Directory structure:
â””â”€â”€ kedar2812-pmis-2.0/
    â”œâ”€â”€ README.md
    â”œâ”€â”€ requirements.txt
    â”œâ”€â”€ update.ps1
    â”œâ”€â”€ .env.email.example
    â”œâ”€â”€ .env.example
    â”œâ”€â”€ .gitingestignore
    â”œâ”€â”€ backend/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ deploy.ps1
    â”‚   â”œâ”€â”€ manage.py
    â”‚   â”œâ”€â”€ requirements.txt
    â”‚   â”œâ”€â”€ start_local.bat
    â”‚   â”œâ”€â”€ test_api.py
    â”‚   â”œâ”€â”€ .env.email.example
    â”‚   â”œâ”€â”€ .env.example
    â”‚   â”œâ”€â”€ audit/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â””â”€â”€ views.py
    â”‚   â”œâ”€â”€ banks/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ admin.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ CUSTOMER_GUIDE.md
    â”‚   â”‚   â”œâ”€â”€ models.py
    â”‚   â”‚   â”œâ”€â”€ serializers.py
    â”‚   â”‚   â”œâ”€â”€ tests.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â”œâ”€â”€ views.py
    â”‚   â”‚   â”œâ”€â”€ management/
    â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚   â””â”€â”€ commands/
    â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚       â””â”€â”€ import_ifsc.py
    â”‚   â”‚   â””â”€â”€ migrations/
    â”‚   â”‚       â”œâ”€â”€ 0001_initial.py
    â”‚   â”‚       â””â”€â”€ __init__.py
    â”‚   â”œâ”€â”€ common/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â””â”€â”€ utils/
    â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚       â””â”€â”€ importers.py
    â”‚   â”œâ”€â”€ communications/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ admin.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ encryption.py
    â”‚   â”‚   â”œâ”€â”€ models.py
    â”‚   â”‚   â”œâ”€â”€ permissions.py
    â”‚   â”‚   â”œâ”€â”€ serializers.py
    â”‚   â”‚   â”œâ”€â”€ services.py
    â”‚   â”‚   â”œâ”€â”€ tests.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â”œâ”€â”€ views.py
    â”‚   â”‚   â”œâ”€â”€ management/
    â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚   â””â”€â”€ commands/
    â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚       â””â”€â”€ fix_encrypted_messages.py
    â”‚   â”‚   â””â”€â”€ migrations/
    â”‚   â”‚       â”œâ”€â”€ 0001_initial.py
    â”‚   â”‚       â”œâ”€â”€ 0002_thread_chat_name_alter_thread_context_id_and_more.py
    â”‚   â”‚       â”œâ”€â”€ 0003_attachment_messagereadreceipt_threadparticipant_and_more.py
    â”‚   â”‚       â”œâ”€â”€ 0004_alter_communicationauditlog_action.py
    â”‚   â”‚       â”œâ”€â”€ 0005_add_message_encryption.py
    â”‚   â”‚       â”œâ”€â”€ 0006_fix_encryption_default.py
    â”‚   â”‚       â”œâ”€â”€ 0007_allow_null_message_attachment.py
    â”‚   â”‚       â””â”€â”€ __init__.py
    â”‚   â”œâ”€â”€ config/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ asgi.py
    â”‚   â”‚   â”œâ”€â”€ settings.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â””â”€â”€ wsgi.py
    â”‚   â”œâ”€â”€ edms/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ admin.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ models.py
    â”‚   â”‚   â”œâ”€â”€ permissions.py
    â”‚   â”‚   â”œâ”€â”€ serializers.py
    â”‚   â”‚   â”œâ”€â”€ services_base.py
    â”‚   â”‚   â”œâ”€â”€ tests.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â”œâ”€â”€ views.py
    â”‚   â”‚   â”œâ”€â”€ management/
    â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚   â””â”€â”€ commands/
    â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ align_edms_structure.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ debug_edms.py
    â”‚   â”‚   â”‚       â””â”€â”€ repair_edms.py
    â”‚   â”‚   â”œâ”€â”€ migrations/
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0001_initial.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0002_add_notingsheet.py
    â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
    â”‚   â”‚   â””â”€â”€ services/
    â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚       â””â”€â”€ directory_service.py
    â”‚   â”œâ”€â”€ finance/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ admin.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ boq_execution.py
    â”‚   â”‚   â”œâ”€â”€ evm_service.py
    â”‚   â”‚   â”œâ”€â”€ models.py
    â”‚   â”‚   â”œâ”€â”€ progress_service.py
    â”‚   â”‚   â”œâ”€â”€ serializers.py
    â”‚   â”‚   â”œâ”€â”€ tests.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â”œâ”€â”€ views.py
    â”‚   â”‚   â”œâ”€â”€ migrations/
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0001_initial.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0002_rename_source_name_fundhead_name_and_more.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0003_budgetlineitem_fund_head.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0004_remove_retentionledger_remarks_boqitem_and_more.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0005_rabill_metadata.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0006_approvalrequest_notification.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0007_rabill_bill_pdf_file.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0008_add_boq_execution_and_progress_log.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0009_add_project_evm_history.py
    â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
    â”‚   â”‚   â””â”€â”€ services/
    â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”œâ”€â”€ bill_pdf_generator.py
    â”‚   â”‚       â””â”€â”€ etp_calculator.py
    â”‚   â”œâ”€â”€ masters/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ admin.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ serializers.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â”œâ”€â”€ views.py
    â”‚   â”‚   â”œâ”€â”€ management/
    â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚   â””â”€â”€ commands/
    â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ check_contractor_validity.py
    â”‚   â”‚   â”‚       â”œâ”€â”€ populate_geography.py
    â”‚   â”‚   â”‚       â””â”€â”€ populate_india_locations.py
    â”‚   â”‚   â”œâ”€â”€ migrations/
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0001_initial.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0002_add_user_links_to_hierarchy.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0003_add_linked_user_to_contractor.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0004_district_status_projectcategory_status_scheme_status_and_more.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0005_country_state_city.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0006_add_location_district.py
    â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
    â”‚   â”‚   â””â”€â”€ models/
    â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”œâ”€â”€ classification.py
    â”‚   â”‚       â”œâ”€â”€ entities.py
    â”‚   â”‚       â”œâ”€â”€ finance_config.py
    â”‚   â”‚       â”œâ”€â”€ geography.py
    â”‚   â”‚       â”œâ”€â”€ hierarchy.py
    â”‚   â”‚       â””â”€â”€ locations.py
    â”‚   â”œâ”€â”€ procurement/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ admin.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ models.py
    â”‚   â”‚   â”œâ”€â”€ nicdc_integration.py
    â”‚   â”‚   â”œâ”€â”€ serializers.py
    â”‚   â”‚   â”œâ”€â”€ tests.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â”œâ”€â”€ views.py
    â”‚   â”‚   â””â”€â”€ migrations/
    â”‚   â”‚       â”œâ”€â”€ 0001_initial.py
    â”‚   â”‚       â””â”€â”€ __init__.py
    â”‚   â”œâ”€â”€ projects/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ admin.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ calendar_service.py
    â”‚   â”‚   â”œâ”€â”€ funding_model.py
    â”‚   â”‚   â”œâ”€â”€ models.py
    â”‚   â”‚   â”œâ”€â”€ notification_service.py
    â”‚   â”‚   â”œâ”€â”€ risk_models.py
    â”‚   â”‚   â”œâ”€â”€ risk_serializers.py
    â”‚   â”‚   â”œâ”€â”€ risk_services.py
    â”‚   â”‚   â”œâ”€â”€ risk_views.py
    â”‚   â”‚   â”œâ”€â”€ serializers.py
    â”‚   â”‚   â”œâ”€â”€ signals.py
    â”‚   â”‚   â”œâ”€â”€ tests.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â”œâ”€â”€ views.py
    â”‚   â”‚   â”œâ”€â”€ management/
    â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚   â””â”€â”€ commands/
    â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”‚       â””â”€â”€ clear_manager_data.py
    â”‚   â”‚   â”œâ”€â”€ migrations/
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0001_initial.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0002_workpackage.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0003_add_master_foreignkeys.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0004_project_earned_value_project_financial_progress_and_more.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0005_add_approval_and_manager_fk.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0006_fix_manager_schema.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0007_add_risk_management_models.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0008_add_edms_fields_to_workpackage.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0009_add_performance_indexes.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0009_remove_workpackage_agreement_document_edms_and_more.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ 0010_merge_20260127_2329.py
    â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
    â”‚   â”‚   â””â”€â”€ services/
    â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚       â””â”€â”€ progress_calculator.py
    â”‚   â”œâ”€â”€ scheduling/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ admin.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ models.py
    â”‚   â”‚   â”œâ”€â”€ serializers.py
    â”‚   â”‚   â”œâ”€â”€ signals.py
    â”‚   â”‚   â”œâ”€â”€ tests.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â”œâ”€â”€ views.py
    â”‚   â”‚   â””â”€â”€ migrations/
    â”‚   â”‚       â”œâ”€â”€ 0001_initial.py
    â”‚   â”‚       â”œâ”€â”€ 0002_scheduletask_external_id_scheduletask_metadata.py
    â”‚   â”‚       â”œâ”€â”€ 0003_alter_scheduletask_options_and_more.py
    â”‚   â”‚       â””â”€â”€ __init__.py
    â”‚   â”œâ”€â”€ search/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â””â”€â”€ views.py
    â”‚   â”œâ”€â”€ users/
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ admin.py
    â”‚   â”‚   â”œâ”€â”€ apps.py
    â”‚   â”‚   â”œâ”€â”€ auth.py
    â”‚   â”‚   â”œâ”€â”€ email_service.py
    â”‚   â”‚   â”œâ”€â”€ middleware.py
    â”‚   â”‚   â”œâ”€â”€ models.py
    â”‚   â”‚   â”œâ”€â”€ serializers.py
    â”‚   â”‚   â”œâ”€â”€ tests.py
    â”‚   â”‚   â”œâ”€â”€ throttles.py
    â”‚   â”‚   â”œâ”€â”€ urls.py
    â”‚   â”‚   â”œâ”€â”€ views.py
    â”‚   â”‚   â””â”€â”€ migrations/
    â”‚   â”‚       â”œâ”€â”€ 0001_initial.py
    â”‚   â”‚       â”œâ”€â”€ 0002_add_user_management_fields.py
    â”‚   â”‚       â”œâ”€â”€ 0003_user_is_online_user_last_seen.py
    â”‚   â”‚       â”œâ”€â”€ 0004_add_password_reset_token.py
    â”‚   â”‚       â”œâ”€â”€ 0005_user_registration_class.py
    â”‚   â”‚       â”œâ”€â”€ 0006_add_government_hierarchy_roles.py
    â”‚   â”‚       â””â”€â”€ __init__.py
    â”‚   â””â”€â”€ workflow/
    â”‚       â”œâ”€â”€ __init__.py
    â”‚       â”œâ”€â”€ admin.py
    â”‚       â”œâ”€â”€ apps.py
    â”‚       â”œâ”€â”€ engine.py
    â”‚       â”œâ”€â”€ models.py
    â”‚       â”œâ”€â”€ serializers.py
    â”‚       â”œâ”€â”€ signals.py
    â”‚       â”œâ”€â”€ tests.py
    â”‚       â”œâ”€â”€ urls.py
    â”‚       â”œâ”€â”€ views.py
    â”‚       â”œâ”€â”€ management/
    â”‚       â”‚   â”œâ”€â”€ __init__.py
    â”‚       â”‚   â””â”€â”€ commands/
    â”‚       â”‚       â”œâ”€â”€ __init__.py
    â”‚       â”‚       â””â”€â”€ seed_workflows.py
    â”‚       â””â”€â”€ migrations/
    â”‚           â”œâ”€â”€ 0001_initial.py
    â”‚           â””â”€â”€ __init__.py
    â”œâ”€â”€ docs/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ ARCHITECTURE.md
    â”‚   â”œâ”€â”€ SECURITY.md
    â”‚   â””â”€â”€ workflows/
    â”‚       â”œâ”€â”€ create_standard_modal.md
    â”‚       â”œâ”€â”€ sync-api-repo.md
    â”‚       â””â”€â”€ sync-gitlab.md
    â”œâ”€â”€ frontend/
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ index.html
    â”‚   â”œâ”€â”€ package.json
    â”‚   â”œâ”€â”€ postcss.config.js
    â”‚   â”œâ”€â”€ tailwind.config.js
    â”‚   â”œâ”€â”€ vite.config.js
    â”‚   â”œâ”€â”€ .eslintrc.cjs
    â”‚   â”œâ”€â”€ public/
    â”‚   â”‚   â”œâ”€â”€ images/
    â”‚   â”‚   â”‚   â””â”€â”€ README.md
    â”‚   â”‚   â””â”€â”€ locales/
    â”‚   â”‚       â”œâ”€â”€ en/
    â”‚   â”‚       â”‚   â””â”€â”€ translation.json
    â”‚   â”‚       â”œâ”€â”€ hi/
    â”‚   â”‚       â”‚   â””â”€â”€ translation.json
    â”‚   â”‚       â””â”€â”€ te/
    â”‚   â”‚           â””â”€â”€ translation.json
    â”‚   â””â”€â”€ src/
    â”‚       â”œâ”€â”€ App.jsx
    â”‚       â”œâ”€â”€ index.css
    â”‚       â”œâ”€â”€ main.jsx
    â”‚       â”œâ”€â”€ api/
    â”‚       â”‚   â”œâ”€â”€ client.js
    â”‚       â”‚   â””â”€â”€ services/
    â”‚       â”‚       â”œâ”€â”€ calendarService.js
    â”‚       â”‚       â”œâ”€â”€ dashboardService.js
    â”‚       â”‚       â”œâ”€â”€ edmsService.js
    â”‚       â”‚       â”œâ”€â”€ evmService.js
    â”‚       â”‚       â”œâ”€â”€ financeService.js
    â”‚       â”‚       â”œâ”€â”€ mastersService.js
    â”‚       â”‚       â”œâ”€â”€ procurementService.js
    â”‚       â”‚       â”œâ”€â”€ progressService.js
    â”‚       â”‚       â”œâ”€â”€ projectService.js
    â”‚       â”‚       â”œâ”€â”€ riskService.js
    â”‚       â”‚       â”œâ”€â”€ settingsService.js
    â”‚       â”‚       â”œâ”€â”€ userService.js
    â”‚       â”‚       â””â”€â”€ workflowService.js
    â”‚       â”œâ”€â”€ components/
    â”‚       â”‚   â”œâ”€â”€ auth/
    â”‚       â”‚   â”‚   â””â”€â”€ OtpLogin.jsx
    â”‚       â”‚   â”œâ”€â”€ billing/
    â”‚       â”‚   â”‚   â”œâ”€â”€ BillDetailModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ GenerateBillModal.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ RABillTemplate.jsx
    â”‚       â”‚   â”œâ”€â”€ common/
    â”‚       â”‚   â”‚   â””â”€â”€ TranslationNavigationGuard.jsx
    â”‚       â”‚   â”œâ”€â”€ communications/
    â”‚       â”‚   â”‚   â”œâ”€â”€ AddParticipantsModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ NewThreadModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ NotificationDropdown.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ StartChatModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ ThreadDetail.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ ThreadList.jsx
    â”‚       â”‚   â”œâ”€â”€ contractor/
    â”‚       â”‚   â”‚   â””â”€â”€ IFSCInput.jsx
    â”‚       â”‚   â”œâ”€â”€ cost/
    â”‚       â”‚   â”‚   â”œâ”€â”€ BOQMilestoneMappingModal.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ EditBOQItemModal.jsx
    â”‚       â”‚   â”œâ”€â”€ dashboard/
    â”‚       â”‚   â”‚   â”œâ”€â”€ ActivityFeed.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ ConsultantDashboard.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ EPCDashboard.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ GovtDashboard.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ HealthSummaryPanel.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ KPIDetailModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ MilestonePerformanceCard.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ MiniCalendarWidget.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ NICDCDashboard.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ PhaseProgressCard.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ PMNCDashboard.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ ProjectCalendar.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ RadialProgressCard.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ SPVDashboard.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ UnifiedDashboard.jsx
    â”‚       â”‚   â”œâ”€â”€ edms/
    â”‚       â”‚   â”‚   â”œâ”€â”€ AddNoteModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ AddVersionModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ DocumentDetailModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ DocumentList.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ DocumentUploadModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ FolderTree.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ NotingPanel.jsx
    â”‚       â”‚   â”œâ”€â”€ evm/
    â”‚       â”‚   â”‚   â””â”€â”€ EVMSCurveChart.jsx
    â”‚       â”‚   â”œâ”€â”€ gis/
    â”‚       â”‚   â”‚   â””â”€â”€ LeafletMap.jsx
    â”‚       â”‚   â”œâ”€â”€ layout/
    â”‚       â”‚   â”‚   â”œâ”€â”€ AppLayout.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Header.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ Sidebar.jsx
    â”‚       â”‚   â”œâ”€â”€ masters/
    â”‚       â”‚   â”‚   â”œâ”€â”€ ChainedHierarchySelector.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ ClassificationSelector.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ ContractorSelector.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ DeleteConfirmModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ fieldConfigs.js
    â”‚       â”‚   â”‚   â”œâ”€â”€ GeographySelector.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ LocationSelector.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ MasterFormModal.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ UserSelectField.jsx
    â”‚       â”‚   â”œâ”€â”€ messaging/
    â”‚       â”‚   â”‚   â””â”€â”€ MessagingCenter.jsx
    â”‚       â”‚   â”œâ”€â”€ packages/
    â”‚       â”‚   â”‚   â””â”€â”€ CreatePackageModal.jsx
    â”‚       â”‚   â”œâ”€â”€ procurement/
    â”‚       â”‚   â”‚   â”œâ”€â”€ AddContractorModal.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ ContractorDetailModal.jsx
    â”‚       â”‚   â”œâ”€â”€ projects/
    â”‚       â”‚   â”‚   â”œâ”€â”€ CreateProjectModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ LandStats.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ MultiProgressBar.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ ProjectDetailModal.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ ProjectDetailView.jsx
    â”‚       â”‚   â”œâ”€â”€ risks/
    â”‚       â”‚   â”‚   â”œâ”€â”€ CreateRiskModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ index.js
    â”‚       â”‚   â”‚   â””â”€â”€ RiskDetailPanel.jsx
    â”‚       â”‚   â”œâ”€â”€ scheduling/
    â”‚       â”‚   â”‚   â”œâ”€â”€ AddScheduleTaskModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ GanttChart.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ ImportScheduleModal.jsx
    â”‚       â”‚   â”œâ”€â”€ search/
    â”‚       â”‚   â”‚   â”œâ”€â”€ GlobalSearchBar.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ index.js
    â”‚       â”‚   â”‚   â”œâ”€â”€ SearchFilters.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ SearchModal.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ SearchResultItem.jsx
    â”‚       â”‚   â”œâ”€â”€ ui/
    â”‚       â”‚   â”‚   â”œâ”€â”€ AnimatedChart.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Breadcrumbs.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Button.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Card.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ ContractorSearchDropdown.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ DynamicChart.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ EmptyState.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ ErrorBoundary.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ GoogleTranslateWidget.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ GraphAnalysisModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ GraphLoader.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ InfoTooltip.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ LanguageDropdown.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Loading.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ MetricsDetailModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ MotionCard.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ NotificationCenter.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ NotificationPreferencesModal.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ SearchableSelect.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Select.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Skeleton.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ SmartInput.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ SortableDataTable.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ StatusBadge.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Switch.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ ThemeToggle.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Toast.jsx
    â”‚       â”‚   â”‚   â”œâ”€â”€ Toggle.jsx
    â”‚       â”‚   â”‚   â””â”€â”€ UserSearchDropdown.jsx
    â”‚       â”‚   â”œâ”€â”€ users/
    â”‚       â”‚   â”‚   â””â”€â”€ InviteUserModal.jsx
    â”‚       â”‚   â””â”€â”€ workflow/
    â”‚       â”‚       â”œâ”€â”€ EntityWorkflowCard.jsx
    â”‚       â”‚       â”œâ”€â”€ WorkflowActionCards.jsx
    â”‚       â”‚       â””â”€â”€ WorkflowTracker.jsx
    â”‚       â”œâ”€â”€ contexts/
    â”‚       â”‚   â”œâ”€â”€ AuthContext.jsx
    â”‚       â”‚   â”œâ”€â”€ LanguageContext.jsx
    â”‚       â”‚   â”œâ”€â”€ SidebarContext.jsx
    â”‚       â”‚   â””â”€â”€ ThemeContext.jsx
    â”‚       â”œâ”€â”€ hooks/
    â”‚       â”‚   â”œâ”€â”€ useAnimatedCounter.jsx
    â”‚       â”‚   â”œâ”€â”€ useETPCalculation.js
    â”‚       â”‚   â”œâ”€â”€ useMockData.js
    â”‚       â”‚   â””â”€â”€ useModalClose.js
    â”‚       â”œâ”€â”€ lib/
    â”‚       â”‚   â”œâ”€â”€ calculations.js
    â”‚       â”‚   â”œâ”€â”€ colors.js
    â”‚       â”‚   â”œâ”€â”€ rules.md
    â”‚       â”‚   â”œâ”€â”€ translationService.js
    â”‚       â”‚   â””â”€â”€ utils.js
    â”‚       â”œâ”€â”€ mock/
    â”‚       â”‚   â”œâ”€â”€ index.js
    â”‚       â”‚   â””â”€â”€ data/
    â”‚       â”‚       â”œâ”€â”€ budgets.json
    â”‚       â”‚       â”œâ”€â”€ contractors.json
    â”‚       â”‚       â”œâ”€â”€ costForecasts.json
    â”‚       â”‚       â”œâ”€â”€ gisFeatures.json
    â”‚       â”‚       â”œâ”€â”€ kpis.json
    â”‚       â”‚       â”œâ”€â”€ notifications.json
    â”‚       â”‚       â”œâ”€â”€ projects.json
    â”‚       â”‚       â”œâ”€â”€ risks.json
    â”‚       â”‚       â”œâ”€â”€ tasks.json
    â”‚       â”‚       â””â”€â”€ users.json
    â”‚       â”œâ”€â”€ pages/
    â”‚       â”‚   â”œâ”€â”€ AcceptInvite.jsx
    â”‚       â”‚   â”œâ”€â”€ Approvals.jsx
    â”‚       â”‚   â”œâ”€â”€ BIM.jsx
    â”‚       â”‚   â”œâ”€â”€ Budgeting.jsx
    â”‚       â”‚   â”œâ”€â”€ Communications.jsx
    â”‚       â”‚   â”œâ”€â”€ ContractorRegistration.jsx
    â”‚       â”‚   â”œâ”€â”€ CostManagement.jsx
    â”‚       â”‚   â”œâ”€â”€ Dashboard.jsx
    â”‚       â”‚   â”œâ”€â”€ DocumentViewerPage.jsx
    â”‚       â”‚   â”œâ”€â”€ EDMS.jsx
    â”‚       â”‚   â”œâ”€â”€ EProcurement.jsx
    â”‚       â”‚   â”œâ”€â”€ ETPMaster.jsx
    â”‚       â”‚   â”œâ”€â”€ ForgotPassword.jsx
    â”‚       â”‚   â”œâ”€â”€ FundManagement.jsx
    â”‚       â”‚   â”œâ”€â”€ GIS.jsx
    â”‚       â”‚   â”œâ”€â”€ Login.jsx
    â”‚       â”‚   â”œâ”€â”€ Procurement.jsx
    â”‚       â”‚   â”œâ”€â”€ ProjectDetailsPage.jsx
    â”‚       â”‚   â”œâ”€â”€ Projects.jsx
    â”‚       â”‚   â”œâ”€â”€ RABilling.jsx
    â”‚       â”‚   â”œâ”€â”€ Reimbursement.jsx
    â”‚       â”‚   â”œâ”€â”€ ResetPassword.jsx
    â”‚       â”‚   â”œâ”€â”€ RiskManagement.jsx
    â”‚       â”‚   â”œâ”€â”€ RoleManager.jsx
    â”‚       â”‚   â”œâ”€â”€ Scheduling.jsx
    â”‚       â”‚   â”œâ”€â”€ UserManagement.jsx
    â”‚       â”‚   â”œâ”€â”€ WorkflowConfig.jsx
    â”‚       â”‚   â””â”€â”€ admin/
    â”‚       â”‚       â”œâ”€â”€ AuditLogs.jsx
    â”‚       â”‚       â””â”€â”€ MasterData.jsx
    â”‚       â”œâ”€â”€ services/
    â”‚       â”‚   â”œâ”€â”€ AuditLogger.js
    â”‚       â”‚   â”œâ”€â”€ financeService.js
    â”‚       â”‚   â”œâ”€â”€ ifscService.js
    â”‚       â”‚   â”œâ”€â”€ projectService.js
    â”‚       â”‚   â”œâ”€â”€ schedulingService.js
    â”‚       â”‚   â”œâ”€â”€ searchService.js
    â”‚       â”‚   â””â”€â”€ userService.js
    â”‚       â””â”€â”€ utils/
    â”‚           â””â”€â”€ AuthUtils.js
    â”œâ”€â”€ .github/
    â”‚   â””â”€â”€ workflows/
    â”‚       â””â”€â”€ sync-gitlab.yml
    â””â”€â”€ .vite/
        â”œâ”€â”€ deps/
        â”‚   â”œâ”€â”€ _metadata.json
        â”‚   â””â”€â”€ package.json
        â””â”€â”€ deps_temp_4f72f5b4/
            â””â”€â”€ package.json


Files Content:

================================================
FILE: README.md
================================================
# PMIS 2.0 - Project Management Information System

> **Government-Grade Project Management Platform**  
> Enterprise solution for infrastructure project lifecycle management, budget tracking, and multi-stakeholder collaboration.

[![Django 5.0+](https://img.shields.io/badge/Django-5.0+-green.svg)](https://www.djangoproject.com/)
[![React 18](https://img.shields.io/badge/React-18-blue.svg)](https://reactjs.org/)
[![PostgreSQL 14+](https://img.shields.io/badge/PostgreSQL-14+-blue.svg)](https://www.postgresql.org/)
[![License: Proprietary](https://img.shields.io/badge/License-Proprietary-red.svg)](LICENSE)

---

## Table of Contents

- [Overview](#-overview)
- [Key Features](#-key-features)
- [Tech Stack](#-tech-stack)
- [Architecture](#-architecture)
- [Getting Started](#-getting-started)
  - [Prerequisites](#prerequisites)
  - [Backend Setup](#backend-setup)
  - [Frontend Setup](#frontend-setup)
- [Deployment](#-deployment)
- [Core Modules](#-core-modules)
- [Security](#-security)
- [API Documentation](#-api-documentation)
- [Contributing](#-contributing)
- [Support](#-support)

---

## Overview

**PMIS 2.0** is a comprehensive project management information system designed for government infrastructure projects. It provides end-to-end lifecycle management from planning to execution, with robust financial tracking, document management, and compliance features.

### Built For

- **SPV Officials** - Project oversight and decision-making
- **PMNC Teams** - Project monitoring and coordination
- **EPC Contractors** - Execution and billing
- **Consultants** - Design reviews and technical support
- **Government Departments** - Compliance and approvals
- **NICDC HQ** - Central monitoring and analytics

---

## Key Features

### Project Management
- **Multi-Project Dashboard** - Real-time overview of all projects
- **Work Package Management** - Granular project breakdown
- **Milestone Tracking** - Critical path monitoring
- **Risk Management** - Comprehensive risk register with mitigation plans
- **Progress Tracking** - Physical and financial progress monitoring

### Financial Management
- **Budget Planning & Allocation** - Multi-source fund management
- **RA Bill Processing** - Running Account bill generation and approval
- **EVM Analytics** - Earned Value Management with S-curves
- **Payment Tracking** - Contractor payment ledger
- **Fund Source Management** - Track central/state funding

### Document Management (EDMS)
- **Hierarchical File System** - Organized by project/category
- **Version Control** - Complete audit trail of document revisions
- **E-Notings** - Digital noting sheets with approval workflows
- **Auto-Routing** - Smart document filing based on 35+ categories
- **Secure Access Control** - Role-based document permissions

### Workflow Engine
- **Configurable Workflows** - Multi-stage approval processes
- **SLA Tracking** - Automated escalation on delays
- **Digital Signatures** - Secure approval chain
- **Audit Logging** - Complete action history

### Communications
- **Contextual Messaging** - Thread-based discussions linked to projects/documents
- **End-to-End Encryption** - AES-256-GCM for message content
- **Role-Based Access** - Controlled communication channels
- **Notification System** - Real-time alerts and updates

### Scheduling
- **Gantt Charts** - Visual timeline management
- **Task Dependencies** - Critical path analysis
- **MSP/P6 Import** - Import from Microsoft Project and Primavera P6
- **Progress Tracking** - Task completion monitoring

### GIS Integration
- **Interactive Maps** - Leaflet-based project location mapping
- **Spatial Analysis** - Geographic project distribution
- **Land Acquisition Tracking** - Plot-level status monitoring

### Advanced Search
- **Global Search** - Search across all modules
- **Faceted Filters** - Filter by type, status, date, etc.
- **Smart Suggestions** - AI-powered search recommendations

### IFSC Database
- **Self-Hosted Bank Data** - 177,000+ bank branches
- **Offline Validation** - No external API dependencies
- **Auto-Complete** - Smart bank/branch selection

### Security & Compliance
- **Role-Based Access Control (RBAC)** - 7 user roles with granular permissions
- **JWT Authentication** - Secure token-based auth
- **Audit Logging** - Immutable action trails
- **Data Encryption** - At-rest encryption for sensitive data
- **CORS Protection** - Configurable origin policies

---

## Tech Stack

### Backend
| Technology | Version | Purpose |
|------------|---------|---------|
| **Python** | 3.10+ | Core language |
| **Django** | 5.0+ | Web framework |
| **Django REST Framework** | 3.14+ | API development |
| **PostgreSQL** | 14+ | Primary database |
| **Redis** | 5.0+ | Caching & sessions |
| **Gunicorn** | 21.2+ | WSGI server |
| **Pillow** | 10.0+ | Image processing |
| **ReportLab** | 4.0+ | PDF generation |
| **openpyxl** | 3.1+ | Excel import/export |

### Frontend
| Technology | Version | Purpose |
|------------|---------|---------|
| **React** | 18+ | UI framework |
| **Vite** | Latest | Build tool |
| **Tailwind CSS** | 3+ | Styling |
| **Recharts** | 2+ | Data visualization |
| **Leaflet** | 1.9+ | GIS mapping |
| **Axios** | 1.6+ | HTTP client |
| **React Router** | 6+ | Routing |
| **i18next** | 23+ | Internationalization |

### Infrastructure
- **Windows Server** - Production hosting
- **IIS** - Frontend web server
- **NSSM** - Backend service management
- **PostgreSQL** - Database server

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend (React)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Dashboard â”‚  â”‚ Projects â”‚  â”‚   EDMS   â”‚  â”‚ Messaging   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          API Client (Axios + JWT Auth)                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ REST API
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Backend (Django)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  API Layer (DRF)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Projects â”‚  â”‚ Finance  â”‚  â”‚   EDMS   â”‚  â”‚  Workflow   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Users   â”‚  â”‚ Masters  â”‚  â”‚  Comms   â”‚  â”‚ Scheduling  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚             Business Logic & Services                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PostgreSQL Database                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Projects â”‚  â”‚ Finance  â”‚  â”‚Documents â”‚  â”‚   Users     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Design Principles
- **Modularity** - Each Django app is self-contained
- **API-First** - Frontend consumes RESTful APIs
- **Security by Design** - Authentication, encryption, audit logging
- **Scalability** - Caching, pagination, optimized queries
- **Government Compliance** - Audit trails, role-based access, data sovereignty

---

## Getting Started

### Prerequisites

- **Python** 3.10 or higher
- **Node.js** 18 or higher
- **PostgreSQL** 14 or higher
- **Git** for version control

### Backend Setup

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd pmis-2.0
   ```

2. **Navigate to backend directory**
   ```bash
   cd backend
   ```

3. **Create virtual environment**
   ```bash
   python -m venv venv
   
   # Windows
   .\venv\Scripts\activate
   
   # Linux/Mac
   source venv/bin/activate
   ```

4. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

5. **Configure environment**
   ```bash
   # Copy example env file
   cp .env.example .env
   
   # Edit .env with your settings
   # - Database credentials
   # - Secret key
   # - CORS origins
   # - Encryption key
   ```

6. **Setup database**
   ```bash
   # Create database (if needed)
   python create_db.py
   
   # Run migrations
   python manage.py migrate
   
   # Create superuser
   python create_superuser.py
   # Default: username=admin, password=admin
   ```

7. **Import master data**
   ```bash
   # Import IFSC bank data (177K+ branches)
   python manage.py import_ifsc --clear
   
   # Populate Indian geography (optional)
   python manage.py populate_geography
   ```

8. **Run development server**
   ```bash
   python manage.py runserver
   ```
   
   Backend API: http://localhost:8000  
   Admin Panel: http://localhost:8000/admin

### Frontend Setup

1. **Navigate to frontend directory**
   ```bash
   cd frontend
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Configure environment**
   ```bash
   # Frontend uses Vite's env system
   # Update API endpoint in src/api/client.js if needed
   ```

4. **Run development server**
   ```bash
   npm run dev
   ```
   
   Frontend: http://localhost:5173

5. **Build for production**
   ```bash
   npm run build
   # Output: dist/
   ```

---

## Deployment

### Windows Server Deployment

#### Prerequisites
- Windows Server 2019/2022
- IIS installed and configured
- PostgreSQL installed
- NSSM (Non-Sucking Service Manager)

#### Backend Deployment

1. **Clone repository**
   ```powershell
   cd C:\
   git clone <repository-url> pmis
   cd pmis\backend
   ```

2. **Setup virtual environment**
   ```powershell
   python -m venv venv
   .\venv\Scripts\activate
   pip install -r requirements.txt
   ```

3. **Configure production environment**
   ```powershell
   # Create .env file with production settings
   # Set DEBUG=False
   # Configure production database
   # Set secure SECRET_KEY
   # Configure EMAIL settings
   ```

4. **Run migrations and collect static**
   ```powershell
   python manage.py migrate
   python manage.py collectstatic --noinput
   ```

5. **Install as Windows Service**
   ```powershell
   # Install NSSM
   nssm install PMISBackend "C:\pmis\backend\venv\Scripts\python.exe" "C:\pmis\backend\manage.py runserver 0.0.0.0:8000"
   
   # Set working directory
   nssm set PMISBackend AppDirectory "C:\pmis\backend"
   
   # Start service
   nssm start PMISBackend
   ```

#### Frontend Deployment (IIS)

1. **Build frontend**
   ```powershell
   cd C:\pmis\frontend
   npm install
   npm run build
   ```

2. **Copy to IIS directory**
   ```powershell
   Copy-Item -Path dist\* -Destination C:\inetpub\wwwroot\pmis -Recurse -Force
   ```

3. **Configure IIS**
   - Create new website in IIS Manager
   - Point to `C:\inetpub\wwwroot\pmis`
   - Set up SSL certificate (recommended)
   - Configure URL rewrite for React Router (if needed)

#### Automated Deployment

Use the provided PowerShell scripts:

```powershell
# Full update (backend + frontend)
.\update.ps1

# Backend only
cd backend
.\deploy.ps1
```

---

## Core Modules

### Users & Authentication
- Custom user model with 7 role types
- JWT-based authentication
- Role-based access control (RBAC)
- Password reset via email
- User management dashboard

**API Endpoints:**
- `POST /api/users/register/` - Register new user
- `POST /api/users/login/` - Login (get JWT token)
- `GET /api/users/me/` - Get current user profile
- `GET /api/users/` - List users (admin only)

### Projects
- Project lifecycle management
- Work package breakdown
- Risk register and mitigation plans
- Progress tracking (physical & financial)
- EVM metrics (CPI, SPI, EAC)

**API Endpoints:**
- `GET /api/projects/` - List projects
- `POST /api/projects/` - Create project
- `GET /api/projects/{id}/` - Project details
- `GET /api/projects/{id}/risks/` - Project risks

### Finance
- Budget allocation and tracking
- RA bill generation and approval
- Fund source management
- Retention ledger
- Payment tracking
- EVM calculations

**API Endpoints:**
- `GET /api/finance/bills/` - List RA bills
- `POST /api/finance/bills/` - Create bill
- `GET /api/finance/budgets/` - Budget line items
- `GET /api/finance/evm/{project_id}/` - EVM data

### EDMS (Document Management)
- Hierarchical folder structure
- Document versioning
- E-noting sheets
- Auto-routing (35+ categories)
- Access control
- Audit trails

**API Endpoints:**
- `GET /api/edms/folders/` - Folder tree
- `POST /api/edms/upload/` - Upload document
- `GET /api/edms/documents/{id}/` - Document details
- `POST /api/edms/documents/{id}/note/` - Add note

### Communications
- Contextual threaded messaging
- End-to-end encryption (AES-256-GCM)
- Direct messages and group chats
- Notifications
- Read receipts

**API Endpoints:**
- `GET /api/communications/threads/` - List threads
- `POST /api/communications/threads/` - Create thread
- `POST /api/communications/messages/` - Send message
- `GET /api/communications/notifications/` - Get notifications

### Workflow
- Configurable approval workflows
- Multi-stage approvals
- SLA tracking and escalation
- Delegation support
- Workflow templates

**API Endpoints:**
- `GET /api/workflow/definitions/` - Workflow templates
- `POST /api/workflow/instances/` - Start workflow
- `POST /api/workflow/actions/` - Take action (approve/reject)

### Masters
- Geography (countries, states, districts, cities)
- Organizational hierarchy
- Contractors and vendors
- Classifications and categories
- Finance configuration

**API Endpoints:**
- `GET /api/masters/states/` - List states
- `GET /api/masters/districts/?state={id}` - Districts by state
- `GET /api/masters/contractors/` - List contractors

### Scheduling
- Gantt chart visualization
- Task dependencies
- Critical path analysis
- Import from MSP/P6
- Progress tracking

**API Endpoints:**
- `GET /api/scheduling/tasks/` - List tasks
- `POST /api/scheduling/import/` - Import schedule
- `PATCH /api/scheduling/tasks/{id}/` - Update progress

### Banks (IFSC)
- Self-hosted IFSC database (177K+ branches)
- Offline validation
- Bank/branch search
- Auto-complete support

**API Endpoints:**
- `GET /api/banks/list/` - List bank names
- `GET /api/banks/ifsc/{code}/` - Lookup IFSC
- `GET /api/banks/stats/` - Database stats (admin)

---

## Security

### Authentication & Authorization
- **JWT Tokens** - Stateless authentication
- **Role-Based Access Control** - 7 predefined roles
- **Permission Classes** - Granular endpoint protection
- **Password Policies** - Strong password requirements

### Data Protection
- **Encryption at Rest** - AES-256-GCM for sensitive data
- **Encryption in Transit** - HTTPS/TLS required in production
- **Database Credentials** - Environment variables only
- **Secret Key Management** - Never committed to repository

### Audit & Compliance
- **Immutable Audit Logs** - Every action logged
- **User Activity Tracking** - IP address, user agent
- **Document Version Control** - Complete revision history
- **Regulatory Compliance** - Government-grade standards

### Best Practices
- **CORS Protection** - Configurable allowed origins
- **Rate Limiting** - Throttling for API endpoints
- **SQL Injection Prevention** - ORM-based queries
- **XSS Protection** - Input sanitization
- **CSRF Protection** - Django middleware enabled

---

## API Documentation

### Base URL
- **Development:** `http://localhost:8000/api/`
- **Production:** `https://your-domain.com/api/`

### Authentication

All protected endpoints require a JWT token in the `Authorization` header:

```http
Authorization: Bearer <your_jwt_token>
```

**Get Token:**
```http
POST /api/users/login/
Content-Type: application/json

{
  "username": "admin",
  "password": "yourpassword"
}
```

**Response:**
```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "id": "uuid",
    "username": "admin",
    "role": "SPV_Official"
  }
}
```

### Pagination

List endpoints support pagination:

```http
GET /api/projects/?page=1&page_size=50
```

**Response:**
```json
{
  "count": 150,
  "next": "http://localhost:8000/api/projects/?page=2",
  "previous": null,
  "results": [...]
}
```

### Filtering & Search

Many endpoints support filtering:

```http
GET /api/projects/?status=ONGOING&search=highway
GET /api/finance/bills/?project={uuid}&status=PENDING
```

### Error Handling

Standard HTTP status codes:
- `200 OK` - Success
- `201 Created` - Resource created
- `400 Bad Request` - Validation error
- `401 Unauthorized` - Missing/invalid token
- `403 Forbidden` - Insufficient permissions
- `404 Not Found` - Resource not found
- `500 Internal Server Error` - Server error

**Error Response:**
```json
{
  "error": "Validation failed",
  "details": {
    "field_name": ["Error message"]
  }
}
```

---

## Contributing

### Development Workflow

1. **Create a feature branch**
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **Make your changes**
   - Follow PEP 8 for Python code
   - Use ESLint for JavaScript/React code
   - Write meaningful commit messages

3. **Test your changes**
   ```bash
   # Backend tests
   python manage.py test
   
   # Frontend tests (if applicable)
   npm test
   ```

4. **Commit and push**
   ```bash
   git add .
   git commit -m "feat: Add new feature"
   git push origin feature/your-feature-name
   ```

5. **Create a Pull Request**
   - Describe your changes
   - Reference related issues
   - Request code review

### Code Style

**Backend (Python):**
- Follow PEP 8
- Use type hints where applicable
- Write docstrings for functions and classes
- Keep functions focused and small

**Frontend (React):**
- Use functional components with hooks
- Follow Airbnb JavaScript Style Guide
- Use Tailwind CSS utility classes
- Create reusable components

### Commit Message Convention

```
feat: Add new feature
fix: Fix bug in module
docs: Update documentation
style: Format code
refactor: Refactor component
test: Add tests
chore: Update dependencies
```

---



### Documentation
- **Backend:** See `backend/README.md`
- **IFSC Database:** See `backend/banks/CUSTOMER_GUIDE.md`
- **Architecture:** See `docs/ARCHITECTURE.md`
- **Security:** See `docs/SECURITY.md`

### Troubleshooting

**Database Connection Errors:**
- Verify PostgreSQL is running
- Check credentials in `.env` file
- Ensure database exists

**CORS Errors:**
- Update `CORS_ALLOWED_ORIGINS` in `.env`
- Verify frontend URL matches

**Encryption Errors:**
- Set `MESSAGE_ENCRYPTION_KEY` in `.env`
- Use: `python -c "import secrets; print(secrets.token_urlsafe(32))"`

**IFSC Data Missing:**
- Run: `python manage.py import_ifsc --clear`
- Requires internet to download data

---

## ğŸ“„ License

**Proprietary Software** - All rights reserved.

This software is proprietary and confidential. Unauthorized copying, distribution, or use is strictly prohibited.

---

**Technology Stack:**
- Django & Django REST Framework
- React & Vite
- PostgreSQL
- Tailwind CSS
- Recharts, Leaflet, and more

---





================================================
FILE: requirements.txt
================================================
django>=5.0
djangorestframework>=3.14
django-cors-headers>=4.3
psycopg2-binary>=2.9
python-decouple>=3.8
djangorestframework-simplejwt>=5.3
gunicorn>=21.2
whitenoise>=6.6
pillow>=10.0
openpyxl>=3.1
python-dateutil>=2.8
dj-database-url>=2.1
django-filter>=24.0
drf-nested-routers>=0.93

# Caching & Performance
django-redis>=5.4.0
redis>=5.0.1




================================================
FILE: update.ps1
================================================
# PowerShell Update Script for PMIS (Full Deployment)
# Location: C:\pmis\update.ps1
# Usage: Run this script after git pull to update both backend and frontend

Write-Host "================================================" -ForegroundColor Cyan
Write-Host "PMIS Full Update & Deployment Script" -ForegroundColor Cyan
Write-Host "================================================" -ForegroundColor Cyan
Write-Host ""

# Set error action preference
$ErrorActionPreference = "Stop"

# Set base path
$BasePath = "C:\pmis"
Set-Location $BasePath

# ============================================================================
# STEP 1: Pull Latest Code
# ============================================================================
Write-Host "[STEP 1/6] Pulling latest code from GitHub..." -ForegroundColor Yellow
git pull origin main
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Git pull failed!" -ForegroundColor Red
    exit 1
}

# ============================================================================
# STEP 2: Update Backend Dependencies
# ============================================================================
Write-Host ""
Write-Host "[STEP 2/6] Updating backend dependencies..." -ForegroundColor Yellow
Set-Location "$BasePath\backend"
& .\venv\Scripts\Activate.ps1
pip install -r requirements.txt
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to install backend dependencies!" -ForegroundColor Red
    exit 1
}

# ============================================================================
# STEP 3: Run Database Migrations
# ============================================================================
Write-Host ""
Write-Host "[STEP 3/6] Running database migrations..." -ForegroundColor Yellow
python manage.py migrate
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Database migrations failed!" -ForegroundColor Red
    exit 1
}

# ============================================================================
# STEP 4: Collect Static Files
# ============================================================================
Write-Host ""
Write-Host "[STEP 4/6] Collecting static files..." -ForegroundColor Yellow
python manage.py collectstatic --noinput
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: collectstatic failed!" -ForegroundColor Red
    exit 1
}

# ============================================================================
# STEP 5: Build Frontend
# ============================================================================
Write-Host ""
Write-Host "[STEP 5/6] Building frontend..." -ForegroundColor Yellow
Set-Location "$BasePath\frontend"
npm install
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: npm install failed!" -ForegroundColor Red
    exit 1
}

npm run build
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Frontend build failed!" -ForegroundColor Red
    exit 1
}

Write-Host "Copying frontend build to IIS directory..." -ForegroundColor Yellow
Copy-Item -Path dist\* -Destination C:\inetpub\wwwroot\pmis -Recurse -Force
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to copy frontend files to IIS!" -ForegroundColor Red
    exit 1
}

# ============================================================================
# STEP 6: Restart Services
# ============================================================================
Write-Host ""
Write-Host "[STEP 6/6] Restarting services..." -ForegroundColor Yellow

Write-Host "Restarting backend service (NSSM)..." -ForegroundColor Yellow
nssm restart PMISBackend
if ($LASTEXITCODE -ne 0) {
    Write-Host "WARNING: Failed to restart backend service via NSSM" -ForegroundColor Yellow
}

Write-Host "Restarting IIS..." -ForegroundColor Yellow
iisreset
if ($LASTEXITCODE -ne 0) {
    Write-Host "WARNING: Failed to restart IIS" -ForegroundColor Yellow
}

# ============================================================================
# Completion Summary
# ============================================================================
Write-Host ""
Write-Host "================================================" -ForegroundColor Green
Write-Host "Update & Deployment Completed Successfully!" -ForegroundColor Green
Write-Host "================================================" -ForegroundColor Green
Write-Host ""
Write-Host "Service Status:" -ForegroundColor Cyan
nssm status PMISBackend

Write-Host ""
Write-Host "Access URLs:" -ForegroundColor Cyan
Write-Host "  Frontend:    http://45.118.163.111" -ForegroundColor White
Write-Host "  Backend API: http://45.118.163.111:8000" -ForegroundColor White
Write-Host "  Admin Panel: http://45.118.163.111:8000/admin" -ForegroundColor White
Write-Host ""
Write-Host "To view backend logs:" -ForegroundColor Yellow
Write-Host "  Get-Content C:\pmis\logs\backend.log -Tail 100 -Wait" -ForegroundColor White



================================================
FILE: .env.email.example
================================================
# Production Email Configuration

# For Gmail SMTP (Testing/Development)
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com  
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password  # Use Gmail App Password, not regular password
DEFAULT_FROM_EMAIL=your-email@gmail.com

# For SendGrid (Alternative)
# EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
# EMAIL_HOST=smtp.sendgrid.net
# EMAIL_PORT=587
# EMAIL_USE_TLS=True
# EMAIL_HOST_USER=apikey
# EMAIL_HOST_PASSWORD=<your-sendgrid-api-key>
# DEFAULT_FROM_EMAIL=noreply@pmis-zia.gov.in

# For AWS SES (Production - Government)
# EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
# EMAIL_HOST=email-smtp.ap-south-1.amazonaws.com
# EMAIL_PORT=587
# EMAIL_USE_TLS=True
# EMAIL_HOST_USER=<your-ses-smtp-username>
# EMAIL_HOST_PASSWORD=<your-ses-smtp-password>
# DEFAULT_FROM_EMAIL=noreply@pmis-zia.gov.in



================================================
FILE: .env.example
================================================
# ============================================================================
# DJANGO CORE SETTINGS
# ============================================================================
SECRET_KEY=django-insecure-change-this-in-production-random-string
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================
# For DEVELOPMENT: Use individual DB settings below
DB_NAME=pmis_db
DB_USER=postgres
DB_PASSWORD=your_database_password_here
DB_HOST=localhost
DB_PORT=5432

# For PRODUCTION: Use DATABASE_URL (overrides individual DB_* settings)
# DATABASE_URL=postgresql://pmis_user:PmisSecure@2026@localhost:5432/pmis_db

# ============================================================================
# CORS & FRONTEND CONFIGURATION
# ============================================================================
# CRITICAL: Set to your production frontend URL in production
CORS_ALLOWED_ORIGINS=http://localhost:5173
FRONTEND_URL=http://localhost:5173

# ============================================================================
# SECURITY
# ============================================================================
# CRITICAL: Generate a secure encryption key for production!
# Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"
MESSAGE_ENCRYPTION_KEY=pmis-dev-key-CHANGE-IN-PRODUCTION

# ============================================================================
# API CONFIGURATION
# ============================================================================
ENABLE_PAGINATION=True
API_PAGE_SIZE=50
ENABLE_RATE_LIMITING=True
THROTTLE_RATE_ANON=100/hour
THROTTLE_RATE_USER=1000/hour

# ============================================================================
# CACHING (OPTIONAL)
# ============================================================================
# Uses local memory cache if not set
# For production with Redis: REDIS_URL=redis://localhost:6379/0

# ============================================================================
# FILE UPLOAD LIMITS (in bytes)
# ============================================================================
DATA_UPLOAD_MAX_MEMORY_SIZE=10485760
FILE_UPLOAD_MAX_MEMORY_SIZE=52428800

# ============================================================================
# EMAIL CONFIGURATION (OPTIONAL)
# ============================================================================
# Development: uses console backend (prints emails to console)
# For production with AWS SES SMTP, uncomment and configure:
# EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
# EMAIL_HOST=email-smtp.ap-south-1.amazonaws.com
# EMAIL_PORT=587
# EMAIL_USE_TLS=True
# AWS_SES_SMTP_USER=your_ses_username
# AWS_SES_SMTP_PASSWORD=your_ses_password
# DEFAULT_FROM_EMAIL=noreply@yourdomain.com



================================================
FILE: .gitingestignore
================================================
# .gitingestignore
node_modules/
venv/
.vite/
__pycache__/
*.pyc
frontend/dist/
frontend/build/
backend/media/
backend/staticfiles/
*.pdf
*.jpg
*.png
*.svg
*.ico
*.sqlite3
.git/
.vscode/
.env



================================================
FILE: backend/README.md
================================================
# PMIS Backend API

Enterprise-grade backend for the Project Management Information System (PMIS), built with Django and PostgreSQL.

## Prerequisites
- Python 3.10+
- PostgreSQL 14+

## Setup & Installation

1.  **Navigate to backend directory**:
    ```bash
    cd backend
    ```

2.  **Create Virtual Environment**:
    ```bash
    python -m venv venv
    .\venv\Scripts\activate  # Windows
    # source venv/bin/activate  # Linux/Mac
    ```

3.  **Install Dependencies**:
    ```bash
    pip install -r requirements.txt
    ```

4.  **Environment Configuration**:
    - Copy `.env.example` to `.env`.
    - Update `.env` with your PostgreSQL credentials.
    ```env
    DB_NAME=pmis_db
    DB_USER=postgres
    DB_PASSWORD=your_password
    DB_HOST=localhost
    DB_PORT=5432
    ```

5.  **Initialize Database**:
    ```bash
    # Creates the database 'pmis_db' if it doesn't exist
    python create_db.py
    ```

6.  **Run Migrations**:
    ```bash
    python manage.py makemigrations
    python manage.py migrate
    ```

7.  **Create Superuser (Admin)**:
    ```bash
    # Creates user 'admin' with password 'admin'
    python create_superuser.py
    ```

## Running the Server
```bash
python manage.py runserver
```
API will be available at: http://127.0.0.1:8000/

## Project Structure
- `config/`: Global project settings, URL routing, WSGI application.
- `users/`: Custom User model, Role-based access control, Authentication.
- `requirements.txt`: Python dependency list.

## Authentication
- Uses JWT (JSON Web Tokens).
- Default login: `admin` / `admin` (Created via script).



================================================
FILE: backend/deploy.ps1
================================================
# PowerShell Deployment Script for PMIS Backend
# Location: C:\pmis\backend\deploy.ps1

Write-Host "================================================" -ForegroundColor Cyan
Write-Host "PMIS Backend Deployment Script" -ForegroundColor Cyan
Write-Host "================================================" -ForegroundColor Cyan
Write-Host ""

# Set error action preference
$ErrorActionPreference = "Stop"

# Get script directory
$BackendPath = Split-Path -Parent $MyInvocation.MyCommand.Path
Set-Location $BackendPath

Write-Host "[1/4] Activating virtual environment..." -ForegroundColor Yellow
& .\venv\Scripts\Activate.ps1
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to activate virtual environment!" -ForegroundColor Red
    exit 1
}

Write-Host "[2/4] Running database migrations..." -ForegroundColor Yellow
python manage.py migrate
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Database migrations failed!" -ForegroundColor Red
    exit 1
}

Write-Host "[3/4] Collecting static files..." -ForegroundColor Yellow
python manage.py collectstatic --noinput
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: collectstatic failed!" -ForegroundColor Red
    exit 1
}

Write-Host "[4/4] Restarting backend service..." -ForegroundColor Yellow
nssm restart PMISBackend
if ($LASTEXITCODE -ne 0) {
    Write-Host "ERROR: Failed to restart backend service!" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "================================================" -ForegroundColor Green
Write-Host "Deployment completed successfully!" -ForegroundColor Green
Write-Host "================================================" -ForegroundColor Green
Write-Host ""
Write-Host "Service Status:" -ForegroundColor Cyan
nssm status PMISBackend



================================================
FILE: backend/manage.py
================================================
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()



================================================
FILE: backend/requirements.txt
================================================
django>=5.0
djangorestframework>=3.14
django-cors-headers>=4.3
psycopg2-binary>=2.9
python-decouple>=3.8
djangorestframework-simplejwt>=5.3
gunicorn>=21.2
whitenoise>=6.6
pillow>=10.0
openpyxl>=3.1
python-dateutil>=2.8
dj-database-url>=2.1
django-filter>=24.0
drf-nested-routers>=0.93
reportlab>=4.0.9




================================================
FILE: backend/start_local.bat
================================================
@echo off
cd /d "C:\Users\desal\OneDrive\Desktop\projects kedar\pmis-2.0-main\backend"
call venv\Scripts\activate.bat
python manage.py runserver 0.0.0.0:8000



================================================
FILE: backend/test_api.py
================================================
import requests
import json

try:
    print("Testing API endpoint...")
    r = requests.get('http://localhost:8000/api/projects/')
    print(f"Status Code: {r.status_code}")
    
    if r.status_code == 200:
        data = r.json()
        print(f"Response type: {type(data)}")
        print(f"Response keys: {list(data.keys()) if isinstance(data, dict) else 'Not a dict'}")
        if isinstance(data, dict) and 'results' in data:
            print(f"Number of projects: {len(data['results'])}")
            print("âœ… Pagination is working!")
        elif isinstance(data, list):
            print(f"Number of projects: {len(data)}")
            print("âš ï¸ API returning array (old format)")
        else:
            print(f"Unexpected format: {data}")
    else:
        print(f"âŒ Error: {r.status_code}")
        print(f"Response: {r.text[:500]}")
except Exception as e:
    print(f"âŒ Exception: {e}")



================================================
FILE: backend/.env.email.example
================================================
# Production Email Configuration

# For Gmail SMTP (Testing/Development)
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com  
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password  # Use Gmail App Password, not regular password
DEFAULT_FROM_EMAIL=your-email@gmail.com

# For SendGrid (Alternative)
# EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
# EMAIL_HOST=smtp.sendgrid.net
# EMAIL_PORT=587
# EMAIL_USE_TLS=True
# EMAIL_HOST_USER=apikey
# EMAIL_HOST_PASSWORD=<your-sendgrid-api-key>
# DEFAULT_FROM_EMAIL=noreply@pmis-zia.gov.in

# For AWS SES (Production - Government)
# EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
# EMAIL_HOST=email-smtp.ap-south-1.amazonaws.com
# EMAIL_PORT=587
# EMAIL_USE_TLS=True
# EMAIL_HOST_USER=<your-ses-smtp-username>
# EMAIL_HOST_PASSWORD=<your-ses-smtp-password>
# DEFAULT_FROM_EMAIL=noreply@pmis-zia.gov.in



================================================
FILE: backend/.env.example
================================================
# ============================================================================
# DJANGO CORE SETTINGS
# ============================================================================
SECRET_KEY=django-insecure-change-this-in-production-random-string
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================
# For DEVELOPMENT: Use individual DB settings below
DB_NAME=pmis_db
DB_USER=postgres
DB_PASSWORD=your_database_password_here
DB_HOST=localhost
DB_PORT=5432

# For PRODUCTION: Use DATABASE_URL (overrides individual DB_* settings)
# DATABASE_URL=postgresql://pmis_user:PmisSecure@2026@localhost:5432/pmis_db

# ============================================================================
# CORS & FRONTEND CONFIGURATION
# ============================================================================
# CRITICAL: Set to your production frontend URL in production
CORS_ALLOWED_ORIGINS=http://localhost:5173
FRONTEND_URL=http://localhost:5173

# ============================================================================
# SECURITY
# ============================================================================
# CRITICAL: Generate a secure encryption key for production!
# Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"
MESSAGE_ENCRYPTION_KEY=pmis-dev-key-CHANGE-IN-PRODUCTION

# ============================================================================
# API CONFIGURATION
# ============================================================================
ENABLE_PAGINATION=True
API_PAGE_SIZE=50
ENABLE_RATE_LIMITING=True
THROTTLE_RATE_ANON=100/hour
THROTTLE_RATE_USER=1000/hour

# ============================================================================
# CACHING (OPTIONAL)
# ============================================================================
# Uses local memory cache if not set
# For production with Redis: REDIS_URL=redis://localhost:6379/0

# ============================================================================
# FILE UPLOAD LIMITS (in bytes)
# ============================================================================
DATA_UPLOAD_MAX_MEMORY_SIZE=10485760
FILE_UPLOAD_MAX_MEMORY_SIZE=52428800

# ============================================================================
# EMAIL CONFIGURATION (OPTIONAL)
# ============================================================================
# Development: uses console backend (prints emails to console)
# For production with AWS SES SMTP, uncomment and configure:
# EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
# EMAIL_HOST=email-smtp.ap-south-1.amazonaws.com
# EMAIL_PORT=587
# EMAIL_USE_TLS=True
# AWS_SES_SMTP_USER=your_ses_username
# AWS_SES_SMTP_PASSWORD=your_ses_password
# DEFAULT_FROM_EMAIL=noreply@yourdomain.com



================================================
FILE: backend/audit/__init__.py
================================================
"""
Unified Audit Log App - Aggregates audit logs from all system modules
"""



================================================
FILE: backend/audit/views.py
================================================
"""
Unified Audit Log Views - Aggregates logs from all system modules
Provides a single endpoint for viewing all system activities
"""
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from edms.models import DocumentAuditLog
from django.db.models import Q


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def unified_audit_logs(request):
    """
    Aggregate audit logs from all modules.
    Returns unified format with IP addresses, sorted by timestamp.
    
    Query Parameters:
    - limit: Number of logs to return (default: 100)
    - search: Search term for filtering
    - module: Filter by module (EDMS, Users, Projects, etc.)
    """
    limit = int(request.GET.get('limit', 100))
    search = request.GET.get('search', '').lower()
    module_filter = request.GET.get('module', '')
    
    logs = []
    
    # 1. EDMS Document Management Logs
    if not module_filter or module_filter == 'EDMS':
        edms_query = DocumentAuditLog.objects.select_related('actor').all()
        
        # Apply search filter
        if search:
            edms_query = edms_query.filter(
                Q(actor__username__icontains=search) |
                Q(action__icontains=search) |
                Q(resource_type__icontains=search) |
                Q(details__icontains=search)
            )
        
        edms_logs = edms_query[:limit]
        
        for log in edms_logs:
            logs.append({
                'id': str(log.id),
                'timestamp': log.timestamp.isoformat(),
                'actor_name': log.actor.username if log.actor else 'System',
                'actor_role': log.actor_role,
                'action': log.action,
                'resource_type': log.resource_type,
                'module': 'EDMS',
                'details': log.details,
                'ip_address': log.ip_address or '-',  # Ensure IP is included
                'user_agent': log.user_agent[:100] if log.user_agent else ''  # Truncate user agent
            })
    
    # 2. Future: User Management Logs
    # TODO: Add user audit logs (login, logout, registration, role changes)
    
    # 3. Future: Project Management Logs
    # TODO: Add project audit logs (creation, updates, work packages)
    
    # 4. Future: Communications Logs
    # TODO: Add communication audit logs (messages, notifications)
    
    # Sort all logs by timestamp (most recent first)
    logs.sort(key=lambda x: x['timestamp'], reverse=True)
    
    # Apply limit across all modules
    logs = logs[:limit]
    
    return Response({
        'results': logs,
        'count': len(logs),
        'modules_available': ['EDMS'],  # Will expand as more modules add audit logging
        'total_modules': 1
    })



================================================
FILE: backend/banks/__init__.py
================================================
[Empty file]


================================================
FILE: backend/banks/admin.py
================================================
from django.contrib import admin
from .models import BankBranch


@admin.register(BankBranch)
class BankBranchAdmin(admin.ModelAdmin):
    """
    Admin interface for managing bank branches and IFSC codes.
    Allows customers to view, search, and update IFSC data easily.
    """
    
    list_display = ['ifsc_code', 'bank_name', 'branch_name', 'city', 'state', 'is_active']
    list_filter = ['bank_name', 'state', 'is_active', 'rtgs', 'neft', 'imps', 'upi']
    search_fields = ['ifsc_code', 'bank_name', 'branch_name', 'city', 'district', 'state']
    readonly_fields = ['created_at', 'updated_at', 'data_source']
    
    fieldsets = (
        ('Branch Identification', {
            'fields': ('ifsc_code', 'bank_name', 'branch_name', 'is_active')
        }),
        ('Location Details', {
            'fields': ('address', 'city', 'district', 'state')
        }),
        ('Contact Information', {
            'fields': ('contact',)
        }),
        ('Payment Systems', {
            'fields': ('rtgs', 'neft', 'imps', 'upi'),
            'description': 'Enable/disable payment systems for this branch'
        }),
        ('Data Management', {
            'fields': ('data_source', 'last_verified', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    actions = ['activate_branches', 'deactivate_branches', 'enable_upi']
    
    def activate_branches(self, request, queryset):
        updated = queryset.update(is_active=True)
        self.message_user(request, f'{updated} branch(es) activated successfully.')
    activate_branches.short_description = 'Activate selected branches'
    
    def deactivate_branches(self, request, queryset):
        updated = queryset.update(is_active=False)
        self.message_user(request, f'{updated} branch(es) deactivated successfully.')
    deactivate_branches.short_description = 'Deactivate selected branches'
    
    def enable_upi(self, request, queryset):
        updated = queryset.update(upi=True)
        self.message_user(request, f'UPI enabled for {updated} branch(es).')
    enable_upi.short_description = 'Enable UPI for selected branches'
    
    class Media:
        css = {
            'all': ('admin/css/custom_admin.css',)
        }



================================================
FILE: backend/banks/apps.py
================================================
from django.apps import AppConfig


class BanksConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'banks'
    verbose_name = 'Bank Branches (IFSC)'



================================================
FILE: backend/banks/CUSTOMER_GUIDE.md
================================================
# IFSC Database Management Guide

## For Customers/Administrators

This guide explains how to manage and update the IFSC database in your PMIS system.

## Overview

The PMIS system uses a self-hosted IFSC database with **1,346+ bank branches** from all major Indian banks. The data is stored securely on your server with no dependency on external APIs.

---

## Viewing IFSC Data

### Via Django Admin

1. **Login to Admin Panel:**  
   `https://your-pmis-url.com/admin`

2. **Navigate to:**  
   `Banks` â†’ `Bank Branches (IFSC)`

3. **Features:**
   - Search by IFSC code, bank name, branch name, city
   - Filter by bank, state, payment systems (RTGS, NEFT, UPI)
   - View/edit individual branch details
   - Bulk actions (activate/deactivate branches)

---

## Updating IFSC Data

### When to Update

- Quarterly (recommended)
- When new banks/branches are announced
- When branches close or merge

### How to Update

#### Method 1: Download Latest Data (Recommended)

1. **Download latest IFSC data:**
   ```bash
   # On your server
   cd /path/to/backend
   git clone --depth 1 https://github.com/razorpay/ifsc.git temp_ifsc_data
   ```

2. **Import data:**
   ```bash
   python manage.py import_ifsc_data --clear
   ```

3. **Verify:**
   ```bash
   # Check import summary in output
   # Should show: Total imported, Unique banks
   ```

#### Method 2: Manual Updates via Admin

1. Go to Admin Panel â†’ Bank Branches
2. Click "Add Bank Branch" or edit existing
3. Fill in all required fields
4. Save

---

## Management Commands

### Import IFSC Data

```bash
# Import from custom directory
python manage.py import_ifsc_data --data-dir /path/to/ifsc/data

# Clear existing data and import fresh
python manage.py import_ifsc_data --clear
```

### Check Database Stats

Access via API (admin only):
```
GET /api/banks/stats/
```

Returns:
- Total branches
- Active/inactive counts
- Total banks
- UPI-enabled branches
- Last update timestamp

---

## Troubleshooting

### Import Fails

**Problem:** Unicode error during import  
**Solution:** File already handles Windows encoding issues

**Problem:** Missing files  
**Solution:** Ensure `banks.json` and `banknames.json` exist in data directory

### IFSC Not Found

**Problem:** Valid IFSC returns "not found"  
**Solution:**  
1. Check if branch is marked inactive in admin
2. Update IFSC database
3. Verify IFSC code format

### Slow Performance

**Problem:** Bank dropdown loads slowly  
**Solution:**  
- Data is cached for 24 hours automatically
- Check database indexes are in place
- Consider reducing inactive branches

---

## Security Best Practices

âœ… **Data Privacy:**  
- All IFSC data stored locally
- No external API calls
- Complete data sovereignty

âœ… **Access Control:**  
- Only authenticated admins can view statistics
- Public endpoints (list, lookup) use caching

âœ… **Regular Updates:**  
- Keep data current with quarterly updates
- Monitor for closed branches

---

## Support

For technical assistance with IFSC database management, contact your system administrator or refer to the PMIS technical documentation.

**Database Location:** PostgreSQL â†’ `banks_ifsc` table  
**Admin Interface:** `/admin/banks/bankbranch/`  
**API Endpoints:**  
- `/api/banks/list/` - Get bank names
- `/api/banks/ifsc/{code}/` - Lookup IFSC
- `/api/banks/stats/` - Get statistics (admin only)



================================================
FILE: backend/banks/models.py
================================================
from django.db import models


class BankBranch(models.Model):
    """
    IFSC Master Data - Self-hosted from RBI official sources
    Data Source: National Payment Corporation of India (NPCI) via Razorpay GitHub
    """
    
    # Primary identification
    ifsc_code = models.CharField(
        max_length=11,
        primary_key=True,
        db_index=True,
        help_text="11-character IFSC code (Format: ABCD0123456)"
    )
    
    # Bank details
    bank_name = models.CharField(
        max_length=255,
        db_index=True,
        help_text="Full name of the bank"
    )
    
    branch_name = models.CharField(
        max_length=255,
        help_text="Branch name"
    )
    
    # Location details
    address = models.TextField(
        blank=True,
        help_text="Complete branch address"
    )
    
    city = models.CharField(
        max_length=100,
        db_index=True,
        blank=True,
        help_text="City name"
    )
    
    district = models.CharField(
        max_length=100,
        blank=True,
        help_text="District name"
    )
    
    state = models.CharField(
        max_length=100,
        db_index=True,
        blank=True,
        help_text="State name"
    )
    
    # Contact details
    contact = models.CharField(
        max_length=50,
        blank=True,
        help_text="Branch contact number"
    )
    
    # Payment system participation
    rtgs = models.BooleanField(
        default=True,
        help_text="RTGS enabled"
    )
    
    neft = models.BooleanField(
        default=True,
        help_text="NEFT enabled"
    )
    
    imps = models.BooleanField(
        default=True,
        help_text="IMPS enabled"
    )
    
    upi = models.BooleanField(
        default=False,
        help_text="UPI enabled"
    )
    
    # Data management
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    data_source = models.CharField(
        max_length=100,
        default="NPCI/RBI via Razorpay",
        help_text="Source of the data"
    )
    last_verified = models.DateField(
        null=True,
        blank=True,
        help_text="Last date data was verified"
    )
    is_active = models.BooleanField(
        default=True,
        help_text="Whether this branch is currently active"
    )
    
    class Meta:
        db_table = 'banks_ifsc'
        indexes = [
            models.Index(fields=['bank_name']),
            models.Index(fields=['city']),
            models.Index(fields=['state']),
            models.Index(fields=['is_active']),
        ]
        verbose_name = 'Bank Branch (IFSC)'
        verbose_name_plural = 'Bank Branches (IFSC)'
        ordering = ['bank_name', 'branch_name']
    
    def __str__(self):
        return f"{self.ifsc_code} - {self.bank_name} ({self.branch_name})"
    
    @classmethod
    def get_unique_banks(cls):
        """Get list of unique bank names"""
        return cls.objects.filter(is_active=True).values_list('bank_name', flat=True).distinct().order_by('bank_name')
    
    @classmethod
    def search_by_ifsc(cls, ifsc_code):
        """Search branch by IFSC code"""
        return cls.objects.filter(ifsc_code=ifsc_code.upper(), is_active=True).first()



================================================
FILE: backend/banks/serializers.py
================================================
from rest_framework import serializers
from .models import BankBranch


class BankBranchSerializer(serializers.ModelSerializer):
    """Serializer for bank branch details"""
    
    class Meta:
        model = BankBranch
        fields = [
            'ifsc_code',
            'bank_name',
            'branch_name',
            'address',
            'city',
            'district',
            'state',
            'contact',
            'rtgs',
            'neft',
            'imps',
            'upi',
            'is_active',
        ]
        read_only_fields = fields  # All fields are read-only for public API


class BankListSerializer(serializers.Serializer):
    """Simple serializer for bank names list"""
    bank_name = serializers.CharField()



================================================
FILE: backend/banks/tests.py
================================================
from django.test import TestCase

# Create your tests here.



================================================
FILE: backend/banks/urls.py
================================================
from django.urls import path
from . import views

urlpatterns = [
    path('list/', views.BankListView.as_view(), name='bank-list'),
    path('ifsc/<str:ifsc_code>/', views.IFSCLookupView.as_view(), name='ifsc-lookup'),
    path('stats/', views.IFSCStatsView.as_view(), name='ifsc-stats'),
]



================================================
FILE: backend/banks/views.py
================================================
"""
API Views for Bank and IFSC lookup
Secure, fast, and easy to use
"""
import re
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status, permissions
from django.core.cache import cache
from .models import BankBranch
from .serializers import BankBranchSerializer


class BankListView(APIView):
    """
    Get list of unique bank names for dropdown
    Cached for 24 hours for performance
    """
    permission_classes = [permissions.AllowAny]
    
    def get(self, request):
        # Try to get from cache first
        cache_key = 'bank_names_list'
        bank_names = cache.get(cache_key)
        
        if bank_names is None:
            # Fetch from database
            bank_names = list(
                BankBranch.objects
                .filter(is_active=True)
                .values_list('bank_name', flat=True)
                .distinct()
                .order_by('bank_name')
            )
            
            # If no banks found, return helpful error message
            if not bank_names:
                return Response({
                    'count': 0,
                    'banks': [],
                    'warning': 'No bank data available. Please run: python manage.py import_ifsc --clear',
                    'help': 'This downloads latest IFSC data from Razorpay GitHub releases'
                }, status=status.HTTP_200_OK)
            
            # Cache for 24 hours
            cache.set(cache_key, bank_names, 60 * 60 * 24)
        
        return Response({
            'count': len(bank_names),
            'banks': bank_names
        })


class IFSCLookupView(APIView):
    """
    Validate IFSC code and return branch details
    Public endpoint - no authentication required
    """
    permission_classes = [permissions.AllowAny]
    
    def get(self, request, ifsc_code):
        # Normalize IFSC code
        ifsc_code = ifsc_code.upper().strip()
        
        # Validate format
        if not self._is_valid_ifsc_format(ifsc_code):
            return Response(
                {
                    'error': 'Invalid IFSC format',
                    'message': 'IFSC code must be 11 characters (Format: ABCD0123456)',
                    'valid': False
                },
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # Try cache first
        cache_key = f'ifsc_{ifsc_code}'
        cached_data = cache.get(cache_key)
        
        if cached_data:
            return Response(cached_data)
        
        # Lookup in database
        try:
            branch = BankBranch.objects.get(ifsc_code=ifsc_code, is_active=True)
            serializer = BankBranchSerializer(branch)
            data = serializer.data
            data['valid'] = True
            
            # Cache for 7 days
            cache.set(cache_key, data, 60 * 60 * 24 * 7)
            
            return Response(data)
            
        except BankBranch.DoesNotExist:
            return Response(
                {
                    'error': 'IFSC code not found',
                    'message': f'No branch found with IFSC code: {ifsc_code}',
                    'valid': False
                },
                status=status.HTTP_404_NOT_FOUND
            )
    
    def _is_valid_ifsc_format(self, ifsc):
        """
        Validate IFSC code format
        Format: ABCD0123456 (4 letters, 0, then 6 alphanumeric)
        """
        return bool(re.match(r'^[A-Z]{4}0[A-Z0-9]{6}$', ifsc))


class IFSCStatsView(APIView):
    """Get statistics about IFSC database (for admin monitoring)"""
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request):
        total_branches = BankBranch.objects.count()
        active_branches = BankBranch.objects.filter(is_active=True).count()
        total_banks = BankBranch.objects.values('bank_name').distinct().count()
        upi_enabled = BankBranch.objects.filter(upi=True).count()
        
        return Response({
            'total_branches': total_branches,
            'active_branches': active_branches,
            'inactive_branches': total_branches - active_branches,
            'total_banks': total_banks,
            'upi_enabled_branches': upi_enabled,
            'last_update': BankBranch.objects.order_by('-updated_at').first().updated_at if BankBranch.objects.exists() else None
        })



================================================
FILE: backend/banks/management/__init__.py
================================================
# Empty file to make this directory a Python package



================================================
FILE: backend/banks/management/commands/__init__.py
================================================
# Empty file to make this directory a Python package



================================================
FILE: backend/banks/management/commands/import_ifsc.py
================================================
"""
Django management command to import IFSC data from Razorpay GitHub releases.

Downloads the latest IFSC.csv from:
https://github.com/razorpay/ifsc/releases/latest/download/IFSC.csv

This file contains ~177K bank branches with complete details including:
- IFSC code, Bank name, Branch name
- Address, City, District, State
- RTGS, NEFT, IMPS, UPI support flags

Usage:
    python manage.py import_ifsc          # Download and import latest data
    python manage.py import_ifsc --clear  # Clear existing data first
    python manage.py import_ifsc --file ~/IFSC.csv  # Import from local file

Data Source: https://github.com/razorpay/ifsc (Updated by RBI regularly)
"""
import csv
import os
import tempfile
import urllib.request
from django.core.management.base import BaseCommand
from django.utils import timezone
from banks.models import BankBranch


class Command(BaseCommand):
    help = 'Import IFSC data from Razorpay GitHub releases (CSV format)'

    # Direct download URL for latest IFSC.csv
    DOWNLOAD_URL = 'https://github.com/razorpay/ifsc/releases/latest/download/IFSC.csv'

    def add_arguments(self, parser):
        parser.add_argument(
            '--file',
            type=str,
            default=None,
            help='Path to local IFSC.csv file (skips download)'
        )
        parser.add_argument(
            '--clear',
            action='store_true',
            help='Clear existing data before importing'
        )
        parser.add_argument(
            '--batch-size',
            type=int,
            default=5000,
            help='Batch size for database inserts (default: 5000)'
        )

    def handle(self, *args, **options):
        csv_file = options['file']
        temp_file = None

        # Download if no local file specified
        if not csv_file:
            self.stdout.write('Downloading IFSC.csv from Razorpay GitHub releases...')
            self.stdout.write(f'URL: {self.DOWNLOAD_URL}')
            
            try:
                # Create temp file
                temp_file = tempfile.NamedTemporaryFile(mode='wb', suffix='.csv', delete=False)
                
                # Download with progress
                def show_progress(block_num, block_size, total_size):
                    if total_size > 0:
                        percent = min(100, block_num * block_size * 100 / total_size)
                        mb_downloaded = (block_num * block_size) / (1024 * 1024)
                        mb_total = total_size / (1024 * 1024)
                        self.stdout.write(
                            f'\rDownloading: {mb_downloaded:.1f}/{mb_total:.1f} MB ({percent:.0f}%)',
                            ending=''
                        )
                
                urllib.request.urlretrieve(self.DOWNLOAD_URL, temp_file.name, show_progress)
                self.stdout.write('')  # New line after progress
                
                csv_file = temp_file.name
                file_size = os.path.getsize(csv_file) / (1024 * 1024)
                self.stdout.write(self.style.SUCCESS(f'Downloaded: {file_size:.1f} MB'))
                
            except Exception as e:
                self.stdout.write(self.style.ERROR(f'Download failed: {e}'))
                self.stdout.write('You can manually download from:')
                self.stdout.write('  https://github.com/razorpay/ifsc/releases/latest')
                self.stdout.write('Then run: python manage.py import_ifsc --file /path/to/IFSC.csv')
                return

        # Verify file exists
        if not os.path.exists(csv_file):
            self.stdout.write(self.style.ERROR(f'File not found: {csv_file}'))
            return

        # Clear existing data if requested
        if options['clear']:
            self.stdout.write(self.style.WARNING('Clearing existing bank data...'))
            deleted_count = BankBranch.objects.count()
            BankBranch.objects.all().delete()
            self.stdout.write(f'Deleted {deleted_count} existing records')

        # Import from CSV
        self.stdout.write(f'Importing from {csv_file}...')
        batch_size = options['batch_size']
        
        total_imported = 0
        total_errors = 0
        batch = []

        try:
            with open(csv_file, 'r', encoding='utf-8') as f:
                reader = csv.DictReader(f)
                
                for row in reader:
                    try:
                        # Parse boolean fields
                        rtgs = self._parse_bool(row.get('RTGS', 'true'))
                        neft = self._parse_bool(row.get('NEFT', 'true'))
                        imps = self._parse_bool(row.get('IMPS', 'true'))
                        upi = self._parse_bool(row.get('UPI', 'false'))
                        
                        branch = BankBranch(
                            ifsc_code=row['IFSC'].upper().strip(),
                            bank_name=row.get('BANK', '').strip(),
                            branch_name=row.get('BRANCH', '').strip(),
                            address=row.get('ADDRESS', '').strip(),
                            city=row.get('CITY', '').strip(),
                            district=row.get('DISTRICT', '').strip(),
                            state=row.get('STATE', '').strip(),
                            contact=str(row.get('CONTACT', ''))[:50].strip(),
                            rtgs=rtgs,
                            neft=neft,
                            imps=imps,
                            upi=upi,
                            is_active=True,
                            data_source='Razorpay/RBI',
                            last_verified=timezone.now().date()
                        )
                        batch.append(branch)
                        total_imported += 1

                        # Bulk insert when batch is full
                        if len(batch) >= batch_size:
                            BankBranch.objects.bulk_create(batch, ignore_conflicts=True)
                            self.stdout.write(f'Progress: {total_imported:,} records imported...')
                            batch = []

                    except Exception as e:
                        total_errors += 1
                        if total_errors <= 5:
                            self.stdout.write(
                                self.style.WARNING(f'Error on row {total_imported + total_errors}: {e}')
                            )

                # Insert remaining records
                if batch:
                    BankBranch.objects.bulk_create(batch, ignore_conflicts=True)

        except Exception as e:
            self.stdout.write(self.style.ERROR(f'Import failed: {e}'))
            return

        finally:
            # Cleanup temp file (ignore errors on Windows due to file locking)
            if temp_file:
                try:
                    os.unlink(temp_file.name)
                except (PermissionError, OSError):
                    pass  # File will be cleaned up by OS later

        # Summary
        db_count = BankBranch.objects.count()
        unique_banks = BankBranch.objects.values('bank_name').distinct().count()

        self.stdout.write('')
        self.stdout.write(self.style.SUCCESS('=' * 60))
        self.stdout.write(self.style.SUCCESS('IFSC Import Completed!'))
        self.stdout.write(self.style.SUCCESS('=' * 60))
        self.stdout.write(f'Records processed: {total_imported:,}')
        self.stdout.write(f'Errors: {total_errors}')
        self.stdout.write(f'Total in database: {db_count:,}')
        self.stdout.write(f'Unique banks: {unique_banks:,}')
        
        # Sample output
        sample = BankBranch.objects.filter(ifsc_code__startswith='SBIN')[:2]
        if sample:
            self.stdout.write('')
            self.stdout.write('Sample SBI branches:')
            for b in sample:
                self.stdout.write(f'  {b.ifsc_code} - {b.branch_name}, {b.city}, {b.state}')

    def _parse_bool(self, value):
        """Parse boolean value from CSV (handles 'true', 'false', 'TRUE', 'FALSE', etc.)"""
        if isinstance(value, bool):
            return value
        if isinstance(value, str):
            return value.lower().strip() in ('true', '1', 'yes', 't')
        return bool(value)



================================================
FILE: backend/banks/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2025-12-30 08:03

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='BankBranch',
            fields=[
                ('ifsc_code', models.CharField(db_index=True, help_text='11-character IFSC code (Format: ABCD0123456)', max_length=11, primary_key=True, serialize=False)),
                ('bank_name', models.CharField(db_index=True, help_text='Full name of the bank', max_length=255)),
                ('branch_name', models.CharField(help_text='Branch name', max_length=255)),
                ('address', models.TextField(blank=True, help_text='Complete branch address')),
                ('city', models.CharField(blank=True, db_index=True, help_text='City name', max_length=100)),
                ('district', models.CharField(blank=True, help_text='District name', max_length=100)),
                ('state', models.CharField(blank=True, db_index=True, help_text='State name', max_length=100)),
                ('contact', models.CharField(blank=True, help_text='Branch contact number', max_length=50)),
                ('rtgs', models.BooleanField(default=True, help_text='RTGS enabled')),
                ('neft', models.BooleanField(default=True, help_text='NEFT enabled')),
                ('imps', models.BooleanField(default=True, help_text='IMPS enabled')),
                ('upi', models.BooleanField(default=False, help_text='UPI enabled')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('data_source', models.CharField(default='NPCI/RBI via Razorpay', help_text='Source of the data', max_length=100)),
                ('last_verified', models.DateField(blank=True, help_text='Last date data was verified', null=True)),
                ('is_active', models.BooleanField(default=True, help_text='Whether this branch is currently active')),
            ],
            options={
                'verbose_name': 'Bank Branch (IFSC)',
                'verbose_name_plural': 'Bank Branches (IFSC)',
                'db_table': 'banks_ifsc',
                'ordering': ['bank_name', 'branch_name'],
                'indexes': [models.Index(fields=['bank_name'], name='banks_ifsc_bank_na_995707_idx'), models.Index(fields=['city'], name='banks_ifsc_city_d8ea99_idx'), models.Index(fields=['state'], name='banks_ifsc_state_dbdd8b_idx'), models.Index(fields=['is_active'], name='banks_ifsc_is_acti_2b8b0d_idx')],
            },
        ),
    ]



================================================
FILE: backend/banks/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: backend/common/__init__.py
================================================
[Empty file]


================================================
FILE: backend/common/utils/__init__.py
================================================
[Empty file]


================================================
FILE: backend/common/utils/importers.py
================================================
import abc
import json
import logging
from typing import List, Dict, Any, Generator
from openpyxl import load_workbook
import xml.etree.ElementTree as ET
from datetime import datetime
import re

logger = logging.getLogger(__name__)

class BaseImporter(abc.ABC):
    """
    Abstract Base Class for all File Importers.
    """
    @abc.abstractmethod
    def read_headers(self, file_path: str) -> List[str]:
        """Read and return column headers from the file."""
        pass

    @abc.abstractmethod
    def import_data(self, file_path: str, mapping: Dict[str, str] = None) -> Generator[Dict[str, Any], None, None]:
        """
        Yield rows as dictionaries based on the provided mapping.
        mapping: { 'DbField': 'FileHeader' }
        """
        pass

class ExcelImporter(BaseImporter):
    def _serialize_value(self, val):
        """Convert values to JSON-serializable types."""
        if val is None:
            return None
        if isinstance(val, datetime):
            return val.isoformat()
        return val

    def read_headers(self, file_path: str) -> List[str]:
        if hasattr(file_path, 'seek'):
            file_path.seek(0)
        wb = load_workbook(file_path, read_only=True)
        ws = wb.active
        # Read the first row
        headers = []
        for row in ws.iter_rows(min_row=1, max_row=1, values_only=True):
            headers = [str(h).strip() for h in row if h is not None]
            break
        # wb.close() # Avoid closing externally provided file objects if possible, or just accept it.
        # Openpyxl read-only mode uses a file handle. If we close wb, it might close the handle.
        # But we need to close wb to release resources.
        wb.close()
        return headers

    def import_data(self, file_path: str, mapping: Dict[str, str] = None) -> Generator[Dict[str, Any], None, None]:
        """
        mapping: { 'db_field': 'Excel Header Name' }
        """
        if hasattr(file_path, 'seek'):
            file_path.seek(0)
        wb = load_workbook(file_path, read_only=True, data_only=True)
        ws = wb.active
        
        # 1. Identify Column Indices for the Mapping
        # Get headers first
        file_headers = []
        for row in ws.iter_rows(min_row=1, max_row=1, values_only=True):
            file_headers = [str(h).strip() for h in row if h is not None]
            break
        
        # Build index map: {'Excel Header': 0, ...}
        header_map = {name: i for i, name in enumerate(file_headers)}
        
        # Invert user mapping to get col indices: {'db_field': col_index}
        db_to_col_index = {}
        if mapping:
            for db_field, excel_header in mapping.items():
                if excel_header in header_map:
                    db_to_col_index[db_field] = header_map[excel_header]
                else:
                    logger.warning(f"Mapped header '{excel_header}' not found in file.")

        # 2. Iterate Data
        for row in ws.iter_rows(min_row=2, values_only=True):
            if not any(row): continue  # Skip empty rows
            
            data = {}
            if not mapping:
                # If no mapping provided, yield raw dict using headers
                for i, val in enumerate(row):
                    if i < len(file_headers):
                        data[file_headers[i]] = self._serialize_value(val)
            else:
                # Use mapping to extract specific fields
                for db_field, col_idx in db_to_col_index.items():
                    if col_idx < len(row):
                        data[db_field] = self._serialize_value(row[col_idx])
            
            yield data
        
        wb.close()


class MSPImporter(BaseImporter):
    """
    Microsoft Project XML Parser.
    Extracts Tasks, UIDs, Dates, Progress.
    Does NOT need detailed mapping as XML schema is standard.
    """
    ns = {'msp': 'http://schemas.microsoft.com/project'} # Standard 2007+ schema usually

    def read_headers(self, file_path: str) -> List[str]:
        # Return standard MSP fields we support
        return ['UID', 'Name', 'Start', 'Finish', 'PercentComplete', 'WBS', 'OutlineNumber']

    def import_data(self, file_path: str, mapping: Dict[str, str] = None) -> Generator[Dict[str, Any], None, None]:
        tree = ET.parse(file_path)
        root = tree.getroot()
        
        # Handle namespaces if present (simple hack: strict namespace handling is pain in generic parsers)
        # We'll use local-name() or loop and strip tags if namespace is standard
        # But 'http://schemas.microsoft.com/project' is common.
        
        # Find 'Task' elements
        # Note: root usually has {ns}Tasks -> {ns}Task
        
        # Fallback recursive search for 'Task' tag
        tasks = []
        # Try finding all elements ending in 'Task'
        for elem in root.iter():
            if elem.tag.endswith('Task'):
                tasks.append(elem)
        
        for task in tasks:
            data = {}
            for child in task:
                tag = child.tag.split('}')[-1] # Strip NS
                if tag in ['UID', 'Name', 'Start', 'Finish', 'PercentComplete', 'WBS', 'OutlineNumber']:
                    data[tag] = child.text
            
            # Skip summary tasks if needed, or identifying them
            # Usually Summary tasks have children or specific flags. 
            # We'll yield everything, logic layer can filter.
            if 'Name' in data:
                 yield data

class P6Importer(BaseImporter):
    """
    Primavera P6 (.xer) Parser.
    Proprietary text format. We focus on %T=TASK table.
    """
    def read_headers(self, file_path: str) -> List[str]:
        # P6 headers depend on the table definition in the file.
        # We basically say we support standard P6 Task fields.
        return ['task_code', 'task_name', 'target_start_date', 'target_end_date', 'act_start_date', 'act_end_date', 'phys_complete_pct']

    def import_data(self, file_path: str, mapping: Dict[str, str] = None) -> Generator[Dict[str, Any], None, None]:
        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
            lines = f.readlines()
        
        current_table = None
        headers = []
        for line in lines:
            line = line.strip()
            parts = line.split('\t')
            row_type = parts[0]
            
            if row_type == '%T':
                current_table = parts[1]
                # We only care about TASK table
            elif row_type == '%F':
                if current_table == 'TASK':
                    headers = parts[1:] # Field names
            elif row_type == '%R':
                if current_table == 'TASK':
                    values = parts[1:]
                    row_data = dict(zip(headers, values))
                    yield row_data



================================================
FILE: backend/communications/__init__.py
================================================
[Empty file]


================================================
FILE: backend/communications/admin.py
================================================
from django.contrib import admin

# Register your models here.



================================================
FILE: backend/communications/apps.py
================================================
from django.apps import AppConfig


class CommunicationsConfig(AppConfig):
    name = 'communications'



================================================
FILE: backend/communications/encryption.py
================================================
"""
AES-256-GCM Authenticated Encryption Service for Communications
Government-compliant, bulletproof encryption at rest for message content.

Security Model:
- AES-256-GCM (Galois/Counter Mode) - authenticated encryption
- Built-in integrity verification (no padding oracle attacks)
- PBKDF2 key derivation with salt
- Version-tagged format for future upgrades
- Graceful fallback handling - NEVER fails completely
- Supports legacy CBC format for backward compatibility

Format: VERSION(1) + SALT(16) + NONCE(12) + TAG(16) + CIPHERTEXT
"""
import base64
import hashlib
import hmac
import os
import logging
from typing import Optional, Tuple
from cryptography.hazmat.primitives.ciphers.aead import AESGCM
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from cryptography.hazmat.backends import default_backend
from django.conf import settings

logger = logging.getLogger(__name__)

# Encryption format versions
VERSION_1_CBC = b'\x01'  # Legacy CBC mode (for backward compat)
VERSION_2_GCM = b'\x02'  # Current GCM mode (authenticated)


class EncryptionError(Exception):
    """Raised when encryption/decryption fails"""
    pass


class MessageEncryption:
    """
    AES-256-GCM Authenticated Encryption for message content.
    
    Features:
    - Authenticated encryption (encrypt-then-MAC built into GCM)
    - Per-message random salt and nonce
    - Key derivation from master key using PBKDF2
    - Version tagging for format upgrades
    - 100% graceful failure handling
    
    Usage:
        # Encrypt
        encrypted = MessageEncryption.encrypt("Hello World")
        
        # Decrypt (never throws - returns fallback on failure)
        plaintext = MessageEncryption.decrypt(encrypted)
    """
    
    # Configuration
    KEY_LENGTH = 32  # 256 bits
    SALT_LENGTH = 16  # 128 bits
    NONCE_LENGTH = 12  # 96 bits for GCM
    TAG_LENGTH = 16  # 128 bits authentication tag
    PBKDF2_ITERATIONS = 100000  # Strong key derivation
    
    # Master key from settings
    _master_key: Optional[bytes] = None
    
    @classmethod
    def _get_master_key(cls) -> bytes:
        """
        Get master encryption key from settings.
        Returns a stable fallback key if not configured.
        """
        if cls._master_key is None:
            key = getattr(settings, 'MESSAGE_ENCRYPTION_KEY', None)
            
            if not key:
                key = os.environ.get('MESSAGE_ENCRYPTION_KEY', None)
            
            if not key:
                # Fallback key for development - derives from Django SECRET_KEY
                # This ensures consistency across restarts
                secret_key = getattr(settings, 'SECRET_KEY', 'pmis-fallback-key')
                key = hashlib.sha256(f"message-encryption-{secret_key}".encode()).hexdigest()
                logger.warning("MESSAGE_ENCRYPTION_KEY not set - using derived fallback key")
            
            cls._master_key = key.encode() if isinstance(key, str) else key
        
        return cls._master_key
    
    @classmethod
    def _derive_key(cls, salt: bytes) -> bytes:
        """
        Derive a unique encryption key from master key + salt using PBKDF2.
        """
        kdf = PBKDF2HMAC(
            algorithm=hashes.SHA256(),
            length=cls.KEY_LENGTH,
            salt=salt,
            iterations=cls.PBKDF2_ITERATIONS,
            backend=default_backend()
        )
        return kdf.derive(cls._get_master_key())
    
    @classmethod
    def encrypt(cls, plaintext: str) -> str:
        """
        Encrypt plaintext using AES-256-GCM with authenticated encryption.
        
        Args:
            plaintext: The message content to encrypt
            
        Returns:
            Base64 encoded string: VERSION + SALT + NONCE + TAG + CIPHERTEXT
            
        Note: Never throws - returns original text if encryption fails
        """
        if not plaintext:
            return ""
        
        try:
            # Generate random salt and nonce for this message
            salt = os.urandom(cls.SALT_LENGTH)
            nonce = os.urandom(cls.NONCE_LENGTH)
            
            # Derive key from master key + salt
            key = cls._derive_key(salt)
            
            # Encrypt with AES-256-GCM (authenticated)
            aesgcm = AESGCM(key)
            ciphertext = aesgcm.encrypt(nonce, plaintext.encode('utf-8'), None)
            # Note: GCM appends 16-byte auth tag to ciphertext
            
            # Combine: VERSION + SALT + NONCE + CIPHERTEXT+TAG
            combined = VERSION_2_GCM + salt + nonce + ciphertext
            
            return base64.b64encode(combined).decode('utf-8')
            
        except Exception as e:
            logger.error(f"Encryption failed (returning plaintext): {e}")
            # Return plaintext prefixed with marker so we know it's unencrypted
            return f"__PLAIN__{plaintext}"
    
    @classmethod
    def decrypt(cls, ciphertext: str) -> str:
        """
        Decrypt ciphertext using AES-256-GCM.
        
        Args:
            ciphertext: Base64 encoded encrypted data
            
        Returns:
            Decrypted plaintext string
            
        Note: NEVER throws - returns graceful fallback on any failure
        """
        if not ciphertext:
            return ""
        
        # Check for plaintext marker (encryption failed previously)
        if ciphertext.startswith("__PLAIN__"):
            return ciphertext[9:]  # Remove marker
        
        try:
            # Decode base64
            combined = base64.b64decode(ciphertext.encode('utf-8'))
            
            if len(combined) < 1:
                return cls._safe_fallback(ciphertext, "Empty data")
            
            # Check version
            version = combined[0:1]
            
            if version == VERSION_2_GCM:
                return cls._decrypt_v2_gcm(combined)
            elif version == VERSION_1_CBC:
                return cls._decrypt_v1_cbc_legacy(combined)
            else:
                # Unknown version - try legacy CBC (might be old format without version)
                return cls._decrypt_v1_cbc_legacy(combined, has_version=False)
                
        except Exception as e:
            return cls._safe_fallback(ciphertext, str(e))
    
    @classmethod
    def _decrypt_v2_gcm(cls, combined: bytes) -> str:
        """Decrypt version 2 GCM format."""
        try:
            # Parse: VERSION(1) + SALT(16) + NONCE(12) + CIPHERTEXT+TAG
            min_length = 1 + cls.SALT_LENGTH + cls.NONCE_LENGTH + cls.TAG_LENGTH + 1
            if len(combined) < min_length:
                return cls._safe_fallback("", "Data too short for GCM")
            
            salt = combined[1:1+cls.SALT_LENGTH]
            nonce = combined[1+cls.SALT_LENGTH:1+cls.SALT_LENGTH+cls.NONCE_LENGTH]
            ciphertext_with_tag = combined[1+cls.SALT_LENGTH+cls.NONCE_LENGTH:]
            
            # Derive key
            key = cls._derive_key(salt)
            
            # Decrypt with AES-256-GCM
            aesgcm = AESGCM(key)
            plaintext = aesgcm.decrypt(nonce, ciphertext_with_tag, None)
            
            return plaintext.decode('utf-8')
            
        except Exception as e:
            return cls._safe_fallback("", f"GCM decryption failed: {e}")
    
    @classmethod
    def _decrypt_v1_cbc_legacy(cls, combined: bytes, has_version: bool = True) -> str:
        """
        Decrypt legacy version 1 CBC format for backward compatibility.
        Format: [VERSION(1)] + IV(16) + CIPHERTEXT
        """
        try:
            from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
            from cryptography.hazmat.primitives import padding
            
            # Parse data
            if has_version:
                iv = combined[1:17]
                encrypted = combined[17:]
            else:
                # Old format without version byte
                iv = combined[:16]
                encrypted = combined[16:]
            
            if len(iv) < 16 or len(encrypted) < 16:
                return cls._safe_fallback("", "Data too short for CBC")
            
            # Use simple SHA256 hash of master key (legacy method)
            key = hashlib.sha256(cls._get_master_key()).digest()
            
            # Decrypt with AES-256-CBC
            cipher = Cipher(
                algorithms.AES(key),
                modes.CBC(iv),
                backend=default_backend()
            )
            decryptor = cipher.decryptor()
            padded_data = decryptor.update(encrypted) + decryptor.finalize()
            
            # Remove PKCS7 padding
            unpadder = padding.PKCS7(128).unpadder()
            plaintext = unpadder.update(padded_data) + unpadder.finalize()
            
            return plaintext.decode('utf-8')
            
        except Exception as e:
            return cls._safe_fallback("", f"CBC decryption failed: {e}")
    
    @classmethod
    def _safe_fallback(cls, original: str, error: str) -> str:
        """
        Return a safe fallback when decryption fails.
        Never exposes raw encrypted data or crashes.
        """
        # Use DEBUG level - this is expected for old/migrated data
        logger.debug(f"Decryption fallback (legacy data): {error}")
        
        # Return a user-friendly message
        return "[Message encrypted with different key - content unavailable]"
    
    @classmethod
    def is_encrypted(cls, text: str) -> bool:
        """
        Check if text is encrypted (base64 with valid structure).
        """
        if not text:
            return False
        
        # Check for plaintext marker
        if text.startswith("__PLAIN__"):
            return False
        
        try:
            if len(text) < 32:  # Minimum size
                return False
            
            decoded = base64.b64decode(text.encode('utf-8'))
            
            # Check for version bytes
            if decoded[0:1] in (VERSION_1_CBC, VERSION_2_GCM):
                return True
            
            # Legacy format without version - at least IV(16) + 1 block(16)
            return len(decoded) >= 32
            
        except:
            return False
    
    @classmethod
    def reencrypt_if_needed(cls, ciphertext: str) -> Tuple[str, bool]:
        """
        Re-encrypt message with current format if using legacy encryption.
        Returns (new_ciphertext, was_updated).
        
        Use this for migrations to upgrade encryption format.
        """
        if not ciphertext or not cls.is_encrypted(ciphertext):
            return ciphertext, False
        
        try:
            combined = base64.b64decode(ciphertext.encode('utf-8'))
            
            # Already using latest format
            if combined[0:1] == VERSION_2_GCM:
                return ciphertext, False
            
            # Decrypt with old format
            plaintext = cls.decrypt(ciphertext)
            
            # Re-encrypt with new format
            if not plaintext.startswith("[Message encrypted"):
                new_ciphertext = cls.encrypt(plaintext)
                return new_ciphertext, True
            
            return ciphertext, False
            
        except:
            return ciphertext, False
    
    @classmethod
    def get_encryption_info(cls) -> dict:
        """
        Return information about current encryption configuration.
        Useful for debugging and admin dashboards.
        """
        return {
            'algorithm': 'AES-256-GCM',
            'key_derivation': 'PBKDF2-SHA256',
            'iterations': cls.PBKDF2_ITERATIONS,
            'key_length_bits': cls.KEY_LENGTH * 8,
            'nonce_length_bits': cls.NONCE_LENGTH * 8,
            'tag_length_bits': cls.TAG_LENGTH * 8,
            'current_version': 2,
            'has_master_key': bool(getattr(settings, 'MESSAGE_ENCRYPTION_KEY', None) or 
                                   os.environ.get('MESSAGE_ENCRYPTION_KEY')),
        }



================================================
FILE: backend/communications/models.py
================================================
from django.db import models
from django.contrib.contenttypes.fields import GenericForeignKey
from django.contrib.contenttypes.models import ContentType
from django.utils.translation import gettext_lazy as _
import uuid
import logging

logger = logging.getLogger(__name__)


class Thread(models.Model):
    """
    Contextual conversation container.
    All communications must be anchored to a system object.
    """
    class ThreadType(models.TextChoices):
        DISCUSSION = 'DISCUSSION', _('Discussion')
        CLARIFICATION = 'CLARIFICATION', _('Clarification Request')
        INTERNAL_NOTE = 'INTERNAL_NOTE', _('Internal Note')
        RULING = 'RULING', _('Ruling/Decision')
        DIRECT_MESSAGE = 'DIRECT_MESSAGE', _('Direct Message')
        GROUP_CHAT = 'GROUP_CHAT', _('Group Chat')

    class Status(models.TextChoices):
        OPEN = 'OPEN', _('Open')
        PENDING_RESPONSE = 'PENDING_RESPONSE', _('Pending Response')
        CLOSED = 'CLOSED', _('Closed')
        ESCALATED = 'ESCALATED', _('Escalated')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    subject = models.CharField(max_length=255)
    
    # Generic Foreign Key to link to any context (Document, Project, RABill, etc.)
    # Optional for general chat (DM, Group Chat)
    context_type = models.ForeignKey(ContentType, on_delete=models.CASCADE, null=True, blank=True)
    context_id = models.UUIDField(null=True, blank=True)
    context_object = GenericForeignKey('context_type', 'context_id')
    
    thread_type = models.CharField(max_length=50, choices=ThreadType.choices, default=ThreadType.DISCUSSION)
    status = models.CharField(max_length=50, choices=Status.choices, default=Status.OPEN)
    
    # Optional custom name for group chats
    chat_name = models.CharField(max_length=255, blank=True, help_text="Custom name for group chats")
    
    initiated_by = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True, related_name='initiated_threads')
    initiated_by_role = models.CharField(max_length=100, help_text="Role of user at thread creation time")
    
    # SLA tracking for escalation
    sla_deadline = models.DateTimeField(null=True, blank=True, help_text="Deadline before auto-escalation")
    
    # Participants (for notification targeting)
    participants = models.ManyToManyField('users.User', related_name='participated_threads', blank=True)
    
    closed_at = models.DateTimeField(null=True, blank=True)
    closed_by = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True, related_name='closed_threads', blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['context_type', 'context_id']),
            models.Index(fields=['status']),
            models.Index(fields=['thread_type']),
        ]
        verbose_name = _('Communication Thread')
        verbose_name_plural = _('Communication Threads')

    def __str__(self):
        return f"{self.get_thread_type_display()}: {self.subject}"


class Message(models.Model):
    """
    Individual message within a thread. Immutable once created (audit requirement).
    """
    class MessageType(models.TextChoices):
        STANDARD = 'STANDARD', _('Standard Message')
        CLARIFICATION_REQUEST = 'CLARIFICATION_REQUEST', _('Clarification Request')
        CLARIFICATION_RESPONSE = 'CLARIFICATION_RESPONSE', _('Clarification Response')
        RULING = 'RULING', _('Official Ruling')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    thread = models.ForeignKey(Thread, on_delete=models.CASCADE, related_name='messages')
    sender = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True)
    sender_role = models.CharField(max_length=100, help_text="Role of sender at message creation time")
    
    # Encrypted content storage (AES-256)
    # The 'content' field stores encrypted data at rest
    content = models.TextField(help_text="AES-256 encrypted message content")
    is_encrypted = models.BooleanField(default=False, help_text="Whether content is encrypted")
    
    message_type = models.CharField(max_length=50, choices=MessageType.choices, default=MessageType.STANDARD)
    is_ruling = models.BooleanField(default=False, help_text="Official ruling flag for govt oversight")
    
    # Reference to another message (for threaded replies, clarifications)
    references = models.ForeignKey('self', on_delete=models.SET_NULL, null=True, blank=True, related_name='replies')
    
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['created_at']
        indexes = [
            models.Index(fields=['thread']),
            models.Index(fields=['sender']),
            models.Index(fields=['message_type']),
        ]

    def save(self, *args, **kwargs):
        # Enforce immutability - prevent updates to existing messages
        if self.pk:
            existing = Message.objects.filter(pk=self.pk).first()
            if existing:
                from django.core.exceptions import ValidationError
                raise ValidationError("Messages are immutable and cannot be edited. Create a new message with a reference instead.")
        
        # Auto-set is_ruling flag
        if self.message_type == self.MessageType.RULING:
            self.is_ruling = True
        
        # Encrypt content before saving (AES-256-GCM)
        # The encryption is bulletproof - it never fails completely
        if self.content and not self.is_encrypted:
            try:
                from .encryption import MessageEncryption
                # Check if content looks like it's already encrypted
                if not MessageEncryption.is_encrypted(self.content):
                    self.content = MessageEncryption.encrypt(self.content)
                    self.is_encrypted = True
                else:
                    # Already encrypted
                    self.is_encrypted = True
            except Exception as e:
                logger.error(f"Encryption setup failed for message: {e}")
                # The new encryption never fails, but just in case
                self.is_encrypted = False
            
        super().save(*args, **kwargs)
    
    def get_decrypted_content(self):
        """
        Decrypt and return message content.
        Uses bulletproof decryption that NEVER fails - always returns usable text.
        """
        if not self.content:
            return ""
        
        if not self.is_encrypted:
            return self.content
        
        try:
            from .encryption import MessageEncryption
            # This NEVER throws - returns graceful fallback on failure
            return MessageEncryption.decrypt(self.content)
        except Exception as e:
            # This should never happen with new encryption, but just in case
            logger.error(f"Unexpected decrypt error for message {self.pk}: {e}")
            return "[Message content unavailable]"

    def __str__(self):
        return f"Message by {self.sender} in {self.thread.subject}"


class CommunicationAuditLog(models.Model):
    """
    Tamper-proof audit trail for all communication actions.
    Every action generates an immutable audit entry.
    """
    class Action(models.TextChoices):
        THREAD_CREATED = 'THREAD_CREATED', _('Thread Created')
        MESSAGE_SENT = 'MESSAGE_SENT', _('Message Sent')
        THREAD_CLOSED = 'THREAD_CLOSED', _('Thread Closed')
        THREAD_ESCALATED = 'THREAD_ESCALATED', _('Thread Escalated')
        PARTICIPANT_ADDED = 'PARTICIPANT_ADDED', _('Participant Added')
        PARTICIPANT_REMOVED = 'PARTICIPANT_REMOVED', _('Participant Removed')
        NOTIFICATION_SENT = 'NOTIFICATION_SENT', _('Notification Sent')
        # Additional actions for messaging features
        CLARIFICATION_REQUESTED = 'CLARIFICATION_REQUESTED', _('Clarification Requested')
        CLARIFICATION_RESPONDED = 'CLARIFICATION_RESPONDED', _('Clarification Responded')
        RULING_ISSUED = 'RULING_ISSUED', _('Ruling Issued')
        ESCALATION_TRIGGERED = 'ESCALATION_TRIGGERED', _('Escalation Triggered')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Actor (who performed the action)
    actor = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True, related_name='communication_actions')
    actor_role = models.CharField(max_length=100, help_text="Role at time of action")
    
    # Action details
    action = models.CharField(max_length=100, choices=Action.choices)
    resource_type = models.CharField(max_length=100, help_text="Type of resource (Thread, Message, etc.)")
    resource_id = models.UUIDField(help_text="ID of the affected resource")
    
    # Context
    details = models.JSONField(default=dict, blank=True, help_text="Additional context about the action")
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    
    # Timestamp
    timestamp = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = _('Communication Audit Log')
        verbose_name_plural = _('Communication Audit Logs')
        ordering = ['-timestamp']

    def save(self, *args, **kwargs):
        # Enforce immutability - prevent updates to existing records
        if not self._state.adding and self.pk:
            raise Exception("Audit logs are immutable and cannot be modified.")
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.action} by {self.actor} at {self.timestamp}"


class Notification(models.Model):
    """
    In-system notifications for communication events.
    Distinct from emails or external notifications.
    """
    class NotificationType(models.TextChoices):
        NEW_MESSAGE = 'NEW_MESSAGE', _('New Message')
        THREAD_ASSIGNED = 'THREAD_ASSIGNED', _('Thread Assigned')
        RULING_ISSUED = 'RULING_ISSUED', _('Ruling Issued')
        CLARIFICATION_REQUESTED = 'CLARIFICATION_REQUESTED', _('Clarification Requested')
        SLA_APPROACHING = 'SLA_APPROACHING', _('SLA Deadline Approaching')
        THREAD_ESCALATED = 'THREAD_ESCALATED', _('Thread Escalated')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    recipient = models.ForeignKey('users.User', on_delete=models.CASCADE, related_name='notifications')
    notification_type = models.CharField(max_length=50, choices=NotificationType.choices)
    
    title = models.CharField(max_length=255)
    message = models.TextField()
    
    # Link to context
    context_type = models.ForeignKey(ContentType, on_delete=models.CASCADE, null=True, blank=True)
    context_id = models.UUIDField(null=True, blank=True)
    deep_link = models.CharField(max_length=500, blank=True, help_text="Direct URL to the relevant page")
    
    is_read = models.BooleanField(default=False)
    read_at = models.DateTimeField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['recipient', 'is_read']),
            models.Index(fields=['notification_type']),
        ]

    def __str__(self):
        return f"[{self.notification_type}] {self.title} -> {self.recipient}"


class MessageReadReceipt(models.Model):
    """
    Track when messages are read by participants.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    message = models.ForeignKey(Message, on_delete=models.CASCADE, related_name='read_receipts')
    user = models.ForeignKey('users.User', on_delete=models.CASCADE)
    read_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        unique_together = ['message', 'user']
        ordering = ['-read_at']
        verbose_name = _('Message Read Receipt')
        verbose_name_plural = _('Message Read Receipts')
    
    def __str__(self):
        return f"{self.user.username} read message at {self.read_at}"


class Attachment(models.Model):
    """
    File attachments for messages.
    Message can be null initially for uploads before message is sent.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    message = models.ForeignKey(Message, on_delete=models.CASCADE, related_name='attachments', null=True, blank=True)
    file = models.FileField(upload_to='communications/attachments/%Y/%m/%d/')
    filename = models.CharField(max_length=255)
    file_size = models.PositiveIntegerField(help_text="File size in bytes")
    content_type = models.CharField(max_length=100)
    uploaded_at = models.DateTimeField(auto_now_add=True)
    uploaded_by = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True)
    
    class Meta:
        ordering = ['-uploaded_at']
        verbose_name = _('Attachment')
        verbose_name_plural = _('Attachments')
    
    def __str__(self):
        return f"{self.filename} ({self.file_size} bytes)"


class ThreadParticipant(models.Model):
    """
    Through model for Thread participants with additional metadata.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    thread = models.ForeignKey(Thread, on_delete=models.CASCADE, related_name='thread_participants')
    user = models.ForeignKey('users.User', on_delete=models.CASCADE, related_name='user_threads')
    
    # Mute functionality
    is_muted = models.BooleanField(default=False)
    muted_until = models.DateTimeField(null=True, blank=True, help_text="Mute until this time (null = forever)")
    
    # Pin functionality
    is_pinned = models.BooleanField(default=False)
    pinned_at = models.DateTimeField(null=True, blank=True)
    
    # Tracking
    joined_at = models.DateTimeField(auto_now_add=True)
    left_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        unique_together = ['thread', 'user']
        ordering = ['-is_pinned', '-joined_at']
        verbose_name = _('Thread Participant')
        verbose_name_plural = _('Thread Participants')
    
    def __str__(self):
        return f"{self.user.username} in {self.thread.subject}"



================================================
FILE: backend/communications/permissions.py
================================================
"""
Role-Based Access Control for Communications System.
All rules are enforced server-side for security.

User Roles (from users.models.User.Roles):
- SPV_Official: SPV Official
- PMNC_Team: PMNC Team
- EPC_Contractor: EPC Contractor
- Consultant_Design: Design Consultant
- Govt_Department: Government Department
- NICDC_HQ: NICDC HQ
"""
from rest_framework import permissions


class CommunicationPermissions:
    """
    Central permission matrix for the communications system.
    """
    
    # Roles that can initiate new threads
    CAN_INITIATE_THREAD = ['SPV_Official', 'PMNC_Team', 'Govt_Department', 'NICDC_HQ']
    
    # Roles that can send messages (reply)
    CAN_SEND_MESSAGE = ['SPV_Official', 'PMNC_Team', 'EPC_Contractor', 'Consultant_Design', 'Govt_Department', 'NICDC_HQ']
    
    # Roles that can request clarifications
    CAN_REQUEST_CLARIFICATION = ['SPV_Official', 'PMNC_Team', 'Govt_Department', 'NICDC_HQ']
    
    # Roles that can issue rulings (authoritative decisions)
    CAN_ISSUE_RULING = ['SPV_Official', 'NICDC_HQ']
    
    # Roles that can view internal notes
    CAN_VIEW_INTERNAL_NOTES = ['SPV_Official', 'PMNC_Team', 'Govt_Department', 'NICDC_HQ']
    
    # Roles that can close threads
    CAN_CLOSE_THREAD = ['SPV_Official', 'PMNC_Team', 'NICDC_HQ']
    
    # Roles that can escalate manually
    CAN_ESCALATE = ['SPV_Official', 'PMNC_Team', 'Govt_Department', 'NICDC_HQ']

    @classmethod
    def can_initiate_thread(cls, user):
        # Allow all authenticated users to initiate threads
        return True
        # return user.role in cls.CAN_INITIATE_THREAD

    @classmethod
    def can_send_message(cls, user):
        # Allow all authenticated users to send messages
        return True
        # return user.role in cls.CAN_SEND_MESSAGE

    @classmethod
    def can_request_clarification(cls, user):
        return user.role in cls.CAN_REQUEST_CLARIFICATION

    @classmethod
    def can_issue_ruling(cls, user):
        return user.role in cls.CAN_ISSUE_RULING

    @classmethod
    def can_view_internal_notes(cls, user):
        return user.role in cls.CAN_VIEW_INTERNAL_NOTES

    @classmethod
    def can_close_thread(cls, user):
        return user.role in cls.CAN_CLOSE_THREAD

    @classmethod
    def can_escalate(cls, user):
        return user.role in cls.CAN_ESCALATE


class CanInitiateThread(permissions.BasePermission):
    """
    Permission check for initiating new threads.
    """
    message = "Your role is not authorized to initiate communication threads."

    def has_permission(self, request, view):
        if request.method in permissions.SAFE_METHODS:
            return True
        return CommunicationPermissions.can_initiate_thread(request.user)


class CanSendMessage(permissions.BasePermission):
    """
    Permission check for sending messages.
    """
    message = "Your role is not authorized to send messages."

    def has_permission(self, request, view):
        if request.method in permissions.SAFE_METHODS:
            return True
        return CommunicationPermissions.can_send_message(request.user)


class CanIssueRuling(permissions.BasePermission):
    """
    Permission check for issuing rulings.
    Only SPV_Official can issue authoritative rulings.
    """
    message = "Only SPV Officials are authorized to issue rulings."

    def has_permission(self, request, view):
        if request.method in permissions.SAFE_METHODS:
            return True
        return CommunicationPermissions.can_issue_ruling(request.user)


class CanCloseThread(permissions.BasePermission):
    """
    Permission check for closing threads.
    """
    message = "Your role is not authorized to close communication threads."

    def has_permission(self, request, view):
        return CommunicationPermissions.can_close_thread(request.user)


class CanViewInternalNotes(permissions.BasePermission):
    """
    Permission check for viewing internal notes.
    Contractors and external users cannot see internal notes.
    """
    message = "Internal notes are not accessible to your role."

    def has_object_permission(self, request, view, obj):
        # Check if the thread or message is internal
        if hasattr(obj, 'thread_type'):
            if obj.thread_type == 'INTERNAL_NOTE':
                return CommunicationPermissions.can_view_internal_notes(request.user)
        if hasattr(obj, 'message_type'):
            if obj.message_type == 'INTERNAL':
                return CommunicationPermissions.can_view_internal_notes(request.user)
        return True



================================================
FILE: backend/communications/serializers.py
================================================
"""
Serializers for the Communications System.
"""
from rest_framework import serializers
from django.contrib.contenttypes.models import ContentType
from .models import Thread, Message, CommunicationAuditLog, Notification, Attachment


class AttachmentSerializer(serializers.ModelSerializer):
    """
    Serializer for Attachment model.
    Download happens via secure authenticated endpoint, no URL exposed.
    """
    class Meta:
        model = Attachment
        fields = [
            'id', 'filename', 'file_size', 'content_type', 
            'uploaded_at', 'uploaded_by'
        ]
        read_only_fields = ['id', 'uploaded_at', 'uploaded_by']


class MessageSerializer(serializers.ModelSerializer):
    """
    Serializer for Message model.
    Read-only for most fields due to immutability.
    Content is decrypted for authorized users.
    """
    sender_name = serializers.SerializerMethodField()
    references_content = serializers.SerializerMethodField()
    content = serializers.SerializerMethodField()  # Decrypt on read
    attachments = AttachmentSerializer(many=True, read_only=True)
    
    class Meta:
        model = Message
        fields = [
            'id', 'thread', 'sender', 'sender_name', 'sender_role',
            'content', 'message_type', 'is_ruling', 'references',
            'references_content', 'created_at', 'is_encrypted', 'attachments'
        ]
        read_only_fields = ['id', 'sender', 'sender_role', 'is_ruling', 'created_at', 'is_encrypted']
    
    def get_content(self, obj):
        """Return decrypted message content."""
        return obj.get_decrypted_content()
    
    def get_sender_name(self, obj):
        if obj.sender:
            return f"{obj.sender.first_name} {obj.sender.last_name}".strip() or obj.sender.username
        return 'Unknown'
    
    def get_references_content(self, obj):
        if obj.references:
            decrypted = obj.references.get_decrypted_content()
            return decrypted[:100] + '...' if len(decrypted) > 100 else decrypted
        return None


class MessageCreateSerializer(serializers.ModelSerializer):
    """
    Serializer for creating new messages.
    """
    class Meta:
        model = Message
        fields = ['content', 'message_type', 'references']
    
    def validate_message_type(self, value):
        user = self.context['request'].user
        from .permissions import CommunicationPermissions
        
        # Validate ruling permissions
        if value == Message.MessageType.RULING:
            if not CommunicationPermissions.can_issue_ruling(user):
                raise serializers.ValidationError("Your role is not authorized to issue rulings.")
        
        # Validate clarification request permissions
        if value == Message.MessageType.CLARIFICATION_REQUEST:
            if not CommunicationPermissions.can_request_clarification(user):
                raise serializers.ValidationError("Your role is not authorized to request clarifications.")
        
        return value


class ThreadSerializer(serializers.ModelSerializer):
    """
    Serializer for Thread model with nested messages.
    """
    initiated_by_name = serializers.SerializerMethodField()
    messages = MessageSerializer(many=True, read_only=True)
    message_count = serializers.SerializerMethodField()
    context_display = serializers.SerializerMethodField()
    context_model = serializers.SerializerMethodField()
    last_message_at = serializers.SerializerMethodField()
    is_pinned = serializers.SerializerMethodField()
    is_muted = serializers.SerializerMethodField()
    participants = serializers.SerializerMethodField()
    
    class Meta:
        model = Thread
        fields = [
            'id', 'subject', 'context_type', 'context_id', 'context_display', 'context_model',
            'thread_type', 'status', 'initiated_by', 'initiated_by_name',
            'initiated_by_role', 'sla_deadline', 'created_at', 'closed_at',
            'closed_by', 'messages', 'message_count', 'last_message_at',
            'is_pinned', 'is_muted', 'participants'
        ]
        read_only_fields = [
            'id', 'initiated_by', 'initiated_by_role', 'created_at',
            'closed_at', 'closed_by'
        ]

    def get_participants(self, obj):
        return [
            {
                'id': p.id,
                'username': p.username,
                'email': p.email,
                'role': p.role,
                'full_name': f"{p.first_name} {p.last_name}".strip() or p.username
            }
            for p in obj.participants.all()
        ]
    
    def get_initiated_by_name(self, obj):
        if obj.initiated_by:
            return f"{obj.initiated_by.first_name} {obj.initiated_by.last_name}".strip() or obj.initiated_by.username
        return 'Unknown'
    
    def get_message_count(self, obj):
        return obj.messages.count()
    
    def get_context_display(self, obj):
        """Get a human-readable representation of the linked context."""
        # Handle general chats (DM, Group Chat) without context
        if not obj.context_type:
            if obj.thread_type == 'DIRECT_MESSAGE':
                return 'Direct Message'
            elif obj.thread_type == 'GROUP_CHAT':
                return 'Group Chat'
            return 'General Chat'
        
        try:
            context = obj.context_object
            if context:
                return str(context)
        except:
            pass
        return f"{obj.context_type.model} ({obj.context_id})"
    
    def get_context_model(self, obj):
        if obj.context_type:
            return obj.context_type.model
        return None
    
    def get_last_message_at(self, obj):
        last_msg = obj.messages.order_by('-created_at').first()
        return last_msg.created_at if last_msg else obj.created_at
    
    def get_is_pinned(self, obj):
        """Check if thread is pinned for the current user."""
        request = self.context.get('request')
        if request and request.user:
            from .models import ThreadParticipant
            try:
                participant = ThreadParticipant.objects.get(thread=obj, user=request.user)
                return participant.is_pinned
            except ThreadParticipant.DoesNotExist:
                return False
        return False
    
    def get_is_muted(self, obj):
        """Check if thread is muted for the current user."""
        request = self.context.get('request')
        if request and request.user:
            from .models import ThreadParticipant
            from django.utils import timezone
            try:
                participant = ThreadParticipant.objects.get(thread=obj, user=request.user)
                # Check if muted and not expired
                if participant.is_muted:
                    if participant.muted_until is None:  # Forever
                        return True
                    elif participant.muted_until > timezone.now():  # Not expired
                        return True
                    else:  # Expired
                        participant.is_muted = False
                        participant.muted_until = None
                        participant.save()
                        return False
                return False
            except ThreadParticipant.DoesNotExist:
                return False
        return False


class ThreadListSerializer(serializers.ModelSerializer):
    """
    Lightweight serializer for thread list views.
    Includes participants for DM name resolution.
    """
    initiated_by_name = serializers.SerializerMethodField()
    message_count = serializers.SerializerMethodField()
    last_message_preview = serializers.SerializerMethodField()
    unread_count = serializers.SerializerMethodField()
    participants = serializers.SerializerMethodField()
    
    class Meta:
        model = Thread
        fields = [
            'id', 'subject', 'context_type', 'context_id',
            'thread_type', 'status', 'initiated_by_name',
            'initiated_by_role', 'sla_deadline', 'created_at', 'updated_at',
            'message_count', 'last_message_preview', 'unread_count', 'participants'
        ]
    
    def get_participants(self, obj):
        """Return minimal participant info for DM name resolution."""
        return [
            {
                'id': p.id,
                'username': p.username,
                'full_name': f"{p.first_name} {p.last_name}".strip() or p.username
            }
            for p in obj.participants.all()[:10]  # Limit for performance
        ]
    
    def get_initiated_by_name(self, obj):
        if obj.initiated_by:
            return f"{obj.initiated_by.first_name} {obj.initiated_by.last_name}".strip() or obj.initiated_by.username
        return 'Unknown'
    
    def get_message_count(self, obj):
        return obj.messages.count()
    
    def get_last_message_preview(self, obj):
        last_msg = obj.messages.order_by('-created_at').first()
        if last_msg:
            # Decrypt content for preview
            decrypted = last_msg.get_decrypted_content()
            content = decrypted[:80] + '...' if len(decrypted) > 80 else decrypted
            return {
                'sender': last_msg.sender.username if last_msg.sender else 'Unknown',
                'content': content,
                'created_at': last_msg.created_at
            }
        return None
    
    def get_unread_count(self, obj):
        request = self.context.get('request')
        if not request or not request.user.is_authenticated:
            return 0
            
        from .models import MessageReadReceipt
        
        # Count messages not sent by user and not read by user
        unread_count = obj.messages.exclude(sender=request.user).exclude(
            read_receipts__user=request.user
        ).count()
        
        return unread_count


class ThreadCreateSerializer(serializers.Serializer):
    """
    Serializer for creating new threads.
    """
    subject = serializers.CharField(max_length=255)
    context_type = serializers.CharField()  # e.g., 'edms.document', 'projects.project'
    context_id = serializers.UUIDField()
    thread_type = serializers.ChoiceField(choices=Thread.ThreadType.choices)
    initial_message = serializers.CharField(required=False, allow_blank=True)
    recipients = serializers.ListField(
        child=serializers.IntegerField(),
        required=False,
        allow_empty=True,
        help_text="List of user IDs to add as participants"
    )
    
    def validate_context_type(self, value):
        try:
            app_label, model = value.split('.')
            ContentType.objects.get(app_label=app_label, model=model)
        except (ValueError, ContentType.DoesNotExist):
            raise serializers.ValidationError(f"Invalid context type: {value}")
        return value
    
    def validate_thread_type(self, value):
        user = self.context['request'].user
        from .permissions import CommunicationPermissions
        
        # Internal notes require special permissions
        if value == Thread.ThreadType.INTERNAL_NOTE:
            if not CommunicationPermissions.can_view_internal_notes(user):
                raise serializers.ValidationError("Your role cannot create internal notes.")
        
        return value


class NotificationSerializer(serializers.ModelSerializer):
    """
    Serializer for Notification model.
    """
    class Meta:
        model = Notification
        fields = [
            'id', 'notification_type', 'title', 'message',
            'deep_link', 'is_read', 'read_at', 'created_at'
        ]
        read_only_fields = ['id', 'notification_type', 'title', 'message', 'deep_link', 'created_at']


class CommunicationAuditLogSerializer(serializers.ModelSerializer):
    """
    Serializer for audit log entries (read-only).
    """
    actor_name = serializers.SerializerMethodField()
    
    class Meta:
        model = CommunicationAuditLog
        fields = [
            'id', 'actor', 'actor_name', 'actor_role', 'action',
            'resource_type', 'resource_id', 'details',
            'ip_address', 'timestamp'
        ]
        read_only_fields = fields
    
    def get_actor_name(self, obj):
        if obj.actor:
            return obj.actor.username
        return 'System'



================================================
FILE: backend/communications/services.py
================================================
"""
Services for Communications System.
Handles notification triggers, escalation logic, and audit logging.
"""
from django.utils import timezone
from django.contrib.contenttypes.models import ContentType
from datetime import timedelta

from .models import Thread, Message, CommunicationAuditLog, Notification


class AuditService:
    """
    Creates immutable audit log entries for all communication actions.
    """
    
    @staticmethod
    def log(actor, action, resource_type, resource_id, details=None, request=None):
        """
        Create an audit log entry.
        
        Args:
            actor: User performing the action
            action: CommunicationAuditLog.Action choice
            resource_type: 'Thread' or 'Message'
            resource_id: UUID of the resource
            details: Additional context (dict)
            request: HTTP request for IP extraction
        """
        ip_address = None
        
        if request:
            ip_address = request.META.get('REMOTE_ADDR')
        
        return CommunicationAuditLog.objects.create(
            actor=actor,
            actor_role=getattr(actor, 'role', 'Unknown'),
            action=action,
            resource_type=resource_type,
            resource_id=resource_id,
            details=details or {},
            ip_address=ip_address
        )


class NotificationService:
    """
    Creates and manages notifications for communication events.
    """
    
    @staticmethod
    def notify_thread_participants(thread, notification_type, title, message, exclude_user=None, deep_link=None):
        """
        Send notification to all thread participants.
        
        Args:
            thread: Thread instance
            notification_type: Notification.NotificationType choice
            title: Notification title
            message: Notification body
            exclude_user: User to exclude (typically the sender)
            deep_link: URL to the relevant page
        """
        notifications = []
        
        for participant in thread.participants.all():
            if exclude_user and participant == exclude_user:
                continue
            
            notifications.append(Notification(
                recipient=participant,
                notification_type=notification_type,
                title=title,
                message=message,
                context_type=ContentType.objects.get_for_model(Thread),
                context_id=thread.id,
                deep_link=deep_link or f"/communications/{thread.id}"
            ))
        
        Notification.objects.bulk_create(notifications)
        return notifications
    
    @staticmethod
    def notify_user(user, notification_type, title, message, context_object=None, deep_link=None):
        """
        Send notification to a specific user.
        """
        context_type = None
        context_id = None
        
        if context_object:
            context_type = ContentType.objects.get_for_model(context_object)
            context_id = context_object.pk
        
        return Notification.objects.create(
            recipient=user,
            notification_type=notification_type,
            title=title,
            message=message,
            context_type=context_type,
            context_id=context_id,
            deep_link=deep_link or ''
        )


class EscalationService:
    """
    Handles SLA monitoring and automatic escalation.
    """
    
    # Default SLA times (in hours)
    SLA_CLARIFICATION_RESPONSE = 48  # 2 days
    SLA_RULING_REQUIRED = 72  # 3 days
    
    # Role hierarchy for escalation (from lowest to highest authority)
    ESCALATION_CHAIN = [
        'EPC_Contractor',
        'Consultant_Design',
        'PMNC_Team',
        'Govt_Department',
        'NICDC_HQ',
        'SPV_Official',
    ]
    
    @classmethod
    def set_sla_deadline(cls, thread):
        """
        Set the SLA deadline based on thread type.
        """
        if thread.thread_type == Thread.ThreadType.CLARIFICATION:
            hours = cls.SLA_CLARIFICATION_RESPONSE
        elif thread.thread_type == Thread.ThreadType.RULING:
            hours = cls.SLA_RULING_REQUIRED
        else:
            hours = cls.SLA_CLARIFICATION_RESPONSE  # Default
        
        thread.sla_deadline = timezone.now() + timedelta(hours=hours)
        thread.save(update_fields=['sla_deadline'])
        return thread.sla_deadline
    
    @classmethod
    def check_and_escalate(cls):
        """
        Check all open threads for SLA breaches and escalate if needed.
        Should be called by a scheduled task (e.g., Celery beat).
        """
        now = timezone.now()
        breached_threads = Thread.objects.filter(
            status__in=[Thread.Status.OPEN, Thread.Status.PENDING_RESPONSE],
            sla_deadline__lt=now
        ).exclude(status=Thread.Status.ESCALATED)
        
        escalated = []
        
        for thread in breached_threads:
            # Mark as escalated
            thread.status = Thread.Status.ESCALATED
            thread.save(update_fields=['status'])
            
            # Find next authority
            next_authority = cls.get_next_authority(thread.initiated_by_role)
            
            # Create escalation notification
            NotificationService.notify_thread_participants(
                thread=thread,
                notification_type=Notification.NotificationType.ESCALATION,
                title=f"ESCALATION: {thread.subject}",
                message=f"This thread has breached SLA and has been escalated. Immediate action required.",
                deep_link=f"/communications/{thread.id}"
            )
            
            # Audit log
            AuditService.log(
                actor=None,  # System action
                action=CommunicationAuditLog.Action.ESCALATION_TRIGGERED,
                resource_type='Thread',
                resource_id=thread.id,
                details={'reason': 'SLA breach', 'escalated_to': next_authority}
            )
            
            escalated.append(thread)
        
        return escalated
    
    @classmethod
    def get_next_authority(cls, current_role):
        """
        Get the next role in the escalation chain.
        """
        try:
            current_index = cls.ESCALATION_CHAIN.index(current_role)
            if current_index < len(cls.ESCALATION_CHAIN) - 1:
                return cls.ESCALATION_CHAIN[current_index + 1]
        except ValueError:
            pass
        return 'SPV_Official'  # Default to highest authority


class CommunicationService:
    """
    High-level service for communication operations.
    """
    
    @staticmethod
    def create_thread(user, subject, context_object, thread_type, request=None):
        """
        Create a new communication thread.
        """
        thread = Thread.objects.create(
            subject=subject,
            context_type=ContentType.objects.get_for_model(context_object),
            context_id=context_object.pk,
            thread_type=thread_type,
            initiated_by=user,
            initiated_by_role=getattr(user, 'role', 'Unknown'),
            status=Thread.Status.OPEN
        )
        
        # Add creator as participant
        thread.participants.add(user)
        
        # Set SLA deadline
        EscalationService.set_sla_deadline(thread)
        
        # Audit log
        AuditService.log(
            actor=user,
            action=CommunicationAuditLog.Action.THREAD_CREATED,
            resource_type='Thread',
            resource_id=thread.id,
            details={'subject': subject, 'type': thread_type},
            request=request
        )
        
        return thread
    
    @staticmethod
    def send_message(user, thread, content, message_type, reference=None, request=None):
        """
        Send a message in a thread.
        """
        message = Message.objects.create(
            thread=thread,
            sender=user,
            sender_role=getattr(user, 'role', 'Unknown'),
            content=content,
            message_type=message_type,
            references=reference
        )
        
        # Add sender to participants if not already
        thread.participants.add(user)
        
        # Determine audit action
        if message_type == Message.MessageType.CLARIFICATION_REQUEST:
            action = CommunicationAuditLog.Action.CLARIFICATION_REQUESTED
            notification_type = Notification.NotificationType.CLARIFICATION_REQUESTED
            title = f"Clarification Requested: {thread.subject}"
        elif message_type == Message.MessageType.CLARIFICATION_RESPONSE:
            action = CommunicationAuditLog.Action.CLARIFICATION_RESPONDED
            notification_type = Notification.NotificationType.CLARIFICATION_RESPONDED
            title = f"Clarification Received: {thread.subject}"
        elif message_type == Message.MessageType.RULING:
            action = CommunicationAuditLog.Action.RULING_ISSUED
            notification_type = Notification.NotificationType.RULING_ISSUED
            title = f"Ruling Issued: {thread.subject}"
        else:
            action = CommunicationAuditLog.Action.MESSAGE_SENT
            notification_type = Notification.NotificationType.NEW_MESSAGE
            title = f"New Message: {thread.subject}"
        
        # Audit log
        AuditService.log(
            actor=user,
            action=action,
            resource_type='Message',
            resource_id=message.id,
            details={'thread_id': str(thread.id), 'message_type': message_type},
            request=request
        )
        
        # Notify participants
        NotificationService.notify_thread_participants(
            thread=thread,
            notification_type=notification_type,
            title=title,
            message=content[:200] + '...' if len(content) > 200 else content,
            exclude_user=user,
            deep_link=f"/communications/{thread.id}"
        )
        
        # Explicitly update thread timestamp for sorting
        thread.save()
        
        return message
    
    @staticmethod
    def close_thread(user, thread, request=None):
        """
        Close a communication thread.
        """
        thread.status = Thread.Status.CLOSED
        thread.closed_at = timezone.now()
        thread.closed_by = user
        thread.save(update_fields=['status', 'closed_at', 'closed_by'])
        
        # Audit log
        AuditService.log(
            actor=user,
            action=CommunicationAuditLog.Action.THREAD_CLOSED,
            resource_type='Thread',
            resource_id=thread.id,
            details={'closed_by_role': getattr(user, 'role', 'Unknown')},
            request=request
        )
        
        # Notify participants
        NotificationService.notify_thread_participants(
            thread=thread,
            notification_type=Notification.NotificationType.THREAD_CLOSED,
            title=f"Thread Closed: {thread.subject}",
            message=f"This thread has been closed by {user.username}.",
            exclude_user=user,
            deep_link=f"/communications/{thread.id}"
        )
        
        return thread


class ChatService:
    """Service for managing general chat functionality (DMs and Group Chats)."""
    
    @staticmethod
    def create_direct_message(user, recipient):
        """
        Create or get existing DM thread between two users.
        Returns existing thread if one already exists.
        """
        # Check if DM already exists between these two users
        existing = Thread.objects.filter(
            thread_type=Thread.ThreadType.DIRECT_MESSAGE,
            context_type__isnull=True,
            context_id__isnull=True
        ).filter(
            participants=user
        ).filter(
            participants=recipient
        ).first()
        
        if existing:
            return existing
        
        # Create new DM thread
        thread = Thread.objects.create(
            subject=f"Chat with {recipient.username}",
            thread_type=Thread.ThreadType.DIRECT_MESSAGE,
            initiated_by=user,
            initiated_by_role=getattr(user, 'role', 'Unknown'),
            status=Thread.Status.OPEN,
            context_type=None,
            context_id=None
        )
        thread.participants.add(user, recipient)
        
        # Audit log
        AuditService.log(
            actor=user,
            action=CommunicationAuditLog.Action.THREAD_CREATED,
            resource_type='Thread',
            resource_id=thread.id,
            details={'type': 'DIRECT_MESSAGE', 'recipient': recipient.username}
        )
        
        return thread
    
    @staticmethod
    def create_group_chat(user, participants, chat_name=None):
        """
        Create a group chat with multiple participants.
        
        Args:
            user: The user creating the chat
            participants: List of User objects to include
            chat_name: Optional custom name for the group
        
        Returns:
            Thread object
        """
        # Auto-generate name if not provided
        if not chat_name:
            participant_names = [p.username for p in participants[:3]]
            if len(participants) > 3:
                chat_name = f"Group Chat - {', '.join(participant_names)} +{len(participants) - 3} more"
            else:
                chat_name = f"Group Chat - {', '.join(participant_names)}"
        
        # Create group chat thread
        thread = Thread.objects.create(
            subject=chat_name,
            chat_name=chat_name,
            thread_type=Thread.ThreadType.GROUP_CHAT,
            initiated_by=user,
            initiated_by_role=getattr(user, 'role', 'Unknown'),
            status=Thread.Status.OPEN,
            context_type=None,
            context_id=None
        )
        
        # Add creator + all participants
        all_participants = [user] + list(participants)
        thread.participants.add(*all_participants)
        
        # Audit log
        AuditService.log(
            actor=user,
            action=CommunicationAuditLog.Action.THREAD_CREATED,
            resource_type='Thread',
            resource_id=thread.id,
            details={'type': 'GROUP_CHAT', 'participant_count': len(all_participants)}
        )
        
        return thread
    
    @staticmethod
    def get_chat_display_name(thread, current_user):
        """
        Get display name for a chat thread.
        
        For DMs: Returns the other user's name
        For Group Chats: Returns the custom chat name or generated name
        """
        if thread.thread_type == Thread.ThreadType.DIRECT_MESSAGE:
            # For DM, show the other user's name
            other_user = thread.participants.exclude(id=current_user.id).first()
            return other_user.username if other_user else "Direct Message"
        
        elif thread.thread_type == Thread.ThreadType.GROUP_CHAT:
            return thread.chat_name or thread.subject
        
        else:
            # Context-based threads use subject
            return thread.subject



================================================
FILE: backend/communications/tests.py
================================================
from django.test import TestCase

# Create your tests here.



================================================
FILE: backend/communications/urls.py
================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import ThreadViewSet, NotificationViewSet, AuditLogViewSet, AttachmentViewSet

router = DefaultRouter()
router.register(r'threads', ThreadViewSet, basename='thread')
router.register(r'notifications', NotificationViewSet, basename='notification')
router.register(r'audit-logs', AuditLogViewSet, basename='auditlog')
router.register(r'attachments', AttachmentViewSet, basename='attachment')

# Additional URL patterns for legacy endpoints
urlpatterns = [
    path('', include(router.urls)),
    # Legacy endpoint for frontend compatibility
    path('messages/upload_attachment/', AttachmentViewSet.as_view({'post': 'upload'}), name='upload_attachment'),
]



================================================
FILE: backend/communications/views.py
================================================
"""
API Views for the Communications System.
All views enforce role-based access control server-side.
"""
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser, FormParser
from django.contrib.contenttypes.models import ContentType
from django.utils import timezone
from django.http import FileResponse, Http404

from .models import Thread, Message, CommunicationAuditLog, Notification, Attachment
from .serializers import (
    ThreadSerializer, ThreadListSerializer, ThreadCreateSerializer,
    MessageSerializer, MessageCreateSerializer,
    NotificationSerializer, CommunicationAuditLogSerializer,
    AttachmentSerializer
)
from .permissions import (
    CommunicationPermissions, CanInitiateThread, CanSendMessage,
    CanIssueRuling, CanCloseThread, CanViewInternalNotes
)
from .services import CommunicationService, AuditService


class ThreadViewSet(viewsets.ModelViewSet):
    """
    ViewSet for communication threads.
    """
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        user = self.request.user
        
        # ğŸ”’ SECURITY FIX: Only show threads where user is a participant
        # No exceptions - even SPV can only see their own threads
        queryset = Thread.objects.filter(participants=user)
        
        # Filter out internal notes for unauthorized roles
        if not CommunicationPermissions.can_view_internal_notes(user):
            queryset = queryset.exclude(thread_type=Thread.ThreadType.INTERNAL_NOTE)
        
        # Filter by context if provided
        context_type = self.request.query_params.get('context_type')
        context_id = self.request.query_params.get('context_id')
        
        if context_type and context_id:
            try:
                app_label, model = context_type.split('.')
                ct = ContentType.objects.get(app_label=app_label, model=model)
                queryset = queryset.filter(context_type=ct, context_id=context_id)
            except (ValueError, ContentType.DoesNotExist):
                pass
        
        # Filter by status
        thread_status = self.request.query_params.get('status')
        if thread_status:
            queryset = queryset.filter(status=thread_status)
        
        # Filter by type
        thread_type = self.request.query_params.get('type')
        if thread_type:
            queryset = queryset.filter(thread_type=thread_type)
        
        # Sort by latest activity (optimized native field)
        queryset = queryset.order_by('-updated_at')
        
        return queryset.prefetch_related('messages', 'participants')
    
    def get_serializer_class(self):
        if self.action == 'list':
            return ThreadListSerializer
        if self.action == 'create':
            return ThreadCreateSerializer
        return ThreadSerializer
    
    def create(self, request, *args, **kwargs):
        """Create a new thread with permission check."""
        user = request.user
        
        if not CommunicationPermissions.can_initiate_thread(user):
            return Response(
                {'error': f'Your role ({getattr(user, "role", "Unknown")}) is not authorized to initiate threads.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        try:
            # Get context object
            context_type_str = serializer.validated_data['context_type']
            app_label, model = context_type_str.split('.')
            ct = ContentType.objects.get(app_label=app_label, model=model)
            model_class = ct.model_class()
            
            context_id = serializer.validated_data['context_id']
            try:
                context_object = model_class.objects.get(pk=context_id)
            except model_class.DoesNotExist:
                return Response(
                    {'error': f'{model_class.__name__} with ID {context_id} not found.'},
                    status=status.HTTP_400_BAD_REQUEST
                )
            
            # Create thread using service
            thread = CommunicationService.create_thread(
                user=user,
                subject=serializer.validated_data['subject'],
                context_object=context_object,
                thread_type=serializer.validated_data['thread_type'],
                request=request
            )
            
            # Add recipients as participants
            recipients = serializer.validated_data.get('recipients', [])
            if recipients:
                from django.contrib.auth import get_user_model
                User = get_user_model()
                recipient_users = User.objects.filter(id__in=recipients)
                thread.participants.add(*recipient_users)
            
            # Add initial message if provided
            initial_message = serializer.validated_data.get('initial_message')
            if initial_message:
                CommunicationService.send_message(
                    user=user,
                    thread=thread,
                    content=initial_message,
                    message_type=Message.MessageType.STANDARD,
                    request=request
                )
            
            return Response(ThreadSerializer(thread).data, status=status.HTTP_201_CREATED)
        
        except ContentType.DoesNotExist:
            return Response(
                {'error': f'Invalid context type: {serializer.validated_data["context_type"]}'},
                status=status.HTTP_400_BAD_REQUEST
            )
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response(
                {'error': f'Failed to create thread: {str(e)}'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )
    
    @action(detail=True, methods=['post'])
    def send_message(self, request, pk=None):
        """Send a message to the thread with optional attachments."""
        thread = self.get_object()
        user = request.user
        
        # ğŸ”’ SECURITY: Verify user is a participant in this thread
        if user not in thread.participants.all():
            return Response(
                {'error': 'Access denied. You are not a participant in this thread.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        if not CommunicationPermissions.can_send_message(user):
            return Response(
                {'error': 'Your role is not authorized to send messages.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        serializer = MessageCreateSerializer(data=request.data, context={'request': request})
        serializer.is_valid(raise_exception=True)
        
        message = CommunicationService.send_message(
            user=user,
            thread=thread,
            content=serializer.validated_data['content'],
            message_type=serializer.validated_data.get('message_type', Message.MessageType.STANDARD),
            reference=serializer.validated_data.get('references'),
            request=request
        )
        
        # Link attachments to the message
        attachment_id = request.data.get('attachment_id')  # Single attachment (legacy)
        attachment_ids = request.data.get('attachment_ids', [])  # Multiple attachments
        
        if attachment_id:
            attachment_ids = [attachment_id] + list(attachment_ids)
        
        if attachment_ids:
            # Link all attachments to this message
            Attachment.objects.filter(
                id__in=attachment_ids,
                uploaded_by=user,
                message__isnull=True  # Only unlinked attachments
            ).update(message=message)
        
        # Refresh message to include attachments
        message.refresh_from_db()
        
        return Response(MessageSerializer(message, context={'request': request}).data, status=status.HTTP_201_CREATED)
    
    @action(detail=True, methods=['post'])
    def close(self, request, pk=None):
        """Close the thread."""
        thread = self.get_object()
        user = request.user
        
        if not CommunicationPermissions.can_close_thread(user):
            return Response(
                {'error': 'Your role is not authorized to close threads.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        thread = CommunicationService.close_thread(user, thread, request)
        return Response(ThreadSerializer(thread).data)
    
    @action(detail=True, methods=['post'])
    def escalate(self, request, pk=None):
        """Manually escalate the thread."""
        thread = self.get_object()
        user = request.user
        
        if not CommunicationPermissions.can_escalate(user):
            return Response(
                {'error': 'Your role is not authorized to escalate threads.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        thread.status = Thread.Status.ESCALATED
        thread.save(update_fields=['status'])
        
        AuditService.log(
            actor=user,
            action=CommunicationAuditLog.Action.ESCALATION_TRIGGERED,
            resource_type='Thread',
            resource_id=thread.id,
            details={'manual': True, 'escalated_by': user.username},
            request=request
        )
        
        return Response(ThreadSerializer(thread).data)

    @action(detail=True, methods=['post'])
    def mark_read(self, request, pk=None):
        """Mark all messages in the thread as read for the current user."""
        thread = self.get_object()
        user = request.user
        
        from .models import MessageReadReceipt
        
        # Get all messages in thread not sent by user
        messages = thread.messages.exclude(sender=user)
        
        # Find messages that don't have a read receipt from this user
        unread_messages = messages.exclude(read_receipts__user=user)
        
        # Bulk create receipts
        receipts = [
            MessageReadReceipt(message=msg, user=user)
            for msg in unread_messages
        ]
        
        if receipts:
            MessageReadReceipt.objects.bulk_create(receipts, ignore_conflicts=True)
            
        return Response({'status': 'marked as read', 'count': len(receipts)})
    
    @action(detail=False, methods=['post'])
    def start_dm(self, request):
        """Start a direct message with a user."""
        from .services import ChatService
        from django.contrib.auth import get_user_model
        User = get_user_model()
        
        recipient_id = request.data.get('recipient_id')
        if not recipient_id:
            return Response(
                {'error': 'recipient_id is required'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            recipient = User.objects.get(id=recipient_id)
        except User.DoesNotExist:
            return Response(
                {'error': 'Recipient not found'},
                status=status.HTTP_404_NOT_FOUND
            )
        
        # Create or get existing DM
        thread = ChatService.create_direct_message(request.user, recipient)
        return Response(ThreadSerializer(thread).data, status=status.HTTP_201_CREATED)
    
    @action(detail=False, methods=['post'])
    def start_group_chat(self, request):
        """Start a group chat with multiple users."""
        from .services import ChatService
        from django.contrib.auth import get_user_model
        User = get_user_model()
        
        participant_ids = request.data.get('participant_ids', [])
        chat_name = request.data.get('chat_name', '')
        
        if not participant_ids or len(participant_ids) < 1:
            return Response(
                {'error': 'At least one participant is required'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            participants = User.objects.filter(id__in=participant_ids)
            if participants.count() != len(participant_ids):
                return Response(
                    {'error': 'Some participants not found'},
                    status=status.HTTP_404_NOT_FOUND
                )
        except Exception as e:
            return Response(
                {'error': f'Invalid participant IDs: {str(e)}'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # Create group chat
        thread = ChatService.create_group_chat(request.user, participants, chat_name)
        return Response(ThreadSerializer(thread).data, status=status.HTTP_201_CREATED)
    
    @action(detail=True, methods=['post'])
    def pin(self, request, pk=None):
        """Pin/unpin a thread for the current user."""
        from .models import ThreadParticipant
        thread = self.get_object()
        
        participant, created = ThreadParticipant.objects.get_or_create(
            thread=thread,
            user=request.user
        )
        
        # Toggle pin status
        participant.is_pinned = not participant.is_pinned
        participant.pinned_at = timezone.now() if participant.is_pinned else None
        participant.save(update_fields=['is_pinned', 'pinned_at'])
        
        return Response({
            'is_pinned': participant.is_pinned,
            'message': 'Thread pinned' if participant.is_pinned else 'Thread unpinned'
        })
    
    @action(detail=True, methods=['post'])
    def mute(self, request, pk=None):
        """Mute a thread for the current user."""
        from .models import ThreadParticipant
        from datetime import timedelta
        
        thread = self.get_object()
        duration = request.data.get('duration', 'forever')  # Options: '1h', '8h', '24h', 'forever'
        
        participant, created = ThreadParticipant.objects.get_or_create(
            thread=thread,
            user=request.user
        )
        
        # Calculate mute duration
        muted_until = None
        if duration != 'forever':
            hours = {'1h': 1, '8h': 8, '24h': 24}.get(duration, 24)
            muted_until = timezone.now() + timedelta(hours=hours)
        
        participant.is_muted = True
        participant.muted_until = muted_until
        participant.save(update_fields=['is_muted', 'muted_until'])
        
        return Response({
            'is_muted': True,
            'muted_until': muted_until,
            'message': f'Thread muted {duration}'
        })
    
    @action(detail=True, methods=['post'])
    def unmute(self, request, pk=None):
        """Unmute a thread for the current user."""
        from .models import ThreadParticipant
        
        thread = self.get_object()
        
        try:
            participant = ThreadParticipant.objects.get(thread=thread, user=request.user)
            participant.is_muted = False
            participant.muted_until = None
            participant.save(update_fields=['is_muted', 'muted_until'])
            return Response({'is_muted': False, 'message': 'Thread unmuted'})
        except ThreadParticipant.DoesNotExist:
            return Response({'error': 'Not a participant'}, status=status.HTTP_404_NOT_FOUND)
    
    @action(detail=True, methods=['post'])
    def leave_group(self, request, pk=None):
        """Leave a group chat."""
        thread = self.get_object()
        
        # Only allow leaving group chats
        if thread.thread_type != Thread.ThreadType.GROUP_CHAT:
            return Response(
                {'error': 'Can only leave group chats'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # Remove user from participants
        if request.user in thread.participants.all():
            thread.participants.remove(request.user)
            
            # Update ThreadParticipant left_at
            from .models import ThreadParticipant
            try:
                participant = ThreadParticipant.objects.get(thread=thread, user=request.user)
                participant.left_at = timezone.now()
                participant.save(update_fields=['left_at'])
            except ThreadParticipant.DoesNotExist:
                pass
            
            # Audit log
            AuditService.log(
                actor=request.user,
                action=CommunicationAuditLog.Action.PARTICIPANT_REMOVED,
                resource_type='Thread',
                resource_id=thread.id,
                details={'user': request.user.username, 'action': 'left_group'}
            )
            
            return Response({'message': 'Left group successfully'})
        
        return Response({'error': 'Not a participant'}, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'])
    def add_participants(self, request, pk=None):
        """Add participants to a group chat."""
        from django.contrib.auth import get_user_model
        User = get_user_model()
        
        thread = self.get_object()
        
        # Only allow adding to group chats
        if thread.thread_type != Thread.ThreadType.GROUP_CHAT:
            return Response(
                {'error': 'Can only add participants to group chats'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        participant_ids = request.data.get('participant_ids', [])
        if not participant_ids:
            return Response(
                {'error': 'No participants specified'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            new_participants = User.objects.filter(id__in=participant_ids)
            thread.participants.add(*new_participants)
            
            # Audit log
            AuditService.log(
                actor=request.user,
                action=CommunicationAuditLog.Action.PARTICIPANT_ADDED,
                resource_type='Thread',
                resource_id=thread.id,
                details={
                    'added_by': request.user.username,
                    'participant_count': new_participants.count()
                }
            )
            
            return Response({
                'message': f'Added {new_participants.count()} participants',
                'thread': ThreadSerializer(thread).data
            })
        except Exception as e:
            return Response(
                {'error': str(e)},
                status=status.HTTP_400_BAD_REQUEST
            )



class NotificationViewSet(viewsets.ReadOnlyModelViewSet):
    """
    ViewSet for user notifications.
    """
    serializer_class = NotificationSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        return Notification.objects.filter(recipient=self.request.user)
    
    @action(detail=False, methods=['get'])
    def unread_count(self, request):
        """Get count of unread notifications."""
        count = self.get_queryset().filter(is_read=False).count()
        return Response({'unread_count': count})
    
    @action(detail=True, methods=['patch'])
    def mark_read(self, request, pk=None):
        """Mark a notification as read."""
        notification = self.get_object()
        notification.is_read = True
        notification.read_at = timezone.now()
        notification.save(update_fields=['is_read', 'read_at'])
        return Response(self.get_serializer(notification).data)
    
    @action(detail=False, methods=['post'])
    def mark_all_read(self, request):
        """Mark all notifications as read."""
        self.get_queryset().filter(is_read=False).update(
            is_read=True,
            read_at=timezone.now()
        )
        return Response({'status': 'All notifications marked as read'})


class AuditLogViewSet(viewsets.ReadOnlyModelViewSet):
    """
    ViewSet for audit log viewing (read-only, authorized users only).
    """
    serializer_class = CommunicationAuditLogSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        user = self.request.user
        
        # Only SPV and Government officials can view audit logs
        if user.role not in ['SPV_Official', 'Govt_Official', 'Nodal_Officer']:
            return CommunicationAuditLog.objects.none()
        
        queryset = CommunicationAuditLog.objects.all()
        
        # Filter by resource
        resource_type = self.request.query_params.get('resource_type')
        resource_id = self.request.query_params.get('resource_id')
        
        if resource_type:
            queryset = queryset.filter(resource_type=resource_type)
        if resource_id:
            queryset = queryset.filter(resource_id=resource_id)
        
        # Filter by action
        action = self.request.query_params.get('action')
        if action:
            queryset = queryset.filter(action=action)
        
        # Filter by date range
        start_date = self.request.query_params.get('start_date')
        end_date = self.request.query_params.get('end_date')
        
        if start_date:
            queryset = queryset.filter(timestamp__gte=start_date)
        if end_date:
            queryset = queryset.filter(timestamp__lte=end_date)
        
        return queryset


class AttachmentViewSet(viewsets.ModelViewSet):
    """
    ViewSet for file attachments.
    Supports single and multiple file uploads.
    """
    serializer_class = AttachmentSerializer
    permission_classes = [permissions.IsAuthenticated]
    parser_classes = [MultiPartParser, FormParser]
    
    def get_queryset(self):
        user = self.request.user
        # Only show attachments from threads user participates in
        return Attachment.objects.filter(
            message__thread__participants=user
        ).select_related('message', 'uploaded_by')
    
    @action(detail=False, methods=['post'])
    def upload(self, request):
        """
        Upload a single file attachment.
        Returns the attachment ID to be linked to a message.
        """
        file = request.FILES.get('file')
        
        if not file:
            return Response(
                {'error': 'No file provided'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # Create temporary attachment (not linked to message yet)
        attachment = Attachment.objects.create(
            message=None,  # Will be linked when message is sent
            file=file,
            filename=file.name,
            file_size=file.size,
            content_type=file.content_type or 'application/octet-stream',
            uploaded_by=request.user
        )
        
        return Response({
            'id': str(attachment.id),
            'filename': attachment.filename,
            'file_size': attachment.file_size,
            'content_type': attachment.content_type
        }, status=status.HTTP_201_CREATED)
    
    @action(detail=False, methods=['post'])
    def upload_multiple(self, request):
        """
        Upload multiple files at once.
        Returns a list of attachment IDs.
        """
        files = request.FILES.getlist('files')
        
        if not files:
            return Response(
                {'error': 'No files provided'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        attachments = []
        for file in files:
            attachment = Attachment.objects.create(
                message=None,  # Will be linked when message is sent
                file=file,
                filename=file.name,
                file_size=file.size,
                content_type=file.content_type or 'application/octet-stream',
                uploaded_by=request.user
            )
            attachments.append({
                'id': str(attachment.id),
                'filename': attachment.filename,
                'file_size': attachment.file_size,
                'content_type': attachment.content_type
            })
        
        return Response({
            'attachments': attachments,
            'count': len(attachments)
        }, status=status.HTTP_201_CREATED)
    
    @action(detail=True, methods=['get'])
    def download(self, request, pk=None):
        """
        Download an attachment file.
        """
        try:
            attachment = Attachment.objects.get(pk=pk)
            
            # Check if user has access to this attachment
            if attachment.message:
                thread = attachment.message.thread
                if request.user not in thread.participants.all():
                    return Response(
                        {'error': 'Access denied'},
                        status=status.HTTP_403_FORBIDDEN
                    )
            
            # Return file response
            try:
                response = FileResponse(
                    attachment.file.open('rb'),
                    content_type=attachment.content_type
                )
                response['Content-Disposition'] = f'attachment; filename="{attachment.filename}"'
                return response
            except Exception as e:
                return Response(
                    {'error': f'File not found: {str(e)}'},
                    status=status.HTTP_404_NOT_FOUND
                )
                
        except Attachment.DoesNotExist:
            return Response(
                {'error': 'Attachment not found'},
                status=status.HTTP_404_NOT_FOUND
            )



================================================
FILE: backend/communications/management/__init__.py
================================================
# Required for Django to recognize this as a package



================================================
FILE: backend/communications/management/commands/__init__.py
================================================
# Required for Django to recognize this as a package



================================================
FILE: backend/communications/management/commands/fix_encrypted_messages.py
================================================
"""
Management command to fix corrupted/legacy encrypted messages.
Deletes messages that can't be decrypted with current key.
"""
from django.core.management.base import BaseCommand
from communications.models import Message
from communications.encryption import MessageEncryption


class Command(BaseCommand):
    help = 'Fix or delete messages with corrupted/legacy encryption'

    def add_arguments(self, parser):
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Show what would be deleted without actually deleting',
        )
        parser.add_argument(
            '--delete',
            action='store_true',
            help='Actually delete corrupted messages',
        )

    def handle(self, *args, **options):
        dry_run = options['dry_run']
        delete = options['delete']
        
        if not dry_run and not delete:
            self.stdout.write(self.style.WARNING(
                'Use --dry-run to see corrupted messages, or --delete to remove them'
            ))
            return
        
        corrupted_messages = []
        total_checked = 0
        
        self.stdout.write('Checking all encrypted messages...')
        
        for message in Message.objects.filter(is_encrypted=True):
            total_checked += 1
            try:
                content = message.get_decrypted_content()
                if content.startswith('[Message encrypted with different key'):
                    corrupted_messages.append(message)
            except Exception:
                corrupted_messages.append(message)
        
        self.stdout.write(f'Checked {total_checked} encrypted messages')
        self.stdout.write(f'Found {len(corrupted_messages)} corrupted messages')
        
        if not corrupted_messages:
            self.stdout.write(self.style.SUCCESS('No corrupted messages found!'))
            return
        
        # Show details
        for msg in corrupted_messages:
            self.stdout.write(f'  - Message {msg.id} in thread "{msg.thread.subject}"')
        
        if delete:
            # Delete corrupted messages
            for msg in corrupted_messages:
                msg.delete()
            self.stdout.write(self.style.SUCCESS(
                f'Deleted {len(corrupted_messages)} corrupted messages'
            ))
        else:
            self.stdout.write(self.style.WARNING(
                f'Would delete {len(corrupted_messages)} messages. Run with --delete to proceed.'
            ))



================================================
FILE: backend/communications/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2025-12-14 06:10

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('contenttypes', '0002_remove_content_type_name'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Thread',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('subject', models.CharField(max_length=255)),
                ('context_id', models.UUIDField()),
                ('thread_type', models.CharField(choices=[('DISCUSSION', 'Discussion'), ('CLARIFICATION', 'Clarification Request'), ('INTERNAL_NOTE', 'Internal Note'), ('RULING', 'Ruling/Decision')], default='DISCUSSION', max_length=50)),
                ('status', models.CharField(choices=[('OPEN', 'Open'), ('PENDING_RESPONSE', 'Pending Response'), ('CLOSED', 'Closed'), ('ESCALATED', 'Escalated')], default='OPEN', max_length=50)),
                ('initiated_by_role', models.CharField(help_text='Role of user at thread creation time', max_length=100)),
                ('sla_deadline', models.DateTimeField(blank=True, help_text='Deadline before auto-escalation', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('closed_at', models.DateTimeField(blank=True, null=True)),
                ('closed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='closed_threads', to=settings.AUTH_USER_MODEL)),
                ('context_type', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='contenttypes.contenttype')),
                ('initiated_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='initiated_threads', to=settings.AUTH_USER_MODEL)),
                ('participants', models.ManyToManyField(blank=True, related_name='participated_threads', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='Message',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('sender_role', models.CharField(help_text='Role of sender at message creation time', max_length=100)),
                ('content', models.TextField()),
                ('message_type', models.CharField(choices=[('STANDARD', 'Standard Message'), ('CLARIFICATION_REQUEST', 'Clarification Request'), ('CLARIFICATION_RESPONSE', 'Clarification Response'), ('RULING', 'Ruling/Decision'), ('INTERNAL', 'Internal Note')], default='STANDARD', max_length=50)),
                ('is_ruling', models.BooleanField(default=False, help_text='Marks this as an authoritative ruling')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('references', models.ForeignKey(blank=True, help_text='Reference to a previous message for corrections', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='referenced_by', to='communications.message')),
                ('sender', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='sent_messages', to=settings.AUTH_USER_MODEL)),
                ('thread', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='messages', to='communications.thread')),
            ],
            options={
                'ordering': ['created_at'],
            },
        ),
        migrations.CreateModel(
            name='CommunicationAuditLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('actor_role', models.CharField(max_length=100)),
                ('action', models.CharField(choices=[('THREAD_CREATED', 'Thread Created'), ('MESSAGE_SENT', 'Message Sent'), ('CLARIFICATION_REQUESTED', 'Clarification Requested'), ('CLARIFICATION_RESPONDED', 'Clarification Responded'), ('RULING_ISSUED', 'Ruling Issued'), ('THREAD_CLOSED', 'Thread Closed'), ('ESCALATION_TRIGGERED', 'Escalation Triggered'), ('THREAD_VIEWED', 'Thread Viewed')], max_length=50)),
                ('resource_type', models.CharField(help_text='Thread or Message', max_length=100)),
                ('resource_id', models.UUIDField()),
                ('details', models.JSONField(blank=True, default=dict)),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('user_agent', models.TextField(blank=True)),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('actor', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-timestamp'],
                'indexes': [models.Index(fields=['actor'], name='communicati_actor_i_398553_idx'), models.Index(fields=['action'], name='communicati_action_560fa2_idx'), models.Index(fields=['resource_type', 'resource_id'], name='communicati_resourc_f24059_idx'), models.Index(fields=['timestamp'], name='communicati_timesta_5feba2_idx')],
            },
        ),
        migrations.CreateModel(
            name='Notification',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('notification_type', models.CharField(choices=[('NEW_MESSAGE', 'New Message'), ('CLARIFICATION_REQUESTED', 'Clarification Requested'), ('CLARIFICATION_RESPONDED', 'Clarification Responded'), ('RULING_ISSUED', 'Ruling Issued'), ('ESCALATION', 'Escalation Alert'), ('DEADLINE_BREACH', 'Deadline Breach'), ('THREAD_CLOSED', 'Thread Closed')], max_length=50)),
                ('title', models.CharField(max_length=255)),
                ('message', models.TextField()),
                ('context_id', models.UUIDField(blank=True, null=True)),
                ('deep_link', models.CharField(blank=True, help_text='Direct URL to the relevant page', max_length=500)),
                ('is_read', models.BooleanField(default=False)),
                ('read_at', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('context_type', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='contenttypes.contenttype')),
                ('recipient', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='notifications', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['recipient', 'is_read'], name='communicati_recipie_dd2f99_idx'), models.Index(fields=['notification_type'], name='communicati_notific_8e3688_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='thread',
            index=models.Index(fields=['context_type', 'context_id'], name='communicati_context_e2a3e1_idx'),
        ),
        migrations.AddIndex(
            model_name='thread',
            index=models.Index(fields=['status'], name='communicati_status_bc6179_idx'),
        ),
        migrations.AddIndex(
            model_name='thread',
            index=models.Index(fields=['thread_type'], name='communicati_thread__cb516d_idx'),
        ),
        migrations.AddIndex(
            model_name='message',
            index=models.Index(fields=['thread'], name='communicati_thread__1d4701_idx'),
        ),
        migrations.AddIndex(
            model_name='message',
            index=models.Index(fields=['sender'], name='communicati_sender__822f5c_idx'),
        ),
        migrations.AddIndex(
            model_name='message',
            index=models.Index(fields=['message_type'], name='communicati_message_4a1d97_idx'),
        ),
    ]



================================================
FILE: backend/communications/migrations/0002_thread_chat_name_alter_thread_context_id_and_more.py
================================================
# Generated by Django 6.0 on 2025-12-23 13:33

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('communications', '0001_initial'),
        ('contenttypes', '0002_remove_content_type_name'),
    ]

    operations = [
        migrations.AddField(
            model_name='thread',
            name='chat_name',
            field=models.CharField(blank=True, help_text='Custom name for group chats', max_length=255),
        ),
        migrations.AlterField(
            model_name='thread',
            name='context_id',
            field=models.UUIDField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='thread',
            name='context_type',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='contenttypes.contenttype'),
        ),
        migrations.AlterField(
            model_name='thread',
            name='thread_type',
            field=models.CharField(choices=[('DISCUSSION', 'Discussion'), ('CLARIFICATION', 'Clarification Request'), ('INTERNAL_NOTE', 'Internal Note'), ('RULING', 'Ruling/Decision'), ('DIRECT_MESSAGE', 'Direct Message'), ('GROUP_CHAT', 'Group Chat')], default='DISCUSSION', max_length=50),
        ),
    ]



================================================
FILE: backend/communications/migrations/0003_attachment_messagereadreceipt_threadparticipant_and_more.py
================================================
# Generated by Django 6.0 on 2025-12-23 14:59

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('communications', '0002_thread_chat_name_alter_thread_context_id_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Attachment',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('file', models.FileField(upload_to='communications/attachments/%Y/%m/%d/')),
                ('filename', models.CharField(max_length=255)),
                ('file_size', models.PositiveIntegerField(help_text='File size in bytes')),
                ('content_type', models.CharField(max_length=100)),
                ('uploaded_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'verbose_name': 'Attachment',
                'verbose_name_plural': 'Attachments',
                'ordering': ['-uploaded_at'],
            },
        ),
        migrations.CreateModel(
            name='MessageReadReceipt',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('read_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'verbose_name': 'Message Read Receipt',
                'verbose_name_plural': 'Message Read Receipts',
                'ordering': ['-read_at'],
            },
        ),
        migrations.CreateModel(
            name='ThreadParticipant',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('is_muted', models.BooleanField(default=False)),
                ('muted_until', models.DateTimeField(blank=True, help_text='Mute until this time (null = forever)', null=True)),
                ('is_pinned', models.BooleanField(default=False)),
                ('pinned_at', models.DateTimeField(blank=True, null=True)),
                ('joined_at', models.DateTimeField(auto_now_add=True)),
                ('left_at', models.DateTimeField(blank=True, null=True)),
            ],
            options={
                'verbose_name': 'Thread Participant',
                'verbose_name_plural': 'Thread Participants',
                'ordering': ['-is_pinned', '-joined_at'],
            },
        ),
        migrations.AlterModelOptions(
            name='communicationauditlog',
            options={'ordering': ['-timestamp'], 'verbose_name': 'Communication Audit Log', 'verbose_name_plural': 'Communication Audit Logs'},
        ),
        migrations.AlterModelOptions(
            name='thread',
            options={'ordering': ['-created_at'], 'verbose_name': 'Communication Thread', 'verbose_name_plural': 'Communication Threads'},
        ),
        migrations.RemoveIndex(
            model_name='communicationauditlog',
            name='communicati_actor_i_398553_idx',
        ),
        migrations.RemoveIndex(
            model_name='communicationauditlog',
            name='communicati_action_560fa2_idx',
        ),
        migrations.RemoveIndex(
            model_name='communicationauditlog',
            name='communicati_resourc_f24059_idx',
        ),
        migrations.RemoveIndex(
            model_name='communicationauditlog',
            name='communicati_timesta_5feba2_idx',
        ),
        migrations.AddField(
            model_name='thread',
            name='updated_at',
            field=models.DateTimeField(auto_now=True),
        ),
        migrations.AlterField(
            model_name='communicationauditlog',
            name='action',
            field=models.CharField(choices=[('THREAD_CREATED', 'Thread Created'), ('MESSAGE_SENT', 'Message Sent'), ('THREAD_CLOSED', 'Thread Closed'), ('THREAD_ESCALATED', 'Thread Escalated'), ('PARTICIPANT_ADDED', 'Participant Added'), ('PARTICIPANT_REMOVED', 'Participant Removed'), ('NOTIFICATION_SENT', 'Notification Sent')], max_length=100),
        ),
        migrations.AlterField(
            model_name='communicationauditlog',
            name='actor',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='communication_actions', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AlterField(
            model_name='communicationauditlog',
            name='actor_role',
            field=models.CharField(help_text='Role at time of action', max_length=100),
        ),
        migrations.AlterField(
            model_name='communicationauditlog',
            name='details',
            field=models.JSONField(blank=True, default=dict, help_text='Additional context about the action'),
        ),
        migrations.AlterField(
            model_name='communicationauditlog',
            name='resource_id',
            field=models.UUIDField(help_text='ID of the affected resource'),
        ),
        migrations.AlterField(
            model_name='communicationauditlog',
            name='resource_type',
            field=models.CharField(help_text='Type of resource (Thread, Message, etc.)', max_length=100),
        ),
        migrations.AlterField(
            model_name='message',
            name='is_ruling',
            field=models.BooleanField(default=False, help_text='Official ruling flag for govt oversight'),
        ),
        migrations.AlterField(
            model_name='message',
            name='message_type',
            field=models.CharField(choices=[('STANDARD', 'Standard Message'), ('CLARIFICATION_REQUEST', 'Clarification Request'), ('CLARIFICATION_RESPONSE', 'Clarification Response'), ('RULING', 'Official Ruling')], default='STANDARD', max_length=50),
        ),
        migrations.AlterField(
            model_name='message',
            name='references',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='replies', to='communications.message'),
        ),
        migrations.AlterField(
            model_name='message',
            name='sender',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL),
        ),
        migrations.AlterField(
            model_name='notification',
            name='notification_type',
            field=models.CharField(choices=[('NEW_MESSAGE', 'New Message'), ('THREAD_ASSIGNED', 'Thread Assigned'), ('RULING_ISSUED', 'Ruling Issued'), ('CLARIFICATION_REQUESTED', 'Clarification Requested'), ('SLA_APPROACHING', 'SLA Deadline Approaching'), ('THREAD_ESCALATED', 'Thread Escalated')], max_length=50),
        ),
        migrations.AddField(
            model_name='attachment',
            name='message',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='attachments', to='communications.message'),
        ),
        migrations.AddField(
            model_name='attachment',
            name='uploaded_by',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='messagereadreceipt',
            name='message',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='read_receipts', to='communications.message'),
        ),
        migrations.AddField(
            model_name='messagereadreceipt',
            name='user',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='threadparticipant',
            name='thread',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='thread_participants', to='communications.thread'),
        ),
        migrations.AddField(
            model_name='threadparticipant',
            name='user',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='user_threads', to=settings.AUTH_USER_MODEL),
        ),
        migrations.RemoveField(
            model_name='communicationauditlog',
            name='user_agent',
        ),
        migrations.AlterUniqueTogether(
            name='messagereadreceipt',
            unique_together={('message', 'user')},
        ),
        migrations.AlterUniqueTogether(
            name='threadparticipant',
            unique_together={('thread', 'user')},
        ),
    ]



================================================
FILE: backend/communications/migrations/0004_alter_communicationauditlog_action.py
================================================
# Generated by Django 6.0 on 2025-12-24 14:11

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('communications', '0003_attachment_messagereadreceipt_threadparticipant_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='communicationauditlog',
            name='action',
            field=models.CharField(choices=[('THREAD_CREATED', 'Thread Created'), ('MESSAGE_SENT', 'Message Sent'), ('THREAD_CLOSED', 'Thread Closed'), ('THREAD_ESCALATED', 'Thread Escalated'), ('PARTICIPANT_ADDED', 'Participant Added'), ('PARTICIPANT_REMOVED', 'Participant Removed'), ('NOTIFICATION_SENT', 'Notification Sent'), ('CLARIFICATION_REQUESTED', 'Clarification Requested'), ('CLARIFICATION_RESPONDED', 'Clarification Responded'), ('RULING_ISSUED', 'Ruling Issued'), ('ESCALATION_TRIGGERED', 'Escalation Triggered')], max_length=100),
        ),
    ]



================================================
FILE: backend/communications/migrations/0005_add_message_encryption.py
================================================
# Generated by Django 6.0 on 2025-12-30 14:57

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('communications', '0004_alter_communicationauditlog_action'),
    ]

    operations = [
        migrations.AddField(
            model_name='message',
            name='is_encrypted',
            field=models.BooleanField(default=True, help_text='Whether content is encrypted'),
        ),
        migrations.AlterField(
            model_name='message',
            name='content',
            field=models.TextField(help_text='AES-256 encrypted message content'),
        ),
    ]



================================================
FILE: backend/communications/migrations/0006_fix_encryption_default.py
================================================
# Generated by Django 6.0 on 2025-12-30 15:19

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('communications', '0005_add_message_encryption'),
    ]

    operations = [
        migrations.AlterField(
            model_name='message',
            name='is_encrypted',
            field=models.BooleanField(default=False, help_text='Whether content is encrypted'),
        ),
    ]



================================================
FILE: backend/communications/migrations/0007_allow_null_message_attachment.py
================================================
# Generated by Django 6.0 on 2026-01-20 14:53

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('communications', '0006_fix_encryption_default'),
    ]

    operations = [
        migrations.AlterField(
            model_name='attachment',
            name='message',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='attachments', to='communications.message'),
        ),
    ]



================================================
FILE: backend/communications/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: backend/config/__init__.py
================================================
[Empty file]


================================================
FILE: backend/config/asgi.py
================================================
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()



================================================
FILE: backend/config/settings.py
================================================
from pathlib import Path
from decouple import config

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Quick-start development settings - unsuitable for production
SECRET_KEY = config('SECRET_KEY')

DEBUG = config('DEBUG', default=False, cast=bool)

# PRODUCTION DEPLOYMENT: Add your server IP and domain to ALLOWED_HOSTS
# Windows VM: Must include server IP (e.g., 45.118.163.111)
# Format: ALLOWED_HOSTS=45.118.163.111,yourdomain.com,localhost
ALLOWED_HOSTS = config('ALLOWED_HOSTS', default='').split(',')


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.postgres',
    'django.contrib.staticfiles',
    
    # Third Party
    'rest_framework',
    'rest_framework_simplejwt',
    'corsheaders',
    'django_filters',
    
    # Local Apps
    'users.apps.UsersConfig',
    'projects',
    'edms',
    'communications',
    'finance',
    'scheduling',
    'banks.apps.BanksConfig',
    'masters.apps.MastersConfig',
    'procurement',
    'workflow',
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware', # CORS first
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'users.middleware.UserPresenceMiddleware',  # Track user activity
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

X_FRAME_OPTIONS = 'SAMEORIGIN' # Default
if DEBUG:
    X_FRAME_OPTIONS = 'ALLOWALL' # Allow iframes in dev

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# Use DATABASE_URL if available (production), otherwise use individual settings (development)
import dj_database_url

DATABASE_URL = config('DATABASE_URL', default=None)

if DATABASE_URL:
    # Production: Use DATABASE_URL from Neon/Render
    DATABASES = {
        'default': dj_database_url.parse(DATABASE_URL, conn_max_age=600)
    }
else:
    # Development: Use individual database settings
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.postgresql',
            'NAME': config('DB_NAME'),
            'USER': config('DB_USER'),
            'PASSWORD': config('DB_PASSWORD'),
            'HOST': config('DB_HOST', default='localhost'),
            'PORT': config('DB_PORT', default='5432'),
        }
    }


# Password validation
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True


# Static files (CSS, JavaScript, Images)
STATIC_URL = 'static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

# Production: Use WhiteNoise for static files
if not DEBUG:
    MIDDLEWARE.insert(2, 'whitenoise.middleware.WhiteNoiseMiddleware')
    STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

# Default primary key field type
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Custom User Model
AUTH_USER_MODEL = 'users.User'

# CORS Settings
# PRODUCTION DEPLOYMENT: Set CORS_ALLOWED_ORIGINS to your frontend URL
# Windows VM: Must include server IP (e.g., http://45.118.163.111)
# Format: CORS_ALLOWED_ORIGINS=http://45.118.163.111,https://yourdomain.com
CORS_ALLOW_ALL_ORIGINS = DEBUG  # Only in debug mode
CORS_ALLOWED_ORIGINS = config('CORS_ALLOWED_ORIGINS', default='http://localhost:5173').split(',')

# CSRF Trusted Origins (required for production POST requests)
# PRODUCTION DEPLOYMENT: Set to match FRONTEND_URL
# Windows VM: Must include server IP (e.g., http://45.118.163.111)
CSRF_TRUSTED_ORIGINS = [origin.strip() for origin in CORS_ALLOWED_ORIGINS if origin.strip()]

# REST Framework Config
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.IsAuthenticated',
    ),
    # Pagination (Feature Flag Controlled)
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination' if config('ENABLE_PAGINATION', default=True, cast=bool) else None,
    'PAGE_SIZE': config('API_PAGE_SIZE', default=50, cast=int),
    # Rate Limiting / Throttling (Feature Flag Controlled)
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle',
    ] if config('ENABLE_RATE_LIMITING', default=True, cast=bool) else [],
    'DEFAULT_THROTTLE_RATES': {
        'anon': config('THROTTLE_RATE_ANON', default='100/hour'),
        'user': config('THROTTLE_RATE_USER', default='1000/hour'),
        'login': '5/minute',  # Prevent brute force attacks
        'dashboard': '60/hour',  # Limit expensive dashboard queries
        'masterdata': '500/hour',  # Master data is cached, less restrictive
        'bulk': '10/hour',  # Bulk operations are expensive
    },
}

# ============================================================================
# CACHING CONFIGURATION
# ============================================================================
# Use Redis for caching in production, fallback to local memory in development
REDIS_URL = config('REDIS_URL', default=None)

if REDIS_URL:
    # Production: Redis cache
    CACHES = {
        'default': {
            'BACKEND': 'django_redis.cache.RedisCache',
            'LOCATION': REDIS_URL,
            'OPTIONS': {
                'CLIENT_CLASS': 'django_redis.client.DefaultClient',
                'SOCKET_CONNECT_TIMEOUT': 5,
                'SOCKET_TIMEOUT': 5,
                'CONNECTION_POOL_KWARGS': {
                    'max_connections': 50,
                    'retry_on_timeout': True,
                },
                'COMPRESSOR': 'django_redis.compressors.zlib.ZlibCompressor',
            },
            'KEY_PREFIX': 'pmis',
            'TIMEOUT': 300,  # 5 minutes default
        }
    }
else:
    # Development: Local memory cache (no Redis required)
    CACHES = {
        'default': {
            'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
            'LOCATION': 'pmis-dev-cache',
            'TIMEOUT': 300,
            'OPTIONS': {
                'MAX_ENTRIES': 1000,
            }
        }
    }

# Cache timeouts (in seconds)
CACHE_TTL_SHORT = 60 * 1  # 1 minute
CACHE_TTL_MEDIUM = 60 * 5  # 5 minutes
CACHE_TTL_LONG = 60 * 30  # 30 minutes

# ============================================================================
# FILE UPLOAD & DATA LIMITS
# ============================================================================
# Maximum size for uploaded files and form data
DATA_UPLOAD_MAX_MEMORY_SIZE = config('DATA_UPLOAD_MAX_MEMORY_SIZE', default=10485760, cast=int)  # 10MB
FILE_UPLOAD_MAX_MEMORY_SIZE = config('FILE_UPLOAD_MAX_MEMORY_SIZE', default=52428800, cast=int)  # 50MB
DATA_UPLOAD_MAX_NUMBER_FIELDS = 1000  # Prevent form field attacks

# File upload handlers
FILE_UPLOAD_HANDLERS = [
    'django.core.files.uploadhandler.TemporaryFileUploadHandler',
]

# PRODUCTION DEPLOYMENT: Set FRONTEND_URL for invite links and emails
# Windows VM: Must be set to server IP (e.g., http://45.118.163.111)
# Format: FRONTEND_URL=http://45.118.163.111
FRONTEND_URL = config('FRONTEND_URL', default='http://localhost:5173')

# Email Configuration
# For development, use console backend (prints emails to console)
EMAIL_BACKEND = config('EMAIL_BACKEND', default='django.core.mail.backends.console.EmailBackend')

# AWS SES SMTP settings (for production)
# Set EMAIL_BACKEND='django.core.mail.backends.smtp.EmailBackend' in .env for production
EMAIL_HOST = config('EMAIL_HOST', default='email-smtp.ap-south-1.amazonaws.com')  # Mumbai region
EMAIL_PORT = config('EMAIL_PORT', default=587, cast=int)
EMAIL_USE_TLS = config('EMAIL_USE_TLS', default=True, cast=bool)
EMAIL_HOST_USER = config('AWS_SES_SMTP_USER', default='')  # SES SMTP username
EMAIL_HOST_PASSWORD = config('AWS_SES_SMTP_PASSWORD', default='')  # SES SMTP password

DEFAULT_FROM_EMAIL = config('DEFAULT_FROM_EMAIL', default='noreply@pmis-zia.gov.in')

# Production Settings
# TODO: Configure production file storage (e.g., AWS S3, MinIO, or government-approved object storage)


# ============================================================================
# SECURITY: AES-256 Message Encryption
# ============================================================================
# Encryption key for message content at rest (AES-256)
# CRITICAL: In production, use a secure 32+ character key from environment
# Generate a secure key: python -c "import secrets; print(secrets.token_urlsafe(32))"
MESSAGE_ENCRYPTION_KEY = config('MESSAGE_ENCRYPTION_KEY', default='pmis-dev-key-CHANGE-IN-PRODUCTION-2025')



================================================
FILE: backend/config/urls.py
================================================
from django.contrib import admin
from django.urls import path, include
from django.http import JsonResponse
from rest_framework_simplejwt.views import TokenRefreshView
from users.auth import CustomTokenObtainPairView
from audit import views as audit_views

def api_root(request):
    return JsonResponse({
        "status": "ok",
        "message": "PMIS Backend is running",
        "version": "1.0.0"
    })

urlpatterns = [
    path('', api_root, name='api_root'),
    path('admin/', admin.site.urls),
    path('api/auth/login/', CustomTokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/auth/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    path('api/users/', include('users.urls')),
    path('api/banks/', include('banks.urls')),  # Bank and IFSC lookup APIs
    path('api/projects/', include('projects.urls')),
    path('api/edms/', include('edms.urls')),
    path('api/communications/', include('communications.urls')),
    path('api/finance/', include('finance.urls')),
    path('api/scheduling/', include('scheduling.urls')),
    path('api/masters/', include('masters.urls')),
    path('api/procurement/', include('procurement.urls')),  # e-Procurement module
    path('api/workflow/', include('workflow.urls')),  # Workflow Engine
    path('api/search/', include('search.urls')),  # Global search
    path('api/audit/logs/', audit_views.unified_audit_logs, name='unified_audit_logs'),
]

from django.conf import settings
from django.conf.urls.static import static

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)



================================================
FILE: backend/config/wsgi.py
================================================
"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()



================================================
FILE: backend/edms/__init__.py
================================================
[Empty file]


================================================
FILE: backend/edms/admin.py
================================================
from django.contrib import admin
from .models import Folder, Document, DocumentVersion, ApprovalWorkflow, ApprovalStep, DocumentAuditLog, NotingSheet


@admin.register(Folder)
class FolderAdmin(admin.ModelAdmin):
    list_display = ['name', 'project', 'parent', 'created_by', 'created_at']
    list_filter = ['project', 'created_at']
    search_fields = ['name']


@admin.register(Document)
class DocumentAdmin(admin.ModelAdmin):
    list_display = ['title', 'document_type', 'status', 'project', 'uploaded_by', 'created_at']
    list_filter = ['status', 'document_type', 'project', 'is_confidential']
    search_fields = ['title', 'description', 'document_number']
    readonly_fields = ['id', 'created_at', 'updated_at']


@admin.register(DocumentVersion)
class DocumentVersionAdmin(admin.ModelAdmin):
    list_display = ['document', 'version_number', 'file_name', 'uploaded_by', 'created_at']
    list_filter = ['created_at']
    search_fields = ['document__title', 'file_name']
    readonly_fields = ['id', 'version_number', 'file_hash', 'created_at']


@admin.register(ApprovalWorkflow)
class ApprovalWorkflowAdmin(admin.ModelAdmin):
    list_display = ['document', 'status', 'initiated_by', 'initiated_at', 'deadline']
    list_filter = ['status', 'initiated_at']


@admin.register(ApprovalStep)
class ApprovalStepAdmin(admin.ModelAdmin):
    list_display = ['workflow', 'step_type', 'step_order', 'action', 'actor', 'acted_at']
    list_filter = ['step_type', 'action']


@admin.register(DocumentAuditLog)
class DocumentAuditLogAdmin(admin.ModelAdmin):
    list_display = ['actor', 'action', 'resource_type', 'timestamp']
    list_filter = ['action', 'resource_type', 'timestamp']
    search_fields = ['actor__username']
    readonly_fields = ['id', 'timestamp']


@admin.register(NotingSheet)
class NotingSheetAdmin(admin.ModelAdmin):
    list_display = ['note_number', 'note_type', 'document', 'author_name', 'is_draft', 'created_at', 'submitted_at']
    list_filter = ['note_type', 'is_draft', 'created_at', 'ruling_action']
    search_fields = ['content', 'subject', 'author_name']
    readonly_fields = ['id', 'note_number', 'author_name', 'author_role', 'author_designation', 'created_at', 'submitted_at']
    raw_id_fields = ['document', 'document_version', 'workflow', 'author', 'references_note']




================================================
FILE: backend/edms/apps.py
================================================
from django.apps import AppConfig


class EdmsConfig(AppConfig):
    name = 'edms'



================================================
FILE: backend/edms/models.py
================================================
"""
EDMS Models - Electronic Document Management System

Implements:
- Folder hierarchy (per-project)
- Document with version control
- Workflow-based approvals (Draft â†’ Under Review â†’ Validated â†’ Approved)
- Immutable audit logging
- No deletion allowed (soft archive only)
"""
import uuid
import hashlib
from django.db import models
from django.conf import settings
from django.contrib.contenttypes.fields import GenericForeignKey
from django.contrib.contenttypes.models import ContentType


class Folder(models.Model):
    """
    Hierarchical folder structure within a project.
    Each project has its own folder tree.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    name = models.CharField(max_length=255)
    project = models.ForeignKey(
        'projects.Project',
        on_delete=models.CASCADE,
        related_name='folders'
    )
    parent = models.ForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='subfolders'
    )
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='created_folders'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['name']
        unique_together = ['name', 'parent', 'project']
    
    def __str__(self):
        return f"{self.project.name}/{self.get_full_path()}"
    
    def get_full_path(self):
        """Returns the full path from root to this folder."""
        if self.parent:
            return f"{self.parent.get_full_path()}/{self.name}"
        return self.name
    
    def get_ancestors(self):
        """Returns list of ancestor folders (for breadcrumb)."""
        ancestors = []
        current = self.parent
        while current:
            ancestors.insert(0, current)
            current = current.parent
        return ancestors


class Document(models.Model):
    """
    Core document entity with workflow status.
    Documents are never deleted, only archived.
    """
    
    class DocumentType(models.TextChoices):
        DRAWING = 'DRAWING', 'Drawing'
        REPORT = 'REPORT', 'Report'
        CONTRACT = 'CONTRACT', 'Contract'
        CORRESPONDENCE = 'CORRESPONDENCE', 'Correspondence'
        SPECIFICATION = 'SPECIFICATION', 'Specification'
        INVOICE = 'INVOICE', 'Invoice'
        MEDIA = 'MEDIA', 'Media'
        OTHER = 'OTHER', 'Other'
    
    class Status(models.TextChoices):
        DRAFT = 'DRAFT', 'Draft'
        UNDER_REVIEW = 'UNDER_REVIEW', 'Under Review'
        REVISION_REQUESTED = 'REVISION_REQUESTED', 'Revision Requested'
        VALIDATED = 'VALIDATED', 'Validated'
        APPROVED = 'APPROVED', 'Approved'
        REJECTED = 'REJECTED', 'Rejected'
        ARCHIVED = 'ARCHIVED', 'Archived'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    title = models.CharField(max_length=500)
    description = models.TextField(blank=True)
    document_type = models.CharField(
        max_length=20,
        choices=DocumentType.choices,
        default=DocumentType.OTHER
    )
    document_number = models.CharField(max_length=100, blank=True, help_text="Official document reference number")
    
    # Location
    project = models.ForeignKey(
        'projects.Project',
        on_delete=models.CASCADE,
        related_name='documents'
    )
    folder = models.ForeignKey(
        Folder,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='documents'
    )
    
    # Workflow status
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.DRAFT
    )
    
    # Current version reference
    current_version = models.ForeignKey(
        'DocumentVersion',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='current_for_document'
    )
    
    # Metadata
    is_confidential = models.BooleanField(default=False)
    tags = models.JSONField(default=list, blank=True)
    metadata = models.JSONField(default=dict, blank=True, help_text="Flexible additional attributes")
    
    # Tracking
    uploaded_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='uploaded_documents'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.title} (v{self.current_version.version_number if self.current_version else 0})"
    
    def save(self, *args, **kwargs):
        if not self.document_number:
            from django.utils import timezone
            import datetime
            
            now = timezone.now()
            year = now.year
            prefix = f"DOC-{year}"
            
            # Find the last document number for this year
            # This is a naive implementation; for high concurrency use a separate Sequence model
            last_doc = Document.objects.filter(
                document_number__startswith=prefix
            ).order_by('created_at').last()
            
            last_seq = 0
            if last_doc and last_doc.document_number:
                try:
                    parts = last_doc.document_number.split('-')
                    if len(parts) >= 3:
                        last_seq = int(parts[-1])
                except ValueError:
                    pass
            
            new_seq = last_seq + 1
            self.document_number = f"{prefix}-{new_seq:05d}"
            
        super().save(*args, **kwargs)
    
    def can_be_edited_by(self, user):
        """Check if document can be edited by user based on status and role."""
        # Only DRAFT and REVISION_REQUESTED allow edits
        if self.status not in [self.Status.DRAFT, self.Status.REVISION_REQUESTED]:
            return False
        
        # Only uploader or admins can edit
        if self.uploaded_by == user:
            return True
        if user.role in ['SPV_Official', 'NICDC_HQ', 'PMNC_Team']:
            return True
        return False
    
    def get_version_count(self):
        return self.versions.count()


def document_file_path(instance, filename):
    """Generate file path: documents/{project_id}/{document_id}/{version}/{filename}"""
    return f"documents/{instance.document.project_id}/{instance.document_id}/{instance.version_number}/{filename}"


class DocumentVersion(models.Model):
    """
    Immutable version record for a document.
    Each new upload creates a new version.
    Cannot be modified after creation.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    document = models.ForeignKey(
        Document,
        on_delete=models.CASCADE,
        related_name='versions'
    )
    version_number = models.PositiveIntegerField()
    
    # File storage (S3-ready)
    file = models.FileField(upload_to=document_file_path)
    file_name = models.CharField(max_length=255)
    file_size = models.BigIntegerField(help_text="Size in bytes")
    file_hash = models.CharField(max_length=64, help_text="SHA-256 hash for integrity")
    mime_type = models.CharField(max_length=100)
    
    # Tracking
    uploaded_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='uploaded_versions'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    change_notes = models.TextField(blank=True, help_text="What changed in this version")
    
    class Meta:
        ordering = ['-version_number']
        unique_together = ['document', 'version_number']
    
    def __str__(self):
        return f"{self.document.title} v{self.version_number}"
    
    def save(self, *args, **kwargs):
        # Enforce immutability
        if self.pk and DocumentVersion.objects.filter(pk=self.pk).exists():
            raise Exception("Document versions are immutable and cannot be modified.")
        
        # Auto-increment version number
        if not self.version_number:
            last_version = DocumentVersion.objects.filter(document=self.document).order_by('-version_number').first()
            self.version_number = (last_version.version_number + 1) if last_version else 1
        
        # Calculate file hash if not provided
        if self.file and not self.file_hash:
            self.file_hash = self._calculate_file_hash()
        
        super().save(*args, **kwargs)
        
        # Update document's current version
        self.document.current_version = self
        self.document.save(update_fields=['current_version', 'updated_at'])
    
    def _calculate_file_hash(self):
        """Calculate SHA-256 hash of the file."""
        sha256 = hashlib.sha256()
        for chunk in self.file.chunks():
            sha256.update(chunk)
        return sha256.hexdigest()


class ApprovalWorkflow(models.Model):
    """
    Tracks the approval workflow for a document.
    Created when document is submitted for review.
    """
    
    class WorkflowStatus(models.TextChoices):
        PENDING = 'PENDING', 'Pending Review'
        IN_PROGRESS = 'IN_PROGRESS', 'In Progress'
        VALIDATED = 'VALIDATED', 'Validated (Awaiting Final)'
        APPROVED = 'APPROVED', 'Approved'
        REJECTED = 'REJECTED', 'Rejected'
        CANCELLED = 'CANCELLED', 'Cancelled'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    document = models.OneToOneField(
        Document,
        on_delete=models.CASCADE,
        related_name='workflow'
    )
    status = models.CharField(
        max_length=20,
        choices=WorkflowStatus.choices,
        default=WorkflowStatus.PENDING
    )
    
    # Tracking
    initiated_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='initiated_workflows'
    )
    initiated_at = models.DateTimeField(auto_now_add=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    
    # Deadline for SLA tracking
    deadline = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        ordering = ['-initiated_at']
    
    def __str__(self):
        return f"Workflow for {self.document.title} - {self.status}"


class ApprovalStep(models.Model):
    """
    Individual approval/review action within a workflow.
    Immutable after completion.
    """
    
    class Action(models.TextChoices):
        PENDING = 'PENDING', 'Pending'
        APPROVED = 'APPROVED', 'Approved'
        VALIDATED = 'VALIDATED', 'Validated'
        REJECTED = 'REJECTED', 'Rejected'
        REVISION_REQUESTED = 'REVISION_REQUESTED', 'Revision Requested'
    
    class StepType(models.TextChoices):
        PMNC_REVIEW = 'PMNC_REVIEW', 'PMNC Review'
        SPV_APPROVAL = 'SPV_APPROVAL', 'SPV Final Approval'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    workflow = models.ForeignKey(
        ApprovalWorkflow,
        on_delete=models.CASCADE,
        related_name='steps'
    )
    step_type = models.CharField(max_length=20, choices=StepType.choices)
    step_order = models.PositiveIntegerField()
    
    # Required role for this step
    role_required = models.CharField(max_length=50)
    
    # Action taken
    action = models.CharField(
        max_length=20,
        choices=Action.choices,
        default=Action.PENDING
    )
    actor = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='approval_actions'
    )
    acted_at = models.DateTimeField(null=True, blank=True)
    comments = models.TextField(blank=True)
    
    class Meta:
        ordering = ['step_order']
        unique_together = ['workflow', 'step_order']
    
    def __str__(self):
        return f"{self.step_type} - {self.action}"


class DocumentAuditLog(models.Model):
    """
    Immutable audit trail for all document actions.
    Supports government compliance and RTI requirements.
    """
    
    class Action(models.TextChoices):
        UPLOAD = 'UPLOAD', 'Document Uploaded'
        VERSION_CREATED = 'VERSION_CREATED', 'New Version Created'
        VIEW = 'VIEW', 'Document Viewed'
        DOWNLOAD = 'DOWNLOAD', 'Document Downloaded'
        MOVED = 'MOVED', 'Document Moved'
        STATUS_CHANGED = 'STATUS_CHANGED', 'Status Changed'
        SUBMITTED_FOR_REVIEW = 'SUBMITTED_FOR_REVIEW', 'Submitted for Review'
        VALIDATED = 'VALIDATED', 'Validated by PMNC'
        APPROVED = 'APPROVED', 'Final Approval'
        REJECTED = 'REJECTED', 'Rejected'
        REVISION_REQUESTED = 'REVISION_REQUESTED', 'Revision Requested'
        ARCHIVED = 'ARCHIVED', 'Archived'
        FOLDER_CREATED = 'FOLDER_CREATED', 'Folder Created'
        FOLDER_MOVED = 'FOLDER_MOVED', 'Folder Moved'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Actor
    actor = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='edms_audit_logs'
    )
    actor_role = models.CharField(max_length=50)
    
    # Action
    action = models.CharField(max_length=30, choices=Action.choices)
    
    # Resource (generic to support documents and folders)
    resource_type = models.CharField(max_length=50)  # 'Document', 'Folder', 'Version'
    resource_id = models.UUIDField()
    
    # Details
    details = models.JSONField(default=dict, help_text="Additional context about the action")
    
    # Request metadata
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    user_agent = models.TextField(blank=True)
    
    # Timestamp
    timestamp = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['-timestamp']
        indexes = [
            models.Index(fields=['resource_type', 'resource_id']),
            models.Index(fields=['actor', 'action']),
            models.Index(fields=['timestamp']),
        ]
    
    def __str__(self):
        return f"{self.actor} - {self.action} - {self.resource_type}:{self.resource_id}"
    
    def save(self, *args, **kwargs):
        # Enforce immutability
        if self.pk and DocumentAuditLog.objects.filter(pk=self.pk).exists():
            raise Exception("Audit logs are immutable and cannot be modified.")
        super().save(*args, **kwargs)


class NotingSheet(models.Model):
    """
    Immutable Noting Sheet Entry - Official record of observations, decisions, and rulings.
    
    Features:
    - Write-once-read-forever (immutable after submission)
    - Linked to document and optionally to specific version/workflow
    - Sequential numbering per document
    - Role-based access control
    - Rulings can trigger document status changes
    
    Complies with audit, RTI, and CAG requirements.
    """
    
    class NoteType(models.TextChoices):
        REMARK = 'REMARK', 'Remark/Observation'
        CLARIFICATION_REQUEST = 'CLARIFICATION_REQUEST', 'Clarification Request'
        CLARIFICATION_RESPONSE = 'CLARIFICATION_RESPONSE', 'Clarification Response'
        RECOMMENDATION = 'RECOMMENDATION', 'Recommendation'
        RULING = 'RULING', 'Decision/Ruling'  # Triggers status change
    
    class RulingAction(models.TextChoices):
        """Actions that can be taken in a RULING note."""
        NONE = 'NONE', 'None'
        VALIDATE = 'VALIDATE', 'Validate Document'
        APPROVE = 'APPROVE', 'Approve Document'
        REJECT = 'REJECT', 'Reject Document'
        REQUEST_REVISION = 'REQUEST_REVISION', 'Request Revision'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Context - what this note is about
    document = models.ForeignKey(
        Document,
        on_delete=models.CASCADE,
        related_name='notings'
    )
    document_version = models.ForeignKey(
        DocumentVersion,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        help_text="Specific version this note references"
    )
    workflow = models.ForeignKey(
        ApprovalWorkflow,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        help_text="Linked approval workflow"
    )
    
    # Note identification
    note_number = models.PositiveIntegerField(
        help_text="Sequential number within document"
    )
    note_type = models.CharField(
        max_length=30,
        choices=NoteType.choices,
        default=NoteType.REMARK
    )
    
    # Content
    subject = models.CharField(max_length=500, blank=True)
    content = models.TextField()
    
    # Page/location reference (for PDF viewer integration)
    page_reference = models.JSONField(
        null=True,
        blank=True,
        help_text="Page and coordinate reference: {'page': 3, 'coords': [x,y]}"
    )
    
    # Reference to earlier note (for corrections/follow-ups)
    references_note = models.ForeignKey(
        'self',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='referenced_by',
        help_text="Reference to a previous note being corrected or responded to"
    )
    
    # Ruling action (only for RULING type)
    ruling_action = models.CharField(
        max_length=30,
        choices=RulingAction.choices,
        default=RulingAction.NONE,
        help_text="Action to take when ruling is submitted"
    )
    
    # Author information (frozen at creation time)
    author = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.PROTECT,  # Cannot delete user with notes
        related_name='noting_entries'
    )
    author_name = models.CharField(max_length=200, help_text="Frozen author name")
    author_role = models.CharField(max_length=50, help_text="Frozen author role")
    author_designation = models.CharField(max_length=200, blank=True, help_text="Official designation")
    
    # Draft/Submit workflow
    is_draft = models.BooleanField(
        default=True,
        help_text="Draft notes are editable, submitted notes are immutable"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    submitted_at = models.DateTimeField(
        null=True,
        blank=True,
        help_text="Timestamp when note was finalized"
    )
    
    class Meta:
        ordering = ['note_number']
        unique_together = ['document', 'note_number']
        indexes = [
            models.Index(fields=['document', 'is_draft']),
            models.Index(fields=['author', 'created_at']),
        ]
    
    def __str__(self):
        status = "DRAFT" if self.is_draft else "SUBMITTED"
        return f"Note #{self.note_number} ({self.note_type}) - {status}"
    
    def save(self, *args, **kwargs):
        # Auto-assign note number for new notes
        if not self.note_number:
            max_num = NotingSheet.objects.filter(
                document=self.document
            ).aggregate(models.Max('note_number'))['note_number__max'] or 0
            self.note_number = max_num + 1
        
        # Freeze author details on creation
        if not self.pk:
            self.author_name = self.author.username
            self.author_role = getattr(self.author, 'role', 'Unknown')
            self.author_designation = getattr(self.author, 'designation', '')
        
        # IMMUTABILITY: Once submitted, no changes allowed
        if self.pk:
            original = NotingSheet.objects.filter(pk=self.pk).first()
            if original and not original.is_draft:
                raise Exception(
                    "Submitted noting entries are immutable and cannot be modified. "
                    "Create a new note to add corrections or clarifications."
                )
        
        super().save(*args, **kwargs)
    
    def delete(self, *args, **kwargs):
        # Only drafts can be deleted
        if not self.is_draft:
            raise Exception(
                "Submitted noting entries cannot be deleted. "
                "They are permanent legal records."
            )
        super().delete(*args, **kwargs)
    
    def submit(self):
        """
        Submit the note, making it immutable.
        If it's a RULING, also triggers the appropriate document status change.
        """
        from django.utils import timezone
        
        if not self.is_draft:
            raise Exception("Note is already submitted.")
        
        self.is_draft = False
        self.submitted_at = timezone.now()
        self.save()
        
        # Execute ruling action if applicable
        if self.note_type == self.NoteType.RULING and self.ruling_action != self.RulingAction.NONE:
            self._execute_ruling()
    
    def _execute_ruling(self):
        """Execute a ruling action on the document."""
        from .services import WorkflowService
        
        doc = self.document
        action = self.ruling_action
        
        try:
            if action == self.RulingAction.VALIDATE:
                WorkflowService.validate_document(self.author, doc, comments=self.content)
            elif action == self.RulingAction.APPROVE:
                WorkflowService.approve_document(self.author, doc, comments=self.content)
            elif action == self.RulingAction.REJECT:
                WorkflowService.reject_document(self.author, doc, comments=self.content)
            elif action == self.RulingAction.REQUEST_REVISION:
                WorkflowService.request_revision(self.author, doc, comments=self.content)
        except ValueError as e:
            # Status change not applicable in current state
            pass




================================================
FILE: backend/edms/permissions.py
================================================
"""
EDMS Permissions - Role-Based Access Control

RBAC Matrix:
- EPC_Contractor: Upload own, view own, no approval
- Consultant_Design: Upload own, view own, no approval
- PMNC_Team: Full view, validate documents
- Govt_Department: View only
- SPV_Official: Full control, final approval
- NICDC_HQ: Full control, final approval
"""
from rest_framework import permissions


class EDMSPermissions:
    """
    Central permission matrix for the EDMS.
    """
    
    # Roles that can upload documents
    CAN_UPLOAD = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team', 'EPC_Contractor', 'Consultant_Design']
    
    # Roles that can view all documents (not just their own)
    CAN_VIEW_ALL = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team', 'Govt_Department']
    
    # Roles that can create folders
    CAN_CREATE_FOLDER = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team', 'EPC_Contractor', 'Consultant_Design']
    
    # Roles that can move documents between folders
    CAN_MOVE_DOCUMENT = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team']
    
    # Roles that can validate documents (PMNC review)
    CAN_VALIDATE = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team']
    
    # Roles that can give final approval
    CAN_APPROVE = ['SPV_Official', 'NICDC_HQ']
    
    # Roles that can view confidential documents
    CAN_VIEW_CONFIDENTIAL = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team']
    
    # Roles that can view audit logs
    CAN_VIEW_AUDIT = ['SPV_Official', 'NICDC_HQ']
    
    # Roles that can archive documents (soft delete)
    CAN_ARCHIVE = ['SPV_Official', 'NICDC_HQ']
    
    # =========================================
    # NOTING SHEET PERMISSIONS
    # =========================================
    
    # Roles that can add noting entries (formal remarks, recommendations)
    CAN_ADD_NOTING = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team']
    
    # Roles that can add RULING notes (decisions that trigger status changes)
    CAN_ADD_RULING = ['SPV_Official', 'NICDC_HQ']
    
    # Roles that can respond to clarification requests
    CAN_RESPOND_CLARIFICATION = ['EPC_Contractor', 'Consultant_Design']
    
    # Roles that can view all noting sheets
    CAN_VIEW_ALL_NOTINGS = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team', 'Govt_Department']
    
    @classmethod
    def can_upload(cls, user):
        return getattr(user, 'role', None) in cls.CAN_UPLOAD
    
    @classmethod
    def can_view_all(cls, user):
        return getattr(user, 'role', None) in cls.CAN_VIEW_ALL
    
    @classmethod
    def can_create_folder(cls, user):
        return getattr(user, 'role', None) in cls.CAN_CREATE_FOLDER
    
    @classmethod
    def can_move_document(cls, user):
        return getattr(user, 'role', None) in cls.CAN_MOVE_DOCUMENT
    
    @classmethod
    def can_validate(cls, user):
        return getattr(user, 'role', None) in cls.CAN_VALIDATE
    
    @classmethod
    def can_approve(cls, user):
        return getattr(user, 'role', None) in cls.CAN_APPROVE
    
    @classmethod
    def can_view_confidential(cls, user):
        return getattr(user, 'role', None) in cls.CAN_VIEW_CONFIDENTIAL
    
    @classmethod
    def can_view_audit(cls, user):
        return getattr(user, 'role', None) in cls.CAN_VIEW_AUDIT
    
    @classmethod
    def can_archive(cls, user):
        return getattr(user, 'role', None) in cls.CAN_ARCHIVE
    
    # =========================================
    # NOTING SHEET PERMISSION HELPERS
    # =========================================
    
    @classmethod
    def can_add_noting(cls, user, note_type='REMARK'):
        """Check if user can add a noting entry of the given type."""
        role = getattr(user, 'role', None)
        
        # RULING notes require special permission
        if note_type == 'RULING':
            return role in cls.CAN_ADD_RULING
        
        # Clarification responses allowed for EPC/Consultants
        if note_type == 'CLARIFICATION_RESPONSE':
            return role in cls.CAN_RESPOND_CLARIFICATION or role in cls.CAN_ADD_NOTING
        
        # Other note types require general noting permission
        return role in cls.CAN_ADD_NOTING
    
    @classmethod
    def can_view_all_notings(cls, user):
        return getattr(user, 'role', None) in cls.CAN_VIEW_ALL_NOTINGS
    
    @classmethod
    def can_view_document(cls, user, document):
        """Check if user can view a specific document."""
        # Admins can see all
        if cls.can_view_all(user):
            return True
        
        # For confidential docs, need special permission
        if document.is_confidential and not cls.can_view_confidential(user):
            return False
        
        # Users can see their own uploads
        if document.uploaded_by == user:
            return True
        
        # Users in same project can see non-confidential docs
        # (This can be refined based on project membership)
        return not document.is_confidential
    
    @classmethod
    def can_edit_document(cls, user, document):
        """Check if user can edit/upload new version of a document."""
        from .models import Document
        
        # Only editable in DRAFT or REVISION_REQUESTED status
        if document.status not in [Document.Status.DRAFT, Document.Status.REVISION_REQUESTED]:
            return False
        
        # Uploader or admins can edit
        if document.uploaded_by == user:
            return True
        return user.role in ['SPV_Official', 'NICDC_HQ', 'PMNC_Team']


class CanUploadDocument(permissions.BasePermission):
    """Permission class for document upload."""
    
    def has_permission(self, request, view):
        return EDMSPermissions.can_upload(request.user)


class CanCreateFolder(permissions.BasePermission):
    """Permission class for folder creation."""
    
    def has_permission(self, request, view):
        return EDMSPermissions.can_create_folder(request.user)


class CanValidateDocument(permissions.BasePermission):
    """Permission class for PMNC validation."""
    
    def has_permission(self, request, view):
        return EDMSPermissions.can_validate(request.user)


class CanApproveDocument(permissions.BasePermission):
    """Permission class for SPV final approval."""
    
    def has_permission(self, request, view):
        return EDMSPermissions.can_approve(request.user)


class CanViewAuditLog(permissions.BasePermission):
    """Permission class for audit log access."""
    
    def has_permission(self, request, view):
        return EDMSPermissions.can_view_audit(request.user)



================================================
FILE: backend/edms/serializers.py
================================================
"""
EDMS Serializers - API Data Transformation
"""
from rest_framework import serializers
from .models import (
    Folder, Document, DocumentVersion,
    ApprovalWorkflow, ApprovalStep, DocumentAuditLog
)


class FolderSerializer(serializers.ModelSerializer):
    """Serializer for Folder model."""
    created_by_name = serializers.SerializerMethodField()
    document_count = serializers.SerializerMethodField()
    subfolder_count = serializers.SerializerMethodField()
    full_path = serializers.SerializerMethodField()
    
    class Meta:
        model = Folder
        fields = [
            'id', 'name', 'project', 'parent', 'created_by', 'created_by_name',
            'created_at', 'document_count', 'subfolder_count', 'full_path'
        ]
        read_only_fields = ['id', 'created_by', 'created_at']
    
    def get_created_by_name(self, obj):
        if obj.created_by:
            return obj.created_by.username
        return None
    
    def get_document_count(self, obj):
        return obj.documents.count()
    
    def get_subfolder_count(self, obj):
        return obj.subfolders.count()
    
    def get_full_path(self, obj):
        return obj.get_full_path()


class FolderTreeSerializer(serializers.ModelSerializer):
    """Recursive serializer for folder tree view."""
    children = serializers.SerializerMethodField()
    document_count = serializers.SerializerMethodField()
    
    class Meta:
        model = Folder
        fields = ['id', 'name', 'children', 'document_count']
    
    def get_children(self, obj):
        children = obj.subfolders.all()
        return FolderTreeSerializer(children, many=True).data
    
    def get_document_count(self, obj):
        return obj.documents.count()


class DocumentVersionSerializer(serializers.ModelSerializer):
    """Serializer for DocumentVersion model."""
    uploaded_by_name = serializers.SerializerMethodField()
    file_url = serializers.SerializerMethodField()
    file_size_display = serializers.SerializerMethodField()
    
    class Meta:
        model = DocumentVersion
        fields = [
            'id', 'version_number', 'file', 'file_url', 'file_name', 
            'file_size', 'file_size_display', 'file_hash', 'mime_type',
            'uploaded_by', 'uploaded_by_name', 'created_at', 'change_notes'
        ]
        read_only_fields = ['id', 'version_number', 'file_hash', 'created_at']
    
    def get_uploaded_by_name(self, obj):
        if obj.uploaded_by:
            return obj.uploaded_by.username
        return None
    
    def get_file_url(self, obj):
        if obj.file:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.file.url)
            return obj.file.url
        return None
    
    def get_file_size_display(self, obj):
        size = obj.file_size
        if size < 1024:
            return f"{size} B"
        elif size < 1024 * 1024:
            return f"{size / 1024:.1f} KB"
        elif size < 1024 * 1024 * 1024:
            return f"{size / (1024 * 1024):.1f} MB"
        return f"{size / (1024 * 1024 * 1024):.1f} GB"


class ApprovalStepSerializer(serializers.ModelSerializer):
    """Serializer for ApprovalStep model."""
    actor_name = serializers.SerializerMethodField()
    
    class Meta:
        model = ApprovalStep
        fields = [
            'id', 'step_type', 'step_order', 'role_required',
            'action', 'actor', 'actor_name', 'acted_at', 'comments'
        ]
        read_only_fields = ['id', 'step_type', 'step_order', 'role_required']
    
    def get_actor_name(self, obj):
        if obj.actor:
            return obj.actor.username
        return None


class ApprovalWorkflowSerializer(serializers.ModelSerializer):
    """Serializer for ApprovalWorkflow with nested steps."""
    steps = ApprovalStepSerializer(many=True, read_only=True)
    initiated_by_name = serializers.SerializerMethodField()
    
    class Meta:
        model = ApprovalWorkflow
        fields = [
            'id', 'status', 'initiated_by', 'initiated_by_name',
            'initiated_at', 'completed_at', 'deadline', 'steps'
        ]
        read_only_fields = fields
    
    def get_initiated_by_name(self, obj):
        if obj.initiated_by:
            return obj.initiated_by.username
        return None


class DocumentListSerializer(serializers.ModelSerializer):
    """Lightweight serializer for document list views."""
    uploaded_by_name = serializers.SerializerMethodField()
    version_count = serializers.SerializerMethodField()
    current_version_number = serializers.SerializerMethodField()
    folder_name = serializers.SerializerMethodField()
    project_name = serializers.SerializerMethodField()
    
    class Meta:
        model = Document
        fields = [
            'id', 'title', 'document_type', 'document_number', 'status',
            'is_confidential', 'folder', 'folder_name', 'project', 'project_name',
            'uploaded_by', 'uploaded_by_name', 'created_at', 'updated_at',
            'version_count', 'current_version_number'
        ]
    
    def get_uploaded_by_name(self, obj):
        if obj.uploaded_by:
            return obj.uploaded_by.username
        return None
    
    def get_version_count(self, obj):
        return obj.versions.count()
    
    def get_current_version_number(self, obj):
        if obj.current_version:
            return obj.current_version.version_number
        return 0
    
    def get_folder_name(self, obj):
        if obj.folder:
            return obj.folder.name
        return 'Root'
    
    def get_project_name(self, obj):
        if obj.project:
            return obj.project.name
        return None


class DocumentDetailSerializer(serializers.ModelSerializer):
    """Full serializer for document detail view."""
    uploaded_by_name = serializers.SerializerMethodField()
    current_version = DocumentVersionSerializer(read_only=True)
    versions = DocumentVersionSerializer(many=True, read_only=True)
    workflow = ApprovalWorkflowSerializer(read_only=True)
    folder_path = serializers.SerializerMethodField()
    project_name = serializers.SerializerMethodField()
    can_edit = serializers.SerializerMethodField()
    
    class Meta:
        model = Document
        fields = [
            'id', 'title', 'description', 'document_type', 'document_number',
            'status', 'is_confidential', 'tags', 'metadata',
            'folder', 'folder_path', 'project', 'project_name',
            'uploaded_by', 'uploaded_by_name', 'created_at', 'updated_at',
            'current_version', 'versions', 'workflow', 'can_edit'
        ]
    
    def get_uploaded_by_name(self, obj):
        if obj.uploaded_by:
            return obj.uploaded_by.username
        return None
    
    def get_folder_path(self, obj):
        if obj.folder:
            return obj.folder.get_full_path()
        return '/'
    
    def get_project_name(self, obj):
        if obj.project:
            return obj.project.name
        return None
    
    def get_can_edit(self, obj):
        request = self.context.get('request')
        if request and request.user:
            return obj.can_be_edited_by(request.user)
        return False


class DocumentUploadSerializer(serializers.Serializer):
    """
    Serializer for document upload with smart versioning and auto-routing support.
    
    Auto-routing: If `auto_route_category` is provided, the document will be
    automatically filed to the corresponding standard folder (e.g., RA_BILL â†’ 04_Financials/RA Bills).
    If not provided, falls back to manual `folder` selection.
    """
    title = serializers.CharField(max_length=500, required=False, allow_blank=True)  # Optional - will use filename if not provided
    description = serializers.CharField(required=False, allow_blank=True)
    document_type = serializers.ChoiceField(
        choices=Document.DocumentType.choices,
        required=False,  # Optional - will default to OTHER
        default=Document.DocumentType.OTHER
    )
    document_number = serializers.CharField(max_length=100, required=False, allow_blank=True)
    file = serializers.FileField()
    project = serializers.IntegerField()  # Changed from UUID - projects use bigint ID
    folder = serializers.UUIDField(required=False, allow_null=True)
    is_confidential = serializers.BooleanField(default=False)
    metadata = serializers.JSONField(required=False, default=dict)
    change_notes = serializers.CharField(required=False, allow_blank=True)  # For version updates
    
    # Smart Routing: Auto-file to standard folder based on category
    auto_route_category = serializers.ChoiceField(
        choices=[
            ('ADMIN_APPROVAL', 'Admin Approval'),
            ('DPR', 'Detailed Project Report'),
            ('FEASIBILITY', 'Feasibility Report'),
            ('SITE_SURVEY', 'Site Survey'),
            ('ENV_CLEARANCE', 'Environmental Clearance'),
            ('TENDER', 'Tender Document'),
            ('AGREEMENT', 'Agreement/Contract'),
            ('WORK_ORDER', 'Work Order'),
            ('LOA', 'Letter of Award'),
            ('TENDER_EVALUATION', 'Tender Evaluation'),
            ('DRAWING', 'Drawing'),
            ('BOQ', 'Bill of Quantities'),
            ('TECH_SPEC', 'Technical Specification'),
            ('AS_BUILT', 'As-Built Drawing'),
            ('RA_BILL', 'Running Account Bill'),
            ('INVOICE', 'Tax Invoice'),
            ('PAYMENT_ADVICE', 'Payment Advice'),
            ('BUDGET', 'Budget Estimate'),
            ('FINAL_BILL', 'Final Bill'),
            ('FUNDING_PROOF', 'Fund Sanction Order'),
            ('DAILY_REPORT', 'Daily Progress Report'),
            ('SITE_PHOTO', 'Site Photograph'),
            ('INSPECTION', 'Inspection Report'),
            ('RISK_EVIDENCE', 'Risk Evidence'),
            ('QUALITY_REPORT', 'Quality Report'),
            ('SAFETY_REPORT', 'Safety Report'),
            ('INSURANCE', 'Insurance Document'),
            ('BANK_GUARANTEE', 'Bank Guarantee'),
            ('NOTICE', 'Notice'),
            ('NOC', 'No Objection Certificate'),
            ('LICENSE', 'License/Permit'),
            ('CORRESPONDENCE_IN', 'Incoming Correspondence'),
            ('CORRESPONDENCE_OUT', 'Outgoing Correspondence'),
            ('MEETING_MINUTES', 'Meeting Minutes'),
            ('OTHER', 'Other/Miscellaneous'),
        ],
        required=False,
        allow_null=True,
        allow_blank=True,
        help_text="Auto-route to standard folder based on category. Overrides 'folder' if provided."
    )
    
    def validate_project(self, value):
        from projects.models import Project
        try:
            Project.objects.get(id=value)
        except Project.DoesNotExist:
            raise serializers.ValidationError("Project not found.")
        return value
    
    def validate_folder(self, value):
        if value:
            try:
                Folder.objects.get(id=value)
            except Folder.DoesNotExist:
                raise serializers.ValidationError("Folder not found.")
        return value


class DocumentMoveSerializer(serializers.Serializer):
    """Serializer for moving a document."""
    folder = serializers.UUIDField(required=False, allow_null=True)
    
    def validate_folder(self, value):
        if value:
            try:
                Folder.objects.get(id=value)
            except Folder.DoesNotExist:
                raise serializers.ValidationError("Target folder not found.")
        return value


class VersionUploadSerializer(serializers.Serializer):
    """Serializer for uploading a new version."""
    file = serializers.FileField()
    change_notes = serializers.CharField(required=False, allow_blank=True)


class WorkflowActionSerializer(serializers.Serializer):
    """Serializer for workflow actions (approve, reject, request revision)."""
    comments = serializers.CharField(required=False, allow_blank=True)


class DocumentAuditLogSerializer(serializers.ModelSerializer):
    """Read-only serializer for audit logs."""
    actor_name = serializers.SerializerMethodField()
    
    class Meta:
        model = DocumentAuditLog
        fields = [
            'id', 'actor', 'actor_name', 'actor_role', 'action',
            'resource_type', 'resource_id', 'details',
            'ip_address', 'timestamp'
        ]
        read_only_fields = fields
    
    def get_actor_name(self, obj):
        if obj.actor:
            return obj.actor.username
        return 'System'


class FolderCreateSerializer(serializers.Serializer):
    """Serializer for creating a folder."""
    name = serializers.CharField(max_length=255)
    project = serializers.UUIDField()
    parent = serializers.UUIDField(required=False, allow_null=True)
    
    def validate_project(self, value):
        from projects.models import Project
        try:
            Project.objects.get(id=value)
        except Project.DoesNotExist:
            raise serializers.ValidationError("Project not found.")
        return value
    
    def validate_parent(self, value):
        if value:
            try:
                Folder.objects.get(id=value)
            except Folder.DoesNotExist:
                raise serializers.ValidationError("Parent folder not found.")
        return value


# =========================================
# NOTING SHEET SERIALIZERS
# =========================================

class NotingSheetListSerializer(serializers.ModelSerializer):
    """Lightweight serializer for noting sheet list."""
    note_type_display = serializers.CharField(source='get_note_type_display', read_only=True)
    ruling_action_display = serializers.CharField(source='get_ruling_action_display', read_only=True)
    
    class Meta:
        from .models import NotingSheet
        model = NotingSheet
        fields = [
            'id', 'note_number', 'note_type', 'note_type_display',
            'subject', 'content', 'is_draft',
            'author_name', 'author_role', 'author_designation',
            'ruling_action', 'ruling_action_display',
            'created_at', 'submitted_at',
            'references_note', 'page_reference'
        ]


class NotingSheetDetailSerializer(serializers.ModelSerializer):
    """Full serializer for noting sheet detail."""
    note_type_display = serializers.CharField(source='get_note_type_display', read_only=True)
    ruling_action_display = serializers.CharField(source='get_ruling_action_display', read_only=True)
    document_title = serializers.CharField(source='document.title', read_only=True)
    document_version_number = serializers.SerializerMethodField()
    referenced_by = NotingSheetListSerializer(many=True, read_only=True)
    
    class Meta:
        from .models import NotingSheet
        model = NotingSheet
        fields = [
            'id', 'note_number', 'note_type', 'note_type_display',
            'subject', 'content', 'is_draft',
            'document', 'document_title',
            'document_version', 'document_version_number',
            'workflow',
            'author', 'author_name', 'author_role', 'author_designation',
            'ruling_action', 'ruling_action_display',
            'page_reference', 'references_note', 'referenced_by',
            'created_at', 'submitted_at'
        ]
        read_only_fields = [
            'id', 'note_number', 'author_name', 'author_role', 'author_designation',
            'created_at', 'submitted_at'
        ]
    
    def get_document_version_number(self, obj):
        if obj.document_version:
            return obj.document_version.version_number
        return None


class NotingSheetCreateSerializer(serializers.Serializer):
    """Serializer for creating a noting sheet entry."""
    from .models import NotingSheet
    
    document = serializers.UUIDField()
    document_version = serializers.UUIDField(required=False, allow_null=True)
    note_type = serializers.ChoiceField(choices=NotingSheet.NoteType.choices)
    subject = serializers.CharField(max_length=500, required=False, allow_blank=True)
    content = serializers.CharField()
    page_reference = serializers.JSONField(required=False, allow_null=True)
    references_note = serializers.UUIDField(required=False, allow_null=True)
    ruling_action = serializers.ChoiceField(
        choices=NotingSheet.RulingAction.choices,
        required=False,
        default='NONE'
    )
    is_draft = serializers.BooleanField(default=True)
    
    def validate_document(self, value):
        from .models import Document
        try:
            Document.objects.get(id=value)
        except Document.DoesNotExist:
            raise serializers.ValidationError("Document not found.")
        return value
    
    def validate_document_version(self, value):
        if value:
            from .models import DocumentVersion
            try:
                DocumentVersion.objects.get(id=value)
            except DocumentVersion.DoesNotExist:
                raise serializers.ValidationError("Document version not found.")
        return value
    
    def validate_references_note(self, value):
        if value:
            from .models import NotingSheet
            try:
                NotingSheet.objects.get(id=value)
            except NotingSheet.DoesNotExist:
                raise serializers.ValidationError("Referenced note not found.")
        return value
    
    def validate(self, data):
        # Ruling action only allowed for RULING type
        if data.get('ruling_action') != 'NONE' and data.get('note_type') != 'RULING':
            raise serializers.ValidationError({
                'ruling_action': 'Ruling action can only be set for RULING type notes.'
            })
        return data




================================================
FILE: backend/edms/services_base.py
================================================
"""
EDMS Services - Business Logic Layer

Implements:
- Document upload and versioning
- Workflow management (submit, validate, approve, reject)
- Folder operations
- Audit logging
- Notification integration with Communications
"""
from django.utils import timezone
from django.contrib.contenttypes.models import ContentType
from datetime import timedelta

from .models import (
    Document, DocumentVersion, Folder,
    ApprovalWorkflow, ApprovalStep, DocumentAuditLog
)


class AuditService:
    """
    Creates immutable audit log entries for all EDMS actions.
    """
    
    @staticmethod
    def log(actor, action, resource_type, resource_id, details=None, request=None):
        """Create an audit log entry."""
        ip_address = None
        user_agent = ''
        
        if request:
            ip_address = request.META.get('REMOTE_ADDR')
            user_agent = request.META.get('HTTP_USER_AGENT', '')
        
        return DocumentAuditLog.objects.create(
            actor=actor,
            actor_role=getattr(actor, 'role', 'Unknown') if actor else 'System',
            action=action,
            resource_type=resource_type,
            resource_id=resource_id,
            details=details or {},
            ip_address=ip_address,
            user_agent=user_agent
        )


class DocumentService:
    """
    Handles document operations with version control.
    """
    
    @staticmethod
    def upload_document(user, project, file, title, document_type, 
                        folder=None, description='', change_notes='Initial upload',
                        is_confidential=False, metadata=None, request=None):
        """
        Upload a new document with initial version.
        """
        import os
        
        # Create document record (auto-submit for approval)
        document = Document.objects.create(
            title=title,
            description=description,
            document_type=document_type,
            project=project,
            folder=folder,
            status=Document.Status.UNDER_REVIEW,  # Auto-submit for approval
            is_confidential=is_confidential,
            metadata=metadata or {},
            uploaded_by=user
        )
        
        # Create initial version
        version = DocumentVersion.objects.create(
            document=document,
            file=file,
            file_name=file.name,
            file_size=file.size,
            mime_type=file.content_type or 'application/octet-stream',
            uploaded_by=user,
            change_notes=change_notes
        )
        
        # Set current version
        document.current_version = version
        document.save(update_fields=['current_version'])
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.UPLOAD,
            resource_type='Document',
            resource_id=document.id,
            details={
                'title': title,
                'type': document_type,
                'file_name': file.name,
                'version': version.version_number
            },
            request=request
        )
        
        return document
    
    @staticmethod
    def create_new_version(user, document, file, change_notes='', request=None):
        """
        Create a new version of an existing document.
        """
        # Check if document is editable
        if not document.can_be_edited_by(user):
            raise PermissionError("You cannot upload a new version of this document in its current state.")
        
        version = DocumentVersion.objects.create(
            document=document,
            file=file,
            file_name=file.name,
            file_size=file.size,
            mime_type=file.content_type or 'application/octet-stream',
            uploaded_by=user,
            change_notes=change_notes
        )
        
        # Update document's current version
        document.current_version = version
        
        # Set status to UNDER_REVIEW (auto-submit for approval)
        document.status = Document.Status.UNDER_REVIEW
        document.save(update_fields=['status', 'current_version'])
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.VERSION_CREATED,
            resource_type='Document',
            resource_id=document.id,
            details={
                'version': version.version_number,
                'file_name': file.name,
                'change_notes': change_notes
            },
            request=request
        )
        
        return version
    
    @staticmethod
    def move_document(user, document, target_folder, request=None):
        """
        Move document to a different folder.
        """
        old_folder = document.folder
        document.folder = target_folder
        document.save(update_fields=['folder', 'updated_at'])
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.MOVED,
            resource_type='Document',
            resource_id=document.id,
            details={
                'from_folder': str(old_folder.id) if old_folder else None,
                'to_folder': str(target_folder.id) if target_folder else None
            },
            request=request
        )
        
        return document
    
    @staticmethod
    def log_view(user, document, request=None):
        """Log document view action."""
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.VIEW,
            resource_type='Document',
            resource_id=document.id,
            request=request
        )
    
    @staticmethod
    def log_download(user, document, version=None, request=None):
        """Log document download action."""
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.DOWNLOAD,
            resource_type='Document',
            resource_id=document.id,
            details={'version': version.version_number if version else document.current_version.version_number},
            request=request
        )
    
    @staticmethod
    def upload_or_version_document(user, project, file, title=None, document_type=None,
                                    folder=None, description='', change_notes='',
                                    is_confidential=False, metadata=None, request=None):
        """
        Smart upload: Creates new document or adds version to existing one.
        
        This implements non-destructive versioning for government EDMS compliance.
        
        Matching logic:
        - If title provided: Match by title (case-insensitive)
        - Else: Match by filename (case-insensitive)
        - Scope: Same project + folder
        
        Returns:
            Document: The created or updated document
        """
        import os
        
        # Determine the identifier to match
        # Strip file extension for matching if using filename
        if title and title.strip():
            identifier = title.strip()
        else:
            # Use filename without extension for better matching
            filename = file.name
            identifier, _ = os.path.splitext(filename)
        
        # Look for existing document (case-insensitive match)
        existing = Document.objects.filter(
            project=project,
            folder=folder,
            title__iexact=identifier
        ).first()
        
        if existing:
            # Document exists - add new version
            # Check if user has permission to edit/version this document
            if not existing.can_be_edited_by(user):
                raise PermissionError(
                    f"You cannot upload a new version of '{existing.title}'. "
                    f"Current status: {existing.get_status_display()}. "
                    f"Only the document owner or administrators can add versions."
                )
            
            # Create new version
            version = DocumentService.create_new_version(
                user=user,
                document=existing,
                file=file,
                change_notes=change_notes or f'Updated from upload',
                request=request
            )
            
            # Return the document (not the version)
            existing.refresh_from_db()
            return existing
        else:
            # No existing document - create new one
            final_title = title.strip() if title and title.strip() else file.name
            final_doc_type = document_type if document_type else Document.DocumentType.OTHER
            
            return DocumentService.upload_document(
                user=user,
                project=project,
                file=file,
                title=final_title,
                document_type=final_doc_type,
                folder=folder,
                description=description,
                change_notes='Initial upload',
                is_confidential=is_confidential,
                metadata=metadata or {},
                request=request
            )
    
    @staticmethod
    def restore_version(user, document, version_number, request=None):
        """
        Restore an older version by creating a new version that references the old file.
        
        This is used for rollback scenarios (e.g., wrong file uploaded).
        The system never deletes versions - it creates a new version pointing to the old file.
        
        Args:
            user: User performing the restoration
            document: Document to restore
            version_number: Version number to restore from
            request: HTTP request for audit logging
            
        Returns:
            DocumentVersion: The newly created version (pointing to old file)
        """
        # Check if document is editable
        if not document.can_be_edited_by(user):
            raise PermissionError("You cannot restore a version of this document in its current state.")
        
        # Get the version to restore
        try:
            old_version = document.versions.get(version_number=version_number)
        except DocumentVersion.DoesNotExist:
            raise ValueError(f"Version {version_number} not found for this document.")
        
        # Create NEW version that points to the old file
        new_version = DocumentVersion.objects.create(
            document=document,
            file=old_version.file,  # Reuse the same file
            file_name=old_version.file_name,
            file_size=old_version.file_size,
            file_hash=old_version.file_hash,
            mime_type=old_version.mime_type,
            uploaded_by=user,
            change_notes=f"Restored from version {version_number}"
        )
        
        # Update document's current version
        document.current_version = new_version
        
        # Set status to UNDER_REVIEW (restored content needs re-approval)
        document.status = Document.Status.UNDER_REVIEW
        document.save(update_fields=['status', 'current_version'])
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.VERSION_CREATED,
            resource_type='Document',
            resource_id=document.id,
            details={
                'version': new_version.version_number,
                'restored_from_version': version_number,
                'file_name': old_version.file_name,
                'change_notes': new_version.change_notes
            },
            request=request
        )
        
        return new_version
    
    @staticmethod
    def compare_versions(document, version_a_number, version_b_number):
        """
        Compare two versions of a document and return metadata differences.
        
        For government compliance, this helps auditors see what changed between versions.
        
        Args:
            document: Document to compare versions of
            version_a_number: First version number
            version_b_number: Second version number
            
        Returns:
            dict: Comparison data including metadata differences
        """
        try:
            version_a = document.versions.get(version_number=version_a_number)
            version_b = document.versions.get(version_number=version_b_number)
        except DocumentVersion.DoesNotExist:
            raise ValueError("One or both versions not found.")
        
        comparison = {
            'version_a': {
                'number': version_a.version_number,
                'file_name': version_a.file_name,
                'file_size': version_a.file_size,
                'file_hash': version_a.file_hash,
                'uploaded_by': version_a.uploaded_by.username if version_a.uploaded_by else None,
                'created_at': version_a.created_at.isoformat(),
                'change_notes': version_a.change_notes,
            },
            'version_b': {
                'number': version_b.version_number,
                'file_name': version_b.file_name,
                'file_size': version_b.file_size,
                'file_hash': version_b.file_hash,
                'uploaded_by': version_b.uploaded_by.username if version_b.uploaded_by else None,
                'created_at': version_b.created_at.isoformat(),
                'change_notes': version_b.change_notes,
            },
            'differences': {
                'file_name_changed': version_a.file_name != version_b.file_name,
                'file_size_changed': version_a.file_size != version_b.file_size,
                'file_content_changed': version_a.file_hash != version_b.file_hash,
                'uploader_changed': version_a.uploaded_by != version_b.uploaded_by,
            },
            'file_identical': version_a.file_hash == version_b.file_hash,
        }
        
        return comparison



class WorkflowService:
    """
    Manages document approval workflow.
    """
    
    # Default SLA for document approval (in hours)
    DEFAULT_SLA_HOURS = 72  # 3 days
    
    @staticmethod
    def submit_for_review(user, document, request=None):
        """
        Submit document for PMNC review.
        Creates workflow and notifies reviewers.
        Can be called on DRAFT or UNDER_REVIEW documents.
        """
        # Allow submission from DRAFT or UNDER_REVIEW (for auto-submission)
        if document.status not in [Document.Status.DRAFT, Document.Status.UNDER_REVIEW]:
            raise ValueError("Only DRAFT or UNDER_REVIEW documents can be submitted for review.")
        
        # Update document status
        document.status = Document.Status.UNDER_REVIEW
        document.save(update_fields=['status', 'updated_at'])
        
        # Create or update workflow
        workflow, created = ApprovalWorkflow.objects.get_or_create(
            document=document,
            defaults={
                'initiated_by': user,
                'deadline': timezone.now() + timedelta(hours=WorkflowService.DEFAULT_SLA_HOURS)
            }
        )
        
        if not created:
            workflow.status = ApprovalWorkflow.WorkflowStatus.IN_PROGRESS
            workflow.save(update_fields=['status'])
        
        # Create PMNC review step
        ApprovalStep.objects.create(
            workflow=workflow,
            step_type=ApprovalStep.StepType.PMNC_REVIEW,
            step_order=1,
            role_required='PMNC_Team'
        )
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.SUBMITTED_FOR_REVIEW,
            resource_type='Document',
            resource_id=document.id,
            request=request
        )
        
        # Send notification
        WorkflowService._notify_reviewers(document, 'PMNC_Team', 'New Document for Review')
        
        return workflow
    
    @staticmethod
    def validate_document(user, document, comments='', request=None):
        """
        PMNC validates the document.
        Moves to VALIDATED status awaiting SPV approval.
        """
        if document.status != Document.Status.UNDER_REVIEW:
            raise ValueError("Only documents UNDER_REVIEW can be validated.")
        
        # Update document status
        document.status = Document.Status.VALIDATED
        document.save(update_fields=['status', 'updated_at'])
        
        # Update workflow
        workflow = document.workflow
        workflow.status = ApprovalWorkflow.WorkflowStatus.VALIDATED
        workflow.save(update_fields=['status'])
        
        # Update PMNC step
        pmnc_step = workflow.steps.filter(step_type=ApprovalStep.StepType.PMNC_REVIEW).first()
        if pmnc_step:
            pmnc_step.action = ApprovalStep.Action.VALIDATED
            pmnc_step.actor = user
            pmnc_step.acted_at = timezone.now()
            pmnc_step.comments = comments
            pmnc_step.save()
        
        # Create SPV approval step
        ApprovalStep.objects.create(
            workflow=workflow,
            step_type=ApprovalStep.StepType.SPV_APPROVAL,
            step_order=2,
            role_required='SPV_Official'
        )
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.VALIDATED,
            resource_type='Document',
            resource_id=document.id,
            details={'comments': comments},
            request=request
        )
        
        # Notify SPV for final approval
        WorkflowService._notify_reviewers(document, 'SPV_Official', 'Document Awaiting Final Approval')
        
        return document
    
    @staticmethod
    def request_revision(user, document, comments, request=None):
        """
        Request revision from uploader.
        """
        if document.status != Document.Status.UNDER_REVIEW:
            raise ValueError("Only documents UNDER_REVIEW can have revision requested.")
        
        # Update document status
        document.status = Document.Status.REVISION_REQUESTED
        document.save(update_fields=['status', 'updated_at'])
        
        # Update PMNC step
        workflow = document.workflow
        pmnc_step = workflow.steps.filter(step_type=ApprovalStep.StepType.PMNC_REVIEW).first()
        if pmnc_step:
            pmnc_step.action = ApprovalStep.Action.REVISION_REQUESTED
            pmnc_step.actor = user
            pmnc_step.acted_at = timezone.now()
            pmnc_step.comments = comments
            pmnc_step.save()
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.REVISION_REQUESTED,
            resource_type='Document',
            resource_id=document.id,
            details={'comments': comments},
            request=request
        )
        
        # Notify uploader
        WorkflowService._notify_user(
            document.uploaded_by, 
            document, 
            'Revision Requested',
            f'Your document "{document.title}" requires revision: {comments}'
        )
        
        return document
    
    @staticmethod
    def approve_document(user, document, comments='', request=None):
        """
        SPV gives final approval.
        """
        if document.status != Document.Status.VALIDATED:
            raise ValueError("Only VALIDATED documents can receive final approval.")
        
        # Update document status
        document.status = Document.Status.APPROVED
        document.save(update_fields=['status', 'updated_at'])
        
        # Update workflow
        workflow = document.workflow
        workflow.status = ApprovalWorkflow.WorkflowStatus.APPROVED
        workflow.completed_at = timezone.now()
        workflow.save(update_fields=['status', 'completed_at'])
        
        # Update SPV step
        spv_step = workflow.steps.filter(step_type=ApprovalStep.StepType.SPV_APPROVAL).first()
        if spv_step:
            spv_step.action = ApprovalStep.Action.APPROVED
            spv_step.actor = user
            spv_step.acted_at = timezone.now()
            spv_step.comments = comments
            spv_step.save()
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.APPROVED,
            resource_type='Document',
            resource_id=document.id,
            details={'comments': comments},
            request=request
        )
        
        # Notify uploader
        WorkflowService._notify_user(
            document.uploaded_by,
            document,
            'Document Approved',
            f'Your document "{document.title}" has been approved.'
        )
        
        return document
    
    @staticmethod
    def reject_document(user, document, comments, request=None):
        """
        SPV rejects the document and sends it back to uploader.
        Uses REVISION_REQUESTED status so it counts as "Under Review".
        """
        if document.status != Document.Status.VALIDATED:
            raise ValueError("Only VALIDATED documents can be rejected at SPV level.")
        
        # Update document status to REVISION_REQUESTED (not REJECTED)
        document.status = Document.Status.REVISION_REQUESTED
        document.save(update_fields=['status', 'updated_at'])
        
        # Update workflow
        workflow = document.workflow
        workflow.status = ApprovalWorkflow.WorkflowStatus.REJECTED
        workflow.completed_at = timezone.now()
        workflow.save(update_fields=['status', 'completed_at'])
        
        # Update SPV step
        spv_step = workflow.steps.filter(step_type=ApprovalStep.StepType.SPV_APPROVAL).first()
        if spv_step:
            spv_step.action = ApprovalStep.Action.REJECTED
            spv_step.actor = user
            spv_step.acted_at = timezone.now()
            spv_step.comments = comments
            spv_step.save()
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.REJECTED,
            resource_type='Document',
            resource_id=document.id,
            details={'comments': comments},
            request=request
        )
        
        # Notify uploader
        WorkflowService._notify_user(
            document.uploaded_by,
            document,
            'Document Rejected',
            f'Your document "{document.title}" has been rejected: {comments}'
        )
        
        return document
    
    @staticmethod
    def get_pending_approvals(user):
        """
        Get documents pending action from this user based on role.
        Includes REVISION_REQUESTED docs as they need review.
        """
        role = getattr(user, 'role', None)
        
        if role in ['PMNC_Team']:
            # PMNC sees documents under review + revision requested
            return Document.objects.filter(
                status__in=[Document.Status.UNDER_REVIEW, Document.Status.REVISION_REQUESTED]
            )
        elif role in ['SPV_Official', 'NICDC_HQ']:
            # SPV sees validated documents + can also see under review/revision requested
            return Document.objects.filter(
                status__in=[
                    Document.Status.VALIDATED,
                    Document.Status.UNDER_REVIEW,
                    Document.Status.REVISION_REQUESTED
                ]
            )
        
        return Document.objects.none()
    
    @staticmethod
    def _notify_reviewers(document, role, title):
        """Send notification to all users with specified role."""
        try:
            from communications.models import Notification
            from django.contrib.auth import get_user_model
            
            User = get_user_model()
            reviewers = User.objects.filter(role=role)
            
            for reviewer in reviewers:
                Notification.objects.create(
                    recipient=reviewer,
                    notification_type=Notification.NotificationType.ACTION_REQUIRED,
                    title=title,
                    message=f'Document "{document.title}" requires your attention.',
                    context_type=ContentType.objects.get_for_model(Document),
                    context_id=document.id,
                    deep_link=f'/edms?document={document.id}'
                )
        except Exception as e:
            # Log error but don't fail the workflow
            print(f"Failed to send notification: {e}")
    
    @staticmethod
    def _notify_user(user, document, title, message):
        """Send notification to a specific user."""
        try:
            from communications.models import Notification
            
            if user:
                Notification.objects.create(
                    recipient=user,
                    notification_type=Notification.NotificationType.ACTION_REQUIRED,
                    title=title,
                    message=message,
                    context_type=ContentType.objects.get_for_model(Document),
                    context_id=document.id,
                    deep_link=f'/edms?document={document.id}'
                )
        except Exception as e:
            print(f"Failed to send notification: {e}")


class FolderService:
    """
    Manages folder operations.
    """
    
    @staticmethod
    def create_folder(user, project, name, parent=None, request=None):
        """Create a new folder."""
        folder = Folder.objects.create(
            name=name,
            project=project,
            parent=parent,
            created_by=user
        )
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.FOLDER_CREATED,
            resource_type='Folder',
            resource_id=folder.id,
            details={
                'name': name,
                'parent': str(parent.id) if parent else None,
                'project': str(project.id)
            },
            request=request
        )
        
        return folder
    
    @staticmethod
    def get_folder_tree(project):
        """Get hierarchical folder structure for a project."""
        folders = Folder.objects.filter(project=project, parent__isnull=True)
        return folders
    
    @staticmethod
    def move_folder(user, folder, new_parent, request=None):
        """Move folder to new parent (within same project)."""
        if new_parent and new_parent.project != folder.project:
            raise ValueError("Cannot move folder to a different project.")
        
        old_parent = folder.parent
        folder.parent = new_parent
        folder.save(update_fields=['parent'])
        
        # Audit log
        AuditService.log(
            actor=user,
            action=DocumentAuditLog.Action.FOLDER_MOVED,
            resource_type='Folder',
            resource_id=folder.id,
            details={
                'from_parent': str(old_parent.id) if old_parent else None,
                'to_parent': str(new_parent.id) if new_parent else None
            },
            request=request
        )
        
        return folder



================================================
FILE: backend/edms/tests.py
================================================
from django.test import TestCase

# Create your tests here.



================================================
FILE: backend/edms/urls.py
================================================
# EDMS URL Configuration
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import FolderViewSet, DocumentViewSet, ApprovalViewSet, AuditLogViewSet, NotingSheetViewSet

router = DefaultRouter()
router.register(r'folders', FolderViewSet, basename='folder')
router.register(r'documents', DocumentViewSet, basename='document')
router.register(r'approvals', ApprovalViewSet, basename='approval')
router.register(r'audit-logs', AuditLogViewSet, basename='auditlog')
router.register(r'noting-sheets', NotingSheetViewSet, basename='notingsheet')

urlpatterns = [
    path('', include(router.urls)),
]




================================================
FILE: backend/edms/views.py
================================================
"""
EDMS Views - API Endpoints

Implements:
- Folder CRUD (create, list, move - no delete)
- Document CRUD with version control
- File upload/download
- Workflow actions (submit, validate, approve, reject)
- Audit log access
"""
from rest_framework import viewsets, permissions, status, parsers
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser, FormParser
from django.http import FileResponse
from django.shortcuts import get_object_or_404

from .models import (
    Folder, Document, DocumentVersion,
    ApprovalWorkflow, ApprovalStep, DocumentAuditLog, NotingSheet
)
from .serializers import (
    FolderSerializer, FolderTreeSerializer, FolderCreateSerializer,
    DocumentListSerializer, DocumentDetailSerializer, DocumentUploadSerializer,
    DocumentVersionSerializer, DocumentMoveSerializer, VersionUploadSerializer,
    ApprovalWorkflowSerializer, WorkflowActionSerializer,
    DocumentAuditLogSerializer,
    NotingSheetListSerializer, NotingSheetDetailSerializer, NotingSheetCreateSerializer
)
from .permissions import (
    EDMSPermissions, CanUploadDocument, CanCreateFolder,
    CanValidateDocument, CanApproveDocument, CanViewAuditLog
)
from .services import DocumentService, WorkflowService, FolderService, AuditService


class FolderViewSet(viewsets.ModelViewSet):
    """
    ViewSet for folder operations.
    No delete allowed - only create, list, and move.
    """
    serializer_class = FolderSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        queryset = Folder.objects.all()
        
        # Filter by project
        project_id = self.request.query_params.get('project')
        if project_id:
            queryset = queryset.filter(project_id=project_id)
        
        # Filter by parent (for tree building)
        parent_id = self.request.query_params.get('parent')
        if parent_id == 'null' or parent_id == '':
            queryset = queryset.filter(parent__isnull=True)
        elif parent_id:
            queryset = queryset.filter(parent_id=parent_id)
        
        return queryset.order_by('name')
    
    def create(self, request, *args, **kwargs):
        """Create a new folder."""
        if not EDMSPermissions.can_create_folder(request.user):
            return Response(
                {'error': f'You do not have permission to create folders. Your role: {getattr(request.user, "role", "Unknown")}'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        serializer = FolderCreateSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        try:
            from projects.models import Project
            project = Project.objects.get(id=serializer.validated_data['project'])
            parent = None
            if serializer.validated_data.get('parent'):
                parent = Folder.objects.get(id=serializer.validated_data['parent'])
            
            folder = FolderService.create_folder(
                user=request.user,
                project=project,
                name=serializer.validated_data['name'],
                parent=parent,
                request=request
            )
            
            return Response(FolderSerializer(folder).data, status=status.HTTP_201_CREATED)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found.'}, status=status.HTTP_400_BAD_REQUEST)
        except Folder.DoesNotExist:
            return Response({'error': 'Parent folder not found.'}, status=status.HTTP_400_BAD_REQUEST)
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
    
    def destroy(self, request, *args, **kwargs):
        """Disable delete."""
        return Response(
            {'error': 'Folder deletion is not allowed.'},
            status=status.HTTP_405_METHOD_NOT_ALLOWED
        )
    
    @action(detail=False, methods=['get'])
    def tree(self, request):
        """Get folder tree for a project."""
        project_id = request.query_params.get('project')
        if not project_id:
            return Response(
                {'error': 'project parameter is required.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        folders = Folder.objects.filter(project_id=project_id, parent__isnull=True)
        serializer = FolderTreeSerializer(folders, many=True)
        return Response(serializer.data)
    
    @action(detail=True, methods=['patch'])
    def move(self, request, pk=None):
        """Move folder to a new parent."""
        if not EDMSPermissions.can_create_folder(request.user):
            return Response(
                {'error': 'You do not have permission to move folders.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        folder = self.get_object()
        new_parent_id = request.data.get('parent')
        new_parent = None
        
        if new_parent_id:
            new_parent = get_object_or_404(Folder, id=new_parent_id)
        
        folder = FolderService.move_folder(request.user, folder, new_parent, request)
        return Response(FolderSerializer(folder).data)


class DocumentViewSet(viewsets.ModelViewSet):
    """
    ViewSet for document operations with version control.
    """
    permission_classes = [permissions.IsAuthenticated]
    parser_classes = [MultiPartParser, FormParser]
    
    def get_queryset(self):
        user = self.request.user
        queryset = Document.objects.exclude(status=Document.Status.ARCHIVED)
        
        # Role-based filtering
        if not EDMSPermissions.can_view_all(user):
            # Non-admins see only their own uploads + non-confidential docs
            from django.db.models import Q
            queryset = queryset.filter(
                Q(uploaded_by=user) | Q(is_confidential=False)
            )
        elif not EDMSPermissions.can_view_confidential(user):
            queryset = queryset.filter(is_confidential=False)
        
        # Filter by project
        project_id = self.request.query_params.get('project')
        if project_id:
            queryset = queryset.filter(project_id=project_id)
        
        # Filter by folder
        folder_id = self.request.query_params.get('folder')
        if folder_id == 'null' or folder_id == '':
            queryset = queryset.filter(folder__isnull=True)
        elif folder_id:
            queryset = queryset.filter(folder_id=folder_id)
        
        # Filter by status
        doc_status = self.request.query_params.get('status')
        if doc_status:
            queryset = queryset.filter(status=doc_status)
        
        # Filter by type
        doc_type = self.request.query_params.get('type')
        if doc_type:
            queryset = queryset.filter(document_type=doc_type)
        
        # Search
        search = self.request.query_params.get('search')
        if search:
            queryset = queryset.filter(title__icontains=search)
        
        return queryset.select_related('folder', 'project', 'uploaded_by', 'current_version')
    
    def get_serializer_class(self):
        if self.action == 'list':
            return DocumentListSerializer
        if self.action == 'create':
            return DocumentUploadSerializer
        return DocumentDetailSerializer
    
    def create(self, request, *args, **kwargs):
        """
        Upload a new document or add version if exists.
        
        Smart Routing: If 'auto_route_category' is provided, the document is
        automatically filed to the standard folder (e.g., RA_BILL â†’ 04_Financials/RA Bills).
        Falls back to manual 'folder' selection if not provided.
        """
        if not EDMSPermissions.can_upload(request.user):
            return Response(
                {'error': 'You do not have permission to upload documents.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        serializer = DocumentUploadSerializer(data=request.data)
        if not serializer.is_valid():
            print("Document upload validation errors:", serializer.errors)
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        try:
            from projects.models import Project
            project = Project.objects.get(id=serializer.validated_data['project'])
            
            # Smart Routing: Determine target folder
            folder = None
            auto_route_category = serializer.validated_data.get('auto_route_category')
            
            if auto_route_category:
                # Use DirectoryService to get the correct folder
                from edms.services.directory_service import DirectoryService
                import logging
                logger = logging.getLogger(__name__)
                
                logger.info(f"Smart routing document to category: {auto_route_category}")
                folder = DirectoryService.get_route_folder(
                    project=project,
                    route_category=auto_route_category,
                    created_by=request.user
                )
                logger.info(f"Document routed to folder: {folder.name if folder else 'None'}")
            elif serializer.validated_data.get('folder'):
                # Fallback to manual folder selection
                folder = Folder.objects.get(id=serializer.validated_data['folder'])
            
            # Use smart upload/version detection
            document = DocumentService.upload_or_version_document(
                user=request.user,
                project=project,
                file=serializer.validated_data['file'],
                title=serializer.validated_data.get('title'),  # May be None
                document_type=serializer.validated_data.get('document_type'),
                folder=folder,
                description=serializer.validated_data.get('description', ''),
                change_notes=serializer.validated_data.get('change_notes', ''),
                is_confidential=serializer.validated_data.get('is_confidential', False),
                metadata=serializer.validated_data.get('metadata', {}),
                request=request
            )
            
            # Auto-submit for approval (mandatory workflow)
            try:
                workflow = WorkflowService.submit_for_review(
                    user=request.user,
                    document=document,
                    request=request
                )
            except Exception as e:
                # If workflow already exists or submission fails, log but continue
                print(f"Workflow submission note: {e}")
            
            document.refresh_from_db()
            
            return Response(
                DocumentDetailSerializer(document, context={'request': request}).data,
                status=status.HTTP_201_CREATED
            )
        except PermissionError as e:
            return Response({'error': str(e)}, status=status.HTTP_403_FORBIDDEN)
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
    
    def retrieve(self, request, *args, **kwargs):
        """Get document details and log view."""
        document = self.get_object()
        
        # Log view
        DocumentService.log_view(request.user, document, request)
        
        serializer = DocumentDetailSerializer(document, context={'request': request})
        return Response(serializer.data)
    
    def destroy(self, request, *args, **kwargs):
        """Disable delete - use archive instead."""
        return Response(
            {'error': 'Document deletion is not allowed. Use archive instead.'},
            status=status.HTTP_405_METHOD_NOT_ALLOWED
        )
    
    @action(detail=True, methods=['post'], parser_classes=[MultiPartParser, FormParser])
    def upload_version(self, request, pk=None):
        """Upload a new version of the document."""
        document = self.get_object()
        
        if not EDMSPermissions.can_edit_document(request.user, document):
            return Response(
                {'error': 'You cannot upload a new version of this document.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        serializer = VersionUploadSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        try:
            version = DocumentService.create_new_version(
                user=request.user,
                document=document,
                file=serializer.validated_data['file'],
                change_notes=serializer.validated_data.get('change_notes', ''),
                request=request
            )
            
            # Auto-submit for approval (mandatory workflow)
            document.refresh_from_db()
            try:
                workflow = WorkflowService.submit_for_review(
                    user=request.user,
                    document=document,
                    request=request
                )
            except Exception as e:
                # If workflow already exists, log but continue
                print(f"Workflow submission note: {e}")
            
            document.refresh_from_db()
            
            return Response(
                DocumentVersionSerializer(version, context={'request': request}).data,
                status=status.HTTP_201_CREATED
            )
        except PermissionError as e:
            return Response({'error': str(e)}, status=status.HTTP_403_FORBIDDEN)
    
    @action(detail=True, methods=['get'])
    def versions(self, request, pk=None):
        """Get version history."""
        document = self.get_object()
        versions = document.versions.all()
        serializer = DocumentVersionSerializer(versions, many=True, context={'request': request})
        return Response(serializer.data)
    
    @action(detail=True, methods=['get'])
    def download(self, request, pk=None):
        """Download the current version of the document."""
        document = self.get_object()
        version = document.current_version
        
        if not version or not version.file:
            return Response(
                {'error': 'No file available for download.'},
                status=status.HTTP_404_NOT_FOUND
            )
        
        # Log download
        DocumentService.log_download(request.user, document, version, request)
        
        response = FileResponse(
            version.file.open('rb'),
            content_type=version.mime_type
        )
        response['Content-Disposition'] = f'attachment; filename="{version.file_name}"'
        return response
    
    @action(detail=True, methods=['get'], url_path='versions/(?P<version_id>[^/.]+)/download')
    def download_version(self, request, pk=None, version_id=None):
        """Download a specific version."""
        document = self.get_object()
        version = get_object_or_404(DocumentVersion, id=version_id, document=document)
        
        if not version.file:
            return Response(
                {'error': 'No file available for download.'},
                status=status.HTTP_404_NOT_FOUND
            )
        
        # Log download
        DocumentService.log_download(request.user, document, version, request)
        
        response = FileResponse(
            version.file.open('rb'),
            content_type=version.mime_type
        )
        response['Content-Disposition'] = f'attachment; filename="{version.file_name}"'
        return response
    
    @action(detail=True, methods=['patch'])
    def move(self, request, pk=None):
        """Move document to a different folder."""
        if not EDMSPermissions.can_move_document(request.user):
            return Response(
                {'error': 'You do not have permission to move documents.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        document = self.get_object()
        serializer = DocumentMoveSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        folder = None
        if serializer.validated_data.get('folder'):
            folder = Folder.objects.get(id=serializer.validated_data['folder'])
        
        document = DocumentService.move_document(request.user, document, folder, request)
        return Response(DocumentDetailSerializer(document, context={'request': request}).data)
    
    @action(detail=True, methods=['post'])
    def submit_for_review(self, request, pk=None):
        """Submit document for PMNC review."""
        document = self.get_object()
        
        try:
            workflow = WorkflowService.submit_for_review(request.user, document, request)
            document.refresh_from_db()
            return Response(DocumentDetailSerializer(document, context={'request': request}).data)
        except ValueError as e:
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'], parser_classes=[parsers.JSONParser])
    def validate(self, request, pk=None):
        """PMNC validates the document."""
        if not EDMSPermissions.can_validate(request.user):
            return Response(
                {'error': 'You do not have permission to validate documents.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        document = self.get_object()
        serializer = WorkflowActionSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        try:
            document = WorkflowService.validate_document(
                request.user, document,
                comments=serializer.validated_data.get('comments', ''),
                request=request
            )
            return Response(DocumentDetailSerializer(document, context={'request': request}).data)
        except ValueError as e:
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'], parser_classes=[parsers.JSONParser])
    def request_revision(self, request, pk=None):
        """Request revision from uploader."""
        if not EDMSPermissions.can_validate(request.user):
            return Response(
                {'error': 'You do not have permission to request revisions.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        document = self.get_object()
        serializer = WorkflowActionSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        comments = serializer.validated_data.get('comments', '')
        if not comments:
            return Response(
                {'error': 'Comments are required when requesting revision.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            document = WorkflowService.request_revision(
                request.user, document, comments, request
            )
            return Response(DocumentDetailSerializer(document, context={'request': request}).data)
        except ValueError as e:
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'], parser_classes=[parsers.JSONParser])
    def approve(self, request, pk=None):
        """SPV final approval."""
        if not EDMSPermissions.can_approve(request.user):
            return Response(
                {'error': 'You do not have permission for final approval.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        document = self.get_object()
        serializer = WorkflowActionSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        try:
            document = WorkflowService.approve_document(
                request.user, document,
                comments=serializer.validated_data.get('comments', ''),
                request=request
            )
            return Response(DocumentDetailSerializer(document, context={'request': request}).data)
        except ValueError as e:
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'], parser_classes=[parsers.JSONParser])
    def reject(self, request, pk=None):
        """SPV rejects the document."""
        if not EDMSPermissions.can_approve(request.user):
            return Response(
                {'error': 'You do not have permission to reject documents.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        document = self.get_object()
        serializer = WorkflowActionSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        comments = serializer.validated_data.get('comments', '')
        if not comments:
            return Response(
                {'error': 'Comments are required when rejecting a document.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            document = WorkflowService.reject_document(
                request.user, document, comments, request
            )
            return Response(DocumentDetailSerializer(document, context={'request': request}).data)
        except ValueError as e:
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'])
    def archive(self, request, pk=None):
        """Archive a document (soft delete)."""
        if not EDMSPermissions.can_archive(request.user):
            return Response(
                {'error': 'You do not have permission to archive documents.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        document = self.get_object()
        document.status = Document.Status.ARCHIVED
        document.save(update_fields=['status', 'updated_at'])
        
        AuditService.log(
            actor=request.user,
            action=DocumentAuditLog.Action.ARCHIVED,
            resource_type='Document',
            resource_id=document.id,
            request=request
        )
        
        return Response({'status': 'Document archived successfully.'})
    
    @action(detail=True, methods=['post'], url_path='versions/(?P<version_number>[0-9]+)/restore')
    def restore_version(self, request, pk=None, version_number=None):
        """
        Restore an older version by creating a new version from it.
        Government compliance: Rollback capability without destroying history.
        """
        document = self.get_object()
        
        if not EDMSPermissions.can_edit_document(request.user, document):
            return Response(
                {'error': 'You do not have permission to restore versions of this document.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        try:
            version_number_int = int(version_number)
            new_version = DocumentService.restore_version(
                user=request.user,
                document=document,
                version_number=version_number_int,
                request=request
            )
            
            document.refresh_from_db()
            return Response(
                {
                    'message': f'Version {version_number_int} restored successfully as version {new_version.version_number}',
                    'document': DocumentDetailSerializer(document, context={'request': request}).data
                },
                status=status.HTTP_200_OK
            )
        except PermissionError as e:
            return Response({'error': str(e)}, status=status.HTTP_403_FORBIDDEN)
        except ValueError as e:
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
    
    @action(detail=True, methods=['get'], url_path='versions/compare')
    def compare_versions(self, request, pk=None):
        """
        Compare two versions of a document.
        Query params: version_a, version_b (version numbers)
        """
        document = self.get_object()
        
        version_a = request.query_params.get('version_a')
        version_b = request.query_params.get('version_b')
        
        if not version_a or not version_b:
            return Response(
                {'error': 'Both version_a and version_b query parameters are required.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            version_a_int = int(version_a)
            version_b_int = int(version_b)
            
            comparison = DocumentService.compare_versions(
                document=document,
                version_a_number=version_a_int,
                version_b_number=version_b_int
            )
            
            return Response(comparison, status=status.HTTP_200_OK)
        except ValueError as e:
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)


class ApprovalViewSet(viewsets.ReadOnlyModelViewSet):
    """
    ViewSet for viewing approvals and pending items.
    """
    serializer_class = ApprovalWorkflowSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        return ApprovalWorkflow.objects.exclude(
            status=ApprovalWorkflow.WorkflowStatus.CANCELLED
        ).select_related('document', 'initiated_by').prefetch_related('steps')
    
    @action(detail=False, methods=['get'])
    def pending(self, request):
        """Get documents pending action from current user."""
        documents = WorkflowService.get_pending_approvals(request.user)
        serializer = DocumentListSerializer(documents, many=True)
        return Response(serializer.data)


class AuditLogViewSet(viewsets.ReadOnlyModelViewSet):
    """
    Read-only access to audit logs (SPV/NICDC only).
    """
    serializer_class = DocumentAuditLogSerializer
    permission_classes = [permissions.IsAuthenticated, CanViewAuditLog]
    
    def get_queryset(self):
        queryset = DocumentAuditLog.objects.all()
        
        # Filter by document
        document_id = self.request.query_params.get('document')
        if document_id:
            queryset = queryset.filter(resource_type='Document', resource_id=document_id)
        
        # Filter by action
        action = self.request.query_params.get('action')
        if action:
            queryset = queryset.filter(action=action)
        
        # Filter by actor
        actor_id = self.request.query_params.get('actor')
        if actor_id:
            queryset = queryset.filter(actor_id=actor_id)
        
        # Filter by date range
        start_date = self.request.query_params.get('start_date')
        end_date = self.request.query_params.get('end_date')
        if start_date:
            queryset = queryset.filter(timestamp__gte=start_date)
        if end_date:
            queryset = queryset.filter(timestamp__lte=end_date)
        
        return queryset.select_related('actor')


class NotingSheetViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Noting Sheet operations.
    
    Supports:
    - List notes for a document
    - Create draft notes
    - Submit notes (makes them immutable)
    - No update/delete for submitted notes
    """
    serializer_class = NotingSheetListSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        from .models import NotingSheet
        user = self.request.user
        queryset = NotingSheet.objects.all()
        
        # Filter drafts - users can only see their own drafts
        if not self.request.query_params.get('include_drafts'):
            # Hide other users' drafts
            from django.db.models import Q
            queryset = queryset.filter(Q(is_draft=False) | Q(author=user))
        
        # Filter by document (primary use case)
        document_id = self.request.query_params.get('document')
        if document_id:
            queryset = queryset.filter(document_id=document_id)
        
        # Filter by type
        note_type = self.request.query_params.get('type')
        if note_type:
            queryset = queryset.filter(note_type=note_type)
        
        # Filter by author
        author_id = self.request.query_params.get('author')
        if author_id:
            queryset = queryset.filter(author_id=author_id)
        
        return queryset.select_related('author', 'document', 'document_version')
    
    def get_serializer_class(self):
        if self.action == 'list':
            return NotingSheetListSerializer
        if self.action == 'create':
            return NotingSheetCreateSerializer
        return NotingSheetDetailSerializer
    
    def create(self, request, *args, **kwargs):
        """Create a new noting entry (draft by default)."""
        from .models import NotingSheet, Document, DocumentVersion
        
        serializer = NotingSheetCreateSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        data = serializer.validated_data
        note_type = data['note_type']
        
        # Permission check based on note type
        if not EDMSPermissions.can_add_noting(request.user, note_type):
            return Response(
                {'error': f'You do not have permission to add {note_type} notes.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        try:
            document = Document.objects.get(id=data['document'])
            document_version = None
            if data.get('document_version'):
                document_version = DocumentVersion.objects.get(id=data['document_version'])
            
            references_note = None
            if data.get('references_note'):
                references_note = NotingSheet.objects.get(id=data['references_note'])
            
            note = NotingSheet.objects.create(
                document=document,
                document_version=document_version,
                note_type=note_type,
                subject=data.get('subject', ''),
                content=data['content'],
                page_reference=data.get('page_reference'),
                references_note=references_note,
                ruling_action=data.get('ruling_action', 'NONE'),
                author=request.user,
                is_draft=data.get('is_draft', True)
            )
            
            # If not draft, submit immediately
            if not data.get('is_draft', True):
                note.submit()
            
            return Response(
                NotingSheetDetailSerializer(note).data,
                status=status.HTTP_201_CREATED
            )
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
    
    def update(self, request, *args, **kwargs):
        """Only allow updating drafts."""
        note = self.get_object()
        if not note.is_draft:
            return Response(
                {'error': 'Submitted notes are immutable and cannot be modified.'},
                status=status.HTTP_403_FORBIDDEN
            )
        if note.author != request.user:
            return Response(
                {'error': 'You can only edit your own draft notes.'},
                status=status.HTTP_403_FORBIDDEN
            )
        return super().update(request, *args, **kwargs)
    
    def destroy(self, request, *args, **kwargs):
        """Only allow deleting drafts."""
        note = self.get_object()
        if not note.is_draft:
            return Response(
                {'error': 'Submitted notes cannot be deleted. They are permanent legal records.'},
                status=status.HTTP_403_FORBIDDEN
            )
        if note.author != request.user:
            return Response(
                {'error': 'You can only delete your own draft notes.'},
                status=status.HTTP_403_FORBIDDEN
            )
        return super().destroy(request, *args, **kwargs)
    
    @action(detail=True, methods=['post'])
    def submit(self, request, pk=None):
        """Submit a draft note, making it immutable."""
        note = self.get_object()
        
        if note.author != request.user:
            return Response(
                {'error': 'You can only submit your own notes.'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        if not note.is_draft:
            return Response(
                {'error': 'Note is already submitted.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            note.submit()
            return Response(NotingSheetDetailSerializer(note).data)
        except Exception as e:
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=False, methods=['get'])
    def export_pdf(self, request):
        """Export all notes for a document as PDF."""
        from django.http import HttpResponse
        from .models import NotingSheet
        
        document_id = request.query_params.get('document')
        if not document_id:
            return Response(
                {'error': 'document parameter is required.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        notes = NotingSheet.objects.filter(
            document_id=document_id,
            is_draft=False
        ).order_by('note_number')
        
        if not notes.exists():
            return Response(
                {'error': 'No submitted notes found for this document.'},
                status=status.HTTP_404_NOT_FOUND
            )
        
        # Generate simple text/HTML for now - can be enhanced with proper PDF library
        document = notes.first().document
        content = f"""
        <html>
        <head>
            <title>Noting Sheet - {document.title}</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 40px; }}
                .header {{ border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }}
                .note {{ border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }}
                .note-header {{ display: flex; justify-content: space-between; margin-bottom: 10px; }}
                .note-number {{ font-weight: bold; font-size: 1.2em; }}
                .note-type {{ background: #e0e0e0; padding: 2px 8px; border-radius: 3px; }}
                .note-meta {{ color: #666; font-size: 0.9em; }}
                .note-content {{ margin-top: 10px; }}
                .ruling {{ border-left: 4px solid #4CAF50; }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>NOTING SHEET</h1>
                <p><strong>Document:</strong> {document.title}</p>
                <p><strong>Document Number:</strong> {document.document_number or 'N/A'}</p>
                <p><strong>Status:</strong> {document.status}</p>
            </div>
        """
        
        for note in notes:
            ruling_class = 'ruling' if note.note_type == 'RULING' else ''
            content += f"""
            <div class="note {ruling_class}">
                <div class="note-header">
                    <span class="note-number">Note #{note.note_number}</span>
                    <span class="note-type">{note.get_note_type_display()}</span>
                </div>
                <div class="note-meta">
                    <strong>{note.author_name}</strong> ({note.author_role})
                    {f'- {note.author_designation}' if note.author_designation else ''}
                    <br>
                    Submitted: {note.submitted_at.strftime('%d %b %Y, %H:%M') if note.submitted_at else 'N/A'}
                </div>
                {f'<p><strong>Subject:</strong> {note.subject}</p>' if note.subject else ''}
                <div class="note-content">{note.content}</div>
                {f'<p><em>Ruling Action: {note.get_ruling_action_display()}</em></p>' if note.ruling_action != 'NONE' else ''}
            </div>
            """
        
        content += "</body></html>"
        
        response = HttpResponse(content, content_type='text/html')
        response['Content-Disposition'] = f'attachment; filename="noting_sheet_{document_id}.html"'
        return response




================================================
FILE: backend/edms/management/__init__.py
================================================
[Empty file]


================================================
FILE: backend/edms/management/commands/__init__.py
================================================
[Empty file]


================================================
FILE: backend/edms/management/commands/align_edms_structure.py
================================================
"""
EDMS Structure Alignment Command

Retroactively applies the standard folder structure to existing projects.
This is safe to run multiple times (idempotent) and will only create missing folders.

Usage:
    python manage.py align_edms_structure              # All projects
    python manage.py align_edms_structure --dry-run    # Preview only
    python manage.py align_edms_structure --project-id=123  # Specific project
"""
import logging
from django.core.management.base import BaseCommand, CommandError
from django.db import transaction

logger = logging.getLogger(__name__)


class Command(BaseCommand):
    help = 'Ensure all existing projects have the standard EDMS folder structure'

    def add_arguments(self, parser):
        parser.add_argument(
            '--project-id',
            type=int,
            help='Specific project ID to align (default: all projects)',
        )
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Preview changes without creating folders',
        )
        parser.add_argument(
            '--batch-size',
            type=int,
            default=100,
            help='Number of projects to process per batch (default: 100)',
        )
        parser.add_argument(
            '--verbose',
            action='store_true',
            help='Show detailed output for each project',
        )

    def handle(self, *args, **options):
        from projects.models import Project
        from edms.services.directory_service import DirectoryService
        
        dry_run = options['dry_run']
        project_id = options['project_id']
        batch_size = options['batch_size']
        verbose = options['verbose']
        
        if dry_run:
            self.stdout.write(self.style.WARNING('DRY RUN MODE - No changes will be made'))
            self.stdout.write('')
        
        # Get projects to process
        if project_id:
            try:
                projects = [Project.objects.get(id=project_id)]
                self.stdout.write(f'Processing single project: {projects[0].name}')
            except Project.DoesNotExist:
                raise CommandError(f'Project with ID {project_id} not found')
        else:
            projects = list(Project.objects.all().order_by('id'))
            self.stdout.write(f'Processing {len(projects)} projects...')
        
        # Statistics
        total_projects = len(projects)
        processed = 0
        skipped = 0
        total_folders_created = 0
        errors = []
        
        # Process in batches for memory efficiency
        for i in range(0, total_projects, batch_size):
            batch = projects[i:i + batch_size]
            
            for project in batch:
                try:
                    if dry_run:
                        # Preview mode: check what would be created
                        validation = DirectoryService.validate_project_structure(project)
                        
                        if validation['is_valid']:
                            skipped += 1
                            if verbose:
                                self.stdout.write(
                                    f'  [SKIP] {project.name}: Structure already complete'
                                )
                        else:
                            missing_count = validation['missing_count']
                            total_folders_created += missing_count
                            self.stdout.write(
                                f'  [WOULD CREATE] {project.name}: '
                                f'{missing_count} folders missing'
                            )
                            if verbose:
                                for folder in validation['missing_folders'][:5]:
                                    self.stdout.write(f'    - {folder}')
                                if missing_count > 5:
                                    self.stdout.write(f'    ... and {missing_count - 5} more')
                    else:
                        # Actual mode: create folders
                        with transaction.atomic():
                            folders_created = DirectoryService.ensure_project_structure(
                                project=project,
                                created_by=None  # System-initiated
                            )
                            
                            if folders_created > 0:
                                total_folders_created += folders_created
                                self.stdout.write(
                                    f'  [OK] {project.name}: '
                                    f'{folders_created} folders created'
                                )
                            else:
                                skipped += 1
                                if verbose:
                                    self.stdout.write(
                                        f'  [SKIP] {project.name}: '
                                        'Structure already complete'
                                    )
                    
                    processed += 1
                    
                except Exception as e:
                    errors.append((project.name, str(e)))
                    self.stdout.write(
                        self.style.ERROR(f'  [ERROR] {project.name}: {e}')
                    )
                    logger.exception(f'Error processing project {project.name}')
            
            # Progress update for large batches
            if total_projects > batch_size:
                progress = min(i + batch_size, total_projects)
                self.stdout.write(
                    f'Progress: {progress}/{total_projects} projects processed'
                )
        
        # Summary
        self.stdout.write('')
        self.stdout.write('=' * 60)
        self.stdout.write('SUMMARY')
        self.stdout.write('=' * 60)
        
        if dry_run:
            self.stdout.write(self.style.WARNING('DRY RUN - No changes were made'))
            self.stdout.write(f'Projects analyzed: {processed}')
            self.stdout.write(f'Projects already complete: {skipped}')
            self.stdout.write(f'Folders that would be created: {total_folders_created}')
        else:
            self.stdout.write(self.style.SUCCESS(f'Projects processed: {processed}'))
            self.stdout.write(f'Projects skipped (already complete): {skipped}')
            self.stdout.write(self.style.SUCCESS(
                f'Total folders created: {total_folders_created}'
            ))
        
        if errors:
            self.stdout.write(self.style.ERROR(f'Errors: {len(errors)}'))
            for project_name, error in errors:
                self.stdout.write(self.style.ERROR(f'  - {project_name}: {error}'))
        
        self.stdout.write('')
        
        if dry_run and total_folders_created > 0:
            self.stdout.write(
                self.style.NOTICE(
                    'Run without --dry-run to apply changes:'
                )
            )
            self.stdout.write('  python manage.py align_edms_structure')



================================================
FILE: backend/edms/management/commands/debug_edms.py
================================================

from django.core.management.base import BaseCommand
from django.conf import settings
from django.core.files.storage import default_storage
from edms.models import Document
import os

class Command(BaseCommand):
    help = 'Debugs EDMS file paths and database consistency'

    def handle(self, *args, **options):
        self.stdout.write("--- DIAGNOSTICS START ---")
        self.stdout.write(f"MEDIA_ROOT: {settings.MEDIA_ROOT}")
        self.stdout.write(f"MEDIA_URL: {settings.MEDIA_URL}")
        self.stdout.write(f"FileSystemStorage Location: {default_storage.location}")
        
        self.stdout.write("\n--- DATABASE vs DISK ---")
        documents = Document.objects.all()
        if not documents:
            self.stdout.write("No documents found in DB.")
            return

        for doc in documents:
            self.stdout.write(f"\nDocument ID: {doc.id}")
            self.stdout.write(f"Title: {doc.title}")
            self.stdout.write(f"Stored Key (s3_key): '{doc.s3_key}'")
            
            # Check via Storage API
            exists = default_storage.exists(doc.s3_key)
            self.stdout.write(f"Storage.exists(key): {exists}")
            
            if not exists:
                # Check manual path
                full_path = os.path.join(settings.MEDIA_ROOT, doc.s3_key)
                self.stdout.write(f"Checking full path manually: {full_path}")
                self.stdout.write(f"os.path.exists: {os.path.exists(full_path)}")
                
                # List directory
                dir_path = os.path.dirname(full_path)
                if os.path.exists(dir_path):
                    self.stdout.write(f"Contents of {dir_path}:")
                    try:
                        self.stdout.write(str(os.listdir(dir_path)))
                    except Exception as e:
                        self.stdout.write(f"Error listing dir: {e}")
                else:
                    self.stdout.write(f"Directory does not exist: {dir_path}")
        
        self.stdout.write("\n--- DIAGNOSTICS END ---")



================================================
FILE: backend/edms/management/commands/repair_edms.py
================================================

from django.core.management.base import BaseCommand
from django.conf import settings
from django.core.files.storage import default_storage
from django.core.files.base import ContentFile
from edms.models import Document
import os

class Command(BaseCommand):
    help = 'Repairs missing physical files for EDMS documents'

    def handle(self, *args, **options):
        documents = Document.objects.all()
        for doc in documents:
            if not default_storage.exists(doc.s3_key):
                self.stdout.write(f"Restoring file for: {doc.s3_key}")
                
                # Create simple PDF content
                # This is a minimal valid PDF header/footer to prevent viewer error
                dummy_pdf_content = (
                    b"%PDF-1.4\n"
                    b"1 0 obj\n"
                    b"<< /Type /Catalog /Pages 2 0 R >>\n"
                    b"endobj\n"
                    b"2 0 obj\n"
                    b"<< /Type /Pages /Kids [3 0 R] /Count 1 >>\n"
                    b"endobj\n"
                    b"3 0 obj\n"
                    b"<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Resources << >> /Contents 4 0 R >>\n"
                    b"endobj\n"
                    b"4 0 obj\n"
                    b"<< /Length 44 >>\n"
                    b"stream\n"
                    b"BT /F1 24 Tf 50 700 Td (Restored Document content) Tj ET\n"
                    b"endstream\n"
                    b"endobj\n"
                    b"xref\n"
                    b"0 5\n"
                    b"0000000000 65535 f \n"
                    b"0000000010 00000 n \n"
                    b"0000000060 00000 n \n"
                    b"0000000117 00000 n \n"
                    b"0000000223 00000 n \n"
                    b"trailer\n"
                    b"<< /Size 5 /Root 1 0 R >>\n"
                    b"startxref\n"
                    b"317\n"
                    b"%%EOF"
                )
                
                # Check dir
                full_path = os.path.join(settings.MEDIA_ROOT, doc.s3_key)
                os.makedirs(os.path.dirname(full_path), exist_ok=True)
                
                default_storage.save(doc.s3_key, ContentFile(dummy_pdf_content))
                self.stdout.write(f"Created: {doc.s3_key}")



================================================
FILE: backend/edms/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2025-12-14 07:16

import django.db.models.deletion
import edms.models
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('projects', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Document',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('title', models.CharField(max_length=500)),
                ('description', models.TextField(blank=True)),
                ('document_type', models.CharField(choices=[('DRAWING', 'Drawing'), ('REPORT', 'Report'), ('CONTRACT', 'Contract'), ('CORRESPONDENCE', 'Correspondence'), ('SPECIFICATION', 'Specification'), ('INVOICE', 'Invoice'), ('MEDIA', 'Media'), ('OTHER', 'Other')], default='OTHER', max_length=20)),
                ('document_number', models.CharField(blank=True, help_text='Official document reference number', max_length=100)),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('UNDER_REVIEW', 'Under Review'), ('REVISION_REQUESTED', 'Revision Requested'), ('VALIDATED', 'Validated'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected'), ('ARCHIVED', 'Archived')], default='DRAFT', max_length=20)),
                ('is_confidential', models.BooleanField(default=False)),
                ('tags', models.JSONField(blank=True, default=list)),
                ('metadata', models.JSONField(blank=True, default=dict, help_text='Flexible additional attributes')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documents', to='projects.project')),
                ('uploaded_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='uploaded_documents', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='ApprovalWorkflow',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('status', models.CharField(choices=[('PENDING', 'Pending Review'), ('IN_PROGRESS', 'In Progress'), ('VALIDATED', 'Validated (Awaiting Final)'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected'), ('CANCELLED', 'Cancelled')], default='PENDING', max_length=20)),
                ('initiated_at', models.DateTimeField(auto_now_add=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('deadline', models.DateTimeField(blank=True, null=True)),
                ('initiated_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='initiated_workflows', to=settings.AUTH_USER_MODEL)),
                ('document', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='workflow', to='edms.document')),
            ],
            options={
                'ordering': ['-initiated_at'],
            },
        ),
        migrations.CreateModel(
            name='DocumentVersion',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('version_number', models.PositiveIntegerField()),
                ('file', models.FileField(upload_to=edms.models.document_file_path)),
                ('file_name', models.CharField(max_length=255)),
                ('file_size', models.BigIntegerField(help_text='Size in bytes')),
                ('file_hash', models.CharField(help_text='SHA-256 hash for integrity', max_length=64)),
                ('mime_type', models.CharField(max_length=100)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('change_notes', models.TextField(blank=True, help_text='What changed in this version')),
                ('document', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='versions', to='edms.document')),
                ('uploaded_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='uploaded_versions', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-version_number'],
                'unique_together': {('document', 'version_number')},
            },
        ),
        migrations.AddField(
            model_name='document',
            name='current_version',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='current_for_document', to='edms.documentversion'),
        ),
        migrations.CreateModel(
            name='Folder',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=255)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_folders', to=settings.AUTH_USER_MODEL)),
                ('parent', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='subfolders', to='edms.folder')),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='folders', to='projects.project')),
            ],
            options={
                'ordering': ['name'],
                'unique_together': {('name', 'parent', 'project')},
            },
        ),
        migrations.AddField(
            model_name='document',
            name='folder',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='documents', to='edms.folder'),
        ),
        migrations.CreateModel(
            name='ApprovalStep',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('step_type', models.CharField(choices=[('PMNC_REVIEW', 'PMNC Review'), ('SPV_APPROVAL', 'SPV Final Approval')], max_length=20)),
                ('step_order', models.PositiveIntegerField()),
                ('role_required', models.CharField(max_length=50)),
                ('action', models.CharField(choices=[('PENDING', 'Pending'), ('APPROVED', 'Approved'), ('VALIDATED', 'Validated'), ('REJECTED', 'Rejected'), ('REVISION_REQUESTED', 'Revision Requested')], default='PENDING', max_length=20)),
                ('acted_at', models.DateTimeField(blank=True, null=True)),
                ('comments', models.TextField(blank=True)),
                ('actor', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approval_actions', to=settings.AUTH_USER_MODEL)),
                ('workflow', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='steps', to='edms.approvalworkflow')),
            ],
            options={
                'ordering': ['step_order'],
                'unique_together': {('workflow', 'step_order')},
            },
        ),
        migrations.CreateModel(
            name='DocumentAuditLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('actor_role', models.CharField(max_length=50)),
                ('action', models.CharField(choices=[('UPLOAD', 'Document Uploaded'), ('VERSION_CREATED', 'New Version Created'), ('VIEW', 'Document Viewed'), ('DOWNLOAD', 'Document Downloaded'), ('MOVED', 'Document Moved'), ('STATUS_CHANGED', 'Status Changed'), ('SUBMITTED_FOR_REVIEW', 'Submitted for Review'), ('VALIDATED', 'Validated by PMNC'), ('APPROVED', 'Final Approval'), ('REJECTED', 'Rejected'), ('REVISION_REQUESTED', 'Revision Requested'), ('ARCHIVED', 'Archived'), ('FOLDER_CREATED', 'Folder Created'), ('FOLDER_MOVED', 'Folder Moved')], max_length=30)),
                ('resource_type', models.CharField(max_length=50)),
                ('resource_id', models.UUIDField()),
                ('details', models.JSONField(default=dict, help_text='Additional context about the action')),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('user_agent', models.TextField(blank=True)),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('actor', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='edms_audit_logs', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-timestamp'],
                'indexes': [models.Index(fields=['resource_type', 'resource_id'], name='edms_docume_resourc_815757_idx'), models.Index(fields=['actor', 'action'], name='edms_docume_actor_i_63b406_idx'), models.Index(fields=['timestamp'], name='edms_docume_timesta_e1a5a2_idx')],
            },
        ),
    ]



================================================
FILE: backend/edms/migrations/0002_add_notingsheet.py
================================================
# Generated by Django 6.0 on 2025-12-14 10:02

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('edms', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='NotingSheet',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('note_number', models.PositiveIntegerField(help_text='Sequential number within document')),
                ('note_type', models.CharField(choices=[('REMARK', 'Remark/Observation'), ('CLARIFICATION_REQUEST', 'Clarification Request'), ('CLARIFICATION_RESPONSE', 'Clarification Response'), ('RECOMMENDATION', 'Recommendation'), ('RULING', 'Decision/Ruling')], default='REMARK', max_length=30)),
                ('subject', models.CharField(blank=True, max_length=500)),
                ('content', models.TextField()),
                ('page_reference', models.JSONField(blank=True, help_text="Page and coordinate reference: {'page': 3, 'coords': [x,y]}", null=True)),
                ('ruling_action', models.CharField(choices=[('NONE', 'None'), ('VALIDATE', 'Validate Document'), ('APPROVE', 'Approve Document'), ('REJECT', 'Reject Document'), ('REQUEST_REVISION', 'Request Revision')], default='NONE', help_text='Action to take when ruling is submitted', max_length=30)),
                ('author_name', models.CharField(help_text='Frozen author name', max_length=200)),
                ('author_role', models.CharField(help_text='Frozen author role', max_length=50)),
                ('author_designation', models.CharField(blank=True, help_text='Official designation', max_length=200)),
                ('is_draft', models.BooleanField(default=True, help_text='Draft notes are editable, submitted notes are immutable')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('submitted_at', models.DateTimeField(blank=True, help_text='Timestamp when note was finalized', null=True)),
                ('author', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='noting_entries', to=settings.AUTH_USER_MODEL)),
                ('document', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='notings', to='edms.document')),
                ('document_version', models.ForeignKey(blank=True, help_text='Specific version this note references', null=True, on_delete=django.db.models.deletion.SET_NULL, to='edms.documentversion')),
                ('references_note', models.ForeignKey(blank=True, help_text='Reference to a previous note being corrected or responded to', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='referenced_by', to='edms.notingsheet')),
                ('workflow', models.ForeignKey(blank=True, help_text='Linked approval workflow', null=True, on_delete=django.db.models.deletion.SET_NULL, to='edms.approvalworkflow')),
            ],
            options={
                'ordering': ['note_number'],
                'indexes': [models.Index(fields=['document', 'is_draft'], name='edms_noting_documen_2fd5d6_idx'), models.Index(fields=['author', 'created_at'], name='edms_noting_author__3d4fe0_idx')],
                'unique_together': {('document', 'note_number')},
            },
        ),
    ]



================================================
FILE: backend/edms/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: backend/edms/services/__init__.py
================================================
"""
EDMS Services Package

Re-exports all services for backward compatibility.
"""

# Re-export from original services module (now renamed to _base_services)
# to maintain backward compatibility with existing imports
from edms.services_base import (
    DocumentService,
    WorkflowService, 
    FolderService,
    AuditService,
)

# New directory service for auto-filing
from edms.services.directory_service import DirectoryService

__all__ = [
    'DocumentService',
    'WorkflowService',
    'FolderService',
    'AuditService',
    'DirectoryService',
]



================================================
FILE: backend/edms/services/directory_service.py
================================================
"""
EDMS Directory Service - Automated Intelligent Filing System

Provides:
- Standardized government-compliant folder structure for projects
- Smart document routing based on category
- Idempotent operations (safe to run multiple times)

Industry Standard: Uses numbered prefixes for proper lifecycle ordering.
"""
import logging
from typing import Optional, Dict, List, Tuple
from django.db import transaction
from django.core.cache import cache

logger = logging.getLogger(__name__)


# =============================================================================
# CONFIGURATION: Standard Government Project Structure
# =============================================================================

STANDARD_PROJECT_STRUCTURE: Dict[str, List[str]] = {
    "01_Planning & Approvals": [
        "Admin Approvals",
        "DPR",
        "Feasibility Reports",
        "Site Survey",
        "Environmental Clearance",
    ],
    "02_Procurement & Contracts": [
        "Tenders",
        "Agreements",
        "Work Orders",
        "LOA",
        "Tender Evaluation",
    ],
    "03_Engineering & Design": [
        "Drawings",
        "BoQ",
        "Technical Specs",
        "As-Built Drawings",
        "Revisions",
    ],
    "04_Financials": [
        "RA Bills",
        "Tax Invoices",
        "Payment Advices",
        "Budget Estimates",
        "Final Bills",
        "Fund Sanction Orders",  # Funding proof documents from project creation
    ],
    "05_Site Execution": [
        "Daily Reports",
        "Site Photos",
        "Inspection Reports",
        "Risk Evidence",
        "Quality Reports",
        "Safety Reports",
    ],
    "06_Legal & Compliance": [
        "Insurance",
        "Bank Guarantees",
        "Notices",
        "NOCs",
        "Licenses",
    ],
    "07_Correspondence": [
        "Incoming",
        "Outgoing",
        "Meeting Minutes",
    ],
    "99_Miscellaneous": [
        "Uncategorized",
        "Archives",
    ],
}


# =============================================================================
# CONFIGURATION: Smart Routing Category Mappings
# =============================================================================

ROUTE_CATEGORY_MAPPING: Dict[str, str] = {
    # Planning & Approvals
    "ADMIN_APPROVAL": "01_Planning & Approvals/Admin Approvals",
    "DPR": "01_Planning & Approvals/DPR",
    "FEASIBILITY": "01_Planning & Approvals/Feasibility Reports",
    "SITE_SURVEY": "01_Planning & Approvals/Site Survey",
    "ENV_CLEARANCE": "01_Planning & Approvals/Environmental Clearance",
    
    # Procurement & Contracts
    "TENDER": "02_Procurement & Contracts/Tenders",
    "AGREEMENT": "02_Procurement & Contracts/Agreements",
    "WORK_ORDER": "02_Procurement & Contracts/Work Orders",
    "LOA": "02_Procurement & Contracts/LOA",
    "TENDER_EVALUATION": "02_Procurement & Contracts/Tender Evaluation",
    
    # Engineering & Design
    "DRAWING": "03_Engineering & Design/Drawings",
    "BOQ": "03_Engineering & Design/BoQ",
    "TECH_SPEC": "03_Engineering & Design/Technical Specs",
    "AS_BUILT": "03_Engineering & Design/As-Built Drawings",
    
    # Financials
    "RA_BILL": "04_Financials/RA Bills",
    "INVOICE": "04_Financials/Tax Invoices",
    "PAYMENT_ADVICE": "04_Financials/Payment Advices",
    "BUDGET": "04_Financials/Budget Estimates",
    "FINAL_BILL": "04_Financials/Final Bills",
    "FUNDING_PROOF": "04_Financials/Fund Sanction Orders",  # For two-step upload from project creation
    
    # Site Execution
    "DAILY_REPORT": "05_Site Execution/Daily Reports",
    "SITE_PHOTO": "05_Site Execution/Site Photos",
    "INSPECTION": "05_Site Execution/Inspection Reports",
    "RISK_EVIDENCE": "05_Site Execution/Risk Evidence",
    "QUALITY_REPORT": "05_Site Execution/Quality Reports",
    "SAFETY_REPORT": "05_Site Execution/Safety Reports",
    
    # Legal & Compliance
    "INSURANCE": "06_Legal & Compliance/Insurance",
    "BANK_GUARANTEE": "06_Legal & Compliance/Bank Guarantees",
    "NOTICE": "06_Legal & Compliance/Notices",
    "NOC": "06_Legal & Compliance/NOCs",
    "LICENSE": "06_Legal & Compliance/Licenses",
    
    # Correspondence
    "CORRESPONDENCE_IN": "07_Correspondence/Incoming",
    "CORRESPONDENCE_OUT": "07_Correspondence/Outgoing",
    "MEETING_MINUTES": "07_Correspondence/Meeting Minutes",
    
    # Fallback
    "OTHER": "99_Miscellaneous/Uncategorized",
}


# All valid route categories for serializer choices
ROUTE_CATEGORY_CHOICES: List[Tuple[str, str]] = [
    ("ADMIN_APPROVAL", "Admin Approval"),
    ("DPR", "Detailed Project Report"),
    ("FEASIBILITY", "Feasibility Report"),
    ("SITE_SURVEY", "Site Survey"),
    ("ENV_CLEARANCE", "Environmental Clearance"),
    ("TENDER", "Tender Document"),
    ("AGREEMENT", "Agreement/Contract"),
    ("WORK_ORDER", "Work Order"),
    ("LOA", "Letter of Award"),
    ("TENDER_EVALUATION", "Tender Evaluation"),
    ("DRAWING", "Drawing"),
    ("BOQ", "Bill of Quantities"),
    ("TECH_SPEC", "Technical Specification"),
    ("AS_BUILT", "As-Built Drawing"),
    ("RA_BILL", "Running Account Bill"),
    ("INVOICE", "Tax Invoice"),
    ("PAYMENT_ADVICE", "Payment Advice"),
    ("BUDGET", "Budget Estimate"),
    ("FINAL_BILL", "Final Bill"),
    ("FUNDING_PROOF", "Fund Sanction Order"),
    ("DAILY_REPORT", "Daily Progress Report"),
    ("SITE_PHOTO", "Site Photograph"),
    ("INSPECTION", "Inspection Report"),
    ("RISK_EVIDENCE", "Risk Evidence"),
    ("QUALITY_REPORT", "Quality Report"),
    ("SAFETY_REPORT", "Safety Report"),
    ("INSURANCE", "Insurance Document"),
    ("BANK_GUARANTEE", "Bank Guarantee"),
    ("NOTICE", "Notice"),
    ("NOC", "No Objection Certificate"),
    ("LICENSE", "License/Permit"),
    ("CORRESPONDENCE_IN", "Incoming Correspondence"),
    ("CORRESPONDENCE_OUT", "Outgoing Correspondence"),
    ("MEETING_MINUTES", "Meeting Minutes"),
    ("OTHER", "Other/Miscellaneous"),
]


class DirectoryService:
    """
    Service for managing standardized EDMS folder structures.
    
    Features:
    - Idempotent operations (safe to run multiple times)
    - Transaction-safe folder creation
    - Smart routing based on document category
    - Caching for high-traffic scenarios
    
    Usage:
        DirectoryService.ensure_project_structure(project, created_by=user)
        folder = DirectoryService.get_route_folder(project, "RA_BILL", user)
    """
    
    # Cache timeout for folder lookups (5 minutes)
    CACHE_TIMEOUT = 300
    
    @classmethod
    @transaction.atomic
    def ensure_project_structure(cls, project, created_by=None) -> int:
        """
        Ensure a project has the complete standard folder structure.
        
        This is IDEMPOTENT: safe to call multiple times without creating duplicates.
        Uses get_or_create for each folder to prevent race conditions.
        
        Args:
            project: Project instance
            created_by: User who triggered creation (for audit trail)
            
        Returns:
            int: Number of folders created (0 if structure already existed)
        """
        from edms.models import Folder, DocumentAuditLog
        
        folders_created = 0
        project_id = str(project.id)
        
        logger.info(f"Ensuring folder structure for project: {project.name} ({project_id})")
        
        try:
            # Create parent folders and their subfolders
            for parent_name, subfolders in STANDARD_PROJECT_STRUCTURE.items():
                # Create parent folder
                parent_folder, parent_created = Folder.objects.get_or_create(
                    project=project,
                    name=parent_name,
                    parent=None,
                    defaults={'created_by': created_by}
                )
                
                if parent_created:
                    folders_created += 1
                    cls._log_folder_creation(
                        parent_folder, created_by, 
                        auto_created=True, 
                        trigger='project_structure_init'
                    )
                
                # Create subfolders
                for subfolder_name in subfolders:
                    subfolder, sub_created = Folder.objects.get_or_create(
                        project=project,
                        name=subfolder_name,
                        parent=parent_folder,
                        defaults={'created_by': created_by}
                    )
                    
                    if sub_created:
                        folders_created += 1
                        cls._log_folder_creation(
                            subfolder, created_by,
                            auto_created=True,
                            trigger='project_structure_init'
                        )
            
            # Invalidate cache for this project
            cls._invalidate_project_cache(project_id)
            
            logger.info(
                f"Folder structure complete for {project.name}: "
                f"{folders_created} new folders created"
            )
            
        except Exception as e:
            logger.error(f"Error creating folder structure for {project.name}: {e}")
            raise
        
        return folders_created
    
    @classmethod
    def get_route_folder(cls, project, route_category: str, created_by=None):
        """
        Get the target folder for a given route category.
        
        If the folder doesn't exist (rare edge case), creates it immediately.
        
        Args:
            project: Project instance
            route_category: Category key from ROUTE_CATEGORY_MAPPING
            created_by: User for audit trail
            
        Returns:
            Folder instance
            
        Raises:
            ValueError: If route_category is invalid
        """
        from edms.models import Folder
        
        # Validate category
        if route_category not in ROUTE_CATEGORY_MAPPING:
            logger.warning(f"Unknown route category: {route_category}, using fallback")
            route_category = "OTHER"
        
        path = ROUTE_CATEGORY_MAPPING[route_category]
        
        # Try cache first
        cache_key = f"edms_folder_{project.id}_{route_category}"
        cached_folder_id = cache.get(cache_key)
        
        if cached_folder_id:
            try:
                return Folder.objects.get(id=cached_folder_id)
            except Folder.DoesNotExist:
                # Cache is stale, continue to lookup
                cache.delete(cache_key)
        
        # Lookup by path
        folder = cls.get_folder_by_path(project, path, created_by)
        
        # Cache the result
        if folder:
            cache.set(cache_key, str(folder.id), cls.CACHE_TIMEOUT)
        
        return folder
    
    @classmethod
    @transaction.atomic
    def get_folder_by_path(cls, project, path: str, created_by=None):
        """
        Get a folder by its path (e.g., "04_Financials/RA Bills").
        
        Creates the folder hierarchy if it doesn't exist.
        
        Args:
            project: Project instance
            path: Folder path (e.g., "01_Planning & Approvals/Admin Approvals")
            created_by: User for audit trail
            
        Returns:
            Folder instance
        """
        from edms.models import Folder
        
        parts = path.split("/")
        current_parent = None
        current_folder = None
        
        for part in parts:
            part = part.strip()
            if not part:
                continue
                
            current_folder, created = Folder.objects.get_or_create(
                project=project,
                name=part,
                parent=current_parent,
                defaults={'created_by': created_by}
            )
            
            if created:
                cls._log_folder_creation(
                    current_folder, created_by,
                    auto_created=True,
                    trigger='route_folder_creation'
                )
                logger.info(f"Created folder on-demand: {path}")
            
            current_parent = current_folder
        
        return current_folder
    
    @classmethod
    def get_project_folder_tree(cls, project) -> Dict:
        """
        Get the complete folder tree for a project.
        
        Optimized for large projects with many folders.
        Uses prefetch to minimize database queries.
        
        Args:
            project: Project instance
            
        Returns:
            dict: Nested folder structure
        """
        from edms.models import Folder
        
        # Single query with prefetch for efficiency
        all_folders = list(
            Folder.objects.filter(project=project)
            .select_related('parent', 'created_by')
            .order_by('name')
        )
        
        # Build tree in memory
        folder_map = {str(f.id): f for f in all_folders}
        root_folders = []
        
        for folder in all_folders:
            if folder.parent is None:
                root_folders.append(cls._folder_to_dict(folder, folder_map, all_folders))
        
        return {
            'project_id': str(project.id),
            'project_name': project.name,
            'folders': root_folders,
            'total_count': len(all_folders)
        }
    
    @classmethod
    def get_folder_statistics(cls, project) -> Dict:
        """
        Get statistics about folder structure for a project.
        
        Args:
            project: Project instance
            
        Returns:
            dict: Statistics including folder count, document count per folder
        """
        from edms.models import Folder, Document
        from django.db.models import Count
        
        folders_with_counts = (
            Folder.objects.filter(project=project)
            .annotate(document_count=Count('documents'))
            .values('id', 'name', 'parent_id', 'document_count')
        )
        
        total_folders = len(folders_with_counts)
        empty_folders = sum(1 for f in folders_with_counts if f['document_count'] == 0)
        total_documents = sum(f['document_count'] for f in folders_with_counts)
        
        return {
            'total_folders': total_folders,
            'empty_folders': empty_folders,
            'folders_with_docs': total_folders - empty_folders,
            'total_documents': total_documents,
            'expected_folders': cls._get_expected_folder_count(),
            'structure_complete': total_folders >= cls._get_expected_folder_count()
        }
    
    @classmethod
    def validate_project_structure(cls, project) -> Dict:
        """
        Validate if a project has the complete standard structure.
        
        Args:
            project: Project instance
            
        Returns:
            dict: Validation result with missing folders
        """
        from edms.models import Folder
        
        existing_folders = set(
            Folder.objects.filter(project=project)
            .values_list('name', 'parent__name')
        )
        
        missing = []
        
        for parent_name, subfolders in STANDARD_PROJECT_STRUCTURE.items():
            # Check parent exists
            if (parent_name, None) not in existing_folders:
                missing.append(parent_name)
            
            # Check subfolders exist
            for subfolder_name in subfolders:
                if (subfolder_name, parent_name) not in existing_folders:
                    missing.append(f"{parent_name}/{subfolder_name}")
        
        return {
            'is_valid': len(missing) == 0,
            'missing_folders': missing,
            'missing_count': len(missing)
        }
    
    # =========================================================================
    # Private Helper Methods
    # =========================================================================
    
    @staticmethod
    def _log_folder_creation(folder, created_by, auto_created=False, trigger='manual'):
        """Log folder creation to audit trail."""
        from edms.models import DocumentAuditLog
        
        try:
            DocumentAuditLog.objects.create(
                actor=created_by,
                actor_role=getattr(created_by, 'role', '') if created_by else '',
                action=DocumentAuditLog.Action.FOLDER_CREATED,
                resource_type='Folder',
                resource_id=folder.id,
                details={
                    'folder_name': folder.name,
                    'project_id': str(folder.project_id),
                    'parent_id': str(folder.parent_id) if folder.parent_id else None,
                    'auto_created': auto_created,
                    'trigger': trigger
                }
            )
        except Exception as e:
            # Don't fail folder creation if audit log fails
            logger.warning(f"Failed to create audit log for folder {folder.name}: {e}")
    
    @staticmethod
    def _invalidate_project_cache(project_id: str):
        """Invalidate all cached folder lookups for a project."""
        # In a more sophisticated setup, use cache versioning or tags
        # For now, we rely on cache timeout
        pass
    
    @staticmethod
    def _get_expected_folder_count() -> int:
        """Calculate total expected folders from structure definition."""
        count = 0
        for parent, subfolders in STANDARD_PROJECT_STRUCTURE.items():
            count += 1 + len(subfolders)
        return count
    
    @classmethod
    def _folder_to_dict(cls, folder, folder_map, all_folders) -> Dict:
        """Convert folder to dict with children."""
        children = [
            cls._folder_to_dict(f, folder_map, all_folders)
            for f in all_folders
            if f.parent_id == folder.id
        ]
        
        return {
            'id': str(folder.id),
            'name': folder.name,
            'path': folder.get_full_path(),
            'children': children,
            'document_count': folder.documents.count() if hasattr(folder, 'documents') else 0
        }



================================================
FILE: backend/finance/__init__.py
================================================
[Empty file]


================================================
FILE: backend/finance/admin.py
================================================
from django.contrib import admin
from .models import (
    FundHead, ProjectFinanceSettings, BudgetLineItem, VariationRequest,
    RABill, RetentionLedger, BOQItem, BOQMilestoneMapping,
    ApprovalRequest, Notification, BOQExecution, ProgressCalculationLog
)


@admin.register(FundHead)
class FundHeadAdmin(admin.ModelAdmin):
    list_display = ['name', 'allocating_authority', 'total_amount', 'balance_available', 'start_date', 'end_date']
    search_fields = ['name', 'allocating_authority']
    list_filter = ['allocating_authority']


@admin.register(ProjectFinanceSettings)
class ProjectFinanceSettingsAdmin(admin.ModelAdmin):
    list_display = ['project', 'enable_auto_retention', 'default_retention_rate', 'last_verified_at']
    list_filter = ['enable_auto_retention']
    search_fields = ['project__name']


@admin.register(BudgetLineItem)
class BudgetLineItemAdmin(admin.ModelAdmin):
    list_display = ['project', 'milestone', 'cost_category', 'amount', 'version', 'is_active']
    list_filter = ['cost_category', 'is_active', 'version']
    search_fields = ['project__name', 'milestone__name']


@admin.register(VariationRequest)
class VariationRequestAdmin(admin.ModelAdmin):
    list_display = ['original_budget', 'requested_amount', 'status', 'created_at']
    list_filter = ['status']


@admin.register(RABill)
class RABillAdmin(admin.ModelAdmin):
    list_display = ['bill_no', 'project', 'contractor', 'gross_amount', 'net_payable', 'status', 'bill_date']
    list_filter = ['status', 'bill_date']
    search_fields = ['bill_no', 'project__name', 'work_order_no']
    date_hierarchy = 'bill_date'


@admin.register(RetentionLedger)
class RetentionLedgerAdmin(admin.ModelAdmin):
    list_display = ['bill', 'amount_held', 'amount_released', 'status', 'release_date']
    list_filter = ['status']


@admin.register(BOQItem)
class BOQItemAdmin(admin.ModelAdmin):
    list_display = ['item_code', 'project', 'description_short', 'uom', 'quantity', 'rate', 'amount', 'status']
    list_filter = ['status', 'project']
    search_fields = ['item_code', 'description', 'project__name']
    readonly_fields = ['amount']
    
    def description_short(self, obj):
        return obj.description[:50] + '...' if len(obj.description) > 50 else obj.description
    description_short.short_description = 'Description'


@admin.register(BOQMilestoneMapping)
class BOQMilestoneMappingAdmin(admin.ModelAdmin):
    list_display = ['boq_item', 'milestone', 'percentage_allocated', 'created_at']
    list_filter = ['boq_item__project']
    search_fields = ['boq_item__item_code', 'milestone__name']


@admin.register(ApprovalRequest)
class ApprovalRequestAdmin(admin.ModelAdmin):
    list_display = ['title', 'request_type', 'project', 'requested_by', 'status', 'created_at']
    list_filter = ['status', 'request_type']
    search_fields = ['title', 'project__name', 'requested_by__username']
    date_hierarchy = 'created_at'


@admin.register(Notification)
class NotificationAdmin(admin.ModelAdmin):
    list_display = ['title', 'user', 'notification_type', 'is_read', 'created_at']
    list_filter = ['notification_type', 'is_read']
    search_fields = ['title', 'message', 'user__username']
    date_hierarchy = 'created_at'


@admin.register(BOQExecution)
class BOQExecutionAdmin(admin.ModelAdmin):
    list_display = [
        'boq_item', 'executed_quantity', 'execution_date', 
        'status', 'created_by', 'verified_by', 'verified_at'
    ]
    list_filter = ['status', 'execution_date', 'boq_item__project']
    search_fields = ['boq_item__item_code', 'boq_item__project__name', 'created_by__username']
    date_hierarchy = 'execution_date'
    readonly_fields = ['verified_at', 'created_at', 'updated_at']
    
    fieldsets = (
        ('Execution Details', {
            'fields': ('boq_item', 'executed_quantity', 'execution_date', 'period_from', 'period_to')
        }),
        ('Status & Verification', {
            'fields': ('status', 'verified_by', 'verified_at', 'remarks')
        }),
        ('Links', {
            'fields': ('ra_bill', 'supporting_documents')
        }),
        ('Audit', {
            'fields': ('created_by', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )


@admin.register(ProgressCalculationLog)
class ProgressCalculationLogAdmin(admin.ModelAdmin):
    list_display = [
        'project', 'physical_progress', 'financial_progress', 
        'earned_value', 'calculated_at', 'triggered_by'
    ]
    list_filter = ['calculated_at', 'project']
    search_fields = ['project__name', 'triggered_by__username']
    date_hierarchy = 'calculated_at'
    readonly_fields = [
        'project', 'physical_progress', 'financial_progress', 'earned_value',
        'total_boq_value', 'total_executed_value', 'boq_items_count',
        'verified_executions_count', 'physical_progress_delta', 
        'financial_progress_delta', 'calculated_at', 'triggered_by'
    ]  # All fields read-only - this is an audit log



================================================
FILE: backend/finance/apps.py
================================================
from django.apps import AppConfig


class FinanceConfig(AppConfig):
    name = 'finance'



================================================
FILE: backend/finance/boq_execution.py
================================================
"""
BOQ Execution Tracking and Progress Calculation Service

This module provides:
1. BOQExecution model - Tracks executed quantities for each BOQ item
2. Progress calculation service - Computes BOQ-weighted physical and financial progress
3. API endpoints for updating and retrieving project progress

Government-Grade Implementation:
- All calculations are traceable and auditable
- Progress values are computed, never manually overridden
- Historical tracking with timestamps and user references
"""
from django.db import models
from django.conf import settings
from django.core.validators import MinValueValidator, MaxValueValidator
from django.utils import timezone
from decimal import Decimal
import uuid
import logging

logger = logging.getLogger(__name__)


class BOQExecution(models.Model):
    """
    Tracks executed/achieved quantities for BOQ items.
    
    Each execution record represents work done on a specific date,
    creating a traceable history of progress. The cumulative executed
    quantity determines physical progress.
    
    Government Standards Compliance:
    - Immutable once verified
    - Requires verification by authorized personnel
    - Links to supporting documents (RA Bills, site photos, etc.)
    """
    
    class VerificationStatus(models.TextChoices):
        DRAFT = 'DRAFT', 'Draft'
        SUBMITTED = 'SUBMITTED', 'Submitted for Verification'
        VERIFIED = 'VERIFIED', 'Verified by Authority'
        REJECTED = 'REJECTED', 'Rejected'
        REVISED = 'REVISED', 'Revision Required'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    boq_item = models.ForeignKey(
        'BOQItem',
        on_delete=models.CASCADE,
        related_name='executions',
        help_text='Reference to the BOQ item being executed'
    )
    
    # Execution details
    executed_quantity = models.DecimalField(
        max_digits=15,
        decimal_places=4,
        validators=[MinValueValidator(Decimal('0'))],
        help_text='Quantity executed/achieved in this entry'
    )
    
    execution_date = models.DateField(
        help_text='Date when this work was executed'
    )
    
    # Period tracking (for RA Bill correlation)
    period_from = models.DateField(
        null=True,
        blank=True,
        help_text='Start of execution period'
    )
    period_to = models.DateField(
        null=True,
        blank=True,
        help_text='End of execution period'
    )
    
    # Financial link
    ra_bill = models.ForeignKey(
        'RABill',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='boq_executions',
        help_text='Linked RA Bill for payment tracking'
    )
    
    # Verification workflow
    status = models.CharField(
        max_length=20,
        choices=VerificationStatus.choices,
        default=VerificationStatus.DRAFT
    )
    
    remarks = models.TextField(
        blank=True,
        help_text='Execution remarks or notes'
    )
    
    # Evidence/Supporting documents (stored as JSON array of EDMS doc IDs)
    supporting_documents = models.JSONField(
        default=list,
        blank=True,
        help_text='List of EDMS document IDs as evidence'
    )
    
    # Audit trail
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='created_boq_executions'
    )
    verified_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='verified_boq_executions'
    )
    verified_at = models.DateTimeField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-execution_date', '-created_at']
        indexes = [
            models.Index(fields=['boq_item', 'execution_date']),
            models.Index(fields=['status']),
        ]
    
    def __str__(self):
        return f"{self.boq_item.item_code} - {self.executed_quantity} on {self.execution_date}"
    
    @property
    def execution_value(self):
        """Calculate the earned value for this execution entry."""
        return self.executed_quantity * self.boq_item.rate
    
    def verify(self, user):
        """Mark execution as verified by an authorized user."""
        self.status = self.VerificationStatus.VERIFIED
        self.verified_by = user
        self.verified_at = timezone.now()
        self.save()


class ProgressCalculationLog(models.Model):
    """
    Audit log for all progress calculations.
    
    Every time project progress is calculated, a log entry is created
    for audit trail and debugging purposes.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    project = models.ForeignKey(
        'projects.Project',
        on_delete=models.CASCADE,
        related_name='progress_logs'
    )
    
    # Calculated values
    physical_progress = models.FloatField()
    financial_progress = models.FloatField()
    earned_value = models.DecimalField(max_digits=15, decimal_places=2)
    
    # Calculation metadata
    total_boq_value = models.DecimalField(max_digits=15, decimal_places=2)
    total_executed_value = models.DecimalField(max_digits=15, decimal_places=2)
    boq_items_count = models.IntegerField()
    verified_executions_count = models.IntegerField()
    
    # Variance from previous calculation
    physical_progress_delta = models.FloatField(default=0.0)
    financial_progress_delta = models.FloatField(default=0.0)
    
    calculated_at = models.DateTimeField(auto_now_add=True)
    triggered_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True
    )
    
    class Meta:
        ordering = ['-calculated_at']
        get_latest_by = 'calculated_at'
    
    def __str__(self):
        return f"{self.project.name} - {self.physical_progress}% @ {self.calculated_at}"



================================================
FILE: backend/finance/evm_service.py
================================================
"""
Earned Value Management (EVM) Service

Implements PTAG Standard EVM Metrics:
- Primary: BAC, PV, AC, EV
- Variances: CV, SV, VAC (Cost, Schedule, At Completion)
- Indices: CPI, SPI
- Forecasts: EAC (typical/atypical), ETC

Government-Grade Implementation:
- Historical snapshots for S-Curve generation
- Fully computed from BOQ/Execution data - no manual override
- Weekly/monthly history for trend analysis
"""
from django.db import models
from django.db.models import Sum, F
from django.utils import timezone
from django.conf import settings
from decimal import Decimal
from datetime import date, timedelta
import uuid
import logging

logger = logging.getLogger(__name__)


class ProjectEVMHistory(models.Model):
    """
    Historical snapshots of EVM metrics for S-Curve charts.
    
    Created weekly or on-demand to enable trend visualization.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    project = models.ForeignKey(
        'projects.Project',
        on_delete=models.CASCADE,
        related_name='evm_history'
    )
    
    snapshot_date = models.DateField(help_text='Date of this snapshot')
    
    # Primary Data Points
    bac = models.DecimalField(max_digits=15, decimal_places=2, help_text='Budget At Completion')
    pv = models.DecimalField(max_digits=15, decimal_places=2, help_text='Planned Value')
    ac = models.DecimalField(max_digits=15, decimal_places=2, help_text='Actual Cost')
    ev = models.DecimalField(max_digits=15, decimal_places=2, help_text='Earned Value')
    
    # Variances
    cv = models.DecimalField(max_digits=15, decimal_places=2, help_text='Cost Variance (EV-AC)')
    sv = models.DecimalField(max_digits=15, decimal_places=2, help_text='Schedule Variance (EV-PV)')
    
    # Performance Indices
    cpi = models.FloatField(help_text='Cost Performance Index (EV/AC)')
    spi = models.FloatField(help_text='Schedule Performance Index (EV/PV)')
    
    # Forecasts
    eac = models.DecimalField(max_digits=15, decimal_places=2, help_text='Estimate At Completion')
    etc = models.DecimalField(max_digits=15, decimal_places=2, help_text='Estimate To Complete')
    vac = models.DecimalField(max_digits=15, decimal_places=2, help_text='Variance At Completion')
    
    # Progress percentages
    planned_percent = models.FloatField(help_text='Planned % complete at snapshot date')
    actual_percent = models.FloatField(help_text='Actual % complete at snapshot date')
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['snapshot_date']
        unique_together = ['project', 'snapshot_date']
        indexes = [
            models.Index(fields=['project', 'snapshot_date']),
        ]
    
    def __str__(self):
        return f"{self.project.name} EVM @ {self.snapshot_date}"


class EVMCalculationService:
    """
    Calculates all EVM metrics for a project based on BOQ and execution data.
    
    Data Sources:
    - BAC: Project.budget (sanctioned budget)
    - PV: Time-weighted BOQ value based on schedule
    - AC: RABill net_payable (actual payments)
    - EV: BOQExecution verified value (from progress calculation)
    """
    
    def __init__(self, project):
        self.project = project
        self.today = timezone.now().date()
    
    def calculate_all_metrics(self) -> dict:
        """Calculate all EVM metrics for current date."""
        from finance.models import BOQItem, RABill
        from finance.boq_execution import BOQExecution
        from scheduling.models import ScheduleTask
        
        # BAC = Total sanctioned budget
        bac = self.project.budget or Decimal('0')
        
        # Get project timeline
        start_date = self.project.start_date or self.today
        end_date = self.project.end_date or (self.today + timedelta(days=365))
        total_duration = max((end_date - start_date).days, 1)
        elapsed_days = max((self.today - start_date).days, 0)
        
        # Planned % complete (time-based baseline)
        planned_percent = min((elapsed_days / total_duration) * 100, 100)
        
        # PV = BAC Ã— (% Planned)
        # More accurate: Sum of BOQ values for tasks that should be complete by now
        pv = self._calculate_planned_value(bac, planned_percent)
        
        # AC = Sum of actual costs (RA Bills paid/approved)
        ac = RABill.objects.filter(
            project=self.project,
            status__in=['APPROVED', 'PAID', 'VERIFIED']
        ).aggregate(total=Sum('net_payable'))['total'] or Decimal('0')
        
        # EV = From verified BOQ executions (already calculated in progress service)
        ev = self.project.earned_value or Decimal('0')
        
        # Actual % complete
        actual_percent = self.project.physical_progress or 0.0
        
        # Calculate variances
        cv = ev - ac  # Cost Variance
        sv = ev - pv  # Schedule Variance
        
        # Performance Indices (avoid division by zero)
        cpi = float(ev / ac) if ac > 0 else 1.0
        spi = float(ev / pv) if pv > 0 else 1.0
        
        # Forecasts
        # EAC (typical) = AC + ((BAC - EV) / CPI)
        if cpi > 0:
            eac_typical = ac + ((bac - ev) / Decimal(str(cpi)))
        else:
            eac_typical = bac
        
        # EAC (atypical) = AC + (BAC - EV)
        eac_atypical = ac + (bac - ev)
        
        # Use typical EAC as default
        eac = eac_typical
        
        # ETC = EAC - AC
        etc = eac - ac
        
        # VAC = BAC - EAC
        vac = bac - eac
        
        # Variance percentages
        cv_percent = float((cv / ev) * 100) if ev > 0 else 0.0
        sv_percent = float((sv / pv) * 100) if pv > 0 else 0.0
        
        return {
            'project_id': str(self.project.id),
            'project_name': self.project.name,
            'snapshot_date': self.today.isoformat(),
            
            # Primary metrics
            'bac': float(bac),
            'pv': float(pv),
            'ac': float(ac),
            'ev': float(ev),
            
            # Progress
            'planned_percent': round(planned_percent, 2),
            'actual_percent': round(actual_percent, 2),
            
            # Variances
            'cv': float(cv),
            'sv': float(sv),
            'cv_percent': round(cv_percent, 2),
            'sv_percent': round(sv_percent, 2),
            
            # Indices
            'cpi': round(cpi, 3),
            'spi': round(spi, 3),
            
            # Forecasts
            'eac': float(eac),
            'eac_typical': float(eac_typical),
            'eac_atypical': float(eac_atypical),
            'etc': float(etc),
            'vac': float(vac),
            
            # Status
            'cost_status': 'under_budget' if cpi >= 1.0 else 'over_budget',
            'schedule_status': 'ahead' if spi >= 1.0 else 'behind',
            'overall_status': 'on_track' if (cpi >= 0.95 and spi >= 0.95) else 'at_risk'
        }
    
    def _calculate_planned_value(self, bac, planned_percent):
        """
        Calculate Planned Value based on schedule.
        
        For more accuracy, this should sum BOQ values for milestones
        that should be complete by now. Simplified version uses
        linear interpolation.
        """
        from scheduling.models import ScheduleTask
        from finance.models import BOQMilestoneMapping
        
        # Try to get PV from milestone-based calculation
        try:
            completed_milestones = ScheduleTask.objects.filter(
                project=self.project,
                is_milestone=True,
                planned_end__lte=self.today
            )
            
            # Get BOQ value for these milestones
            pv_from_milestones = BOQMilestoneMapping.objects.filter(
                milestone__in=completed_milestones
            ).aggregate(
                total=Sum(F('boq_item__amount') * F('percentage_allocated') / 100)
            )['total']
            
            if pv_from_milestones:
                return Decimal(str(pv_from_milestones))
        except Exception:
            pass
        
        # Fallback: Linear interpolation
        return bac * Decimal(str(planned_percent / 100))
    
    def create_snapshot(self) -> ProjectEVMHistory:
        """Create a historical snapshot of current EVM metrics."""
        metrics = self.calculate_all_metrics()
        
        snapshot, created = ProjectEVMHistory.objects.update_or_create(
            project=self.project,
            snapshot_date=self.today,
            defaults={
                'bac': Decimal(str(metrics['bac'])),
                'pv': Decimal(str(metrics['pv'])),
                'ac': Decimal(str(metrics['ac'])),
                'ev': Decimal(str(metrics['ev'])),
                'cv': Decimal(str(metrics['cv'])),
                'sv': Decimal(str(metrics['sv'])),
                'cpi': metrics['cpi'],
                'spi': metrics['spi'],
                'eac': Decimal(str(metrics['eac'])),
                'etc': Decimal(str(metrics['etc'])),
                'vac': Decimal(str(metrics['vac'])),
                'planned_percent': metrics['planned_percent'],
                'actual_percent': metrics['actual_percent'],
            }
        )
        
        logger.info(f"EVM snapshot {'created' if created else 'updated'} for {self.project.name}")
        return snapshot
    
    def get_s_curve_data(self, start_date=None, end_date=None) -> list:
        """
        Get time-series data for S-Curve chart.
        
        Returns list of [{date, pv, ev, ac, bac}, ...] for charting.
        """
        # Get historical snapshots
        queryset = ProjectEVMHistory.objects.filter(project=self.project)
        
        if start_date:
            queryset = queryset.filter(snapshot_date__gte=start_date)
        if end_date:
            queryset = queryset.filter(snapshot_date__lte=end_date)
        
        snapshots = queryset.order_by('snapshot_date')
        
        # If no historical data, generate projected curve
        if not snapshots.exists():
            return self._generate_projected_curve()
        
        # Format for chart
        data = []
        for snap in snapshots:
            data.append({
                'date': snap.snapshot_date.isoformat(),
                'label': snap.snapshot_date.strftime('%b %d'),
                'pv': float(snap.pv),
                'ev': float(snap.ev),
                'ac': float(snap.ac),
                'bac': float(snap.bac),
                'planned_percent': snap.planned_percent,
                'actual_percent': snap.actual_percent,
            })
        
        # Add current metrics as latest point
        current = self.calculate_all_metrics()
        if not data or data[-1]['date'] != self.today.isoformat():
            data.append({
                'date': self.today.isoformat(),
                'label': self.today.strftime('%b %d'),
                'pv': current['pv'],
                'ev': current['ev'],
                'ac': current['ac'],
                'bac': current['bac'],
                'planned_percent': current['planned_percent'],
                'actual_percent': current['actual_percent'],
            })
        
        return data
    
    def _generate_projected_curve(self) -> list:
        """Generate projected S-curve when no historical data exists."""
        from scheduling.models import ScheduleTask
        
        bac = float(self.project.budget or 0)
        start = self.project.start_date or self.today
        end = self.project.end_date or (self.today + timedelta(days=365))
        
        # Generate monthly data points
        data = []
        current = start
        
        while current <= end:
            # Calculate planned % at this date (S-curve approximation)
            total_days = (end - start).days or 1
            elapsed = (current - start).days
            linear_percent = (elapsed / total_days) * 100
            
            # S-curve formula (slow start, fast middle, slow end)
            # Using logistic function approximation
            x = (elapsed / total_days - 0.5) * 10
            s_curve_percent = 100 / (1 + 2.71828 ** (-x))
            
            pv = bac * (s_curve_percent / 100)
            
            # For past dates, use actual EV/AC if available
            if current <= self.today:
                ev = float(self.project.earned_value or 0) * (elapsed / max((self.today - start).days, 1))
                ac = ev * 1.02  # Slight cost overrun assumption
            else:
                ev = 0
                ac = 0
            
            data.append({
                'date': current.isoformat(),
                'label': current.strftime('%b %Y'),
                'pv': round(pv, 2),
                'ev': round(ev, 2),
                'ac': round(ac, 2),
                'bac': bac,
                'planned_percent': round(s_curve_percent, 2),
                'actual_percent': round((ev / bac) * 100 if bac > 0 else 0, 2),
            })
            
            # Next month
            current = current + timedelta(days=30)
        
        return data


def create_evm_snapshots_for_all_projects():
    """
    Scheduled job to create weekly EVM snapshots.
    
    Call this from a cron job or Django management command.
    """
    from projects.models import Project
    
    active_projects = Project.objects.filter(
        status__in=['In Progress', 'Planning', 'Under Review']
    )
    
    results = []
    for project in active_projects:
        try:
            service = EVMCalculationService(project)
            snapshot = service.create_snapshot()
            results.append({
                'project': project.name,
                'success': True,
                'snapshot_id': str(snapshot.id)
            })
        except Exception as e:
            logger.exception(f"Failed to create EVM snapshot for {project.name}")
            results.append({
                'project': project.name,
                'success': False,
                'error': str(e)
            })
    
    return results



================================================
FILE: backend/finance/models.py
================================================
from django.db import models
from django.core.exceptions import ValidationError
from django.utils.translation import gettext_lazy as _
from django.utils import timezone
import uuid

class FundHead(models.Model):
    """
    Tracks the source of funds (e.g., Grants, Loans, Budget Allocations).
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    name = models.CharField(max_length=255, help_text="e.g. World Bank Loan, State Budget")
    allocating_authority = models.CharField(max_length=255, help_text="e.g. Dept of Finance", default="Government")
    total_amount = models.DecimalField(max_digits=15, decimal_places=2)
    balance_available = models.DecimalField(max_digits=15, decimal_places=2, blank=True)
    start_date = models.DateField(default=timezone.now)
    end_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def save(self, *args, **kwargs):
        if self.balance_available is None:
            self.balance_available = self.total_amount
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.name} (â‚¹{self.balance_available})"

class ProjectFinanceSettings(models.Model):
    """
    Governance settings per project.
    """
    project = models.OneToOneField('projects.Project', on_delete=models.CASCADE, related_name='finance_settings')
    enable_auto_retention = models.BooleanField(default=True, help_text="Auto-calculate 5% retention on bills")
    default_retention_rate = models.DecimalField(max_digits=5, decimal_places=2, default=5.00)
    last_verified_at = models.DateTimeField(null=True, blank=True, help_text="For 30-Day Budget Pulse")

    def __str__(self):
        return f"Finance Settings: {self.project.name}"

class BudgetLineItem(models.Model):
    """
    Planned Cost tied strictly to a Milestone (Time).
    """
    class CostCategory(models.TextChoices):
        MATERIAL = 'MATERIAL', _('Material')
        LABOUR = 'LABOUR', _('Labour')
        MACHINERY = 'MACHINERY', _('Machinery')
        OVERHEAD = 'OVERHEAD', _('Overhead')
        PROFESSIONAL = 'PROFESSIONAL', _('Professional Fees')
        OTHER = 'OTHER', _('Other')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    project = models.ForeignKey('projects.Project', on_delete=models.CASCADE, related_name='budget_items')
    # Strict Linkage: Budget must have a milestone (No Money Without Time)
    milestone = models.ForeignKey('scheduling.ScheduleTask', on_delete=models.CASCADE, related_name='budget_allocations')
    fund_head = models.ForeignKey(FundHead, on_delete=models.CASCADE, related_name='allocations', null=True, blank=True)
    
    cost_category = models.CharField(max_length=50, choices=CostCategory.choices)
    amount = models.DecimalField(max_digits=12, decimal_places=2)
    
    version = models.IntegerField(default=1)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.project.name} - {self.milestone.name}: {self.amount}"

class VariationRequest(models.Model):
    """
    Track changes to sanctioned budget.
    """
    class Status(models.TextChoices):
        PENDING = 'PENDING', _('Pending')
        APPROVED = 'APPROVED', _('Approved')
        REJECTED = 'REJECTED', _('Rejected')

    original_budget = models.ForeignKey(BudgetLineItem, on_delete=models.CASCADE, related_name='variations')
    requested_amount = models.DecimalField(max_digits=12, decimal_places=2)
    reason = models.TextField()
    status = models.CharField(max_length=20, choices=Status.choices, default=Status.PENDING)
    created_at = models.DateTimeField(auto_now_add=True)

class RABill(models.Model):
    """
    Running Account Bill - Digital Replica of Govt Excel Format.
    """
    class BillStatus(models.TextChoices):
        DRAFT = 'DRAFT', _('Draft')
        SUBMITTED = 'SUBMITTED', _('Submitted')
        VERIFIED = 'VERIFIED', _('Verified')
        APPROVED = 'APPROVED', _('Approved')
        PAID = 'PAID', _('Paid')

    class TDSType(models.TextChoices):
        C194_INDIVIDUAL = '194C_IND', _('194C - Individual/HUF')
        C194_OTHER = '194C_OTH', _('194C - Others')
        J194 = '194J', _('194J - Professional')
        NONE = 'NONE', _('None')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    project = models.ForeignKey('projects.Project', on_delete=models.CASCADE, related_name='ra_bills')
    contractor = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True, related_name='submitted_bills')
    
    # Must link to a specific milestone for Physical Progress Validation
    milestone = models.ForeignKey('scheduling.ScheduleTask', on_delete=models.SET_NULL, null=True, related_name='ra_bills')

    # Headers
    bill_no = models.CharField(max_length=50)
    work_order_no = models.CharField(max_length=100)
    bill_date = models.DateField()
    period_from = models.DateField(null=True, blank=True)
    period_to = models.DateField(null=True, blank=True)

    # Base Financials
    gross_amount = models.DecimalField(max_digits=15, decimal_places=2, help_text="Amount before GST")
    gst_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=18.00)
    gst_amount = models.DecimalField(max_digits=15, decimal_places=2)
    total_amount = models.DecimalField(max_digits=15, decimal_places=2, help_text="Gross + GST")

    # Statutory Deductions
    tds_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=0.00)
    tds_amount = models.DecimalField(max_digits=15, decimal_places=2, default=0.00)
    tds_section_type = models.CharField(max_length=20, choices=TDSType.choices, default=TDSType.NONE)

    labour_cess_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=1.00)
    labour_cess_amount = models.DecimalField(max_digits=15, decimal_places=2, default=0.00)

    # Retention / Security
    retention_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=0.00)
    retention_amount = models.DecimalField(max_digits=15, decimal_places=2, default=0.00)

    # Recoveries
    mobilization_advance_recovery = models.DecimalField(max_digits=15, decimal_places=2, default=0.00)
    material_advance_recovery = models.DecimalField(max_digits=15, decimal_places=2, default=0.00)
    plant_machinery_recovery = models.DecimalField(max_digits=15, decimal_places=2, default=0.00)

    # Other Actions
    penalty_amount = models.DecimalField(max_digits=15, decimal_places=2, default=0.00)
    other_deductions = models.DecimalField(max_digits=15, decimal_places=2, default=0.00)
    other_deduction_remarks = models.CharField(max_length=255, blank=True)

    # Final
    net_payable = models.DecimalField(max_digits=15, decimal_places=2)
    
    status = models.CharField(max_length=20, choices=BillStatus.choices, default=BillStatus.DRAFT)
    
    # PDF File Storage - saved to project-specific folder
    bill_pdf_file = models.FileField(
        upload_to='projects/ra_bills/',
        null=True,
        blank=True,
        help_text="Generated PDF bill saved to media/projects/{project_id}/ra_bills/"
    )
    
    metadata = models.JSONField(default=dict, blank=True, help_text="Store override flags or extra sync data")

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"RA Bill #{self.bill_no} - {self.net_payable}"

class RetentionLedger(models.Model):
    """
    Tracks retention money held per bill.
    """
    class Status(models.TextChoices):
        HELD = 'HELD', _('Held')
        RELEASED = 'RELEASED', _('Released')

    bill = models.OneToOneField(RABill, on_delete=models.CASCADE, related_name='retention_ledger')
    amount_held = models.DecimalField(max_digits=15, decimal_places=2)
    amount_released = models.DecimalField(max_digits=15, decimal_places=2, default=0.00)
    status = models.CharField(max_length=20, choices=Status.choices, default=Status.HELD)
    
    release_date = models.DateField(null=True, blank=True)

class BOQItem(models.Model):
    """
    Contract Baseline: The Sanctioned Bill of Quantities.
    Immutable once 'FROZEN'.
    """
    class Status(models.TextChoices):
        DRAFT = 'DRAFT', _('Draft')
        FROZEN = 'FROZEN', _('Frozen (Immutable)')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    project = models.ForeignKey('projects.Project', on_delete=models.CASCADE, related_name='boq_items')
    
    item_code = models.CharField(max_length=50, help_text="e.g. 2.1.1")
    description = models.TextField()
    uom = models.CharField(max_length=20, help_text="Unit of Measurement")
    
    quantity = models.DecimalField(max_digits=15, decimal_places=4)
    rate = models.DecimalField(max_digits=15, decimal_places=2)
    amount = models.DecimalField(max_digits=15, decimal_places=2, help_text="Qty * Rate")
    
    status = models.CharField(max_length=20, choices=Status.choices, default=Status.DRAFT)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        # Prevent duplicates of item code per project
        unique_together = ['project', 'item_code']
        ordering = ['item_code']

    def save(self, *args, **kwargs):
        # Auto-calculate amount
        self.amount = self.quantity * self.rate
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.item_code} - {self.description[:50]}..."

class BOQMilestoneMapping(models.Model):
    """
    Budgeting Link: Money (BOQ) <-> Time (Schedule).
    Allows mapping a percentage of a BOQ Item to a specific Milestone.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    boq_item = models.ForeignKey(BOQItem, on_delete=models.CASCADE, related_name='milestone_mappings')
    milestone = models.ForeignKey('scheduling.ScheduleTask', on_delete=models.CASCADE, related_name='boq_mappings')
    
    percentage_allocated = models.DecimalField(
        max_digits=5, decimal_places=2, 
        help_text="How much of this BOQ item is consumed by this milestone?"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        # A BOQ item can be mapped to multiple milestones, but not the same one twice
        unique_together = ['boq_item', 'milestone']

    def __str__(self):
        return f"{self.boq_item.item_code} -> {self.milestone.name} ({self.percentage_allocated}%)"


class ApprovalRequest(models.Model):
    """
    Generic approval request for various entity types (BOQ Freeze, Budget Change, etc.)
    """
    class RequestType(models.TextChoices):
        BOQ_FREEZE = 'BOQ_FREEZE', _('BOQ Freeze Request')
        BOQ_UNFREEZE = 'BOQ_UNFREEZE', _('BOQ Unfreeze Request')
        BUDGET_CHANGE = 'BUDGET_CHANGE', _('Budget Change Request')
        VARIATION = 'VARIATION', _('Variation Request')

    class Status(models.TextChoices):
        PENDING = 'PENDING', _('Pending')
        APPROVED = 'APPROVED', _('Approved')
        REJECTED = 'REJECTED', _('Rejected')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    request_type = models.CharField(max_length=50, choices=RequestType.choices)
    
    # Generic reference to related items (stored as JSON array of IDs)
    entity_ids = models.JSONField(default=list, help_text="List of entity UUIDs this request affects")
    entity_type = models.CharField(max_length=50, help_text="e.g., 'BOQItem', 'BudgetLineItem'")
    
    project = models.ForeignKey('projects.Project', on_delete=models.CASCADE, related_name='approval_requests')
    requested_by = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True, related_name='submitted_requests')
    
    title = models.CharField(max_length=255)
    description = models.TextField(blank=True)
    
    status = models.CharField(max_length=20, choices=Status.choices, default=Status.PENDING)
    
    reviewed_by = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True, blank=True, related_name='reviewed_requests')
    reviewed_at = models.DateTimeField(null=True, blank=True)
    review_notes = models.TextField(blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.get_request_type_display()} - {self.status}"


class Notification(models.Model):
    """
    System notifications for users.
    """
    class NotificationType(models.TextChoices):
        APPROVAL_REQUEST = 'APPROVAL_REQUEST', _('New Approval Request')
        APPROVAL_RESULT = 'APPROVAL_RESULT', _('Approval Result')
        SYSTEM = 'SYSTEM', _('System Notification')
        INFO = 'INFO', _('Information')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    user = models.ForeignKey('users.User', on_delete=models.CASCADE, related_name='finance_notifications')
    
    notification_type = models.CharField(max_length=50, choices=NotificationType.choices, default=NotificationType.INFO)
    title = models.CharField(max_length=255)
    message = models.TextField()
    
    # Optional link to related entity
    related_url = models.CharField(max_length=500, blank=True, help_text="URL to navigate to when clicked")
    related_request = models.ForeignKey(ApprovalRequest, on_delete=models.SET_NULL, null=True, blank=True)
    
    is_read = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.title} - {'Read' if self.is_read else 'Unread'}"


# Import BOQ Execution models to make them accessible via finance.models
from .boq_execution import BOQExecution, ProgressCalculationLog

# Import EVM models
from .evm_service import ProjectEVMHistory



================================================
FILE: backend/finance/progress_service.py
================================================
"""
Project Progress Calculation Service

Government-Grade Implementation for:
1. BOQ-Weighted Physical Progress - Based on executed vs. sanctioned quantities
2. Financial Progress - Earned Value vs. Budget
3. Schedule Variance - Planned vs. Actual

Key Principles:
- No manual override of computed values
- All calculations are traceable
- Progress = f(verified executions only)
"""
from django.db import transaction
from django.db.models import Sum, F
from django.utils import timezone
from decimal import Decimal
import logging

logger = logging.getLogger(__name__)


class ProgressCalculationService:
    """
    Service class for computing project progress metrics.
    
    Calculation Methodology:
    1. Physical Progress = (Sum of Executed Value) / (Total BOQ Value) * 100
       - Executed Value = Executed Qty * Rate for each BOQ item
       - Only VERIFIED executions are counted
       
    2. Financial Progress = (Earned Value) / (Budget) * 100
       - Earned Value = Total Executed Value (same as numerator in physical)
       
    3. Schedule Variance = ((Actual Progress - Planned Progress) / Planned Progress) * 100
       - Planned Progress is based on scheduled milestones
    """
    
    def __init__(self, project):
        self.project = project
        self.calculation_date = timezone.now()
    
    @transaction.atomic
    def calculate_and_update(self, triggered_by=None):
        """
        Calculate all progress metrics and update the project.
        
        This is the main entry point called:
        - After BOQ execution verification
        - After RA Bill approval
        - Via scheduled daily job
        - On-demand from admin panel
        
        Returns:
            dict: Calculation results with metadata
        """
        from finance.models import BOQItem
        from finance.boq_execution import BOQExecution, ProgressCalculationLog
        
        # Get all frozen BOQ items for this project
        boq_items = BOQItem.objects.filter(
            project=self.project,
            status=BOQItem.Status.FROZEN
        )
        
        # Calculate total sanctioned BOQ value
        total_boq_value = boq_items.aggregate(
            total=Sum('amount')
        )['total'] or Decimal('0')
        
        # Get all verified executions
        verified_executions = BOQExecution.objects.filter(
            boq_item__project=self.project,
            status=BOQExecution.VerificationStatus.VERIFIED
        )
        
        # Calculate total executed value (EV)
        # Using annotation for efficiency
        executed_value_per_item = verified_executions.values(
            'boq_item'
        ).annotate(
            item_executed_value=Sum(
                F('executed_quantity') * F('boq_item__rate')
            )
        )
        
        total_executed_value = sum(
            item['item_executed_value'] or Decimal('0')
            for item in executed_value_per_item
        )
        
        # Calculate physical progress
        if total_boq_value > 0:
            physical_progress = float(
                (Decimal(total_executed_value) / total_boq_value) * 100
            )
        else:
            physical_progress = 0.0
        
        # Cap at 100%
        physical_progress = min(physical_progress, 100.0)
        
        # Calculate financial progress (EV / Budget)
        budget = self.project.budget or Decimal('0')
        if budget > 0:
            financial_progress = float(
                (Decimal(total_executed_value) / budget) * 100
            )
        else:
            financial_progress = 0.0
        
        financial_progress = min(financial_progress, 100.0)
        
        # Get previous values for delta calculation
        prev_physical = self.project.physical_progress or 0.0
        prev_financial = self.project.financial_progress or 0.0
        
        # Update project
        self.project.physical_progress = round(physical_progress, 2)
        self.project.financial_progress = round(financial_progress, 2)
        self.project.earned_value = total_executed_value
        self.project.progress = round(physical_progress, 2)  # Legacy field sync
        self.project.save(update_fields=[
            'physical_progress',
            'financial_progress',
            'earned_value',
            'progress',
            'updated_at'
        ])
        
        # Create audit log
        log = ProgressCalculationLog.objects.create(
            project=self.project,
            physical_progress=physical_progress,
            financial_progress=financial_progress,
            earned_value=total_executed_value,
            total_boq_value=total_boq_value,
            total_executed_value=total_executed_value,
            boq_items_count=boq_items.count(),
            verified_executions_count=verified_executions.count(),
            physical_progress_delta=physical_progress - prev_physical,
            financial_progress_delta=financial_progress - prev_financial,
            triggered_by=triggered_by
        )
        
        logger.info(
            f"Progress calculated for {self.project.name}: "
            f"Physical={physical_progress:.2f}%, Financial={financial_progress:.2f}%"
        )
        
        return {
            'physical_progress': physical_progress,
            'financial_progress': financial_progress,
            'earned_value': float(total_executed_value),
            'total_boq_value': float(total_boq_value),
            'boq_items_count': boq_items.count(),
            'verified_executions_count': verified_executions.count(),
            'calculation_id': str(log.id),
            'calculated_at': self.calculation_date.isoformat()
        }
    
    def get_boq_progress_breakdown(self):
        """
        Get detailed progress for each BOQ item.
        
        Returns:
            list: BOQ items with their individual progress
        """
        from finance.models import BOQItem
        from finance.boq_execution import BOQExecution
        
        boq_items = BOQItem.objects.filter(
            project=self.project,
            status=BOQItem.Status.FROZEN
        ).select_related('project')
        
        result = []
        for item in boq_items:
            # Get total verified execution for this item
            executed = BOQExecution.objects.filter(
                boq_item=item,
                status=BOQExecution.VerificationStatus.VERIFIED
            ).aggregate(
                total_qty=Sum('executed_quantity')
            )['total_qty'] or Decimal('0')
            
            # Calculate item progress
            if item.quantity > 0:
                item_progress = float((executed / item.quantity) * 100)
            else:
                item_progress = 0.0
            
            executed_value = executed * item.rate
            
            result.append({
                'id': str(item.id),
                'item_code': item.item_code,
                'description': item.description[:100],
                'uom': item.uom,
                'sanctioned_qty': float(item.quantity),
                'executed_qty': float(executed),
                'remaining_qty': float(item.quantity - executed),
                'progress_percent': round(item_progress, 2),
                'rate': float(item.rate),
                'sanctioned_value': float(item.amount),
                'executed_value': float(executed_value),
                'status': 'On Track' if item_progress >= 50 else 'Behind'
            })
        
        return result
    
    def calculate_schedule_variance(self):
        """
        Calculate schedule variance based on milestone completion.
        
        Schedule Variance (SV) = EV - PV
        Schedule Performance Index (SPI) = EV / PV
        
        Returns:
            dict: Schedule variance metrics
        """
        from scheduling.models import ScheduleTask
        
        today = timezone.now().date()
        
        # Get all milestones for this project
        milestones = ScheduleTask.objects.filter(
            project=self.project,
            is_milestone=True
        )
        
        total_milestones = milestones.count()
        if total_milestones == 0:
            return {
                'schedule_variance_percent': 0.0,
                'schedule_performance_index': 1.0,
                'status': 'No milestones defined'
            }
        
        # Milestones that should be complete by now (planned)
        planned_complete = milestones.filter(
            planned_end__lte=today
        ).count()
        
        # Milestones actually complete
        actual_complete = milestones.filter(
            status='Completed'
        ).count()
        
        # Calculate planned value % (what should be done)
        if total_milestones > 0:
            planned_progress = (planned_complete / total_milestones) * 100
            actual_progress = (actual_complete / total_milestones) * 100
        else:
            planned_progress = 0
            actual_progress = 0
        
        # Schedule variance percentage
        if planned_progress > 0:
            sv_percent = ((actual_progress - planned_progress) / planned_progress) * 100
            spi = actual_progress / planned_progress
        else:
            sv_percent = 0.0
            spi = 1.0
        
        # Determine status
        if sv_percent >= 0:
            status = 'Ahead of Schedule' if sv_percent > 5 else 'On Schedule'
        elif sv_percent >= -10:
            status = 'Slightly Behind'
        else:
            status = 'Behind Schedule'
        
        # Update project schedule variance
        self.project.schedule_variance = round(sv_percent, 2)
        self.project.save(update_fields=['schedule_variance', 'updated_at'])
        
        return {
            'planned_progress': round(planned_progress, 2),
            'actual_progress': round(actual_progress, 2),
            'schedule_variance_percent': round(sv_percent, 2),
            'schedule_performance_index': round(spi, 2),
            'total_milestones': total_milestones,
            'planned_complete': planned_complete,
            'actual_complete': actual_complete,
            'status': status
        }


def recalculate_project_progress(project_id, triggered_by=None):
    """
    Utility function to recalculate progress for a specific project.
    
    Usage:
        from finance.progress_service import recalculate_project_progress
        result = recalculate_project_progress(project_id, request.user)
    """
    from projects.models import Project
    
    try:
        project = Project.objects.get(id=project_id)
        service = ProgressCalculationService(project)
        return service.calculate_and_update(triggered_by)
    except Project.DoesNotExist:
        logger.error(f"Project {project_id} not found for progress calculation")
        return None


def recalculate_all_projects(triggered_by=None):
    """
    Batch recalculate progress for all active projects.
    
    Called by scheduled job (e.g., daily at midnight).
    """
    from projects.models import Project
    
    active_projects = Project.objects.filter(
        status__in=['In Progress', 'Planning', 'Under Review']
    )
    
    results = []
    for project in active_projects:
        try:
            service = ProgressCalculationService(project)
            result = service.calculate_and_update(triggered_by)
            results.append({
                'project_id': str(project.id),
                'project_name': project.name,
                'success': True,
                'result': result
            })
        except Exception as e:
            logger.exception(f"Failed to calculate progress for {project.name}")
            results.append({
                'project_id': str(project.id),
                'project_name': project.name,
                'success': False,
                'error': str(e)
            })
    
    return results



================================================
FILE: backend/finance/serializers.py
================================================
from rest_framework import serializers
from .models import (
    FundHead, BudgetLineItem, RABill, RetentionLedger, ProjectFinanceSettings, 
    VariationRequest, BOQItem, BOQMilestoneMapping, ApprovalRequest, Notification,
    BOQExecution, ProgressCalculationLog
)
from scheduling.models import ScheduleTask

class BOQItemSerializer(serializers.ModelSerializer):
    class Meta:
        model = BOQItem
        fields = '__all__'
        read_only_fields = ['amount', 'created_at', 'updated_at']


class BOQExecutionSerializer(serializers.ModelSerializer):
    """Serializer for BOQ Execution entries with full audit trail."""
    boq_item_code = serializers.CharField(source='boq_item.item_code', read_only=True)
    boq_description = serializers.CharField(source='boq_item.description', read_only=True)
    boq_uom = serializers.CharField(source='boq_item.uom', read_only=True)
    boq_rate = serializers.DecimalField(source='boq_item.rate', max_digits=15, decimal_places=2, read_only=True)
    execution_value = serializers.SerializerMethodField()
    created_by_name = serializers.CharField(source='created_by.username', read_only=True)
    verified_by_name = serializers.CharField(source='verified_by.username', read_only=True)
    project_id = serializers.UUIDField(source='boq_item.project.id', read_only=True)
    project_name = serializers.CharField(source='boq_item.project.name', read_only=True)
    
    class Meta:
        model = BOQExecution
        fields = [
            'id', 'boq_item', 'boq_item_code', 'boq_description', 'boq_uom', 'boq_rate',
            'executed_quantity', 'execution_date', 'period_from', 'period_to',
            'ra_bill', 'status', 'remarks', 'supporting_documents',
            'execution_value', 'created_by', 'created_by_name', 
            'verified_by', 'verified_by_name', 'verified_at',
            'project_id', 'project_name', 'created_at', 'updated_at'
        ]
        read_only_fields = [
            'id', 'created_by', 'verified_by', 'verified_at', 
            'created_at', 'updated_at'
        ]
    
    def get_execution_value(self, obj):
        """Calculate the earned value for this execution."""
        return float(obj.executed_quantity * obj.boq_item.rate)
    
    def create(self, validated_data):
        # Auto-set created_by from request user
        request = self.context.get('request')
        if request and request.user:
            validated_data['created_by'] = request.user
        return super().create(validated_data)


class BOQExecutionCreateSerializer(serializers.ModelSerializer):
    """Simplified serializer for creating BOQ executions."""
    
    class Meta:
        model = BOQExecution
        fields = [
            'boq_item', 'executed_quantity', 'execution_date',
            'period_from', 'period_to', 'ra_bill', 'remarks', 'supporting_documents'
        ]
    
    def validate_executed_quantity(self, value):
        """Ensure executed quantity is positive."""
        if value <= 0:
            raise serializers.ValidationError("Executed quantity must be positive")
        return value
    
    def validate(self, data):
        """Validate that execution doesn't exceed BOQ quantity."""
        boq_item = data.get('boq_item')
        new_qty = data.get('executed_quantity', 0)
        
        # Get total already executed for this BOQ item
        from django.db.models import Sum
        total_executed = BOQExecution.objects.filter(
            boq_item=boq_item,
            status__in=['VERIFIED', 'SUBMITTED', 'DRAFT']
        ).exclude(
            status='REJECTED'
        ).aggregate(total=Sum('executed_quantity'))['total'] or 0
        
        # Check if new execution would exceed BOQ quantity (with 10% tolerance for variations)
        max_allowed = float(boq_item.quantity) * 1.10  # 10% variation tolerance
        if float(total_executed) + float(new_qty) > max_allowed:
            raise serializers.ValidationError(
                f"Total executed ({float(total_executed) + float(new_qty)}) would exceed "
                f"BOQ quantity ({float(boq_item.quantity)}) by more than 10%"
            )
        
        return data


class ProgressCalculationLogSerializer(serializers.ModelSerializer):
    """Serializer for progress calculation audit logs."""
    project_name = serializers.CharField(source='project.name', read_only=True)
    triggered_by_name = serializers.CharField(source='triggered_by.username', read_only=True)
    
    class Meta:
        model = ProgressCalculationLog
        fields = [
            'id', 'project', 'project_name',
            'physical_progress', 'financial_progress', 'earned_value',
            'total_boq_value', 'total_executed_value',
            'boq_items_count', 'verified_executions_count',
            'physical_progress_delta', 'financial_progress_delta',
            'calculated_at', 'triggered_by', 'triggered_by_name'
        ]
        read_only_fields = fields  # All fields are read-only


class BOQMilestoneMappingSerializer(serializers.ModelSerializer):
    milestone_name = serializers.CharField(source='milestone.name', read_only=True)
    boq_item_code = serializers.CharField(source='boq_item.item_code', read_only=True)
    
    class Meta:
        model = BOQMilestoneMapping
        fields = '__all__'

class FundHeadSerializer(serializers.ModelSerializer):
    class Meta:
        model = FundHead
        fields = '__all__'

class ProjectFinanceSettingsSerializer(serializers.ModelSerializer):
    class Meta:
        model = ProjectFinanceSettings
        fields = '__all__'

class BudgetLineItemSerializer(serializers.ModelSerializer):
    milestone_name = serializers.CharField(source='milestone.name', read_only=True)
    fund_name = serializers.CharField(source='fund_head.name', read_only=True)
    class Meta:
        model = BudgetLineItem
        fields = '__all__'

class RABillSerializer(serializers.ModelSerializer):
    milestone_name = serializers.CharField(source='milestone.name', read_only=True)
    project_name = serializers.CharField(source='project.name', read_only=True)
    contractor_name = serializers.SerializerMethodField()
    
    class Meta:
        model = RABill
        fields = '__all__'
        read_only_fields = ['retention_amount', 'net_payable', 'total_amount']

    def get_contractor_name(self, obj):
        return obj.contractor.username if obj.contractor else 'Unknown'

    def validate(self, data):
        return data

    def create(self, validated_data):
        gross = validated_data.get('gross_amount', 0)
        gst_pc = validated_data.get('gst_percentage', 18)
        gst_amt = (gross * gst_pc) / 100
        validated_data['gst_amount'] = gst_amt
        total = gross + gst_amt
        validated_data['total_amount'] = total

        tds_amt = validated_data.get('tds_amount', 0)
        cess_amt = validated_data.get('labour_cess_amount', 0)
        
        project = validated_data.get('project')
        retention_amt = validated_data.get('retention_amount', 0)
        
        try:
            settings = ProjectFinanceSettings.objects.get(project=project)
            if settings.enable_auto_retention and retention_amt == 0:
                retention_amt = (gross * settings.default_retention_rate) / 100
                validated_data['retention_percentage'] = settings.default_retention_rate
        except ProjectFinanceSettings.DoesNotExist:
            pass
        
        validated_data['retention_amount'] = retention_amt

        recoveries = (
            validated_data.get('mobilization_advance_recovery', 0) + 
            validated_data.get('material_advance_recovery', 0) +
            validated_data.get('plant_machinery_recovery', 0) +
            validated_data.get('penalty_amount', 0) + 
            validated_data.get('other_deductions', 0)
        )
        
        net = total - (tds_amt + cess_amt + retention_amt + recoveries)
        validated_data['net_payable'] = net

        bill = super().create(validated_data)
        
        if retention_amt > 0:
            RetentionLedger.objects.create(
                bill=bill,
                amount_held=retention_amt
            )
        
        return bill


class ApprovalRequestSerializer(serializers.ModelSerializer):
    requested_by_name = serializers.CharField(source='requested_by.username', read_only=True)
    reviewed_by_name = serializers.CharField(source='reviewed_by.username', read_only=True)
    project_name = serializers.CharField(source='project.name', read_only=True)
    request_type_display = serializers.CharField(source='get_request_type_display', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    
    class Meta:
        model = ApprovalRequest
        fields = '__all__'
        read_only_fields = ['requested_by', 'reviewed_by', 'reviewed_at', 'created_at', 'updated_at']


class NotificationSerializer(serializers.ModelSerializer):
    class Meta:
        model = Notification
        fields = '__all__'
        read_only_fields = ['created_at']



================================================
FILE: backend/finance/tests.py
================================================
from django.test import TestCase

# Create your tests here.



================================================
FILE: backend/finance/urls.py
================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import (
    FundHeadViewSet, BudgetLineItemViewSet, RABillViewSet, 
    ProjectFinanceSettingsViewSet, BOQItemViewSet, BOQMilestoneMappingViewSet,
    ApprovalRequestViewSet, NotificationViewSet, BOQExecutionViewSet, ProgressViewSet,
    EVMViewSet
)

router = DefaultRouter()
router.register(r'funds', FundHeadViewSet, basename='fund')
router.register(r'budgets', BudgetLineItemViewSet, basename='budget')
router.register(r'bills', RABillViewSet, basename='bill')
router.register(r'settings', ProjectFinanceSettingsViewSet, basename='finance-settings')
router.register(r'boq', BOQItemViewSet, basename='boq')
router.register(r'mappings', BOQMilestoneMappingViewSet, basename='boq-mapping')
router.register(r'approval-requests', ApprovalRequestViewSet, basename='approval-request')
router.register(r'notifications', NotificationViewSet, basename='notification')
router.register(r'executions', BOQExecutionViewSet, basename='boq-execution')
router.register(r'progress', ProgressViewSet, basename='progress')
router.register(r'evm', EVMViewSet, basename='evm')

urlpatterns = [
    path('', include(router.urls)),
]



================================================
FILE: backend/finance/views.py
================================================
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.exceptions import PermissionDenied
from django.utils import timezone
from .models import (
    FundHead, BudgetLineItem, RABill, RetentionLedger, ProjectFinanceSettings, 
    BOQMilestoneMapping, ApprovalRequest, Notification, BOQExecution, ProgressCalculationLog
)
from .serializers import (
    FundHeadSerializer, BudgetLineItemSerializer, 
    RABillSerializer, ProjectFinanceSettingsSerializer,
    BOQMilestoneMappingSerializer, ApprovalRequestSerializer, NotificationSerializer,
    BOQExecutionSerializer, BOQExecutionCreateSerializer, ProgressCalculationLogSerializer
)
from django.db import models
from users.models import User

class FundHeadViewSet(viewsets.ModelViewSet):
    queryset = FundHead.objects.all()
    serializer_class = FundHeadSerializer
    permission_classes = [permissions.IsAuthenticated]

class BudgetLineItemViewSet(viewsets.ModelViewSet):
    queryset = BudgetLineItem.objects.all()
    serializer_class = BudgetLineItemSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        qs = super().get_queryset()
        project_id = self.request.query_params.get('project')
        if project_id:
            qs = qs.filter(project_id=project_id)
        return qs

class ProjectFinanceSettingsViewSet(viewsets.ModelViewSet):
    queryset = ProjectFinanceSettings.objects.all()
    serializer_class = ProjectFinanceSettingsSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    @action(detail=False, methods=['get'])
    def by_project(self, request):
        project_id = request.query_params.get('project')
        if not project_id:
            return Response({'error': 'Project ID required'}, status=400)
        settings, _ = ProjectFinanceSettings.objects.get_or_create(project_id=project_id)
        return Response(self.get_serializer(settings).data)

from common.utils.importers import ExcelImporter
from .models import BOQItem
from .serializers import BOQItemSerializer
from rest_framework.parsers import MultiPartParser, FormParser
import json

class BOQItemViewSet(viewsets.ModelViewSet):
    queryset = BOQItem.objects.all()
    serializer_class = BOQItemSerializer
    permission_classes = [permissions.IsAuthenticated]
    parser_classes = (MultiPartParser, FormParser)

    def get_queryset(self):
        qs = super().get_queryset()
        project_id = self.request.query_params.get('project')
        if project_id:
            qs = qs.filter(project_id=project_id)
        return qs.order_by('item_code')

    def perform_destroy(self, instance):
        if instance.status == BOQItem.Status.FROZEN:
            raise PermissionDenied("Cannot delete a Frozen BOQ Item.")
        super().perform_destroy(instance)
    
    def perform_update(self, serializer):
        if self.get_object().status == BOQItem.Status.FROZEN:
            raise PermissionDenied("Cannot update a Frozen BOQ Item.")
        serializer.save()

    @action(detail=False, methods=['post'])
    def request_freeze(self, request):
        """
        Request approval to freeze selected BOQ items.
        Creates an ApprovalRequest and notifies admins.
        """
        try:
            item_ids = request.data.get('item_ids', [])
            project_id = request.data.get('project_id')
            description = request.data.get('description', '')
            
            if not item_ids:
                return Response({'error': 'No items selected'}, status=400)
            if not project_id:
                return Response({'error': 'Project ID is required'}, status=400)
            
            # Validate items exist and are in DRAFT status
            items = BOQItem.objects.filter(id__in=item_ids, project_id=project_id, status='DRAFT')
            found_count = items.count()
            
            if found_count == 0:
                return Response({'error': 'No matching draft items found'}, status=400)
            
            # Create approval request with found items only
            approval_request = ApprovalRequest.objects.create(
                request_type=ApprovalRequest.RequestType.BOQ_FREEZE,
                entity_ids=[str(item.id) for item in items],
                entity_type='BOQItem',
                project_id=project_id,
                requested_by=request.user,
                title=f"BOQ Freeze Request - {found_count} items",
                description=description or f"Request to freeze {found_count} BOQ items as baseline."
            )
            
            # Notify all admin users
            admin_users = User.objects.filter(role__in=['NICDC_HQ', 'SPV_Official', 'PMNC_Team'])
            notifications = []
            for admin in admin_users:
                notifications.append(Notification(
                    user=admin,
                    notification_type=Notification.NotificationType.APPROVAL_REQUEST,
                    title="New BOQ Freeze Request",
                    message=f"{request.user.username} has requested to freeze {found_count} BOQ items. Awaiting your approval.",
                    related_url="/approvals",
                    related_request=approval_request
                ))
            if notifications:
                Notification.objects.bulk_create(notifications)
            
            return Response({
                'status': 'success',
                'message': f'Freeze request submitted for {found_count} items',
                'request_id': str(approval_request.id)
            })
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({'error': f'Server error: {str(e)}'}, status=500)

    @action(detail=False, methods=['post'])
    def request_unfreeze(self, request):
        """
        Request approval to unfreeze selected BOQ items.
        """
        try:
            item_ids = request.data.get('item_ids', [])
            project_id = request.data.get('project_id')
            description = request.data.get('description', '')
            
            if not item_ids:
                return Response({'error': 'No items selected'}, status=400)
            if not project_id:
                return Response({'error': 'Project ID is required'}, status=400)
            
            items = BOQItem.objects.filter(id__in=item_ids, project_id=project_id, status='FROZEN')
            found_count = items.count()
            
            if found_count == 0:
                return Response({'error': 'No matching frozen items found'}, status=400)
            
            approval_request = ApprovalRequest.objects.create(
                request_type=ApprovalRequest.RequestType.BOQ_UNFREEZE,
                entity_ids=[str(item.id) for item in items],
                entity_type='BOQItem',
                project_id=project_id,
                requested_by=request.user,
                title=f"BOQ Unfreeze Request - {found_count} items",
                description=description or f"Request to unfreeze {found_count} BOQ items for modification."
            )
            
            admin_users = User.objects.filter(role__in=['NICDC_HQ', 'SPV_Official', 'PMNC_Team'])
            notifications = []
            for admin in admin_users:
                notifications.append(Notification(
                    user=admin,
                    notification_type=Notification.NotificationType.APPROVAL_REQUEST,
                    title="New BOQ Unfreeze Request",
                    message=f"{request.user.username} has requested to unfreeze {found_count} BOQ items.",
                    related_url="/approvals",
                    related_request=approval_request
                ))
            if notifications:
                Notification.objects.bulk_create(notifications)
            
            return Response({
                'status': 'success',
                'message': f'Unfreeze request submitted for {found_count} items',
                'request_id': str(approval_request.id)
            })
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({'error': f'Server error: {str(e)}'}, status=500)

    @action(detail=False, methods=['post'])
    def analyze_file(self, request):
        """
        Analyzes an uploaded Excel file and returns its column headers.
        """
        import tempfile
        import os
        
        file_obj = request.FILES.get('file')
        if not file_obj:
            return Response({'error': 'No file uploaded'}, status=400)
        if not file_obj.name.lower().endswith('.xlsx'):
            return Response({'error': 'Only .xlsx Excel files are supported'}, status=400)
        
        temp_path = None
        try:
            with tempfile.NamedTemporaryFile(delete=False, suffix='.xlsx') as tmp:
                for chunk in file_obj.chunks():
                    tmp.write(chunk)
                temp_path = tmp.name
            
            headers = ExcelImporter().read_headers(temp_path)
            return Response({'headers': headers, 'filename': file_obj.name})
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({'error': f'Failed to analyze file: {str(e)}'}, status=500)
        finally:
            if temp_path and os.path.exists(temp_path):
                os.remove(temp_path)

    @action(detail=False, methods=['post'])
    def import_file(self, request):
        """
        Imports BOQ data from an uploaded Excel file.
        """
        import tempfile
        import os
        
        file_obj = request.FILES.get('file')
        project_id = request.data.get('project_id')
        mapping_str = request.data.get('mapping', '{}')
        
        if not file_obj:
            return Response({'error': 'No file uploaded'}, status=400)
        if not project_id:
            return Response({'error': 'Project ID is required'}, status=400)
        
        temp_path = None
        try:
            mapping = json.loads(mapping_str)
            
            with tempfile.NamedTemporaryFile(delete=False, suffix='.xlsx') as tmp:
                for chunk in file_obj.chunks():
                    tmp.write(chunk)
                temp_path = tmp.name
            
            importer = ExcelImporter()
            count = 0
            errors = []
            
            for row in importer.import_data(temp_path, mapping):
                item_code = row.get('item_code')
                if not item_code:
                    continue
                
                try:
                    quantity = float(row.get('quantity', 0) or 0)
                    rate = float(row.get('rate', 0) or 0)
                    amount = quantity * rate
                    
                    BOQItem.objects.update_or_create(
                        project_id=project_id,
                        item_code=str(item_code).strip(),
                        defaults={
                            'description': str(row.get('description', '')).strip(),
                            'uom': str(row.get('uom', 'LS')).strip() or 'LS',
                            'quantity': quantity,
                            'rate': rate,
                            'amount': amount,
                            'status': 'DRAFT'
                        }
                    )
                    count += 1
                except Exception as row_err:
                    errors.append(f"Row {count+1}: {str(row_err)}")
            
            response_data = {'status': 'success', 'imported': count}
            if errors:
                response_data['errors'] = errors[:5]
            return Response(response_data)
            
        except json.JSONDecodeError:
            return Response({'error': 'Invalid mapping format'}, status=400)
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({'error': f'Import failed: {str(e)}'}, status=500)
        finally:
            if temp_path and os.path.exists(temp_path):
                os.remove(temp_path)


class BOQMilestoneMappingViewSet(viewsets.ModelViewSet):
    queryset = BOQMilestoneMapping.objects.all()
    serializer_class = BOQMilestoneMappingSerializer
    permission_classes = [permissions.IsAuthenticated]


class ApprovalRequestViewSet(viewsets.ModelViewSet):
    queryset = ApprovalRequest.objects.all()
    serializer_class = ApprovalRequestSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        qs = super().get_queryset()
        user = self.request.user
        status_param = self.request.query_params.get('status')
        
        # Regular users see their own requests
        # Admins see pending requests for their approval
        if hasattr(user, 'role') and user.role in ['NICDC_HQ', 'SPV_Official', 'PMNC_Team']:
            pass  # Admins see all
        else:
            qs = qs.filter(requested_by=user)
            
        if status_param:
            qs = qs.filter(status=status_param)
        
        return qs

    @action(detail=False, methods=['get'])
    def pending(self, request):
        """Get all pending approval requests for admin users."""
        user = request.user
        if not hasattr(user, 'role') or user.role not in ['NICDC_HQ', 'SPV_Official', 'PMNC_Team']:
            return Response([], status=200)
        
        pending = ApprovalRequest.objects.filter(status='PENDING')
        return Response(ApprovalRequestSerializer(pending, many=True).data)

    @action(detail=True, methods=['post'])
    def approve(self, request, pk=None):
        """Approve the request and apply the changes."""
        approval = self.get_object()
        user = request.user
        
        # Check admin permission
        if not hasattr(user, 'role') or user.role not in ['NICDC_HQ', 'SPV_Official', 'PMNC_Team']:
            return Response({'error': 'You do not have permission to approve requests'}, status=403)
        
        if approval.status != 'PENDING':
            return Response({'error': 'Request is not pending'}, status=400)
        
        notes = request.data.get('notes', '')
        
        # Apply the changes based on request type
        if approval.request_type == 'BOQ_FREEZE':
            BOQItem.objects.filter(id__in=approval.entity_ids).update(status='FROZEN')
        elif approval.request_type == 'BOQ_UNFREEZE':
            BOQItem.objects.filter(id__in=approval.entity_ids).update(status='DRAFT')
        
        # Update approval record
        approval.status = 'APPROVED'
        approval.reviewed_by = user
        approval.reviewed_at = timezone.now()
        approval.review_notes = notes
        approval.save()
        
        # Notify the requester
        Notification.objects.create(
            user=approval.requested_by,
            notification_type=Notification.NotificationType.APPROVAL_RESULT,
            title=f"Request Approved: {approval.title}",
            message=f"Your {approval.get_request_type_display()} has been approved by {user.username}.",
            related_url="/cost/boq",
            related_request=approval
        )
        
        return Response({'status': 'approved', 'message': 'Request approved successfully'})

    @action(detail=True, methods=['post'])
    def reject(self, request, pk=None):
        """Reject the request."""
        approval = self.get_object()
        user = request.user
        
        if not hasattr(user, 'role') or user.role not in ['NICDC_HQ', 'SPV_Official', 'PMNC_Team']:
            return Response({'error': 'You do not have permission to reject requests'}, status=403)
        
        if approval.status != 'PENDING':
            return Response({'error': 'Request is not pending'}, status=400)
        
        notes = request.data.get('notes', 'No reason provided')
        
        approval.status = 'REJECTED'
        approval.reviewed_by = user
        approval.reviewed_at = timezone.now()
        approval.review_notes = notes
        approval.save()
        
        # Notify the requester
        Notification.objects.create(
            user=approval.requested_by,
            notification_type=Notification.NotificationType.APPROVAL_RESULT,
            title=f"Request Rejected: {approval.title}",
            message=f"Your {approval.get_request_type_display()} has been rejected. Reason: {notes}",
            related_url="/cost/boq",
            related_request=approval
        )
        
        return Response({'status': 'rejected', 'message': 'Request rejected'})


class NotificationViewSet(viewsets.ModelViewSet):
    serializer_class = NotificationSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        return Notification.objects.filter(user=self.request.user)

    @action(detail=False, methods=['get'])
    def unread_count(self, request):
        count = Notification.objects.filter(user=request.user, is_read=False).count()
        return Response({'count': count})

    @action(detail=True, methods=['post'])
    def mark_read(self, request, pk=None):
        notification = self.get_object()
        notification.is_read = True
        notification.save()
        return Response({'status': 'marked_read'})

    @action(detail=False, methods=['post'])
    def mark_all_read(self, request):
        Notification.objects.filter(user=request.user, is_read=False).update(is_read=True)
        return Response({'status': 'all_marked_read'})


class RABillViewSet(viewsets.ModelViewSet):
    queryset = RABill.objects.all()
    serializer_class = RABillSerializer
    permission_classes = [permissions.IsAuthenticated]

    def perform_create(self, serializer):
        user = self.request.user
        
        milestone = serializer.validated_data.get('milestone')
        gross_amount = serializer.validated_data.get('gross_amount')
        
        metadata = serializer.validated_data.get('metadata', {}) or {}
        warnings = []
        
        if milestone and gross_amount:
            total_budget = BudgetLineItem.objects.filter(milestone=milestone).aggregate(models.Sum('amount'))['amount__sum'] or 0
            
            if total_budget > 0:
                billed_pct = (gross_amount / total_budget) * 100
                physical_pct = milestone.progress
                
                if billed_pct > (physical_pct + 5):
                    warnings.append(f"High Risk: Billing {billed_pct:.1f}% (of budget) but Physical Progress is only {physical_pct}%.")
        
        if warnings:
            metadata['warnings'] = warnings
            
        bill = serializer.save(metadata=metadata)
        
        # Auto-generate PDF bill
        try:
            from finance.services import generate_ra_bill_pdf
            pdf_url = generate_ra_bill_pdf(bill)
            import logging
            logger = logging.getLogger(__name__)
            logger.info(f"Generated PDF for bill {bill.bill_no}: {pdf_url}")
        except Exception as e:
            import logging
            logger = logging.getLogger(__name__)
            logger.warning(f"Failed to generate PDF for bill {bill.bill_no}: {str(e)}")
            # Don't fail the bill creation if PDF generation fails
            pass

    def get_queryset(self):
        qs = super().get_queryset()
        project_id = self.request.query_params.get('project')
        status_param = self.request.query_params.get('status')
        if project_id:
            qs = qs.filter(project_id=project_id)
        if status_param:
            qs = qs.filter(status=status_param)
        return qs.order_by('-created_at')

    @action(detail=False, methods=['post'])
    def calculate_etp(self, request):
        """
        Calculate ETP deductions for a given gross amount.
        
        This endpoint fetches active ETP charges from the masters table
        and calculates all applicable deductions, recoveries, and levies.
        
        Request body:
        {
            "gross_amount": 1000000,
            "gst_percentage": 18,
            "retention_percentage": 5,
            "other_deductions": 0,
            "advances_recovery": 0,
            "works_component": null,
            "material_cost": null,
            "labour_cost": null
        }
        
        Returns: Complete bill summary with all calculated charges.
        """
        try:
            from finance.services import ETPCalculationService
            from decimal import Decimal
            
            gross_amount = request.data.get('gross_amount', 0)
            gst_percentage = request.data.get('gst_percentage', 18)
            retention_percentage = request.data.get('retention_percentage', 0)
            other_deductions = request.data.get('other_deductions', 0)
            advances_recovery = request.data.get('advances_recovery', 0)
            works_component = request.data.get('works_component')
            material_cost = request.data.get('material_cost')
            labour_cost = request.data.get('labour_cost')
            
            if not gross_amount or float(gross_amount) <= 0:
                return Response({'error': 'Valid gross_amount is required'}, status=400)
            
            service = ETPCalculationService()
            
            summary = service.generate_bill_summary(
                gross_amount=Decimal(str(gross_amount)),
                gst_percentage=Decimal(str(gst_percentage)),
                works_component=Decimal(str(works_component)) if works_component else None,
                material_cost=Decimal(str(material_cost)) if material_cost else None,
                labour_cost=Decimal(str(labour_cost)) if labour_cost else None,
                other_deductions=Decimal(str(other_deductions)),
                advances_recovery=Decimal(str(advances_recovery)),
                retention_percentage=Decimal(str(retention_percentage)),
            )
            
            return Response(summary)
            
        except ImportError as e:
            return Response({
                'error': 'ETP calculation service not available',
                'detail': str(e)
            }, status=500)
        except Exception as e:
            import traceback
            traceback.print_exc()
            return Response({
                'error': 'Calculation failed',
                'detail': str(e)
            }, status=500)

    @action(detail=True, methods=['post'])
    def verify(self, request, pk=None):
        bill = self.get_object()
        bill.status = 'VERIFIED'
        bill.save()
        return Response({'status': 'verified', 'message': 'Bill verified successfully.'})

    @action(detail=True, methods=['post'])
    def pay(self, request, pk=None):
        bill = self.get_object()
        if bill.status == 'PAID':
            return Response({'error': 'Bill already paid'}, status=400)
        
        budget_items = BudgetLineItem.objects.filter(milestone=bill.milestone)
        if not budget_items.exists():
            return Response({'error': 'No linked Budget/Fund found for this Milestone'}, status=400)
        
        budget = budget_items.first() 
        fund = budget.fund_head
        
        if not fund:
            return Response({'error': 'Budget has no linked Fund Source'}, status=400)
             
        if fund.balance_available < bill.net_payable:
            return Response({'error': f"Insufficient Funds in {fund.name}. Available: {fund.balance_available}"}, status=400)
            
        fund.balance_available -= bill.net_payable
        fund.save()
        
        bill.status = 'PAID'
        bill.save()
        
        return Response({'status': 'paid', 'fund_balance': fund.balance_available})


class BOQExecutionViewSet(viewsets.ModelViewSet):
    """
    ViewSet for BOQ Execution entries.
    
    Provides CRUD operations for tracking executed quantities against BOQ items,
    with verification workflow and automatic progress recalculation.
    """
    queryset = BOQExecution.objects.all()
    permission_classes = [permissions.IsAuthenticated]
    
    def get_serializer_class(self):
        if self.action == 'create':
            return BOQExecutionCreateSerializer
        return BOQExecutionSerializer
    
    def get_queryset(self):
        qs = super().get_queryset().select_related(
            'boq_item', 'boq_item__project', 'created_by', 'verified_by', 'ra_bill'
        )
        
        # Filter by project
        project_id = self.request.query_params.get('project')
        if project_id:
            qs = qs.filter(boq_item__project_id=project_id)
        
        # Filter by BOQ item
        boq_item_id = self.request.query_params.get('boq_item')
        if boq_item_id:
            qs = qs.filter(boq_item_id=boq_item_id)
        
        # Filter by status
        status_param = self.request.query_params.get('status')
        if status_param:
            qs = qs.filter(status=status_param)
        
        return qs.order_by('-execution_date', '-created_at')
    
    def perform_create(self, serializer):
        serializer.save(created_by=self.request.user)
    
    @action(detail=True, methods=['post'])
    def submit(self, request, pk=None):
        """Submit execution for verification."""
        execution = self.get_object()
        
        if execution.status != 'DRAFT':
            return Response(
                {'error': 'Only draft executions can be submitted'},
                status=400
            )
        
        execution.status = 'SUBMITTED'
        execution.save()
        
        # Notify admins about pending verification
        admin_users = User.objects.filter(role__in=['NICDC_HQ', 'SPV_Official', 'PMNC_Team'])
        for admin in admin_users:
            Notification.objects.create(
                user=admin,
                notification_type=Notification.NotificationType.APPROVAL_REQUEST,
                title="BOQ Execution Pending Verification",
                message=f"BOQ execution for {execution.boq_item.item_code} submitted by {request.user.username}",
                related_url="/cost/progress"
            )
        
        return Response({
            'status': 'submitted',
            'message': 'Execution submitted for verification'
        })
    
    @action(detail=True, methods=['post'])
    def verify(self, request, pk=None):
        """Verify execution and recalculate project progress."""
        execution = self.get_object()
        user = request.user
        
        # Check admin permission
        if not hasattr(user, 'role') or user.role not in ['NICDC_HQ', 'SPV_Official', 'PMNC_Team']:
            return Response(
                {'error': 'You do not have permission to verify executions'},
                status=403
            )
        
        if execution.status != 'SUBMITTED':
            return Response(
                {'error': 'Only submitted executions can be verified'},
                status=400
            )
        
        # Verify the execution
        execution.status = 'VERIFIED'
        execution.verified_by = user
        execution.verified_at = timezone.now()
        execution.save()
        
        # Recalculate project progress
        from .progress_service import ProgressCalculationService
        project = execution.boq_item.project
        service = ProgressCalculationService(project)
        progress_result = service.calculate_and_update(triggered_by=user)
        
        # Notify the creator
        if execution.created_by:
            Notification.objects.create(
                user=execution.created_by,
                notification_type=Notification.NotificationType.APPROVAL_RESULT,
                title="Execution Verified",
                message=f"Your BOQ execution for {execution.boq_item.item_code} has been verified",
                related_url="/cost/progress"
            )
        
        return Response({
            'status': 'verified',
            'message': 'Execution verified successfully',
            'progress': progress_result
        })
    
    @action(detail=True, methods=['post'])
    def reject(self, request, pk=None):
        """Reject execution with reason."""
        execution = self.get_object()
        user = request.user
        
        if not hasattr(user, 'role') or user.role not in ['NICDC_HQ', 'SPV_Official', 'PMNC_Team']:
            return Response(
                {'error': 'You do not have permission to reject executions'},
                status=403
            )
        
        if execution.status != 'SUBMITTED':
            return Response(
                {'error': 'Only submitted executions can be rejected'},
                status=400
            )
        
        reason = request.data.get('reason', 'No reason provided')
        
        execution.status = 'REJECTED'
        execution.remarks = f"REJECTED: {reason}"
        execution.save()
        
        # Notify the creator
        if execution.created_by:
            Notification.objects.create(
                user=execution.created_by,
                notification_type=Notification.NotificationType.APPROVAL_RESULT,
                title="Execution Rejected",
                message=f"Your BOQ execution for {execution.boq_item.item_code} was rejected. Reason: {reason}",
                related_url="/cost/progress"
            )
        
        return Response({
            'status': 'rejected',
            'message': f'Execution rejected: {reason}'
        })
    
    @action(detail=False, methods=['get'])
    def pending(self, request):
        """Get all pending verification executions for admins."""
        user = request.user
        if not hasattr(user, 'role') or user.role not in ['NICDC_HQ', 'SPV_Official', 'PMNC_Team']:
            return Response([], status=200)
        
        pending = BOQExecution.objects.filter(status='SUBMITTED').select_related(
            'boq_item', 'boq_item__project', 'created_by'
        ).order_by('-created_at')
        
        return Response(BOQExecutionSerializer(pending, many=True).data)


class ProgressViewSet(viewsets.ViewSet):
    """
    ViewSet for project progress metrics.
    
    Provides endpoints for:
    - Getting current project progress
    - Triggering manual recalculation
    - Getting detailed BOQ breakdown
    - Viewing progress calculation history
    """
    permission_classes = [permissions.IsAuthenticated]
    
    @action(detail=False, methods=['get'], url_path='project/(?P<project_id>[^/.]+)')
    def project_progress(self, request, project_id=None):
        """Get current progress metrics for a project."""
        from projects.models import Project
        
        try:
            project = Project.objects.get(id=project_id)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found'}, status=404)
        
        return Response({
            'project_id': str(project.id),
            'project_name': project.name,
            'physical_progress': project.physical_progress,
            'financial_progress': project.financial_progress,
            'earned_value': float(project.earned_value),
            'budget': float(project.budget),
            'spent': float(project.spent),
            'schedule_variance': project.schedule_variance,
            'progress_state': project.progress_state,
            'updated_at': project.updated_at.isoformat()
        })
    
    @action(detail=False, methods=['post'], url_path='recalculate/(?P<project_id>[^/.]+)')
    def recalculate(self, request, project_id=None):
        """Manually trigger progress recalculation for a project."""
        from projects.models import Project
        from .progress_service import ProgressCalculationService
        
        try:
            project = Project.objects.get(id=project_id)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found'}, status=404)
        
        service = ProgressCalculationService(project)
        result = service.calculate_and_update(triggered_by=request.user)
        
        return Response({
            'status': 'success',
            'message': 'Progress recalculated successfully',
            'result': result
        })
    
    @action(detail=False, methods=['get'], url_path='breakdown/(?P<project_id>[^/.]+)')
    def boq_breakdown(self, request, project_id=None):
        """Get detailed BOQ progress breakdown for a project."""
        from projects.models import Project
        from .progress_service import ProgressCalculationService
        
        try:
            project = Project.objects.get(id=project_id)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found'}, status=404)
        
        service = ProgressCalculationService(project)
        breakdown = service.get_boq_progress_breakdown()
        
        return Response({
            'project_id': str(project.id),
            'project_name': project.name,
            'boq_items': breakdown,
            'summary': {
                'total_items': len(breakdown),
                'completed_items': len([b for b in breakdown if b['progress_percent'] >= 100]),
                'in_progress_items': len([b for b in breakdown if 0 < b['progress_percent'] < 100]),
                'not_started_items': len([b for b in breakdown if b['progress_percent'] == 0])
            }
        })
    
    @action(detail=False, methods=['get'], url_path='schedule-variance/(?P<project_id>[^/.]+)')
    def schedule_variance(self, request, project_id=None):
        """Get schedule variance metrics for a project."""
        from projects.models import Project
        from .progress_service import ProgressCalculationService
        
        try:
            project = Project.objects.get(id=project_id)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found'}, status=404)
        
        service = ProgressCalculationService(project)
        variance = service.calculate_schedule_variance()
        
        return Response({
            'project_id': str(project.id),
            'project_name': project.name,
            **variance
        })
    
    @action(detail=False, methods=['get'], url_path='history/(?P<project_id>[^/.]+)')
    def calculation_history(self, request, project_id=None):
        """Get progress calculation history/audit log for a project."""
        from projects.models import Project
        
        try:
            project = Project.objects.get(id=project_id)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found'}, status=404)
        
        limit = int(request.query_params.get('limit', 20))
        
        logs = ProgressCalculationLog.objects.filter(
            project=project
        ).select_related('triggered_by').order_by('-calculated_at')[:limit]
        
        return Response({
            'project_id': str(project.id),
            'project_name': project.name,
            'history': ProgressCalculationLogSerializer(logs, many=True).data
        })


class EVMViewSet(viewsets.ViewSet):
    """
    ViewSet for Earned Value Management (EVM) metrics.
    
    Provides endpoints for:
    - Current EVM metrics (CPI, SPI, CV, SV, etc.)
    - S-Curve time-series data
    - Historical snapshots
    - Forcing snapshot creation
    """
    permission_classes = [permissions.IsAuthenticated]
    
    @action(detail=False, methods=['get'], url_path='metrics/(?P<project_id>[^/.]+)')
    def metrics(self, request, project_id=None):
        """Get current EVM metrics for a project."""
        from projects.models import Project
        from .evm_service import EVMCalculationService
        
        try:
            project = Project.objects.get(id=project_id)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found'}, status=404)
        
        service = EVMCalculationService(project)
        metrics = service.calculate_all_metrics()
        
        return Response(metrics)
    
    @action(detail=False, methods=['get'], url_path='s-curve/(?P<project_id>[^/.]+)')
    def s_curve(self, request, project_id=None):
        """Get S-Curve time-series data for charting."""
        from projects.models import Project
        from .evm_service import EVMCalculationService
        from datetime import datetime
        
        try:
            project = Project.objects.get(id=project_id)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found'}, status=404)
        
        # Parse optional date filters
        start_date = request.query_params.get('start')
        end_date = request.query_params.get('end')
        
        if start_date:
            start_date = datetime.fromisoformat(start_date).date()
        if end_date:
            end_date = datetime.fromisoformat(end_date).date()
        
        service = EVMCalculationService(project)
        data = service.get_s_curve_data(start_date, end_date)
        
        return Response({
            'project_id': str(project.id),
            'project_name': project.name,
            'data': data,
            'chart_config': {
                'lines': [
                    {'key': 'pv', 'name': 'Planned Value (PV)', 'color': '#3b82f6'},  # Blue
                    {'key': 'ev', 'name': 'Earned Value (EV)', 'color': '#10b981'},   # Green
                    {'key': 'ac', 'name': 'Actual Cost (AC)', 'color': '#ef4444'},    # Red
                ],
                'xKey': 'label',
                'yLabel': 'Amount (â‚¹)',
            }
        })
    
    @action(detail=False, methods=['get'], url_path='history/(?P<project_id>[^/.]+)')
    def history(self, request, project_id=None):
        """Get EVM snapshot history for a project."""
        from projects.models import Project
        from .evm_service import ProjectEVMHistory
        
        try:
            project = Project.objects.get(id=project_id)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found'}, status=404)
        
        limit = int(request.query_params.get('limit', 50))
        
        snapshots = ProjectEVMHistory.objects.filter(
            project=project
        ).order_by('-snapshot_date')[:limit]
        
        data = [{
            'date': snap.snapshot_date.isoformat(),
            'bac': float(snap.bac),
            'pv': float(snap.pv),
            'ev': float(snap.ev),
            'ac': float(snap.ac),
            'cpi': snap.cpi,
            'spi': snap.spi,
            'cv': float(snap.cv),
            'sv': float(snap.sv),
            'eac': float(snap.eac),
            'planned_percent': snap.planned_percent,
            'actual_percent': snap.actual_percent,
        } for snap in snapshots]
        
        return Response({
            'project_id': str(project.id),
            'project_name': project.name,
            'snapshots': data
        })
    
    @action(detail=False, methods=['post'], url_path='snapshot/(?P<project_id>[^/.]+)')
    def create_snapshot(self, request, project_id=None):
        """Force creation of an EVM snapshot for today."""
        from projects.models import Project
        from .evm_service import EVMCalculationService
        
        try:
            project = Project.objects.get(id=project_id)
        except Project.DoesNotExist:
            return Response({'error': 'Project not found'}, status=404)
        
        service = EVMCalculationService(project)
        snapshot = service.create_snapshot()
        
        return Response({
            'status': 'success',
            'message': 'EVM snapshot created',
            'snapshot_id': str(snapshot.id),
            'snapshot_date': snapshot.snapshot_date.isoformat()
        })
    
    @action(detail=False, methods=['post'], url_path='snapshot-all')
    def create_all_snapshots(self, request):
        """Create EVM snapshots for all active projects (admin only)."""
        user = request.user
        
        if not hasattr(user, 'role') or user.role not in ['NICDC_HQ', 'SPV_Official', 'PMNC_Team']:
            return Response(
                {'error': 'Admin permission required'},
                status=403
            )
        
        from .evm_service import create_evm_snapshots_for_all_projects
        results = create_evm_snapshots_for_all_projects()
        
        return Response({
            'status': 'success',
            'projects_processed': len(results),
            'successful': len([r for r in results if r['success']]),
            'failed': len([r for r in results if not r['success']]),
            'details': results
        })



================================================
FILE: backend/finance/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2025-12-24 14:11

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('projects', '0002_workpackage'),
        ('scheduling', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='FundHead',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('source_name', models.CharField(help_text='e.g. World Bank Loan, State Budget', max_length=255)),
                ('total_amount', models.DecimalField(decimal_places=2, max_digits=15)),
                ('balance_available', models.DecimalField(decimal_places=2, max_digits=15)),
                ('allocation_date', models.DateField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
        ),
        migrations.CreateModel(
            name='BudgetLineItem',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('cost_category', models.CharField(choices=[('MATERIAL', 'Material'), ('LABOUR', 'Labour'), ('MACHINERY', 'Machinery'), ('OVERHEAD', 'Overhead'), ('PROFESSIONAL', 'Professional Fees'), ('OTHER', 'Other')], max_length=50)),
                ('amount', models.DecimalField(decimal_places=2, max_digits=12)),
                ('version', models.IntegerField(default=1)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('milestone', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='budget_allocations', to='scheduling.scheduletask')),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='budget_items', to='projects.project')),
            ],
        ),
        migrations.CreateModel(
            name='ProjectFinanceSettings',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('enable_auto_retention', models.BooleanField(default=True, help_text='Auto-calculate 5% retention on bills')),
                ('default_retention_rate', models.DecimalField(decimal_places=2, default=5.0, max_digits=5)),
                ('last_verified_at', models.DateTimeField(blank=True, help_text='For 30-Day Budget Pulse', null=True)),
                ('project', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='finance_settings', to='projects.project')),
            ],
        ),
        migrations.CreateModel(
            name='RABill',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('bill_no', models.CharField(max_length=50)),
                ('work_order_no', models.CharField(max_length=100)),
                ('bill_date', models.DateField()),
                ('period_from', models.DateField(blank=True, null=True)),
                ('period_to', models.DateField(blank=True, null=True)),
                ('gross_amount', models.DecimalField(decimal_places=2, help_text='Amount before GST', max_digits=15)),
                ('gst_percentage', models.DecimalField(decimal_places=2, default=18.0, max_digits=5)),
                ('gst_amount', models.DecimalField(decimal_places=2, max_digits=15)),
                ('total_amount', models.DecimalField(decimal_places=2, help_text='Gross + GST', max_digits=15)),
                ('tds_percentage', models.DecimalField(decimal_places=2, default=0.0, max_digits=5)),
                ('tds_amount', models.DecimalField(decimal_places=2, default=0.0, max_digits=15)),
                ('tds_section_type', models.CharField(choices=[('194C_IND', '194C - Individual/HUF'), ('194C_OTH', '194C - Others'), ('194J', '194J - Professional'), ('NONE', 'None')], default='NONE', max_length=20)),
                ('labour_cess_percentage', models.DecimalField(decimal_places=2, default=1.0, max_digits=5)),
                ('labour_cess_amount', models.DecimalField(decimal_places=2, default=0.0, max_digits=15)),
                ('retention_percentage', models.DecimalField(decimal_places=2, default=0.0, max_digits=5)),
                ('retention_amount', models.DecimalField(decimal_places=2, default=0.0, max_digits=15)),
                ('mobilization_advance_recovery', models.DecimalField(decimal_places=2, default=0.0, max_digits=15)),
                ('material_advance_recovery', models.DecimalField(decimal_places=2, default=0.0, max_digits=15)),
                ('plant_machinery_recovery', models.DecimalField(decimal_places=2, default=0.0, max_digits=15)),
                ('penalty_amount', models.DecimalField(decimal_places=2, default=0.0, max_digits=15)),
                ('other_deductions', models.DecimalField(decimal_places=2, default=0.0, max_digits=15)),
                ('other_deduction_remarks', models.CharField(blank=True, max_length=255)),
                ('net_payable', models.DecimalField(decimal_places=2, max_digits=15)),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('SUBMITTED', 'Submitted'), ('VERIFIED', 'Verified'), ('APPROVED', 'Approved'), ('PAID', 'Paid')], default='DRAFT', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('contractor', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='submitted_bills', to=settings.AUTH_USER_MODEL)),
                ('milestone', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='ra_bills', to='scheduling.scheduletask')),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='ra_bills', to='projects.project')),
            ],
        ),
        migrations.CreateModel(
            name='RetentionLedger',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('amount_held', models.DecimalField(decimal_places=2, max_digits=15)),
                ('amount_released', models.DecimalField(decimal_places=2, default=0.0, max_digits=15)),
                ('status', models.CharField(choices=[('HELD', 'Held'), ('RELEASED', 'Released')], default='HELD', max_length=20)),
                ('release_date', models.DateField(blank=True, null=True)),
                ('remarks', models.TextField(blank=True)),
                ('bill', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='retention_ledger', to='finance.rabill')),
            ],
        ),
        migrations.CreateModel(
            name='VariationRequest',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('requested_amount', models.DecimalField(decimal_places=2, max_digits=12)),
                ('reason', models.TextField()),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected')], default='PENDING', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('original_budget', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='variations', to='finance.budgetlineitem')),
            ],
        ),
    ]



================================================
FILE: backend/finance/migrations/0002_rename_source_name_fundhead_name_and_more.py
================================================
# Generated by Django 6.0 on 2025-12-25 07:28

import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('finance', '0001_initial'),
    ]

    operations = [
        migrations.RenameField(
            model_name='fundhead',
            old_name='source_name',
            new_name='name',
        ),
        migrations.RemoveField(
            model_name='fundhead',
            name='allocation_date',
        ),
        migrations.AddField(
            model_name='fundhead',
            name='allocating_authority',
            field=models.CharField(default='Government', help_text='e.g. Dept of Finance', max_length=255),
        ),
        migrations.AddField(
            model_name='fundhead',
            name='end_date',
            field=models.DateField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='fundhead',
            name='start_date',
            field=models.DateField(default=django.utils.timezone.now),
        ),
        migrations.AlterField(
            model_name='fundhead',
            name='balance_available',
            field=models.DecimalField(blank=True, decimal_places=2, max_digits=15),
        ),
    ]



================================================
FILE: backend/finance/migrations/0003_budgetlineitem_fund_head.py
================================================
# Generated by Django 6.0 on 2025-12-25 07:43

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('finance', '0002_rename_source_name_fundhead_name_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='budgetlineitem',
            name='fund_head',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='allocations', to='finance.fundhead'),
        ),
    ]



================================================
FILE: backend/finance/migrations/0004_remove_retentionledger_remarks_boqitem_and_more.py
================================================
# Generated by Django 6.0 on 2025-12-26 15:02

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('finance', '0003_budgetlineitem_fund_head'),
        ('projects', '0002_workpackage'),
        ('scheduling', '0002_scheduletask_external_id_scheduletask_metadata'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='retentionledger',
            name='remarks',
        ),
        migrations.CreateModel(
            name='BOQItem',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('item_code', models.CharField(help_text='e.g. 2.1.1', max_length=50)),
                ('description', models.TextField()),
                ('uom', models.CharField(help_text='Unit of Measurement', max_length=20)),
                ('quantity', models.DecimalField(decimal_places=4, max_digits=15)),
                ('rate', models.DecimalField(decimal_places=2, max_digits=15)),
                ('amount', models.DecimalField(decimal_places=2, help_text='Qty * Rate', max_digits=15)),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('FROZEN', 'Frozen (Immutable)')], default='DRAFT', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='boq_items', to='projects.project')),
            ],
            options={
                'ordering': ['item_code'],
                'unique_together': {('project', 'item_code')},
            },
        ),
        migrations.CreateModel(
            name='BOQMilestoneMapping',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('percentage_allocated', models.DecimalField(decimal_places=2, help_text='How much of this BOQ item is consumed by this milestone?', max_digits=5)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('boq_item', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='milestone_mappings', to='finance.boqitem')),
                ('milestone', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='boq_mappings', to='scheduling.scheduletask')),
            ],
            options={
                'unique_together': {('boq_item', 'milestone')},
            },
        ),
    ]



================================================
FILE: backend/finance/migrations/0005_rabill_metadata.py
================================================
# Generated by Django 6.0 on 2025-12-26 15:02

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('finance', '0004_remove_retentionledger_remarks_boqitem_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='rabill',
            name='metadata',
            field=models.JSONField(blank=True, default=dict, help_text='Store override flags or extra sync data'),
        ),
    ]



================================================
FILE: backend/finance/migrations/0006_approvalrequest_notification.py
================================================
# Generated by Django 6.0 on 2025-12-27 07:02

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('finance', '0005_rabill_metadata'),
        ('projects', '0002_workpackage'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='ApprovalRequest',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('request_type', models.CharField(choices=[('BOQ_FREEZE', 'BOQ Freeze Request'), ('BOQ_UNFREEZE', 'BOQ Unfreeze Request'), ('BUDGET_CHANGE', 'Budget Change Request'), ('VARIATION', 'Variation Request')], max_length=50)),
                ('entity_ids', models.JSONField(default=list, help_text='List of entity UUIDs this request affects')),
                ('entity_type', models.CharField(help_text="e.g., 'BOQItem', 'BudgetLineItem'", max_length=50)),
                ('title', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True)),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected')], default='PENDING', max_length=20)),
                ('reviewed_at', models.DateTimeField(blank=True, null=True)),
                ('review_notes', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='approval_requests', to='projects.project')),
                ('requested_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='submitted_requests', to=settings.AUTH_USER_MODEL)),
                ('reviewed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='reviewed_requests', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='Notification',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('notification_type', models.CharField(choices=[('APPROVAL_REQUEST', 'New Approval Request'), ('APPROVAL_RESULT', 'Approval Result'), ('SYSTEM', 'System Notification'), ('INFO', 'Information')], default='INFO', max_length=50)),
                ('title', models.CharField(max_length=255)),
                ('message', models.TextField()),
                ('related_url', models.CharField(blank=True, help_text='URL to navigate to when clicked', max_length=500)),
                ('is_read', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('related_request', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='finance.approvalrequest')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='finance_notifications', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
    ]



================================================
FILE: backend/finance/migrations/0007_rabill_bill_pdf_file.py
================================================
# Generated by Django 6.0 on 2026-01-14 08:07

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('finance', '0006_approvalrequest_notification'),
    ]

    operations = [
        migrations.AddField(
            model_name='rabill',
            name='bill_pdf_file',
            field=models.FileField(blank=True, help_text='Generated PDF bill saved to media/projects/{project_id}/ra_bills/', null=True, upload_to='projects/ra_bills/'),
        ),
    ]



================================================
FILE: backend/finance/migrations/0008_add_boq_execution_and_progress_log.py
================================================
# Generated by Django 6.0 on 2026-01-18 13:12

import django.core.validators
import django.db.models.deletion
import uuid
from decimal import Decimal
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('finance', '0007_rabill_bill_pdf_file'),
        ('projects', '0007_add_risk_management_models'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='ProgressCalculationLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('physical_progress', models.FloatField()),
                ('financial_progress', models.FloatField()),
                ('earned_value', models.DecimalField(decimal_places=2, max_digits=15)),
                ('total_boq_value', models.DecimalField(decimal_places=2, max_digits=15)),
                ('total_executed_value', models.DecimalField(decimal_places=2, max_digits=15)),
                ('boq_items_count', models.IntegerField()),
                ('verified_executions_count', models.IntegerField()),
                ('physical_progress_delta', models.FloatField(default=0.0)),
                ('financial_progress_delta', models.FloatField(default=0.0)),
                ('calculated_at', models.DateTimeField(auto_now_add=True)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='progress_logs', to='projects.project')),
                ('triggered_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-calculated_at'],
                'get_latest_by': 'calculated_at',
            },
        ),
        migrations.CreateModel(
            name='BOQExecution',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('executed_quantity', models.DecimalField(decimal_places=4, help_text='Quantity executed/achieved in this entry', max_digits=15, validators=[django.core.validators.MinValueValidator(Decimal('0'))])),
                ('execution_date', models.DateField(help_text='Date when this work was executed')),
                ('period_from', models.DateField(blank=True, help_text='Start of execution period', null=True)),
                ('period_to', models.DateField(blank=True, help_text='End of execution period', null=True)),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('SUBMITTED', 'Submitted for Verification'), ('VERIFIED', 'Verified by Authority'), ('REJECTED', 'Rejected'), ('REVISED', 'Revision Required')], default='DRAFT', max_length=20)),
                ('remarks', models.TextField(blank=True, help_text='Execution remarks or notes')),
                ('supporting_documents', models.JSONField(blank=True, default=list, help_text='List of EDMS document IDs as evidence')),
                ('verified_at', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('boq_item', models.ForeignKey(help_text='Reference to the BOQ item being executed', on_delete=django.db.models.deletion.CASCADE, related_name='executions', to='finance.boqitem')),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_boq_executions', to=settings.AUTH_USER_MODEL)),
                ('ra_bill', models.ForeignKey(blank=True, help_text='Linked RA Bill for payment tracking', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='boq_executions', to='finance.rabill')),
                ('verified_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='verified_boq_executions', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-execution_date', '-created_at'],
                'indexes': [models.Index(fields=['boq_item', 'execution_date'], name='finance_boq_boq_ite_fba94a_idx'), models.Index(fields=['status'], name='finance_boq_status_70ea80_idx')],
            },
        ),
    ]



================================================
FILE: backend/finance/migrations/0009_add_project_evm_history.py
================================================
# Generated by Django 6.0 on 2026-01-18 18:30

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('finance', '0008_add_boq_execution_and_progress_log'),
        ('projects', '0007_add_risk_management_models'),
    ]

    operations = [
        migrations.CreateModel(
            name='ProjectEVMHistory',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('snapshot_date', models.DateField(help_text='Date of this snapshot')),
                ('bac', models.DecimalField(decimal_places=2, help_text='Budget At Completion', max_digits=15)),
                ('pv', models.DecimalField(decimal_places=2, help_text='Planned Value', max_digits=15)),
                ('ac', models.DecimalField(decimal_places=2, help_text='Actual Cost', max_digits=15)),
                ('ev', models.DecimalField(decimal_places=2, help_text='Earned Value', max_digits=15)),
                ('cv', models.DecimalField(decimal_places=2, help_text='Cost Variance (EV-AC)', max_digits=15)),
                ('sv', models.DecimalField(decimal_places=2, help_text='Schedule Variance (EV-PV)', max_digits=15)),
                ('cpi', models.FloatField(help_text='Cost Performance Index (EV/AC)')),
                ('spi', models.FloatField(help_text='Schedule Performance Index (EV/PV)')),
                ('eac', models.DecimalField(decimal_places=2, help_text='Estimate At Completion', max_digits=15)),
                ('etc', models.DecimalField(decimal_places=2, help_text='Estimate To Complete', max_digits=15)),
                ('vac', models.DecimalField(decimal_places=2, help_text='Variance At Completion', max_digits=15)),
                ('planned_percent', models.FloatField(help_text='Planned % complete at snapshot date')),
                ('actual_percent', models.FloatField(help_text='Actual % complete at snapshot date')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='evm_history', to='projects.project')),
            ],
            options={
                'ordering': ['snapshot_date'],
                'indexes': [models.Index(fields=['project', 'snapshot_date'], name='finance_pro_project_6ef5aa_idx')],
                'unique_together': {('project', 'snapshot_date')},
            },
        ),
    ]



================================================
FILE: backend/finance/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: backend/finance/services/__init__.py
================================================
"""
Finance services package.

Contains business logic services for financial calculations.
"""

from .etp_calculator import ETPCalculationService, calculate_bill_deductions
from .bill_pdf_generator import RABillPDFGenerator, generate_ra_bill_pdf

__all__ = ['ETPCalculationService', 'calculate_bill_deductions', 'RABillPDFGenerator', 'generate_ra_bill_pdf']



================================================
FILE: backend/finance/services/bill_pdf_generator.py
================================================
"""
RA Bill PDF Generator Service

Generates professional PDF bills using ReportLab with proper formatting
and saves them to project-specific folders.
"""
import os
from decimal import Decimal
from datetime import datetime
from django.conf import settings
from django.core.files.base import ContentFile
from reportlab.lib import colors
from reportlab.lib.pagesizes import A4, letter
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import inch
from reportlab.lib.enums import TA_CENTER, TA_RIGHT, TA_LEFT
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak
from reportlab.pdfgen import canvas
from io import BytesIO


class RABillPDFGenerator:
    """
    Service to generate professional RA Bill PDFs.
    """
    
    def __init__(self, bill):
        """
        Initialize with an RABill instance.
        
        Args:
            bill: RABill model instance
        """
        self.bill = bill
        self.buffer = BytesIO()
        self.styles = getSampleStyleSheet()
        
        # Custom styles
        self.title_style = ParagraphStyle(
            'CustomTitle',
            parent=self.styles['Heading1'],
            fontSize=16,
            textColor=colors.HexColor('#1a1a1a'),
            spaceAfter=12,
            alignment=TA_CENTER,
            fontName='Helvetica-Bold'
        )
        
        self.heading_style = ParagraphStyle(
            'CustomHeading',
            parent=self.styles['Heading2'],
            fontSize=12,
            textColor=colors.HexColor('#2563eb'),
            spaceAfter=6,
            fontName='Helvetica-Bold'
        )
        
        self.normal_style = ParagraphStyle(
            'CustomNormal',
            parent=self.styles['Normal'],
            fontSize=10,
            textColor=colors.HexColor('#374151'),
        )
    
    def _format_currency(self, amount):
        """Format amount as Indian currency."""
        if amount is None:
            return "â‚¹ 0.00"
        return f"â‚¹ {amount:,.2f}"
    
    def _format_date(self, date):
        """Format date for display."""
        if date is None:
            return "N/A"
        return date.strftime("%d-%b-%Y")
    
    def generate(self):
        """
        Generate the PDF and return as bytes.
        
        Returns:
            bytes: PDF file content
        """
        doc = SimpleDocTemplate(
            self.buffer,
            pagesize=A4,
            rightMargin=0.5*inch,
            leftMargin=0.5*inch,
            topMargin=0.75*inch,
            bottomMargin=0.75*inch
        )
        
        # Build PDF content
        story = []
        
        # Header
        story.append(Paragraph("RUNNING ACCOUNT BILL", self.title_style))
        story.append(Spacer(1, 0.2*inch))
        
        # Project and Bill Info
        story.extend(self._build_header_section())
        story.append(Spacer(1, 0.2*inch))
        
        # Financial Summary
        story.extend(self._build_financial_section())
        story.append(Spacer(1, 0.2*inch))
        
        # Deductions
        story.extend(self._build_deductions_section())
        story.append(Spacer(1, 0.2*inch))
        
        # Net Payable
        story.extend(self._build_net_payable_section())
        
        # Build PDF
        doc.build(story)
        
        # Get PDF bytes
        pdf_bytes = self.buffer.getvalue()
        self.buffer.close()
        
        return pdf_bytes
    
    def _build_header_section(self):
        """Build header section with project and bill details."""
        elements = []
        
        data = [
            ['Project:', self.bill.project.name if self.bill.project else 'N/A'],
            ['Bill No:', self.bill.bill_no],
            ['Work Order No:', self.bill.work_order_no],
            ['Bill Date:', self._format_date(self.bill.bill_date)],
        ]
        
        if self.bill.contractor:
            contractor_name = f"{self.bill.contractor.first_name} {self.bill.contractor.last_name}".strip()
            data.append(['Contractor:', contractor_name or self.bill.contractor.username])
        
        if self.bill.period_from and self.bill.period_to:
            data.append(['Period:', f"{self._format_date(self.bill.period_from)} to {self._format_date(self.bill.period_to)}"])
        
        table = Table(data, colWidths=[2*inch, 4*inch])
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (0, -1), colors.HexColor('#f3f4f6')),
            ('TEXTCOLOR', (0, 0), (-1, -1), colors.HexColor('#1f2937')),
            ('ALIGN', (0, 0), (0, -1), 'RIGHT'),
            ('ALIGN', (1, 0), (1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (0, -1), 'Helvetica-Bold'),
            ('FONTNAME', (1, 0), (1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 0), (-1, -1), 10),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#d1d5db')),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('LEFTPADDING', (0, 0), (-1, -1), 8),
            ('RIGHTPADDING', (0, 0), (-1, -1), 8),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
        ]))
        
        elements.append(table)
        return elements
    
    def _build_financial_section(self):
        """Build financial summary section."""
        elements = []
        
        elements.append(Paragraph("Financial Summary", self.heading_style))
        
        data = [
            ['Description', 'Amount'],
            ['Gross Amount', self._format_currency(self.bill.gross_amount)],
            ['GST ({:.2f}%)'.format(self.bill.gst_percentage), self._format_currency(self.bill.gst_amount)],
            ['Total Amount (Gross + GST)', self._format_currency(self.bill.total_amount)],
        ]
        
        table = Table(data, colWidths=[4*inch, 2*inch])
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2563eb')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
            ('ALIGN', (1, 0), (1, -1), 'RIGHT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTNAME', (0, 1), (0, -1), 'Helvetica'),
            ('FONTNAME', (1, 1), (1, -1), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, -1), 10),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#d1d5db')),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('LEFTPADDING', (0, 0), (-1, -1), 8),
            ('RIGHTPADDING', (0, 0), (-1, -1), 8),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
        ]))
        
        elements.append(table)
        return elements
    
    def _build_deductions_section(self):
        """Build deductions section."""
        elements = []
        
        elements.append(Paragraph("Deductions & Recoveries", self.heading_style))
        
        data = [['Description', 'Amount']]
        
        # Add all deductions
        if self.bill.tds_amount > 0:
            data.append([
                f'TDS ({self.bill.get_tds_section_type_display()} - {self.bill.tds_percentage}%)',
                self._format_currency(self.bill.tds_amount)
            ])
        
        if self.bill.labour_cess_amount > 0:
            data.append([f'Labour Cess ({self.bill.labour_cess_percentage}%)', self._format_currency(self.bill.labour_cess_amount)])
        
        if self.bill.retention_amount > 0:
            data.append([f'Retention ({self.bill.retention_percentage}%)', self._format_currency(self.bill.retention_amount)])
        
        if self.bill.mobilization_advance_recovery > 0:
            data.append(['Mobilization Advance Recovery', self._format_currency(self.bill.mobilization_advance_recovery)])
        
        if self.bill.material_advance_recovery > 0:
            data.append(['Material Advance Recovery', self._format_currency(self.bill.material_advance_recovery)])
        
        if self.bill.plant_machinery_recovery > 0:
            data.append(['Plant & Machinery Recovery', self._format_currency(self.bill.plant_machinery_recovery)])
        
        if self.bill.penalty_amount > 0:
            data.append(['Penalty', self._format_currency(self.bill.penalty_amount)])
        
        if self.bill.other_deductions > 0:
            desc = f'Other Deductions ({self.bill.other_deduction_remarks})' if self.bill.other_deduction_remarks else 'Other Deductions'
            data.append([desc, self._format_currency(self.bill.other_deductions)])
        
        # Calculate total deductions
        total_deductions = (
            self.bill.tds_amount +
            self.bill.labour_cess_amount +
            self.bill.retention_amount +
            self.bill.mobilization_advance_recovery +
            self.bill.material_advance_recovery +
            self.bill.plant_machinery_recovery +
            self.bill.penalty_amount +
            self.bill.other_deductions
        )
        
        data.append(['Total Deductions', self._format_currency(total_deductions)])
        
        table = Table(data, colWidths=[4*inch, 2*inch])
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#dc2626')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
            ('ALIGN', (1, 0), (1, -1), 'RIGHT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTNAME', (0, 1), (0, -2), 'Helvetica'),
            ('FONTNAME', (1, 1), (1, -1), 'Helvetica-Bold'),
            ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
            ('BACKGROUND', (0, -1), (-1, -1), colors.HexColor('#fee2e2')),
            ('FONTSIZE', (0, 0), (-1, -1), 10),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.HexColor('#d1d5db')),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('LEFTPADDING', (0, 0), (-1, -1), 8),
            ('RIGHTPADDING', (0, 0), (-1, -1), 8),
            ('TOPPADDING', (0, 0), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 6),
        ]))
        
        elements.append(table)
        return elements
    
    def _build_net_payable_section(self):
        """Build net payable section."""
        elements = []
        
        data = [[
            Paragraph('<b>NET PAYABLE</b>', self.title_style),
            Paragraph(f'<b>{self._format_currency(self.bill.net_payable)}</b>', self.title_style)
        ]]
        
        table = Table(data, colWidths=[4*inch, 2*inch])
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#10b981')),
            ('TEXTCOLOR', (0, 0), (-1, -1), colors.white),
            ('ALIGN', (1, 0), (1, -1), 'RIGHT'),
            ('FONTSIZE', (0, 0), (-1, -1), 14),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('LEFTPADDING', (0, 0), (-1, -1), 12),
            ('RIGHTPADDING', (0, 0), (-1, -1), 12),
            ('TOPPADDING', (0, 0), (-1, -1), 10),
            ('BOTTOMPADDING', (0, 0), (-1, -1), 10),
        ]))
        
        elements.append(table)
        return elements
    
    def save_to_file(self):
        """
        Generate PDF and save to file field.
        
        Returns:
            str: Path to saved file
        """
        # Generate PDF bytes
        pdf_bytes = self.generate()
        
        # Create filename with project ID and bill number
        project_id = str(self.bill.project.id) if self.bill.project else 'unassigned'
        filename = f"projects/{project_id}/ra_bills/bill_{self.bill.bill_no.replace('/', '_')}.pdf"
        
        # Save to FileField
        self.bill.bill_pdf_file.save(
            filename,
            ContentFile(pdf_bytes),
            save=True
        )
        
        return self.bill.bill_pdf_file.url


def generate_ra_bill_pdf(bill):
    """
    Helper function to generate and save RA Bill PDF.
    
    Args:
        bill: RABill instance
    
    Returns:
        str: URL of the generated PDF
    """
    generator = RABillPDFGenerator(bill)
    return generator.save_to_file()



================================================
FILE: backend/finance/services/etp_calculator.py
================================================
"""
ETP (Every Transaction Payment) Billing Integration Service

This module provides robust calculation of statutory deductions and recoveries
for RA Bills based on the ETPMaster configuration. It reads active charges
from the masters table and applies them dynamically.

Key Features:
- Dynamic charge calculation based on ETPMaster
- Audit trail for all calculated deductions
- Support for different calculation bases (Gross, Works, Material, etc.)
- Configurable effective dates for policy changes
"""

from decimal import Decimal, ROUND_HALF_UP
from typing import Dict, List, Optional, Tuple
from django.db import transaction
from django.utils import timezone
from masters.models import ETPMaster


class ETPCalculationService:
    """
    Service class for calculating ETP deductions and recoveries on RA Bills.
    
    Usage:
        service = ETPCalculationService()
        deductions = service.calculate_all_deductions(gross_amount=1000000)
        total_deductions = service.get_total_deductions(deductions)
        net_payable = service.calculate_net_payable(gross_amount, gst_amount, deductions)
    """
    
    # Precision for monetary calculations (2 decimal places)
    PRECISION = Decimal('0.01')
    
    def __init__(self, reference_date: Optional[timezone.datetime] = None):
        """
        Initialize the service.
        
        Args:
            reference_date: Date to use for checking charge effectiveness.
                           Defaults to current date.
        """
        self.reference_date = reference_date or timezone.now().date()
        self._charges_cache = None
    
    def get_active_charges(self, charge_type: Optional[str] = None) -> List[ETPMaster]:
        """
        Fetch all active ETP charges from the database.
        
        Args:
            charge_type: Optional filter for 'Deduction', 'Recovery', 'Levy', 'Addition'
            
        Returns:
            List of active ETPMaster instances
        """
        queryset = ETPMaster.objects.filter(
            is_active=True,
            effective_date__lte=self.reference_date
        )
        
        if charge_type:
            queryset = queryset.filter(charge_type=charge_type)
        
        return list(queryset.order_by('charge_type', 'code'))
    
    def _get_calculation_base(
        self, 
        basis: str, 
        gross_amount: Decimal,
        works_component: Optional[Decimal] = None,
        material_cost: Optional[Decimal] = None,
        labour_cost: Optional[Decimal] = None,
        net_payable: Optional[Decimal] = None
    ) -> Decimal:
        """
        Determine the base amount for calculation based on the charge configuration.
        
        Args:
            basis: The basis of calculation from ETPMaster
            gross_amount: Total gross bill value
            works_component: Optional works component amount
            material_cost: Optional material cost amount
            labour_cost: Optional labour cost amount
            net_payable: Optional net payable for recursive calculations
            
        Returns:
            The base amount to apply the percentage to
        """
        basis_mapping = {
            'Gross Bill Value': gross_amount,
            'Works Component Only': works_component or gross_amount,
            'Material Cost': material_cost or Decimal('0'),
            'Labour Cost': labour_cost or Decimal('0'),
            'Net Payable': net_payable or gross_amount,
        }
        
        return basis_mapping.get(basis, gross_amount)
    
    def calculate_single_charge(
        self,
        charge: ETPMaster,
        gross_amount: Decimal,
        works_component: Optional[Decimal] = None,
        material_cost: Optional[Decimal] = None,
        labour_cost: Optional[Decimal] = None
    ) -> Dict:
        """
        Calculate a single ETP charge.
        
        Args:
            charge: The ETPMaster instance
            gross_amount: Gross bill amount
            works_component: Optional works component
            material_cost: Optional material cost
            labour_cost: Optional labour cost
            
        Returns:
            Dict with charge details and calculated amount
        """
        base_amount = self._get_calculation_base(
            charge.basis_of_calculation,
            gross_amount,
            works_component,
            material_cost,
            labour_cost
        )
        
        # Calculate the charge amount
        rate = Decimal(str(charge.rate_percentage))
        amount = (base_amount * rate / Decimal('100')).quantize(
            self.PRECISION, 
            rounding=ROUND_HALF_UP
        )
        
        return {
            'charge_id': str(charge.id),
            'code': charge.code,
            'name': charge.name,
            'charge_type': charge.charge_type,
            'rate_percentage': float(rate),
            'basis': charge.basis_of_calculation,
            'base_amount': float(base_amount),
            'calculated_amount': float(amount),
            'account_head': charge.account_head or '',
            'govt_reference': charge.govt_reference or '',
        }
    
    def calculate_all_deductions(
        self,
        gross_amount: Decimal,
        works_component: Optional[Decimal] = None,
        material_cost: Optional[Decimal] = None,
        labour_cost: Optional[Decimal] = None,
        exclude_charges: Optional[List[str]] = None
    ) -> Dict[str, List[Dict]]:
        """
        Calculate all applicable ETP deductions and recoveries.
        
        Args:
            gross_amount: The gross bill amount
            works_component: Optional works component amount
            material_cost: Optional material cost
            labour_cost: Optional labour cost
            exclude_charges: List of charge codes to exclude
            
        Returns:
            Dict with 'deductions', 'recoveries', 'levies', 'additions' keys
        """
        gross_amount = Decimal(str(gross_amount))
        works_component = Decimal(str(works_component)) if works_component else None
        material_cost = Decimal(str(material_cost)) if material_cost else None
        labour_cost = Decimal(str(labour_cost)) if labour_cost else None
        exclude_charges = exclude_charges or []
        
        charges = self.get_active_charges()
        
        result = {
            'deductions': [],
            'recoveries': [],
            'levies': [],
            'additions': [],
        }
        
        for charge in charges:
            if charge.code in exclude_charges:
                continue
                
            calculated = self.calculate_single_charge(
                charge,
                gross_amount,
                works_component,
                material_cost,
                labour_cost
            )
            
            # Categorize by charge type
            type_key = {
                'Deduction': 'deductions',
                'Recovery': 'recoveries',
                'Levy': 'levies',
                'Addition': 'additions',
            }.get(charge.charge_type, 'deductions')
            
            result[type_key].append(calculated)
        
        return result
    
    def get_total_deductions(self, calculated_charges: Dict[str, List[Dict]]) -> Decimal:
        """
        Sum up all deductions, recoveries, and levies.
        
        Args:
            calculated_charges: Result from calculate_all_deductions
            
        Returns:
            Total deduction amount
        """
        total = Decimal('0')
        
        for key in ['deductions', 'recoveries', 'levies']:
            for charge in calculated_charges.get(key, []):
                total += Decimal(str(charge['calculated_amount']))
        
        return total.quantize(self.PRECISION, rounding=ROUND_HALF_UP)
    
    def get_total_additions(self, calculated_charges: Dict[str, List[Dict]]) -> Decimal:
        """
        Sum up all additions.
        
        Args:
            calculated_charges: Result from calculate_all_deductions
            
        Returns:
            Total additions amount
        """
        total = Decimal('0')
        
        for charge in calculated_charges.get('additions', []):
            total += Decimal(str(charge['calculated_amount']))
        
        return total.quantize(self.PRECISION, rounding=ROUND_HALF_UP)
    
    def calculate_net_payable(
        self,
        gross_amount: Decimal,
        gst_amount: Decimal,
        calculated_charges: Dict[str, List[Dict]],
        other_deductions: Decimal = Decimal('0'),
        advances_recovery: Decimal = Decimal('0')
    ) -> Decimal:
        """
        Calculate the final net payable amount.
        
        Formula: Gross + GST + Additions - Deductions - Recoveries - Levies - Other - Advances
        
        Args:
            gross_amount: Gross bill value
            gst_amount: GST amount
            calculated_charges: Result from calculate_all_deductions
            other_deductions: Any manual/other deductions
            advances_recovery: Mobilization/material advance recovery
            
        Returns:
            Net payable amount
        """
        gross_amount = Decimal(str(gross_amount))
        gst_amount = Decimal(str(gst_amount))
        other_deductions = Decimal(str(other_deductions))
        advances_recovery = Decimal(str(advances_recovery))
        
        total_deductions = self.get_total_deductions(calculated_charges)
        total_additions = self.get_total_additions(calculated_charges)
        
        net_payable = (
            gross_amount 
            + gst_amount 
            + total_additions 
            - total_deductions 
            - other_deductions 
            - advances_recovery
        )
        
        return net_payable.quantize(self.PRECISION, rounding=ROUND_HALF_UP)
    
    def generate_bill_summary(
        self,
        gross_amount: Decimal,
        gst_percentage: Decimal = Decimal('18'),
        works_component: Optional[Decimal] = None,
        material_cost: Optional[Decimal] = None,
        labour_cost: Optional[Decimal] = None,
        other_deductions: Decimal = Decimal('0'),
        advances_recovery: Decimal = Decimal('0'),
        retention_percentage: Decimal = Decimal('0')
    ) -> Dict:
        """
        Generate a complete bill calculation summary.
        
        Args:
            gross_amount: Gross bill value
            gst_percentage: GST percentage to apply
            works_component: Optional works component
            material_cost: Optional material cost
            labour_cost: Optional labour cost
            other_deductions: Manual deductions
            advances_recovery: Advance recovery amount
            retention_percentage: Security deposit percentage
            
        Returns:
            Complete bill summary with all calculations
        """
        gross_amount = Decimal(str(gross_amount))
        gst_percentage = Decimal(str(gst_percentage))
        
        # Calculate GST
        gst_amount = (gross_amount * gst_percentage / Decimal('100')).quantize(
            self.PRECISION, rounding=ROUND_HALF_UP
        )
        
        total_before_deductions = gross_amount + gst_amount
        
        # Calculate retention/security deposit
        retention_amount = Decimal('0')
        if retention_percentage > 0:
            retention_amount = (gross_amount * Decimal(str(retention_percentage)) / Decimal('100')).quantize(
                self.PRECISION, rounding=ROUND_HALF_UP
            )
        
        # Calculate all ETP charges
        calculated_charges = self.calculate_all_deductions(
            gross_amount,
            works_component,
            material_cost,
            labour_cost
        )
        
        total_statutory_deductions = self.get_total_deductions(calculated_charges)
        total_additions = self.get_total_additions(calculated_charges)
        
        # Calculate net payable
        net_payable = self.calculate_net_payable(
            gross_amount,
            gst_amount,
            calculated_charges,
            Decimal(str(other_deductions)) + retention_amount,
            Decimal(str(advances_recovery))
        )
        
        return {
            'gross_amount': float(gross_amount),
            'gst_percentage': float(gst_percentage),
            'gst_amount': float(gst_amount),
            'total_before_deductions': float(total_before_deductions),
            
            'statutory_charges': calculated_charges,
            'total_statutory_deductions': float(total_statutory_deductions),
            'total_additions': float(total_additions),
            
            'retention_percentage': float(retention_percentage),
            'retention_amount': float(retention_amount),
            
            'other_deductions': float(other_deductions),
            'advances_recovery': float(advances_recovery),
            
            'total_deductions': float(
                total_statutory_deductions 
                + Decimal(str(other_deductions)) 
                + retention_amount 
                + Decimal(str(advances_recovery))
            ),
            
            'net_payable': float(net_payable),
            
            'calculated_at': self.reference_date.isoformat(),
        }


# Helper function for quick calculations
def calculate_bill_deductions(
    gross_amount: float,
    gst_percentage: float = 18.0,
    retention_percentage: float = 0.0,
    other_deductions: float = 0.0,
    advances_recovery: float = 0.0,
) -> Dict:
    """
    Quick helper to calculate bill deductions.
    
    Args:
        gross_amount: Gross bill value
        gst_percentage: GST percentage (default 18%)
        retention_percentage: Security deposit percentage
        other_deductions: Manual deductions
        advances_recovery: Advance recovery
        
    Returns:
        Complete bill summary
    """
    service = ETPCalculationService()
    return service.generate_bill_summary(
        gross_amount=Decimal(str(gross_amount)),
        gst_percentage=Decimal(str(gst_percentage)),
        retention_percentage=Decimal(str(retention_percentage)),
        other_deductions=Decimal(str(other_deductions)),
        advances_recovery=Decimal(str(advances_recovery)),
    )



================================================
FILE: backend/masters/__init__.py
================================================
[Empty file]


================================================
FILE: backend/masters/admin.py
================================================
from django.contrib import admin
from .models import (
    Zone, Circle, Division, SubDivision,
    District, Town,
    SchemeType, Scheme, WorkType, ProjectCategory,
    Contractor, ContractorBankAccount,
    ETPMaster,
)


# Hierarchy Admin
@admin.register(Zone)
class ZoneAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'state_covered', 'head', 'status')
    list_filter = ('status',)
    search_fields = ('code', 'name', 'state_covered')
    ordering = ('code',)


@admin.register(Circle)
class CircleAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'zone', 'authority_level', 'status')
    list_filter = ('status', 'authority_level', 'zone')
    search_fields = ('code', 'name')
    ordering = ('code',)
    autocomplete_fields = ['zone']


@admin.register(Division)
class DivisionAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'circle', 'hod', 'status')
    list_filter = ('status', 'circle__zone')
    search_fields = ('code', 'name', 'hod')
    ordering = ('code',)
    autocomplete_fields = ['circle']


@admin.register(SubDivision)
class SubDivisionAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'division', 'reporting_officer')
    list_filter = ('division__circle__zone',)
    search_fields = ('code', 'name', 'jurisdiction_area')
    ordering = ('code',)
    autocomplete_fields = ['division']


# Geography Admin
@admin.register(District)
class DistrictAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'state_name', 'pincode_range')
    list_filter = ('state_name',)
    search_fields = ('code', 'name', 'state_name')
    ordering = ('state_name', 'name')


@admin.register(Town)
class TownAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'district', 'classification', 'population')
    list_filter = ('classification', 'district__state_name')
    search_fields = ('code', 'name')
    ordering = ('name',)
    autocomplete_fields = ['district']


# Classification Admin
@admin.register(SchemeType)
class SchemeTypeAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'category')
    list_filter = ('category',)
    search_fields = ('code', 'name')
    ordering = ('code',)


@admin.register(Scheme)
class SchemeAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'scheme_type', 'funding_agency', 'start_date', 'end_date')
    list_filter = ('scheme_type', 'funding_agency')
    search_fields = ('code', 'name')
    ordering = ('code',)
    autocomplete_fields = ['scheme_type']


@admin.register(WorkType)
class WorkTypeAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'sector', 'unit_of_measurement')
    list_filter = ('sector',)
    search_fields = ('code', 'name')
    ordering = ('code',)


@admin.register(ProjectCategory)
class ProjectCategoryAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'threshold_value', 'approval_authority')
    search_fields = ('code', 'name')
    ordering = ('threshold_value',)


# Entity Admin
class ContractorBankAccountInline(admin.TabularInline):
    model = ContractorBankAccount
    extra = 1
    autocomplete_fields = ['bank_branch']


@admin.register(Contractor)
class ContractorAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'contractor_type', 'registration_class', 'pan', 'blacklisted', 'validity_date')
    list_filter = ('contractor_type', 'registration_class', 'blacklisted')
    search_fields = ('code', 'name', 'pan', 'gstin')
    ordering = ('name',)
    inlines = [ContractorBankAccountInline]
    
    fieldsets = (
        ('Basic Information', {
            'fields': ('code', 'name', 'contractor_type', 'registration_class', 'registration_number')
        }),
        ('Tax Details', {
            'fields': ('pan', 'gstin', 'tds_rate')
        }),
        ('Contact', {
            'fields': ('contact_person', 'email', 'phone', 'address')
        }),
        ('Status', {
            'fields': ('blacklisted', 'blacklist_reason', 'validity_date')
        }),
    )


# ETP Admin
@admin.register(ETPMaster)
class ETPMasterAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'charge_type', 'rate_percentage', 'basis_of_calculation', 'effective_date', 'is_active')
    list_filter = ('charge_type', 'basis_of_calculation', 'is_active')
    search_fields = ('code', 'name', 'govt_reference')
    ordering = ('charge_type', 'code')
    
    fieldsets = (
        ('Identification', {
            'fields': ('code', 'name', 'charge_type')
        }),
        ('Rate Configuration', {
            'fields': ('rate_percentage', 'basis_of_calculation')
        }),
        ('Policy Reference', {
            'fields': ('effective_date', 'govt_reference', 'account_head')
        }),
        ('Status', {
            'fields': ('is_active',)
        }),
    )



================================================
FILE: backend/masters/apps.py
================================================
from django.apps import AppConfig


class MastersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'masters'
    verbose_name = 'Master Data'



================================================
FILE: backend/masters/serializers.py
================================================
from rest_framework import serializers
from .models import (
    Zone, Circle, Division, SubDivision,
    District, Town,
    SchemeType, Scheme, WorkType, ProjectCategory,
    Contractor, ContractorBankAccount,
    ETPMaster,
    Country, State, LocationDistrict, City)


# Hierarchy Serializers
class ZoneSerializer(serializers.ModelSerializer):
    class Meta:
        model = Zone
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


class CircleSerializer(serializers.ModelSerializer):
    zone_name = serializers.CharField(source='zone.name', read_only=True)
    
    class Meta:
        model = Circle
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


class DivisionSerializer(serializers.ModelSerializer):
    circle_name = serializers.CharField(source='circle.name', read_only=True)
    zone_name = serializers.CharField(source='circle.zone.name', read_only=True)
    
    class Meta:
        model = Division
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


class SubDivisionSerializer(serializers.ModelSerializer):
    division_name = serializers.CharField(source='division.name', read_only=True)
    
    class Meta:
        model = SubDivision
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


# Geography Serializers
class DistrictSerializer(serializers.ModelSerializer):
    class Meta:
        model = District
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


class TownSerializer(serializers.ModelSerializer):
    district_name = serializers.CharField(source='district.name', read_only=True)
    
    class Meta:
        model = Town
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


# Classification Serializers
class SchemeTypeSerializer(serializers.ModelSerializer):
    class Meta:
        model = SchemeType
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


class SchemeSerializer(serializers.ModelSerializer):
    scheme_type_name = serializers.CharField(source='scheme_type.name', read_only=True)
    
    class Meta:
        model = Scheme
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


class WorkTypeSerializer(serializers.ModelSerializer):
    class Meta:
        model = WorkType
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


class ProjectCategorySerializer(serializers.ModelSerializer):
    class Meta:
        model = ProjectCategory
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


# Entity Serializers
class ContractorBankAccountSerializer(serializers.ModelSerializer):
    bank_name = serializers.CharField(source='bank_branch.bank_name', read_only=True)
    ifsc_code = serializers.CharField(source='bank_branch.ifsc_code', read_only=True)
    
    class Meta:
        model = ContractorBankAccount
        fields = ['id', 'bank_branch', 'bank_name', 'ifsc_code', 'account_number', 'account_type', 'is_primary']


class ContractorSerializer(serializers.ModelSerializer):
    bank_account_details = ContractorBankAccountSerializer(many=True, read_only=True)
    is_valid = serializers.BooleanField(read_only=True)
    
    class Meta:
        model = Contractor
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


class ContractorListSerializer(serializers.ModelSerializer):
    """Lighter serializer for list views with blacklist status"""
    is_valid = serializers.BooleanField(read_only=True)
    status_label = serializers.SerializerMethodField()
    
    class Meta:
        model = Contractor
        fields = ['id', 'code', 'name', 'contractor_type', 'registration_class', 
                  'blacklisted', 'blacklist_reason', 'validity_date', 'is_valid', 'status_label']
    
    def get_status_label(self, obj):
        """Return user-friendly status label for UI"""
        if obj.blacklisted:
            return 'Blacklisted'
        if not obj.is_valid:
            return 'Expired'
        return 'Active'


# Finance Config Serializers
class ETPMasterSerializer(serializers.ModelSerializer):
    class Meta:
        model = ETPMaster
        fields = '__all__'
        read_only_fields = ('id', 'created_at', 'updated_at')


# Nested/Chained Serializers for dropdowns
class CircleNestedSerializer(serializers.ModelSerializer):
    """For chained dropdown: Zone -> Circle"""
    class Meta:
        model = Circle
        fields = ['id', 'code', 'name', 'authority_level', 'status']


class DivisionNestedSerializer(serializers.ModelSerializer):
    """For chained dropdown: Circle -> Division"""
    class Meta:
        model = Division
        fields = ['id', 'code', 'name', 'hod', 'status']


class SubDivisionNestedSerializer(serializers.ModelSerializer):
    """For chained dropdown: Division -> SubDivision"""
    class Meta:
        model = SubDivision
        fields = ['id', 'code', 'name', 'jurisdiction_area']


class TownNestedSerializer(serializers.ModelSerializer):
    """For chained dropdown: District -> Town"""
    class Meta:
        model = Town
        fields = ['id', 'code', 'name', 'classification']

# ========== Location Serializers (Country -> State -> City) ==========

class CountrySerializer(serializers.ModelSerializer):
    """Serializer for Country model"""
    class Meta:
        model = Country
        fields = ['id', 'name', 'code', 'dial_code', 'is_active']
        read_only_fields = ['id']


class StateNestedSerializer(serializers.ModelSerializer):
    """Nested serializer for State (used in cascading dropdowns)"""
    class Meta:
        model = State
        fields = ['id', 'name', 'code']


class StateSerializer(serializers.ModelSerializer):
    """Full serializer for State model"""
    country_name = serializers.CharField(source='country.name', read_only=True)
    
    class Meta:
        model = State
        fields = ['id', 'country', 'country_name', 'name', 'code', 'is_active']
        read_only_fields = ['id']



class LocationDistrictNestedSerializer(serializers.ModelSerializer):
    """Nested serializer for LocationDistrict (used in cascading dropdowns)"""
    class Meta:
        model = LocationDistrict
        fields = ['id', 'name', 'code']


class LocationDistrictSerializer(serializers.ModelSerializer):
    """Full serializer for LocationDistrict model"""
    state_name = serializers.CharField(source='state.name', read_only=True)
    country_name = serializers.CharField(source='state.country.name', read_only=True)

    class Meta:
        model = LocationDistrict
        fields = ['id', 'state', 'state_name', 'country_name', 'name', 'code', 'is_active']
        read_only_fields = ['id']


class CityNestedSerializer(serializers.ModelSerializer):
    """Nested serializer for City (used in cascading dropdowns)"""
    class Meta:
        model = City
        fields = ['id', 'name', 'code']


class CitySerializer(serializers.ModelSerializer):
    """Full serializer for City model"""
    district_name = serializers.CharField(source='district.name', read_only=True)
    state_name = serializers.CharField(source='district.state.name', read_only=True)
    country_name = serializers.CharField(source='district.state.country.name', read_only=True)
    
    class Meta:
        model = City
        fields = ['id', 'district', 'district_name', 'state_name', 'country_name', 'name', 'code', 'is_active']
        read_only_fields = ['id']



================================================
FILE: backend/masters/urls.py
================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import (
    ZoneViewSet, CircleViewSet, DivisionViewSet, SubDivisionViewSet,
    DistrictViewSet, TownViewSet,
    SchemeTypeViewSet, SchemeViewSet, WorkTypeViewSet, ProjectCategoryViewSet,
    ContractorViewSet, ContractorBankAccountViewSet,
    ETPMasterViewSet,
    ETPMasterViewSet,
    CountryViewSet, StateViewSet, LocationDistrictViewSet, CityViewSet,
)

router = DefaultRouter()

# Hierarchy
router.register(r'zones', ZoneViewSet, basename='zone')
router.register(r'circles', CircleViewSet, basename='circle')
router.register(r'divisions', DivisionViewSet, basename='division')
router.register(r'subdivisions', SubDivisionViewSet, basename='subdivision')

# Geography
router.register(r'districts', DistrictViewSet, basename='district')
router.register(r'towns', TownViewSet, basename='town')

# Classification
router.register(r'scheme-types', SchemeTypeViewSet, basename='scheme-type')
router.register(r'schemes', SchemeViewSet, basename='scheme')
router.register(r'work-types', WorkTypeViewSet, basename='work-type')
router.register(r'project-categories', ProjectCategoryViewSet, basename='project-category')

# Entities
router.register(r'contractors', ContractorViewSet, basename='contractor')
router.register(r'contractor-bank-accounts', ContractorBankAccountViewSet, basename='contractor-bank-account')

# Finance Config
router.register(r'etp-charges', ETPMasterViewSet, basename='etp-charge')

# Locations (Country -> State -> District -> City)
router.register(r'countries', CountryViewSet, basename='country')
router.register(r'states', StateViewSet, basename='state')
router.register(r'location-districts', LocationDistrictViewSet, basename='location-district')
router.register(r'cities', CityViewSet, basename='city')

urlpatterns = [
    path('', include(router.urls)),
]



================================================
FILE: backend/masters/views.py
================================================
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import SearchFilter, OrderingFilter
from django.db import models

from .models import (
    Zone, Circle, Division, SubDivision,
    District, Town,
    SchemeType, Scheme, WorkType, ProjectCategory,
    Contractor, ContractorBankAccount,
    ETPMaster,
    ETPMaster,
    Country, State, LocationDistrict, City,
)
from .serializers import (
    ZoneSerializer, CircleSerializer, DivisionSerializer, SubDivisionSerializer,
    DistrictSerializer, TownSerializer,
    SchemeTypeSerializer, SchemeSerializer, WorkTypeSerializer, ProjectCategorySerializer,
    ContractorSerializer, ContractorListSerializer, ContractorBankAccountSerializer,
    ETPMasterSerializer,
    CircleNestedSerializer, DivisionNestedSerializer, SubDivisionNestedSerializer, TownNestedSerializer,
    CountrySerializer, StateSerializer, CitySerializer,
    CountrySerializer, StateSerializer, CitySerializer,
    StateNestedSerializer, CityNestedSerializer, LocationDistrictSerializer, LocationDistrictNestedSerializer,
)


class IsSuperUserOrReadOnly(permissions.BasePermission):
    """
    Custom permission: 
    - All authenticated users can READ
    - Only superusers or Master_Data_Managers group can CREATE/UPDATE/DELETE
    """
    def has_permission(self, request, view):
        # Allow read-only for all authenticated users
        if request.method in permissions.SAFE_METHODS:
            return request.user and request.user.is_authenticated
        
        # Write permissions only for superusers or Master_Data_Managers group
        if not request.user or not request.user.is_authenticated:
            return False
        
        if request.user.is_superuser:
            return True
        
        # Check for Master_Data_Managers group
        return request.user.groups.filter(name='Master_Data_Managers').exists()


class BaseMasterViewSet(viewsets.ModelViewSet):
    """Base viewset with common settings for all masters"""
    permission_classes = [IsSuperUserOrReadOnly]
    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]


# ========== Hierarchy ViewSets ==========

class ZoneViewSet(BaseMasterViewSet):
    queryset = Zone.objects.all()
    serializer_class = ZoneSerializer
    filterset_fields = ['status']
    search_fields = ['code', 'name', 'state_covered']
    ordering_fields = ['code', 'name']
    
    @action(detail=True, methods=['get'])
    def circles(self, request, pk=None):
        """Get all circles under this zone"""
        zone = self.get_object()
        circles = zone.circles.filter(status='Active')
        serializer = CircleNestedSerializer(circles, many=True)
        return Response(serializer.data)


class CircleViewSet(BaseMasterViewSet):
    queryset = Circle.objects.select_related('zone').all()
    serializer_class = CircleSerializer
    filterset_fields = ['status', 'authority_level', 'zone']
    search_fields = ['code', 'name']
    ordering_fields = ['code', 'name']
    
    @action(detail=True, methods=['get'])
    def divisions(self, request, pk=None):
        """Get all divisions under this circle"""
        circle = self.get_object()
        divisions = circle.divisions.filter(status='Active')
        serializer = DivisionNestedSerializer(divisions, many=True)
        return Response(serializer.data)


class DivisionViewSet(BaseMasterViewSet):
    queryset = Division.objects.select_related('circle', 'circle__zone').all()
    serializer_class = DivisionSerializer
    filterset_fields = ['status', 'circle']
    search_fields = ['code', 'name', 'hod']
    ordering_fields = ['code', 'name']
    
    @action(detail=True, methods=['get'])
    def subdivisions(self, request, pk=None):
        """Get all subdivisions under this division"""
        division = self.get_object()
        subdivisions = division.subdivisions.all()
        serializer = SubDivisionNestedSerializer(subdivisions, many=True)
        return Response(serializer.data)


class SubDivisionViewSet(BaseMasterViewSet):
    queryset = SubDivision.objects.select_related('division', 'division__circle').all()
    serializer_class = SubDivisionSerializer
    filterset_fields = ['division']
    search_fields = ['code', 'name', 'jurisdiction_area']
    ordering_fields = ['code', 'name']


# ========== Geography ViewSets ==========

class DistrictViewSet(BaseMasterViewSet):
    queryset = District.objects.all()
    serializer_class = DistrictSerializer
    filterset_fields = ['state_name']
    search_fields = ['code', 'name', 'state_name']
    ordering_fields = ['state_name', 'name']
    
    @action(detail=True, methods=['get'])
    def towns(self, request, pk=None):
        """Get all towns under this district"""
        district = self.get_object()
        towns = district.towns.all()
        serializer = TownNestedSerializer(towns, many=True)
        return Response(serializer.data)


class TownViewSet(BaseMasterViewSet):
    queryset = Town.objects.select_related('district').all()
    serializer_class = TownSerializer
    filterset_fields = ['classification', 'district']
    search_fields = ['code', 'name']
    ordering_fields = ['name']


# ========== Classification ViewSets ==========

class SchemeTypeViewSet(BaseMasterViewSet):
    queryset = SchemeType.objects.all()
    serializer_class = SchemeTypeSerializer
    filterset_fields = ['category']
    search_fields = ['code', 'name']
    ordering_fields = ['code', 'name']


class SchemeViewSet(BaseMasterViewSet):
    queryset = Scheme.objects.select_related('scheme_type').all()
    serializer_class = SchemeSerializer
    filterset_fields = ['scheme_type', 'funding_agency']
    search_fields = ['code', 'name', 'funding_agency']
    ordering_fields = ['code', 'name']


class WorkTypeViewSet(BaseMasterViewSet):
    queryset = WorkType.objects.all()
    serializer_class = WorkTypeSerializer
    filterset_fields = ['sector']
    search_fields = ['code', 'name']
    ordering_fields = ['code', 'name']


class ProjectCategoryViewSet(BaseMasterViewSet):
    queryset = ProjectCategory.objects.all()
    serializer_class = ProjectCategorySerializer
    search_fields = ['code', 'name']
    ordering_fields = ['threshold_value', 'code']
    
    @action(detail=False, methods=['get'])
    def suggest_category(self, request):
        """
        Auto-suggest project category based on contract value.
        
        Query params:
            contract_value: The project's contract value in INR
            
        Returns:
            Matching category based on threshold comparison.
            Categories are ordered by threshold (descending), and the first
            category where contract_value >= threshold is returned.
        """
        from decimal import Decimal
        
        contract_value = request.query_params.get('contract_value')
        if not contract_value:
            return Response({
                'error': 'contract_value query parameter is required'
            }, status=400)
        
        try:
            value = Decimal(str(contract_value))
        except:
            return Response({
                'error': 'Invalid contract_value format'
            }, status=400)
        
        # Get categories ordered by threshold descending
        # Find first category where value >= threshold
        categories = ProjectCategory.objects.order_by('-threshold_value')
        
        matched_category = None
        for category in categories:
            if value >= category.threshold_value:
                matched_category = category
                break
        
        # If no match (value less than all thresholds), use the lowest threshold category
        if not matched_category and categories.exists():
            matched_category = categories.last()  # Lowest threshold
        
        if matched_category:
            return Response({
                'suggested_category': {
                    'id': str(matched_category.id),
                    'code': matched_category.code,
                    'name': matched_category.name,
                    'threshold_value': float(matched_category.threshold_value),
                    'approval_authority': matched_category.approval_authority,
                },
                'contract_value': float(value),
                'message': f"Based on â‚¹{value:,.0f} contract value, suggested category is '{matched_category.name}'"
            })
        else:
            return Response({
                'suggested_category': None,
                'contract_value': float(value),
                'message': 'No project categories configured. Please add categories in Master Data.'
            })



# ========== Entity ViewSets ==========

class ContractorViewSet(BaseMasterViewSet):
    queryset = Contractor.objects.prefetch_related('bank_account_details').all()
    filterset_fields = ['contractor_type', 'registration_class', 'blacklisted']
    search_fields = ['code', 'name', 'pan', 'gstin']
    ordering_fields = ['name', 'code']
    
    def get_serializer_class(self):
        if self.action == 'list':
            return ContractorListSerializer
        return ContractorSerializer
    
    @action(detail=False, methods=['get'])
    def active(self, request):
        """Get only active (non-blacklisted, valid) contractors"""
        from django.utils import timezone
        today = timezone.now().date()
        contractors = self.queryset.filter(
            blacklisted=False
        ).filter(
            models.Q(validity_date__isnull=True) | models.Q(validity_date__gte=today)
        )
        serializer = ContractorListSerializer(contractors, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def active_with_accounts(self, request):
        """
        Get active contractors with linked user accounts.
        
        This endpoint is used for package creation to ensure selected contractors
        can receive notifications via email and in-app.
        
        Returns:
            List of active contractors who have linked_user accounts
        """
        from django.utils import timezone
        today = timezone.now().date()
        
        contractors = self.queryset.filter(
            blacklisted=False,
            linked_user__isnull=False  # Must have linked user account
        ).filter(
            models.Q(validity_date__isnull=True) | models.Q(validity_date__gte=today)
        ).select_related('linked_user')
        
        serializer = ContractorListSerializer(contractors, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['post'])
    def sync_from_users(self, request):
        """
        Create Contractor master records for all EPC_Contractor users 
        who don't have a linked contractor profile.
        """
        from django.contrib.auth import get_user_model
        User = get_user_model()
        
        # Find EPC Contractor users with active status but no linked contractor
        epc_users = User.objects.filter(
            role='EPC_Contractor',
            account_status='ACTIVE',
            contractor_profile__isnull=True
        )
        
        created_count = 0
        linked_count = 0
        errors = []
        
        for user in epc_users:
            try:
                # Check if a contractor already exists with same PAN
                if user.pan_number:
                    existing = Contractor.objects.filter(pan=user.pan_number).first()
                    if existing:
                        existing.linked_user = user
                        existing.save()
                        linked_count += 1
                        continue
                
                # Generate unique contractor code
                last_contractor = Contractor.objects.order_by('-created_at').last()
                if last_contractor and last_contractor.code.startswith('CON-'):
                    try:
                        last_num = int(last_contractor.code.split('-')[1])
                        next_num = last_num + 1
                    except:
                        next_num = Contractor.objects.count() + 1
                else:
                    next_num = Contractor.objects.count() + 1
                code = f"CON-{next_num:04d}"
                
                # Ensure unique code
                while Contractor.objects.filter(code=code).exists():
                    next_num += 1
                    code = f"CON-{next_num:04d}"
                
                # Create contractor record
                Contractor.objects.create(
                    code=code,
                    name=user.company_name or f"{user.first_name} {user.last_name}",
                    contractor_type='Proprietorship',
                    registration_class=getattr(user, 'registration_class', '') or '',
                    pan=user.pan_number or '',
                    gstin=getattr(user, 'gstin_number', '') or '',
                    contact_person=f"{user.first_name} {user.last_name}",
                    email=user.email,
                    phone=user.phone_number or '',
                    address=getattr(user, 'full_address', '') or '',
                    blacklisted=False,
                    linked_user=user,
                )
                created_count += 1
            except Exception as e:
                errors.append(f"User {user.email}: {str(e)}")
        
        return Response({
            'message': f'Sync completed. Created {created_count} new contractors, linked {linked_count} existing.',
            'created': created_count,
            'linked': linked_count,
            'total_epc_users': epc_users.count(),
            'errors': errors if errors else None
        })


class ContractorBankAccountViewSet(BaseMasterViewSet):
    queryset = ContractorBankAccount.objects.select_related('contractor', 'bank_branch').all()
    serializer_class = ContractorBankAccountSerializer
    filterset_fields = ['contractor', 'is_primary']


# ========== Finance Config ViewSets ==========

class ETPMasterViewSet(BaseMasterViewSet):
    queryset = ETPMaster.objects.all()
    serializer_class = ETPMasterSerializer
    filterset_fields = ['charge_type', 'basis_of_calculation', 'is_active']
    search_fields = ['code', 'name', 'govt_reference']
    ordering_fields = ['charge_type', 'code', 'rate_percentage']
    
    @action(detail=False, methods=['get'])
    def active(self, request):
        """Get only active ETP charges"""
        charges = ETPMaster.get_active_charges()
        serializer = self.get_serializer(charges, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def deductions(self, request):
        """Get active deduction charges"""
        charges = ETPMaster.get_active_charges(charge_type='Deduction')
        serializer = self.get_serializer(charges, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def recoveries(self, request):
        """Get active recovery charges"""
        charges = ETPMaster.get_active_charges(charge_type='Recovery')
        serializer = self.get_serializer(charges, many=True)
        return Response(serializer.data)

# ========== Location ViewSets (Country -> State -> City) ==========

class CountryViewSet(BaseMasterViewSet):
    """
    Country master data ViewSet
    Currently returns India only, expandable to more countries
    Uses AllowAny for read operations (needed for contractor registration)
    """
    permission_classes = [permissions.AllowAny]
    queryset = Country.objects.filter(is_active=True)
    serializer_class = CountrySerializer
    search_fields = ['name', 'code']
    ordering_fields = ['name']
    
    @action(detail=True, methods=['get'])
    def states(self, request, pk=None):
        """Get all states for this country"""
        country = self.get_object()
        states = country.states.filter(is_active=True)
        serializer = StateNestedSerializer(states, many=True)
        return Response(serializer.data)


class StateViewSet(BaseMasterViewSet):
    """
    State/Province master data ViewSet
    Filterable by country for cascading dropdowns
    Uses AllowAny for read operations (needed for contractor registration)
    """
    permission_classes = [permissions.AllowAny]
    queryset = State.objects.select_related('country').filter(is_active=True)
    serializer_class = StateSerializer
    filterset_fields = ['country']
    search_fields = ['name', 'code']
    ordering_fields = ['name']
    
    @action(detail=True, methods=['get'])
    def districts(self, request, pk=None):
        """Get all districts for this state"""
        state = self.get_object()
        districts = state.location_districts.filter(is_active=True)
        serializer = LocationDistrictNestedSerializer(districts, many=True)
        return Response(serializer.data)


class LocationDistrictViewSet(BaseMasterViewSet):
    """
    District master data ViewSet (between State and City)
    Filterable by state for cascading dropdowns
    Uses AllowAny for read operations (needed for contractor registration)
    """
    permission_classes = [permissions.AllowAny]
    queryset = LocationDistrict.objects.select_related('state', 'state__country').filter(is_active=True)
    serializer_class = LocationDistrictSerializer
    filterset_fields = ['state']
    search_fields = ['name', 'code']
    ordering_fields = ['name']
    
    @action(detail=True, methods=['get'])
    def cities(self, request, pk=None):
        """Get all cities for this district"""
        district = self.get_object()
        cities = district.cities.filter(is_active=True)
        serializer = CityNestedSerializer(cities, many=True)
        return Response(serializer.data)


class CityViewSet(BaseMasterViewSet):
    """
    City master data ViewSet
    Filterable by district (was state) for cascading dropdowns
    Uses AllowAny for read operations (needed for contractor registration)
    """
    permission_classes = [permissions.AllowAny]
    queryset = City.objects.select_related('district', 'district__state', 'district__state__country').filter(is_active=True)
    serializer_class = CitySerializer
    filterset_fields = ['district']
    search_fields = ['name', 'code']
    ordering_fields = ['name']



================================================
FILE: backend/masters/management/__init__.py
================================================
# This file makes the management directory a Python package



================================================
FILE: backend/masters/management/commands/__init__.py
================================================
# This file makes the commands directory a Python package



================================================
FILE: backend/masters/management/commands/check_contractor_validity.py
================================================
"""
Management command to check contractor validity and mark expired ones as inactive.

This command should be run daily via cron or Celery beat to:
1. Check all contractors with validity_date < today
2. Mark them as expired (optional: set a status field or send notifications)
3. Log the results

Usage:
    python manage.py check_contractor_validity
    python manage.py check_contractor_validity --dry-run  # Preview without changes
    python manage.py check_contractor_validity --notify   # Send email notifications
"""
from django.core.management.base import BaseCommand
from django.utils import timezone
from masters.models import Contractor


class Command(BaseCommand):
    help = 'Check contractor registration validity and mark expired contractors'

    def add_arguments(self, parser):
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Preview what would happen without making changes',
        )
        parser.add_argument(
            '--notify',
            action='store_true',
            help='Send notification emails for expiring contractors',
        )
        parser.add_argument(
            '--days-warning',
            type=int,
            default=30,
            help='Days before expiry to send warning (default: 30)',
        )

    def handle(self, *args, **options):
        today = timezone.now().date()
        dry_run = options['dry_run']
        notify = options['notify']
        warning_days = options['days_warning']
        
        self.stdout.write(self.style.NOTICE(f'\nğŸ“‹ Contractor Validity Check - {today}'))
        self.stdout.write('=' * 50)
        
        # 1. Find already expired contractors (not blacklisted)
        expired_contractors = Contractor.objects.filter(
            validity_date__lt=today,
            blacklisted=False
        )
        
        expired_count = expired_contractors.count()
        self.stdout.write(f'\nğŸ”´ Expired contractors: {expired_count}')
        
        if expired_count > 0:
            for contractor in expired_contractors:
                days_expired = (today - contractor.validity_date).days
                self.stdout.write(
                    f'   - {contractor.code}: {contractor.name} '
                    f'(expired {days_expired} days ago on {contractor.validity_date})'
                )
        
        # 2. Find contractors expiring soon (warning)
        from datetime import timedelta
        warning_date = today + timedelta(days=warning_days)
        
        expiring_soon = Contractor.objects.filter(
            validity_date__gte=today,
            validity_date__lte=warning_date,
            blacklisted=False
        )
        
        expiring_count = expiring_soon.count()
        self.stdout.write(f'\nğŸŸ¡ Expiring within {warning_days} days: {expiring_count}')
        
        if expiring_count > 0:
            for contractor in expiring_soon:
                days_left = (contractor.validity_date - today).days
                self.stdout.write(
                    f'   - {contractor.code}: {contractor.name} '
                    f'(expires in {days_left} days on {contractor.validity_date})'
                )
        
        # 3. Count active (valid) contractors
        active = Contractor.objects.filter(
            blacklisted=False
        ).filter(
            models.Q(validity_date__isnull=True) | models.Q(validity_date__gte=today)
        )
        
        # Import models for Q
        from django.db import models as db_models
        active = Contractor.objects.filter(
            blacklisted=False
        ).filter(
            db_models.Q(validity_date__isnull=True) | db_models.Q(validity_date__gt=warning_date)
        )
        
        active_count = active.count()
        self.stdout.write(f'\nğŸŸ¢ Active contractors: {active_count}')
        
        # 4. Summary
        total = Contractor.objects.count()
        blacklisted = Contractor.objects.filter(blacklisted=True).count()
        
        self.stdout.write('\n' + '=' * 50)
        self.stdout.write(self.style.SUCCESS(f'ğŸ“Š Summary:'))
        self.stdout.write(f'   Total contractors: {total}')
        self.stdout.write(f'   Active: {active_count}')
        self.stdout.write(f'   Expiring soon: {expiring_count}')
        self.stdout.write(f'   Expired: {expired_count}')
        self.stdout.write(f'   Blacklisted: {blacklisted}')
        
        if dry_run:
            self.stdout.write(self.style.WARNING('\nâš ï¸  DRY RUN - No changes made'))
        
        if notify and not dry_run:
            self.stdout.write(self.style.NOTICE('\nğŸ“§ Sending notifications...'))
            self._send_notifications(expiring_soon, expired_contractors)
        
        return
    
    def _send_notifications(self, expiring_soon, expired):
        """
        Send email notifications for expiring/expired contractors.
        This is a placeholder - implement actual email logic here.
        """
        # TODO: Implement email notifications
        # from django.core.mail import send_mail
        # 
        # For now, just log what would be sent
        for contractor in expiring_soon:
            self.stdout.write(f'   Would notify: {contractor.email or "no email"} about upcoming expiry')
        
        for contractor in expired:
            self.stdout.write(f'   Would notify admins about expired: {contractor.name}')
        
        self.stdout.write(self.style.SUCCESS('   âœ… Notifications would be sent (not implemented yet)'))



================================================
FILE: backend/masters/management/commands/populate_geography.py
================================================
from django.core.management.base import BaseCommand
from masters.models.locations import Country, State


class Command(BaseCommand):
    help = 'Populate Indian geography - Country and States only'

    def handle(self, *args, **options):
        # Create India
        india, created = Country.objects.get_or_create(
            code='IN',
            defaults={'name': 'India', 'dial_code': '+91'}
        )
        if created:
            self.stdout.write(self.style.SUCCESS(f'âœ“ Created country: India'))
        else:
            self.stdout.write(f'âœ“ Country already exists: India')

        # Indian States and Union Territories
        indian_states = [
            'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
            'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand',
            'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur',
            'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab',
            'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura',
            'Uttar Pradesh', 'Uttarakhand', 'West Bengal',
            # Union Territories
            'Andaman and Nicobar Islands', 'Chandigarh', 'Dadra and Nagar Haveli and Daman and Diu',
            'Delhi', 'Jammu and Kashmir', 'Ladakh', 'Lakshadweep', 'Puducherry'
        ]

        states_created = 0
        states_existing = 0

        for state_name in indian_states:
            state, created = State.objects.get_or_create(
                country=india,
                name=state_name,
                defaults={'code': state_name[:3].upper()}
            )
            if created:
                states_created += 1
            else:
                states_existing += 1

        self.stdout.write(self.style.SUCCESS(
            f'âœ“ States: {states_created} created, {states_existing} already existed'
        ))
        
        self.stdout.write(self.style.SUCCESS('\\nâœ… Geography data loaded!'))
        self.stdout.write(f'ğŸ“Š Total: {Country.objects.count()} countries, {State.objects.count()} states')



================================================
FILE: backend/masters/management/commands/populate_india_locations.py
================================================
"""
Command to populate India location master data (Country -> State -> District -> City)
Includes ALL states, UTs, and ALL districts (~766 districts).
"""
from django.core.management.base import BaseCommand
from masters.models import Country, State, LocationDistrict, City
from django.db import transaction

class Command(BaseCommand):
    help = 'Populates India states, districts and cities'

    def handle(self, *args, **options):
        self.stdout.write('Populating India location data...')

        # Data Structure: State -> District -> [Cities]
        # Complete dataset with all 766 districts of India
        INDIA_DATA = {
            "Andaman and Nicobar Islands": {
                "Nicobar": ["Nicobar"],
                "North and Middle Andaman": ["Mayabunder"],
                "South Andaman": ["Port Blair"],
            },
            "Andhra Pradesh": {
                "Alluri Sitharama Raju": ["Paderu"],
                "Anakapalli": ["Anakapalli"],
                "Anantapur": ["Anantapur", "Dharmavaram", "Guntakal", "Hindupur"],
                "Annamayya": ["Rayachoti"],
                "Bapatla": ["Bapatla", "Chirala"],
                "Chittoor": ["Chittoor", "Palamaner"],
                "Dr. B.R. Ambedkar Konaseema": ["Amalapuram"],
                "East Godavari": ["Rajahmundry", "Nidadavole"],
                "Eluru": ["Eluru", "Jangareddigudem"],
                "Guntur": ["Guntur", "Tenali", "Mangalagiri"],
                "Kakinada": ["Kakinada", "Tuni"],
                "Krishna": ["Machilipatnam", "Gudivada"],
                "Kurnool": ["Kurnool", "Adoni"],
                "Nandyal": ["Nandyal", "Dhone"],
                "NTR": ["Vijayawada", "Nuzvid"],
                "Palnadu": ["Narasaraopet", "Sattenapalle"],
                "Parvathipuram Manyam": ["Parvathipuram"],
                "Prakasam": ["Ongole", "Markapur"],
                "Sri Potti Sriramulu Nellore": ["Nellore", "Kavali", "Gudur"],
                "Sri Sathya Sai": ["Puttaparthi", "Kadiri"],
                "Srikakulam": ["Srikakulam", "Palasa"],
                "Tirupati": ["Tirupati", "Srikalahasti"],
                "Visakhapatnam": ["Visakhapatnam", "Bheemunipatnam"],
                "Vizianagaram": ["Vizianagaram", "Bobbili"],
                "West Godavari": ["Bhimavaram", "Tanuku", "Tadepalligudem"],
                "YSR": ["Kadapa", "Proddatur", "Jammalamadugu"],
            },
            "Arunachal Pradesh": {
                "Anjaw": ["Hawai"],
                "Changlang": ["Changlang"],
                "Dibang Valley": ["Anini"],
                "East Kameng": ["Seppa"],
                "East Siang": ["Pasighat"],
                "Kamle": ["Raga"],
                "Kra Daadi": ["Jamin"],
                "Kurung Kumey": ["Koloriang"],
                "Lepa Rada": ["Basar"],
                "Lohit": ["Tezu"],
                "Longding": ["Longding"],
                "Lower Dibang Valley": ["Roing"],
                "Lower Siang": ["Likabali"],
                "Lower Subansiri": ["Ziro"],
                "Namsai": ["Namsai"],
                "Pakke Kessang": ["Lemmi"],
                "Papum Pare": ["Yupia", "Itanagar", "Naharlagun"],
                "Shi Yomi": ["Tato"],
                "Siang": ["Boleng"],
                "Tawang": ["Tawang"],
                "Tirap": ["Khonsa"],
                "Upper Siang": ["Yingkiong"],
                "Upper Subansiri": ["Daporijo"],
                "West Kameng": ["Bomdila"],
                "West Siang": ["Aalo"],
            },
            "Assam": {
                "Bajali": ["Pathsala"],
                "Baksa": ["Mushalpur"],
                "Barpeta": ["Barpeta"],
                "Biswanath": ["Biswanath Chariali"],
                "Bongaigaon": ["Bongaigaon"],
                "Cachar": ["Silchar"],
                "Charaideo": ["Sonari"],
                "Chirang": ["Kajalgaon"],
                "Darrang": ["Mangaldai"],
                "Dhemaji": ["Dhemaji"],
                "Dhubri": ["Dhubri"],
                "Dibrugarh": ["Dibrugarh"],
                "Dima Hasao": ["Haflong"],
                "Goalpara": ["Goalpara"],
                "Golaghat": ["Golaghat"],
                "Hailakandi": ["Hailakandi"],
                "Hojai": ["Hojai"],
                "Jorhat": ["Jorhat"],
                "Kamrup": ["Amingaon"],
                "Kamrup Metropolitan": ["Guwahati", "Dispur"],
                "Karbi Anglong": ["Diphu"],
                "Karimganj": ["Karimganj"],
                "Kokrajhar": ["Kokrajhar"],
                "Lakhimpur": ["North Lakhimpur"],
                "Majuli": ["Garamur"],
                "Morigaon": ["Morigaon"],
                "Nagaon": ["Nagaon"],
                "Nalbari": ["Nalbari"],
                "Sivasagar": ["Sivasagar"],
                "Sonitpur": ["Tezpur"],
                "South Salmara Mankachar": ["Hatsingimari"],
                "Tamulpur": ["Tamulpur"],
                "Tinsukia": ["Tinsukia"],
                "Udalguri": ["Udalguri"],
                "West Karbi Anglong": ["Hamren"],
            },
            "Bihar": {
                "Araria": ["Araria"],
                "Arwal": ["Arwal"],
                "Aurangabad": ["Aurangabad"],
                "Banka": ["Banka"],
                "Begusarai": ["Begusarai"],
                "Bhagalpur": ["Bhagalpur", "Sultanganj"],
                "Bhojpur": ["Arrah"],
                "Buxar": ["Buxar"],
                "Darbhanga": ["Darbhanga"],
                "East Champaran": ["Motihari"],
                "Gaya": ["Gaya", "Bodh Gaya"],
                "Gopalganj": ["Gopalganj"],
                "Jamui": ["Jamui"],
                "Jehanabad": ["Jehanabad"],
                "Kaimur": ["Bhabua"],
                "Katihar": ["Katihar"],
                "Khagaria": ["Khagaria"],
                "Kishanganj": ["Kishanganj"],
                "Lakhisarai": ["Lakhisarai"],
                "Madhepura": ["Madhepura"],
                "Madhubani": ["Madhubani"],
                "Munger": ["Munger"],
                "Muzaffarpur": ["Muzaffarpur"],
                "Nalanda": ["Bihar Sharif"],
                "Nawada": ["Nawada"],
                "Patna": ["Patna", "Danapur"],
                "Purnia": ["Purnia"],
                "Rohtas": ["Sasaram"],
                "Saharsa": ["Saharsa"],
                "Samastipur": ["Samastipur"],
                "Saran": ["Chhapra"],
                "Sheikhpura": ["Sheikhpura"],
                "Sheohar": ["Sheohar"],
                "Sitamarhi": ["Sitamarhi"],
                "Siwan": ["Siwan"],
                "Supaul": ["Supaul"],
                "Vaishali": ["Hajipur"],
                "West Champaran": ["Bettiah"],
            },
            "Chandigarh": {
                "Chandigarh": ["Chandigarh"],
            },
            "Chhattisgarh": {
                "Balod": ["Balod"],
                "Baloda Bazar": ["Baloda Bazar"],
                "Balrampur": ["Balrampur"],
                "Bastar": ["Jagdalpur"],
                "Bemetara": ["Bemetara"],
                "Bijapur": ["Bijapur"],
                "Bilaspur": ["Bilaspur"],
                "Dantewada": ["Dantewada"],
                "Dhamtari": ["Dhamtari"],
                "Durg": ["Durg", "Bhilai"],
                "Gariaband": ["Gariaband"],
                "Gaurela-Pendra-Marwahi": ["Gaurela"],
                "Janjgir-Champa": ["Janjgir"],
                "Jashpur": ["Jashpur Nagar"],
                "Kabirdham": ["Kawardha"],
                "Kanker": ["Kanker"],
                "Khairagarh-Chhuikhadan-Gandai": ["Khairagarh"],
                "Kondagaon": ["Kondagaon"],
                "Korba": ["Korba"],
                "Koriya": ["Baikunthpur"],
                "Mahasamund": ["Mahasamund"],
                "Manendragarh-Chirmiri-Bharatpur": ["Manendragarh"],
                "Mohla-Manpur-Ambagarh Chowki": ["Mohla"],
                "Mungeli": ["Mungeli"],
                "Narayanpur": ["Narayanpur"],
                "Raigarh": ["Raigarh"],
                "Raipur": ["Raipur"],
                "Rajnandgaon": ["Rajnandgaon"],
                "Sarangarh-Bilaigarh": ["Sarangarh"],
                "Shakti": ["Shakti"],
                "Sukma": ["Sukma"],
                "Surajpur": ["Surajpur"],
                "Surguja": ["Ambikapur"],
            },
            "Dadra and Nagar Haveli and Daman and Diu": {
                "Dadra and Nagar Haveli": ["Silvassa"],
                "Daman": ["Daman"],
                "Diu": ["Diu"],
            },
            "Delhi": {
                "Central Delhi": ["Daryaganj", "Karol Bagh"],
                "East Delhi": ["Preet Vihar", "Mayur Vihar"],
                "New Delhi": ["Connaught Place", "Chanakyapuri"],
                "North Delhi": ["Sadar Bazar", "Civil Lines"],
                "North East Delhi": ["Seelampur", "Shahdara"],
                "North West Delhi": ["Kanjhawala", "Rohini"],
                "Shahdara": ["Shahdara"],
                "South Delhi": ["Saket", "Hauz Khas"],
                "South East Delhi": ["Defence Colony", "Kalkaji"],
                "South West Delhi": ["Dwarka", "Vasant Kunj"],
                "West Delhi": ["Rajouri Garden", "Punjabi Bagh"],
            },
            "Goa": {
                "North Goa": ["Panaji", "Mapusa", "Bicholim"],
                "South Goa": ["Margao", "Vasco da Gama", "Ponda"],
            },
            "Gujarat": {
                "Ahmedabad": ["Ahmedabad", "Sanand", "Dholka"],
                "Amreli": ["Amreli"],
                "Anand": ["Anand"],
                "Aravalli": ["Modasa"],
                "Banaskantha": ["Palanpur"],
                "Bharuch": ["Bharuch", "Ankleshwar"],
                "Bhavnagar": ["Bhavnagar", "Palitana"],
                "Botad": ["Botad"],
                "Chhota Udaipur": ["Chhota Udaipur"],
                "Dahod": ["Dahod"],
                "Dang": ["Ahwa"],
                "Devbhoomi Dwarka": ["Khambhalia", "Dwarka"],
                "Gandhinagar": ["Gandhinagar"],
                "Gir Somnath": ["Veraval"],
                "Jamnagar": ["Jamnagar"],
                "Junagadh": ["Junagadh"],
                "Kheda": ["Nadiad"],
                "Kutch": ["Bhuj", "Gandhidham", "Anjar", "Mandvi"],
                "Mahisagar": ["Lunavada"],
                "Mehsana": ["Mehsana"],
                "Morbi": ["Morbi"],
                "Narmada": ["Rajpipla"],
                "Navsari": ["Navsari"],
                "Panchmahal": ["Godhra"],
                "Patan": ["Patan"],
                "Porbandar": ["Porbandar"],
                "Rajkot": ["Rajkot", "Gondal"],
                "Sabarkantha": ["Himmatnagar"],
                "Surat": ["Surat", "Bardoli"],
                "Surendranagar": ["Surendranagar"],
                "Tapi": ["Vyara"],
                "Vadodara": ["Vadodara"],
                "Valsad": ["Valsad", "Vapi"],
            },
            "Haryana": {
                "Ambala": ["Ambala", "Ambala Cantt"],
                "Bhiwani": ["Bhiwani"],
                "Charkhi Dadri": ["Charkhi Dadri"],
                "Faridabad": ["Faridabad"],
                "Fatehabad": ["Fatehabad"],
                "Gurugram": ["Gurugram", "Manesar", "Sohna"],
                "Hisar": ["Hisar", "Hansi"],
                "Jhajjar": ["Jhajjar", "Bahadurgarh"],
                "Jind": ["Jind"],
                "Kaithal": ["Kaithal"],
                "Karnal": ["Karnal"],
                "Kurukshetra": ["Kurukshetra", "Thanesar"],
                "Mahendragarh": ["Narnaul"],
                "Nuh": ["Nuh"],
                "Palwal": ["Palwal"],
                "Panchkula": ["Panchkula"],
                "Panipat": ["Panipat"],
                "Rewari": ["Rewari"],
                "Rohtak": ["Rohtak"],
                "Sirsa": ["Sirsa"],
                "Sonipat": ["Sonipat"],
                "Yamunanagar": ["Yamunanagar", "Jagadhri"],
            },
            "Himachal Pradesh": {
                "Bilaspur": ["Bilaspur"],
                "Chamba": ["Chamba", "Dalhousie"],
                "Hamirpur": ["Hamirpur"],
                "Kangra": ["Dharamshala", "Kangra", "Palampur"],
                "Kinnaur": ["Reckong Peo"],
                "Kullu": ["Kullu", "Manali"],
                "Lahaul and Spiti": ["Keylong"],
                "Mandi": ["Mandi", "Sundernagar"],
                "Shimla": ["Shimla", "Rampur"],
                "Sirmaur": ["Nahan", "Paonta Sahib"],
                "Solan": ["Solan", "Baddi"],
                "Una": ["Una"],
            },
            "Jammu and Kashmir": {
                "Anantnag": ["Anantnag", "Pahalgam"],
                "Bandipora": ["Bandipora"],
                "Baramulla": ["Baramulla", "Sopore", "Gulmarg"],
                "Budgam": ["Budgam"],
                "Doda": ["Doda"],
                "Ganderbal": ["Ganderbal"],
                "Jammu": ["Jammu", "Akhnoor"],
                "Kathua": ["Kathua"],
                "Kishtwar": ["Kishtwar"],
                "Kulgam": ["Kulgam"],
                "Kupwara": ["Kupwara"],
                "Poonch": ["Poonch"],
                "Pulwama": ["Pulwama"],
                "Rajouri": ["Rajouri"],
                "Ramban": ["Ramban"],
                "Reasi": ["Reasi", "Katra"],
                "Samba": ["Samba"],
                "Shopian": ["Shopian"],
                "Srinagar": ["Srinagar"],
                "Udhampur": ["Udhampur"],
            },
            "Jharkhand": {
                "Bokaro": ["Bokaro Steel City"],
                "Chatra": ["Chatra"],
                "Deoghar": ["Deoghar"],
                "Dhanbad": ["Dhanbad"],
                "Dumka": ["Dumka"],
                "East Singhbhum": ["Jamshedpur", "Ghatshila"],
                "Garhwa": ["Garhwa"],
                "Giridih": ["Giridih"],
                "Godda": ["Godda"],
                "Gumla": ["Gumla"],
                "Hazaribagh": ["Hazaribagh"],
                "Jamtara": ["Jamtara"],
                "Khunti": ["Khunti"],
                "Koderma": ["Koderma", "Jhumri Telaiya"],
                "Latehar": ["Latehar"],
                "Lohardaga": ["Lohardaga"],
                "Pakur": ["Pakur"],
                "Palamu": ["Daltonganj"],
                "Ramgarh": ["Ramgarh"],
                "Ranchi": ["Ranchi"],
                "Sahibganj": ["Sahibganj"],
                "Seraikela-Kharsawan": ["Seraikela", "Adityapur"],
                "Simdega": ["Simdega"],
                "West Singhbhum": ["Chaibasa"],
            },
            "Karnataka": {
                "Bagalkot": ["Bagalkot"],
                "Ballari": ["Ballari"],
                "Belagavi": ["Belagavi"],
                "Bengaluru Rural": ["Doddaballapura", "Devanahalli"],
                "Bengaluru Urban": ["Bengaluru"],
                "Bidar": ["Bidar"],
                "Chamarajanagar": ["Chamarajanagar"],
                "Chikkaballapura": ["Chikkaballapura"],
                "Chikkamagaluru": ["Chikkamagaluru"],
                "Chitradurga": ["Chitradurga"],
                "Dakshina Kannada": ["Mangaluru"],
                "Davanagere": ["Davanagere"],
                "Dharwad": ["Hubballi", "Dharwad"],
                "Gadag": ["Gadag-Betigeri"],
                "Hassan": ["Hassan"],
                "Haveri": ["Haveri"],
                "Kalaburagi": ["Kalaburagi"],
                "Kodagu": ["Madikeri"],
                "Kolar": ["Kolar"],
                "Koppal": ["Koppal"],
                "Mandya": ["Mandya"],
                "Mysuru": ["Mysuru"],
                "Raichur": ["Raichur"],
                "Ramanagara": ["Ramanagara"],
                "Shivamogga": ["Shivamogga"],
                "Tumakuru": ["Tumakuru"],
                "Udupi": ["Udupi"],
                "Uttara Kannada": ["Karwar", "Sirsi"],
                "Vijayanagara": ["Hosapete"],
                "Vijayapura": ["Vijayapura"],
                "Yadgir": ["Yadgir"],
            },
            "Kerala": {
                "Alappuzha": ["Alappuzha", "Kayamkulam"],
                "Ernakulam": ["Kochi", "Aluva", "Angamaly"],
                "Idukki": ["Painavu", "Thodupuzha"],
                "Kannur": ["Kannur", "Thalassery"],
                "Kasaragod": ["Kasaragod", "Kanhangad"],
                "Kollam": ["Kollam", "Punalur"],
                "Kottayam": ["Kottayam", "Changanassery"],
                "Kozhikode": ["Kozhikode", "Vadakara"],
                "Malappuram": ["Malappuram", "Manjeri"],
                "Palakkad": ["Palakkad"],
                "Pathanamthitta": ["Pathanamthitta", "Thiruvalla"],
                "Thiruvananthapuram": ["Thiruvananthapuram", "Neyyattinkara"],
                "Thrissur": ["Thrissur", "Guruvayur"],
                "Wayanad": ["Kalpetta"],
            },
            "Ladakh": {
                "Kargil": ["Kargil"],
                "Leh": ["Leh"],
            },
            "Lakshadweep": {
                "Lakshadweep": ["Kavaratti"],
            },
            "Madhya Pradesh": {
                "Agar Malwa": ["Agar"],
                "Alirajpur": ["Alirajpur"],
                "Anuppur": ["Anuppur"],
                "Ashoknagar": ["Ashoknagar"],
                "Balaghat": ["Balaghat"],
                "Barwani": ["Barwani"],
                "Betul": ["Betul"],
                "Bhind": ["Bhind"],
                "Bhopal": ["Bhopal"],
                "Burhanpur": ["Burhanpur"],
                "Chhatarpur": ["Chhatarpur"],
                "Chhindwara": ["Chhindwara"],
                "Damoh": ["Damoh"],
                "Datia": ["Datia"],
                "Dewas": ["Dewas"],
                "Dhar": ["Dhar"],
                "Dindori": ["Dindori"],
                "Guna": ["Guna"],
                "Gwalior": ["Gwalior"],
                "Harda": ["Harda"],
                "Indore": ["Indore", "Mhow"],
                "Jabalpur": ["Jabalpur"],
                "Jhabua": ["Jhabua"],
                "Katni": ["Katni"],
                "Khandwa": ["Khandwa"],
                "Khargone": ["Khargone"],
                "Maihar": ["Maihar"],
                "Mandla": ["Mandla"],
                "Mandsaur": ["Mandsaur"],
                "Mauganj": ["Mauganj"],
                "Morena": ["Morena"],
                "Narmadapuram": ["Itarsi", "Hoshangabad"],
                "Narsinghpur": ["Narsinghpur"],
                "Neemuch": ["Neemuch"],
                "Niwari": ["Niwari"],
                "Pandhurna": ["Pandhurna"],
                "Panna": ["Panna"],
                "Raisen": ["Raisen"],
                "Rajgarh": ["Rajgarh"],
                "Ratlam": ["Ratlam"],
                "Rewa": ["Rewa"],
                "Sagar": ["Sagar"],
                "Satna": ["Satna"],
                "Sehore": ["Sehore"],
                "Seoni": ["Seoni"],
                "Shahdol": ["Shahdol"],
                "Shajapur": ["Shajapur"],
                "Sheopur": ["Sheopur"],
                "Shivpuri": ["Shivpuri"],
                "Sidhi": ["Sidhi"],
                "Singrauli": ["Singrauli"],
                "Tikamgarh": ["Tikamgarh"],
                "Ujjain": ["Ujjain"],
                "Umaria": ["Umaria"],
                "Vidisha": ["Vidisha"],
            },
            "Maharashtra": {
                "Ahmednagar": ["Ahmednagar", "Sangamner"],
                "Akola": ["Akola"],
                "Amravati": ["Amravati"],
                "Aurangabad": ["Chhatrapati Sambhajinagar"],
                "Beed": ["Beed"],
                "Bhandara": ["Bhandara"],
                "Buldhana": ["Buldhana"],
                "Chandrapur": ["Chandrapur"],
                "Dhule": ["Dhule"],
                "Gadchiroli": ["Gadchiroli"],
                "Gondia": ["Gondia"],
                "Hingoli": ["Hingoli"],
                "Jalgaon": ["Jalgaon", "Bhusawal"],
                "Jalna": ["Jalna"],
                "Kolhapur": ["Kolhapur"],
                "Latur": ["Latur"],
                "Mumbai City": ["Mumbai"],
                "Mumbai Suburban": ["Bandra", "Andheri", "Borivali"],
                "Nagpur": ["Nagpur"],
                "Nanded": ["Nanded"],
                "Nandurbar": ["Nandurbar"],
                "Nashik": ["Nashik", "Malegaon"],
                "Osmanabad": ["Dharashiv"],
                "Palghar": ["Palghar", "Vasai-Virar"],
                "Parbhani": ["Parbhani"],
                "Pune": ["Pune", "Pimpri-Chinchwad"],
                "Raigad": ["Alibag", "Panvel"],
                "Ratnagiri": ["Ratnagiri"],
                "Sangli": ["Sangli", "Miraj"],
                "Satara": ["Satara"],
                "Sindhudurg": ["Oros", "Malvan"],
                "Solapur": ["Solapur"],
                "Thane": ["Thane", "Kalyan-Dombivli", "Ulhasnagar"],
                "Wardha": ["Wardha"],
                "Washim": ["Washim"],
                "Yavatmal": ["Yavatmal"],
            },
            "Manipur": {
                "Bishnupur": ["Bishnupur"],
                "Chandel": ["Chandel"],
                "Churachandpur": ["Churachandpur"],
                "Imphal East": ["Porompat"],
                "Imphal West": ["Imphal"],
                "Jiribam": ["Jiribam"],
                "Kakching": ["Kakching"],
                "Kamjong": ["Kamjong"],
                "Kangpokpi": ["Kangpokpi"],
                "Noney": ["Noney"],
                "Pherzawl": ["Pherzawl"],
                "Senapati": ["Senapati"],
                "Tamenglong": ["Tamenglong"],
                "Tengnoupal": ["Tengnoupal"],
                "Thoubal": ["Thoubal"],
                "Ukhrul": ["Ukhrul"],
            },
            "Meghalaya": {
                "East Garo Hills": ["Williamnagar"],
                "East Jaintia Hills": ["Khliehriat"],
                "East Khasi Hills": ["Shillong"],
                "Eastern West Khasi Hills": ["Mairang"],
                "North Garo Hills": ["Resubelpara"],
                "Ri Bhoi": ["Nongpoh"],
                "South Garo Hills": ["Baghmara"],
                "South West Garo Hills": ["Ampati"],
                "South West Khasi Hills": ["Mawkyrwat"],
                "West Garo Hills": ["Tura"],
                "West Jaintia Hills": ["Jowai"],
                "West Khasi Hills": ["Nongstoin"],
            },
            "Mizoram": {
                "Aizawl": ["Aizawl"],
                "Champhai": ["Champhai"],
                "Hnahthial": ["Hnahthial"],
                "Khawzawl": ["Khawzawl"],
                "Kolasib": ["Kolasib"],
                "Lawngtlai": ["Lawngtlai"],
                "Lunglei": ["Lunglei"],
                "Mamit": ["Mamit"],
                "Saiha": ["Saiha"],
                "Saitual": ["Saitual"],
                "Serchhip": ["Serchhip"],
            },
            "Nagaland": {
                "Chumoukedima": ["Chumoukedima"],
                "Dimapur": ["Dimapur"],
                "Kiphire": ["Kiphire"],
                "Kohima": ["Kohima"],
                "Longleng": ["Longleng"],
                "Mokokchung": ["Mokokchung"],
                "Mon": ["Mon"],
                "Niuland": ["Niuland"],
                "Noklak": ["Noklak"],
                "Peren": ["Peren"],
                "Phek": ["Phek"],
                "Shamator": ["Shamator"],
                "Tseminyu": ["Tseminyu"],
                "Tuensang": ["Tuensang"],
                "Wokha": ["Wokha"],
                "Zunheboto": ["Zunheboto"],
            },
            "Odisha": {
                "Angul": ["Angul"],
                "Balangir": ["Balangir"],
                "Balasore": ["Balasore"],
                "Bargarh": ["Bargarh"],
                "Bhadrak": ["Bhadrak"],
                "Boudh": ["Boudh"],
                "Cuttack": ["Cuttack"],
                "Deogarh": ["Deogarh"],
                "Dhenkanal": ["Dhenkanal"],
                "Gajapati": ["Paralakhemundi"],
                "Ganjam": ["Chhatrapur", "Berhampur"],
                "Jagatsinghpur": ["Jagatsinghpur"],
                "Jajpur": ["Jajpur"],
                "Jharsuguda": ["Jharsuguda"],
                "Kalahandi": ["Bhawanipatna"],
                "Kandhamal": ["Phulbani"],
                "Kendrapara": ["Kendrapara"],
                "Kendujhar": ["Kendujhar"],
                "Khordha": ["Bhubaneswar", "Khordha"],
                "Koraput": ["Koraput", "Jeypore"],
                "Malkangiri": ["Malkangiri"],
                "Mayurbhanj": ["Baripada"],
                "Nabarangpur": ["Nabarangpur"],
                "Nayagarh": ["Nayagarh"],
                "Nuapada": ["Nuapada"],
                "Puri": ["Puri"],
                "Rayagada": ["Rayagada"],
                "Sambalpur": ["Sambalpur"],
                "Subarnapur": ["Sonepur"],
                "Sundargarh": ["Sundargarh", "Rourkela"],
            },
            "Puducherry": {
                "Karaikal": ["Karaikal"],
                "Mahe": ["Mahe"],
                "Puducherry": ["Puducherry"],
                "Yanam": ["Yanam"],
            },
            "Punjab": {
                "Amritsar": ["Amritsar"],
                "Barnala": ["Barnala"],
                "Bathinda": ["Bathinda"],
                "Faridkot": ["Faridkot"],
                "Fatehgarh Sahib": ["Sirhind"],
                "Fazilka": ["Fazilka", "Abohar"],
                "Ferozepur": ["Ferozepur"],
                "Gurdaspur": ["Gurdaspur", "Batala"],
                "Hoshiarpur": ["Hoshiarpur"],
                "Jalandhar": ["Jalandhar"],
                "Kapurthala": ["Kapurthala"],
                "Ludhiana": ["Ludhiana", "Jagraon", "Khanna"],
                "Malerkotla": ["Malerkotla"],
                "Mansa": ["Mansa"],
                "Moga": ["Moga"],
                "Muktsar": ["Muktsar"],
                "Pathankot": ["Pathankot"],
                "Patiala": ["Patiala", "Rajpura"],
                "Rupnagar": ["Rupnagar"],
                "SAS Nagar": ["Mohali", "Zirakpur", "Kharar"],
                "Sangrur": ["Sangrur"],
                "Shaheed Bhagat Singh Nagar": ["Nawanshahr"],
                "Tarn Taran": ["Tarn Taran"],
            },
            "Rajasthan": {
                "Ajmer": ["Ajmer", "Kishangarh"],
                "Alwar": ["Alwar", "Bhiwadi"],
                "Anupgarh": ["Anupgarh"],
                "Balotra": ["Balotra"],
                "Banswara": ["Banswara"],
                "Baran": ["Baran"],
                "Barmer": ["Barmer"],
                "Beawar": ["Beawar"],
                "Bharatpur": ["Bharatpur"],
                "Bhilwara": ["Bhilwara"],
                "Bikaner": ["Bikaner"],
                "Bundi": ["Bundi"],
                "Chittorgarh": ["Chittorgarh"],
                "Churu": ["Churu"],
                "Dausa": ["Dausa"],
                "Deeg": ["Deeg"],
                "Dholpur": ["Dholpur"],
                "Didwana-Kuchaman": ["Didwana"],
                "Dudu": ["Dudu"],
                "Dungarpur": ["Dungarpur"],
                "Gangapur City": ["Gangapur"],
                "Hanumangarh": ["Hanumangarh"],
                "Jaipur": ["Jaipur"],
                "Jaipur Rural": ["Bagru"],
                "Jaisalmer": ["Jaisalmer"],
                "Jalore": ["Jalore"],
                "Jhalawar": ["Jhalawar"],
                "Jhunjhunu": ["Jhunjhunu"],
                "Jodhpur": ["Jodhpur"],
                "Jodhpur Rural": ["Luni"],
                "Karauli": ["Karauli"],
                "Kekri": ["Kekri"],
                "Khairthal-Tijara": ["Tijara"],
                "Kota": ["Kota"],
                "Kotputli-Behror": ["Kotputli"],
                "Nagaur": ["Nagaur"],
                "Neem Ka Thana": ["Neem Ka Thana"],
                "Pali": ["Pali"],
                "Phalodi": ["Phalodi"],
                "Pratapgarh": ["Pratapgarh"],
                "Rajsamand": ["Rajsamand"],
                "Salumbar": ["Salumbar"],
                "Sanchore": ["Sanchore"],
                "Sawai Madhopur": ["Sawai Madhopur"],
                "Shahpura": ["Shahpura"],
                "Sikar": ["Sikar"],
                "Sirohi": ["Sirohi", "Mount Abu"],
                "Sri Ganganagar": ["Sri Ganganagar"],
                "Tonk": ["Tonk"],
                "Udaipur": ["Udaipur"],
            },
            "Sikkim": {
                "Gangtok": ["Gangtok"],
                "Gyalshing": ["Gyalshing"],
                "Mangan": ["Mangan"],
                "Namchi": ["Namchi"],
                "Pakyong": ["Pakyong"],
                "Soreng": ["Soreng"],
            },
            "Tamil Nadu": {
                "Ariyalur": ["Ariyalur"],
                "Chengalpattu": ["Chengalpattu"],
                "Chennai": ["Chennai"],
                "Coimbatore": ["Coimbatore"],
                "Cuddalore": ["Cuddalore"],
                "Dharmapuri": ["Dharmapuri"],
                "Dindigul": ["Dindigul"],
                "Erode": ["Erode"],
                "Kallakurichi": ["Kallakurichi"],
                "Kancheepuram": ["Kancheepuram"],
                "Kanyakumari": ["Nagercoil"],
                "Karur": ["Karur"],
                "Krishnagiri": ["Krishnagiri", "Hosur"],
                "Madurai": ["Madurai"],
                "Mayiladuthurai": ["Mayiladuthurai"],
                "Nagapattinam": ["Nagapattinam"],
                "Namakkal": ["Namakkal"],
                "Nilgiris": ["Udhagamandalam", "Coonoor"],
                "Perambalur": ["Perambalur"],
                "Pudukkottai": ["Pudukkottai"],
                "Ramanathapuram": ["Ramanathapuram"],
                "Ranipet": ["Ranipet"],
                "Salem": ["Salem"],
                "Sivaganga": ["Sivaganga"],
                "Tenkasi": ["Tenkasi"],
                "Thanjavur": ["Thanjavur", "Kumbakonam"],
                "Theni": ["Theni"],
                "Thoothukudi": ["Thoothukudi"],
                "Tiruchirappalli": ["Tiruchirappalli"],
                "Tirunelveli": ["Tirunelveli"],
                "Tirupathur": ["Tirupathur"],
                "Tiruppur": ["Tiruppur"],
                "Tiruvallur": ["Tiruvallur"],
                "Tiruvannamalai": ["Tiruvannamalai"],
                "Tiruvarur": ["Tiruvarur"],
                "Vellore": ["Vellore"],
                "Viluppuram": ["Viluppuram"],
                "Virudhunagar": ["Virudhunagar"],
            },
            "Telangana": {
                "Adilabad": ["Adilabad"],
                "Bhadradri Kothagudem": ["Kothagudem"],
                "Hanamkonda": ["Hanamkonda"],
                "Hyderabad": ["Hyderabad", "Secunderabad"],
                "Jagtial": ["Jagtial"],
                "Jangaon": ["Jangaon"],
                "Jayashankar Bhupalpally": ["Bhupalpally"],
                "Jogulamba Gadwal": ["Gadwal"],
                "Kamareddy": ["Kamareddy"],
                "Karimnagar": ["Karimnagar"],
                "Khammam": ["Khammam"],
                "Komaram Bheem Asifabad": ["Asifabad"],
                "Mahabubabad": ["Mahabubabad"],
                "Mahbubnagar": ["Mahbubnagar"],
                "Mancherial": ["Mancherial"],
                "Medak": ["Medak"],
                "Medchal-Malkajgiri": ["Malkajgiri", "Kukatpally"],
                "Mulugu": ["Mulugu"],
                "Nagarkurnool": ["Nagarkurnool"],
                "Nalgonda": ["Nalgonda"],
                "Narayanpet": ["Narayanpet"],
                "Nirmal": ["Nirmal"],
                "Nizamabad": ["Nizamabad"],
                "Peddapalli": ["Peddapalli", "Ramagundam"],
                "Rajanna Sircilla": ["Sircilla"],
                "Rangareddy": ["L.B. Nagar", "Shamshabad"],
                "Sangareddy": ["Sangareddy"],
                "Siddipet": ["Siddipet"],
                "Suryapet": ["Suryapet"],
                "Vikarabad": ["Vikarabad"],
                "Wanaparthy": ["Wanaparthy"],
                "Warangal": ["Warangal"],
                "Yadadri Bhuvanagiri": ["Bhongir"],
            },
            "Tripura": {
                "Dhalai": ["Ambassa"],
                "Gomati": ["Udaipur"],
                "Khowai": ["Khowai"],
                "North Tripura": ["Dharmanagar"],
                "Sepahijala": ["Bishramganj"],
                "South Tripura": ["Belonia"],
                "Unakoti": ["Kailashahar"],
                "West Tripura": ["Agartala"],
            },
            "Uttar Pradesh": {
                "Agra": ["Agra"],
                "Aligarh": ["Aligarh"],
                "Ambedkar Nagar": ["Akbarpur"],
                "Amethi": ["Gauriganj"],
                "Amroha": ["Amroha"],
                "Auraiya": ["Auraiya"],
                "Ayodhya": ["Ayodhya", "Faizabad"],
                "Azamgarh": ["Azamgarh"],
                "Baghpat": ["Baghpat"],
                "Bahraich": ["Bahraich"],
                "Ballia": ["Ballia"],
                "Balrampur": ["Balrampur"],
                "Banda": ["Banda"],
                "Barabanki": ["Barabanki"],
                "Bareilly": ["Bareilly"],
                "Basti": ["Basti"],
                "Bhadohi": ["Gyanpur"],
                "Bijnor": ["Bijnor"],
                "Budaun": ["Budaun"],
                "Bulandshahr": ["Bulandshahr"],
                "Chandauli": ["Chandauli"],
                "Chitrakoot": ["Karwi"],
                "Deoria": ["Deoria"],
                "Etah": ["Etah"],
                "Etawah": ["Etawah"],
                "Farrukhabad": ["Fatehgarh"],
                "Fatehpur": ["Fatehpur"],
                "Firozabad": ["Firozabad"],
                "Gautam Buddha Nagar": ["Noida", "Greater Noida"],
                "Ghaziabad": ["Ghaziabad", "Loni"],
                "Ghazipur": ["Ghazipur"],
                "Gonda": ["Gonda"],
                "Gorakhpur": ["Gorakhpur"],
                "Hamirpur": ["Hamirpur"],
                "Hapur": ["Hapur"],
                "Hardoi": ["Hardoi"],
                "Hathras": ["Hathras"],
                "Jalaun": ["Orai"],
                "Jaunpur": ["Jaunpur"],
                "Jhansi": ["Jhansi"],
                "Kannauj": ["Kannauj"],
                "Kanpur Dehat": ["Akbarpur"],
                "Kanpur Nagar": ["Kanpur"],
                "Kasganj": ["Kasganj"],
                "Kaushambi": ["Manjhanpur"],
                "Kushinagar": ["Padrauna"],
                "Lakhimpur Kheri": ["Lakhimpur"],
                "Lalitpur": ["Lalitpur"],
                "Lucknow": ["Lucknow"],
                "Maharajganj": ["Maharajganj"],
                "Mahoba": ["Mahoba"],
                "Mainpuri": ["Mainpuri"],
                "Mathura": ["Mathura"],
                "Mau": ["Mau"],
                "Meerut": ["Meerut"],
                "Mirzapur": ["Mirzapur"],
                "Moradabad": ["Moradabad"],
                "Muzaffarnagar": ["Muzaffarnagar"],
                "Pilibhit": ["Pilibhit"],
                "Pratapgarh": ["Pratapgarh"],
                "Prayagraj": ["Prayagraj"],
                "Raebareli": ["Raebareli"],
                "Rampur": ["Rampur"],
                "Saharanpur": ["Saharanpur"],
                "Sambhal": ["Sambhal"],
                "Sant Kabir Nagar": ["Khalilabad"],
                "Shahjahanpur": ["Shahjahanpur"],
                "Shamli": ["Shamli"],
                "Shravasti": ["Bhinga"],
                "Siddharthnagar": ["Naugarh"],
                "Sitapur": ["Sitapur"],
                "Sonbhadra": ["Robertsganj"],
                "Sultanpur": ["Sultanpur"],
                "Unnao": ["Unnao"],
                "Varanasi": ["Varanasi"],
            },
            "Uttarakhand": {
                "Almora": ["Almora"],
                "Bageshwar": ["Bageshwar"],
                "Chamoli": ["Gopeshwar"],
                "Champawat": ["Champawat"],
                "Dehradun": ["Dehradun", "Rishikesh"],
                "Haridwar": ["Haridwar", "Roorkee"],
                "Nainital": ["Nainital", "Haldwani"],
                "Pauri Garhwal": ["Pauri"],
                "Pithoragarh": ["Pithoragarh"],
                "Rudraprayag": ["Rudraprayag"],
                "Tehri Garhwal": ["New Tehri"],
                "Udham Singh Nagar": ["Rudrapur"],
                "Uttarkashi": ["Uttarkashi"],
            },
            "West Bengal": {
                "Alipurduar": ["Alipurduar"],
                "Bankura": ["Bankura"],
                "Birbhum": ["Suri"],
                "Cooch Behar": ["Cooch Behar"],
                "Dakshin Dinajpur": ["Balurghat"],
                "Darjeeling": ["Darjeeling", "Siliguri"],
                "Hooghly": ["Chinsurah"],
                "Howrah": ["Howrah"],
                "Jalpaiguri": ["Jalpaiguri"],
                "Jhargram": ["Jhargram"],
                "Kalimpong": ["Kalimpong"],
                "Kolkata": ["Kolkata"],
                "Malda": ["English Bazar"],
                "Murshidabad": ["Berhampore"],
                "Nadia": ["Krishnanagar"],
                "North 24 Parganas": ["Barasat"],
                "Paschim Bardhaman": ["Asansol", "Durgapur"],
                "Paschim Medinipur": ["Medinipur"],
                "Purba Bardhaman": ["Bardhaman"],
                "Purba Medinipur": ["Tamluk"],
                "Purulia": ["Purulia"],
                "South 24 Parganas": ["Alipore"],
                "Uttar Dinajpur": ["Raiganj"],
            },
        }

        with transaction.atomic():
            # Create India
            india, _ = Country.objects.get_or_create(
                name='India',
                defaults={'code': 'IN', 'dial_code': '+91'}
            )
            self.stdout.write(f'Using Country: {india.name}')

            for state_name, districts_data in INDIA_DATA.items():
                # Create State
                state_code = state_name[:2].upper() # Naive code gen, can be improved
                state, _ = State.objects.get_or_create(
                    country=india,
                    name=state_name,
                    defaults={'code': state_code}
                )
                
                for district_name, cities_list in districts_data.items():
                     # Create District
                    district, _ = LocationDistrict.objects.get_or_create(
                        state=state,
                        name=district_name,
                        defaults={'code': district_name[:3].upper()}
                    )
                    
                    # Create Cities
                    for city_name in cities_list:
                        City.objects.get_or_create(
                            district=district,
                            name=city_name,
                            defaults={'code': city_name[:3].upper()}
                        )
                        
            self.stdout.write(self.style.SUCCESS(f'Successfully populated India locations!'))
            self.stdout.write(f'States: {State.objects.count()}')
            self.stdout.write(f'Districts: {LocationDistrict.objects.count()}')
            self.stdout.write(f'Cities: {City.objects.count()}')



================================================
FILE: backend/masters/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2026-01-01 10:18

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('banks', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Circle',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., C-CIVIL', max_length=20, unique=True)),
                ('name', models.CharField(help_text='Full name of the Circle', max_length=255)),
                ('authority_level', models.CharField(choices=[('CE', 'Chief Engineer'), ('SE', 'Superintending Engineer')], default='SE', help_text='Rank of officer heading the Circle', max_length=5)),
                ('status', models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Circle',
                'verbose_name_plural': 'Circles',
                'db_table': 'masters_circle',
                'ordering': ['code'],
            },
        ),
        migrations.CreateModel(
            name='Contractor',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., C-10025', max_length=20, unique=True)),
                ('name', models.CharField(help_text='Full legal name of contractor/firm', max_length=500)),
                ('contractor_type', models.CharField(choices=[('Proprietorship', 'Proprietorship'), ('Partnership', 'Partnership'), ('Private Limited', 'Private Limited'), ('Public Limited', 'Public Limited'), ('LLP', 'Limited Liability Partnership'), ('Government', 'Government Entity'), ('Other', 'Other')], default='Proprietorship', max_length=50)),
                ('registration_class', models.CharField(blank=True, choices=[('Class A', 'Class A (Unlimited)'), ('Class B', 'Class B (Up to â‚¹50 Cr)'), ('Class C', 'Class C (Up to â‚¹10 Cr)'), ('Class D', 'Class D (Up to â‚¹2 Cr)'), ('Class E', 'Class E (Up to â‚¹50 Lakh)')], max_length=20)),
                ('registration_number', models.CharField(blank=True, help_text='Official registration/license number', max_length=100)),
                ('pan', models.CharField(blank=True, help_text='10-digit PAN', max_length=10)),
                ('gstin', models.CharField(blank=True, help_text='15-digit GSTIN', max_length=15)),
                ('tds_rate', models.DecimalField(decimal_places=2, default=2.0, help_text='TDS percentage', max_digits=5)),
                ('contact_person', models.CharField(blank=True, max_length=255)),
                ('email', models.EmailField(blank=True, max_length=254)),
                ('phone', models.CharField(blank=True, max_length=20)),
                ('address', models.TextField(blank=True, help_text='Registered address')),
                ('blacklisted', models.BooleanField(default=False, help_text='Barred from bidding')),
                ('blacklist_reason', models.TextField(blank=True)),
                ('validity_date', models.DateField(blank=True, help_text='Registration validity', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Contractor',
                'verbose_name_plural': 'Contractors',
                'db_table': 'masters_contractor',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='District',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., D-410', max_length=20, unique=True)),
                ('name', models.CharField(help_text='Official district name', max_length=255)),
                ('state_name', models.CharField(help_text='State the district belongs to', max_length=100)),
                ('pincode_range', models.CharField(blank=True, help_text='e.g., 560001 to 560099', max_length=100)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'District',
                'verbose_name_plural': 'Districts',
                'db_table': 'masters_district',
                'ordering': ['state_name', 'name'],
            },
        ),
        migrations.CreateModel(
            name='ETPMaster',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., LABOUR-CESS', max_length=30, unique=True)),
                ('name', models.CharField(help_text='e.g., Labour Welfare Cess', max_length=255)),
                ('charge_type', models.CharField(choices=[('Deduction', 'Deduction'), ('Recovery', 'Recovery'), ('Levy', 'Levy'), ('Addition', 'Addition')], default='Deduction', max_length=20)),
                ('rate_percentage', models.DecimalField(decimal_places=3, default=0, help_text='e.g., 1.000 for 1%', max_digits=6)),
                ('basis_of_calculation', models.CharField(choices=[('Gross Bill Value', 'Gross Bill Value'), ('Works Component Only', 'Works Component Only'), ('Material Cost', 'Material Cost'), ('Labour Cost', 'Labour Cost'), ('Net Payable', 'Net Payable')], default='Gross Bill Value', help_text='Which amount to apply the percentage on', max_length=50)),
                ('effective_date', models.DateField(help_text='Date from which rate is applicable')),
                ('govt_reference', models.CharField(blank=True, help_text='Circular/order number', max_length=255)),
                ('account_head', models.CharField(blank=True, help_text='Internal finance ledger code', max_length=100)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'ETP Charge',
                'verbose_name_plural': 'ETP Charges',
                'db_table': 'masters_etp',
                'ordering': ['charge_type', 'code'],
            },
        ),
        migrations.CreateModel(
            name='ProjectCategory',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., PC-MAJ', max_length=20, unique=True)),
                ('name', models.CharField(help_text='e.g., Major Project', max_length=255)),
                ('threshold_value', models.DecimalField(decimal_places=2, default=0, help_text='Minimum contract value in INR', max_digits=15)),
                ('approval_authority', models.CharField(blank=True, help_text='e.g., Chief Engineer/Cabinet', max_length=255)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Project Category',
                'verbose_name_plural': 'Project Categories',
                'db_table': 'masters_project_category',
                'ordering': ['threshold_value'],
            },
        ),
        migrations.CreateModel(
            name='SchemeType',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., ST-CS', max_length=20, unique=True)),
                ('name', models.CharField(help_text='e.g., Centrally Sponsored', max_length=255)),
                ('category', models.CharField(choices=[('Infrastructure', 'Infrastructure'), ('Social Sector', 'Social Sector'), ('Education', 'Education'), ('Health', 'Health'), ('Agriculture', 'Agriculture'), ('Other', 'Other')], default='Infrastructure', max_length=50)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Scheme Type',
                'verbose_name_plural': 'Scheme Types',
                'db_table': 'masters_scheme_type',
                'ordering': ['code'],
            },
        ),
        migrations.CreateModel(
            name='WorkType',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., WT-ROAD', max_length=20, unique=True)),
                ('name', models.CharField(help_text='e.g., New Road Construction', max_length=255)),
                ('sector', models.CharField(choices=[('PWD', 'Public Works Department'), ('Irrigation', 'Irrigation'), ('Health', 'Health'), ('Education', 'Education'), ('Roads', 'Roads & Highways'), ('Water Supply', 'Water Supply'), ('Other', 'Other')], default='PWD', max_length=50)),
                ('unit_of_measurement', models.CharField(blank=True, help_text='Km/Sq.m/Meters', max_length=50)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Work Type',
                'verbose_name_plural': 'Work Types',
                'db_table': 'masters_work_type',
                'ordering': ['code'],
            },
        ),
        migrations.CreateModel(
            name='Zone',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., ZN-SOUTH', max_length=20, unique=True)),
                ('name', models.CharField(help_text='Full name of the Zone', max_length=255)),
                ('state_covered', models.CharField(blank=True, help_text='State or region managed', max_length=255)),
                ('head', models.CharField(blank=True, help_text='Zonal Head name and designation', max_length=255)),
                ('status', models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Zone',
                'verbose_name_plural': 'Zones',
                'db_table': 'masters_zone',
                'ordering': ['code'],
            },
        ),
        migrations.CreateModel(
            name='ContractorBankAccount',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('account_number', models.CharField(help_text='Bank account number', max_length=30)),
                ('account_type', models.CharField(choices=[('Current', 'Current Account'), ('Savings', 'Savings Account')], default='Current', max_length=20)),
                ('is_primary', models.BooleanField(default=False, help_text='Primary account for payments')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('bank_branch', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='contractor_accounts', to='banks.bankbranch')),
                ('contractor', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='bank_account_details', to='masters.contractor')),
            ],
            options={
                'verbose_name': 'Contractor Bank Account',
                'verbose_name_plural': 'Contractor Bank Accounts',
                'db_table': 'masters_contractor_bank_account',
                'unique_together': {('contractor', 'account_number')},
            },
        ),
        migrations.AddField(
            model_name='contractor',
            name='bank_accounts',
            field=models.ManyToManyField(blank=True, related_name='contractors', through='masters.ContractorBankAccount', to='banks.bankbranch'),
        ),
        migrations.CreateModel(
            name='Division',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., DIV-NGR', max_length=20, unique=True)),
                ('name', models.CharField(help_text='Full name of the Division', max_length=255)),
                ('hod', models.CharField(blank=True, help_text='Head of Division name', max_length=255)),
                ('contact_email', models.EmailField(blank=True, help_text='Official email', max_length=254)),
                ('contact_phone', models.CharField(blank=True, help_text='Official phone', max_length=20)),
                ('effective_date', models.DateField(blank=True, help_text='Date division started', null=True)),
                ('status', models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('circle', models.ForeignKey(help_text='Parent Circle', on_delete=django.db.models.deletion.PROTECT, related_name='divisions', to='masters.circle')),
            ],
            options={
                'verbose_name': 'Division',
                'verbose_name_plural': 'Divisions',
                'db_table': 'masters_division',
                'ordering': ['code'],
            },
        ),
        migrations.CreateModel(
            name='Scheme',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., PMSGY', max_length=20, unique=True)),
                ('name', models.CharField(help_text='Full legal name of the program', max_length=500)),
                ('funding_agency', models.CharField(blank=True, help_text='Central Govt/State Govt/World Bank', max_length=255)),
                ('start_date', models.DateField(blank=True, null=True)),
                ('end_date', models.DateField(blank=True, null=True)),
                ('budget_head_code', models.CharField(blank=True, help_text='Budgetary ledger code', max_length=50)),
                ('objective', models.TextField(blank=True, help_text='Brief goal or purpose')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('scheme_type', models.ForeignKey(help_text='Scheme classification', on_delete=django.db.models.deletion.PROTECT, related_name='schemes', to='masters.schemetype')),
            ],
            options={
                'verbose_name': 'Scheme',
                'verbose_name_plural': 'Schemes',
                'db_table': 'masters_scheme',
                'ordering': ['code'],
            },
        ),
        migrations.CreateModel(
            name='SubDivision',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., SD-01-W', max_length=20, unique=True)),
                ('name', models.CharField(help_text='Full name of Sub-Division', max_length=255)),
                ('jurisdiction_area', models.CharField(blank=True, help_text='Geographical area covered', max_length=500)),
                ('reporting_officer', models.CharField(blank=True, help_text='Sub-Divisional Engineer name', max_length=255)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('division', models.ForeignKey(help_text='Parent Division', on_delete=django.db.models.deletion.PROTECT, related_name='subdivisions', to='masters.division')),
            ],
            options={
                'verbose_name': 'Sub-Division',
                'verbose_name_plural': 'Sub-Divisions',
                'db_table': 'masters_subdivision',
                'ordering': ['code'],
            },
        ),
        migrations.CreateModel(
            name='Town',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('code', models.CharField(db_index=True, help_text='e.g., T-0010', max_length=20, unique=True)),
                ('name', models.CharField(help_text='Official town/city name', max_length=255)),
                ('classification', models.CharField(choices=[('Metropolitan', 'Metropolitan'), ('Municipality', 'Municipality'), ('Town', 'Town'), ('Village', 'Village')], default='Town', max_length=20)),
                ('population', models.PositiveIntegerField(blank=True, help_text='Estimated population', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('district', models.ForeignKey(help_text='Parent District', on_delete=django.db.models.deletion.PROTECT, related_name='towns', to='masters.district')),
            ],
            options={
                'verbose_name': 'Town/City',
                'verbose_name_plural': 'Towns/Cities',
                'db_table': 'masters_town',
                'ordering': ['name'],
            },
        ),
        migrations.AddField(
            model_name='circle',
            name='zone',
            field=models.ForeignKey(help_text='Parent Zone', on_delete=django.db.models.deletion.PROTECT, related_name='circles', to='masters.zone'),
        ),
    ]



================================================
FILE: backend/masters/migrations/0002_add_user_links_to_hierarchy.py
================================================
# Generated by Django 6.0 on 2026-01-02 11:48

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('masters', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name='division',
            name='hod_user',
            field=models.ForeignKey(blank=True, help_text='User account of the Head of Division', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='headed_divisions', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='subdivision',
            name='reporting_officer_user',
            field=models.ForeignKey(blank=True, help_text='User account of the Sub-Divisional Engineer', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='managed_subdivisions', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='zone',
            name='head_user',
            field=models.ForeignKey(blank=True, help_text='User account of the Zonal Head', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='headed_zones', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AlterField(
            model_name='division',
            name='hod',
            field=models.CharField(blank=True, help_text='[Deprecated] Head of Division name', max_length=255),
        ),
        migrations.AlterField(
            model_name='subdivision',
            name='reporting_officer',
            field=models.CharField(blank=True, help_text='[Deprecated] Sub-Divisional Engineer name', max_length=255),
        ),
        migrations.AlterField(
            model_name='zone',
            name='head',
            field=models.CharField(blank=True, help_text='[Deprecated] Zonal Head name and designation', max_length=255),
        ),
    ]



================================================
FILE: backend/masters/migrations/0003_add_linked_user_to_contractor.py
================================================
# Generated by Django 6.0 on 2026-01-02 16:29

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('masters', '0002_add_user_links_to_hierarchy'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name='contractor',
            name='linked_user',
            field=models.OneToOneField(blank=True, help_text='Linked user account for self-registered contractors', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='contractor_profile', to=settings.AUTH_USER_MODEL),
        ),
    ]



================================================
FILE: backend/masters/migrations/0004_district_status_projectcategory_status_scheme_status_and_more.py
================================================
# Generated by Django 6.0 on 2026-01-07 14:04

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('masters', '0003_add_linked_user_to_contractor'),
    ]

    operations = [
        migrations.AddField(
            model_name='district',
            name='status',
            field=models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20),
        ),
        migrations.AddField(
            model_name='projectcategory',
            name='status',
            field=models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20),
        ),
        migrations.AddField(
            model_name='scheme',
            name='status',
            field=models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20),
        ),
        migrations.AddField(
            model_name='schemetype',
            name='status',
            field=models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20),
        ),
        migrations.AddField(
            model_name='subdivision',
            name='status',
            field=models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20),
        ),
        migrations.AddField(
            model_name='town',
            name='status',
            field=models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20),
        ),
        migrations.AddField(
            model_name='worktype',
            name='status',
            field=models.CharField(choices=[('Active', 'Active'), ('Inactive', 'Inactive')], default='Active', max_length=20),
        ),
    ]



================================================
FILE: backend/masters/migrations/0005_country_state_city.py
================================================
# Generated by Django 6.0.1 on 2026-01-10 07:20

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('masters', '0004_district_status_projectcategory_status_scheme_status_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='Country',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='Country name (e.g., India)', max_length=100, unique=True)),
                ('code', models.CharField(help_text='ISO 3166-1 alpha-2 code (e.g., IN)', max_length=3, unique=True)),
                ('dial_code', models.CharField(help_text='Country calling code (e.g., +91)', max_length=10)),
                ('is_active', models.BooleanField(default=True, help_text='Whether this country is active in the system')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Country',
                'verbose_name_plural': 'Countries',
                'db_table': 'masters_countries',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='State',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='State/Province name', max_length=100)),
                ('code', models.CharField(blank=True, help_text='State code (e.g., TG for Telangana)', max_length=10)),
                ('is_active', models.BooleanField(default=True, help_text='Whether this state is active')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('country', models.ForeignKey(help_text='Parent country', on_delete=django.db.models.deletion.CASCADE, related_name='states', to='masters.country')),
            ],
            options={
                'verbose_name': 'State',
                'verbose_name_plural': 'States',
                'db_table': 'masters_states',
                'ordering': ['country', 'name'],
                'unique_together': {('country', 'name')},
            },
        ),
        migrations.CreateModel(
            name='City',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='City name', max_length=100)),
                ('code', models.CharField(blank=True, help_text='City code if applicable', max_length=10)),
                ('is_active', models.BooleanField(default=True, help_text='Whether this city is active')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('state', models.ForeignKey(help_text='Parent state', on_delete=django.db.models.deletion.CASCADE, related_name='cities', to='masters.state')),
            ],
            options={
                'verbose_name': 'City',
                'verbose_name_plural': 'Cities',
                'db_table': 'masters_cities',
                'ordering': ['state', 'name'],
                'unique_together': {('state', 'name')},
            },
        ),
    ]



================================================
FILE: backend/masters/migrations/0006_add_location_district.py
================================================
# Generated by Django 6.0.1 on 2026-01-10 10:26

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('masters', '0005_country_state_city'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='city',
            options={'ordering': ['district', 'name'], 'verbose_name': 'City', 'verbose_name_plural': 'Cities'},
        ),
        migrations.AlterField(
            model_name='city',
            name='name',
            field=models.CharField(help_text='City/Town/Area name', max_length=100),
        ),
        migrations.CreateModel(
            name='LocationDistrict',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='District name', max_length=100)),
                ('code', models.CharField(blank=True, help_text='District code if applicable', max_length=10)),
                ('is_active', models.BooleanField(default=True, help_text='Whether this district is active')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('state', models.ForeignKey(help_text='Parent state', on_delete=django.db.models.deletion.CASCADE, related_name='location_districts', to='masters.state')),
            ],
            options={
                'verbose_name': 'Location District',
                'verbose_name_plural': 'Location Districts',
                'db_table': 'masters_location_districts',
                'ordering': ['state', 'name'],
                'unique_together': {('state', 'name')},
            },
        ),
        migrations.AlterUniqueTogether(
            name='city',
            unique_together=set(),
        ),
        migrations.AddField(
            model_name='city',
            name='district',
            field=models.ForeignKey(default=1, help_text='Parent district', on_delete=django.db.models.deletion.CASCADE, related_name='cities', to='masters.locationdistrict'),
            preserve_default=False,
        ),
        migrations.AlterUniqueTogether(
            name='city',
            unique_together={('district', 'name')},
        ),
        migrations.RemoveField(
            model_name='city',
            name='state',
        ),
    ]



================================================
FILE: backend/masters/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: backend/masters/models/__init__.py
================================================
# Import all models for easy access
from .hierarchy import Zone, Circle, Division, SubDivision
from .geography import District, Town
from .classification import SchemeType, Scheme, WorkType, ProjectCategory
from .entities import Contractor, ContractorBankAccount
from .finance_config import ETPMaster
from .locations import Country, State, LocationDistrict, City

__all__ = [
    # Hierarchy
    'Zone',
    'Circle',
    'Division',
    'SubDivision',
    # Geography
    'District',
    'Town',
    # Classification
    'SchemeType',
    'Scheme',
    'WorkType',
    'ProjectCategory',
    # Entities
    'Contractor',
    'ContractorBankAccount',
    # Finance Config
    'ETPMaster',
    # Locations
    'Country',
    'State',
    'City',
]



================================================
FILE: backend/masters/models/classification.py
================================================
"""
Classification Models for Project Categorization
SchemeType â†’ Scheme, WorkType, ProjectCategory
"""
from django.db import models
import uuid


class SchemeType(models.Model):
    """Classification of funding schemes"""
    CATEGORY_CHOICES = [
        ('Infrastructure', 'Infrastructure'),
        ('Social Sector', 'Social Sector'),
        ('Education', 'Education'),
        ('Health', 'Health'),
        ('Agriculture', 'Agriculture'),
        ('Other', 'Other'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., ST-CS")
    name = models.CharField(max_length=255, help_text="e.g., Centrally Sponsored")
    category = models.CharField(max_length=50, choices=CATEGORY_CHOICES, default='Infrastructure')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )

    class Meta:
        db_table = 'masters_scheme_type'
        ordering = ['code']
        verbose_name = 'Scheme Type'
        verbose_name_plural = 'Scheme Types'

    def __str__(self):
        return f"{self.code} - {self.name}"


class Scheme(models.Model):
    """Government funding programs/schemes"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., PMSGY")
    name = models.CharField(max_length=500, help_text="Full legal name of the program")
    scheme_type = models.ForeignKey(
        SchemeType,
        on_delete=models.PROTECT,
        related_name='schemes',
        help_text="Scheme classification"
    )
    funding_agency = models.CharField(max_length=255, blank=True, help_text="Central Govt/State Govt/World Bank")
    start_date = models.DateField(null=True, blank=True)
    end_date = models.DateField(null=True, blank=True)
    budget_head_code = models.CharField(max_length=50, blank=True, help_text="Budgetary ledger code")
    objective = models.TextField(blank=True, help_text="Brief goal or purpose")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )

    class Meta:
        db_table = 'masters_scheme'
        ordering = ['code']
        verbose_name = 'Scheme'
        verbose_name_plural = 'Schemes'

    def __str__(self):
        return f"{self.code} - {self.name}"


class WorkType(models.Model):
    """Type of construction/engineering work"""
    SECTOR_CHOICES = [
        ('PWD', 'Public Works Department'),
        ('Irrigation', 'Irrigation'),
        ('Health', 'Health'),
        ('Education', 'Education'),
        ('Roads', 'Roads & Highways'),
        ('Water Supply', 'Water Supply'),
        ('Other', 'Other'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., WT-ROAD")
    name = models.CharField(max_length=255, help_text="e.g., New Road Construction")
    sector = models.CharField(max_length=50, choices=SECTOR_CHOICES, default='PWD')
    unit_of_measurement = models.CharField(max_length=50, blank=True, help_text="Km/Sq.m/Meters")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )

    class Meta:
        db_table = 'masters_work_type'
        ordering = ['code']
        verbose_name = 'Work Type'
        verbose_name_plural = 'Work Types'

    def __str__(self):
        return f"{self.code} - {self.name}"


class ProjectCategory(models.Model):
    """Project size/administrative category for approval workflows"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., PC-MAJ")
    name = models.CharField(max_length=255, help_text="e.g., Major Project")
    threshold_value = models.DecimalField(
        max_digits=15,
        decimal_places=2,
        default=0,
        help_text="Minimum contract value in INR"
    )
    approval_authority = models.CharField(max_length=255, blank=True, help_text="e.g., Chief Engineer/Cabinet")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )

    class Meta:
        db_table = 'masters_project_category'
        ordering = ['threshold_value']
        verbose_name = 'Project Category'
        verbose_name_plural = 'Project Categories'

    def __str__(self):
        return f"{self.code} - {self.name}"



================================================
FILE: backend/masters/models/entities.py
================================================
"""
Entity Models for Contractors
Links to existing BankBranch model in banks app
"""
from django.db import models
from django.conf import settings
import uuid


class Contractor(models.Model):
    """Registered contractor/vendor master"""
    TYPE_CHOICES = [
        ('Proprietorship', 'Proprietorship'),
        ('Partnership', 'Partnership'),
        ('Private Limited', 'Private Limited'),
        ('Public Limited', 'Public Limited'),
        ('LLP', 'Limited Liability Partnership'),
        ('Government', 'Government Entity'),
        ('Other', 'Other'),
    ]
    
    CLASS_CHOICES = [
        ('Class A', 'Class A (Unlimited)'),
        ('Class B', 'Class B (Up to â‚¹50 Cr)'),
        ('Class C', 'Class C (Up to â‚¹10 Cr)'),
        ('Class D', 'Class D (Up to â‚¹2 Cr)'),
        ('Class E', 'Class E (Up to â‚¹50 Lakh)'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., C-10025")
    name = models.CharField(max_length=500, help_text="Full legal name of contractor/firm")
    contractor_type = models.CharField(max_length=50, choices=TYPE_CHOICES, default='Proprietorship')
    registration_class = models.CharField(max_length=20, choices=CLASS_CHOICES, blank=True)
    registration_number = models.CharField(max_length=100, blank=True, help_text="Official registration/license number")
    
    # Tax details
    pan = models.CharField(max_length=10, blank=True, help_text="10-digit PAN")
    gstin = models.CharField(max_length=15, blank=True, help_text="15-digit GSTIN")
    tds_rate = models.DecimalField(max_digits=5, decimal_places=2, default=2.00, help_text="TDS percentage")
    
    # Contact
    contact_person = models.CharField(max_length=255, blank=True)
    email = models.EmailField(blank=True)
    phone = models.CharField(max_length=20, blank=True)
    address = models.TextField(blank=True, help_text="Registered address")
    
    # Bank accounts - M2M to BankBranch
    bank_accounts = models.ManyToManyField(
        'banks.BankBranch',
        through='ContractorBankAccount',
        related_name='contractors',
        blank=True
    )
    
    # Status
    blacklisted = models.BooleanField(default=False, help_text="Barred from bidding")
    blacklist_reason = models.TextField(blank=True)
    validity_date = models.DateField(null=True, blank=True, help_text="Registration validity")
    
    # Link to User account (for self-registered contractors)
    linked_user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='contractor_profile',
        help_text="Linked user account for self-registered contractors"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'masters_contractor'
        ordering = ['name']
        verbose_name = 'Contractor'
        verbose_name_plural = 'Contractors'

    def __str__(self):
        return f"{self.code} - {self.name}"
    
    @property
    def is_valid(self):
        """Check if contractor registration is still valid"""
        from django.utils import timezone
        if not self.validity_date:
            return True
        return self.validity_date >= timezone.now().date()


class ContractorBankAccount(models.Model):
    """Through model for Contractor-Bank relationship with account number"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    contractor = models.ForeignKey(
        Contractor,
        on_delete=models.CASCADE,
        related_name='bank_account_details'
    )
    bank_branch = models.ForeignKey(
        'banks.BankBranch',
        on_delete=models.PROTECT,
        related_name='contractor_accounts'
    )
    account_number = models.CharField(max_length=30, help_text="Bank account number")
    account_type = models.CharField(
        max_length=20,
        choices=[
            ('Current', 'Current Account'),
            ('Savings', 'Savings Account'),
        ],
        default='Current'
    )
    is_primary = models.BooleanField(default=False, help_text="Primary account for payments")
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = 'masters_contractor_bank_account'
        unique_together = ['contractor', 'account_number']
        verbose_name = 'Contractor Bank Account'
        verbose_name_plural = 'Contractor Bank Accounts'

    def __str__(self):
        return f"{self.contractor.name} - {self.bank_branch.bank_name} ({self.account_number[-4:]})"



================================================
FILE: backend/masters/models/finance_config.py
================================================
"""
ETP Master - Establishment, Tools & Plant Charges
Drives billing deductions and recoveries
"""
from django.db import models
import uuid


class ETPMaster(models.Model):
    """ETP charges configuration for billing calculations"""
    CHARGE_TYPE_CHOICES = [
        ('Deduction', 'Deduction'),
        ('Recovery', 'Recovery'),
        ('Levy', 'Levy'),
        ('Addition', 'Addition'),
    ]
    
    BASIS_CHOICES = [
        ('Gross Bill Value', 'Gross Bill Value'),
        ('Works Component Only', 'Works Component Only'),
        ('Material Cost', 'Material Cost'),
        ('Labour Cost', 'Labour Cost'),
        ('Net Payable', 'Net Payable'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=30, unique=True, db_index=True, help_text="e.g., LABOUR-CESS")
    name = models.CharField(max_length=255, help_text="e.g., Labour Welfare Cess")
    
    charge_type = models.CharField(max_length=20, choices=CHARGE_TYPE_CHOICES, default='Deduction')
    rate_percentage = models.DecimalField(
        max_digits=6,
        decimal_places=3,
        default=0,
        help_text="e.g., 1.000 for 1%"
    )
    basis_of_calculation = models.CharField(
        max_length=50,
        choices=BASIS_CHOICES,
        default='Gross Bill Value',
        help_text="Which amount to apply the percentage on"
    )
    
    # Policy reference
    effective_date = models.DateField(help_text="Date from which rate is applicable")
    govt_reference = models.CharField(max_length=255, blank=True, help_text="Circular/order number")
    account_head = models.CharField(max_length=100, blank=True, help_text="Internal finance ledger code")
    
    # Status
    is_active = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'masters_etp'
        ordering = ['charge_type', 'code']
        verbose_name = 'ETP Charge'
        verbose_name_plural = 'ETP Charges'

    def __str__(self):
        return f"{self.code} - {self.name} ({self.rate_percentage}%)"
    
    @classmethod
    def get_active_charges(cls, charge_type=None):
        """Get all active ETP charges, optionally filtered by type"""
        from django.utils import timezone
        qs = cls.objects.filter(is_active=True, effective_date__lte=timezone.now().date())
        if charge_type:
            qs = qs.filter(charge_type=charge_type)
        return qs
    
    def calculate_amount(self, base_amount):
        """Calculate the charge amount based on percentage"""
        from decimal import Decimal
        return (Decimal(str(base_amount)) * self.rate_percentage / Decimal('100')).quantize(Decimal('0.01'))



================================================
FILE: backend/masters/models/geography.py
================================================
"""
Geography Models for Location Data
District â†’ Town
"""
from django.db import models
import uuid


class District(models.Model):
    """Geographical district classification"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., D-410")
    name = models.CharField(max_length=255, help_text="Official district name")
    state_name = models.CharField(max_length=100, help_text="State the district belongs to")
    pincode_range = models.CharField(max_length=100, blank=True, help_text="e.g., 560001 to 560099")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )

    class Meta:
        db_table = 'masters_district'
        ordering = ['state_name', 'name']
        verbose_name = 'District'
        verbose_name_plural = 'Districts'

    def __str__(self):
        return f"{self.code} - {self.name}, {self.state_name}"


class Town(models.Model):
    """Town/City within a District"""
    CLASSIFICATION_CHOICES = [
        ('Metropolitan', 'Metropolitan'),
        ('Municipality', 'Municipality'),
        ('Town', 'Town'),
        ('Village', 'Village'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., T-0010")
    name = models.CharField(max_length=255, help_text="Official town/city name")
    district = models.ForeignKey(
        District,
        on_delete=models.PROTECT,
        related_name='towns',
        help_text="Parent District"
    )
    classification = models.CharField(
        max_length=20,
        choices=CLASSIFICATION_CHOICES,
        default='Town'
    )
    population = models.PositiveIntegerField(null=True, blank=True, help_text="Estimated population")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )

    class Meta:
        db_table = 'masters_town'
        ordering = ['name']
        verbose_name = 'Town/City'
        verbose_name_plural = 'Towns/Cities'

    def __str__(self):
        return f"{self.code} - {self.name}"



================================================
FILE: backend/masters/models/hierarchy.py
================================================
"""
Hierarchy Models for Administrative Structure
Zone â†’ Circle â†’ Division â†’ SubDivision
"""
from django.db import models
from django.conf import settings
import uuid


class Zone(models.Model):
    """Highest level administrative grouping"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., ZN-SOUTH")
    name = models.CharField(max_length=255, help_text="Full name of the Zone")
    state_covered = models.CharField(max_length=255, blank=True, help_text="State or region managed")
    # Legacy text field (deprecated - use head_user instead)
    head = models.CharField(max_length=255, blank=True, help_text="[Deprecated] Zonal Head name and designation")
    # New: Link to User model for proper user management
    head_user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='headed_zones',
        help_text="User account of the Zonal Head"
    )
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'masters_zone'
        ordering = ['code']
        verbose_name = 'Zone'
        verbose_name_plural = 'Zones'

    def __str__(self):
        return f"{self.code} - {self.name}"
    
    @property
    def head_display(self):
        """Get head name from linked user or fallback to text field"""
        if self.head_user:
            return self.head_user.get_full_name() or self.head_user.username
        return self.head or 'Not Assigned'


class Circle(models.Model):
    """Grouping of divisions, usually headed by SE/CE"""
    AUTHORITY_CHOICES = [
        ('CE', 'Chief Engineer'),
        ('SE', 'Superintending Engineer'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., C-CIVIL")
    name = models.CharField(max_length=255, help_text="Full name of the Circle")
    zone = models.ForeignKey(
        Zone,
        on_delete=models.PROTECT,
        related_name='circles',
        help_text="Parent Zone"
    )
    authority_level = models.CharField(
        max_length=5,
        choices=AUTHORITY_CHOICES,
        default='SE',
        help_text="Rank of officer heading the Circle"
    )
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'masters_circle'
        ordering = ['code']
        verbose_name = 'Circle'
        verbose_name_plural = 'Circles'

    def __str__(self):
        return f"{self.code} - {self.name}"


class Division(models.Model):
    """Operational division within a Circle"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., DIV-NGR")
    name = models.CharField(max_length=255, help_text="Full name of the Division")
    circle = models.ForeignKey(
        Circle,
        on_delete=models.PROTECT,
        related_name='divisions',
        help_text="Parent Circle"
    )
    # Legacy text field (deprecated - use hod_user instead)
    hod = models.CharField(max_length=255, blank=True, help_text="[Deprecated] Head of Division name")
    # New: Link to User model for proper user management
    hod_user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='headed_divisions',
        help_text="User account of the Head of Division"
    )
    contact_email = models.EmailField(blank=True, help_text="Official email")
    contact_phone = models.CharField(max_length=20, blank=True, help_text="Official phone")
    effective_date = models.DateField(null=True, blank=True, help_text="Date division started")
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'masters_division'
        ordering = ['code']
        verbose_name = 'Division'
        verbose_name_plural = 'Divisions'

    def __str__(self):
        return f"{self.code} - {self.name}"
    
    @property
    def hod_display(self):
        """Get HOD name from linked user or fallback to text field"""
        if self.hod_user:
            return self.hod_user.get_full_name() or self.hod_user.username
        return self.hod or 'Not Assigned'


class SubDivision(models.Model):
    """Smallest administrative unit"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=20, unique=True, db_index=True, help_text="e.g., SD-01-W")
    name = models.CharField(max_length=255, help_text="Full name of Sub-Division")
    division = models.ForeignKey(
        Division,
        on_delete=models.PROTECT,
        related_name='subdivisions',
        help_text="Parent Division"
    )
    jurisdiction_area = models.CharField(max_length=500, blank=True, help_text="Geographical area covered")
    # Legacy text field (deprecated - use reporting_officer_user instead)
    reporting_officer = models.CharField(max_length=255, blank=True, help_text="[Deprecated] Sub-Divisional Engineer name")
    # New: Link to User model for proper user management
    reporting_officer_user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='managed_subdivisions',
        help_text="User account of the Sub-Divisional Engineer"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    status = models.CharField(
        max_length=20,
        choices=[('Active', 'Active'), ('Inactive', 'Inactive')],
        default='Active'
    )

    class Meta:
        db_table = 'masters_subdivision'
        ordering = ['code']
        verbose_name = 'Sub-Division'
        verbose_name_plural = 'Sub-Divisions'

    def __str__(self):
        return f"{self.code} - {self.name}"
    
    @property
    def reporting_officer_display(self):
        """Get officer name from linked user or fallback to text field"""
        if self.reporting_officer_user:
            return self.reporting_officer_user.get_full_name() or self.reporting_officer_user.username
        return self.reporting_officer or 'Not Assigned'



================================================
FILE: backend/masters/models/locations.py
================================================
"""
Location models for cascading country â†’ state â†’ district â†’ city dropdowns
Designed for India-focused hierarchy with easy expansion to other countries

Hierarchy:
  Country (e.g., India)
    â””â”€â”€ State (e.g., Telangana)
        â””â”€â”€ LocationDistrict (e.g., Medak) - Named to avoid collision with masters.District
            â””â”€â”€ City/Area (e.g., Zaheerabad)
"""
from django.db import models


class Country(models.Model):
    """
    Country Master Data
    Currently: India only
    Expandable: Add more countries by creating new records
    """
    name = models.CharField(
        max_length=100,
        unique=True,
        help_text="Country name (e.g., India)"
    )
    code = models.CharField(
        max_length=3,
        unique=True,
        help_text="ISO 3166-1 alpha-2 code (e.g., IN)"
    )
    dial_code = models.CharField(
        max_length=10,
        help_text="Country calling code (e.g., +91)"
    )
    is_active = models.BooleanField(
        default=True,
        help_text="Whether this country is active in the system"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'masters_countries'
        verbose_name = 'Country'
        verbose_name_plural = 'Countries'
        ordering = ['name']

    def __str__(self):
        return self.name


class State(models.Model):
    """
    State/Province Master Data
    Currently: Indian states and union territories
    Expandable: Add states for new countries
    """
    country = models.ForeignKey(
        Country,
        on_delete=models.CASCADE,
        related_name='states',
        help_text="Parent country"
    )
    name = models.CharField(
        max_length=100,
        help_text="State/Province name"
    )
    code = models.CharField(
        max_length=10,
        blank=True,
        help_text="State code (e.g., TG for Telangana)"
    )
    is_active = models.BooleanField(
        default=True,
        help_text="Whether this state is active"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'masters_states'
        verbose_name = 'State'
        verbose_name_plural = 'States'
        ordering = ['country', 'name']
        unique_together = [['country', 'name']]

    def __str__(self):
        return f"{self.name}, {self.country.name}"


class LocationDistrict(models.Model):
    """
    District Master Data - Administrative district within a state
    Named LocationDistrict to avoid collision with existing masters.District
    
    In India, districts are the primary administrative division under states.
    Examples: Medak, Hyderabad, Rangareddy (in Telangana)
    """
    state = models.ForeignKey(
        State,
        on_delete=models.CASCADE,
        related_name='location_districts',
        help_text="Parent state"
    )
    name = models.CharField(
        max_length=100,
        help_text="District name"
    )
    code = models.CharField(
        max_length=10,
        blank=True,
        help_text="District code if applicable"
    )
    is_active = models.BooleanField(
        default=True,
        help_text="Whether this district is active"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'masters_location_districts'
        verbose_name = 'Location District'
        verbose_name_plural = 'Location Districts'
        ordering = ['state', 'name']
        unique_together = [['state', 'name']]

    def __str__(self):
        return f"{self.name}, {self.state.name}"


class City(models.Model):
    """
    City/Town/Area Master Data
    Now linked to LocationDistrict instead of State directly
    """
    district = models.ForeignKey(
        LocationDistrict,
        on_delete=models.CASCADE,
        related_name='cities',
        help_text="Parent district"
    )
    name = models.CharField(
        max_length=100,
        help_text="City/Town/Area name"
    )
    code = models.CharField(
        max_length=10,
        blank=True,
        help_text="City code if applicable"
    )
    is_active = models.BooleanField(
        default=True,
        help_text="Whether this city is active"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'masters_cities'
        verbose_name = 'City'
        verbose_name_plural = 'Cities'
        ordering = ['district', 'name']
        unique_together = [['district', 'name']]

    def __str__(self):
        return f"{self.name}, {self.district.name}"



================================================
FILE: backend/procurement/__init__.py
================================================
[Empty file]


================================================
FILE: backend/procurement/admin.py
================================================
from django.contrib import admin
from .models import Tender, Bid, Contract, Variation


@admin.register(Tender)
class TenderAdmin(admin.ModelAdmin):
    list_display = ['tender_no', 'title', 'project', 'status', 'estimated_value', 'submission_deadline']
    list_filter = ['status', 'tender_type', 'project']
    search_fields = ['tender_no', 'title', 'description']
    date_hierarchy = 'created_at'


@admin.register(Bid)
class BidAdmin(admin.ModelAdmin):
    list_display = ['tender', 'bidder', 'bid_amount', 'status', 'combined_score', 'submission_date']
    list_filter = ['status', 'tender']
    search_fields = ['tender__tender_no', 'bidder__name']


@admin.register(Contract)
class ContractAdmin(admin.ModelAdmin):
    list_display = ['contract_no', 'contractor', 'project', 'contract_value', 'status', 'start_date', 'end_date']
    list_filter = ['status', 'project']
    search_fields = ['contract_no', 'contractor__name']
    date_hierarchy = 'created_at'


@admin.register(Variation)
class VariationAdmin(admin.ModelAdmin):
    list_display = ['variation_no', 'contract', 'title', 'amount', 'status', 'variation_type']
    list_filter = ['status', 'variation_type']
    search_fields = ['variation_no', 'title', 'description']



================================================
FILE: backend/procurement/apps.py
================================================
from django.apps import AppConfig


class ProcurementConfig(AppConfig):
    name = 'procurement'



================================================
FILE: backend/procurement/models.py
================================================
from django.db import models
from django.conf import settings
import uuid


class Tender(models.Model):
    """
    Manages the tendering process for project work packages.
    Links to projects and schedule tasks for workflow alignment.
    """
    class TenderType(models.TextChoices):
        OPEN = 'OPEN', 'Open Tender'
        LIMITED = 'LIMITED', 'Limited Tender'
        SINGLE = 'SINGLE', 'Single Source'
        E_TENDER = 'E_TENDER', 'e-Tender (GeM/NICDC Portal)'

    class TenderStatus(models.TextChoices):
        DRAFT = 'DRAFT', 'Draft'
        PUBLISHED = 'PUBLISHED', 'Published'
        BID_OPEN = 'BID_OPEN', 'Bid Opening'
        EVALUATION = 'EVALUATION', 'Under Evaluation'
        AWARDED = 'AWARDED', 'Awarded'
        CANCELLED = 'CANCELLED', 'Cancelled'
        CLOSED = 'CLOSED', 'Closed'

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    tender_no = models.CharField(max_length=50, unique=True)
    title = models.CharField(max_length=500)
    description = models.TextField(blank=True)
    
    # Project and Schedule Integration
    project = models.ForeignKey(
        'projects.Project', 
        on_delete=models.CASCADE, 
        related_name='tenders'
    )
    schedule_task = models.ForeignKey(
        'scheduling.ScheduleTask',
        on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='tenders',
        help_text="Linked schedule milestone/task for workflow alignment"
    )
    work_package = models.ForeignKey(
        'projects.WorkPackage',
        on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='tenders'
    )
    
    # Financial Details
    estimated_value = models.DecimalField(max_digits=15, decimal_places=2)
    earnest_money_deposit = models.DecimalField(max_digits=15, decimal_places=2, null=True, blank=True)
    
    # Tender Configuration
    tender_type = models.CharField(max_length=20, choices=TenderType.choices, default=TenderType.OPEN)
    status = models.CharField(max_length=20, choices=TenderStatus.choices, default=TenderStatus.DRAFT)
    
    # Timeline
    publish_date = models.DateField(null=True, blank=True)
    submission_deadline = models.DateTimeField(null=True, blank=True)
    bid_opening_date = models.DateTimeField(null=True, blank=True)
    
    # NICDC Portal Integration
    nicdc_portal_ref = models.CharField(max_length=100, null=True, blank=True, help_text="Reference ID from NICDC Procurement Portal")
    
    # Audit
    created_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, related_name='created_tenders')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.tender_no} - {self.title}"


class Bid(models.Model):
    """
    Bid submissions and evaluation for tenders.
    Links to Contractor master data.
    """
    class BidStatus(models.TextChoices):
        SUBMITTED = 'SUBMITTED', 'Submitted'
        TECHNICAL_EVAL = 'TECHNICAL_EVAL', 'Technical Evaluation'
        FINANCIAL_EVAL = 'FINANCIAL_EVAL', 'Financial Evaluation'
        QUALIFIED = 'QUALIFIED', 'Qualified'
        DISQUALIFIED = 'DISQUALIFIED', 'Disqualified'
        AWARDED = 'AWARDED', 'Awarded'
        REJECTED = 'REJECTED', 'Rejected'

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    tender = models.ForeignKey(Tender, on_delete=models.CASCADE, related_name='bids')
    
    # Bidder (linked to Contractor master)
    bidder = models.ForeignKey(
        'masters.Contractor',
        on_delete=models.CASCADE,
        related_name='bids'
    )
    
    # Bid Details
    bid_amount = models.DecimalField(max_digits=15, decimal_places=2)
    technical_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    financial_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    combined_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    
    status = models.CharField(max_length=20, choices=BidStatus.choices, default=BidStatus.SUBMITTED)
    
    # Timeline
    submission_date = models.DateTimeField(auto_now_add=True)
    evaluation_date = models.DateTimeField(null=True, blank=True)
    
    # Remarks
    technical_remarks = models.TextField(blank=True)
    financial_remarks = models.TextField(blank=True)
    
    # Audit
    evaluated_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, related_name='evaluated_bids')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-combined_score', 'bid_amount']
        unique_together = ['tender', 'bidder']

    def __str__(self):
        return f"Bid by {self.bidder.name} for {self.tender.tender_no}"


class Contract(models.Model):
    """
    Contract lifecycle management.
    Links tender award to execution with schedule integration.
    """
    class ContractStatus(models.TextChoices):
        DRAFT = 'DRAFT', 'Draft'
        SIGNED = 'SIGNED', 'Signed'
        ACTIVE = 'ACTIVE', 'Active'
        SUSPENDED = 'SUSPENDED', 'Suspended'
        COMPLETED = 'COMPLETED', 'Completed'
        TERMINATED = 'TERMINATED', 'Terminated'

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    contract_no = models.CharField(max_length=50, unique=True)
    
    # Source
    tender = models.OneToOneField(Tender, on_delete=models.CASCADE, related_name='contract')
    winning_bid = models.OneToOneField(Bid, on_delete=models.SET_NULL, null=True, related_name='awarded_contract')
    
    # Parties
    contractor = models.ForeignKey(
        'masters.Contractor',
        on_delete=models.CASCADE,
        related_name='contracts'
    )
    project = models.ForeignKey(
        'projects.Project',
        on_delete=models.CASCADE,
        related_name='contracts'
    )
    
    # Financial
    contract_value = models.DecimalField(max_digits=15, decimal_places=2)
    revised_value = models.DecimalField(max_digits=15, decimal_places=2, null=True, blank=True)
    performance_guarantee = models.DecimalField(max_digits=15, decimal_places=2, null=True, blank=True)
    
    # Schedule Integration
    schedule_task = models.ForeignKey(
        'scheduling.ScheduleTask',
        on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='contracts',
        help_text="Linked milestone - payments tied to schedule progress"
    )
    
    # Timeline
    signing_date = models.DateField(null=True, blank=True)
    start_date = models.DateField()
    end_date = models.DateField()
    revised_end_date = models.DateField(null=True, blank=True)
    
    status = models.CharField(max_length=20, choices=ContractStatus.choices, default=ContractStatus.DRAFT)
    
    # Audit
    created_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, related_name='created_contracts')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.contract_no} - {self.contractor.name}"
    
    @property
    def total_variations(self):
        return self.variations.aggregate(total=models.Sum('amount'))['total'] or 0
    
    @property
    def current_value(self):
        return self.contract_value + self.total_variations


class Variation(models.Model):
    """
    Variation/Change Order management.
    Tracks scope and cost changes to contracts.
    """
    class VariationStatus(models.TextChoices):
        PROPOSED = 'PROPOSED', 'Proposed'
        UNDER_REVIEW = 'UNDER_REVIEW', 'Under Review'
        APPROVED = 'APPROVED', 'Approved'
        REJECTED = 'REJECTED', 'Rejected'
        IMPLEMENTED = 'IMPLEMENTED', 'Implemented'

    class VariationType(models.TextChoices):
        SCOPE_CHANGE = 'SCOPE_CHANGE', 'Scope Change'
        TIME_EXTENSION = 'TIME_EXTENSION', 'Time Extension'
        PRICE_ADJUSTMENT = 'PRICE_ADJUSTMENT', 'Price Adjustment'
        QUANTITY_VARIATION = 'QUANTITY_VARIATION', 'Quantity Variation'

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    contract = models.ForeignKey(Contract, on_delete=models.CASCADE, related_name='variations')
    
    variation_no = models.CharField(max_length=50)
    title = models.CharField(max_length=255)
    description = models.TextField()
    
    variation_type = models.CharField(max_length=30, choices=VariationType.choices)
    
    # Impact
    amount = models.DecimalField(max_digits=15, decimal_places=2, help_text="Cost impact (+/-)")
    time_impact_days = models.IntegerField(default=0, help_text="Schedule impact in days")
    
    # Schedule Integration
    affected_task = models.ForeignKey(
        'scheduling.ScheduleTask',
        on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='variations',
        help_text="Schedule task affected by this variation"
    )
    
    status = models.CharField(max_length=20, choices=VariationStatus.choices, default=VariationStatus.PROPOSED)
    
    # Approval
    proposed_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, related_name='proposed_variations')
    approved_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, blank=True, related_name='approved_variations')
    approved_date = models.DateField(null=True, blank=True)
    
    # Audit
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']
        unique_together = ['contract', 'variation_no']

    def __str__(self):
        return f"{self.variation_no} - {self.title}"



================================================
FILE: backend/procurement/nicdc_integration.py
================================================
"""
NICDC Procurement Portal Integration Service

This module handles two-way synchronization between PMIS and the NICDC Procurement Portal.
The integration supports:
1. Pushing tenders to NICDC portal
2. Pulling tender updates from NICDC portal
3. Receiving webhook notifications for bid submissions

Configuration:
- Set NICDC_PORTAL_API_URL in .env
- Set NICDC_PORTAL_API_KEY in .env
"""
import logging
from typing import Optional, Dict, Any
from django.conf import settings
from django.utils import timezone
import requests

logger = logging.getLogger(__name__)


class NICDCPortalService:
    """
    Service for integrating with NICDC Procurement Portal.
    
    The NICDC portal is the central government procurement system.
    This service enables:
    - Publishing tenders to the portal
    - Syncing bid submissions back to PMIS
    - Status synchronization
    """
    
    def __init__(self):
        self.base_url = getattr(settings, 'NICDC_PORTAL_API_URL', None)
        self.api_key = getattr(settings, 'NICDC_PORTAL_API_KEY', None)
        self.enabled = bool(self.base_url and self.api_key)
    
    def _get_headers(self) -> Dict[str, str]:
        return {
            'Authorization': f'Bearer {self.api_key}',
            'Content-Type': 'application/json',
            'X-Source-System': 'PMIS-ZIA',
        }
    
    def is_configured(self) -> bool:
        """Check if NICDC integration is configured."""
        return self.enabled
    
    def publish_tender(self, tender) -> Optional[str]:
        """
        Publish a tender to NICDC Procurement Portal.
        
        Returns the NICDC reference ID if successful.
        """
        if not self.enabled:
            logger.warning("NICDC Portal integration not configured")
            return None
        
        payload = {
            'source_system': 'PMIS-ZIA',
            'source_ref': str(tender.id),
            'tender_no': tender.tender_no,
            'title': tender.title,
            'description': tender.description,
            'estimated_value': str(tender.estimated_value),
            'tender_type': tender.tender_type,
            'publish_date': tender.publish_date.isoformat() if tender.publish_date else None,
            'submission_deadline': tender.submission_deadline.isoformat() if tender.submission_deadline else None,
            'project': {
                'name': tender.project.name if tender.project else None,
                'location': tender.project.location if tender.project else None,
            }
        }
        
        try:
            response = requests.post(
                f'{self.base_url}/api/v1/tenders/',
                json=payload,
                headers=self._get_headers(),
                timeout=30
            )
            response.raise_for_status()
            
            data = response.json()
            nicdc_ref = data.get('reference_id')
            
            # Store the NICDC reference back to tender
            tender.nicdc_portal_ref = nicdc_ref
            tender.save(update_fields=['nicdc_portal_ref'])
            
            logger.info(f"Tender {tender.tender_no} published to NICDC: {nicdc_ref}")
            return nicdc_ref
            
        except requests.RequestException as e:
            logger.error(f"Failed to publish tender to NICDC: {e}")
            return None
    
    def sync_tender_status(self, tender) -> bool:
        """
        Sync tender status from NICDC Portal.
        """
        if not self.enabled or not tender.nicdc_portal_ref:
            return False
        
        try:
            response = requests.get(
                f'{self.base_url}/api/v1/tenders/{tender.nicdc_portal_ref}/',
                headers=self._get_headers(),
                timeout=30
            )
            response.raise_for_status()
            
            data = response.json()
            # Update local tender with portal status
            # (mapping depends on NICDC portal schema)
            
            return True
            
        except requests.RequestException as e:
            logger.error(f"Failed to sync tender from NICDC: {e}")
            return False
    
    def fetch_bids(self, tender) -> list:
        """
        Fetch bids submitted via NICDC Portal.
        """
        if not self.enabled or not tender.nicdc_portal_ref:
            return []
        
        try:
            response = requests.get(
                f'{self.base_url}/api/v1/tenders/{tender.nicdc_portal_ref}/bids/',
                headers=self._get_headers(),
                timeout=30
            )
            response.raise_for_status()
            
            return response.json().get('bids', [])
            
        except requests.RequestException as e:
            logger.error(f"Failed to fetch bids from NICDC: {e}")
            return []
    
    def update_contract_status(self, contract) -> bool:
        """
        Update contract status on NICDC Portal.
        """
        if not self.enabled or not contract.tender.nicdc_portal_ref:
            return False
        
        payload = {
            'contract_no': contract.contract_no,
            'contractor_name': contract.contractor.name,
            'contract_value': str(contract.contract_value),
            'status': contract.status,
            'signing_date': contract.signing_date.isoformat() if contract.signing_date else None,
        }
        
        try:
            response = requests.post(
                f'{self.base_url}/api/v1/tenders/{contract.tender.nicdc_portal_ref}/contract/',
                json=payload,
                headers=self._get_headers(),
                timeout=30
            )
            response.raise_for_status()
            return True
            
        except requests.RequestException as e:
            logger.error(f"Failed to update contract on NICDC: {e}")
            return False


# Singleton instance
nicdc_service = NICDCPortalService()


def process_nicdc_webhook(payload: Dict[str, Any]) -> bool:
    """
    Process incoming webhook from NICDC Portal.
    
    Webhook events:
    - bid_submitted: New bid received
    - tender_closed: Tender deadline passed
    - clarification_requested: Bidder requested clarification
    """
    from .models import Tender, Bid
    
    event_type = payload.get('event_type')
    tender_ref = payload.get('tender_reference')
    
    try:
        tender = Tender.objects.get(nicdc_portal_ref=tender_ref)
    except Tender.DoesNotExist:
        logger.warning(f"Tender not found for NICDC ref: {tender_ref}")
        return False
    
    if event_type == 'bid_submitted':
        # Create bid record from webhook data
        bid_data = payload.get('bid_data', {})
        # Process bid creation...
        logger.info(f"Bid received via NICDC webhook for {tender.tender_no}")
        return True
    
    elif event_type == 'tender_closed':
        tender.status = 'BID_OPEN'
        tender.save(update_fields=['status'])
        return True
    
    return False



================================================
FILE: backend/procurement/serializers.py
================================================
from rest_framework import serializers
from .models import Tender, Bid, Contract, Variation


class TenderSerializer(serializers.ModelSerializer):
    project_name = serializers.CharField(source='project.name', read_only=True)
    work_package_name = serializers.CharField(source='work_package.name', read_only=True)
    schedule_task_name = serializers.CharField(source='schedule_task.name', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    type_display = serializers.CharField(source='get_tender_type_display', read_only=True)
    bids_count = serializers.IntegerField(source='bids.count', read_only=True)
    created_by_name = serializers.CharField(source='created_by.get_full_name', read_only=True)

    class Meta:
        model = Tender
        fields = [
            'id', 'tender_no', 'title', 'description',
            'project', 'project_name',
            'schedule_task', 'schedule_task_name',
            'work_package', 'work_package_name',
            'estimated_value', 'earnest_money_deposit',
            'tender_type', 'type_display',
            'status', 'status_display',
            'publish_date', 'submission_deadline', 'bid_opening_date',
            'nicdc_portal_ref',
            'bids_count',
            'created_by', 'created_by_name',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'created_by', 'created_at', 'updated_at']


class BidSerializer(serializers.ModelSerializer):
    tender_no = serializers.CharField(source='tender.tender_no', read_only=True)
    bidder_name = serializers.CharField(source='bidder.name', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = Bid
        fields = [
            'id', 'tender', 'tender_no',
            'bidder', 'bidder_name',
            'bid_amount',
            'technical_score', 'financial_score', 'combined_score',
            'status', 'status_display',
            'submission_date', 'evaluation_date',
            'technical_remarks', 'financial_remarks',
            'evaluated_by',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'submission_date', 'created_at', 'updated_at']


class ContractSerializer(serializers.ModelSerializer):
    tender_no = serializers.CharField(source='tender.tender_no', read_only=True)
    contractor_name = serializers.CharField(source='contractor.name', read_only=True)
    project_name = serializers.CharField(source='project.name', read_only=True)
    schedule_task_name = serializers.CharField(source='schedule_task.name', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    current_value = serializers.DecimalField(max_digits=15, decimal_places=2, read_only=True)
    total_variations = serializers.DecimalField(max_digits=15, decimal_places=2, read_only=True)
    variations_count = serializers.IntegerField(source='variations.count', read_only=True)

    class Meta:
        model = Contract
        fields = [
            'id', 'contract_no',
            'tender', 'tender_no',
            'winning_bid',
            'contractor', 'contractor_name',
            'project', 'project_name',
            'schedule_task', 'schedule_task_name',
            'contract_value', 'revised_value', 'current_value', 'total_variations',
            'performance_guarantee',
            'signing_date', 'start_date', 'end_date', 'revised_end_date',
            'status', 'status_display',
            'variations_count',
            'created_by',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'created_by', 'created_at', 'updated_at', 'current_value', 'total_variations']


class VariationSerializer(serializers.ModelSerializer):
    contract_no = serializers.CharField(source='contract.contract_no', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    type_display = serializers.CharField(source='get_variation_type_display', read_only=True)
    affected_task_name = serializers.CharField(source='affected_task.name', read_only=True)
    proposed_by_name = serializers.CharField(source='proposed_by.get_full_name', read_only=True)
    approved_by_name = serializers.CharField(source='approved_by.get_full_name', read_only=True)

    class Meta:
        model = Variation
        fields = [
            'id', 'contract', 'contract_no',
            'variation_no', 'title', 'description',
            'variation_type', 'type_display',
            'amount', 'time_impact_days',
            'affected_task', 'affected_task_name',
            'status', 'status_display',
            'proposed_by', 'proposed_by_name',
            'approved_by', 'approved_by_name', 'approved_date',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'proposed_by', 'created_at', 'updated_at']


# Summary/List Serializers for optimized listing
class TenderListSerializer(serializers.ModelSerializer):
    project_name = serializers.CharField(source='project.name', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    bids_count = serializers.IntegerField(source='bids.count', read_only=True)

    class Meta:
        model = Tender
        fields = ['id', 'tender_no', 'title', 'project_name', 'estimated_value', 
                  'tender_type', 'status', 'status_display', 'submission_deadline', 'bids_count']


class ContractListSerializer(serializers.ModelSerializer):
    contractor_name = serializers.CharField(source='contractor.name', read_only=True)
    project_name = serializers.CharField(source='project.name', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = Contract
        fields = ['id', 'contract_no', 'contractor_name', 'project_name', 
                  'contract_value', 'status', 'status_display', 'start_date', 'end_date']



================================================
FILE: backend/procurement/tests.py
================================================
from django.test import TestCase

# Create your tests here.



================================================
FILE: backend/procurement/urls.py
================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny
from rest_framework.response import Response
from .views import TenderViewSet, BidViewSet, ContractViewSet, VariationViewSet

router = DefaultRouter()
router.register(r'tenders', TenderViewSet, basename='tender')
router.register(r'bids', BidViewSet, basename='bid')
router.register(r'contracts', ContractViewSet, basename='contract')
router.register(r'variations', VariationViewSet, basename='variation')


@api_view(['POST'])
@permission_classes([AllowAny])  # Webhook uses API key validation
def nicdc_webhook(request):
    """
    Webhook endpoint for NICDC Procurement Portal callbacks.
    Receives notifications for: bid submissions, tender closures, clarifications.
    """
    from .nicdc_integration import process_nicdc_webhook
    
    # Validate webhook signature (in production)
    # api_key = request.headers.get('X-NICDC-Signature')
    
    payload = request.data
    success = process_nicdc_webhook(payload)
    
    if success:
        return Response({'status': 'processed'})
    return Response({'status': 'ignored'})


urlpatterns = [
    path('', include(router.urls)),
    path('webhooks/nicdc/', nicdc_webhook, name='nicdc-webhook'),
]



================================================
FILE: backend/procurement/views.py
================================================
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.utils import timezone
from django.db.models import Count, Sum

from .models import Tender, Bid, Contract, Variation
from .serializers import (
    TenderSerializer, TenderListSerializer,
    BidSerializer,
    ContractSerializer, ContractListSerializer,
    VariationSerializer
)


class TenderViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Tender CRUD with workflow actions.
    """
    queryset = Tender.objects.select_related('project', 'work_package', 'schedule_task', 'created_by').all()
    serializer_class = TenderSerializer
    permission_classes = [IsAuthenticated]

    def get_serializer_class(self):
        if self.action == 'list':
            return TenderListSerializer
        return TenderSerializer

    def perform_create(self, serializer):
        serializer.save(created_by=self.request.user)

    @action(detail=True, methods=['post'])
    def publish(self, request, pk=None):
        """Publish a draft tender."""
        tender = self.get_object()
        if tender.status != Tender.TenderStatus.DRAFT:
            return Response({'error': 'Only draft tenders can be published'}, status=status.HTTP_400_BAD_REQUEST)
        
        tender.status = Tender.TenderStatus.PUBLISHED
        tender.publish_date = timezone.now().date()
        tender.save()
        return Response(TenderSerializer(tender).data)

    @action(detail=True, methods=['post'])
    def sync_to_nicdc(self, request, pk=None):
        """
        Publish tender to NICDC Procurement Portal for external visibility.
        This enables bidders to view and submit bids through the central portal.
        """
        from .nicdc_integration import nicdc_service
        
        tender = self.get_object()
        
        if not nicdc_service.is_configured():
            return Response({
                'error': 'NICDC Portal integration is not configured',
                'hint': 'Set NICDC_PORTAL_API_URL and NICDC_PORTAL_API_KEY in environment'
            }, status=status.HTTP_503_SERVICE_UNAVAILABLE)
        
        if tender.nicdc_portal_ref:
            return Response({
                'message': 'Tender already synced to NICDC Portal',
                'nicdc_ref': tender.nicdc_portal_ref
            })
        
        nicdc_ref = nicdc_service.publish_tender(tender)
        
        if nicdc_ref:
            return Response({
                'message': 'Tender published to NICDC Portal',
                'nicdc_ref': nicdc_ref
            })
        else:
            return Response({
                'error': 'Failed to publish tender to NICDC Portal'
            }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

    @action(detail=True, methods=['post'])
    def open_bids(self, request, pk=None):
        """Open bids for evaluation."""
        tender = self.get_object()
        if tender.status != Tender.TenderStatus.PUBLISHED:
            return Response({'error': 'Tender must be published first'}, status=status.HTTP_400_BAD_REQUEST)
        
        tender.status = Tender.TenderStatus.BID_OPEN
        tender.save()
        return Response(TenderSerializer(tender).data)

    @action(detail=True, methods=['post'])
    def start_evaluation(self, request, pk=None):
        """Start bid evaluation."""
        tender = self.get_object()
        tender.status = Tender.TenderStatus.EVALUATION
        tender.save()
        return Response(TenderSerializer(tender).data)

    @action(detail=True, methods=['post'])
    def award(self, request, pk=None):
        """Award tender to winning bidder."""
        tender = self.get_object()
        winning_bid_id = request.data.get('winning_bid_id')
        
        if not winning_bid_id:
            return Response({'error': 'winning_bid_id is required'}, status=status.HTTP_400_BAD_REQUEST)
        
        try:
            winning_bid = Bid.objects.get(id=winning_bid_id, tender=tender)
        except Bid.DoesNotExist:
            return Response({'error': 'Invalid bid'}, status=status.HTTP_400_BAD_REQUEST)
        
        # Update tender and bid status
        tender.status = Tender.TenderStatus.AWARDED
        tender.save()
        
        winning_bid.status = Bid.BidStatus.AWARDED
        winning_bid.save()
        
        # Mark other bids as rejected
        Bid.objects.filter(tender=tender).exclude(id=winning_bid_id).update(status=Bid.BidStatus.REJECTED)
        
        return Response(TenderSerializer(tender).data)

    @action(detail=True, methods=['get'])
    def bids(self, request, pk=None):
        """Get all bids for a tender."""
        tender = self.get_object()
        bids = tender.bids.select_related('bidder', 'evaluated_by').all()
        return Response(BidSerializer(bids, many=True).data)


class BidViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Bid submission and evaluation.
    """
    queryset = Bid.objects.select_related('tender', 'bidder', 'evaluated_by').all()
    serializer_class = BidSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        queryset = super().get_queryset()
        tender_id = self.request.query_params.get('tender')
        if tender_id:
            queryset = queryset.filter(tender_id=tender_id)
        return queryset

    @action(detail=True, methods=['post'])
    def evaluate(self, request, pk=None):
        """Evaluate a bid with scores."""
        bid = self.get_object()
        
        technical_score = request.data.get('technical_score')
        financial_score = request.data.get('financial_score')
        
        if technical_score is not None:
            bid.technical_score = technical_score
        if financial_score is not None:
            bid.financial_score = financial_score
        
        # Calculate combined score (70% technical, 30% financial by default)
        if bid.technical_score and bid.financial_score:
            bid.combined_score = (bid.technical_score * 0.7) + (bid.financial_score * 0.3)
        
        bid.status = Bid.BidStatus.FINANCIAL_EVAL if technical_score else Bid.BidStatus.TECHNICAL_EVAL
        bid.evaluated_by = request.user
        bid.evaluation_date = timezone.now()
        bid.save()
        
        return Response(BidSerializer(bid).data)

    @action(detail=True, methods=['post'])
    def qualify(self, request, pk=None):
        """Mark bid as qualified."""
        bid = self.get_object()
        bid.status = Bid.BidStatus.QUALIFIED
        bid.save()
        return Response(BidSerializer(bid).data)

    @action(detail=True, methods=['post'])
    def disqualify(self, request, pk=None):
        """Mark bid as disqualified."""
        bid = self.get_object()
        bid.status = Bid.BidStatus.DISQUALIFIED
        bid.technical_remarks = request.data.get('reason', '')
        bid.save()
        return Response(BidSerializer(bid).data)


class ContractViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Contract lifecycle management.
    """
    queryset = Contract.objects.select_related(
        'tender', 'contractor', 'project', 'schedule_task', 'created_by'
    ).prefetch_related('variations').all()
    serializer_class = ContractSerializer
    permission_classes = [IsAuthenticated]

    def get_serializer_class(self):
        if self.action == 'list':
            return ContractListSerializer
        return ContractSerializer

    def perform_create(self, serializer):
        serializer.save(created_by=self.request.user)

    @action(detail=True, methods=['post'])
    def sign(self, request, pk=None):
        """Mark contract as signed."""
        contract = self.get_object()
        contract.status = Contract.ContractStatus.SIGNED
        contract.signing_date = request.data.get('signing_date', timezone.now().date())
        contract.save()
        return Response(ContractSerializer(contract).data)

    @action(detail=True, methods=['post'])
    def activate(self, request, pk=None):
        """Activate signed contract."""
        contract = self.get_object()
        if contract.status != Contract.ContractStatus.SIGNED:
            return Response({'error': 'Contract must be signed first'}, status=status.HTTP_400_BAD_REQUEST)
        
        contract.status = Contract.ContractStatus.ACTIVE
        contract.save()
        return Response(ContractSerializer(contract).data)

    @action(detail=True, methods=['post'])
    def complete(self, request, pk=None):
        """Mark contract as completed."""
        contract = self.get_object()
        contract.status = Contract.ContractStatus.COMPLETED
        contract.save()
        return Response(ContractSerializer(contract).data)

    @action(detail=True, methods=['get'])
    def variations(self, request, pk=None):
        """Get all variations for a contract."""
        contract = self.get_object()
        variations = contract.variations.all()
        return Response(VariationSerializer(variations, many=True).data)

    @action(detail=False, methods=['get'])
    def summary(self, request):
        """Get contract summary statistics."""
        contracts = self.get_queryset()
        summary = {
            'total_contracts': contracts.count(),
            'active_contracts': contracts.filter(status=Contract.ContractStatus.ACTIVE).count(),
            'total_value': contracts.aggregate(total=Sum('contract_value'))['total'] or 0,
            'total_variations': Variation.objects.filter(status=Variation.VariationStatus.APPROVED).aggregate(total=Sum('amount'))['total'] or 0,
        }
        return Response(summary)


class VariationViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Variation/Change Order management.
    """
    queryset = Variation.objects.select_related(
        'contract', 'affected_task', 'proposed_by', 'approved_by'
    ).all()
    serializer_class = VariationSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        queryset = super().get_queryset()
        contract_id = self.request.query_params.get('contract')
        if contract_id:
            queryset = queryset.filter(contract_id=contract_id)
        return queryset

    def perform_create(self, serializer):
        serializer.save(proposed_by=self.request.user)

    @action(detail=True, methods=['post'])
    def approve(self, request, pk=None):
        """Approve a variation."""
        variation = self.get_object()
        variation.status = Variation.VariationStatus.APPROVED
        variation.approved_by = request.user
        variation.approved_date = timezone.now().date()
        variation.save()
        
        # Update contract revised value
        contract = variation.contract
        contract.revised_value = contract.current_value
        if variation.time_impact_days > 0 and contract.end_date:
            from datetime import timedelta
            contract.revised_end_date = contract.end_date + timedelta(days=variation.time_impact_days)
        contract.save()
        
        return Response(VariationSerializer(variation).data)

    @action(detail=True, methods=['post'])
    def reject(self, request, pk=None):
        """Reject a variation."""
        variation = self.get_object()
        variation.status = Variation.VariationStatus.REJECTED
        variation.approved_by = request.user
        variation.approved_date = timezone.now().date()
        variation.save()
        return Response(VariationSerializer(variation).data)



================================================
FILE: backend/procurement/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2026-01-06 16:04

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('masters', '0003_add_linked_user_to_contractor'),
        ('projects', '0003_add_master_foreignkeys'),
        ('scheduling', '0002_scheduletask_external_id_scheduletask_metadata'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Bid',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('bid_amount', models.DecimalField(decimal_places=2, max_digits=15)),
                ('technical_score', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True)),
                ('financial_score', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True)),
                ('combined_score', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True)),
                ('status', models.CharField(choices=[('SUBMITTED', 'Submitted'), ('TECHNICAL_EVAL', 'Technical Evaluation'), ('FINANCIAL_EVAL', 'Financial Evaluation'), ('QUALIFIED', 'Qualified'), ('DISQUALIFIED', 'Disqualified'), ('AWARDED', 'Awarded'), ('REJECTED', 'Rejected')], default='SUBMITTED', max_length=20)),
                ('submission_date', models.DateTimeField(auto_now_add=True)),
                ('evaluation_date', models.DateTimeField(blank=True, null=True)),
                ('technical_remarks', models.TextField(blank=True)),
                ('financial_remarks', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('bidder', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='bids', to='masters.contractor')),
                ('evaluated_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='evaluated_bids', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-combined_score', 'bid_amount'],
            },
        ),
        migrations.CreateModel(
            name='Tender',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('tender_no', models.CharField(max_length=50, unique=True)),
                ('title', models.CharField(max_length=500)),
                ('description', models.TextField(blank=True)),
                ('estimated_value', models.DecimalField(decimal_places=2, max_digits=15)),
                ('earnest_money_deposit', models.DecimalField(blank=True, decimal_places=2, max_digits=15, null=True)),
                ('tender_type', models.CharField(choices=[('OPEN', 'Open Tender'), ('LIMITED', 'Limited Tender'), ('SINGLE', 'Single Source'), ('E_TENDER', 'e-Tender (GeM/NICDC Portal)')], default='OPEN', max_length=20)),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('PUBLISHED', 'Published'), ('BID_OPEN', 'Bid Opening'), ('EVALUATION', 'Under Evaluation'), ('AWARDED', 'Awarded'), ('CANCELLED', 'Cancelled'), ('CLOSED', 'Closed')], default='DRAFT', max_length=20)),
                ('publish_date', models.DateField(blank=True, null=True)),
                ('submission_deadline', models.DateTimeField(blank=True, null=True)),
                ('bid_opening_date', models.DateTimeField(blank=True, null=True)),
                ('nicdc_portal_ref', models.CharField(blank=True, help_text='Reference ID from NICDC Procurement Portal', max_length=100, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_tenders', to=settings.AUTH_USER_MODEL)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tenders', to='projects.project')),
                ('schedule_task', models.ForeignKey(blank=True, help_text='Linked schedule milestone/task for workflow alignment', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='tenders', to='scheduling.scheduletask')),
                ('work_package', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='tenders', to='projects.workpackage')),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='Contract',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('contract_no', models.CharField(max_length=50, unique=True)),
                ('contract_value', models.DecimalField(decimal_places=2, max_digits=15)),
                ('revised_value', models.DecimalField(blank=True, decimal_places=2, max_digits=15, null=True)),
                ('performance_guarantee', models.DecimalField(blank=True, decimal_places=2, max_digits=15, null=True)),
                ('signing_date', models.DateField(blank=True, null=True)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField()),
                ('revised_end_date', models.DateField(blank=True, null=True)),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('SIGNED', 'Signed'), ('ACTIVE', 'Active'), ('SUSPENDED', 'Suspended'), ('COMPLETED', 'Completed'), ('TERMINATED', 'Terminated')], default='DRAFT', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('contractor', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='contracts', to='masters.contractor')),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_contracts', to=settings.AUTH_USER_MODEL)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='contracts', to='projects.project')),
                ('schedule_task', models.ForeignKey(blank=True, help_text='Linked milestone - payments tied to schedule progress', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='contracts', to='scheduling.scheduletask')),
                ('winning_bid', models.OneToOneField(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='awarded_contract', to='procurement.bid')),
                ('tender', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='contract', to='procurement.tender')),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.AddField(
            model_name='bid',
            name='tender',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='bids', to='procurement.tender'),
        ),
        migrations.AlterUniqueTogether(
            name='bid',
            unique_together={('tender', 'bidder')},
        ),
        migrations.CreateModel(
            name='Variation',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('variation_no', models.CharField(max_length=50)),
                ('title', models.CharField(max_length=255)),
                ('description', models.TextField()),
                ('variation_type', models.CharField(choices=[('SCOPE_CHANGE', 'Scope Change'), ('TIME_EXTENSION', 'Time Extension'), ('PRICE_ADJUSTMENT', 'Price Adjustment'), ('QUANTITY_VARIATION', 'Quantity Variation')], max_length=30)),
                ('amount', models.DecimalField(decimal_places=2, help_text='Cost impact (+/-)', max_digits=15)),
                ('time_impact_days', models.IntegerField(default=0, help_text='Schedule impact in days')),
                ('status', models.CharField(choices=[('PROPOSED', 'Proposed'), ('UNDER_REVIEW', 'Under Review'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected'), ('IMPLEMENTED', 'Implemented')], default='PROPOSED', max_length=20)),
                ('approved_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('affected_task', models.ForeignKey(blank=True, help_text='Schedule task affected by this variation', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='variations', to='scheduling.scheduletask')),
                ('approved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approved_variations', to=settings.AUTH_USER_MODEL)),
                ('contract', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='variations', to='procurement.contract')),
                ('proposed_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='proposed_variations', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-created_at'],
                'unique_together': {('contract', 'variation_no')},
            },
        ),
    ]



================================================
FILE: backend/procurement/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: backend/projects/__init__.py
================================================
[Empty file]


================================================
FILE: backend/projects/admin.py
================================================
from django.contrib import admin
from .models import Project, WorkPackage


@admin.register(Project)
class ProjectAdmin(admin.ModelAdmin):
    """
    Admin configuration for Project model.
    
    Progress fields are READ-ONLY because they are computed by the
    ProjectProgressCalculator service. They cannot be edited directly.
    """
    
    list_display = [
        'name', 
        'status', 
        'physical_progress_display',
        'financial_progress_display',
        'progress_state',
        'budget',
        'created_at'
    ]
    
    list_filter = ['status', 'progress_state', 'zone', 'circle']
    
    search_fields = ['name', 'description']
    
    readonly_fields = [
        # All computed progress fields are strictly read-only
        'physical_progress',
        'financial_progress',
        'earned_value',
        'progress_state',
        'schedule_variance',
        'progress',  # Legacy field
        # Timestamps
        'created_at',
        'updated_at',
        # Computed display properties
        'hierarchy_display',
        'location_display',
    ]
    
    fieldsets = [
        ('Basic Information', {
            'fields': [
                'name',
                'description',
                'status',
                ('start_date', 'end_date'),
            ]
        }),
        ('Progress (Read-Only - Computed from Tasks)', {
            'fields': [
                ('physical_progress', 'financial_progress'),
                ('earned_value', 'schedule_variance'),
                'progress_state',
                'progress',
            ],
            'description': 'These fields are computed automatically from task-level data. They cannot be edited directly.',
        }),
        ('Financial', {
            'fields': [
                ('budget', 'spent'),
            ]
        }),
        ('Hierarchy', {
            'fields': [
                'zone',
                'circle',
                'division',
                'sub_division',
            ],
            'classes': ['collapse'],
        }),
        ('Geography', {
            'fields': [
                'district',
                'town',
                ('lat', 'lng'),
                'address',
            ],
            'classes': ['collapse'],
        }),
        ('Classification', {
            'fields': [
                'scheme_type',
                'scheme',
                'work_type',
                'project_category',
            ],
            'classes': ['collapse'],
        }),
        ('Other', {
            'fields': [
                'manager',
                'stakeholders',
                'category',
                'land_acquisition_status',
            ],
            'classes': ['collapse'],
        }),
        ('Timestamps', {
            'fields': [
                ('created_at', 'updated_at'),
            ],
        }),
    ]
    
    def physical_progress_display(self, obj):
        """Formatted physical progress for list display."""
        return f"{obj.physical_progress:.1f}%"
    physical_progress_display.short_description = 'Physical %'
    physical_progress_display.admin_order_field = 'physical_progress'
    
    def financial_progress_display(self, obj):
        """Formatted financial progress for list display."""
        return f"{obj.financial_progress:.1f}%"
    financial_progress_display.short_description = 'Financial %'
    financial_progress_display.admin_order_field = 'financial_progress'


@admin.register(WorkPackage)
class WorkPackageAdmin(admin.ModelAdmin):
    """Admin configuration for WorkPackage model."""
    
    list_display = [
        'name',
        'project',
        'contractor',
        'status',
        'budget',
        'start_date',
        'end_date',
    ]
    
    list_filter = ['status', 'project']
    
    search_fields = ['name', 'description', 'project__name']
    
    readonly_fields = ['created_at', 'updated_at']



================================================
FILE: backend/projects/apps.py
================================================
from django.apps import AppConfig


class ProjectsConfig(AppConfig):
    name = 'projects'
    default_auto_field = 'django.db.models.BigAutoField'
    
    def ready(self):
        """Import signals when Django app is ready."""
        import projects.signals  # noqa: F401



================================================
FILE: backend/projects/calendar_service.py
================================================
"""
Calendar Event Aggregation Service

Aggregates time-sensitive events from multiple modules into a unified calendar view.
Supports milestones, billing events, compliance deadlines, and workflow items.
"""
from django.db.models import Q
from django.utils import timezone
from datetime import timedelta
from typing import List, Dict, Any, Optional
import logging

logger = logging.getLogger(__name__)


class CalendarEventType:
    """Event type constants with colors."""
    MILESTONE = 'MILESTONE'
    BILLING = 'BILLING'
    RISK = 'RISK'
    COMPLIANCE = 'COMPLIANCE'
    WORKFLOW = 'WORKFLOW'
    MEETING = 'MEETING'
    
    COLORS = {
        MILESTONE: '#3b82f6',      # Blue
        BILLING: '#10b981',        # Green
        RISK: '#ef4444',           # Red
        COMPLIANCE: '#f97316',     # Orange
        WORKFLOW: '#8b5cf6',       # Purple
        MEETING: '#06b6d4',        # Cyan
    }


class CalendarEventAggregator:
    """
    Aggregates events from all modules into unified calendar format.
    """
    
    def get_events(
        self, 
        user,
        start_date,
        end_date,
        filters: Optional[Dict] = None
    ) -> List[Dict[str, Any]]:
        """
        Get all calendar events within date range.
        
        Args:
            user: Current user
            start_date: Start of date range
            end_date: End of date range
            filters: Optional filters (event_types, projects, etc.)
            
        Returns:
            List of event dictionaries
        """
        events = []
        filters = filters or {}
        event_types = filters.get('event_types', [])
        project_ids = filters.get('projects', [])
        
        # Collect events from all sources
        if not event_types or CalendarEventType.MILESTONE in event_types:
            events.extend(self._get_milestone_events(start_date, end_date, project_ids))
        
        if not event_types or CalendarEventType.BILLING in event_types:
            events.extend(self._get_billing_events(start_date, end_date, project_ids))
        
        if not event_types or CalendarEventType.RISK in event_types:
            events.extend(self._get_risk_events(start_date, end_date, project_ids))
        
        if not event_types or CalendarEventType.COMPLIANCE in event_types:
            events.extend(self._get_compliance_events(start_date, end_date, project_ids))
        
        if not event_types or CalendarEventType.WORKFLOW in event_types:
            events.extend(self._get_workflow_events(user, start_date, end_date))
        
        # Sort by date
        events.sort(key=lambda x: x['start'])
        
        return events
    
    def _get_milestone_events(
        self, 
        start_date, 
        end_date, 
        project_ids: List = None
    ) -> List[Dict]:
        """Get milestone and schedule task events."""
        events = []
        
        try:
            from scheduling.models import ScheduleTask
            
            queryset = ScheduleTask.objects.filter(
                Q(start_date__range=[start_date, end_date]) |
                Q(end_date__range=[start_date, end_date])
            )
            
            if project_ids:
                queryset = queryset.filter(project_id__in=project_ids)
            
            for task in queryset.select_related('project')[:50]:
                is_overdue = task.end_date and task.end_date < timezone.now().date() and task.status != 'COMPLETED'
                
                events.append({
                    'id': f'milestone-{task.id}',
                    'title': task.name,
                    'start': task.start_date.isoformat() if task.start_date else None,
                    'end': task.end_date.isoformat() if task.end_date else None,
                    'type': CalendarEventType.MILESTONE,
                    'color': '#ef4444' if is_overdue else CalendarEventType.COLORS[CalendarEventType.MILESTONE],
                    'priority': 'high' if getattr(task, 'is_critical', False) else 'medium',
                    'entity_type': 'ScheduleTask',
                    'entity_id': str(task.id),
                    'project_name': task.project.name if task.project else None,
                    'status': task.status,
                    'is_overdue': is_overdue,
                    'link_url': f'/scheduling?task={task.id}',
                    'metadata': {
                        'is_critical': getattr(task, 'is_critical', False)
                    }
                })
        except Exception as e:
            logger.error(f"Error fetching milestone events: {e}")
        
        return events
    
    def _get_billing_events(
        self, 
        start_date, 
        end_date, 
        project_ids: List = None
    ) -> List[Dict]:
        """Get RA Bill and payment events."""
        events = []
        
        try:
            from finance.models import RABill
            
            # Use bill_date field which exists in the model
            queryset = RABill.objects.filter(
                bill_date__range=[start_date, end_date]
            )
            
            if project_ids:
                queryset = queryset.filter(project_id__in=project_ids)
            
            for bill in queryset.select_related('project')[:50]:
                event_date = bill.bill_date
                if not event_date:
                    continue
                    
                events.append({
                    'id': f'billing-{bill.id}',
                    'title': f'RA Bill #{bill.bill_no or bill.id}',
                    'start': event_date.isoformat(),
                    'end': event_date.isoformat(),
                    'type': CalendarEventType.BILLING,
                    'color': CalendarEventType.COLORS[CalendarEventType.BILLING],
                    'priority': 'medium',
                    'entity_type': 'RABill',
                    'entity_id': str(bill.id),
                    'project_name': bill.project.name if bill.project else None,
                    'status': bill.status,
                    'is_overdue': False,
                    'link_url': f'/cost/ra-billing?bill={bill.id}',
                    'metadata': {
                        'amount': float(bill.net_payable or 0)
                    }
                })
        except Exception as e:
            logger.error(f"Error fetching billing events: {e}")
        
        return events
    
    def _get_risk_events(
        self, 
        start_date, 
        end_date, 
        project_ids: List = None
    ) -> List[Dict]:
        """Get risk-related events (high risks, mitigation deadlines)."""
        events = []
        
        try:
            from projects.models import Risk
            
            # High-priority risks with target dates
            queryset = Risk.objects.filter(
                probability__gte=4,  # High probability
                status__in=['IDENTIFIED', 'MITIGATING']
            )
            
            if project_ids:
                queryset = queryset.filter(project_id__in=project_ids)
            
            for risk in queryset.select_related('project')[:30]:
                # Use created_at as event date if no specific deadline
                event_date = getattr(risk, 'target_date', None) or risk.created_at.date()
                
                if not (start_date <= event_date <= end_date):
                    continue
                    
                events.append({
                    'id': f'risk-{risk.id}',
                    'title': f'Risk: {risk.title[:50]}',
                    'start': event_date.isoformat(),
                    'end': event_date.isoformat(),
                    'type': CalendarEventType.RISK,
                    'color': CalendarEventType.COLORS[CalendarEventType.RISK],
                    'priority': 'high',
                    'entity_type': 'Risk',
                    'entity_id': str(risk.id),
                    'project_name': risk.project.name if risk.project else None,
                    'status': risk.status,
                    'is_overdue': False,
                    'link_url': f'/risk-management?risk={risk.id}',
                    'metadata': {
                        'severity': risk.impact * risk.probability if hasattr(risk, 'impact') else None,
                        'category': risk.category if hasattr(risk, 'category') else None
                    }
                })
        except Exception as e:
            logger.error(f"Error fetching risk events: {e}")
        
        return events
    
    def _get_compliance_events(
        self, 
        start_date, 
        end_date, 
        project_ids: List = None
    ) -> List[Dict]:
        """Get compliance events (contract end dates, etc.)."""
        events = []
        
        try:
            from procurement.models import Contract
            
            # Use end_date field which exists in Contract model
            queryset = Contract.objects.filter(
                end_date__range=[start_date, end_date]
            )
            
            if project_ids:
                queryset = queryset.filter(project_id__in=project_ids)
            
            for contract in queryset.select_related('project')[:30]:
                if not contract.end_date:
                    continue
                    
                days_until = (contract.end_date - timezone.now().date()).days
                is_urgent = days_until <= 30
                
                events.append({
                    'id': f'compliance-{contract.id}',
                    'title': f'Contract End: {contract.contract_no or str(contract.id)[:8]}',
                    'start': contract.end_date.isoformat(),
                    'end': contract.end_date.isoformat(),
                    'type': CalendarEventType.COMPLIANCE,
                    'color': '#ef4444' if is_urgent else CalendarEventType.COLORS[CalendarEventType.COMPLIANCE],
                    'priority': 'high' if is_urgent else 'medium',
                    'entity_type': 'Contract',
                    'entity_id': str(contract.id),
                    'project_name': contract.project.name if contract.project else None,
                    'status': 'URGENT' if is_urgent else 'UPCOMING',
                    'is_overdue': days_until < 0,
                    'link_url': f'/e-procurement?contract={contract.id}',
                    'metadata': {
                        'days_until': days_until,
                        'contract_value': float(contract.contract_value or 0)
                    }
                })
        except Exception as e:
            logger.error(f"Error fetching compliance events: {e}")
        
        return events
    
    def _get_workflow_events(
        self, 
        user,
        start_date, 
        end_date
    ) -> List[Dict]:
        """Get workflow deadline events (SLA breaches, pending approvals)."""
        events = []
        
        try:
            from workflow.models import WorkflowInstance, WorkflowStatus
            
            # Pending workflows with approaching SLA
            queryset = WorkflowInstance.objects.filter(
                status__in=[WorkflowStatus.IN_PROGRESS, WorkflowStatus.REVERTED]
            ).select_related('template', 'current_step')[:30]
            
            for instance in queryset:
                sla_deadline = instance.get_sla_deadline()
                if not sla_deadline:
                    continue
                    
                deadline_date = sla_deadline.date()
                if not (start_date <= deadline_date <= end_date):
                    continue
                
                is_overdue = instance.is_overdue()
                
                events.append({
                    'id': f'workflow-{instance.id}',
                    'title': f'Approval: {instance.entity_type}',
                    'start': deadline_date.isoformat(),
                    'end': deadline_date.isoformat(),
                    'type': CalendarEventType.WORKFLOW,
                    'color': '#ef4444' if is_overdue else CalendarEventType.COLORS[CalendarEventType.WORKFLOW],
                    'priority': 'high' if is_overdue else 'medium',
                    'entity_type': instance.entity_type,
                    'entity_id': str(instance.entity_id),
                    'project_name': None,
                    'status': 'OVERDUE' if is_overdue else instance.status,
                    'is_overdue': is_overdue,
                    'link_url': '/approvals',
                    'metadata': {
                        'template': instance.template.name,
                        'current_step': str(instance.current_step) if instance.current_step else None,
                        'progress': instance.progress_percent
                    }
                })
        except Exception as e:
            logger.error(f"Error fetching workflow events: {e}")
        
        return events
    
    def get_event_summary(self, user, date) -> Dict[str, int]:
        """Get count of events by type for a specific date."""
        end_date = date
        events = self.get_events(user, date, end_date)
        
        summary = {}
        for event in events:
            event_type = event['type']
            summary[event_type] = summary.get(event_type, 0) + 1
        
        return summary
    
    def get_upcoming_events(self, user, days: int = 7) -> List[Dict]:
        """Get events for the next N days."""
        today = timezone.now().date()
        end_date = today + timedelta(days=days)
        return self.get_events(user, today, end_date)


# Singleton instance
calendar_aggregator = CalendarEventAggregator()



================================================
FILE: backend/projects/funding_model.py
================================================
from django.db import models
import uuid


class FundingSource(models.Model):
    """
    Tracks funding sources/patterns for projects.
    Previously this data was sent from frontend but discarded by backend.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    project = models.ForeignKey(
        'Project',
        on_delete=models.CASCADE,
        related_name='fundings'
    )
    source = models.CharField(max_length=255, help_text="Funding source name/type")
    amount = models.DecimalField(max_digits=15, decimal_places=2)
    document = models.FileField(
        upload_to='projects/funding_docs/%Y/%m/',
        null=True,
        blank=True,
        help_text="Supporting document for this funding source"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.source}: â‚¹{self.amount} ({self.project.name})"



================================================
FILE: backend/projects/models.py
================================================
from django.db import models
from django.core.validators import MinValueValidator
from decimal import Decimal
import uuid


class Project(models.Model):
    """
    Core Project model with references to Master Data tables.
    
    Uses ForeignKey with SET_NULL to maintain data integrity while allowing
    flexibility when master records are deleted or not yet assigned.
    
    Progress Tracking:
    - physical_progress: Computed from task-level execution data.
    - financial_progress: Computed from earned value vs budget.
    - These fields are READ-ONLY and cannot be set via API or Admin.
    """
    
    # ========== STATUS CHOICES ==========
    STATUS_CHOICES = [
        ('Planning', 'Planning'),
        ('In Progress', 'In Progress'),
        ('Completed', 'Completed'),
        ('On Hold', 'On Hold'),
        ('Under Review', 'Under Review'),
    ]
    
    class ProgressState(models.TextChoices):
        """
        Indicates the verification state of progress values.
        - CLAIMED: Computed but not externally verified (default)
        - VERIFIED: Approved by Authority/PMC
        - FLAGGED: Rule violation or anomaly detected
        """
        CLAIMED = 'CLAIMED', 'Claimed'
        VERIFIED = 'VERIFIED', 'Verified'
        FLAGGED = 'FLAGGED', 'Flagged'

    # ========== BASIC INFORMATION ==========
    name = models.CharField(max_length=255)
    description = models.TextField(blank=True)
    status = models.CharField(
        max_length=50, 
        choices=STATUS_CHOICES, 
        default='Planning',
        db_index=True  # Index for filtering
    )
    
    start_date = models.DateField(null=True, blank=True)
    end_date = models.DateField(null=True, blank=True)
    
    # ========== LEGACY PROGRESS (TO BE DEPRECATED) ==========
    progress = models.FloatField(
        default=0.0,
        help_text='DEPRECATED: Use physical_progress instead. Kept for backward compatibility.'
    )
    
    # ========== COMPUTED PROGRESS FIELDS (READ-ONLY) ==========
    physical_progress = models.FloatField(
        default=0.0,
        validators=[MinValueValidator(0.0)],
        help_text='Computed physical progress (0-100%). DO NOT EDIT DIRECTLY.'
    )
    
    financial_progress = models.FloatField(
        default=0.0,
        validators=[MinValueValidator(0.0)],
        help_text='Computed financial progress (EV/Budget %). DO NOT EDIT DIRECTLY.'
    )
    
    earned_value = models.DecimalField(
        max_digits=15,
        decimal_places=2,
        default=Decimal('0.00'),
        help_text='Computed Earned Value (EV). DO NOT EDIT DIRECTLY.'
    )
    
    progress_state = models.CharField(
        max_length=20,
        choices=ProgressState.choices,
        default=ProgressState.CLAIMED,
        help_text='Verification state of progress values'
    )
    
    schedule_variance = models.FloatField(
        default=0.0,
        help_text='Schedule variance percentage. Negative = behind schedule.'
    )
    
    # ========== FINANCIAL ==========
    budget = models.DecimalField(max_digits=15, decimal_places=2, default=Decimal('0.00'))
    spent = models.DecimalField(max_digits=15, decimal_places=2, default=Decimal('0.00'))
    
    # ========== HIERARCHY (Master References) ==========
    zone = models.ForeignKey(
        'masters.Zone', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Administrative zone'
    )
    circle = models.ForeignKey(
        'masters.Circle', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Administrative circle'
    )
    division = models.ForeignKey(
        'masters.Division', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Administrative division'
    )
    sub_division = models.ForeignKey(
        'masters.SubDivision', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Administrative sub-division'
    )
    
    # ========== GEOGRAPHY (Master References) ==========
    district = models.ForeignKey(
        'masters.District', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Project district'
    )
    town = models.ForeignKey(
        'masters.Town', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Project town/city'
    )
    
    # ========== CLASSIFICATION (Master References) ==========
    scheme_type = models.ForeignKey(
        'masters.SchemeType', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Type of scheme'
    )
    scheme = models.ForeignKey(
        'masters.Scheme', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Specific scheme'
    )
    work_type = models.ForeignKey(
        'masters.WorkType', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Type of work'
    )
    project_category = models.ForeignKey(
        'masters.ProjectCategory', 
        on_delete=models.SET_NULL, 
        null=True, blank=True,
        related_name='projects',
        help_text='Project category classification'
    )
    
    # ========== LOCATION (Legacy + Map) ==========
    lat = models.FloatField(null=True, blank=True, help_text='Latitude for map display')
    lng = models.FloatField(null=True, blank=True, help_text='Longitude for map display')
    address = models.CharField(max_length=500, blank=True, help_text='Physical address or landmark')
    
    # ========== METADATA ==========
    manager_legacy = models.CharField(max_length=255, blank=True, null=True, help_text="Old manager field - will be migrated")
    manager = models.ForeignKey(
        'users.User',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='managed_projects',
        help_text='Project Manager assigned to this project'
    )
    admin_approval_reference_no = models.CharField(
        max_length=100,
        blank=True,
        help_text='Administrative approval reference number'
    )
    admin_approval_date = models.DateField(
        null=True,
        blank=True,
        help_text='Date of administrative approval'
    )
    admin_approval_document = models.FileField(
        upload_to='projects/approvals/%Y/%m/',
        null=True,
        blank=True,
        help_text='Uploaded approval document (PDF/Image)'
    )
    stakeholders = models.JSONField(default=list, blank=True)
    category = models.CharField(max_length=100, blank=True, help_text='Legacy category field')
    land_acquisition_status = models.FloatField(default=0.0)

    created_at = models.DateTimeField(auto_now_add=True, db_index=True)  # Index for ordering
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['status', 'physical_progress'], name='proj_status_progress_idx'),
            models.Index(fields=['start_date', 'end_date'], name='proj_date_range_idx'),
            models.Index(fields=['-created_at', 'status'], name='proj_created_status_idx'),
        ]
        
    def __str__(self):
        return self.name
    
    @property
    def hierarchy_display(self):
        """Returns a formatted string of the administrative hierarchy."""
        parts = []
        if self.zone:
            parts.append(self.zone.name)
        if self.circle:
            parts.append(self.circle.name)
        if self.division:
            parts.append(self.division.name)
        return ' â†’ '.join(parts) if parts else 'Not assigned'
    
    @property
    def location_display(self):
        """Returns a formatted location string."""
        parts = []
        if self.town:
            parts.append(self.town.name)
        if self.district:
            parts.append(self.district.name)
        return ', '.join(parts) if parts else self.address or 'Not specified'


class WorkPackage(models.Model):
    STATUS_CHOICES = [
        ('Pending', 'Pending'),
        ('In Progress', 'In Progress'),
        ('Completed', 'Completed'),
        ('On Hold', 'On Hold'),
    ]

    project = models.ForeignKey(Project, on_delete=models.CASCADE, related_name='work_packages')
    
    # Legacy contractor field (FK to User) - kept for backward compatibility
    contractor = models.ForeignKey('users.User', on_delete=models.SET_NULL, null=True, blank=True, related_name='assigned_packages')
    
    # New contractor field (FK to Contractor model) - preferred for new packages
    contractor_master = models.ForeignKey(
        'masters.Contractor',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='work_packages',
        help_text="Contractor assigned to this package (new field)"
    )
    
    name = models.CharField(max_length=255)
    description = models.TextField(blank=True)
    status = models.CharField(max_length=50, choices=STATUS_CHOICES, default='Pending')
    
    budget = models.DecimalField(max_digits=12, decimal_places=2, default=0.00)
    start_date = models.DateField(null=True, blank=True)
    end_date = models.DateField(null=True, blank=True)
    
    # Agreement Details
    agreement_no = models.CharField(max_length=100, blank=True, null=True, help_text="Agreement/Contract number")
    agreement_date = models.DateField(null=True, blank=True)
    responsible_staff = models.CharField(max_length=255, blank=True, null=True)
    
    # Agreement Document (simple file upload)
    agreement_document = models.FileField(
        upload_to='temp/package_agreements/',
        null=True,
        blank=True,
        help_text="Agreement document upload"
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.name} ({self.project.name})"
    

    
    def clean(self):
        """
        Validate package data before saving.
        
        Raises:
            ValidationError: If validation fails
        """
        from django.core.exceptions import ValidationError as DjangoValidationError
        
        errors = {}
        
        # Ensure contractor has linked user account for notifications
        if self.contractor and not self.contractor.linked_user:
            errors['contractor'] = "Selected contractor must have a linked user account"
        
        # Ensure agreement number is provided
        if not self.agreement_no or not self.agreement_no.strip():
            errors['agreement_no'] = "Agreement number is required"
        
        # Validate responsible staff is from same project hierarchy if possible
        if self.responsible_staff and self.project:
            # This is a soft validation - log warning but don't block
            # Could be enhanced to check division/zone match
            pass
        
        if errors:
            raise DjangoValidationError(errors)


class FundingSource(models.Model):
    """
    Tracks funding sources/patterns for projects.
    Previously this data was sent from frontend but discarded by backend.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    project = models.ForeignKey(
        Project,
        on_delete=models.CASCADE,
        related_name='fundings'
    )
    source = models.CharField(max_length=255, help_text="Funding source name/type")
    amount = models.DecimalField(max_digits=15, decimal_places=2)
    document = models.FileField(
        upload_to='projects/funding_docs/%Y/%m/',
        null=True,
        blank=True,
        help_text="Supporting document for this funding source"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.source}: â‚¹{self.amount} ({self.project.name})"


# Import Risk models to make them accessible via projects.models
from .risk_models import Risk, RiskDocument, RiskMitigationAction, MitigationProofDocument, RiskAuditLog





================================================
FILE: backend/projects/notification_service.py
================================================
"""
Package Assignment Notification Service

Handles email and in-app notifications when a contractor is assigned to a work package.
Government-grade implementation with comprehensive error handling and logging.
"""

import logging
from typing import Optional
from django.core.mail import send_mail
from django.conf import settings
from django.template.loader import render_to_string
from django.utils.html import strip_tags

logger = logging.getLogger(__name__)


class PackageNotificationService:
    """
    Service for sending package assignment notifications.
    
    Features:
    - Email notifications to contractor's linked user
    - In-app notifications via notifications app
    - Comprehensive error handling
    - Audit logging
    """
    
    @staticmethod
    def send_package_assignment_notification(package, assigned_by=None):
        """
        Send notification when contractor is assigned to package.
        
        Args:
            package: WorkPackage instance
            assigned_by: User who assigned the package (optional)
            
        Returns:
            dict: Status of email and in-app notification attempts
        """
        try:
            # Validate package has contractor with linked user
            if not package.contractor_master:
                logger.warning(f"Package {package.id} has no contractor assigned")
                return {'success': False, 'error': 'No contractor assigned'}
            
            contractor = package.contractor_master
            
            if not contractor.linked_user:
                logger.warning(f"Contractor {contractor.id} ({contractor.name}) has no linked user account")
                return {'success': False, 'error': 'Contractor has no linked user account'}
            
            recipient_user = contractor.linked_user
            
            # Send email notification
            email_sent = PackageNotificationService._send_email_notification(
                package, contractor, recipient_user, assigned_by
            )
            
            # Create in-app notification
            notification_created = PackageNotificationService._create_in_app_notification(
                package, contractor, recipient_user, assigned_by
            )
            
            logger.info(f"Package assignment notification sent for package {package.id} to contractor {contractor.id}")
            
            return {
                'success': True,
                'email_sent': email_sent,
                'notification_created': notification_created,
                'recipient': recipient_user.email
            }
            
        except Exception as e:
            logger.error(f"Failed to send package assignment notification: {str(e)}", exc_info=True)
            return {'success': False, 'error': str(e)}
    
    @staticmethod
    def _send_email_notification(package, contractor, recipient_user, assigned_by=None):
        """Send email notification about package assignment."""
        try:
            # Prepare email context
            context = {
                'contractor_name': contractor.name,
                'recipient_name': recipient_user.get_full_name() or recipient_user.username,
                'package_name': package.name,
                'project_name': package.project.name,
                'agreement_no': package.agreement_no,
                'agreement_date': package.agreement_date,
                'budget': package.budget,
                'start_date': package.start_date,
                'end_date': package.end_date,
                'responsible_staff': package.responsible_staff,
                'assigned_by': assigned_by.get_full_name() if assigned_by else 'System',
                'login_url': f"{settings.FRONTEND_URL}/login" if hasattr(settings, 'FRONTEND_URL') else 'https://pmis.example.com/login',
            }
            
            # Render HTML email
            html_message = render_to_string('emails/package_assignment.html', context) if hasattr(settings, 'TEMPLATES') else None
            plain_message = strip_tags(html_message) if html_message else PackageNotificationService._get_plain_email_text(context)
            
            # Send email
            send_mail(
                subject=f'Package Assignment: {package.name}',
                message=plain_message,
                from_email=settings.DEFAULT_FROM_EMAIL if hasattr(settings, 'DEFAULT_FROM_EMAIL') else 'noreply@pmis.gov.in',
                recipient_list=[recipient_user.email],
                html_message=html_message,
                fail_silently=False,
            )
            
            logger.info(f"Email sent to {recipient_user.email} for package {package.id}")
            return True
            
        except Exception as e:
            logger.error(f"Failed to send email notification: {str(e)}", exc_info=True)
            return False
    
    @staticmethod
    def _get_plain_email_text(context):
        """Generate plain text email body."""
        return f"""
Dear {context['contractor_name']},

You have been assigned to a new work package in the Project Management Information System (PMIS).

Package Details:
- Package Name: {context['package_name']}
- Project: {context['project_name']}
- Agreement Number: {context['agreement_no']}
- Agreement Date: {context['agreement_date']}
- Budget: â‚¹{context['budget']:,.2f}
- Start Date: {context['start_date']}
- End Date: {context['end_date']}
- Responsible Staff: {context['responsible_staff']}

Assigned by: {context['assigned_by']}

Please log in to the PMIS portal to view full details and upload required documents:
{context['login_url']}

If you have any questions, please contact the responsible staff member.

Best regards,
PMIS Team
Government of India
"""
    
    @staticmethod
    def _create_in_app_notification(package, contractor, recipient_user, assigned_by=None):
        """Create in-app notification for package assignment."""
        try:
            # Check if notifications app exists
            from django.apps import apps
            if not apps.is_installed('notifications'):
                logger.warning("Notifications app not installed, skipping in-app notification")
                return False
            
            from notifications.models import Notification
            
            # Create notification
            notification = Notification.objects.create(
                user=recipient_user,
                notification_type='PACKAGE_ASSIGNMENT',
                title=f'New Package Assignment: {package.name}',
                message=f'You have been assigned to work package "{package.name}" for project "{package.project.name}". Agreement: {package.agreement_no}',
                priority='HIGH',
                metadata={
                    'package_id': str(package.id),
                    'project_id': str(package.project.id),
                    'contractor_id': str(contractor.id),
                    'agreement_no': package.agreement_no,
                    'assigned_by': assigned_by.id if assigned_by else None,
                },
                action_url=f'/projects/{package.project.id}/packages/{package.id}',
            )
            
            logger.info(f"In-app notification created for user {recipient_user.id} regarding package {package.id}")
            return True
            
        except ImportError:
            logger.warning("Notifications app not available, skipping in-app notification")
            return False
        except Exception as e:
            logger.error(f"Failed to create in-app notification: {str(e)}", exc_info=True)
            return False



================================================
FILE: backend/projects/risk_models.py
================================================
"""
Risk Management Models

Implements a comprehensive risk register with:
- Full lifecycle tracking (Identified â†’ Assessed â†’ Mitigating â†’ Mitigated â†’ Closed)
- Risk scoring matrix (probability Ã— impact = 1-25 score)
- Severity auto-calculation (LOW/MEDIUM/HIGH/CRITICAL)
- EDMS integration for document storage
- Mitigation action tracking with mandatory proof documents
- Notification triggers for high-severity risks

Complies with government project management standards.
"""
import uuid
from decimal import Decimal
from django.db import models
from django.conf import settings
from django.core.validators import MinValueValidator, MaxValueValidator
from django.core.exceptions import ValidationError
from django.utils import timezone


class Risk(models.Model):
    """
    Core Risk Register entry with full lifecycle tracking,
    EDMS document integration, and notification triggers.
    
    Risk Score Calculation:
    - Score = Probability (1-5) Ã— Impact (1-5) = 1-25
    - Severity thresholds: LOW(1-4), MEDIUM(5-9), HIGH(10-15), CRITICAL(16-25)
    """
    
    # ========== ENUMS ==========
    
    class Category(models.TextChoices):
        TECHNICAL = 'TECHNICAL', 'Technical'
        FINANCIAL = 'FINANCIAL', 'Financial'
        CONTRACTUAL = 'CONTRACTUAL', 'Contractual'
        ENVIRONMENTAL = 'ENVIRONMENTAL', 'Environmental'
        SAFETY = 'SAFETY', 'Safety'
        POLITICAL = 'POLITICAL', 'Political'
        LEGAL = 'LEGAL', 'Legal'
        OPERATIONAL = 'OPERATIONAL', 'Operational'
        SCHEDULE = 'SCHEDULE', 'Schedule/Timeline'
        RESOURCE = 'RESOURCE', 'Resource/Manpower'
        OTHER = 'OTHER', 'Other'
    
    class RiskSource(models.TextChoices):
        INTERNAL = 'INTERNAL', 'Internal'
        EXTERNAL = 'EXTERNAL', 'External'
    
    class Probability(models.IntegerChoices):
        VERY_LOW = 1, 'Very Low (Rare)'
        LOW = 2, 'Low (Unlikely)'
        MEDIUM = 3, 'Medium (Possible)'
        HIGH = 4, 'High (Likely)'
        VERY_HIGH = 5, 'Very High (Almost Certain)'
    
    class Impact(models.IntegerChoices):
        NEGLIGIBLE = 1, 'Negligible'
        MINOR = 2, 'Minor'
        MODERATE = 3, 'Moderate'
        MAJOR = 4, 'Major'
        CRITICAL = 5, 'Critical'
    
    class Severity(models.TextChoices):
        LOW = 'LOW', 'Low'
        MEDIUM = 'MEDIUM', 'Medium'
        HIGH = 'HIGH', 'High'
        CRITICAL = 'CRITICAL', 'Critical'
    
    class Status(models.TextChoices):
        IDENTIFIED = 'IDENTIFIED', 'Identified'
        ASSESSED = 'ASSESSED', 'Assessed'
        MITIGATING = 'MITIGATING', 'Mitigating'
        MITIGATED = 'MITIGATED', 'Mitigated'
        CLOSED = 'CLOSED', 'Closed'
        OCCURRED = 'OCCURRED', 'Occurred'
        ACCEPTED = 'ACCEPTED', 'Accepted'
    
    class ResponseStrategy(models.TextChoices):
        AVOID = 'AVOID', 'Avoid'
        MITIGATE = 'MITIGATE', 'Mitigate'
        TRANSFER = 'TRANSFER', 'Transfer'
        ACCEPT = 'ACCEPT', 'Accept'
        ESCALATE = 'ESCALATE', 'Escalate'
    
    # ========== IDENTIFICATION ==========
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    risk_code = models.CharField(
        max_length=30, 
        unique=True, 
        blank=True,
        help_text="Auto-generated: RSK-{PROJECT_CODE}-{SEQ}"
    )
    title = models.CharField(max_length=255)
    description = models.TextField()
    
    # ========== CATEGORIZATION ==========
    
    category = models.CharField(
        max_length=20,
        choices=Category.choices,
        default=Category.OTHER
    )
    risk_source = models.CharField(
        max_length=10,
        choices=RiskSource.choices,
        default=RiskSource.INTERNAL
    )
    
    # ========== ASSESSMENT ==========
    
    probability = models.IntegerField(
        choices=Probability.choices,
        default=Probability.MEDIUM,
        help_text="Likelihood of risk occurring (1-5)"
    )
    impact = models.IntegerField(
        choices=Impact.choices,
        default=Impact.MODERATE,
        help_text="Severity if risk occurs (1-5)"
    )
    risk_score = models.IntegerField(
        editable=False,
        default=9,
        help_text="Auto-calculated: probability Ã— impact (1-25)"
    )
    severity = models.CharField(
        max_length=10,
        choices=Severity.choices,
        editable=False,
        default=Severity.MEDIUM,
        help_text="Auto-calculated from risk score"
    )
    
    # ========== STATUS & LIFECYCLE ==========
    
    status = models.CharField(
        max_length=15,
        choices=Status.choices,
        default=Status.IDENTIFIED
    )
    identified_date = models.DateField(auto_now_add=True)
    target_resolution = models.DateField(
        null=True, 
        blank=True,
        help_text="Expected date to resolve/mitigate risk"
    )
    actual_closure = models.DateField(
        null=True, 
        blank=True,
        help_text="Date when risk was closed"
    )
    review_date = models.DateField(
        null=True, 
        blank=True,
        help_text="Next scheduled review date"
    )
    
    # ========== RESPONSE PLAN ==========
    
    response_strategy = models.CharField(
        max_length=10,
        choices=ResponseStrategy.choices,
        null=True,
        blank=True
    )
    mitigation_plan = models.TextField(
        blank=True,
        help_text="Detailed plan to reduce probability/impact"
    )
    contingency_plan = models.TextField(
        blank=True,
        help_text="Actions if risk materializes"
    )
    cost_impact = models.DecimalField(
        max_digits=15, 
        decimal_places=2, 
        default=Decimal('0.00'),
        help_text="Estimated financial impact in INR"
    )
    schedule_impact_days = models.IntegerField(
        default=0,
        help_text="Estimated schedule delay in days"
    )
    residual_risk_score = models.IntegerField(
        null=True,
        blank=True,
        help_text="Risk score after mitigation applied"
    )
    
    # ========== LINKAGES ==========
    
    project = models.ForeignKey(
        'projects.Project',
        on_delete=models.CASCADE,
        related_name='risks'
    )
    work_package = models.ForeignKey(
        'projects.WorkPackage',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='risks'
    )
    schedule_task = models.ForeignKey(
        'scheduling.ScheduleTask',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='risks',
        help_text="Linked schedule task affected by this risk"
    )
    owner = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='owned_risks',
        help_text="Person responsible for managing this risk"
    )
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='created_risks'
    )
    
    # ========== EDMS INTEGRATION ==========
    
    edms_folder = models.ForeignKey(
        'edms.Folder',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        help_text="Auto-created folder: {Project}/Risk Management/{risk_code}"
    )
    
    # ========== AUDIT TRAIL ==========
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['project', 'status']),
            models.Index(fields=['severity', 'status']),
            models.Index(fields=['owner', 'status']),
        ]
    
    def __str__(self):
        return f"{self.risk_code}: {self.title}"
    
    def save(self, *args, **kwargs):
        # Auto-generate risk code
        if not self.risk_code:
            self.risk_code = self._generate_risk_code()
        
        # Calculate risk score and severity
        self.risk_score = self.probability * self.impact
        self.severity = self._calculate_severity()
        
        # Set closure date when status changes to CLOSED
        if self.status == self.Status.CLOSED and not self.actual_closure:
            self.actual_closure = timezone.now().date()
        
        super().save(*args, **kwargs)
    
    def _generate_risk_code(self):
        """Generate unique risk code: RSK-{PROJECT_CODE}-{SEQ}"""
        project_code = self.project.code if hasattr(self.project, 'code') else str(self.project.id)[:6].upper()
        
        # Get next sequence number for this project
        last_risk = Risk.objects.filter(
            risk_code__startswith=f"RSK-{project_code}-"
        ).order_by('-created_at').first()
        
        if last_risk:
            try:
                last_seq = int(last_risk.risk_code.split('-')[-1])
                next_seq = last_seq + 1
            except (ValueError, IndexError):
                next_seq = 1
        else:
            next_seq = 1
        
        return f"RSK-{project_code}-{next_seq:04d}"
    
    def _calculate_severity(self):
        """Calculate severity based on risk score thresholds."""
        if self.risk_score >= 16:
            return self.Severity.CRITICAL
        elif self.risk_score >= 10:
            return self.Severity.HIGH
        elif self.risk_score >= 5:
            return self.Severity.MEDIUM
        else:
            return self.Severity.LOW
    
    @property
    def is_overdue(self):
        """Check if risk is overdue for resolution."""
        if self.target_resolution and self.status not in [self.Status.CLOSED, self.Status.MITIGATED]:
            return timezone.now().date() > self.target_resolution
        return False
    
    @property
    def days_open(self):
        """Number of days risk has been open."""
        if not self.identified_date:
            return 0
        end_date = self.actual_closure or timezone.now().date()
        return (end_date - self.identified_date).days
    
    @property
    def mitigation_count(self):
        """Number of mitigation actions taken."""
        return self.mitigation_actions.filter(status='APPROVED').count()


class RiskDocument(models.Model):
    """
    Links supporting documents to risks via EDMS.
    Documents are stored in: {Project}/Risk Management/{risk_code}/
    """
    
    class DocumentType(models.TextChoices):
        EVIDENCE = 'EVIDENCE', 'Evidence/Proof'
        ASSESSMENT = 'ASSESSMENT', 'Risk Assessment Report'
        MITIGATION_PLAN = 'MITIGATION_PLAN', 'Mitigation Plan'
        MITIGATION_PROOF = 'MITIGATION_PROOF', 'Mitigation Action Proof'
        CLOSURE_REPORT = 'CLOSURE_REPORT', 'Closure Report'
        INSURANCE = 'INSURANCE', 'Insurance Claim'
        MEETING_NOTES = 'MEETING_NOTES', 'Meeting Notes'
        CORRESPONDENCE = 'CORRESPONDENCE', 'Correspondence'
        INCIDENT_REPORT = 'INCIDENT_REPORT', 'Incident Report'
        OTHER = 'OTHER', 'Other'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    risk = models.ForeignKey(
        Risk, 
        on_delete=models.CASCADE, 
        related_name='risk_documents'
    )
    document = models.ForeignKey(
        'edms.Document', 
        on_delete=models.CASCADE,
        related_name='risk_attachments'
    )
    document_type = models.CharField(
        max_length=20,
        choices=DocumentType.choices,
        default=DocumentType.OTHER
    )
    notes = models.TextField(blank=True, help_text="Additional context for this document")
    uploaded_by = models.ForeignKey(
        settings.AUTH_USER_MODEL, 
        on_delete=models.SET_NULL, 
        null=True
    )
    uploaded_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['-uploaded_at']
    
    def __str__(self):
        return f"{self.risk.risk_code} - {self.document.title}"


class RiskMitigationAction(models.Model):
    """
    Tracks individual mitigation actions taken against a risk.
    Each action REQUIRES at least one supporting document as proof.
    
    Lifecycle:
    1. User creates action (DRAFT status)
    2. User uploads proof document(s) - MANDATORY
    3. User submits action (SUBMITTED status)
    4. Risk owner/manager reviews and approves (APPROVED/REJECTED)
    5. If approved, risk's residual score may be updated
    """
    
    class Status(models.TextChoices):
        DRAFT = 'DRAFT', 'Draft'
        SUBMITTED = 'SUBMITTED', 'Submitted for Review'
        APPROVED = 'APPROVED', 'Approved'
        REJECTED = 'REJECTED', 'Rejected'
    
    class ActionType(models.TextChoices):
        PREVENTIVE = 'PREVENTIVE', 'Preventive Action'
        CORRECTIVE = 'CORRECTIVE', 'Corrective Action'
        DETECTIVE = 'DETECTIVE', 'Detective Control'
        CONTINGENCY = 'CONTINGENCY', 'Contingency Measure'
        TRANSFER = 'TRANSFER', 'Risk Transfer (Insurance/Contract)'
        ACCEPTANCE = 'ACCEPTANCE', 'Risk Acceptance with Justification'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    risk = models.ForeignKey(
        Risk, 
        on_delete=models.CASCADE, 
        related_name='mitigation_actions'
    )
    
    # ========== ACTION DETAILS ==========
    
    action_number = models.PositiveIntegerField(
        help_text="Auto-incremented per risk"
    )
    action_type = models.CharField(
        max_length=15,
        choices=ActionType.choices,
        default=ActionType.CORRECTIVE
    )
    title = models.CharField(max_length=255)
    description = models.TextField()
    
    # ========== DATES ==========
    
    action_date = models.DateField(
        help_text="Date when action was taken"
    )
    target_completion = models.DateField(
        null=True, 
        blank=True,
        help_text="Target date for action completion"
    )
    actual_completion = models.DateField(
        null=True, 
        blank=True,
        help_text="Actual completion date"
    )
    
    # ========== EFFECTIVENESS ASSESSMENT ==========
    
    effectiveness_rating = models.IntegerField(
        null=True, 
        blank=True,
        validators=[MinValueValidator(1), MaxValueValidator(5)],
        help_text="1=Not Effective, 3=Moderate, 5=Highly Effective"
    )
    residual_probability = models.IntegerField(
        null=True, 
        blank=True,
        choices=Risk.Probability.choices,
        help_text="Probability after this action"
    )
    residual_impact = models.IntegerField(
        null=True, 
        blank=True,
        choices=Risk.Impact.choices,
        help_text="Impact after this action"
    )
    
    # ========== COST ==========
    
    cost_incurred = models.DecimalField(
        max_digits=15, 
        decimal_places=2, 
        default=Decimal('0.00'),
        help_text="Cost incurred for this mitigation action"
    )
    
    # ========== WORKFLOW STATUS ==========
    
    status = models.CharField(
        max_length=12,
        choices=Status.choices, 
        default=Status.DRAFT
    )
    submitted_at = models.DateTimeField(null=True, blank=True)
    reviewed_by = models.ForeignKey(
        settings.AUTH_USER_MODEL, 
        null=True, 
        blank=True,
        on_delete=models.SET_NULL, 
        related_name='reviewed_mitigations'
    )
    reviewed_at = models.DateTimeField(null=True, blank=True)
    review_comments = models.TextField(blank=True)
    
    # ========== TRACKING ==========
    
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL, 
        on_delete=models.SET_NULL, 
        null=True, 
        related_name='created_mitigations'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-action_number']
        unique_together = ['risk', 'action_number']
        indexes = [
            models.Index(fields=['risk', 'status']),
        ]
    
    def __str__(self):
        return f"{self.risk.risk_code} - Action #{self.action_number}: {self.title}"
    
    def save(self, *args, **kwargs):
        # Auto-increment action number within risk
        if not self.action_number:
            from django.db.models import Max
            max_num = RiskMitigationAction.objects.filter(
                risk=self.risk
            ).aggregate(Max('action_number'))['action_number__max'] or 0
            self.action_number = max_num + 1
        super().save(*args, **kwargs)
    
    def submit(self):
        """
        Submit action for review.
        REQUIRES at least one proof document - enforced at API level.
        """
        if not self.proof_documents.exists():
            raise ValidationError(
                "Cannot submit mitigation action without proof documentation. "
                "Please upload at least one supporting document."
            )
        
        if self.status != self.Status.DRAFT:
            raise ValidationError(
                f"Cannot submit action with status '{self.status}'. Only DRAFT actions can be submitted."
            )
        
        self.status = self.Status.SUBMITTED
        self.submitted_at = timezone.now()
        self.save(update_fields=['status', 'submitted_at', 'updated_at'])
    
    def approve(self, reviewer, comments=''):
        """
        Approve the mitigation action.
        Optionally updates the risk's residual score if assessment provided.
        """
        if self.status != self.Status.SUBMITTED:
            raise ValidationError(
                f"Cannot approve action with status '{self.status}'. Only SUBMITTED actions can be approved."
            )
        
        self.status = self.Status.APPROVED
        self.reviewed_by = reviewer
        self.reviewed_at = timezone.now()
        self.review_comments = comments
        self.actual_completion = self.actual_completion or timezone.now().date()
        self.save()
        
        # Update risk residual score if assessment provided
        if self.residual_probability and self.residual_impact:
            new_residual_score = self.residual_probability * self.residual_impact
            self.risk.residual_risk_score = new_residual_score
            self.risk.save(update_fields=['residual_risk_score', 'updated_at'])
    
    def reject(self, reviewer, comments):
        """Reject the mitigation action with reason."""
        if self.status != self.Status.SUBMITTED:
            raise ValidationError(
                f"Cannot reject action with status '{self.status}'. Only SUBMITTED actions can be rejected."
            )
        
        if not comments:
            raise ValidationError("Rejection reason is required.")
        
        self.status = self.Status.REJECTED
        self.reviewed_by = reviewer
        self.reviewed_at = timezone.now()
        self.review_comments = comments
        self.save()
    
    @property
    def can_submit(self):
        """Check if action can be submitted."""
        return self.status == self.Status.DRAFT and self.proof_documents.exists()
    
    @property
    def has_proof(self):
        """Check if action has proof documents."""
        return self.proof_documents.exists()


class MitigationProofDocument(models.Model):
    """
    Proof documents attached to a mitigation action.
    At least ONE document is REQUIRED before action can be submitted.
    
    Documents are stored in EDMS under:
    {Project}/Risk Management/{risk_code}/Mitigations/
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    mitigation_action = models.ForeignKey(
        RiskMitigationAction, 
        on_delete=models.CASCADE, 
        related_name='proof_documents'
    )
    document = models.ForeignKey(
        'edms.Document', 
        on_delete=models.CASCADE,
        related_name='mitigation_proofs'
    )
    description = models.TextField(
        blank=True, 
        help_text="Brief description of what this document proves"
    )
    uploaded_by = models.ForeignKey(
        settings.AUTH_USER_MODEL, 
        on_delete=models.SET_NULL, 
        null=True
    )
    uploaded_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['-uploaded_at']
    
    def __str__(self):
        return f"Proof for {self.mitigation_action.risk.risk_code} Action #{self.mitigation_action.action_number}"


class RiskAuditLog(models.Model):
    """
    Immutable audit trail for risk management actions.
    Tracks all changes for compliance and reporting.
    """
    
    class Action(models.TextChoices):
        CREATED = 'CREATED', 'Risk Created'
        UPDATED = 'UPDATED', 'Risk Updated'
        STATUS_CHANGED = 'STATUS_CHANGED', 'Status Changed'
        DOCUMENT_ADDED = 'DOCUMENT_ADDED', 'Document Added'
        MITIGATION_ADDED = 'MITIGATION_ADDED', 'Mitigation Action Added'
        MITIGATION_SUBMITTED = 'MITIGATION_SUBMITTED', 'Mitigation Submitted'
        MITIGATION_APPROVED = 'MITIGATION_APPROVED', 'Mitigation Approved'
        MITIGATION_REJECTED = 'MITIGATION_REJECTED', 'Mitigation Rejected'
        OWNER_CHANGED = 'OWNER_CHANGED', 'Owner Changed'
        ASSESSMENT_UPDATED = 'ASSESSMENT_UPDATED', 'Risk Assessment Updated'
        CLOSED = 'CLOSED', 'Risk Closed'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    risk = models.ForeignKey(
        Risk, 
        on_delete=models.CASCADE, 
        related_name='audit_logs'
    )
    
    action = models.CharField(max_length=25, choices=Action.choices)
    actor = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True
    )
    actor_name = models.CharField(max_length=200, blank=True)
    actor_role = models.CharField(max_length=50, blank=True)
    
    details = models.JSONField(
        default=dict,
        help_text="Additional action details"
    )
    previous_values = models.JSONField(
        default=dict,
        blank=True,
        help_text="Field values before change"
    )
    new_values = models.JSONField(
        default=dict,
        blank=True,
        help_text="Field values after change"
    )
    
    timestamp = models.DateTimeField(auto_now_add=True)
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    
    class Meta:
        ordering = ['-timestamp']
        indexes = [
            models.Index(fields=['risk', 'action']),
            models.Index(fields=['timestamp']),
        ]
    
    def __str__(self):
        return f"{self.risk.risk_code} - {self.action} by {self.actor_name}"
    
    def save(self, *args, **kwargs):
        # Freeze actor details
        if self.actor and not self.actor_name:
            self.actor_name = f"{self.actor.first_name} {self.actor.last_name}".strip() or self.actor.username
            self.actor_role = getattr(self.actor, 'role', '')
        
        # Enforce immutability
        if self.pk and RiskAuditLog.objects.filter(pk=self.pk).exists():
            raise Exception("Risk audit logs are immutable and cannot be modified.")
        
        super().save(*args, **kwargs)



================================================
FILE: backend/projects/risk_serializers.py
================================================
"""
Risk Management Serializers

Provides serializers for:
- Risk CRUD operations
- Risk document attachments
- Mitigation action workflow
- Proof document uploads
"""
from rest_framework import serializers
from django.utils import timezone
from .risk_models import (
    Risk, RiskDocument, RiskMitigationAction, 
    MitigationProofDocument, RiskAuditLog
)
from .models import Project, WorkPackage


class RiskListSerializer(serializers.ModelSerializer):
    """Serializer for risk list view with summary fields."""
    
    project_name = serializers.CharField(source='project.name', read_only=True)
    owner_name = serializers.SerializerMethodField()
    is_overdue = serializers.BooleanField(read_only=True)
    days_open = serializers.IntegerField(read_only=True)
    mitigation_count = serializers.IntegerField(read_only=True)
    document_count = serializers.SerializerMethodField()
    
    class Meta:
        model = Risk
        fields = [
            'id', 'risk_code', 'title', 'category', 'risk_source',
            'probability', 'impact', 'risk_score', 'severity',
            'status', 'response_strategy',
            'identified_date', 'target_resolution',
            'cost_impact', 'schedule_impact_days',
            'project', 'project_name', 'owner', 'owner_name',
            'is_overdue', 'days_open', 'mitigation_count', 'document_count',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'risk_code', 'risk_score', 'severity', 'created_at', 'updated_at']
    
    def get_owner_name(self, obj):
        if obj.owner:
            return f"{obj.owner.first_name} {obj.owner.last_name}".strip() or obj.owner.username
        return None
    
    def get_document_count(self, obj):
        return obj.risk_documents.count()


class RiskDocumentSerializer(serializers.ModelSerializer):
    """Serializer for risk documents."""
    
    document_title = serializers.CharField(source='document.title', read_only=True)
    document_url = serializers.SerializerMethodField()
    uploaded_by_name = serializers.SerializerMethodField()
    
    class Meta:
        model = RiskDocument
        fields = [
            'id', 'risk', 'document', 'document_type', 'notes',
            'document_title', 'document_url',
            'uploaded_by', 'uploaded_by_name', 'uploaded_at'
        ]
        read_only_fields = ['id', 'uploaded_by', 'uploaded_at']
    
    def get_document_url(self, obj):
        if obj.document and obj.document.current_version:
            return obj.document.current_version.file.url
        return None
    
    def get_uploaded_by_name(self, obj):
        if obj.uploaded_by:
            return f"{obj.uploaded_by.first_name} {obj.uploaded_by.last_name}".strip()
        return None


class MitigationProofDocumentSerializer(serializers.ModelSerializer):
    """Serializer for mitigation proof documents."""
    
    document_title = serializers.CharField(source='document.title', read_only=True)
    document_url = serializers.SerializerMethodField()
    
    class Meta:
        model = MitigationProofDocument
        fields = [
            'id', 'mitigation_action', 'document', 'description',
            'document_title', 'document_url',
            'uploaded_by', 'uploaded_at'
        ]
        read_only_fields = ['id', 'uploaded_by', 'uploaded_at']
    
    def get_document_url(self, obj):
        if obj.document and obj.document.current_version:
            return obj.document.current_version.file.url
        return None


class RiskMitigationActionListSerializer(serializers.ModelSerializer):
    """Serializer for mitigation action list."""
    
    created_by_name = serializers.SerializerMethodField()
    reviewed_by_name = serializers.SerializerMethodField()
    can_submit = serializers.BooleanField(read_only=True)
    has_proof = serializers.BooleanField(read_only=True)
    proof_count = serializers.SerializerMethodField()
    
    class Meta:
        model = RiskMitigationAction
        fields = [
            'id', 'action_number', 'action_type', 'title', 'description',
            'action_date', 'target_completion', 'actual_completion',
            'effectiveness_rating', 'residual_probability', 'residual_impact',
            'cost_incurred', 'status',
            'submitted_at', 'reviewed_at', 'review_comments',
            'created_by', 'created_by_name', 'reviewed_by', 'reviewed_by_name',
            'can_submit', 'has_proof', 'proof_count',
            'created_at', 'updated_at'
        ]
        read_only_fields = [
            'id', 'action_number', 'status', 'submitted_at', 
            'reviewed_at', 'reviewed_by', 'created_at', 'updated_at'
        ]
    
    def get_created_by_name(self, obj):
        if obj.created_by:
            return f"{obj.created_by.first_name} {obj.created_by.last_name}".strip()
        return None
    
    def get_reviewed_by_name(self, obj):
        if obj.reviewed_by:
            return f"{obj.reviewed_by.first_name} {obj.reviewed_by.last_name}".strip()
        return None
    
    def get_proof_count(self, obj):
        return obj.proof_documents.count()


class RiskMitigationActionDetailSerializer(RiskMitigationActionListSerializer):
    """Detailed serializer with nested proof documents."""
    
    proof_documents = MitigationProofDocumentSerializer(many=True, read_only=True)
    risk_code = serializers.CharField(source='risk.risk_code', read_only=True)
    
    class Meta(RiskMitigationActionListSerializer.Meta):
        fields = RiskMitigationActionListSerializer.Meta.fields + [
            'proof_documents', 'risk_code'
        ]


class RiskMitigationActionCreateSerializer(serializers.ModelSerializer):
    """Serializer for creating mitigation actions."""
    
    class Meta:
        model = RiskMitigationAction
        fields = [
            'risk', 'action_type', 'title', 'description',
            'action_date', 'target_completion',
            'effectiveness_rating', 'residual_probability', 'residual_impact',
            'cost_incurred'
        ]
    
    def create(self, validated_data):
        validated_data['created_by'] = self.context['request'].user
        return super().create(validated_data)


class RiskDetailSerializer(serializers.ModelSerializer):
    """Detailed serializer for single risk view."""
    
    project_name = serializers.CharField(source='project.name', read_only=True)
    work_package_name = serializers.CharField(source='work_package.name', read_only=True)
    schedule_task_name = serializers.CharField(source='schedule_task.name', read_only=True)
    owner_name = serializers.SerializerMethodField()
    created_by_name = serializers.SerializerMethodField()
    
    is_overdue = serializers.BooleanField(read_only=True)
    days_open = serializers.IntegerField(read_only=True)
    mitigation_count = serializers.IntegerField(read_only=True)
    
    risk_documents = RiskDocumentSerializer(many=True, read_only=True)
    mitigation_actions = RiskMitigationActionListSerializer(many=True, read_only=True)
    
    # Display values for enums
    category_display = serializers.CharField(source='get_category_display', read_only=True)
    probability_display = serializers.CharField(source='get_probability_display', read_only=True)
    impact_display = serializers.CharField(source='get_impact_display', read_only=True)
    severity_display = serializers.CharField(source='get_severity_display', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    response_strategy_display = serializers.CharField(source='get_response_strategy_display', read_only=True)
    
    class Meta:
        model = Risk
        fields = [
            'id', 'risk_code', 'title', 'description',
            # Categorization
            'category', 'category_display', 'risk_source',
            # Assessment
            'probability', 'probability_display',
            'impact', 'impact_display',
            'risk_score', 'severity', 'severity_display',
            # Status
            'status', 'status_display',
            'identified_date', 'target_resolution', 'actual_closure', 'review_date',
            # Response
            'response_strategy', 'response_strategy_display',
            'mitigation_plan', 'contingency_plan',
            'cost_impact', 'schedule_impact_days', 'residual_risk_score',
            # Linkages
            'project', 'project_name',
            'work_package', 'work_package_name',
            'schedule_task', 'schedule_task_name',
            'owner', 'owner_name',
            'created_by', 'created_by_name',
            'edms_folder',
            # Computed
            'is_overdue', 'days_open', 'mitigation_count',
            # Related
            'risk_documents', 'mitigation_actions',
            # Audit
            'created_at', 'updated_at', 'is_active'
        ]
        read_only_fields = [
            'id', 'risk_code', 'risk_score', 'severity', 'edms_folder',
            'created_at', 'updated_at'
        ]
    
    def get_owner_name(self, obj):
        if obj.owner:
            return f"{obj.owner.first_name} {obj.owner.last_name}".strip() or obj.owner.username
        return None
    
    def get_created_by_name(self, obj):
        if obj.created_by:
            return f"{obj.created_by.first_name} {obj.created_by.last_name}".strip() or obj.created_by.username
        return None


class RiskCreateSerializer(serializers.ModelSerializer):
    """Serializer for creating risks."""
    
    class Meta:
        model = Risk
        fields = [
            'title', 'description',
            'category', 'risk_source',
            'probability', 'impact',
            'status', 'target_resolution', 'review_date',
            'response_strategy', 'mitigation_plan', 'contingency_plan',
            'cost_impact', 'schedule_impact_days',
            'project', 'work_package', 'schedule_task', 'owner'
        ]
    
    def validate_project(self, value):
        """Ensure project exists and user has access."""
        if not value:
            raise serializers.ValidationError("Project is required.")
        return value
    
    def create(self, validated_data):
        validated_data['created_by'] = self.context['request'].user
        return super().create(validated_data)


class RiskUpdateSerializer(serializers.ModelSerializer):
    """Serializer for updating risks."""
    
    class Meta:
        model = Risk
        fields = [
            'title', 'description',
            'category', 'risk_source',
            'probability', 'impact',
            'status', 'target_resolution', 'actual_closure', 'review_date',
            'response_strategy', 'mitigation_plan', 'contingency_plan',
            'cost_impact', 'schedule_impact_days', 'residual_risk_score',
            'work_package', 'schedule_task', 'owner',
            'is_active'
        ]
    
    def update(self, instance, validated_data):
        # Track status changes for audit log
        old_status = instance.status
        instance = super().update(instance, validated_data)
        
        # Create audit log for status changes
        if 'status' in validated_data and old_status != validated_data['status']:
            RiskAuditLog.objects.create(
                risk=instance,
                action=RiskAuditLog.Action.STATUS_CHANGED,
                actor=self.context['request'].user,
                previous_values={'status': old_status},
                new_values={'status': validated_data['status']}
            )
        
        return instance


class RiskStatsSerializer(serializers.Serializer):
    """Serializer for risk statistics dashboard."""
    
    total = serializers.IntegerField()
    by_severity = serializers.DictField()
    by_status = serializers.DictField()
    by_category = serializers.DictField()
    overdue_count = serializers.IntegerField()
    avg_days_open = serializers.FloatField()
    total_cost_impact = serializers.DecimalField(max_digits=15, decimal_places=2)
    total_schedule_impact = serializers.IntegerField()
    top_risks = RiskListSerializer(many=True)


class RiskAuditLogSerializer(serializers.ModelSerializer):
    """Serializer for risk audit logs."""
    
    class Meta:
        model = RiskAuditLog
        fields = [
            'id', 'risk', 'action', 'actor', 'actor_name', 'actor_role',
            'details', 'previous_values', 'new_values',
            'timestamp', 'ip_address'
        ]
        read_only_fields = fields


class MitigationActionSubmitSerializer(serializers.Serializer):
    """Serializer for submitting a mitigation action."""
    
    def validate(self, data):
        action = self.instance
        if not action.proof_documents.exists():
            raise serializers.ValidationError({
                "proof_documents": "Cannot submit without at least one proof document."
            })
        if action.status != RiskMitigationAction.Status.DRAFT:
            raise serializers.ValidationError({
                "status": f"Can only submit actions in DRAFT status. Current: {action.status}"
            })
        return data


class MitigationActionReviewSerializer(serializers.Serializer):
    """Serializer for approving/rejecting a mitigation action."""
    
    action = serializers.ChoiceField(choices=['approve', 'reject'])
    comments = serializers.CharField(required=False, allow_blank=True)
    
    def validate(self, data):
        action = self.instance
        if action.status != RiskMitigationAction.Status.SUBMITTED:
            raise serializers.ValidationError({
                "status": f"Can only review actions in SUBMITTED status. Current: {action.status}"
            })
        if data['action'] == 'reject' and not data.get('comments'):
            raise serializers.ValidationError({
                "comments": "Rejection reason is required."
            })
        return data



================================================
FILE: backend/projects/risk_services.py
================================================
"""
Risk Management Services

Provides business logic for:
- EDMS folder auto-creation for risks
- Risk score calculations
- Notification triggers
"""
from django.db import transaction


class RiskFolderService:
    """
    Service for managing risk-related EDMS folders.
    
    Folder structure:
    {Project}/
    â””â”€â”€ Risk Management/              â† Created on first risk document
        â””â”€â”€ {risk_code}/              â† Created per risk
            â””â”€â”€ Mitigations/          â† Created on first mitigation proof
    """
    
    @staticmethod
    def get_or_create_risk_management_folder(project, created_by=None):
        """
        Get or create the root "Risk Management" folder for a project.
        This folder holds all risk-related documents.
        
        Args:
            project: Project instance
            created_by: User who triggered the creation
            
        Returns:
            Folder instance
        """
        from edms.models import Folder
        
        folder, created = Folder.objects.get_or_create(
            project=project,
            name="Risk Management",
            parent=None,
            defaults={'created_by': created_by}
        )
        
        if created:
            # Log folder creation
            from edms.models import DocumentAuditLog
            try:
                DocumentAuditLog.objects.create(
                    actor=created_by,
                    actor_role=getattr(created_by, 'role', '') if created_by else '',
                    action=DocumentAuditLog.Action.FOLDER_CREATED,
                    resource_type='Folder',
                    resource_id=folder.id,
                    details={
                        'folder_name': 'Risk Management',
                        'project_id': str(project.id),
                        'auto_created': True,
                        'trigger': 'risk_document_upload'
                    }
                )
            except Exception:
                pass  # Don't fail if audit log fails
        
        return folder
    
    @staticmethod
    def get_or_create_risk_folder(risk, created_by=None):
        """
        Get or create a folder for a specific risk.
        Structure: {Project}/Risk Management/{risk_code}/
        
        Args:
            risk: Risk instance
            created_by: User who triggered the creation
            
        Returns:
            Folder instance
        """
        from edms.models import Folder
        
        # First ensure the Risk Management parent folder exists
        rm_folder = RiskFolderService.get_or_create_risk_management_folder(
            risk.project, 
            created_by
        )
        
        # Create folder for this specific risk
        folder, created = Folder.objects.get_or_create(
            project=risk.project,
            name=risk.risk_code,
            parent=rm_folder,
            defaults={'created_by': created_by}
        )
        
        # Update risk with folder reference if not set
        if risk.edms_folder_id != folder.id:
            risk.edms_folder = folder
            risk.save(update_fields=['edms_folder', 'updated_at'])
        
        return folder
    
    @staticmethod
    def get_or_create_mitigation_folder(risk, created_by=None):
        """
        Get or create a "Mitigations" subfolder within a risk folder.
        Structure: {Project}/Risk Management/{risk_code}/Mitigations/
        
        Args:
            risk: Risk instance
            created_by: User who triggered the creation
            
        Returns:
            Folder instance
        """
        from edms.models import Folder
        
        # First ensure the risk folder exists
        risk_folder = RiskFolderService.get_or_create_risk_folder(risk, created_by)
        
        # Create Mitigations subfolder
        folder, _ = Folder.objects.get_or_create(
            project=risk.project,
            name="Mitigations",
            parent=risk_folder,
            defaults={'created_by': created_by}
        )
        
        return folder


class RiskCalculationService:
    """
    Service for risk calculations and aggregations.
    """
    
    # Risk score thresholds
    SEVERITY_THRESHOLDS = {
        'CRITICAL': (16, 25),
        'HIGH': (10, 15),
        'MEDIUM': (5, 9),
        'LOW': (1, 4)
    }
    
    @staticmethod
    def calculate_severity(risk_score):
        """
        Calculate severity level from risk score.
        
        Args:
            risk_score: Integer 1-25
            
        Returns:
            Severity string: LOW, MEDIUM, HIGH, or CRITICAL
        """
        from .risk_models import Risk
        
        if risk_score >= 16:
            return Risk.Severity.CRITICAL
        elif risk_score >= 10:
            return Risk.Severity.HIGH
        elif risk_score >= 5:
            return Risk.Severity.MEDIUM
        return Risk.Severity.LOW
    
    @staticmethod
    def get_project_risk_summary(project):
        """
        Get risk summary statistics for a project.
        
        Args:
            project: Project instance or project_id
            
        Returns:
            dict with risk counts and metrics
        """
        from .risk_models import Risk
        from django.db.models import Sum, Avg
        from django.utils import timezone
        
        project_id = project if isinstance(project, str) else project.id
        
        risks = Risk.objects.filter(
            project_id=project_id,
            is_active=True
        )
        
        today = timezone.now().date()
        
        summary = {
            'total': risks.count(),
            'by_severity': {
                'critical': risks.filter(severity='CRITICAL').count(),
                'high': risks.filter(severity='HIGH').count(),
                'medium': risks.filter(severity='MEDIUM').count(),
                'low': risks.filter(severity='LOW').count(),
            },
            'by_status': {
                'identified': risks.filter(status='IDENTIFIED').count(),
                'assessed': risks.filter(status='ASSESSED').count(),
                'mitigating': risks.filter(status='MITIGATING').count(),
                'mitigated': risks.filter(status='MITIGATED').count(),
                'closed': risks.filter(status='CLOSED').count(),
                'occurred': risks.filter(status='OCCURRED').count(),
            },
            'overdue': risks.filter(
                target_resolution__lt=today
            ).exclude(
                status__in=['CLOSED', 'MITIGATED']
            ).count(),
            'total_cost_impact': float(
                risks.aggregate(Sum('cost_impact'))['cost_impact__sum'] or 0
            ),
            'total_schedule_impact': risks.aggregate(
                Sum('schedule_impact_days')
            )['schedule_impact_days__sum'] or 0,
        }
        
        return summary
    
    @staticmethod
    def recalculate_residual_score(risk):
        """
        Recalculate residual risk score based on approved mitigations.
        Takes the minimum residual score from all approved mitigation actions.
        
        Args:
            risk: Risk instance
        """
        approved_mitigations = risk.mitigation_actions.filter(
            status='APPROVED',
            residual_probability__isnull=False,
            residual_impact__isnull=False
        ).order_by('-reviewed_at')
        
        if approved_mitigations.exists():
            # Use the most recent approved mitigation's assessment
            latest = approved_mitigations.first()
            risk.residual_risk_score = latest.residual_probability * latest.residual_impact
            risk.save(update_fields=['residual_risk_score', 'updated_at'])


class RiskNotificationService:
    """
    Service for risk-related notifications.
    """
    
    @staticmethod
    def notify_high_risk_created(risk):
        """
        Send notifications when a HIGH or CRITICAL risk is created.
        
        Args:
            risk: Risk instance
        """
        from communications.models import Notification
        
        if risk.severity not in ['HIGH', 'CRITICAL']:
            return
        
        # Get recipients: project manager and risk owner
        recipients = []
        
        if risk.project.manager:
            recipients.append(risk.project.manager)
        
        if risk.owner and risk.owner not in recipients:
            recipients.append(risk.owner)
        
        for recipient in recipients:
            try:
                Notification.objects.create(
                    user=recipient,
                    title=f"âš ï¸ {risk.severity} Risk Identified",
                    message=f"New {risk.severity.lower()} risk '{risk.title}' identified in project {risk.project.name}",
                    link=f"/projects/{risk.project_id}/risks/{risk.id}",
                    priority='HIGH' if risk.severity == 'CRITICAL' else 'NORMAL'
                )
            except Exception:
                pass  # Don't fail if notification fails
    
    @staticmethod
    def notify_risk_overdue(risk):
        """
        Send notification when a risk becomes overdue.
        
        Args:
            risk: Risk instance
        """
        from communications.models import Notification
        
        if not risk.is_overdue or not risk.owner:
            return
        
        try:
            Notification.objects.create(
                user=risk.owner,
                title="ğŸ•’ Risk Resolution Overdue",
                message=f"Risk '{risk.risk_code}: {risk.title}' is past its target resolution date.",
                link=f"/projects/{risk.project_id}/risks/{risk.id}",
                priority='HIGH'
            )
        except Exception:
            pass
    
    @staticmethod
    def notify_mitigation_submitted(mitigation_action):
        """
        Notify risk owner when mitigation action is submitted for review.
        
        Args:
            mitigation_action: RiskMitigationAction instance
        """
        from communications.models import Notification
        
        risk = mitigation_action.risk
        
        if not risk.owner:
            return
        
        try:
            Notification.objects.create(
                user=risk.owner,
                title="ğŸ“‹ Mitigation Action Needs Review",
                message=f"Mitigation action for '{risk.risk_code}' submitted by {mitigation_action.created_by.username}",
                link=f"/projects/{risk.project_id}/risks/{risk.id}",
                priority='NORMAL'
            )
        except Exception:
            pass



================================================
FILE: backend/projects/risk_views.py
================================================
"""
Risk Management Views

Provides API endpoints for:
- Risk CRUD operations
- Risk document management
- Mitigation action workflow
- Risk statistics for dashboard
"""
from rest_framework import viewsets, views, status, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser, FormParser, JSONParser
from django.db.models import Avg, Sum, Count, Q
from django.db.models.functions import Coalesce
from django.utils import timezone
import logging

logger = logging.getLogger(__name__)

from .risk_models import (
    Risk, RiskDocument, RiskMitigationAction, 
    MitigationProofDocument, RiskAuditLog
)
from .risk_serializers import (
    RiskListSerializer, RiskDetailSerializer, 
    RiskCreateSerializer, RiskUpdateSerializer,
    RiskDocumentSerializer, RiskMitigationActionListSerializer,
    RiskMitigationActionDetailSerializer, RiskMitigationActionCreateSerializer,
    MitigationProofDocumentSerializer, RiskAuditLogSerializer,
    MitigationActionSubmitSerializer, MitigationActionReviewSerializer
)
from .risk_services import RiskFolderService


class RiskViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Risk CRUD operations.
    
    Endpoints:
    - GET    /api/projects/risks/           - List all risks (filterable)
    - POST   /api/projects/risks/           - Create new risk
    - GET    /api/projects/risks/{id}/      - Get risk details
    - PUT    /api/projects/risks/{id}/      - Update risk
    - DELETE /api/projects/risks/{id}/      - Soft delete risk
    - GET    /api/projects/risks/stats/     - Get risk statistics
    """
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        queryset = Risk.objects.filter(is_active=True).select_related(
            'project', 'owner', 'created_by', 'work_package', 'schedule_task'
        ).prefetch_related('risk_documents', 'mitigation_actions')
        
        # Filter by project
        project_id = self.request.query_params.get('project')
        if project_id:
            queryset = queryset.filter(project_id=project_id)
        
        # Filter by status
        status_filter = self.request.query_params.get('status')
        if status_filter:
            queryset = queryset.filter(status=status_filter)
        
        # Filter by severity
        severity = self.request.query_params.get('severity')
        if severity:
            queryset = queryset.filter(severity=severity)
        
        # Filter by category
        category = self.request.query_params.get('category')
        if category:
            queryset = queryset.filter(category=category)
        
        # Filter by owner
        owner = self.request.query_params.get('owner')
        if owner:
            queryset = queryset.filter(owner_id=owner)
        
        # Filter overdue only
        overdue = self.request.query_params.get('overdue')
        if overdue and overdue.lower() == 'true':
            today = timezone.now().date()
            queryset = queryset.filter(
                target_resolution__lt=today
            ).exclude(
                status__in=[Risk.Status.CLOSED, Risk.Status.MITIGATED]
            )
        
        return queryset
    
    def get_serializer_class(self):
        if self.action == 'list':
            return RiskListSerializer
        elif self.action == 'create':
            return RiskCreateSerializer
        elif self.action in ['update', 'partial_update']:
            return RiskUpdateSerializer
        return RiskDetailSerializer
    
    def perform_create(self, serializer):
        risk = serializer.save()
        
        # Create audit log
        RiskAuditLog.objects.create(
            risk=risk,
            action=RiskAuditLog.Action.CREATED,
            actor=self.request.user,
            details={
                'title': risk.title,
                'severity': risk.severity,
                'project': str(risk.project_id)
            }
        )
    
    def perform_destroy(self, instance):
        """Soft delete instead of hard delete."""
        instance.is_active = False
        instance.save(update_fields=['is_active', 'updated_at'])
        
        # Create audit log
        RiskAuditLog.objects.create(
            risk=instance,
            action=RiskAuditLog.Action.CLOSED,
            actor=self.request.user,
            details={'reason': 'Deleted by user'}
        )
    
    @action(detail=False, methods=['get'])
    def stats(self, request):
        """Get aggregated risk statistics for dashboard."""
        try:
            queryset = self.get_queryset()
            total_count = queryset.count()
            logger.info(f"Risk stats: Found {total_count} risks in queryset")
            
            # Aggregate statistics
            stats = {
                'total': total_count,
                'by_severity': {
                    'critical': queryset.filter(severity='CRITICAL').count(),
                    'high': queryset.filter(severity='HIGH').count(),
                    'medium': queryset.filter(severity='MEDIUM').count(),
                    'low': queryset.filter(severity='LOW').count(),
                },
                'by_status': {},
                'by_category': {},
                'overdue_count': 0,
                'avg_days_open': 0,
                'total_cost_impact': 0,
                'total_schedule_impact': 0,
                'top_risks': []
            }
            
            # Count by status
            for choice in Risk.Status.choices:
                stats['by_status'][choice[0]] = queryset.filter(status=choice[0]).count()
            
            # Count by category
            for choice in Risk.Category.choices:
                count = queryset.filter(category=choice[0]).count()
                if count > 0:
                    stats['by_category'][choice[0]] = count
            
            # Overdue count
            today = timezone.now().date()
            stats['overdue_count'] = queryset.filter(
                target_resolution__lt=today
            ).exclude(
                status__in=[Risk.Status.CLOSED, Risk.Status.MITIGATED]
            ).count()
            
            # Average days open (for non-closed risks)
            open_risks = queryset.exclude(status=Risk.Status.CLOSED)
            if open_risks.exists():
                try:
                    total_days = sum(r.days_open for r in open_risks)
                    stats['avg_days_open'] = round(total_days / open_risks.count(), 1)
                except Exception as e:
                    logger.warning(f"Failed to calculate average days open: {e}")
                    stats['avg_days_open'] = 0
            
            # Total impacts
            from django.db.models import DecimalField, IntegerField
            from decimal import Decimal
            aggregates = queryset.aggregate(
                total_cost=Coalesce(Sum('cost_impact'), Decimal('0.00'), output_field=DecimalField()),
                total_schedule=Coalesce(Sum('schedule_impact_days'), 0, output_field=IntegerField())
            )
            stats['total_cost_impact'] = float(aggregates['total_cost'])
            stats['total_schedule_impact'] = aggregates['total_schedule']
            
            # Top 5 high/critical risks
            top_risks = queryset.filter(
                severity__in=['HIGH', 'CRITICAL']
            ).exclude(
                status=Risk.Status.CLOSED
            ).order_by('-risk_score', '-created_at')[:5]
            stats['top_risks'] = RiskListSerializer(top_risks, many=True).data
            
            return Response(stats)
        except Exception as e:
            logger.error(f"Error fetching risk stats: {e}")
            # Return empty stats on error instead of 500
            return Response({
                'total': 0,
                'by_severity': {'critical': 0, 'high': 0, 'medium': 0, 'low': 0},
                'by_status': {},
                'by_category': {},
                'overdue_count': 0,
                'avg_days_open': 0,
                'total_cost_impact': 0,
                'total_schedule_impact': 0,
                'top_risks': [],
                'error': str(e)
            })
    
    @action(detail=True, methods=['get'])
    def audit_log(self, request, pk=None):
        """Get audit log for a specific risk."""
        risk = self.get_object()
        logs = risk.audit_logs.all()
        serializer = RiskAuditLogSerializer(logs, many=True)
        return Response(serializer.data)


class RiskDocumentViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Risk Document attachments.
    
    Endpoints:
    - GET    /api/projects/risks/{risk_id}/documents/     - List documents
    - POST   /api/projects/risks/{risk_id}/documents/     - Upload document
    - DELETE /api/projects/risks/{risk_id}/documents/{id}/ - Remove document
    """
    serializer_class = RiskDocumentSerializer
    permission_classes = [permissions.IsAuthenticated]
    parser_classes = [MultiPartParser, FormParser, JSONParser]
    
    def get_queryset(self):
        risk_id = self.kwargs.get('risk_pk')
        return RiskDocument.objects.filter(risk_id=risk_id).select_related('document')
    
    def perform_create(self, serializer):
        risk_id = self.kwargs.get('risk_pk')
        risk = Risk.objects.get(id=risk_id)
        
        # Ensure EDMS folder exists
        folder = RiskFolderService.get_or_create_risk_folder(risk, self.request.user)
        
        # Save document
        serializer.save(
            risk=risk,
            uploaded_by=self.request.user
        )
        
        # Create audit log
        RiskAuditLog.objects.create(
            risk=risk,
            action=RiskAuditLog.Action.DOCUMENT_ADDED,
            actor=self.request.user,
            details={
                'document_type': serializer.validated_data.get('document_type'),
                'document_id': str(serializer.validated_data.get('document').id)
            }
        )


class RiskMitigationActionViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Mitigation Actions with workflow.
    
    Endpoints:
    - GET    /api/projects/risks/{risk_id}/mitigations/              - List actions
    - POST   /api/projects/risks/{risk_id}/mitigations/              - Create action
    - GET    /api/projects/risks/{risk_id}/mitigations/{id}/         - Get details
    - PUT    /api/projects/risks/{risk_id}/mitigations/{id}/         - Update action
    - POST   /api/projects/risks/{risk_id}/mitigations/{id}/submit/  - Submit for review
    - POST   /api/projects/risks/{risk_id}/mitigations/{id}/review/  - Approve/Reject
    """
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        risk_id = self.kwargs.get('risk_pk')
        return RiskMitigationAction.objects.filter(
            risk_id=risk_id
        ).select_related('created_by', 'reviewed_by').prefetch_related('proof_documents')
    
    def get_serializer_class(self):
        if self.action == 'create':
            return RiskMitigationActionCreateSerializer
        elif self.action == 'retrieve':
            return RiskMitigationActionDetailSerializer
        return RiskMitigationActionListSerializer
    
    def perform_create(self, serializer):
        risk_id = self.kwargs.get('risk_pk')
        risk = Risk.objects.get(id=risk_id)
        
        action = serializer.save(
            risk=risk,
            created_by=self.request.user
        )
        
        # Update risk status to MITIGATING if not already
        if risk.status == Risk.Status.ASSESSED:
            risk.status = Risk.Status.MITIGATING
            risk.save(update_fields=['status', 'updated_at'])
        
        # Create audit log
        RiskAuditLog.objects.create(
            risk=risk,
            action=RiskAuditLog.Action.MITIGATION_ADDED,
            actor=self.request.user,
            details={
                'action_number': action.action_number,
                'action_type': action.action_type,
                'title': action.title
            }
        )
    
    @action(detail=True, methods=['post'])
    def submit(self, request, risk_pk=None, pk=None):
        """Submit mitigation action for review."""
        action = self.get_object()
        serializer = MitigationActionSubmitSerializer(instance=action, data={})
        
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        try:
            action.submit()
            
            # Create audit log
            RiskAuditLog.objects.create(
                risk=action.risk,
                action=RiskAuditLog.Action.MITIGATION_SUBMITTED,
                actor=request.user,
                details={
                    'action_number': action.action_number,
                    'title': action.title
                }
            )
            
            return Response({
                'status': 'success',
                'message': 'Mitigation action submitted for review.',
                'action': RiskMitigationActionDetailSerializer(action).data
            })
        except Exception as e:
            return Response({
                'status': 'error',
                'message': str(e)
            }, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'])
    def review(self, request, risk_pk=None, pk=None):
        """Approve or reject mitigation action."""
        action_obj = self.get_object()
        serializer = MitigationActionReviewSerializer(
            instance=action_obj, 
            data=request.data
        )
        
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        try:
            review_action = serializer.validated_data['action']
            comments = serializer.validated_data.get('comments', '')
            
            if review_action == 'approve':
                action_obj.approve(request.user, comments)
                audit_action = RiskAuditLog.Action.MITIGATION_APPROVED
                message = 'Mitigation action approved.'
            else:
                action_obj.reject(request.user, comments)
                audit_action = RiskAuditLog.Action.MITIGATION_REJECTED
                message = 'Mitigation action rejected.'
            
            # Create audit log
            RiskAuditLog.objects.create(
                risk=action_obj.risk,
                action=audit_action,
                actor=request.user,
                details={
                    'action_number': action_obj.action_number,
                    'comments': comments
                }
            )
            
            return Response({
                'status': 'success',
                'message': message,
                'action': RiskMitigationActionDetailSerializer(action_obj).data
            })
        except Exception as e:
            return Response({
                'status': 'error',
                'message': str(e)
            }, status=status.HTTP_400_BAD_REQUEST)


class MitigationProofDocumentViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Mitigation Proof Documents.
    
    Endpoints:
    - GET  /api/projects/mitigations/{mitigation_id}/proofs/  - List proofs
    - POST /api/projects/mitigations/{mitigation_id}/proofs/  - Upload proof
    """
    serializer_class = MitigationProofDocumentSerializer
    permission_classes = [permissions.IsAuthenticated]
    parser_classes = [MultiPartParser, FormParser, JSONParser]
    
    def get_queryset(self):
        mitigation_id = self.kwargs.get('mitigation_pk')
        return MitigationProofDocument.objects.filter(
            mitigation_action_id=mitigation_id
        ).select_related('document')
    
    def perform_create(self, serializer):
        mitigation_id = self.kwargs.get('mitigation_pk')
        mitigation = RiskMitigationAction.objects.get(id=mitigation_id)
        
        # Ensure folder exists
        folder = RiskFolderService.get_or_create_mitigation_folder(
            mitigation.risk, 
            self.request.user
        )
        
        serializer.save(
            mitigation_action=mitigation,
            uploaded_by=self.request.user
        )


class ProjectRisksView(views.APIView):
    """
    Get all risks for a specific project.
    
    GET /api/projects/{project_id}/risks/
    """
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request, project_id):
        risks = Risk.objects.filter(
            project_id=project_id,
            is_active=True
        ).select_related('owner').order_by('-created_at')
        
        serializer = RiskListSerializer(risks, many=True)
        return Response(serializer.data)



================================================
FILE: backend/projects/serializers.py
================================================
from rest_framework import serializers
from .models import Project, WorkPackage, FundingSource
from users.serializers import UserSerializer


class WorkPackageSerializer(serializers.ModelSerializer):
    contractor_name = serializers.SerializerMethodField()
    
    class Meta:
        model = WorkPackage
        fields = [
            'id', 'project', 'contractor', 'contractor_name', 'name', 
            'description', 'status', 'budget', 'start_date', 'end_date',
            'agreement_no', 'agreement_date', 'responsible_staff',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'created_at', 'updated_at']

    def get_contractor_name(self, obj):
        if obj.contractor:
            return f"{obj.contractor.first_name} {obj.contractor.last_name}".strip() or obj.contractor.username
        return None


class FundingSourceSerializer(serializers.ModelSerializer):
    class Meta:
        model = FundingSource
        fields = ['id', 'source', 'amount', 'document', 'created_at']
        read_only_fields = ['id', 'created_at']
        extra_kwargs = {
            'document': {'required': False, 'allow_null': True},
        }


class ProjectSerializer(serializers.ModelSerializer):
    """
    Project serializer with master data references.
    
    IMPORTANT: Progress fields are READ-ONLY. They are computed by the
    ProjectProgressCalculator service and cannot be set via API.
    
    For reading: Returns nested objects with id, code, name for display.
    For writing: Accepts just the ID for each foreign key field.
    
    Most fields are optional to allow flexible project creation.
    """
    location = serializers.SerializerMethodField()
    work_packages = WorkPackageSerializer(many=True, read_only=True)
    
    # Read-only nested representations for display
    zone_name = serializers.CharField(source='zone.name', read_only=True, default='', allow_null=True)
    circle_name = serializers.CharField(source='circle.name', read_only=True, default='', allow_null=True)
    division_name = serializers.CharField(source='division.name', read_only=True, default='', allow_null=True)
    sub_division_name = serializers.CharField(source='sub_division.name', read_only=True, default='', allow_null=True)
    district_name = serializers.CharField(source='district.name', read_only=True, default='', allow_null=True)
    town_name = serializers.CharField(source='town.name', read_only=True, default='', allow_null=True)
    scheme_type_name = serializers.CharField(source='scheme_type.name', read_only=True, default='', allow_null=True)
    scheme_name = serializers.CharField(source='scheme.name', read_only=True, default='', allow_null=True)
    work_type_name = serializers.CharField(source='work_type.name', read_only=True, default='', allow_null=True)
    project_category_name = serializers.CharField(source='project_category.name', read_only=True, default='', allow_null=True)
    
    # Manager relationship
    manager_name = serializers.SerializerMethodField()
    
    # Nested fundings (writable)
    fundings = FundingSourceSerializer(many=True, read_only=False, required=False)
    
    # Computed display fields
    hierarchy_display = serializers.CharField(read_only=True)
    location_display = serializers.CharField(read_only=True)
    
    # Progress state display
    progress_state_display = serializers.CharField(
        source='get_progress_state_display', 
        read_only=True
    )
    
    class Meta:
        model = Project
        fields = [
            'id', 'name', 'description', 'status', 
            'start_date', 'end_date', 
            
            # All progress fields (READ-ONLY)
            'progress',  # Legacy
            'physical_progress',
            'financial_progress',
            'earned_value',
            'progress_state',
            'progress_state_display',
            'schedule_variance',
            
            # Financial
            'budget', 'spent', 'location', 
            
            # Hierarchy FKs (write) + names (read)
            'zone', 'zone_name',
            'circle', 'circle_name', 
            'division', 'division_name',
            'sub_division', 'sub_division_name',
            
            # Geography FKs (write) + names (read)
            'district', 'district_name',
            'town', 'town_name',
            
            # Classification FKs (write) + names (read)
            'scheme_type', 'scheme_type_name',
            'scheme', 'scheme_name',
            'work_type', 'work_type_name',
            'project_category', 'project_category_name',
            
            # Computed displays
            'hierarchy_display', 'location_display',
            
            # Legacy/other fields
            'lat', 'lng', 'address',
            'manager', 'manager_name',
            'admin_approval_reference_no', 'admin_approval_date', 'admin_approval_document',
            'fundings',
            'stakeholders', 'category', 
            'land_acquisition_status', 'work_packages',
            'created_at', 'updated_at'
        ]
        read_only_fields = [
            'id', 
            'created_at', 
            'updated_at', 
            'hierarchy_display', 
            'location_display',
            # CRITICAL: All computed progress fields are strictly read-only
            'progress',
            'physical_progress',
            'financial_progress',
            'earned_value',
            'progress_state',
            'schedule_variance',
        ]
        # Make most FK fields optional
        extra_kwargs = {
            'zone': {'required': False, 'allow_null': True},
            'circle': {'required': False, 'allow_null': True},
            'division': {'required': False, 'allow_null': True},
            'sub_division': {'required': False, 'allow_null': True},
            'district': {'required': False, 'allow_null': True},
            'town': {'required': False, 'allow_null': True},
            'scheme_type': {'required': False, 'allow_null': True},
            'scheme': {'required': False, 'allow_null': True},
            'work_type': {'required': False, 'allow_null': True},
            'project_category': {'required': False, 'allow_null': True},
            'manager': {'required': False, 'allow_null': True},
            'description': {'required': False, 'allow_blank': True},
            'start_date': {'required': False, 'allow_null': True},
            'end_date': {'required': False, 'allow_null': True},
        }

    def get_location(self, obj):
        """Returns location data for map display."""
        if obj.lat is not None and obj.lng is not None:
            return {
                "lat": obj.lat,
                "lng": obj.lng,
                "address": obj.address
            }
        return None
    
    def get_manager_name(self, obj):
        if obj.manager:
            return f"{obj.manager.first_name} {obj.manager.last_name}".strip() or obj.manager.username
        return None
    
    def create(self, validated_data):
        fundings_data = validated_data.pop('fundings', [])
        project = Project.objects.create(**validated_data)
        
        # Create funding sources
        for funding_data in fundings_data:
            FundingSource.objects.create(project=project, **funding_data)
        
        return project
    
    def update(self, instance, validated_data):
        fundings_data = validated_data.pop('fundings', None)
        
        # Update project fields
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()
        
        # Update fundings if provided
        if fundings_data is not None:
            # Clear existing and recreate
            instance.fundings.all().delete()
            for funding_data in fundings_data:
                FundingSource.objects.create(project=instance, **funding_data)
        
        return instance





================================================
FILE: backend/projects/signals.py
================================================
"""
Project Signals - EDMS Integration

Triggers:
- Automatic folder structure creation when a project is created

Safeguards:
- Only runs on NEW projects (created=True), NOT on updates
- Uses transaction.on_commit to avoid database conflicts
- Catches and logs errors without breaking project creation
"""
import logging
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.db import transaction

from .models import Project

logger = logging.getLogger(__name__)


@receiver(post_save, sender=Project)
def create_project_folder_structure(sender, instance, created, **kwargs):
    """
    Auto-create EDMS folder structure when a project is created.
    
    IMPORTANT: This only runs when created=True to prevent:
    - Infinite loops (if folder creation somehow updates project)
    - Duplicate folder creation on every save
    - Performance issues on frequent project updates
    
    Args:
        sender: Project model class
        instance: Project instance being saved
        created: True if this is a new project, False if update
        **kwargs: Additional signal arguments
    """
    # GUARD: Only run on creation, never on updates
    if not created:
        return
    
    # Use on_commit to ensure project is fully saved before creating folders
    transaction.on_commit(
        lambda: _safe_create_folder_structure(instance)
    )


def _safe_create_folder_structure(project):
    """
    Safely create folder structure with error handling.
    
    Wrapped in try/except to ensure project creation never fails
    due to EDMS folder creation issues.
    """
    try:
        from edms.services.directory_service import DirectoryService
        
        logger.info(f"Creating EDMS folder structure for new project: {project.name}")
        
        folders_created = DirectoryService.ensure_project_structure(
            project=project,
            created_by=None  # System-initiated, no specific user
        )
        
        logger.info(
            f"EDMS folder structure created for {project.name}: "
            f"{folders_created} folders"
        )
        
    except Exception as e:
        # Log error but don't fail project creation
        logger.error(
            f"Failed to create EDMS folder structure for project {project.name}: {e}",
            exc_info=True
        )
        # In production, you might want to notify admins or queue for retry
        # For now, we just log and continue



================================================
FILE: backend/projects/tests.py
================================================
from django.test import TestCase

# Create your tests here.



================================================
FILE: backend/projects/urls.py
================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from rest_framework_nested import routers as nested_routers
from .views import ProjectViewSet, WorkPackageViewSet, DashboardStatsView, RecentActivityView, CalendarEventsView
from .risk_views import (
    RiskViewSet, RiskDocumentViewSet, RiskMitigationActionViewSet,
    MitigationProofDocumentViewSet, ProjectRisksView
)

# Main router
router = DefaultRouter()
router.register(r'packages', WorkPackageViewSet, basename='workpackage')
router.register(r'risks', RiskViewSet, basename='risk')
router.register(r'', ProjectViewSet, basename='project')

# Nested router for risk documents and mitigations
risk_router = nested_routers.NestedDefaultRouter(router, r'risks', lookup='risk')
risk_router.register(r'documents', RiskDocumentViewSet, basename='risk-documents')
risk_router.register(r'mitigations', RiskMitigationActionViewSet, basename='risk-mitigations')

# Nested router for mitigation proof documents
mitigation_router = nested_routers.NestedDefaultRouter(risk_router, r'mitigations', lookup='mitigation')
mitigation_router.register(r'proofs', MitigationProofDocumentViewSet, basename='mitigation-proofs')

urlpatterns = [
    # Dashboard endpoints (must be before router)
    path('dashboard/stats/', DashboardStatsView.as_view(), name='dashboard-stats'),
    path('dashboard/activity/', RecentActivityView.as_view(), name='dashboard-activity'),
    path('dashboard/calendar/', CalendarEventsView.as_view(), name='dashboard-calendar'),
    
    # Project-specific risks endpoint
    path('<uuid:project_id>/risks/', ProjectRisksView.as_view(), name='project-risks'),
    
    # Router URLs
    path('', include(router.urls)),
    path('', include(risk_router.urls)),
    path('', include(mitigation_router.urls)),
]





================================================
FILE: backend/projects/views.py
================================================
from rest_framework import viewsets, status
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework.decorators import action
from django.db.models import Sum, Count, Q, Avg
from django.utils import timezone
from datetime import timedelta
import logging

from .models import Project, WorkPackage, FundingSource
from .serializers import ProjectSerializer, WorkPackageSerializer

logger = logging.getLogger(__name__)


class ProjectViewSet(viewsets.ModelViewSet):
    queryset = Project.objects.all()
    serializer_class = ProjectSerializer
    permission_classes = [IsAuthenticated]
    
    def create(self, request, *args, **kwargs):
        logger.info(f"Project creation request data: {request.data}")
        serializer = self.get_serializer(data=request.data)
        if not serializer.is_valid():
            logger.error(f"Project creation validation errors: {serializer.errors}")
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        try:
            self.perform_create(serializer)
            headers = self.get_success_headers(serializer.data)
            return Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)
        except Exception as e:
            logger.error(f"Project creation exception: {str(e)}")
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['get'])
    def eligible_staff(self, request, pk=None):
        """
        Get staff eligible for package assignment based on project hierarchy.
        
        Returns users who are:
        - In the same division, subdivision, or zone as the project
        - Have appropriate roles (not contractors or consultants)
        - Active accounts
        
        This ensures package responsible staff are from the project's hierarchy.
        """
        from django.contrib.auth import get_user_model
        
        User = get_user_model()
        project = self.get_object()
        
        # Build hierarchy filter
        hierarchy_filter = Q()
        
        # Filter by division first (most specific)
        if project.division:
            hierarchy_filter |= Q(division=project.division)
        
        # Filter by subdivision if available
        if project.sub_division:
            hierarchy_filter |= Q(subdivision=project.sub_division)
        
        # Filter by zone (broader)
        if project.zone:
            hierarchy_filter |= Q(zone=project.zone)
        
        # Fallback: if no hierarchy set, return all active staff
        if not (project.division or project.sub_division or project.zone):
            hierarchy_filter = Q(account_status='ACTIVE')
        
        # Get users matching hierarchy
        staff = User.objects.filter(hierarchy_filter).filter(
            account_status='ACTIVE'
        ).exclude(
            role__in=['EPC_Contractor', 'Consultant', 'Guest']  # Exclude non-staff roles
        ).select_related('division', 'subdivision', 'zone').order_by('first_name', 'last_name')[:100]
        
        # Serialize user data
        staff_data = [{
           'id': user.id,
            'username': user.username,
            'first_name': user.first_name,
            'last_name': user.last_name,
            'email': user.email,
            'full_name': user.get_full_name() if hasattr(user, 'get_full_name') else f"{user.first_name} {user.last_name}",
            'role': user.role,
            'role_display': getattr(user, 'get_role_display', lambda: user.role)(),
            'division': user.division.name if user.division else None,
        } for user in staff]
        
        return Response({
            'count': len(staff_data),
            'eligible_staff': staff_data,
            'filter_applied': {
                'division': project.division.name if project.division else None,
                'subdivision': project.sub_division.name if project.sub_division else None,
                'zone': project.zone.name if project.zone else None,
            }
        })


class WorkPackageViewSet(viewsets.ModelViewSet):
    queryset = WorkPackage.objects.all()
    serializer_class = WorkPackageSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        queryset = WorkPackage.objects.all()
        project_id = self.request.query_params.get('project', None)
        if project_id:
            queryset = queryset.filter(project_id=project_id)
        return queryset


class DashboardStatsView(APIView):
    """
    Aggregated dashboard statistics from all modules.
    Returns KPIs, financial summary, project status distribution, and recent activity.
    Enhanced with procurement, schedule health, alerts, and top projects.
    
    Note: Caching will be implemented manually in _get_stats method for DRF compatibility.
    Rate limited to 60 requests per hour per user.
    """
    permission_classes = [IsAuthenticated]
    throttle_classes = []  # Add custom throttle class if needed
    
    def get(self, request):
        try:
            return self._get_stats(request)
        except Exception as e:
            import traceback
            print(f"Dashboard stats error: {str(e)}")
            print(traceback.format_exc())
            return Response({
                'error': str(e),
                'project_stats': {'total': 0, 'in_progress': 0, 'planning': 0, 'completed': 0, 'on_hold': 0},
                'financial_summary': {'total_budget': 0, 'total_spent': 0, 'remaining': 0, 'utilization': 0},
                'pending_approvals': 0,
                'critical_risks': 0,
                'overdue_tasks': 0,
                'schedule_health': {'on_track': 0, 'delayed': 0, 'critical': 0, 'percentage': 100},
                'procurement_summary': {'active_tenders': 0, 'open_bids': 0, 'active_contracts': 0, 'pending_variations': 0},
                'alerts': [{'type': 'error', 'severity': 'critical', 'message': f'Dashboard error: {str(e)}', 'link': '/'}],
                'top_projects': [],
                'kpis': [],
                'recent_activity': [],
                'milestones': [],
                'critical_path_tasks': [],
                'risk_summary': {'high': 0, 'medium': 0, 'low': 0, 'total': 0, 'top_risks': []},
                'change_requests': [],
                'earned_value': {'cpi': 1.0, 'spi': 1.0, 'status': 'unknown'},
                'cash_flow': [],
            }, status=status.HTTP_200_OK)

    def _get_stats(self, request):
        user = request.user
        today = timezone.now().date()
        
        # Get projects data
        projects = Project.objects.all()
        active_projects = projects.filter(status='In Progress')
        
        # Project counts by status
        project_stats = {
            'total': projects.count(),
            'in_progress': active_projects.count(),
            'planning': projects.filter(status='Planning').count(),
            'completed': projects.filter(status='Completed').count(),
            'on_hold': projects.filter(status='On Hold').count(),
        }
        
        # ========== AGGREGATED PROGRESS (from computed fields) ==========
        # Physical Progress: Weighted average by budget across active projects
        progress_aggregates = active_projects.aggregate(
            total_budget=Sum('budget'),
            total_earned_value=Sum('earned_value'),
            avg_physical_progress=Avg('physical_progress'),
            avg_financial_progress=Avg('financial_progress'),
            avg_schedule_variance=Avg('schedule_variance'),
        )
        
        portfolio_physical_progress = float(progress_aggregates['avg_physical_progress'] or 0)
        portfolio_financial_progress = float(progress_aggregates['avg_financial_progress'] or 0)
        portfolio_earned_value = float(progress_aggregates['total_earned_value'] or 0)
        portfolio_schedule_variance = float(progress_aggregates['avg_schedule_variance'] or 0)
        
        # Progress state summary
        progress_state_counts = {
            'claimed': active_projects.filter(progress_state='CLAIMED').count(),
            'verified': active_projects.filter(progress_state='VERIFIED').count(),
            'flagged': active_projects.filter(progress_state='FLAGGED').count(),
        }
        
        # Financial summary
        financial_summary = projects.aggregate(
            total_budget=Sum('budget'),
            total_spent=Sum('spent'),
        )
        financial_summary['total_budget'] = float(financial_summary['total_budget'] or 0)
        financial_summary['total_spent'] = float(financial_summary['total_spent'] or 0)
        financial_summary['remaining'] = financial_summary['total_budget'] - financial_summary['total_spent']
        financial_summary['utilization'] = (
            (financial_summary['total_spent'] / financial_summary['total_budget'] * 100) 
            if financial_summary['total_budget'] > 0 else 0
        )
        
        # Get pending approvals from EDMS
        pending_approvals = 0
        overdue_approvals = 0
        try:
            from edms.models import Document
            pending_docs = Document.objects.filter(status__in=['pending_review', 'under_review'])
            pending_approvals = pending_docs.count()
            # Overdue = pending > 48 hours
            two_days_ago = timezone.now() - timedelta(hours=48)
            overdue_approvals = pending_docs.filter(created_at__lt=two_days_ago).count()
        except ImportError:
            logger.warning("EDMS module not available for dashboard stats")
        except Exception as e:
            logger.error(f"Failed to fetch EDMS approval data: {e}")
        
        # Get critical risks count
        critical_risks = 0
        try:
            critical_risks = projects.filter(
                Q(status='In Progress') & Q(progress__lt=50)
            ).count()
        except Exception as e:
            logger.error(f"Failed to calculate critical risks: {e}")
        
        # Schedule health from scheduling module
        schedule_health = {
            'on_track': 0,
            'delayed': 0,
            'critical': 0,
            'percentage': 0,
            'no_data': True  # Flag to indicate no scheduling data available
        }
        overdue_tasks = 0
        try:
            from scheduling.models import ScheduleTask
            all_tasks = ScheduleTask.objects.all()
            total_tasks = all_tasks.count()
            
            if total_tasks > 0:
                on_track = all_tasks.filter(
                    Q(status='COMPLETED') | 
                    (Q(status='IN_PROGRESS') & Q(end_date__gte=today))
                ).count()
                delayed = all_tasks.filter(
                    status='DELAYED'
                ).count()
                overdue_tasks = all_tasks.filter(
                    end_date__lt=today,
                    status__in=['PLANNED', 'IN_PROGRESS']
                ).count()
                
                schedule_health = {
                    'on_track': on_track,
                    'delayed': delayed,
                    'critical': overdue_tasks,
                    'total_tasks': total_tasks,
                    'percentage': round((on_track / total_tasks * 100), 1),
                    'no_data': False
                }
        except ImportError:
            logger.warning("Scheduling module not available for dashboard stats")
        except Exception as e:
            logger.error(f"Failed to fetch scheduling data: {e}")
        
        # Procurement data
        procurement_summary = {
            'active_tenders': 0,
            'open_bids': 0,
            'active_contracts': 0,
            'pending_variations': 0
        }
        try:
            from procurement.models import Tender, Contract, Variation
            procurement_summary = {
                'active_tenders': Tender.objects.filter(status__in=['PUBLISHED', 'BID_OPEN', 'EVALUATION']).count(),
                'open_bids': Tender.objects.filter(status='BID_OPEN').count(),
                'active_contracts': Contract.objects.filter(status='ACTIVE').count(),
                'pending_variations': Variation.objects.filter(status__in=['PROPOSED', 'UNDER_REVIEW']).count()
            }
        except Exception:
            pass
        
        # Alerts - critical items needing attention
        alerts = []
        if overdue_approvals > 0:
            alerts.append({
                'type': 'approval_overdue',
                'severity': 'warning',
                'count': overdue_approvals,
                'message': f'{overdue_approvals} documents pending > 48h',
                'link': '/approvals'
            })
        if overdue_tasks > 0:
            alerts.append({
                'type': 'task_overdue',
                'severity': 'critical',
                'count': overdue_tasks,
                'message': f'{overdue_tasks} tasks past deadline',
                'link': '/scheduling'
            })
        # Budget warnings - projects over 90% utilization
        # Use database aggregation instead of Python loop for better performance
        from django.db.models import F, ExpressionWrapper, DecimalField
        
        budget_warning_count = projects.filter(
            spent__gt=F('budget') * 0.9,
            budget__gt=0
        ).count()
        
        if budget_warning_count > 0:
            alerts.append({
                'type': 'budget_warning',
                'severity': 'warning',
                'count': budget_warning_count,
                'message': f'{budget_warning_count} projects over 90% budget',
                'link': '/projects'
            })
        
        # Top 5 projects by budget
        top_projects = []
        for p in projects.order_by('-budget')[:5]:
            utilization = (float(p.spent) / float(p.budget) * 100) if p.budget and p.budget > 0 else 0
            top_projects.append({
                'id': str(p.id),
                'name': p.name,
                'budget': float(p.budget) if p.budget else 0,
                'spent': float(p.spent) if p.spent else 0,
                'progress': p.progress or 0,
                'status': p.status,
                'utilization': round(utilization, 1)
            })
        
        # Recent activity (last 7 days)
        recent_activity = []
        one_week_ago = timezone.now() - timedelta(days=7)
        
        # Project updates
        recent_projects = projects.filter(
            updated_at__gte=one_week_ago
        ).order_by('-updated_at')[:5]
        
        for project in recent_projects:
            recent_activity.append({
                'type': 'project_update',
                'title': f'Project updated: {project.name}',
                'timestamp': project.updated_at.isoformat(),
                'icon': 'folder',
                'color': 'blue',
                'link': f'/projects/{project.id}'
            })
        
        # Document uploads
        try:
            from edms.models import Document
            recent_docs = Document.objects.filter(
                created_at__gte=one_week_ago
            ).order_by('-created_at')[:5]
            
            for doc in recent_docs:
                recent_activity.append({
                    'type': 'document_upload',
                    'title': f'Document uploaded: {doc.title}',
                    'timestamp': doc.created_at.isoformat(),
                    'icon': 'file',
                    'color': 'green',
                    'link': f'/edms?doc={doc.id}'
                })
        except Exception:
            pass
        
        # Sort by timestamp
        recent_activity.sort(key=lambda x: x['timestamp'], reverse=True)
        recent_activity = recent_activity[:10]
        
        # KPIs for the dashboard
        kpis = [
            {
                'id': 'total_budget',
                'label': 'Total Budget',
                'value': financial_summary['total_budget'],
                'formatted': f"â‚¹{financial_summary['total_budget'] / 10000000:.2f} Cr",
                'trend': 'up',
                'change': '+5.2%',
                'color': 'emerald'
            },
            {
                'id': 'active_projects',
                'label': 'Active Projects',
                'value': project_stats['in_progress'],
                'formatted': str(project_stats['in_progress']),
                'trend': 'up',
                'change': '+2',
                'color': 'blue'
            },
            {
                'id': 'pending_approvals',
                'label': 'Pending Approvals',
                'value': pending_approvals,
                'formatted': str(pending_approvals),
                'trend': 'neutral' if pending_approvals == 0 else 'down',
                'change': 'Needs attention' if pending_approvals > 0 else 'All clear',
                'color': 'amber' if pending_approvals > 0 else 'emerald'
            },
            {
                'id': 'schedule_health',
                'label': 'Schedule Health',
                'value': schedule_health['percentage'],
                'formatted': f"{schedule_health['percentage']}%",
                'trend': 'up' if schedule_health['percentage'] >= 80 else 'down',
                'change': f"{schedule_health['on_track']} on track",
                'color': 'emerald' if schedule_health['percentage'] >= 80 else 'amber'
            },
            {
                'id': 'active_contracts',
                'label': 'Active Contracts',
                'value': procurement_summary['active_contracts'],
                'formatted': str(procurement_summary['active_contracts']),
                'trend': 'up',
                'change': f"{procurement_summary['active_tenders']} tenders",
                'color': 'violet'
            }
        ]
        
        # Milestones from scheduling (next 5 upcoming)
        milestones = []
        try:
            from scheduling.models import ScheduleTask
            milestone_tasks = ScheduleTask.objects.filter(
                is_milestone=True,
                end_date__gte=today
            ).order_by('end_date')[:5]
            
            for m in milestone_tasks:
                milestones.append({
                    'id': str(m.id),
                    'name': m.name,
                    'project': m.project.name if m.project else 'N/A',
                    'date': m.end_date.isoformat() if m.end_date else None,
                    'status': m.status
                })
        except Exception:
            # Fallback: create milestones from project end dates
            for p in projects.filter(status='In Progress').order_by('end_date')[:5]:
                if p.end_date:
                    milestones.append({
                        'id': str(p.id),
                        'name': f'{p.name} - Completion',
                        'project': p.name,
                        'date': p.end_date.isoformat() if hasattr(p.end_date, 'isoformat') else str(p.end_date),
                        'status': 'PLANNED'
                    })
        
        # Critical path tasks (overdue or starting soon)
        critical_path_tasks = []
        try:
            from scheduling.models import ScheduleTask
            critical_tasks = ScheduleTask.objects.filter(
                Q(is_critical=True) | Q(end_date__lt=today, status__in=['PLANNED', 'IN_PROGRESS'])
            ).order_by('end_date')[:5]
            
            for t in critical_tasks:
                critical_path_tasks.append({
                    'id': str(t.id),
                    'name': t.name,
                    'project': t.project.name if t.project else 'N/A',
                    'end_date': t.end_date.isoformat() if t.end_date else None,
                    'status': t.status,
                    'is_overdue': t.end_date < today if t.end_date else False
                })
        except Exception:
            pass
        
        # Risk summary - NOW USING REAL RISK DATA
        risk_summary = {
            'critical': 0,
            'high': 0,
            'medium': 0,
            'low': 0,
            'total': 0,
            'overdue': 0,
            'top_risks': []
        }
        try:
            from projects.risk_models import Risk
            active_risks = Risk.objects.filter(is_active=True).exclude(status='CLOSED')
            risk_summary = {
                'critical': active_risks.filter(severity='CRITICAL').count(),
                'high': active_risks.filter(severity='HIGH').count(),
                'medium': active_risks.filter(severity='MEDIUM').count(),
                'low': active_risks.filter(severity='LOW').count(),
                'total': active_risks.count(),
                'overdue': active_risks.filter(
                    target_resolution__lt=today
                ).exclude(status__in=['CLOSED', 'MITIGATED']).count(),
                'top_risks': list(
                    active_risks.filter(severity__in=['CRITICAL', 'HIGH'])
                    .select_related('project', 'owner')
                    .values('id', 'risk_code', 'title', 'severity', 'status', 'project__name')[:5]
                )
            }
            # Update critical_risks count
            critical_risks = risk_summary['critical'] + risk_summary['high']
        except Exception as e:
            logger.warning(f"Failed to fetch risk data: {e}")
            # Estimate from project progress as fallback
            risk_summary = {
                'critical': 0,
                'high': projects.filter(progress__lt=30, status='In Progress').count(),
                'medium': projects.filter(progress__gte=30, progress__lt=60, status='In Progress').count(),
                'low': projects.filter(progress__gte=60, status='In Progress').count(),
                'total': projects.filter(status='In Progress').count(),
                'overdue': 0,
                'top_risks': []
            }
        
        # Change requests / Variations
        change_requests = []
        try:
            from procurement.models import Variation
            variations = Variation.objects.filter(status__in=['PROPOSED', 'UNDER_REVIEW']).order_by('-created_at')[:5]
            for v in variations:
                change_requests.append({
                    'id': str(v.id),
                    'title': v.description[:50] if v.description else 'Variation',
                    'type': v.variation_type,
                    'amount': float(v.amount) if v.amount else 0,
                    'status': v.status,
                    'contract': v.contract.title if v.contract else 'N/A'
                })
        except Exception:
            pass
        
        # Earned Value Metrics (EVM)
        total_budget = float(financial_summary['total_budget'] or 1)
        total_spent = float(financial_summary['total_spent'] or 0)
        avg_progress = float(projects.aggregate(avg=Avg('progress'))['avg'] or 0)
        
        # EV = Budget * Progress%
        earned_value = total_budget * (avg_progress / 100)
        # CPI = EV / AC (Cost Performance Index)
        cpi = earned_value / total_spent if total_spent > 0 else 1.0
        # SPI = EV / PV (Schedule Performance Index) - simplified
        spi = avg_progress / 50 if avg_progress > 0 else 1.0  # Assuming 50% planned progress
        
        earned_value_metrics = {
            'earned_value': round(earned_value, 2),
            'actual_cost': round(total_spent, 2),
            'cpi': round(cpi, 2),
            'spi': round(min(spi, 2.0), 2),  # Cap at 2.0
            'status': 'on_budget' if cpi >= 1.0 else 'over_budget',
            'variance': round((cpi - 1.0) * 100, 1)
        }
        
        # Cash flow (last 6 months)
        cash_flow = []
        for i in range(6):
            month_date = timezone.now() - timedelta(days=30 * (5 - i))
            month_name = month_date.strftime('%b')
            # Simulated based on total spent distribution
            inflow = (total_budget / 12) * (1 + (i * 0.1))
            outflow = (total_spent / 6) * (1 + (i * 0.05))
            cash_flow.append({
                'month': month_name,
                'inflow': round(inflow / 10000000, 2),  # In Cr
                'outflow': round(outflow / 10000000, 2),
                'net': round((inflow - outflow) / 10000000, 2)
            })
        
        return Response({
            'project_stats': project_stats,
            'financial_summary': financial_summary,
            'pending_approvals': pending_approvals,
            'critical_risks': critical_risks,
            'overdue_tasks': overdue_tasks,
            'schedule_health': schedule_health,
            'procurement_summary': procurement_summary,
            'alerts': alerts,
            'top_projects': top_projects,
            'kpis': kpis,
            'recent_activity': recent_activity,
            # New data for comprehensive dashboard
            'milestones': milestones,
            'critical_path_tasks': critical_path_tasks,
            'risk_summary': risk_summary,
            'change_requests': change_requests,
            'earned_value': earned_value_metrics,
            'cash_flow': cash_flow,
            # ========== NEW: Aggregated Progress KPIs ==========
            'portfolio_progress': {
                'physical_progress': round(portfolio_physical_progress, 1),
                'financial_progress': round(portfolio_financial_progress, 1),
                'earned_value': round(portfolio_earned_value, 2),
                'schedule_variance': round(portfolio_schedule_variance, 1),
                'active_projects': project_stats['in_progress'],
            },
            'progress_state_counts': progress_state_counts,
        })


class RecentActivityView(APIView):
    """
    Recent activity feed for the dashboard.
    Returns the latest updates across all modules.
    """
    permission_classes = [IsAuthenticated]
    
    def get(self, request):
        limit = int(request.query_params.get('limit', 20))
        one_week_ago = timezone.now() - timedelta(days=7)
        activities = []
        
        # Project updates
        recent_projects = Project.objects.filter(
            updated_at__gte=one_week_ago
        ).order_by('-updated_at')[:limit//3]
        
        for project in recent_projects:
            activities.append({
                'id': f'project-{project.id}',
                'type': 'project',
                'action': 'updated',
                'title': project.name,
                'description': f'Status: {project.status}, Progress: {project.progress}%',
                'timestamp': project.updated_at.isoformat(),
                'user': None,  # Could add updated_by field
                'link': f'/projects/{project.id}'
            })
        
        # Document uploads
        try:
            from edms.models import Document
            recent_docs = Document.objects.filter(
                created_at__gte=one_week_ago
            ).select_related('uploaded_by').order_by('-created_at')[:limit//3]
            
            for doc in recent_docs:
                activities.append({
                    'id': f'document-{doc.id}',
                    'type': 'document',
                    'action': 'uploaded',
                    'title': doc.title,
                    'description': f'Category: {doc.category}',
                    'timestamp': doc.created_at.isoformat(),
                    'user': doc.uploaded_by.get_full_name() if doc.uploaded_by else None,
                    'link': f'/edms?doc={doc.id}'
                })
        except Exception:
            pass
        
        # Sort by timestamp
        activities.sort(key=lambda x: x['timestamp'], reverse=True)
        
        return Response({
            'activities': activities[:limit],
            'total': len(activities)
        })


class CalendarEventsView(APIView):
    """
    Calendar events aggregated from all modules.
    Returns milestones, billing events, risks, compliance deadlines, and workflows.
    """
    permission_classes = [IsAuthenticated]
    
    def get(self, request):
        from datetime import datetime
        from .calendar_service import calendar_aggregator
        
        # Parse date range
        start_str = request.query_params.get('start')
        end_str = request.query_params.get('end')
        
        try:
            if start_str:
                start_date = datetime.fromisoformat(start_str.replace('Z', '+00:00')).date()
            else:
                start_date = timezone.now().date() - timedelta(days=30)
            
            if end_str:
                end_date = datetime.fromisoformat(end_str.replace('Z', '+00:00')).date()
            else:
                end_date = timezone.now().date() + timedelta(days=60)
        except ValueError:
            return Response({'error': 'Invalid date format'}, status=status.HTTP_400_BAD_REQUEST)
        
        # Parse filters
        filters = {}
        event_types = request.query_params.get('event_types')
        if event_types:
            filters['event_types'] = event_types.split(',')
        
        projects = request.query_params.get('projects')
        if projects:
            filters['projects'] = projects.split(',')
        
        # Get aggregated events
        events = calendar_aggregator.get_events(
            user=request.user,
            start_date=start_date,
            end_date=end_date,
            filters=filters
        )
        
        return Response({
            'events': events,
            'count': len(events),
            'start_date': start_date.isoformat(),
            'end_date': end_date.isoformat()
        })




================================================
FILE: backend/projects/management/__init__.py
================================================
# Empty init file



================================================
FILE: backend/projects/management/commands/__init__.py
================================================
# Empty init file



================================================
FILE: backend/projects/management/commands/clear_manager_data.py
================================================
from django.core.management.base import BaseCommand
from django.db import connection


class Command(BaseCommand):
    help = 'Clear manager field from projects before migration'

    def handle(self, *args, **options):
        with connection.cursor() as cursor:
            # First, drop the NOT NULL constraint
            cursor.execute("ALTER TABLE projects_project ALTER COLUMN manager DROP NOT NULL")
            self.stdout.write(self.style.SUCCESS('Dropped NOT NULL constraint on manager field'))
            
            # Now clear the data
            cursor.execute("UPDATE projects_project SET manager = NULL WHERE manager IS NOT NULL")
            rows_updated = cursor.rowcount
            self.stdout.write(
                self.style.SUCCESS(f'Successfully cleared manager field from {rows_updated} projects')
            )



================================================
FILE: backend/projects/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2025-12-12 14:46

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Project',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True)),
                ('status', models.CharField(choices=[('Planning', 'Planning'), ('In Progress', 'In Progress'), ('Completed', 'Completed'), ('On Hold', 'On Hold'), ('Under Review', 'Under Review')], default='Planning', max_length=50)),
                ('start_date', models.DateField(blank=True, null=True)),
                ('end_date', models.DateField(blank=True, null=True)),
                ('progress', models.FloatField(default=0.0)),
                ('budget', models.DecimalField(decimal_places=2, default=0.0, max_digits=12)),
                ('spent', models.DecimalField(decimal_places=2, default=0.0, max_digits=12)),
                ('lat', models.FloatField(blank=True, null=True)),
                ('lng', models.FloatField(blank=True, null=True)),
                ('address', models.CharField(blank=True, max_length=500)),
                ('manager', models.CharField(blank=True, max_length=255)),
                ('stakeholders', models.JSONField(blank=True, default=list)),
                ('category', models.CharField(blank=True, max_length=100)),
                ('land_acquisition_status', models.FloatField(default=0.0)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
    ]



================================================
FILE: backend/projects/migrations/0002_workpackage.py
================================================
# Generated by Django 6.0 on 2025-12-15 09:37

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('projects', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='WorkPackage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True)),
                ('status', models.CharField(choices=[('Pending', 'Pending'), ('In Progress', 'In Progress'), ('Completed', 'Completed'), ('On Hold', 'On Hold')], default='Pending', max_length=50)),
                ('budget', models.DecimalField(decimal_places=2, default=0.0, max_digits=12)),
                ('start_date', models.DateField(blank=True, null=True)),
                ('end_date', models.DateField(blank=True, null=True)),
                ('agreement_no', models.CharField(blank=True, max_length=100, null=True)),
                ('agreement_date', models.DateField(blank=True, null=True)),
                ('responsible_staff', models.CharField(blank=True, max_length=255, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('contractor', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='assigned_packages', to=settings.AUTH_USER_MODEL)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='work_packages', to='projects.project')),
            ],
        ),
    ]



================================================
FILE: backend/projects/migrations/0003_add_master_foreignkeys.py
================================================
# Generated by Django 6.0 on 2026-01-01 10:58

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('masters', '0001_initial'),
        ('projects', '0002_workpackage'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='project',
            options={'ordering': ['-created_at']},
        ),
        migrations.AddField(
            model_name='project',
            name='circle',
            field=models.ForeignKey(blank=True, help_text='Administrative circle', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.circle'),
        ),
        migrations.AddField(
            model_name='project',
            name='district',
            field=models.ForeignKey(blank=True, help_text='Project district', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.district'),
        ),
        migrations.AddField(
            model_name='project',
            name='division',
            field=models.ForeignKey(blank=True, help_text='Administrative division', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.division'),
        ),
        migrations.AddField(
            model_name='project',
            name='project_category',
            field=models.ForeignKey(blank=True, help_text='Project category classification', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.projectcategory'),
        ),
        migrations.AddField(
            model_name='project',
            name='scheme',
            field=models.ForeignKey(blank=True, help_text='Specific scheme', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.scheme'),
        ),
        migrations.AddField(
            model_name='project',
            name='scheme_type',
            field=models.ForeignKey(blank=True, help_text='Type of scheme', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.schemetype'),
        ),
        migrations.AddField(
            model_name='project',
            name='sub_division',
            field=models.ForeignKey(blank=True, help_text='Administrative sub-division', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.subdivision'),
        ),
        migrations.AddField(
            model_name='project',
            name='town',
            field=models.ForeignKey(blank=True, help_text='Project town/city', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.town'),
        ),
        migrations.AddField(
            model_name='project',
            name='work_type',
            field=models.ForeignKey(blank=True, help_text='Type of work', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.worktype'),
        ),
        migrations.AddField(
            model_name='project',
            name='zone',
            field=models.ForeignKey(blank=True, help_text='Administrative zone', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='projects', to='masters.zone'),
        ),
        migrations.AlterField(
            model_name='project',
            name='address',
            field=models.CharField(blank=True, help_text='Physical address or landmark', max_length=500),
        ),
        migrations.AlterField(
            model_name='project',
            name='budget',
            field=models.DecimalField(decimal_places=2, default=0.0, max_digits=15),
        ),
        migrations.AlterField(
            model_name='project',
            name='category',
            field=models.CharField(blank=True, help_text='Legacy category field', max_length=100),
        ),
        migrations.AlterField(
            model_name='project',
            name='lat',
            field=models.FloatField(blank=True, help_text='Latitude for map display', null=True),
        ),
        migrations.AlterField(
            model_name='project',
            name='lng',
            field=models.FloatField(blank=True, help_text='Longitude for map display', null=True),
        ),
        migrations.AlterField(
            model_name='project',
            name='spent',
            field=models.DecimalField(decimal_places=2, default=0.0, max_digits=15),
        ),
    ]



================================================
FILE: backend/projects/migrations/0004_project_earned_value_project_financial_progress_and_more.py
================================================
# Generated by Django 6.0 on 2026-01-10 18:53

import django.core.validators
from decimal import Decimal
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('projects', '0003_add_master_foreignkeys'),
    ]

    operations = [
        migrations.AddField(
            model_name='project',
            name='earned_value',
            field=models.DecimalField(decimal_places=2, default=Decimal('0.00'), help_text='Computed Earned Value (EV). DO NOT EDIT DIRECTLY.', max_digits=15),
        ),
        migrations.AddField(
            model_name='project',
            name='financial_progress',
            field=models.FloatField(default=0.0, help_text='Computed financial progress (EV/Budget %). DO NOT EDIT DIRECTLY.', validators=[django.core.validators.MinValueValidator(0.0)]),
        ),
        migrations.AddField(
            model_name='project',
            name='physical_progress',
            field=models.FloatField(default=0.0, help_text='Computed physical progress (0-100%). DO NOT EDIT DIRECTLY.', validators=[django.core.validators.MinValueValidator(0.0)]),
        ),
        migrations.AddField(
            model_name='project',
            name='progress_state',
            field=models.CharField(choices=[('CLAIMED', 'Claimed'), ('VERIFIED', 'Verified'), ('FLAGGED', 'Flagged')], default='CLAIMED', help_text='Verification state of progress values', max_length=20),
        ),
        migrations.AddField(
            model_name='project',
            name='schedule_variance',
            field=models.FloatField(default=0.0, help_text='Schedule variance percentage. Negative = behind schedule.'),
        ),
        migrations.AlterField(
            model_name='project',
            name='progress',
            field=models.FloatField(default=0.0, help_text='DEPRECATED: Use physical_progress instead. Kept for backward compatibility.'),
        ),
    ]



================================================
FILE: backend/projects/migrations/0005_add_approval_and_manager_fk.py
================================================
# Generated by Django 6.0 on 2026-01-11 07:22

import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


def migrate_manager_to_fk(apps, schema_editor):
    """
    Data migration: Attempt to link existing manager string values to User objects.
    If not found, leave manager as null (the legacy value is preserved in manager_legacy).
    """
    Project = apps.get_model('projects', 'Project')
    User = apps.get_model('users', 'User')
    
    for project in Project.objects.all():
        # Try to find a matching user by username, email, or name
        manager_str = project.manager_legacy
        if manager_str:
            manager_str = manager_str.strip()
            # Try matching by username (case-insensitive)
            user = User.objects.filter(username__iexact=manager_str).first()
            if not user:
                # Try matching by email
                user = User.objects.filter(email__iexact=manager_str).first()
            if not user:
                # Try matching by first_name + last_name
                user = User.objects.filter(first_name__iexact=manager_str).first()
            if user:
                project.manager = user
                project.save(update_fields=['manager'])


def reverse_manager_migration(apps, schema_editor):
    """Reverse data migration - nothing to do since we preserve manager_legacy."""
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('projects', '0004_project_earned_value_project_financial_progress_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        # Step 1: Add admin approval fields
        migrations.AddField(
            model_name='project',
            name='admin_approval_date',
            field=models.DateField(blank=True, help_text='Date of administrative approval', null=True),
        ),
        migrations.AddField(
            model_name='project',
            name='admin_approval_document',
            field=models.FileField(blank=True, help_text='Uploaded approval document (PDF/Image)', null=True, upload_to='projects/approvals/%Y/%m/'),
        ),
        migrations.AddField(
            model_name='project',
            name='admin_approval_reference_no',
            field=models.CharField(blank=True, help_text='Administrative approval reference number', max_length=100),
        ),
        
        # Step 2: Rename old manager CharField to manager_legacy (preserves existing data)
        migrations.RenameField(
            model_name='project',
            old_name='manager',
            new_name='manager_legacy',
        ),
        # Update the manager_legacy field definition to be nullable
        migrations.AlterField(
            model_name='project',
            name='manager_legacy',
            field=models.CharField(blank=True, help_text='Old manager field - will be migrated', max_length=255, null=True),
        ),
        
        # Step 3: Add the new manager field as a ForeignKey
        migrations.AddField(
            model_name='project',
            name='manager',
            field=models.ForeignKey(blank=True, help_text='Project Manager assigned to this project', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='managed_projects', to=settings.AUTH_USER_MODEL),
        ),
        
        # Step 4: Data migration to link existing manager strings to User objects
        migrations.RunPython(migrate_manager_to_fk, reverse_manager_migration),
        
        # Step 5: Create FundingSource model
        migrations.CreateModel(
            name='FundingSource',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('source', models.CharField(help_text='Funding source name/type', max_length=255)),
                ('amount', models.DecimalField(decimal_places=2, max_digits=15)),
                ('document', models.FileField(blank=True, help_text='Supporting document for this funding source', null=True, upload_to='projects/funding_docs/%Y/%m/')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='fundings', to='projects.project')),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
    ]



================================================
FILE: backend/projects/migrations/0006_fix_manager_schema.py
================================================
# Generated by Django 6.0 on 2026-01-11 17:40
# HOTFIX: Fix corrupted migration state on production

from django.db import migrations


def check_and_fix_schema(apps, schema_editor):
    """
    Check the current database state and fix if needed.
    This handles the case where migration 0005 was partially applied
    or applied with a different version.
    """
    from django.db import connection
    
    with connection.cursor() as cursor:
        # Check what columns exist in projects_project table
        cursor.execute("""
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name = 'projects_project'
            AND column_name IN ('manager', 'manager_id', 'manager_legacy')
        """)
        existing_columns = [row[0] for row in cursor.fetchall()]
        
        print(f"Existing columns: {existing_columns}")
        
        # Case 1: Has manager (CharField) but not manager_legacy or manager_id
        # This means migration 0005 never ran - we need to fix this
        if 'manager' in existing_columns and 'manager_legacy' not in existing_columns:
            print("Found old 'manager' CharField - renaming to manager_legacy")
            cursor.execute('ALTER TABLE projects_project RENAME COLUMN manager TO manager_legacy')
            
        # Case 2: Has manager_id but not manager_legacy
        # This means the old broken migration ran and converted manager to FK directly
        if 'manager_id' in existing_columns and 'manager_legacy' not in existing_columns:
            print("Found manager_id but no manager_legacy - adding manager_legacy column")
            cursor.execute('ALTER TABLE projects_project ADD COLUMN IF NOT EXISTS manager_legacy VARCHAR(255) NULL')
            
        # Case 3: Has neither manager nor manager_id - need to add manager FK
        if 'manager_id' not in existing_columns:
            print("No manager_id found - adding manager FK column")
            cursor.execute('ALTER TABLE projects_project ADD COLUMN IF NOT EXISTS manager_id BIGINT NULL')
            # Add foreign key constraint
            cursor.execute("""
                DO $$
                BEGIN
                    IF NOT EXISTS (
                        SELECT 1 FROM information_schema.table_constraints 
                        WHERE constraint_name = 'projects_project_manager_id_fk'
                    ) THEN
                        ALTER TABLE projects_project 
                        ADD CONSTRAINT projects_project_manager_id_fk 
                        FOREIGN KEY (manager_id) REFERENCES users_user(id) ON DELETE SET NULL;
                    END IF;
                END $$;
            """)


def reverse_schema_fix(apps, schema_editor):
    """Reverse is not supported - this is a one-way fix."""
    pass


class Migration(migrations.Migration):
    """
    Emergency schema fix for production database.
    Ensures the projects_project table has the correct columns:
    - manager_legacy (VARCHAR, nullable) - old CharField data
    - manager_id (BIGINT, nullable) - new ForeignKey to users_user
    """

    dependencies = [
        ('projects', '0005_add_approval_and_manager_fk'),
    ]

    operations = [
        migrations.RunPython(check_and_fix_schema, reverse_schema_fix),
    ]



================================================
FILE: backend/projects/migrations/0007_add_risk_management_models.py
================================================
# Generated by Django 6.0 on 2026-01-12 13:25

import django.core.validators
import django.db.models.deletion
import uuid
from decimal import Decimal
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('edms', '0002_add_notingsheet'),
        ('projects', '0006_fix_manager_schema'),
        ('scheduling', '0003_alter_scheduletask_options_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Risk',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('risk_code', models.CharField(blank=True, help_text='Auto-generated: RSK-{PROJECT_CODE}-{SEQ}', max_length=30, unique=True)),
                ('title', models.CharField(max_length=255)),
                ('description', models.TextField()),
                ('category', models.CharField(choices=[('TECHNICAL', 'Technical'), ('FINANCIAL', 'Financial'), ('CONTRACTUAL', 'Contractual'), ('ENVIRONMENTAL', 'Environmental'), ('SAFETY', 'Safety'), ('POLITICAL', 'Political'), ('LEGAL', 'Legal'), ('OPERATIONAL', 'Operational'), ('SCHEDULE', 'Schedule/Timeline'), ('RESOURCE', 'Resource/Manpower'), ('OTHER', 'Other')], default='OTHER', max_length=20)),
                ('risk_source', models.CharField(choices=[('INTERNAL', 'Internal'), ('EXTERNAL', 'External')], default='INTERNAL', max_length=10)),
                ('probability', models.IntegerField(choices=[(1, 'Very Low (Rare)'), (2, 'Low (Unlikely)'), (3, 'Medium (Possible)'), (4, 'High (Likely)'), (5, 'Very High (Almost Certain)')], default=3, help_text='Likelihood of risk occurring (1-5)')),
                ('impact', models.IntegerField(choices=[(1, 'Negligible'), (2, 'Minor'), (3, 'Moderate'), (4, 'Major'), (5, 'Critical')], default=3, help_text='Severity if risk occurs (1-5)')),
                ('risk_score', models.IntegerField(default=9, editable=False, help_text='Auto-calculated: probability Ã— impact (1-25)')),
                ('severity', models.CharField(choices=[('LOW', 'Low'), ('MEDIUM', 'Medium'), ('HIGH', 'High'), ('CRITICAL', 'Critical')], default='MEDIUM', editable=False, help_text='Auto-calculated from risk score', max_length=10)),
                ('status', models.CharField(choices=[('IDENTIFIED', 'Identified'), ('ASSESSED', 'Assessed'), ('MITIGATING', 'Mitigating'), ('MITIGATED', 'Mitigated'), ('CLOSED', 'Closed'), ('OCCURRED', 'Occurred'), ('ACCEPTED', 'Accepted')], default='IDENTIFIED', max_length=15)),
                ('identified_date', models.DateField(auto_now_add=True)),
                ('target_resolution', models.DateField(blank=True, help_text='Expected date to resolve/mitigate risk', null=True)),
                ('actual_closure', models.DateField(blank=True, help_text='Date when risk was closed', null=True)),
                ('review_date', models.DateField(blank=True, help_text='Next scheduled review date', null=True)),
                ('response_strategy', models.CharField(blank=True, choices=[('AVOID', 'Avoid'), ('MITIGATE', 'Mitigate'), ('TRANSFER', 'Transfer'), ('ACCEPT', 'Accept'), ('ESCALATE', 'Escalate')], max_length=10, null=True)),
                ('mitigation_plan', models.TextField(blank=True, help_text='Detailed plan to reduce probability/impact')),
                ('contingency_plan', models.TextField(blank=True, help_text='Actions if risk materializes')),
                ('cost_impact', models.DecimalField(decimal_places=2, default=Decimal('0.00'), help_text='Estimated financial impact in INR', max_digits=15)),
                ('schedule_impact_days', models.IntegerField(default=0, help_text='Estimated schedule delay in days')),
                ('residual_risk_score', models.IntegerField(blank=True, help_text='Risk score after mitigation applied', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_risks', to=settings.AUTH_USER_MODEL)),
                ('edms_folder', models.ForeignKey(blank=True, help_text='Auto-created folder: {Project}/Risk Management/{risk_code}', null=True, on_delete=django.db.models.deletion.SET_NULL, to='edms.folder')),
                ('owner', models.ForeignKey(blank=True, help_text='Person responsible for managing this risk', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='owned_risks', to=settings.AUTH_USER_MODEL)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='risks', to='projects.project')),
                ('schedule_task', models.ForeignKey(blank=True, help_text='Linked schedule task affected by this risk', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='risks', to='scheduling.scheduletask')),
                ('work_package', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='risks', to='projects.workpackage')),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='RiskAuditLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('action', models.CharField(choices=[('CREATED', 'Risk Created'), ('UPDATED', 'Risk Updated'), ('STATUS_CHANGED', 'Status Changed'), ('DOCUMENT_ADDED', 'Document Added'), ('MITIGATION_ADDED', 'Mitigation Action Added'), ('MITIGATION_SUBMITTED', 'Mitigation Submitted'), ('MITIGATION_APPROVED', 'Mitigation Approved'), ('MITIGATION_REJECTED', 'Mitigation Rejected'), ('OWNER_CHANGED', 'Owner Changed'), ('ASSESSMENT_UPDATED', 'Risk Assessment Updated'), ('CLOSED', 'Risk Closed')], max_length=25)),
                ('actor_name', models.CharField(blank=True, max_length=200)),
                ('actor_role', models.CharField(blank=True, max_length=50)),
                ('details', models.JSONField(default=dict, help_text='Additional action details')),
                ('previous_values', models.JSONField(blank=True, default=dict, help_text='Field values before change')),
                ('new_values', models.JSONField(blank=True, default=dict, help_text='Field values after change')),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('actor', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('risk', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='audit_logs', to='projects.risk')),
            ],
            options={
                'ordering': ['-timestamp'],
            },
        ),
        migrations.CreateModel(
            name='RiskDocument',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('document_type', models.CharField(choices=[('EVIDENCE', 'Evidence/Proof'), ('ASSESSMENT', 'Risk Assessment Report'), ('MITIGATION_PLAN', 'Mitigation Plan'), ('MITIGATION_PROOF', 'Mitigation Action Proof'), ('CLOSURE_REPORT', 'Closure Report'), ('INSURANCE', 'Insurance Claim'), ('MEETING_NOTES', 'Meeting Notes'), ('CORRESPONDENCE', 'Correspondence'), ('INCIDENT_REPORT', 'Incident Report'), ('OTHER', 'Other')], default='OTHER', max_length=20)),
                ('notes', models.TextField(blank=True, help_text='Additional context for this document')),
                ('uploaded_at', models.DateTimeField(auto_now_add=True)),
                ('document', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='risk_attachments', to='edms.document')),
                ('risk', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='risk_documents', to='projects.risk')),
                ('uploaded_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-uploaded_at'],
            },
        ),
        migrations.CreateModel(
            name='RiskMitigationAction',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('action_number', models.PositiveIntegerField(help_text='Auto-incremented per risk')),
                ('action_type', models.CharField(choices=[('PREVENTIVE', 'Preventive Action'), ('CORRECTIVE', 'Corrective Action'), ('DETECTIVE', 'Detective Control'), ('CONTINGENCY', 'Contingency Measure'), ('TRANSFER', 'Risk Transfer (Insurance/Contract)'), ('ACCEPTANCE', 'Risk Acceptance with Justification')], default='CORRECTIVE', max_length=15)),
                ('title', models.CharField(max_length=255)),
                ('description', models.TextField()),
                ('action_date', models.DateField(help_text='Date when action was taken')),
                ('target_completion', models.DateField(blank=True, help_text='Target date for action completion', null=True)),
                ('actual_completion', models.DateField(blank=True, help_text='Actual completion date', null=True)),
                ('effectiveness_rating', models.IntegerField(blank=True, help_text='1=Not Effective, 3=Moderate, 5=Highly Effective', null=True, validators=[django.core.validators.MinValueValidator(1), django.core.validators.MaxValueValidator(5)])),
                ('residual_probability', models.IntegerField(blank=True, choices=[(1, 'Very Low (Rare)'), (2, 'Low (Unlikely)'), (3, 'Medium (Possible)'), (4, 'High (Likely)'), (5, 'Very High (Almost Certain)')], help_text='Probability after this action', null=True)),
                ('residual_impact', models.IntegerField(blank=True, choices=[(1, 'Negligible'), (2, 'Minor'), (3, 'Moderate'), (4, 'Major'), (5, 'Critical')], help_text='Impact after this action', null=True)),
                ('cost_incurred', models.DecimalField(decimal_places=2, default=Decimal('0.00'), help_text='Cost incurred for this mitigation action', max_digits=15)),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('SUBMITTED', 'Submitted for Review'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected')], default='DRAFT', max_length=12)),
                ('submitted_at', models.DateTimeField(blank=True, null=True)),
                ('reviewed_at', models.DateTimeField(blank=True, null=True)),
                ('review_comments', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_mitigations', to=settings.AUTH_USER_MODEL)),
                ('reviewed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='reviewed_mitigations', to=settings.AUTH_USER_MODEL)),
                ('risk', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='mitigation_actions', to='projects.risk')),
            ],
            options={
                'ordering': ['-action_number'],
            },
        ),
        migrations.CreateModel(
            name='MitigationProofDocument',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('description', models.TextField(blank=True, help_text='Brief description of what this document proves')),
                ('uploaded_at', models.DateTimeField(auto_now_add=True)),
                ('document', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='mitigation_proofs', to='edms.document')),
                ('uploaded_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('mitigation_action', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='proof_documents', to='projects.riskmitigationaction')),
            ],
            options={
                'ordering': ['-uploaded_at'],
            },
        ),
        migrations.AddIndex(
            model_name='risk',
            index=models.Index(fields=['project', 'status'], name='projects_ri_project_1387bb_idx'),
        ),
        migrations.AddIndex(
            model_name='risk',
            index=models.Index(fields=['severity', 'status'], name='projects_ri_severit_e26530_idx'),
        ),
        migrations.AddIndex(
            model_name='risk',
            index=models.Index(fields=['owner', 'status'], name='projects_ri_owner_i_78be84_idx'),
        ),
        migrations.AddIndex(
            model_name='riskauditlog',
            index=models.Index(fields=['risk', 'action'], name='projects_ri_risk_id_0b7757_idx'),
        ),
        migrations.AddIndex(
            model_name='riskauditlog',
            index=models.Index(fields=['timestamp'], name='projects_ri_timesta_8edb9a_idx'),
        ),
        migrations.AddIndex(
            model_name='riskmitigationaction',
            index=models.Index(fields=['risk', 'status'], name='projects_ri_risk_id_b84aec_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='riskmitigationaction',
            unique_together={('risk', 'action_number')},
        ),
    ]



================================================
FILE: backend/projects/migrations/0008_add_edms_fields_to_workpackage.py
================================================
# Generated by Django 6.0 on 2026-01-23 08:17

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('edms', '0002_add_notingsheet'),
        ('masters', '0006_add_location_district'),
        ('projects', '0007_add_risk_management_models'),
    ]

    operations = [
        migrations.AddField(
            model_name='workpackage',
            name='agreement_document',
            field=models.FileField(blank=True, help_text='Temporary storage during upload, moved to EDMS after creation', null=True, upload_to='temp/package_agreements/'),
        ),
        migrations.AddField(
            model_name='workpackage',
            name='agreement_document_edms',
            field=models.ForeignKey(blank=True, help_text='EDMS document reference for agreement', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='package_agreements', to='edms.document'),
        ),
        migrations.AddField(
            model_name='workpackage',
            name='contractor_master',
            field=models.ForeignKey(blank=True, help_text='Contractor assigned to this package (new field)', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='work_packages', to='masters.contractor'),
        ),
        migrations.AddField(
            model_name='workpackage',
            name='package_folder_edms',
            field=models.ForeignKey(blank=True, help_text="EDMS folder for this package's documents", null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='work_packages', to='edms.folder'),
        ),
        migrations.AlterField(
            model_name='workpackage',
            name='agreement_no',
            field=models.CharField(blank=True, help_text='Agreement/Contract number', max_length=100, null=True),
        ),
    ]



================================================
FILE: backend/projects/migrations/0009_add_performance_indexes.py
================================================
# Generated by Django 6.0.1 on 2026-01-23 10:37

from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('masters', '0006_add_location_district'),
        ('projects', '0008_add_edms_fields_to_workpackage'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AlterField(
            model_name='project',
            name='created_at',
            field=models.DateTimeField(auto_now_add=True, db_index=True),
        ),
        migrations.AlterField(
            model_name='project',
            name='status',
            field=models.CharField(choices=[('Planning', 'Planning'), ('In Progress', 'In Progress'), ('Completed', 'Completed'), ('On Hold', 'On Hold'), ('Under Review', 'Under Review')], db_index=True, default='Planning', max_length=50),
        ),
        migrations.AddIndex(
            model_name='project',
            index=models.Index(fields=['status', 'physical_progress'], name='proj_status_progress_idx'),
        ),
        migrations.AddIndex(
            model_name='project',
            index=models.Index(fields=['start_date', 'end_date'], name='proj_date_range_idx'),
        ),
        migrations.AddIndex(
            model_name='project',
            index=models.Index(fields=['-created_at', 'status'], name='proj_created_status_idx'),
        ),
    ]



================================================
FILE: backend/projects/migrations/0009_remove_workpackage_agreement_document_edms_and_more.py
================================================
# Generated by Django 6.0 on 2026-01-27 16:20

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('projects', '0008_add_edms_fields_to_workpackage'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='workpackage',
            name='agreement_document_edms',
        ),
        migrations.RemoveField(
            model_name='workpackage',
            name='package_folder_edms',
        ),
        migrations.AlterField(
            model_name='workpackage',
            name='agreement_document',
            field=models.FileField(blank=True, help_text='Agreement document upload', null=True, upload_to='temp/package_agreements/'),
        ),
    ]



================================================
FILE: backend/projects/migrations/0010_merge_20260127_2329.py
================================================
# Generated by Django 6.0.1 on 2026-01-27 17:59

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('projects', '0009_add_performance_indexes'),
        ('projects', '0009_remove_workpackage_agreement_document_edms_and_more'),
    ]

    operations = [
    ]



================================================
FILE: backend/projects/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: backend/projects/services/__init__.py
================================================
# This file makes the services directory a Python package



================================================
FILE: backend/projects/services/progress_calculator.py
================================================
"""
Project Progress Calculator Service

This is the SINGLE SOURCE OF TRUTH for all project progress calculations.
It implements the following business rules:

1. Physical Progress: Weighted average of task progress
   - Formula: Î£(Task Progress Ã— Task Weight) / Î£(Task Weight)
   
2. Earned Value (EV): Sum of task-level earned values
   - Formula: Î£(Task Progress Ã— Budgeted Cost)
   
3. Financial Progress: EV as percentage of approved budget
   - Formula: (EV / Project Budget) Ã— 100

4. Progress State:
   - CLAIMED: Default (computed but not verified)
   - VERIFIED: Approved by authority
   - FLAGGED: Rule violation detected

5. Schedule Variance (SV):
   - Formula: ((Progress / Expected Progress) - 1) Ã— 100
   
CRITICAL: This service is the ONLY code that should update progress fields.
All updates are atomic and logged for audit trail.
"""

from decimal import Decimal
from django.db import transaction
from django.utils import timezone
import logging

logger = logging.getLogger(__name__)


class ProjectProgressCalculator:
    """
    Service class for calculating and updating project progress.
    
    Usage:
        calculator = ProjectProgressCalculator(project_id)
        result = calculator.recalculate()
    
    The recalculate() method:
    1. Fetches all tasks for the project
    2. Resolves weights for unresolved tasks
    3. Calculates computed_progress for each task
    4. Aggregates to project-level physical_progress
    5. Calculates earned_value and financial_progress
    6. Checks for flagging conditions
    7. Updates project atomically
    8. Returns detailed result for logging/debugging
    """
    
    # Configuration constants
    SCHEDULE_VARIANCE_FLAG_THRESHOLD = -20.0  # Flag if >20% behind schedule
    MAX_DAILY_PROGRESS_INCREASE = 25.0  # Anti-gaming: max % increase per day (future use)
    
    def __init__(self, project_id):
        """
        Initialize the calculator with a project ID.
        
        Args:
            project_id: Integer ID of the project to recalculate.
        """
        self.project_id = project_id
        self.project = None
        self.tasks = None
        self.result = {
            'project_id': project_id,
            'success': False,
            'physical_progress': 0.0,
            'financial_progress': 0.0,
            'earned_value': Decimal('0.00'),
            'progress_state': 'CLAIMED',
            'schedule_variance': 0.0,
            'task_count': 0,
            'resolved_weights': 0,
            'flagging_reasons': [],
            'errors': []
        }
    
    def recalculate(self):
        """
        Main entry point. Recalculates all progress values for the project.
        
        Returns:
            dict: Detailed result of the calculation including success status,
                  calculated values, and any errors or flagging reasons.
        """
        try:
            with transaction.atomic():
                # Lock the project row to prevent race conditions
                self._load_project()
                if not self.project:
                    self.result['errors'].append(f'Project {self.project_id} not found')
                    return self.result
                
                # Load and process tasks
                self._load_tasks()
                self._resolve_all_weights()
                self._calculate_all_task_progress()
                
                # Aggregate to project level
                self._calculate_physical_progress()
                self._calculate_earned_value()
                self._calculate_financial_progress()
                self._calculate_schedule_variance()
                
                # Determine progress state (flagging logic)
                self._evaluate_progress_state()
                
                # Persist changes
                self._save_project()
                self._save_tasks()
                
                self.result['success'] = True
                logger.info(
                    f"Progress recalculated for Project {self.project_id}: "
                    f"Physical={self.result['physical_progress']:.2f}%, "
                    f"Financial={self.result['financial_progress']:.2f}%, "
                    f"EV=â‚¹{self.result['earned_value']}"
                )
                
        except Exception as e:
            logger.error(f"Error recalculating progress for Project {self.project_id}: {str(e)}")
            self.result['errors'].append(str(e))
            self.result['success'] = False
        
        return self.result
    
    def _load_project(self):
        """Load project with row-level lock."""
        from projects.models import Project
        try:
            self.project = Project.objects.select_for_update().get(id=self.project_id)
        except Project.DoesNotExist:
            self.project = None
    
    def _load_tasks(self):
        """Load all tasks for the project."""
        from scheduling.models import ScheduleTask
        self.tasks = list(
            ScheduleTask.objects.filter(project_id=self.project_id)
            .select_for_update()
            .order_by('start_date', 'wbs_code')
        )
        self.result['task_count'] = len(self.tasks)
    
    def _resolve_all_weights(self):
        """Resolve weights for all tasks that need it."""
        resolved_count = 0
        for task in self.tasks:
            if task.weight is None or task.weight_source == 'UNRESOLVED':
                weight, source = task.resolve_weight()
                if weight is not None:
                    task.weight = weight
                    task.weight_source = source
                    resolved_count += 1
        self.result['resolved_weights'] = resolved_count
    
    def _calculate_all_task_progress(self):
        """Calculate computed_progress for each task."""
        for task in self.tasks:
            progress = task.calculate_progress()
            task.computed_progress = progress
    
    def _calculate_physical_progress(self):
        """
        Calculate weighted average physical progress.
        Formula: Î£(effective_progress Ã— weight) / Î£(weight)
        """
        total_weighted_progress = Decimal('0')
        total_weight = Decimal('0')
        
        for task in self.tasks:
            weight = task.weight or Decimal('0')
            if weight > 0:
                # Use effective_progress which respects the cap
                effective = Decimal(str(task.effective_progress))
                total_weighted_progress += effective * weight
                total_weight += weight
        
        if total_weight > 0:
            physical_progress = float(total_weighted_progress / total_weight)
        else:
            physical_progress = 0.0
        
        self.result['physical_progress'] = round(min(physical_progress, 100.0), 2)
    
    def _calculate_earned_value(self):
        """
        Calculate Earned Value (EV).
        Formula: Î£(task.earned_value).
        Task EV = (effective_progress / 100) Ã— budgeted_cost
        """
        total_ev = Decimal('0')
        for task in self.tasks:
            total_ev += task.earned_value
        
        self.result['earned_value'] = total_ev
    
    def _calculate_financial_progress(self):
        """
        Calculate Financial Progress.
        Formula: (EV / Project Budget) Ã— 100
        """
        if self.project.budget and self.project.budget > 0:
            financial_progress = (self.result['earned_value'] / self.project.budget) * 100
            self.result['financial_progress'] = round(min(float(financial_progress), 100.0), 2)
        else:
            self.result['financial_progress'] = 0.0
    
    def _calculate_schedule_variance(self):
        """
        Calculate Schedule Variance (SV) percentage.
        
        SV = ((Actual Progress / Expected Progress) - 1) Ã— 100
        
        Expected Progress is calculated based on time elapsed:
        Expected = (Days Elapsed / Total Project Duration) Ã— 100
        """
        today = timezone.now().date()
        
        if not self.project.start_date or not self.project.end_date:
            self.result['schedule_variance'] = 0.0
            return
        
        total_duration = (self.project.end_date - self.project.start_date).days
        if total_duration <= 0:
            self.result['schedule_variance'] = 0.0
            return
        
        days_elapsed = (today - self.project.start_date).days
        days_elapsed = max(0, min(days_elapsed, total_duration))
        
        expected_progress = (days_elapsed / total_duration) * 100
        
        if expected_progress > 0:
            actual = self.result['physical_progress']
            sv = ((actual / expected_progress) - 1) * 100
            self.result['schedule_variance'] = round(sv, 1)
        else:
            self.result['schedule_variance'] = 0.0
    
    def _evaluate_progress_state(self):
        """
        Evaluate conditions for flagging the project.
        
        FLAGGED conditions:
        1. Schedule variance exceeds threshold
        2. Any task has unresolved weight
        3. Physical progress > 100% (shouldn't happen, but safety check)
        4. Financial progress significantly ahead of physical (potential front-loading)
        """
        state = 'CLAIMED'
        reasons = []
        
        # Check schedule variance
        if self.result['schedule_variance'] < self.SCHEDULE_VARIANCE_FLAG_THRESHOLD:
            reasons.append(
                f"Schedule behind by {abs(self.result['schedule_variance']):.1f}%"
            )
        
        # Check for unresolved weights
        unresolved_tasks = [t for t in self.tasks if t.weight is None or t.weight <= 0]
        if unresolved_tasks:
            reasons.append(
                f"{len(unresolved_tasks)} task(s) have unresolved/zero weight"
            )
        
        # Check for progress anomalies
        if self.result['physical_progress'] > 100:
            reasons.append("Physical progress exceeds 100%")
        
        # Check for financial/physical mismatch (potential gaming)
        financial = self.result['financial_progress']
        physical = self.result['physical_progress']
        if physical > 0 and financial > (physical * 1.5):
            reasons.append(
                f"Financial progress ({financial:.1f}%) significantly ahead of physical ({physical:.1f}%)"
            )
        
        if reasons:
            state = 'FLAGGED'
            self.result['flagging_reasons'] = reasons
        
        self.result['progress_state'] = state
    
    def _save_project(self):
        """Save calculated values to the project."""
        self.project.physical_progress = self.result['physical_progress']
        self.project.financial_progress = self.result['financial_progress']
        self.project.earned_value = self.result['earned_value']
        self.project.progress_state = self.result['progress_state']
        self.project.schedule_variance = self.result['schedule_variance']
        
        # Also update legacy progress field for backward compatibility
        self.project.progress = self.result['physical_progress']
        
        self.project.save(update_fields=[
            'physical_progress',
            'financial_progress',
            'earned_value',
            'progress_state',
            'schedule_variance',
            'progress',
            'updated_at'
        ])
    
    def _save_tasks(self):
        """Bulk save task updates (weight and computed_progress)."""
        from scheduling.models import ScheduleTask
        
        # Use bulk_update for efficiency with large datasets
        fields_to_update = ['weight', 'weight_source', 'computed_progress']
        ScheduleTask.objects.bulk_update(
            self.tasks,
            fields_to_update,
            batch_size=100
        )


def recalculate_project_progress(project_id):
    """
    Convenience function to recalculate progress for a project.
    
    This is the function that should be called from signals or other code.
    
    Args:
        project_id: Integer ID of the project.
        
    Returns:
        dict: Result of the calculation.
    """
    calculator = ProjectProgressCalculator(project_id)
    return calculator.recalculate()


def recalculate_all_projects():
    """
    Utility function to recalculate progress for ALL projects.
    
    Use with caution - can be slow for large datasets.
    Intended for data migration or batch correction.
    """
    from projects.models import Project
    
    results = []
    project_ids = list(Project.objects.values_list('id', flat=True))
    
    for project_id in project_ids:
        result = recalculate_project_progress(project_id)
        results.append(result)
        logger.info(f"Recalculated project {project_id}: success={result['success']}")
    
    return results



================================================
FILE: backend/scheduling/__init__.py
================================================
[Empty file]


================================================
FILE: backend/scheduling/admin.py
================================================
from django.contrib import admin
from .models import ScheduleTask


@admin.register(ScheduleTask)
class ScheduleTaskAdmin(admin.ModelAdmin):
    """
    Admin configuration for ScheduleTask model.
    
    computed_progress is READ-ONLY as it's calculated by the system.
    """
    
    list_display = [
        'name',
        'project',
        'progress_method',
        'computed_progress_display',
        'weight',
        'status',
        'start_date',
        'end_date',
    ]
    
    list_filter = ['status', 'progress_method', 'is_milestone', 'project']
    
    search_fields = ['name', 'project__name', 'wbs_code']
    
    readonly_fields = [
        'id',
        'computed_progress',
        'created_at',
        'updated_at',
    ]
    
    fieldsets = [
        ('Basic Information', {
            'fields': [
                'project',
                'parent_task',
                'name',
                'description',
                'wbs_code',
            ]
        }),
        ('Schedule', {
            'fields': [
                ('start_date', 'end_date'),
            ]
        }),
        ('Progress Method & Weight', {
            'fields': [
                'progress_method',
                ('weight', 'weight_source'),
            ],
            'description': 'Define how progress is measured for this task.',
        }),
        ('Quantity-Based Progress (if method = QUANTITY)', {
            'fields': [
                ('planned_quantity', 'executed_quantity', 'uom'),
            ],
            'classes': ['collapse'],
        }),
        ('Cost-Based Progress (if method = COST)', {
            'fields': [
                ('budgeted_cost', 'actual_cost'),
            ],
            'classes': ['collapse'],
        }),
        ('Computed Progress (Read-Only)', {
            'fields': [
                'computed_progress',
                ('max_progress_without_approval', 'is_approval_granted'),
            ],
            'description': 'Progress is calculated automatically based on the method above.',
        }),
        ('Manual Progress (Restricted)', {
            'fields': [
                'manual_progress_value',
                'manual_progress_justification',
            ],
            'classes': ['collapse'],
        }),
        ('Flags', {
            'fields': [
                ('is_milestone', 'is_critical'),
                'status',
            ]
        }),
        ('Import Support', {
            'fields': [
                'external_id',
                'metadata',
            ],
            'classes': ['collapse'],
        }),
        ('Timestamps', {
            'fields': [
                ('created_at', 'updated_at'),
            ],
        }),
    ]
    
    def computed_progress_display(self, obj):
        """Formatted progress for list display."""
        return f"{obj.computed_progress:.1f}%"
    computed_progress_display.short_description = 'Progress'
    computed_progress_display.admin_order_field = 'computed_progress'



================================================
FILE: backend/scheduling/apps.py
================================================
from django.apps import AppConfig


class SchedulingConfig(AppConfig):
    name = 'scheduling'
    
    def ready(self):
        """
        Import signals when the app is ready.
        
        This ensures signal handlers are registered when Django starts.
        The import statement connects the signals defined in signals.py.
        """
        import scheduling.signals  # noqa: F401



================================================
FILE: backend/scheduling/models.py
================================================
from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator
from decimal import Decimal
import uuid


class ScheduleTask(models.Model):
    """
    Represents a Task or Milestone in the Project Schedule (WBS).
    Finance module links strictly to these for 'No Money Without Time'.
    
    Progress Tracking:
    - Progress is COMPUTED, not manually entered.
    - Calculation method is defined by `progress_method`.
    - Weight determines contribution to project-level aggregation.
    """
    
    # ========== ENUMS ==========
    class TaskStatus(models.TextChoices):
        PLANNED = 'PLANNED', 'Planned'
        IN_PROGRESS = 'IN_PROGRESS', 'In Progress'
        COMPLETED = 'COMPLETED', 'Completed'
        DELAYED = 'DELAYED', 'Delayed'
    
    class ProgressMethod(models.TextChoices):
        """
        Defines how task progress is calculated.
        - QUANTITY: Progress = executed_quantity / planned_quantity
        - MILESTONE: Progress = 0 or 100 based on milestone approval
        - COST: Progress = actual_cost / budgeted_cost
        - TIME: Progress = elapsed_days / total_duration
        - MANUAL: Restricted manual entry (requires justification)
        """
        QUANTITY = 'QUANTITY', 'Quantity-Based'
        MILESTONE = 'MILESTONE', 'Milestone-Based'
        COST = 'COST', 'Cost-Based'
        TIME = 'TIME', 'Time-Based'
        MANUAL = 'MANUAL', 'Manual (Restricted)'
    
    class WeightSource(models.TextChoices):
        """
        Tracks how the task weight was determined.
        Priority: QUANTITY > COST > MANUAL > DURATION
        """
        QUANTITY = 'QUANTITY', 'Derived from Quantity'
        COST = 'COST', 'Derived from Cost'
        MANUAL = 'MANUAL', 'Manually Assigned'
        DURATION = 'DURATION', 'Derived from Duration (Fallback)'
        UNRESOLVED = 'UNRESOLVED', 'Not Yet Resolved'

    # ========== PRIMARY KEY ==========
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # ========== RELATIONSHIPS ==========
    project = models.ForeignKey(
        'projects.Project', 
        on_delete=models.CASCADE, 
        related_name='tasks'
    )
    parent_task = models.ForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='subtasks',
        help_text='Parent task for WBS hierarchy'
    )
    
    # ========== BASIC INFO ==========
    name = models.CharField(max_length=255)
    description = models.TextField(blank=True, default='')
    wbs_code = models.CharField(
        max_length=50, 
        blank=True, 
        default='',
        help_text='Work Breakdown Structure code (e.g., 1.2.3)'
    )
    
    # ========== SCHEDULE ==========
    start_date = models.DateField()
    end_date = models.DateField()
    
    # ========== PROGRESS METHOD & WEIGHT ==========
    progress_method = models.CharField(
        max_length=20,
        choices=ProgressMethod.choices,
        default=ProgressMethod.QUANTITY,
        help_text='Method used to calculate task progress'
    )
    
    weight = models.DecimalField(
        max_digits=12,
        decimal_places=4,
        null=True,
        blank=True,
        validators=[MinValueValidator(Decimal('0'))],
        help_text='Weight for project-level aggregation. Null = unresolved.'
    )
    
    weight_source = models.CharField(
        max_length=20,
        choices=WeightSource.choices,
        default=WeightSource.UNRESOLVED,
        help_text='How the weight was determined'
    )
    
    # ========== QUANTITY-BASED PROGRESS ==========
    planned_quantity = models.DecimalField(
        max_digits=15,
        decimal_places=4,
        null=True,
        blank=True,
        validators=[MinValueValidator(Decimal('0.0001'))],
        help_text='Planned quantity for quantity-based progress'
    )
    
    executed_quantity = models.DecimalField(
        max_digits=15,
        decimal_places=4,
        default=Decimal('0'),
        validators=[MinValueValidator(Decimal('0'))],
        help_text='Actual executed quantity'
    )
    
    uom = models.CharField(
        max_length=50,
        blank=True,
        default='',
        help_text='Unit of Measurement (e.g., m3, kg, nos)'
    )
    
    # ========== COST-BASED PROGRESS & EARNED VALUE ==========
    budgeted_cost = models.DecimalField(
        max_digits=15,
        decimal_places=2,
        default=Decimal('0'),
        validators=[MinValueValidator(Decimal('0'))],
        help_text='Budgeted Cost of Work Scheduled (BCWS) for EV calculations'
    )
    
    actual_cost = models.DecimalField(
        max_digits=15,
        decimal_places=2,
        default=Decimal('0'),
        validators=[MinValueValidator(Decimal('0'))],
        help_text='Actual Cost of Work Performed (ACWP)'
    )
    
    # ========== COMPUTED PROGRESS (READ-ONLY) ==========
    computed_progress = models.FloatField(
        default=0.0,
        validators=[MinValueValidator(0.0), MaxValueValidator(100.0)],
        help_text='System-calculated progress percentage (0-100). DO NOT EDIT DIRECTLY.'
    )
    
    # ========== CAPPING & VALIDATION ==========
    max_progress_without_approval = models.FloatField(
        default=70.0,
        validators=[MinValueValidator(0.0), MaxValueValidator(100.0)],
        help_text='Progress cap until milestone/approval is complete'
    )
    
    is_approval_granted = models.BooleanField(
        default=False,
        help_text='If True, progress can exceed the cap (up to 100%)'
    )
    
    # ========== MANUAL PROGRESS (RESTRICTED) ==========
    manual_progress_value = models.FloatField(
        null=True,
        blank=True,
        validators=[MinValueValidator(0.0), MaxValueValidator(100.0)],
        help_text='Only used if progress_method is MANUAL'
    )
    
    manual_progress_justification = models.TextField(
        blank=True,
        default='',
        help_text='Required justification when using manual progress'
    )
    
    # ========== MILESTONE FLAGS ==========
    is_milestone = models.BooleanField(default=False)
    is_critical = models.BooleanField(
        default=False,
        help_text='True if this task is on the critical path'
    )
    
    # ========== IMPORT SUPPORT ==========
    external_id = models.CharField(
        max_length=255, 
        null=True, 
        blank=True, 
        help_text='UID from P6/MSP/Excel'
    )
    metadata = models.JSONField(
        default=dict, 
        blank=True, 
        help_text='Custom columns from imported files'
    )
    
    # ========== STATUS & AUDIT ==========
    status = models.CharField(
        max_length=20, 
        choices=TaskStatus.choices, 
        default=TaskStatus.PLANNED
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['start_date', 'wbs_code', 'name']
        indexes = [
            models.Index(fields=['project', 'status']),
            models.Index(fields=['project', 'is_milestone']),
        ]

    def __str__(self):
        return f"{self.name} ({self.computed_progress:.1f}%)"

    @property
    def duration_days(self):
        """Calculate task duration in days."""
        if self.start_date and self.end_date:
            return (self.end_date - self.start_date).days + 1
        return 0

    @property
    def effective_progress(self):
        """
        Returns progress capped by approval status.
        If approval is not granted, progress is capped at max_progress_without_approval.
        """
        if self.is_approval_granted:
            return self.computed_progress
        return min(self.computed_progress, self.max_progress_without_approval)

    @property
    def earned_value(self):
        """
        Earned Value (EV) = Progress% Ã— Budgeted Cost
        Uses effective_progress which respects the cap.
        """
        return Decimal(str(self.effective_progress / 100)) * self.budgeted_cost

    def calculate_progress(self):
        """
        Calculate progress based on the configured method.
        This method is called by the ProjectProgressCalculator service.
        Returns a float between 0.0 and 100.0.
        """
        if self.progress_method == self.ProgressMethod.QUANTITY:
            if self.planned_quantity and self.planned_quantity > 0:
                progress = (self.executed_quantity / self.planned_quantity) * 100
                return min(float(progress), 100.0)
            return 0.0
        
        elif self.progress_method == self.ProgressMethod.MILESTONE:
            # Milestones are binary: 0% or 100%
            return 100.0 if self.is_approval_granted else 0.0
        
        elif self.progress_method == self.ProgressMethod.COST:
            if self.budgeted_cost and self.budgeted_cost > 0:
                progress = (self.actual_cost / self.budgeted_cost) * 100
                return min(float(progress), 100.0)
            return 0.0
        
        elif self.progress_method == self.ProgressMethod.TIME:
            from django.utils import timezone
            today = timezone.now().date()
            if self.start_date and self.end_date:
                total_duration = (self.end_date - self.start_date).days
                if total_duration <= 0:
                    return 100.0 if today >= self.end_date else 0.0
                elapsed = (today - self.start_date).days
                progress = (elapsed / total_duration) * 100
                return min(max(float(progress), 0.0), 100.0)
            return 0.0
        
        elif self.progress_method == self.ProgressMethod.MANUAL:
            if self.manual_progress_value is not None:
                return float(self.manual_progress_value)
            return 0.0
        
        return 0.0

    def resolve_weight(self):
        """
        Resolve weight based on priority: QUANTITY > COST > MANUAL > DURATION.
        Returns (weight_value, weight_source) tuple.
        Called by the ProjectProgressCalculator service.
        """
        # Priority 1: Quantity-derived weight (if quantity method with valid data)
        if self.progress_method == self.ProgressMethod.QUANTITY and self.planned_quantity:
            return Decimal(str(self.planned_quantity)), self.WeightSource.QUANTITY
        
        # Priority 2: Cost-based weight
        if self.budgeted_cost and self.budgeted_cost > 0:
            return self.budgeted_cost, self.WeightSource.COST
        
        # Priority 3: Manually assigned weight
        if self.weight and self.weight_source == self.WeightSource.MANUAL:
            return self.weight, self.WeightSource.MANUAL
        
        # Priority 4: Duration-based weight (fallback)
        duration = self.duration_days
        if duration > 0:
            return Decimal(str(duration)), self.WeightSource.DURATION
        
        # Unresolved
        return None, self.WeightSource.UNRESOLVED



================================================
FILE: backend/scheduling/serializers.py
================================================
from rest_framework import serializers
from .models import ScheduleTask


class ScheduleTaskSerializer(serializers.ModelSerializer):
    """
    Serializer for ScheduleTask model.
    
    Progress is COMPUTED based on the task's progress_method.
    Users provide inputs (executed_quantity, etc.) and the system calculates progress.
    
    Read-Only Fields:
    - computed_progress: System-calculated progress
    - weight: Can be set initially, but auto-resolved if not provided
    - weight_source: How the weight was determined
    - effective_progress: Progress with capping applied
    - earned_value: EV for this task
    """
    
    # Computed properties exposed as read-only
    effective_progress = serializers.FloatField(read_only=True)
    earned_value = serializers.DecimalField(
        max_digits=15, 
        decimal_places=2, 
        read_only=True
    )
    duration_days = serializers.IntegerField(read_only=True)
    
    # Method display for UI
    progress_method_display = serializers.CharField(
        source='get_progress_method_display',
        read_only=True
    )
    weight_source_display = serializers.CharField(
        source='get_weight_source_display',
        read_only=True
    )
    status_display = serializers.CharField(
        source='get_status_display',
        read_only=True
    )
    
    class Meta:
        model = ScheduleTask
        fields = [
            'id',
            'project',
            'parent_task',
            'name',
            'description',
            'wbs_code',
            
            # Schedule
            'start_date',
            'end_date',
            'duration_days',  # Computed
            
            # Progress Method & Weight
            'progress_method',
            'progress_method_display',
            'weight',
            'weight_source',
            'weight_source_display',
            
            # Quantity-Based Progress inputs
            'planned_quantity',
            'executed_quantity',
            'uom',
            
            # Cost-Based Progress inputs
            'budgeted_cost',
            'actual_cost',
            
            # Computed Progress (READ-ONLY)
            'computed_progress',
            'effective_progress',  # With capping applied
            'earned_value',
            
            # Capping & Validation
            'max_progress_without_approval',
            'is_approval_granted',
            
            # Manual Progress (restricted)
            'manual_progress_value',
            'manual_progress_justification',
            
            # Flags
            'is_milestone',
            'is_critical',
            
            # Import Support
            'external_id',
            'metadata',
            
            # Status
            'status',
            'status_display',
            
            # Timestamps
            'created_at',
            'updated_at',
        ]
        read_only_fields = [
            'id',
            'computed_progress',
            'created_at',
            'updated_at',
        ]

    def validate(self, data):
        """Validate task data."""
        # Date validation
        if data.get('start_date') and data.get('end_date'):
            if data['start_date'] > data['end_date']:
                raise serializers.ValidationError(
                    {"end_date": "End date cannot be before start date."}
                )
        
        # Quantity validation for QUANTITY method
        progress_method = data.get('progress_method', 'QUANTITY')
        if progress_method == 'QUANTITY':
            planned = data.get('planned_quantity')
            if planned is not None and planned <= 0:
                raise serializers.ValidationError(
                    {"planned_quantity": "Planned quantity must be greater than 0 for quantity-based progress."}
                )
        
        # Manual progress justification required
        if progress_method == 'MANUAL':
            manual_value = data.get('manual_progress_value')
            justification = data.get('manual_progress_justification', '')
            if manual_value is not None and manual_value > 0 and not justification.strip():
                raise serializers.ValidationError(
                    {"manual_progress_justification": "Justification is required for manual progress entry."}
                )
        
        return data


class ScheduleTaskListSerializer(serializers.ModelSerializer):
    """
    Lightweight serializer for listing tasks.
    Used in list views for better performance.
    """
    effective_progress = serializers.FloatField(read_only=True)
    
    class Meta:
        model = ScheduleTask
        fields = [
            'id',
            'name',
            'wbs_code',
            'start_date',
            'end_date',
            'computed_progress',
            'effective_progress',
            'status',
            'is_milestone',
            'is_critical',
            'weight',
            'budgeted_cost',
        ]
        read_only_fields = ['id', 'computed_progress']



================================================
FILE: backend/scheduling/signals.py
================================================
"""
Scheduling App Signals

This module defines Django signals for the scheduling app.
The key signal triggers project progress recalculation when tasks are modified.

CRITICAL: Signal handlers use transaction.on_commit() to ensure
the recalculation runs AFTER the database transaction commits.
This prevents race conditions and ensures data consistency.
"""

from django.db import transaction
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
import logging

logger = logging.getLogger(__name__)


@receiver(post_save, sender='scheduling.ScheduleTask')
def schedule_task_saved(sender, instance, created, **kwargs):
    """
    Signal handler for ScheduleTask save events.
    
    Triggers project progress recalculation after the transaction commits.
    Uses on_commit() to prevent race conditions.
    """
    project_id = instance.project_id
    
    if project_id:
        # Schedule recalculation to run after transaction commits
        transaction.on_commit(
            lambda: _trigger_recalculation(project_id, 'save')
        )


@receiver(post_delete, sender='scheduling.ScheduleTask')
def schedule_task_deleted(sender, instance, **kwargs):
    """
    Signal handler for ScheduleTask delete events.
    
    Triggers project progress recalculation after the transaction commits.
    """
    project_id = instance.project_id
    
    if project_id:
        # Schedule recalculation to run after transaction commits
        transaction.on_commit(
            lambda: _trigger_recalculation(project_id, 'delete')
        )


def _trigger_recalculation(project_id, event_type):
    """
    Internal function to trigger the recalculation.
    
    This runs AFTER the transaction commits, ensuring all task
    changes are visible to the calculator.
    
    Args:
        project_id: ID of the project to recalculate.
        event_type: 'save' or 'delete' for logging purposes.
    """
    try:
        from projects.services.progress_calculator import recalculate_project_progress
        
        logger.debug(
            f"Triggering progress recalculation for Project {project_id} "
            f"after task {event_type}"
        )
        
        result = recalculate_project_progress(project_id)
        
        if result['success']:
            logger.debug(
                f"Progress recalculation successful for Project {project_id}: "
                f"Physical={result['physical_progress']:.1f}%"
            )
        else:
            logger.warning(
                f"Progress recalculation failed for Project {project_id}: "
                f"{result['errors']}"
            )
            
    except Exception as e:
        # Log but don't raise - we don't want to break the main operation
        logger.error(
            f"Error in progress recalculation signal for Project {project_id}: {str(e)}",
            exc_info=True
        )



================================================
FILE: backend/scheduling/tests.py
================================================
from django.test import TestCase

# Create your tests here.



================================================
FILE: backend/scheduling/urls.py
================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import ScheduleTaskViewSet

router = DefaultRouter()
router.register(r'tasks', ScheduleTaskViewSet, basename='scheduletask')

urlpatterns = [
    path('', include(router.urls)),
]



================================================
FILE: backend/scheduling/views.py
================================================
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser, FormParser
from .models import ScheduleTask
from .serializers import ScheduleTaskSerializer
from common.utils.importers import ExcelImporter, MSPImporter, P6Importer
import json
from datetime import datetime

class ScheduleTaskViewSet(viewsets.ModelViewSet):
    queryset = ScheduleTask.objects.all()
    serializer_class = ScheduleTaskSerializer
    permission_classes = [permissions.IsAuthenticated]
    parser_classes = (MultiPartParser, FormParser) # Allow file uploads
    
    def get_queryset(self):
        qs = super().get_queryset()
        project_id = self.request.query_params.get('project')
        if project_id:
            qs = qs.filter(project_id=project_id)
        return qs.order_by('start_date')

    @action(detail=False, methods=['post'])
    def analyze_file(self, request):
        """
        Step 1: Analyze file and return headers (for user mapping).
        """
        file_obj = request.FILES.get('file')
        if not file_obj:
            return Response({'error': 'No file uploaded'}, status=400)
        
        filename = file_obj.name.lower()
        headers = []
        
        try:
            if filename.endswith('.xlsx'):
                headers = ExcelImporter().read_headers(file_obj)
            elif filename.endswith('.xml'): # MSP
                headers = MSPImporter().read_headers(file_obj)
            elif filename.endswith('.xer'): # P6
                headers = P6Importer().read_headers(file_obj) # Might fail if temp file needed
            else:
                return Response({'error': 'Unsupported file format (use .xlsx, .xml, .xer)'}, status=400)
            
            return Response({'headers': headers, 'filename': file_obj.name})
        except Exception as e:
            return Response({'error': str(e)}, status=500)

    @action(detail=False, methods=['post'])
    def import_file(self, request):
        """
        Step 2: generic import using mapping.
        """
        file_obj = request.FILES.get('file')
        project_id = request.data.get('project_id')
        mapping_str = request.data.get('mapping', '{}')

        if not file_obj or not project_id:
            return Response({'error': 'File and Project ID required'}, status=400)

        try:
            mapping = json.loads(mapping_str)
        except json.JSONDecodeError:
            return Response({'error': 'Invalid mapping JSON'}, status=400)

        filename = file_obj.name.lower()
        importer = None
        
        if filename.endswith('.xlsx'):
            importer = ExcelImporter()
        elif filename.endswith('.xml'):
            importer = MSPImporter()
        elif filename.endswith('.xer'):
            importer = P6Importer()
        else:
             return Response({'error': 'Unsupported file format'}, status=400)

        try:
            # Process Rows
            created_count = 0
            updated_count = 0
            
            tasks_to_create = []
            tasks_to_update = []
            
            for row in importer.import_data(file_obj, mapping):
                # Standardize Fields based on mapping or internal schema
                # For Excel, mapping keys should match our internal codes if possible, or we handle here
                # Expected keys in 'row' (after mapping applied by importer):
                # 'name', 'start_date', 'end_date', 'progress', 'external_id'
                
                # If explicit mapping was passed (Excel), row keys are DB fields.
                # If no mapping (MSP/P6), row keys are standard Importer keys.
                
                # Normalization
                name = row.get('name') or row.get('Name') or row.get('task_name')
                ext_id = row.get('external_id') or row.get('UID') or row.get('task_code')
                start = row.get('start_date') or row.get('Start') or row.get('target_start_date')
                end = row.get('end_date') or row.get('Finish') or row.get('target_end_date')
                progress = row.get('progress') or row.get('PercentComplete') or row.get('phys_complete_pct') or 0
                
                if not name: continue
                
                # Date Parsing (Very crude, needs robustness)
                def parse_date(d_str):
                    if not d_str: return None
                    if isinstance(d_str, datetime): return d_str.date()
                    for fmt in ('%Y-%m-%d', '%d-%m-%Y', '%Y-%m-%dT%H:%M:%S'):
                         try: return datetime.strptime(str(d_str).split('T')[0], '%Y-%m-%d').date()
                         except: pass
                    return None # Fallback

                # Build task data
                task_data = {
                    'project_id': project_id,
                    'name': name,
                    'start_date': parse_date(start) or datetime.today(),
                    'end_date': parse_date(end) or datetime.today(),
                    'progress': float(progress or 0),
                    'external_id': ext_id,
                    'metadata': row # Dump all raw data into metadata
                }
                
                # Try to find existing by External ID if present
                task = None
                if ext_id:
                    task = ScheduleTask.objects.filter(project_id=project_id, external_id=ext_id).first()
                
                if task:
                    # Update existing task
                    for k, v in task_data.items():
                        setattr(task, k, v)
                    tasks_to_update.append(task)
                else:
                    # Prepare for bulk creation
                    tasks_to_create.append(ScheduleTask(**task_data))
            
            # Bulk operations
            if tasks_to_create:
                ScheduleTask.objects.bulk_create(tasks_to_create)
                created_count = len(tasks_to_create)
            
            if tasks_to_update:
                for task in tasks_to_update:
                    task.save()
                updated_count = len(tasks_to_update)

            return Response({
                'status': 'success',
                'created': created_count,
                'updated': updated_count
            })

        except Exception as e:
            return Response({'error': str(e)}, status=500)



================================================
FILE: backend/scheduling/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2025-12-24 14:11

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('projects', '0002_workpackage'),
    ]

    operations = [
        migrations.CreateModel(
            name='ScheduleTask',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=255)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField()),
                ('progress', models.FloatField(default=0.0, help_text='Physical Progress %')),
                ('is_milestone', models.BooleanField(default=False)),
                ('status', models.CharField(choices=[('PLANNED', 'Planned'), ('IN_PROGRESS', 'In Progress'), ('COMPLETED', 'Completed'), ('DELAYED', 'Delayed')], default='PLANNED', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tasks', to='projects.project')),
            ],
        ),
    ]



================================================
FILE: backend/scheduling/migrations/0002_scheduletask_external_id_scheduletask_metadata.py
================================================
# Generated by Django 6.0 on 2025-12-26 15:02

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('scheduling', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='scheduletask',
            name='external_id',
            field=models.CharField(blank=True, help_text='UID from P6/MSP/Excel', max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='metadata',
            field=models.JSONField(blank=True, default=dict, help_text='Custom columns from imported files'),
        ),
    ]



================================================
FILE: backend/scheduling/migrations/0003_alter_scheduletask_options_and_more.py
================================================
# Generated by Django 6.0 on 2026-01-10 18:53

import django.core.validators
import django.db.models.deletion
from decimal import Decimal
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('projects', '0004_project_earned_value_project_financial_progress_and_more'),
        ('scheduling', '0002_scheduletask_external_id_scheduletask_metadata'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='scheduletask',
            options={'ordering': ['start_date', 'wbs_code', 'name']},
        ),
        migrations.RemoveField(
            model_name='scheduletask',
            name='progress',
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='actual_cost',
            field=models.DecimalField(decimal_places=2, default=Decimal('0'), help_text='Actual Cost of Work Performed (ACWP)', max_digits=15, validators=[django.core.validators.MinValueValidator(Decimal('0'))]),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='budgeted_cost',
            field=models.DecimalField(decimal_places=2, default=Decimal('0'), help_text='Budgeted Cost of Work Scheduled (BCWS) for EV calculations', max_digits=15, validators=[django.core.validators.MinValueValidator(Decimal('0'))]),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='computed_progress',
            field=models.FloatField(default=0.0, help_text='System-calculated progress percentage (0-100). DO NOT EDIT DIRECTLY.', validators=[django.core.validators.MinValueValidator(0.0), django.core.validators.MaxValueValidator(100.0)]),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='description',
            field=models.TextField(blank=True, default=''),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='executed_quantity',
            field=models.DecimalField(decimal_places=4, default=Decimal('0'), help_text='Actual executed quantity', max_digits=15, validators=[django.core.validators.MinValueValidator(Decimal('0'))]),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='is_approval_granted',
            field=models.BooleanField(default=False, help_text='If True, progress can exceed the cap (up to 100%)'),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='is_critical',
            field=models.BooleanField(default=False, help_text='True if this task is on the critical path'),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='manual_progress_justification',
            field=models.TextField(blank=True, default='', help_text='Required justification when using manual progress'),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='manual_progress_value',
            field=models.FloatField(blank=True, help_text='Only used if progress_method is MANUAL', null=True, validators=[django.core.validators.MinValueValidator(0.0), django.core.validators.MaxValueValidator(100.0)]),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='max_progress_without_approval',
            field=models.FloatField(default=70.0, help_text='Progress cap until milestone/approval is complete', validators=[django.core.validators.MinValueValidator(0.0), django.core.validators.MaxValueValidator(100.0)]),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='parent_task',
            field=models.ForeignKey(blank=True, help_text='Parent task for WBS hierarchy', null=True, on_delete=django.db.models.deletion.CASCADE, related_name='subtasks', to='scheduling.scheduletask'),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='planned_quantity',
            field=models.DecimalField(blank=True, decimal_places=4, help_text='Planned quantity for quantity-based progress', max_digits=15, null=True, validators=[django.core.validators.MinValueValidator(Decimal('0.0001'))]),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='progress_method',
            field=models.CharField(choices=[('QUANTITY', 'Quantity-Based'), ('MILESTONE', 'Milestone-Based'), ('COST', 'Cost-Based'), ('TIME', 'Time-Based'), ('MANUAL', 'Manual (Restricted)')], default='QUANTITY', help_text='Method used to calculate task progress', max_length=20),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='uom',
            field=models.CharField(blank=True, default='', help_text='Unit of Measurement (e.g., m3, kg, nos)', max_length=50),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='wbs_code',
            field=models.CharField(blank=True, default='', help_text='Work Breakdown Structure code (e.g., 1.2.3)', max_length=50),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='weight',
            field=models.DecimalField(blank=True, decimal_places=4, help_text='Weight for project-level aggregation. Null = unresolved.', max_digits=12, null=True, validators=[django.core.validators.MinValueValidator(Decimal('0'))]),
        ),
        migrations.AddField(
            model_name='scheduletask',
            name='weight_source',
            field=models.CharField(choices=[('QUANTITY', 'Derived from Quantity'), ('COST', 'Derived from Cost'), ('MANUAL', 'Manually Assigned'), ('DURATION', 'Derived from Duration (Fallback)'), ('UNRESOLVED', 'Not Yet Resolved')], default='UNRESOLVED', help_text='How the weight was determined', max_length=20),
        ),
        migrations.AddIndex(
            model_name='scheduletask',
            index=models.Index(fields=['project', 'status'], name='scheduling__project_f5d919_idx'),
        ),
        migrations.AddIndex(
            model_name='scheduletask',
            index=models.Index(fields=['project', 'is_milestone'], name='scheduling__project_8db4ab_idx'),
        ),
    ]



================================================
FILE: backend/scheduling/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: backend/search/__init__.py
================================================
# Search App - Django app for unified global search



================================================
FILE: backend/search/apps.py
================================================
from django.apps import AppConfig


class SearchConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'search'
    verbose_name = 'Global Search'



================================================
FILE: backend/search/urls.py
================================================
from django.urls import path
from . import views

app_name = 'search'

urlpatterns = [
    path('', views.global_search, name='global_search'),
]



================================================
FILE: backend/search/views.py
================================================
"""
Global Search API Views

Provides a unified search endpoint that searches across multiple entities:
- Projects
- Documents (EDMS)
- Users
- Communications (threads/messages)
- Tasks/Schedules
- Contractors

Features:
- User-scoped data access (only returns data user can access)
- Fuzzy search with trigram similarity (when available)
- Result ranking and scoring
- Pagination support
"""

from django.db.models import Q, Value, CharField, F
from django.db.models.functions import Concat, Lower
from django.contrib.auth import get_user_model
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework import status
import re

# Import models from other apps
try:
    from projects.models import Project
except ImportError:
    Project = None

try:
    from edms.models import File as EDMSFile, Folder
except ImportError:
    EDMSFile = None
    Folder = None

try:
    from communications.models import Thread, Message
except ImportError:
    Thread = None
    Message = None

try:
    from scheduling.models import Task
except ImportError:
    Task = None

try:
    from masters.models import Contractor
except ImportError:
    Contractor = None

# Additional model imports for comprehensive search
try:
    from projects.models import Risk
except ImportError:
    Risk = None

try:
    from finance.models import BOQItem, RABill, Fund
except ImportError:
    BOQItem = None
    RABill = None
    Fund = None

try:
    from procurement.models import Package as ProcurementPackage
except ImportError:
    ProcurementPackage = None

User = get_user_model()


def normalize_query(query):
    """
    Normalize search query for better matching.
    - Lowercase
    - Remove extra whitespace
    - Handle common typos
    """
    if not query:
        return ''
    
    query = query.lower().strip()
    query = re.sub(r'\s+', ' ', query)  # Collapse whitespace
    
    return query


def calculate_relevance_score(text, query, field_weight=1.0):
    """
    Calculate a relevance score for a match.
    Higher score = better match.
    """
    if not text or not query:
        return 0
    
    text = text.lower()
    query = query.lower()
    
    # Exact match
    if text == query:
        return 100 * field_weight
    
    # Starts with query
    if text.startswith(query):
        return 90 * field_weight
    
    # Contains query
    if query in text:
        return 70 * field_weight
    
    # Word boundary match
    words = text.split()
    for word in words:
        if word.startswith(query):
            return 60 * field_weight
    
    return 0


def fuzzy_match(text, query, threshold=0.6):
    """
    Simple fuzzy matching using character-level comparison.
    Returns True if similarity is above threshold.
    """
    if not text or not query:
        return False
    
    text = text.lower()
    query = query.lower()
    
    # Direct match
    if query in text:
        return True
    
    # Character sequence matching (like trigram)
    if len(query) >= 3:
        matches = 0
        text_index = 0
        for char in query:
            while text_index < len(text):
                if text[text_index] == char:
                    matches += 1
                    text_index += 1
                    break
                text_index += 1
        
        similarity = matches / len(query)
        return similarity >= threshold
    
    return False


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def global_search(request):
    """
    Global search endpoint.
    
    Query Parameters:
    - q: Search query (required, min 2 characters)
    - category: Filter by category (optional: 'projects', 'documents', 'users', 'communications', 'tasks')
    - limit: Maximum results per category (default: 10)
    
    Returns:
    {
        "results": [
            {
                "id": "...",
                "type": "project|document|user|...",
                "title": "...",
                "description": "...",
                "url": "/path/to/resource",
                "score": 85,
                "status": "active|pending|...",
                "breadcrumb": ["Parent", "Child"],
                "created_at": "2024-01-01T00:00:00Z"
            }
        ],
        "total": 42,
        "query": "search term"
    }
    """
    query = request.query_params.get('q', '').strip()
    category = request.query_params.get('category', 'all')
    limit = min(int(request.query_params.get('limit', 10)), 50)
    
    if not query or len(query) < 2:
        return Response({
            'results': [],
            'total': 0,
            'query': query,
            'error': 'Query must be at least 2 characters'
        })
    
    normalized_query = normalize_query(query)
    user = request.user
    results = []
    
    # Search Projects
    if category in ['all', 'projects'] and Project:
        project_results = search_projects(normalized_query, user, limit)
        results.extend(project_results)
    
    # Search Documents (EDMS)
    if category in ['all', 'documents'] and EDMSFile:
        document_results = search_documents(normalized_query, user, limit)
        results.extend(document_results)
    
    # Search Users
    if category in ['all', 'users']:
        user_results = search_users(normalized_query, user, limit)
        results.extend(user_results)
    
    # Search Communications
    if category in ['all', 'communications'] and Thread:
        comm_results = search_communications(normalized_query, user, limit)
        results.extend(comm_results)
    
    # Search Tasks/Schedules
    if category in ['all', 'tasks'] and Task:
        task_results = search_tasks(normalized_query, user, limit)
        results.extend(task_results)
    
    # Search Contractors
    if category in ['all', 'contractors'] and Contractor:
        contractor_results = search_contractors(normalized_query, user, limit)
        results.extend(contractor_results)
    
    # Search Risks
    if category in ['all', 'risks'] and Risk:
        risk_results = search_risks(normalized_query, user, limit)
        results.extend(risk_results)
    
    # Search BOQ Items
    if category in ['all', 'boq'] and BOQItem:
        boq_results = search_boq(normalized_query, user, limit)
        results.extend(boq_results)
    
    # Search RA Bills (Billing)
    if category in ['all', 'billing'] and RABill:
        billing_results = search_billing(normalized_query, user, limit)
        results.extend(billing_results)
    
    # Search Funds
    if category in ['all', 'funds'] and Fund:
        fund_results = search_funds(normalized_query, user, limit)
        results.extend(fund_results)
    
    # Search Procurement Packages
    if category in ['all', 'procurement'] and ProcurementPackage:
        procurement_results = search_procurement(normalized_query, user, limit)
        results.extend(procurement_results)
    
    # Sort by relevance score
    results.sort(key=lambda x: x.get('score', 0), reverse=True)
    
    # Limit total results
    results = results[:limit * 3]  # Allow more overflow for additional categories
    
    return Response({
        'results': results,
        'total': len(results),
        'query': query
    })


def search_projects(query, user, limit):
    """Search projects the user has access to."""
    results = []
    
    try:
        # Build query - filter by user's accessible projects
        # For now, using a simple approach - can be enhanced with role-based access
        queryset = Project.objects.filter(
            Q(name__icontains=query) |
            Q(description__icontains=query) |
            Q(code__icontains=query)
        )
        
        # Apply user-based filtering if project has user assignment
        if hasattr(Project, 'assigned_users'):
            queryset = queryset.filter(
                Q(assigned_users=user) | Q(created_by=user)
            ).distinct()
        elif hasattr(Project, 'created_by'):
            # If no user assignment, just show all (can be role-based later)
            pass
        
        for project in queryset[:limit]:
            score = max(
                calculate_relevance_score(project.name, query, 1.0),
                calculate_relevance_score(getattr(project, 'description', ''), query, 0.7),
                calculate_relevance_score(getattr(project, 'code', ''), query, 0.9)
            )
            
            results.append({
                'id': str(project.id),
                'type': 'project',
                'title': project.name,
                'description': getattr(project, 'description', '')[:100] if hasattr(project, 'description') else '',
                'url': f'/projects/{project.id}',
                'path': f'/projects/{project.id}',
                'score': score,
                'status': getattr(project, 'status', None),
                'created_at': getattr(project, 'created_at', None),
            })
    except Exception as e:
        print(f"Error searching projects: {e}")
    
    return results


def search_documents(query, user, limit):
    """Search documents/files the user has access to."""
    results = []
    
    try:
        queryset = EDMSFile.objects.filter(
            Q(title__icontains=query) |
            Q(description__icontains=query)
        )
        
        # Filter by user access if file has permissions
        if hasattr(EDMSFile, 'uploaded_by'):
            # For now, show files uploaded by user or public files
            # This can be enhanced with folder-based permissions
            pass
        
        for doc in queryset[:limit]:
            score = max(
                calculate_relevance_score(doc.title, query, 1.0),
                calculate_relevance_score(getattr(doc, 'description', ''), query, 0.6)
            )
            
            # Build breadcrumb from folder hierarchy
            breadcrumb = []
            if hasattr(doc, 'folder') and doc.folder:
                folder = doc.folder
                while folder:
                    breadcrumb.insert(0, folder.name)
                    folder = getattr(folder, 'parent', None)
            
            results.append({
                'id': str(doc.id),
                'type': 'document',
                'title': doc.title,
                'description': getattr(doc, 'description', '')[:100] if hasattr(doc, 'description') else '',
                'url': f'/edms/view/{doc.id}',
                'path': f'/edms/view/{doc.id}',
                'score': score,
                'breadcrumb': breadcrumb[:3] if breadcrumb else None,
                'created_at': getattr(doc, 'created_at', None),
                'author': str(doc.uploaded_by) if hasattr(doc, 'uploaded_by') and doc.uploaded_by else None,
            })
    except Exception as e:
        print(f"Error searching documents: {e}")
    
    return results


def search_users(query, user, limit):
    """Search users (public directory)."""
    results = []
    
    try:
        queryset = User.objects.filter(
            Q(username__icontains=query) |
            Q(first_name__icontains=query) |
            Q(last_name__icontains=query) |
            Q(email__icontains=query)
        ).filter(is_active=True)
        
        for u in queryset[:limit]:
            full_name = f"{u.first_name} {u.last_name}".strip() or u.username
            score = max(
                calculate_relevance_score(full_name, query, 1.0),
                calculate_relevance_score(u.username, query, 0.9),
                calculate_relevance_score(u.email, query, 0.7)
            )
            
            results.append({
                'id': str(u.id),
                'type': 'user',
                'title': full_name,
                'description': u.email,
                'url': f'/users?id={u.id}',
                'path': f'/users?id={u.id}',
                'score': score,
                'status': 'active' if u.is_active else 'inactive',
            })
    except Exception as e:
        print(f"Error searching users: {e}")
    
    return results


def search_communications(query, user, limit):
    """Search threads/messages the user is a participant of."""
    results = []
    
    try:
        # Only search threads where user is a participant
        thread_queryset = Thread.objects.filter(
            Q(title__icontains=query) | Q(subject__icontains=query)
        )
        
        # Filter by participant
        if hasattr(Thread, 'participants'):
            thread_queryset = thread_queryset.filter(participants=user)
        elif hasattr(Thread, 'created_by'):
            thread_queryset = thread_queryset.filter(
                Q(created_by=user) | Q(messages__sender=user)
            ).distinct()
        
        for thread in thread_queryset[:limit]:
            title = getattr(thread, 'title', None) or getattr(thread, 'subject', 'Message Thread')
            score = calculate_relevance_score(title, query, 1.0)
            
            results.append({
                'id': str(thread.id),
                'type': 'message',
                'title': title,
                'description': 'Message thread',
                'url': f'/communications/{thread.id}',
                'path': f'/communications/{thread.id}',
                'score': score,
                'created_at': getattr(thread, 'created_at', None),
            })
        
        # Also search messages within user's threads
        if hasattr(Thread, 'message_set') or Message:
            message_queryset = Message.objects.filter(
                content__icontains=query
            )
            
            # Filter by user's threads
            if hasattr(Message, 'thread'):
                if hasattr(Thread, 'participants'):
                    message_queryset = message_queryset.filter(thread__participants=user)
                else:
                    message_queryset = message_queryset.filter(
                        Q(sender=user) | Q(thread__created_by=user)
                    )
            
            for msg in message_queryset[:limit // 2]:  # Limit messages to half
                preview = msg.content[:80] + '...' if len(msg.content) > 80 else msg.content
                score = calculate_relevance_score(msg.content, query, 0.8)
                
                thread_id = msg.thread.id if hasattr(msg, 'thread') and msg.thread else None
                
                results.append({
                    'id': str(msg.id),
                    'type': 'message',
                    'title': f"Message from {msg.sender}" if hasattr(msg, 'sender') else 'Message',
                    'description': preview,
                    'url': f'/communications/{thread_id}' if thread_id else '/communications',
                    'path': f'/communications/{thread_id}' if thread_id else '/communications',
                    'score': score,
                    'created_at': getattr(msg, 'created_at', None),
                })
    except Exception as e:
        print(f"Error searching communications: {e}")
    
    return results


def search_tasks(query, user, limit):
    """Search tasks/schedules from user's projects."""
    results = []
    
    try:
        queryset = Task.objects.filter(
            Q(name__icontains=query) |
            Q(title__icontains=query) |
            Q(description__icontains=query)
        )
        
        # Filter by user's projects
        if hasattr(Task, 'project'):
            if hasattr(Project, 'assigned_users'):
                queryset = queryset.filter(
                    Q(project__assigned_users=user) | Q(assigned_to=user)
                ).distinct()
            elif hasattr(Task, 'assigned_to'):
                queryset = queryset.filter(assigned_to=user)
        
        for task in queryset[:limit]:
            title = getattr(task, 'name', None) or getattr(task, 'title', 'Task')
            score = max(
                calculate_relevance_score(title, query, 1.0),
                calculate_relevance_score(getattr(task, 'description', ''), query, 0.6)
            )
            
            project_name = None
            if hasattr(task, 'project') and task.project:
                project_name = task.project.name
            
            results.append({
                'id': str(task.id),
                'type': 'task',
                'title': title,
                'description': getattr(task, 'description', '')[:100] if hasattr(task, 'description') else '',
                'url': '/scheduling',
                'path': '/scheduling',
                'score': score,
                'status': getattr(task, 'status', None),
                'breadcrumb': [project_name] if project_name else None,
                'created_at': getattr(task, 'created_at', None),
            })
    except Exception as e:
        print(f"Error searching tasks: {e}")
    
    return results


def search_contractors(query, user, limit):
    """Search contractors."""
    results = []
    
    try:
        queryset = Contractor.objects.filter(
            Q(name__icontains=query) |
            Q(company_name__icontains=query) |
            Q(contact_person__icontains=query) |
            Q(email__icontains=query)
        )
        
        for contractor in queryset[:limit]:
            name = getattr(contractor, 'company_name', None) or getattr(contractor, 'name', 'Contractor')
            score = max(
                calculate_relevance_score(name, query, 1.0),
                calculate_relevance_score(getattr(contractor, 'contact_person', ''), query, 0.8)
            )
            
            results.append({
                'id': str(contractor.id),
                'type': 'contractor',
                'title': name,
                'description': getattr(contractor, 'contact_person', '') or getattr(contractor, 'email', ''),
                'url': '/admin/master-data?tab=contractors',
                'path': '/admin/master-data?tab=contractors',
                'score': score,
                'status': getattr(contractor, 'status', None),
            })
    except Exception as e:
        print(f"Error searching contractors: {e}")
    
    return results


def search_risks(query, user, limit):
    """Search project risks."""
    results = []
    
    try:
        queryset = Risk.objects.filter(
            Q(title__icontains=query) |
            Q(description__icontains=query) |
            Q(category__icontains=query)
        )
        
        for risk in queryset[:limit]:
            score = max(
                calculate_relevance_score(risk.title, query, 1.0),
                calculate_relevance_score(getattr(risk, 'description', ''), query, 0.6)
            )
            
            project_name = None
            if hasattr(risk, 'project') and risk.project:
                project_name = risk.project.name
            
            results.append({
                'id': str(risk.id),
                'type': 'risk',
                'title': risk.title,
                'description': getattr(risk, 'description', '')[:100] if hasattr(risk, 'description') else '',
                'url': '/risk',
                'path': '/risk',
                'score': score,
                'status': getattr(risk, 'status', None),
                'breadcrumb': [project_name] if project_name else None,
            })
    except Exception as e:
        print(f"Error searching risks: {e}")
    
    return results


def search_boq(query, user, limit):
    """Search BOQ items."""
    results = []
    
    try:
        queryset = BOQItem.objects.filter(
            Q(description__icontains=query) |
            Q(item_code__icontains=query) |
            Q(unit__icontains=query)
        )
        
        for item in queryset[:limit]:
            title = getattr(item, 'item_code', '') or 'BOQ Item'
            score = max(
                calculate_relevance_score(getattr(item, 'description', ''), query, 1.0),
                calculate_relevance_score(title, query, 0.9)
            )
            
            project_name = None
            if hasattr(item, 'project') and item.project:
                project_name = item.project.name
            
            results.append({
                'id': str(item.id),
                'type': 'boq',
                'title': f"{title}: {getattr(item, 'description', '')[:50]}",
                'description': f"Qty: {getattr(item, 'quantity', 0)} {getattr(item, 'unit', '')}",
                'url': '/cost/boq',
                'path': '/cost/boq',
                'score': score,
                'breadcrumb': [project_name] if project_name else None,
            })
    except Exception as e:
        print(f"Error searching BOQ: {e}")
    
    return results


def search_billing(query, user, limit):
    """Search RA Bills."""
    results = []
    
    try:
        queryset = RABill.objects.filter(
            Q(bill_number__icontains=query) |
            Q(description__icontains=query) |
            Q(remarks__icontains=query)
        )
        
        for bill in queryset[:limit]:
            title = getattr(bill, 'bill_number', '') or 'RA Bill'
            score = max(
                calculate_relevance_score(title, query, 1.0),
                calculate_relevance_score(getattr(bill, 'description', ''), query, 0.7)
            )
            
            project_name = None
            if hasattr(bill, 'project') and bill.project:
                project_name = bill.project.name
            
            results.append({
                'id': str(bill.id),
                'type': 'billing',
                'title': f"RA Bill: {title}",
                'description': getattr(bill, 'description', '')[:80] if hasattr(bill, 'description') else '',
                'url': '/cost/billing',
                'path': '/cost/billing',
                'score': score,
                'status': getattr(bill, 'status', None),
                'breadcrumb': [project_name] if project_name else None,
            })
    except Exception as e:
        print(f"Error searching billing: {e}")
    
    return results


def search_funds(query, user, limit):
    """Search fund records."""
    results = []
    
    try:
        queryset = Fund.objects.filter(
            Q(name__icontains=query) |
            Q(description__icontains=query) |
            Q(fund_type__icontains=query)
        )
        
        for fund in queryset[:limit]:
            title = getattr(fund, 'name', '') or 'Fund'
            score = max(
                calculate_relevance_score(title, query, 1.0),
                calculate_relevance_score(getattr(fund, 'description', ''), query, 0.6)
            )
            
            project_name = None
            if hasattr(fund, 'project') and fund.project:
                project_name = fund.project.name
            
            results.append({
                'id': str(fund.id),
                'type': 'fund',
                'title': title,
                'description': getattr(fund, 'description', '')[:80] if hasattr(fund, 'description') else '',
                'url': '/cost/funds',
                'path': '/cost/funds',
                'score': score,
                'status': getattr(fund, 'status', None),
                'breadcrumb': [project_name] if project_name else None,
            })
    except Exception as e:
        print(f"Error searching funds: {e}")
    
    return results


def search_procurement(query, user, limit):
    """Search procurement packages."""
    results = []
    
    try:
        queryset = ProcurementPackage.objects.filter(
            Q(name__icontains=query) |
            Q(description__icontains=query) |
            Q(package_number__icontains=query)
        )
        
        for pkg in queryset[:limit]:
            title = getattr(pkg, 'name', '') or getattr(pkg, 'package_number', 'Package')
            score = max(
                calculate_relevance_score(title, query, 1.0),
                calculate_relevance_score(getattr(pkg, 'description', ''), query, 0.6)
            )
            
            project_name = None
            if hasattr(pkg, 'project') and pkg.project:
                project_name = pkg.project.name
            
            results.append({
                'id': str(pkg.id),
                'type': 'procurement',
                'title': title,
                'description': getattr(pkg, 'description', '')[:80] if hasattr(pkg, 'description') else '',
                'url': '/e-procurement',
                'path': '/e-procurement',
                'score': score,
                'status': getattr(pkg, 'status', None),
                'breadcrumb': [project_name] if project_name else None,
            })
    except Exception as e:
        print(f"Error searching procurement: {e}")
    
    return results




================================================
FILE: backend/users/__init__.py
================================================
[Empty file]


================================================
FILE: backend/users/admin.py
================================================
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import User

@admin.register(User)
class CustomUserAdmin(UserAdmin):
    list_display = ('username', 'email', 'role', 'account_status', 'company_name', 'department', 'is_active')
    list_filter = ('role', 'account_status', 'is_staff', 'is_active')
    search_fields = ('username', 'email', 'first_name', 'last_name', 'company_name', 'pan_number')
    ordering = ('-date_joined',)
    
    fieldsets = UserAdmin.fieldsets + (
        ('Role & Status', {
            'fields': ('role', 'account_status', 'department', 'designation', 'phone_number')
        }),
        ('Contractor Information', {
            'fields': ('contractor_id', 'company_name', 'pan_number', 'gstin_number', 'eproc_number'),
            'classes': ('collapse',)
        }),
        ('Address', {
            'fields': ('building_number', 'street', 'area', 'city', 'state', 'country', 'zip_code'),
            'classes': ('collapse',)
        }),
        ('Bank Details', {
            'fields': ('bank_name', 'bank_branch', 'ifsc_code', 'account_number', 'account_type'),
            'classes': ('collapse',)
        }),
        ('Invite/Approval', {
            'fields': ('invite_token', 'invite_expires_at', 'approved_by', 'approved_at', 'rejection_reason'),
            'classes': ('collapse',)
        }),
    )
    
    readonly_fields = ('invite_token', 'invite_expires_at', 'approved_at')
    
    # Add filters for quick actions
    actions = ['approve_users', 'reject_users', 'activate_users', 'deactivate_users']
    
    def approve_users(self, request, queryset):
        from django.utils import timezone
        updated = queryset.filter(account_status='PENDING_APPROVAL').update(
            account_status='ACTIVE',
            is_active=True,
            approved_by=request.user,
            approved_at=timezone.now()
        )
        self.message_user(request, f'{updated} users approved.')
    approve_users.short_description = 'Approve selected pending users'
    
    def reject_users(self, request, queryset):
        updated = queryset.filter(account_status='PENDING_APPROVAL').update(
            account_status='DISABLED',
            is_active=False
        )
        self.message_user(request, f'{updated} users rejected.')
    reject_users.short_description = 'Reject selected pending users'
    
    def activate_users(self, request, queryset):
        updated = queryset.update(is_active=True, account_status='ACTIVE')
        self.message_user(request, f'{updated} users activated.')
    activate_users.short_description = 'Activate selected users'
    
    def deactivate_users(self, request, queryset):
        updated = queryset.update(is_active=False, account_status='DISABLED')
        self.message_user(request, f'{updated} users deactivated.')
    deactivate_users.short_description = 'Deactivate selected users'



================================================
FILE: backend/users/apps.py
================================================
from django.apps import AppConfig


class UsersConfig(AppConfig):
    name = 'users'



================================================
FILE: backend/users/auth.py
================================================
from rest_framework_simplejwt.views import TokenObtainPairView
from rest_framework_simplejwt.serializers import TokenObtainPairSerializer
from rest_framework import serializers
from django.contrib.auth import get_user_model

User = get_user_model()


class CustomTokenObtainPairSerializer(TokenObtainPairSerializer):
    """
    Custom JWT serializer that provides clear error messages for inactive users
    and invalid credentials.
    """
    
    def validate(self, attrs):
        # Get the user first to check their status
        username = attrs.get('username', '')
        
        try:
            user = User.objects.get(username=username)
            
            # Check if user is inactive
            if not user.is_active:
                raise serializers.ValidationError({
                    'detail': 'Your account has been deactivated. Please contact your supervisor or administrator.',
                    'code': 'account_deactivated'
                })
            
            # Check account status
            if hasattr(user, 'account_status') and user.account_status == 'DISABLED':
                raise serializers.ValidationError({
                    'detail': 'Your account has been disabled. Please contact your supervisor or administrator.',
                    'code': 'account_disabled'
                })
            
            # Check if account is pending approval
            if hasattr(user, 'account_status') and user.account_status == 'PENDING':
                raise serializers.ValidationError({
                    'detail': 'Your account is pending approval. Please wait for administrator approval.',
                    'code': 'account_pending'
                })
                
        except User.DoesNotExist:
            # User doesn't exist - will be caught by parent validation
            pass
        
        # Call parent validation (handles password check)
        try:
            data = super().validate(attrs)
            return data
        except Exception as e:
            # Catch ANY authentication error and provide clear message
            error_message = str(e)
            
            # Replace default error messages with user-friendly ones
            if 'No active account' in error_message or 'Unable to log in' in error_message or 'given credentials' in error_message:
                raise serializers.ValidationError({
                    'detail': 'Invalid credentials. Please check your username and password.',
                    'code': 'invalid_credentials'
                })
            
            # Re-raise other errors as-is
            raise


class CustomTokenObtainPairView(TokenObtainPairView):
    """
    Custom token view with enhanced error messages for inactive accounts.
    """
    serializer_class = CustomTokenObtainPairSerializer



================================================
FILE: backend/users/email_service.py
================================================
"""
Enhanced Email Service with HTML Templates
Uses Gmail SMTP for sending professional-looking emails
"""
from django.conf import settings
from django.core.mail import EmailMultiAlternatives
from django.template.loader import render_to_string


def send_invite_email(user, invite_url):
    """Send invite email to internal user with HTML template."""
    subject = 'You have been invited to PMIS - Zaheerabad Industrial Area'
    
    # Plain text version
    text_content = f"""
Dear {user.first_name} {user.last_name},

You have been invited to join the Programme Management Information System (PMIS) 
for Zaheerabad Industrial Area.

Your Role: {user.get_role_display()}
Department: {user.department or 'N/A'}
Username: {user.username}

Please click the link below to set your password and activate your account:
{invite_url}

This link will expire in 24 hours.

If you did not expect this invitation, please ignore this email.

Best regards,
PMIS Administration
Zaheerabad Industrial Area
    """
    
    # HTML version
    html_content = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMIS Invitation</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6;">
    <table role="presentation" style="width: 100%; border-collapse: collapse;">
        <tr>
            <td align="center" style="padding: 40px 0;">
                <table role="presentation" style="width: 600px; max-width: 100%; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <!-- Header -->
                    <tr>
                        <td style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 32px; text-align: center; border-radius: 12px 12px 0 0;">
                            <h1 style="margin: 0; color: #ffffff; font-size: 24px; font-weight: 600;">PMIS Invitation</h1>
                            <p style="margin: 8px 0 0 0; color: #e0e7ff; font-size: 14px;">Zaheerabad Industrial Area</p>
                        </td>
                    </tr>
                    
                    <!-- Content -->
                    <tr>
                        <td style="padding: 32px;">
                            <p style="margin: 0 0 16px 0; color: #374151; font-size: 16px; line-height: 1.5;">
                                Dear <strong>{user.first_name} {user.last_name}</strong>,
                            </p>
                            
                            <p style="margin: 0 0 24px 0; color: #374151; font-size: 16px; line-height: 1.5;">
                                You have been invited to join the <strong>Programme Management Information System (PMIS)</strong> for Zaheerabad Industrial Area.
                            </p>
                            
                            <table role="presentation" style="width: 100%; background-color: #f3f4f6; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                                <tr>
                                    <td style="padding: 4px 0;">
                                        <strong style="color: #1f2937;">Your Role:</strong>
                                        <span style="color: #374151;">{user.get_role_display()}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0;">
                                        <strong style="color: #1f2937;">Department:</strong>
                                        <span style="color: #374151;">{user.department or 'N/A'}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0;">
                                        <strong style="color: #1f2937;">Username:</strong>
                                        <span style="color: #374151;">{user.username}</span>
                                    </td>
                                </tr>
                            </table>
                            
                            <p style="margin: 0 0 24px 0; color: #374151; font-size: 16px; line-height: 1.5;">
                                Please click the button below to set your password and activate your account:
                            </p>
                            
                            <table role="presentation" style="width: 100%;">
                                <tr>
                                    <td align="center">
                                        <a href="{invite_url}" style="display: inline-block; padding: 14px 32px; background-color: #3b82f6; color: #ffffff; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                                            Activate My Account
                                        </a>
                                    </td>
                                </tr>
                            </table>
                            
                            <p style="margin: 24px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.5;">
                                This link will expire in <strong>24 hours</strong>.
                            </p>
                            
                            <p style="margin: 16px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.5;">
                                If you did not expect this invitation, please ignore this email.
                            </p>
                        </td>
                    </tr>
                    
                    <!-- Footer -->
                    <tr>
                        <td style="padding: 24px 32px; background-color: #f9fafb; border-top: 1px solid #e5e7eb; border-radius: 0 0 12px 12px;">
                            <p style="margin: 0; color: #6b7280; font-size: 14px; text-align: center;">
                                <strong>PMIS Administration</strong><br>
                                Zaheerabad Industrial Area<br>
                                This is an automated message, please do not reply.
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
    """
    
    try:
        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[user.email]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()
        print(f"[EMAIL] Invite sent to {user.email}")
        return True
    except Exception as e:
        print(f"[EMAIL ERROR] Failed to send invite to {user.email}: {e}")
        raise


def send_welcome_email(user):
    """Send welcome email after account activation."""
    subject = 'Welcome to PMIS - Account Activated'
    
    login_url = f"{getattr(settings, 'FRONTEND_URL', 'http://localhost:3000')}/login"
    
    text_content = f"""
Dear {user.first_name} {user.last_name},

Welcome to PMIS! Your account has been successfully activated.

Your Account Details:
- Username: {user.username}
- Email: {user.email}
- Role: {user.get_role_display()}

You can now login to the system using your username or email and the password you just set.

Login URL: {login_url}

If you have any questions or need assistance, please contact the PMIS administration team.

Best regards,
PMIS Administration
Zaheerabad Industrial Area
    """
    
    html_content = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f3f4f6;">
    <table role="presentation" style="width: 100%; border-collapse: collapse;">
        <tr>
            <td align="center" style="padding: 40px 0;">
                <table role="presentation" style="width: 600px; max-width: 100%; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <tr>
                        <td style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 32px; text-align: center; border-radius: 12px 12px 0 0;">
                            <h1 style="margin: 0; color: #ffffff; font-size: 24px; font-weight: 600;">Welcome to PMIS!</h1>
                            <p style="margin: 8px 0 0 0; color: #d1fae5; font-size: 14px;">Your account is now active</p>
                        </td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 32px;">
                            <p style="margin: 0 0 16px 0; color: #374151; font-size: 16px;">
                                Dear <strong>{user.first_name} {user.last_name}</strong>,
                            </p>
                            
                            <p style="margin: 0 0 24px 0; color: #374151; font-size: 16px; line-height: 1.6;">
                                Welcome to the Programme Management Information System (PMIS)! Your account has been successfully activated.
                            </p>
                            
                            <table role="presentation" style="width: 100%; background-color: #f3f4f6; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                                <tr><td style="padding: 4px 0;"><strong>Username:</strong> {user.username}</td></tr>
                                <tr><td style="padding: 4px 0;"><strong>Email:</strong> {user.email}</td></tr>
                                <tr><td style="padding: 4px 0;"><strong>Role:</strong> {user.get_role_display()}</td></tr>
                            </table>
                            
                            <p style="margin: 0 0 24px 0; color: #374151; font-size: 16px;">
                                You can now login to the system using your username or email and the password you set.
                            </p>
                            
                            <table role="presentation" style="width: 100%;">
                                <tr>
                                    <td align="center">
                                        <a href="{login_url}" style="display: inline-block; padding: 14px 32px; background-color: #10b981; color: #ffffff; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                                            Login to PM IS
                                        </a>
                                    </td>
                                </tr>
                            </table>
                            
                            <p style="margin: 24px 0 0 0; color: #6b7280; font-size: 14px;">
                                If you need assistance, please contact the PMIS administration team.
                            </p>
                        </td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 24px 32px; background-color: #f9fafb; border-top: 1px solid #e5e7eb; border-radius: 0 0 12px 12px; text-align: center;">
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">
                                <strong>PMIS Administration</strong><br>
                                Zaheerabad Industrial Area
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
    """
    
    try:
        email = EmailMultiAlternatives(subject=subject, body=text_content, from_email=settings.DEFAULT_FROM_EMAIL, to=[user.email])
        email.attach_alternative(html_content, "text/html")
        email.send()
        print(f"[EMAIL] Welcome email sent to {user.email}")
    except Exception as e:
        print(f"[EMAIL ERROR] Failed to send welcome email to {user.email}: {e}")


def send_registration_confirmation(user):
    """Send confirmation email after contractor registration."""
    subject = 'Registration Received - PMIS Zaheerabad Industrial Area'
    
    text_content = f"""
Dear {user.first_name} {user.last_name},

Thank you for registering on the Programme Management Information System (PMIS).

Your registration has been received and is pending approval by our administrators.

Registration Details:
- Company: {user.company_name}
- PAN: {user.pan_number}
- GSTIN: {user.gstin_number}
- Email: {user.email}

You will receive another email once your account has been reviewed and activated.

If you have any questions, please contact the PMNC team.

Best regards,
PMIS Administration
Zaheerabad Industrial Area
    """
    
    html_content = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f3f4f6;">
    <table role="presentation" style="width: 100%; border-collapse: collapse;">
        <tr>
            <td align="center" style="padding: 40px 0;">
                <table role="presentation" style="width: 600px; max-width: 100%; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <tr>
                        <td style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 32px; text-align: center; border-radius: 12px 12px 0 0;">
                            <h1 style="margin: 0; color: #ffffff; font-size: 24px; font-weight: 600;">Registration Received</h1>
                            <p style="margin: 8px 0 0 0; color: #d1fae5; font-size: 14px;">PMIS - Zaheerabad Industrial Area</p>
                        </td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 32px;">
                            <p style="margin: 0 0 16px 0; color: #374151; font-size: 16px;">
                                Dear <strong>{user.first_name} {user.last_name}</strong>,
                            </p>
                            
                            <p style="margin: 0 0 24px 0; color: #374151; font-size: 16px; line-height: 1.6;">
                                Thank you for registering on the Programme Management Information System (PMIS). Your registration has been received and is <strong>pending approval</strong> by our administrators.
                            </p>
                            
                            <table role="presentation" style="width: 100%; background-color: #f3f4f6; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                                <tr><td style="padding: 4px 0;"><strong>Company:</strong> {user.company_name}</td></tr>
                                <tr><td style="padding: 4px 0;"><strong>PAN:</strong> {user.pan_number}</td></tr>
                                <tr><td style="padding: 4px 0;"><strong>GSTIN:</strong> {user.gstin_number}</td></tr>
                                <tr><td style="padding: 4px 0;"><strong>Email:</strong> {user.email}</td></tr>
                            </table>
                            
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">
                                You will receive another email once your account has been reviewed and activated.
                            </p>
                        </td>
                    </tr>
                    
                    <tr>
                        <td style="padding: 24px 32px; background-color: #f9fafb; border-top: 1px solid #e5e7eb; border-radius: 0 0 12px 12px; text-align: center;">
                            <p style="margin: 0; color: #6b7280; font-size: 14px;">
                                <strong>PMIS Administration</strong><br>
                                Zaheerabad Industrial Area
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
    """
    
    try:
        email = EmailMultiAlternatives(subject=subject, body=text_content, from_email=settings.DEFAULT_FROM_EMAIL, to=[user.email])
        email.attach_alternative(html_content, "text/html")
        email.send()
        print(f"[EMAIL] Registration confirmation sent to {user.email}")
    except Exception as e:
        print(f"[EMAIL ERROR] Failed to send confirmation to {user.email}: {e}")


def notify_admins_new_registration(user):
    """Notify admin users about new contractor registration."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    
    admins = User.objects.filter(role__in=['SPV_Official', 'PMNC_Team'], is_active=True, account_status='ACTIVE')
    
    if not admins.exists():
        print("[EMAIL] No admin users found to notify")
        return
    
    subject = f'New Contractor Registration Pending Approval - {user.company_name}'
    
    text_content = f"""
A new contractor has registered on PMIS and requires approval.

Company Details:
- Name: {user.company_name}
- Contact: {user.first_name} {user.last_name}
- Email: {user.email}
- Phone: {user.phone_number}
- PAN: {user.pan_number}
- GSTIN: {user.gstin_number}

Please login to PM IS to review and approve/reject this registration.

Best regards,
PMIS System
    """
    
    admin_emails = list(admins.values_list('email', flat=True))
    
    try:
        from django.core.mail import send_mail
        send_mail(subject=subject, message=text_content, from_email=settings.DEFAULT_FROM_EMAIL, recipient_list=admin_emails, fail_silently=False)
        print(f"[EMAIL] Admin notification sent to {len(admin_emails)} admins")
    except Exception as e:
        print(f"[EMAIL ERROR] Failed to notify admins: {e}")


def send_approval_notification(user):
    """Send approval notification to contractor."""
    subject = 'Account Approved - PMIS Zaheerabad Industrial Area'
    
    login_url = f"{getattr(settings, 'FRONTEND_URL', 'http://localhost:3000')}/login"
    
    text_content = f"""
Dear {user.first_name} {user.last_name},

Congratulations! Your registration for PMIS has been approved.

You can now login to the system using your registered email and password.

Login URL: {login_url}

If you have any questions, please contact the PMNC team.

Best regards,
PMIS Administration
Zaheerabad Industrial Area
    """
    
    try:
        from django.core.mail import send_mail
        send_mail(subject=subject, message=text_content, from_email=settings.DEFAULT_FROM_EMAIL, recipient_list=[user.email], fail_silently=False)
        print(f"[EMAIL] Approval notification sent to {user.email}")
    except Exception as e:
        print(f"[EMAIL ERROR] Failed to send approval notification to {user.email}: {e}")


def send_rejection_notification(user, reason):
    """Send rejection notification to contractor."""
    subject = 'Registration Not Approved - PMIS Zaheerabad Industrial Area'
    
    text_content = f"""
Dear {user.first_name} {user.last_name},

We regret to inform you that your registration for PMIS has not been approved.

Reason: {reason}

If you believe this is an error or would like to provide additional information, 
please contact the PMNC team.

Best regards,
PMIS Administration
Zaheerabad Industrial Area
    """
    
    try:
        from django.core.mail import send_mail
        send_mail(subject=subject, message=text_content, from_email=settings.DEFAULT_FROM_EMAIL, recipient_list=[user.email], fail_silently=False)
        print(f"[EMAIL] Rejection notification sent to {user.email}")
    except Exception as e:
        print(f"[EMAIL ERROR] Failed to send rejection notification to {user.email}: {e}")


def send_password_reset_email(user, reset_url):
    """Send password reset email with HTML template."""
    subject = 'Password Reset Request - PMIS Zaheerabad Industrial Area'
    
    text_content = f"""
Dear {user.first_name or 'User'},

We received a request to reset your password for your PMIS account.

Click the link below to reset your password:
{reset_url}

This link will expire in 1 hour.

If you did not request a password reset, please ignore this email or contact support if you have concerns.

Best regards,
PMIS Administration
Zaheerabad Industrial Area
    """
    
    html_content = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6;">
    <table role="presentation" style="width: 100%; border-collapse: collapse;">
        <tr>
            <td align="center" style="padding: 40px 0;">
                <table role="presentation" style="width: 600px; max-width: 100%; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <!-- Header -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 32px; text-align: center; border-radius: 12px 12px 0 0;">
                            <h1 style="margin: 0; color: #ffffff; font-size: 24px; font-weight: 600;">Password Reset</h1>
                            <p style="margin: 8px 0 0 0; color: #fef3c7; font-size: 14px;">PMIS - Zaheerabad Industrial Area</p>
                        </td>
                    </tr>
                    
                    <!-- Content -->
                    <tr>
                        <td style="padding: 32px;">
                            <p style="margin: 0 0 16px 0; color: #374151; font-size: 16px; line-height: 1.5;">
                                Dear <strong>{user.first_name or 'User'}</strong>,
                            </p>
                            
                            <p style="margin: 0 0 24px 0; color: #374151; font-size: 16px; line-height: 1.5;">
                                We received a request to reset your password for your PMIS account. Click the button below to create a new password.
                            </p>
                            
                            <table role="presentation" style="width: 100%;">
                                <tr>
                                    <td align="center">
                                        <a href="{reset_url}" style="display: inline-block; padding: 14px 32px; background-color: #f59e0b; color: #ffffff; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                                            Reset My Password
                                        </a>
                                    </td>
                                </tr>
                            </table>
                            
                            <p style="margin: 24px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.5;">
                                This link will expire in <strong>1 hour</strong>.
                            </p>
                            
                            <p style="margin: 16px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.5;">
                                If you did not request a password reset, please ignore this email or contact support if you have concerns.
                            </p>
                        </td>
                    </tr>
                    
                    <!-- Footer -->
                    <tr>
                        <td style="padding: 24px 32px; background-color: #f9fafb; border-top: 1px solid #e5e7eb; border-radius: 0 0 12px 12px;">
                            <p style="margin: 0; color: #6b7280; font-size: 14px; text-align: center;">
                                <strong>PMIS Administration</strong><br>
                                Zaheerabad Industrial Area<br>
                                This is an automated message, please do not reply.
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
    """
    
    try:
        email = EmailMultiAlternatives(
            subject=subject,
            body=text_content,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[user.email]
        )
        email.attach_alternative(html_content, "text/html")
        email.send()
        print(f"[EMAIL] Password reset email sent to {user.email}")
        return True
    except Exception as e:
        print(f"[EMAIL ERROR] Failed to send password reset email to {user.email}: {e}")
        raise




================================================
FILE: backend/users/middleware.py
================================================
# User presence tracking middleware
from django.utils import timezone
from datetime import timedelta

class UserPresenceMiddleware:
    """
    Middleware to track user activity and update online status.
    Updates last_seen timestamp on every request from authenticated users.
    """
    
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        # Process request
        response = self.get_response(request)
        
        # Update user presence after response
        if request.user.is_authenticated:
            try:
                # Update last_seen timestamp
                request.user.last_seen = timezone.now()
                
                # Set is_online to True if user was inactive for less than 5 minutes
                request.user.is_online = True
                
                # Only update these fields (avoid triggering full save)
                request.user.save(update_fields=['last_seen', 'is_online'])
            except Exception as e:
                # Silent fail - don't break requests if presence update fails
                pass
        
        return response



================================================
FILE: backend/users/models.py
================================================
from django.contrib.auth.models import AbstractUser
from django.db import models
import uuid

class User(AbstractUser):
    class Roles(models.TextChoices):
        # Organizational roles
        SPV_OFFICIAL = 'SPV_Official', 'SPV Official'
        PMNC_TEAM = 'PMNC_Team', 'PMNC Team'
        EPC_CONTRACTOR = 'EPC_Contractor', 'EPC Contractor'
        CONSULTANT_DESIGN = 'Consultant_Design', 'Design Consultant'
        GOVT_DEPARTMENT = 'Govt_Department', 'Government Department'
        NICDC_HQ = 'NICDC_HQ', 'NICDC HQ'
        # Government hierarchy roles (for workflow routing)
        AE = 'AE', 'Assistant Engineer'
        EE = 'EE', 'Executive Engineer'
        SE = 'SE', 'Superintending Engineer'
        CE = 'CE', 'Chief Engineer'
        DA = 'DA', 'Divisional Accountant'
        PD = 'PD', 'Project Director'
    
    class AccountStatus(models.TextChoices):
        ACTIVE = 'ACTIVE', 'Active'
        PENDING_INVITE = 'PENDING_INVITE', 'Pending Invite Acceptance'
        PENDING_APPROVAL = 'PENDING_APPROVAL', 'Pending Admin Approval'
        DISABLED = 'DISABLED', 'Disabled'

    # Core Role Field
    role = models.CharField(
        max_length=50,
        choices=Roles.choices,
        default=Roles.SPV_OFFICIAL,
        help_text="Designates the functional role of the user."
    )
    
    # Account Status (for invite/approval workflow)
    account_status = models.CharField(
        max_length=20,
        choices=AccountStatus.choices,
        default=AccountStatus.ACTIVE,
        help_text="Current status of the user account."
    )
    
    # Invite Token (for internal user invite workflow)
    invite_token = models.UUIDField(null=True, blank=True, unique=True)
    invite_expires_at = models.DateTimeField(null=True, blank=True)
    
    # Password Reset Token
    password_reset_token = models.UUIDField(null=True, blank=True, unique=True)
    password_reset_expires_at = models.DateTimeField(null=True, blank=True)
    
    # Approval Tracking (for contractor approval workflow)
    approved_by = models.ForeignKey(
        'self', 
        null=True, 
        blank=True, 
        on_delete=models.SET_NULL,
        related_name='approved_users'
    )
    approved_at = models.DateTimeField(null=True, blank=True)
    rejection_reason = models.TextField(blank=True, default='')
    
    # Basic Contact Info
    department = models.CharField(max_length=100, blank=True, null=True)
    phone_number = models.CharField(max_length=15, blank=True, null=True)
    designation = models.CharField(max_length=100, blank=True, null=True)
    
    # Contractor-Specific Fields (populated only for EPC_Contractor role)
    contractor_id = models.CharField(
        max_length=100, 
        blank=True, 
        null=True, 
        help_text="Internal Contractor Profile ID"
    )
    
    # Legal Identifiers
    pan_number = models.CharField(max_length=10, blank=True, null=True, help_text="PAN Number")
    gstin_number = models.CharField(max_length=15, blank=True, null=True, help_text="GSTIN Number")
    eproc_number = models.CharField(max_length=50, blank=True, null=True, help_text="e-Procurement Number")
    
    # Company Details
    company_name = models.CharField(max_length=255, blank=True, null=True)
    
    # Address (Split Fields)
    building_number = models.CharField(max_length=100, blank=True, null=True)
    street = models.CharField(max_length=255, blank=True, null=True)
    area = models.CharField(max_length=100, blank=True, null=True)
    city = models.CharField(max_length=100, blank=True, null=True)
    state = models.CharField(max_length=100, blank=True, null=True)
    country = models.CharField(max_length=100, blank=True, null=True, default='India')
    zip_code = models.CharField(max_length=10, blank=True, null=True)
    
    # Bank Details (Required for Bill Payment module)
    bank_name = models.CharField(max_length=255, blank=True, null=True)
    bank_branch = models.CharField(max_length=255, blank=True, null=True)
    ifsc_code = models.CharField(max_length=11, blank=True, null=True, help_text="IFSC Code")
    account_number = models.CharField(max_length=20, blank=True, null=True)
    account_type = models.CharField(
        max_length=20, 
        blank=True, 
        null=True,
        choices=[
            ('SAVINGS', 'Savings'),
            ('CURRENT', 'Current'),
            ('OTHER', 'Other'),
        ]
    )
    
    # Contractor Registration Class (for EPC_Contractor role)
    registration_class = models.CharField(
        max_length=20,
        blank=True,
        null=True,
        choices=[
            ('Class A', 'Class A (Unlimited)'),
            ('Class B', 'Class B (Up to â‚¹50 Cr)'),
            ('Class C', 'Class C (Up to â‚¹10 Cr)'),
            ('Class D', 'Class D (Up to â‚¹2 Cr)'),
            ('Class E', 'Class E (Up to â‚¹50 Lakh)'),
        ],
        help_text="Contractor registration class (only for EPC_Contractor role)"
    )
    
    # User Presence Tracking
    last_seen = models.DateTimeField(null=True, blank=True, help_text="Last activity timestamp")
    is_online = models.BooleanField(default=False, help_text="Currently active status")
    
    class Meta:
        verbose_name = 'User'
        verbose_name_plural = 'Users'

    def __str__(self):
        return f"{self.username} ({self.get_role_display()})"
    
    @property
    def full_address(self):
        """Returns formatted full address."""
        parts = [
            self.building_number,
            self.street,
            self.area,
            self.city,
            self.state,
            self.country,
            self.zip_code
        ]
        return ', '.join(filter(None, parts))
    
    @property
    def is_contractor(self):
        return self.role == self.Roles.EPC_CONTRACTOR
    
    @property
    def can_login(self):
        """Check if user is allowed to login."""
        return self.account_status == self.AccountStatus.ACTIVE and self.is_active
    
    def generate_invite_token(self):
        """Generate a new invite token."""
        from django.utils import timezone
        from datetime import timedelta
        
        self.invite_token = uuid.uuid4()
        self.invite_expires_at = timezone.now() + timedelta(days=1)  # 24 hour expiry
        self.save(update_fields=['invite_token', 'invite_expires_at'])
        return self.invite_token
    
    def accept_invite(self, password):
        """Accept invite and set password."""
        from django.utils import timezone
        
        if not self.invite_token:
            raise ValueError("No invite token found.")
        
        if self.invite_expires_at and timezone.now() > self.invite_expires_at:
            raise ValueError("Invite link has expired.")
        
        self.set_password(password)
        self.account_status = self.AccountStatus.ACTIVE
        self.is_active = True  # Enable login
        self.invite_token = None
        self.invite_expires_at = None
        self.save()
    
    def generate_password_reset_token(self):
        """Generate a password reset token with 1 hour expiry."""
        from django.utils import timezone
        from datetime import timedelta
        
        self.password_reset_token = uuid.uuid4()
        self.password_reset_expires_at = timezone.now() + timedelta(hours=1)
        self.save(update_fields=['password_reset_token', 'password_reset_expires_at'])
        return self.password_reset_token
    
    def reset_password(self, new_password):
        """Reset password using token."""
        from django.utils import timezone
        
        if not self.password_reset_token:
            raise ValueError("No password reset token found.")
        
        if self.password_reset_expires_at and timezone.now() > self.password_reset_expires_at:
            raise ValueError("Password reset link has expired.")
        
        self.set_password(new_password)
        self.password_reset_token = None
        self.password_reset_expires_at = None
        self.save()



================================================
FILE: backend/users/serializers.py
================================================
from rest_framework import serializers
from django.contrib.auth import get_user_model
from django.contrib.auth.password_validation import validate_password

User = get_user_model()


class UserSerializer(serializers.ModelSerializer):
    """Basic user serializer for listing/viewing users."""
    full_address = serializers.ReadOnlyField()
    
    class Meta:
        model = User
        fields = [
            'id', 'username', 'email', 'first_name', 'last_name',
            'role', 'account_status', 'department', 'phone_number', 'designation',
            'company_name', 'is_contractor', 'date_joined', 'last_login',
            'full_address'
        ]
        read_only_fields = ['id', 'date_joined', 'last_login', 'is_contractor']


class UserDetailSerializer(serializers.ModelSerializer):
    """Detailed user serializer with all fields."""
    full_address = serializers.ReadOnlyField()
    approved_by_name = serializers.SerializerMethodField()
    
    class Meta:
        model = User
        fields = [
            'id', 'username', 'email', 'first_name', 'last_name',
            'role', 'account_status', 'department', 'phone_number', 'designation',
            # Contractor fields
            'contractor_id', 'pan_number', 'gstin_number', 'eproc_number',
            'company_name',
            # Address
            'building_number', 'street', 'area', 'city', 'state', 'country', 'zip_code',
            'full_address',
            # Bank details
            'bank_name', 'bank_branch', 'ifsc_code', 'account_number', 'account_type',
            # Approval
            'approved_by', 'approved_by_name', 'approved_at', 'rejection_reason',
            # Meta
            'is_contractor', 'date_joined', 'last_login', 'is_active'
        ]
        read_only_fields = ['id', 'date_joined', 'last_login', 'is_contractor', 'approved_by_name']
    
    def get_approved_by_name(self, obj):
        if obj.approved_by:
            return f"{obj.approved_by.first_name} {obj.approved_by.last_name}".strip() or obj.approved_by.username
        return None


class InviteUserSerializer(serializers.Serializer):
    """Serializer for inviting internal users."""
    email = serializers.EmailField()
    first_name = serializers.CharField(max_length=150)
    last_name = serializers.CharField(max_length=150)
    role = serializers.ChoiceField(choices=[
        ('SPV_Official', 'SPV Official'),
        ('PMNC_Team', 'PMNC Team'),
        ('Consultant_Design', 'Design Consultant'),
        ('Govt_Department', 'Government Department'),
        ('NICDC_HQ', 'NICDC HQ'),
    ])
    department = serializers.CharField(max_length=100, required=False, allow_blank=True)
    designation = serializers.CharField(max_length=100, required=False, allow_blank=True)
    phone_number = serializers.CharField(max_length=15, required=False, allow_blank=True)
    
    def validate_email(self, value):
        if User.objects.filter(email=value).exists():
            raise serializers.ValidationError("A user with this email already exists.")
        return value


class AcceptInviteSerializer(serializers.Serializer):
    """Serializer for accepting invite and setting password."""
    token = serializers.UUIDField()
    password = serializers.CharField(write_only=True, min_length=8)
    confirm_password = serializers.CharField(write_only=True)
    
    def validate(self, data):
        if data['password'] != data['confirm_password']:
            raise serializers.ValidationError({"confirm_password": "Passwords do not match."})
        
        # Validate password strength
        validate_password(data['password'])
        
        # Validate token
        try:
            user = User.objects.get(invite_token=data['token'])
        except User.DoesNotExist:
            raise serializers.ValidationError({"token": "Invalid or expired invite token."})
        
        from django.utils import timezone
        if user.invite_expires_at and timezone.now() > user.invite_expires_at:
            raise serializers.ValidationError({"token": "Invite link has expired."})
        
        data['user'] = user
        return data


class ContractorRegistrationSerializer(serializers.Serializer):
    """Serializer for contractor self-registration."""
    # Account credentials
    email = serializers.EmailField()
    password = serializers.CharField(write_only=True, min_length=8)
    confirm_password = serializers.CharField(write_only=True)
    
    # Contact Person
    first_name = serializers.CharField(max_length=150)
    last_name = serializers.CharField(max_length=150)
    phone_number = serializers.CharField(max_length=15)
    designation = serializers.CharField(max_length=100, required=False, allow_blank=True)
    
    # Company Details
    company_name = serializers.CharField(max_length=255)
    
    # Legal Identifiers
    pan_number = serializers.CharField(max_length=10)
    gstin_number = serializers.CharField(max_length=15)
    eproc_number = serializers.CharField(max_length=50)
    
    # Address
    building_number = serializers.CharField(max_length=100, required=False, allow_blank=True)
    street = serializers.CharField(max_length=255)
    area = serializers.CharField(max_length=100, required=False, allow_blank=True)
    city = serializers.CharField(max_length=100)
    state = serializers.CharField(max_length=100)
    country = serializers.CharField(max_length=100, default='India')
    zip_code = serializers.CharField(max_length=10)
    
    # Bank Details
    bank_name = serializers.CharField(max_length=255)
    bank_branch = serializers.CharField(max_length=255, required=False, allow_blank=True)
    ifsc_code = serializers.CharField(max_length=11)
    account_number = serializers.CharField(max_length=20)
    account_type = serializers.ChoiceField(choices=[
        ('SAVINGS', 'Savings'),
        ('CURRENT', 'Current'),
        ('OTHER', 'Other'),
    ], default='CURRENT')
    
    def validate_email(self, value):
        if User.objects.filter(email=value).exists():
            raise serializers.ValidationError("A user with this email already exists.")
        return value
    
    def validate_pan_number(self, value):
        # Basic PAN format validation: ABCDE1234F
        import re
        if not re.match(r'^[A-Z]{5}[0-9]{4}[A-Z]$', value.upper()):
            raise serializers.ValidationError("Invalid PAN format. Expected: ABCDE1234F")
        return value.upper()
    
    def validate_gstin_number(self, value):
        # Basic GSTIN format: 22AAAAA0000A1Z5
        import re
        if not re.match(r'^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z][0-9A-Z]Z[0-9A-Z]$', value.upper()):
            raise serializers.ValidationError("Invalid GSTIN format.")
        return value.upper()
    
    def validate_ifsc_code(self, value):
        # IFSC format: ABCD0123456
        import re
        if not re.match(r'^[A-Z]{4}0[A-Z0-9]{6}$', value.upper()):
            raise serializers.ValidationError("Invalid IFSC code format.")
        return value.upper()
    
    def validate(self, data):
        if data['password'] != data['confirm_password']:
            raise serializers.ValidationError({"confirm_password": "Passwords do not match."})
        validate_password(data['password'])
        return data
    
    def create(self, validated_data):
        validated_data.pop('confirm_password')
        password = validated_data.pop('password')
        
        # Generate username from first name and last name (epc_contractor_firstname_l)
        first_name = validated_data['first_name']
        last_name = validated_data['last_name']
        
        # Clean names (lowercase, remove spaces/special chars)
        clean_first_name = ''.join(e for e in first_name if e.isalnum()).lower()
        clean_last_initial = ''.join(e for e in last_name if e.isalnum()).lower()[0] if last_name else 'x'
        
        base_username = f"epc_contractor_{clean_first_name}_{clean_last_initial}"
        
        username = base_username
        counter = 1
        while User.objects.filter(username=username).exists():
            username = f"{base_username}{counter}"
            counter += 1
        
        user = User.objects.create_user(
            username=username,
            password=password,
            role=User.Roles.EPC_CONTRACTOR,
            account_status=User.AccountStatus.PENDING_APPROVAL,
            is_active=False,  # Contractors can't login until approved
            **validated_data
        )
        return user


class ApproveUserSerializer(serializers.Serializer):
    """Serializer for approving pending users."""
    pass  # No input needed, just action


class RejectUserSerializer(serializers.Serializer):
    """Serializer for rejecting pending users."""
    reason = serializers.CharField(max_length=500)


class UserUpdateSerializer(serializers.ModelSerializer):
    """Serializer for updating user details (admin)."""
    
    class Meta:
        model = User
        fields = [
            'first_name', 'last_name', 'email', 'role', 'department',
            'phone_number', 'designation', 'account_status', 'is_active',
            # Contractor fields
            'contractor_id', 'pan_number', 'gstin_number', 'eproc_number',
            'company_name',
            # Address
            'building_number', 'street', 'area', 'city', 'state', 'country', 'zip_code',
            # Bank
            'bank_name', 'bank_branch', 'ifsc_code', 'account_number', 'account_type',
        ]


class PasswordResetRequestSerializer(serializers.Serializer):
    """Serializer for requesting password reset email."""
    email = serializers.EmailField()
    
    def validate_email(self, value):
        try:
            user = User.objects.get(email=value)
            if not user.is_active and user.account_status != User.AccountStatus.ACTIVE:
                raise serializers.ValidationError("This account is not active.")
        except User.DoesNotExist:
            # Don't reveal if email exists for security
            pass
        return value


class PasswordResetConfirmSerializer(serializers.Serializer):
    """Serializer for confirming password reset with token."""
    token = serializers.UUIDField()
    password = serializers.CharField(write_only=True, min_length=8)
    confirm_password = serializers.CharField(write_only=True)
    
    def validate(self, data):
        if data['password'] != data['confirm_password']:
            raise serializers.ValidationError({"confirm_password": "Passwords do not match."})
        
        # Validate password strength
        validate_password(data['password'])
        
        # Validate token
        try:
            user = User.objects.get(password_reset_token=data['token'])
        except User.DoesNotExist:
            raise serializers.ValidationError({"token": "Invalid or expired reset token."})
        
        from django.utils import timezone
        if user.password_reset_expires_at and timezone.now() > user.password_reset_expires_at:
            raise serializers.ValidationError({"token": "Password reset link has expired."})
        
        data['user'] = user
        return data



================================================
FILE: backend/users/tests.py
================================================
from django.test import TestCase

# Create your tests here.



================================================
FILE: backend/users/throttles.py
================================================
"""
Custom throttle classes for API rate limiting.
Provides fine-grained control over API access rates for different endpoints.
"""
from rest_framework.throttling import UserRateThrottle, AnonRateThrottle


class LoginThrottle(UserRateThrottle):
    """
    Rate limit for login endpoint to prevent brute force attacks.
    Default: 5 attempts per minute
    """
    scope = 'login'
    rate = '5/minute'


class DashboardThrottle(UserRateThrottle):
    """
    Rate limit for dashboard stats endpoint to prevent excessive load.
    Default: 60 requests per hour
    """
    scope = 'dashboard'
    rate = '60/hour'


class MasterDataThrottle(UserRateThrottle):
    """
    Rate limit for master data endpoints (less restrictive as they're cached).
    Default: 500 requests per hour
    """
    scope = 'masterdata'
    rate = '500/hour'


class BulkOperationThrottle(UserRateThrottle):
    """
    Rate limit for bulk operations (imports, exports).
    Default: 10 requests per hour
    """
    scope = 'bulk'
    rate = '10/hour'



================================================
FILE: backend/users/urls.py
================================================
from django.urls import path
from .views import (
    UserProfileView, UserListView, UserDetailView,
    InviteUserView, AcceptInviteView,
    ContractorRegistrationView, PendingUsersView,
    ApproveUserView, RejectUserView, ToggleUserStatusView,
    PasswordResetRequestView, PasswordResetConfirmView,
    EligibleManagersListView, UserSearchView
)

urlpatterns = [
    # Current user profile
    path('profile/', UserProfileView.as_view(), name='user-profile'),
    path('me/', UserProfileView.as_view(), name='user-me'),  # Alias for frontend compatibility
    
    # User management (Admin)
    path('', UserListView.as_view(), name='user-list'),
    path('search/', UserSearchView.as_view(), name='user-search'),  # Fuzzy search endpoint
    path('eligible-managers/', EligibleManagersListView.as_view(), name='eligible-managers'),
    path('<int:pk>/', UserDetailView.as_view(), name='user-detail'),
    path('<int:pk>/toggle-status/', ToggleUserStatusView.as_view(), name='user-toggle-status'),
    
    # Invite workflow (Internal users)
    path('invite/', InviteUserView.as_view(), name='user-invite'),
    path('accept-invite/', AcceptInviteView.as_view(), name='user-accept-invite'),
    
    # Contractor registration (Public)
    path('register-contractor/', ContractorRegistrationView.as_view(), name='contractor-register'),
    
    # Password reset (Public)
    path('password-reset/', PasswordResetRequestView.as_view(), name='password-reset-request'),
    path('password-reset/confirm/', PasswordResetConfirmView.as_view(), name='password-reset-confirm'),
    
    # Approval workflow
    path('pending/', PendingUsersView.as_view(), name='user-pending'),
    path('<int:pk>/approve/', ApproveUserView.as_view(), name='user-approve'),
    path('<int:pk>/reject/', RejectUserView.as_view(), name='user-reject'),
]



================================================
FILE: backend/users/views.py
================================================
from rest_framework import status, permissions
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.generics import ListAPIView, RetrieveUpdateAPIView
from django.contrib.auth import get_user_model
from django.utils import timezone
from django.conf import settings

from .serializers import (
    UserSerializer, UserDetailSerializer, InviteUserSerializer,
    AcceptInviteSerializer, ContractorRegistrationSerializer,
    ApproveUserSerializer, RejectUserSerializer, UserUpdateSerializer,
    PasswordResetRequestSerializer, PasswordResetConfirmSerializer
)

User = get_user_model()


class IsAdminUser(permissions.BasePermission):
    """Permission for SPV and NICDC HQ users."""
    def has_permission(self, request, view):
        return request.user.is_authenticated and request.user.role in ['SPV_Official', 'NICDC_HQ']


class UserProfileView(APIView):
    """Get current user's profile."""
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request):
        serializer = UserDetailSerializer(request.user)
        return Response(serializer.data)
    
    def patch(self, request):
        """Allow users to update their own basic info."""
        allowed_fields = ['first_name', 'last_name', 'phone_number', 'designation']
        update_data = {k: v for k, v in request.data.items() if k in allowed_fields}
        
        for key, value in update_data.items():
            setattr(request.user, key, value)
        request.user.save()
        
        serializer = UserDetailSerializer(request.user)
        return Response(serializer.data)


class UserListView(ListAPIView):
    """List all users (Accessible to all authenticated users for chat)."""
    serializer_class = UserSerializer
    permission_classes = [permissions.IsAuthenticated]
    pagination_class = None
    
    def get_queryset(self):
        queryset = User.objects.all().order_by('-date_joined')
        
        # Filter by role
        role = self.request.query_params.get('role')
        if role:
            queryset = queryset.filter(role=role)
        
        # Filter by status
        status_filter = self.request.query_params.get('status')
        if status_filter:
            queryset = queryset.filter(account_status=status_filter)
        
        # Search
        search = self.request.query_params.get('search')
        if search:
            from django.db.models import Q
            queryset = queryset.filter(
                Q(username__icontains=search) |
                Q(email__icontains=search) |
                Q(first_name__icontains=search) |
                Q(last_name__icontains=search) |
                Q(company_name__icontains=search)
            )
        
        return queryset


class EligibleManagersListView(ListAPIView):
    """
    List users eligible to be assigned as Project Managers.
    
    Eligible roles:
    - SPV_Official: State Project Vehicle officials
    - PMNC_Team: Project Management & Coordination Team
    - GOVT_DEPARTMENT: Government Department representatives  
    - NICDC_HQ: NICDC Headquarters staff
    
    Only ACTIVE users are returned for assignment.
    """
    serializer_class = UserSerializer
    permission_classes = [permissions.IsAuthenticated]
    pagination_class = None
    
    # Define eligible roles for project management
    ELIGIBLE_ROLES = [
        'SPV_Official',
        'PMNC_Team', 
        'GOVT_DEPARTMENT',
        'NICDC_HQ'
    ]
    
    def get_queryset(self):
        return User.objects.filter(
            role__in=self.ELIGIBLE_ROLES,
            account_status=User.AccountStatus.ACTIVE,
            is_active=True
        ).order_by('first_name', 'last_name')


class UserSearchView(APIView):
    """
    Search users with fuzzy matching for package staff and zone head selection.
    
    Query Parameters:
        q (str): Search query (name, email, username)
        role (str, optional): Filter by specific role
        limit (int, optional): Limit results (default: 20, max: 100)
    
    Features:
        - Fuzzy search across first_name, last_name, email, username
        - Case-insensitive matching
        - Role filtering
        - Active users only
        - Performance optimized with query limits
    """
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request):
        query = request.GET.get('q', '').strip()
        role_filter = request.GET.get('role', None)
        limit = min(int(request.GET.get('limit', 20)), 100)  # Cap at 100 for performance
        
        # Require at least 2 characters for search to prevent loading all users
        if not query or len(query) < 2:
            return Response({
                'error': 'Search query must be at least 2 characters',
                'users': []
            }, status=status.HTTP_400_BAD_REQUEST)
        
        # Build search query with fuzzy matching (case-insensitive)
        from django.db.models import Q
        query_lower = query.lower()
        
        search_filter = Q(
            Q(first_name__icontains=query_lower) |
            Q(last_name__icontains=query_lower) |
            Q(email__icontains=query_lower) |
            Q(username__icontains=query_lower)
        )
        
        # Start with active users only
        users = User.objects.filter(
            search_filter,
            account_status='ACTIVE'
        )
        
        # Apply role filter if specified
        if role_filter:
            users = users.filter(role=role_filter)
        
        # Optimize query and limit results
        users = users.select_related('division', 'subdivision', 'zone').order_by(
            'first_name', 'last_name'
        )[:limit]
        
        # Serialize results
        user_data = [{ 
            'id': user.id,
            'username': user.username,
            'first_name': user.first_name,
            'last_name': user.last_name,
            'email': user.email,
            'full_name': f"{user.first_name} {user.last_name}".strip() or user.username,
            'role': user.role,
            'role_display': user.get_role_display() if hasattr(user, 'get_role_display') else user.role,
            'division': user.division.name if user.division else None,
            'subdivision': user.subdivision.name if hasattr(user, 'subdivision') and user.subdivision else None,
            'account_status': user.account_status,
        } for user in users]
        
        return Response({
            'count': len(user_data),
            'query': query,
            'role_filter': role_filter,
            'users': user_data
        })


class UserDetailView(RetrieveUpdateAPIView):
    """Get/Update user details (Admin only)."""
    queryset = User.objects.all()
    permission_classes = [IsAdminUser]
    
    def get_serializer_class(self):
        if self.request.method in ['PUT', 'PATCH']:
            return UserUpdateSerializer
        return UserDetailSerializer


class InviteUserView(APIView):
    """Invite internal user (Admin only)."""
    permission_classes = [IsAdminUser]
    
    def post(self, request):
        serializer = InviteUserSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        data = serializer.validated_data
        
        # Create user with pending invite status
        username = data['email'].split('@')[0]
        counter = 1
        base_username = username
        while User.objects.filter(username=username).exists():
            username = f"{base_username}{counter}"
            counter += 1
        
        user = User.objects.create(
            username=username,
            email=data['email'],
            first_name=data['first_name'],
            last_name=data['last_name'],
            role=data['role'],
            department=data.get('department', ''),
            designation=data.get('designation', ''),
            phone_number=data.get('phone_number', ''),
            account_status=User.AccountStatus.PENDING_INVITE,
            is_active=False  # Can't login until invite is accepted
        )
        
        # Generate invite token
        token = user.generate_invite_token()
        
        # Send invite email
        invite_url = f"{settings.FRONTEND_URL}/accept-invite/{token}"
        self._send_invite_email(user, invite_url)
        
        return Response({
            'message': f'Invite sent to {user.email}',
            'user_id': user.id,
            'invite_url': invite_url  # For testing; remove in production
        }, status=status.HTTP_201_CREATED)
    
    def _send_invite_email(self, user, invite_url):
        """Send invite email via SendGrid."""
        try:
            from .email_service import send_invite_email
            send_invite_email(user, invite_url)
        except Exception as e:
            print(f"Failed to send invite email: {e}")
            # Don't fail the request if email fails


class AcceptInviteView(APIView):
    """Accept invite and set password (Public)."""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        serializer = AcceptInviteSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        user = serializer.validated_data['user']
        password = serializer.validated_data['password']
        
        user.accept_invite(password)
        
        # Send welcome email
        try:
            from .email_service import send_welcome_email
            send_welcome_email(user)
        except Exception as e:
            print(f"Failed to send welcome email: {e}")
        
        return Response({
            'message': 'Account activated successfully. You can now login.',
            'username': user.username,
            'email': user.email
        })
    
    def get(self, request):
        """Validate invite token and return user info."""
        token = request.query_params.get('token')
        if not token:
            return Response({'error': 'Token is required'}, status=status.HTTP_400_BAD_REQUEST)
        
        try:
            import uuid
            token_uuid = uuid.UUID(token)
            user = User.objects.get(invite_token=token_uuid)
            
            if user.invite_expires_at and timezone.now() > user.invite_expires_at:
                return Response({'error': 'Invite link has expired'}, status=status.HTTP_400_BAD_REQUEST)
            
            return Response({
                'valid': True,
                'username': user.username,
                'email': user.email,
                'first_name': user.first_name,
                'last_name': user.last_name,
                'role': user.get_role_display()
            })
        except (ValueError, User.DoesNotExist):
            return Response({'error': 'Invalid invite token'}, status=status.HTTP_400_BAD_REQUEST)


class ContractorRegistrationView(APIView):
    """Contractor self-registration (Public)."""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        serializer = ContractorRegistrationSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        user = serializer.save()
        
        # Send confirmation email
        try:
            from .email_service import send_registration_confirmation
            send_registration_confirmation(user)
        except Exception as e:
            print(f"Failed to send confirmation email: {e}")
        
        # Notify admins
        try:
            from .email_service import notify_admins_new_registration
            notify_admins_new_registration(user)
        except Exception as e:
            print(f"Failed to notify admins: {e}")
        
        return Response({
            'message': 'Registration submitted successfully. Your account is pending approval.',
            'user_id': user.id,
            'status': 'PENDING_APPROVAL'
        }, status=status.HTTP_201_CREATED)


class PendingUsersView(ListAPIView):
    """List users pending approval (Admin only)."""
    serializer_class = UserDetailSerializer
    permission_classes = [IsAdminUser]
    
    def get_queryset(self):
        return User.objects.filter(
            account_status=User.AccountStatus.PENDING_APPROVAL
        ).order_by('-date_joined')


class ApproveUserView(APIView):
    """Approve pending user (Admin only)."""
    permission_classes = [IsAdminUser]
    
    def post(self, request, pk):
        try:
            user = User.objects.get(pk=pk)
        except User.DoesNotExist:
            return Response({'error': 'User not found'}, status=status.HTTP_404_NOT_FOUND)
        
        if user.account_status != User.AccountStatus.PENDING_APPROVAL:
            return Response({
                'error': f'User is not pending approval. Current status: {user.account_status}'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        user.account_status = User.AccountStatus.ACTIVE
        user.is_active = True
        user.approved_by = request.user
        user.approved_at = timezone.now()
        user.save()
        
        # If this is a contractor, auto-create contractor master record
        contractor_created = False
        if user.role == 'EPC_Contractor':
            contractor_created = self._create_contractor_record(user)
        
        # Send approval email
        try:
            from .email_service import send_approval_notification
            send_approval_notification(user)
        except Exception as e:
            print(f"Failed to send approval email: {e}")
        
        return Response({
            'message': f'User {user.email} has been approved.',
            'user': UserDetailSerializer(user).data,
            'contractor_created': contractor_created
        })
    
    def _create_contractor_record(self, user):
        """Auto-create contractor master record for approved contractor user."""
        try:
            from masters.models.entities import Contractor
            
            # Check if contractor already exists linked to this user
            existing = Contractor.objects.filter(linked_user=user).first()
            if existing:
                return True  # Already linked
            
            # Check if contractor already exists with same PAN
            if user.pan_number:
                existing = Contractor.objects.filter(pan=user.pan_number).first()
                if existing:
                    # Link existing contractor to user
                    existing.linked_user = user
                    existing.save()
                    return True
            
            # Generate unique contractor code
            last_contractor = Contractor.objects.order_by('-created_at').last()
            if last_contractor and last_contractor.code.startswith('CON-'):
                try:
                    last_num = int(last_contractor.code.split('-')[1])
                    next_num = last_num + 1
                except:
                    next_num = Contractor.objects.count() + 1
            else:
                next_num = Contractor.objects.count() + 1
            code = f"CON-{next_num:04d}"
            
            # Ensure code is unique
            while Contractor.objects.filter(code=code).exists():
                next_num += 1
                code = f"CON-{next_num:04d}"
            
            # Create new contractor record using model's actual fields
            Contractor.objects.create(
                code=code,
                name=user.company_name or f"{user.first_name} {user.last_name}",
                contractor_type='Proprietorship',  # Default, user can update later
                registration_class=user.registration_class or '',
                pan=user.pan_number or '',
                gstin=user.gstin_number or '',
                contact_person=f"{user.first_name} {user.last_name}",
                email=user.email,
                phone=user.phone_number or '',
                address=user.full_address or '',
                blacklisted=False,
                linked_user=user,
            )
            return True
        except Exception as e:
            print(f"Failed to auto-create contractor record: {e}")
            import traceback
            traceback.print_exc()
            return False


class RejectUserView(APIView):
    """Reject pending user (Admin only)."""
    permission_classes = [IsAdminUser]
    
    def post(self, request, pk):
        serializer = RejectUserSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        try:
            user = User.objects.get(pk=pk)
        except User.DoesNotExist:
            return Response({'error': 'User not found'}, status=status.HTTP_404_NOT_FOUND)
        
        if user.account_status != User.AccountStatus.PENDING_APPROVAL:
            return Response({
                'error': f'User is not pending approval. Current status: {user.account_status}'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        user.account_status = User.AccountStatus.DISABLED
        user.rejection_reason = serializer.validated_data['reason']
        user.save()
        
        # Send rejection email
        try:
            from .email_service import send_rejection_notification
            send_rejection_notification(user, serializer.validated_data['reason'])
        except Exception as e:
            print(f"Failed to send rejection email: {e}")
        
        return Response({
            'message': f'User {user.email} has been rejected.',
        })


class ToggleUserStatusView(APIView):
    """Enable/Disable user account (Admin only)."""
    permission_classes = [IsAdminUser]
    
    def post(self, request, pk):
        try:
            user = User.objects.get(pk=pk)
        except User.DoesNotExist:
            return Response({'error': 'User not found'}, status=status.HTTP_404_NOT_FOUND)
        
        # Toggle active status
        new_status = request.data.get('is_active')
        if new_status is not None:
            user.is_active = new_status
            user.account_status = User.AccountStatus.ACTIVE if new_status else User.AccountStatus.DISABLED
            user.save()
        
        return Response({
            'message': f'User status updated.',
            'is_active': user.is_active,
            'account_status': user.account_status
        })


class PasswordResetRequestView(APIView):
    """Request password reset email (Public)."""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        serializer = PasswordResetRequestSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        email = serializer.validated_data['email']
        
        try:
            user = User.objects.get(email=email)
            token = user.generate_password_reset_token()
            
            # Send password reset email
            reset_url = f"{settings.FRONTEND_URL}/reset-password/{token}"
            self._send_reset_email(user, reset_url)
            
        except User.DoesNotExist:
            # Don't reveal if email exists - still return success
            pass
        
        # Always return success to prevent email enumeration
        return Response({
            'message': 'If an account exists with this email, a password reset link has been sent.',
            'success': True
        })
    
    def _send_reset_email(self, user, reset_url):
        """Send password reset email."""
        try:
            from .email_service import send_password_reset_email
            send_password_reset_email(user, reset_url)
        except Exception as e:
            print(f"Failed to send password reset email: {e}")


class PasswordResetConfirmView(APIView):
    """Confirm password reset with token (Public)."""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        serializer = PasswordResetConfirmSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        user = serializer.validated_data['user']
        new_password = serializer.validated_data['password']
        
        user.reset_password(new_password)
        
        return Response({
            'message': 'Password has been reset successfully. You can now login.',
            'success': True
        })
    
    def get(self, request):
        """Validate reset token and return user info."""
        token = request.query_params.get('token')
        if not token:
            return Response({'error': 'Token is required'}, status=status.HTTP_400_BAD_REQUEST)
        
        try:
            import uuid
            token_uuid = uuid.UUID(token)
            user = User.objects.get(password_reset_token=token_uuid)
            
            if user.password_reset_expires_at and timezone.now() > user.password_reset_expires_at:
                return Response({'error': 'Password reset link has expired'}, status=status.HTTP_400_BAD_REQUEST)
            
            return Response({
                'valid': True,
                'email': user.email,
                'first_name': user.first_name,
            })
        except (ValueError, User.DoesNotExist):
            return Response({'error': 'Invalid reset token'}, status=status.HTTP_400_BAD_REQUEST)



================================================
FILE: backend/users/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2025-12-12 13:23

import django.contrib.auth.models
import django.contrib.auth.validators
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
    ]

    operations = [
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('username', models.CharField(error_messages={'unique': 'A user with that username already exists.'}, help_text='Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.', max_length=150, unique=True, validators=[django.contrib.auth.validators.UnicodeUsernameValidator()], verbose_name='username')),
                ('first_name', models.CharField(blank=True, max_length=150, verbose_name='first name')),
                ('last_name', models.CharField(blank=True, max_length=150, verbose_name='last name')),
                ('email', models.EmailField(blank=True, max_length=254, verbose_name='email address')),
                ('is_staff', models.BooleanField(default=False, help_text='Designates whether the user can log into this admin site.', verbose_name='staff status')),
                ('is_active', models.BooleanField(default=True, help_text='Designates whether this user should be treated as active. Unselect this instead of deleting accounts.', verbose_name='active')),
                ('date_joined', models.DateTimeField(default=django.utils.timezone.now, verbose_name='date joined')),
                ('role', models.CharField(choices=[('SPV_Official', 'SPV Official'), ('PMNC_Team', 'PMNC Team'), ('EPC_Contractor', 'EPC Contractor'), ('Consultant_Design', 'Design Consultant'), ('Govt_Department', 'Government Department'), ('NICDC_HQ', 'NICDC HQ')], default='SPV_Official', help_text='Designates the functional role of the user.', max_length=50)),
                ('contractor_id', models.CharField(blank=True, help_text='Link to Contractor Profile if applicable', max_length=100, null=True)),
                ('department', models.CharField(blank=True, max_length=100, null=True)),
                ('phone_number', models.CharField(blank=True, max_length=15, null=True)),
                ('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups')),
                ('user_permissions', models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions')),
            ],
            options={
                'verbose_name': 'user',
                'verbose_name_plural': 'users',
                'abstract': False,
            },
            managers=[
                ('objects', django.contrib.auth.models.UserManager()),
            ],
        ),
    ]



================================================
FILE: backend/users/migrations/0002_add_user_management_fields.py
================================================
# Generated by Django 6.0 on 2025-12-14 17:57

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('users', '0001_initial'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='user',
            options={'verbose_name': 'User', 'verbose_name_plural': 'Users'},
        ),
        migrations.AddField(
            model_name='user',
            name='account_number',
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='account_status',
            field=models.CharField(choices=[('ACTIVE', 'Active'), ('PENDING_INVITE', 'Pending Invite Acceptance'), ('PENDING_APPROVAL', 'Pending Admin Approval'), ('DISABLED', 'Disabled')], default='ACTIVE', help_text='Current status of the user account.', max_length=20),
        ),
        migrations.AddField(
            model_name='user',
            name='account_type',
            field=models.CharField(blank=True, choices=[('SAVINGS', 'Savings'), ('CURRENT', 'Current'), ('OTHER', 'Other')], max_length=20, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='approved_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='approved_by',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approved_users', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='user',
            name='area',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='bank_branch',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='bank_name',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='building_number',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='city',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='company_name',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='country',
            field=models.CharField(blank=True, default='India', max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='designation',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='eproc_number',
            field=models.CharField(blank=True, help_text='e-Procurement Number', max_length=50, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='gstin_number',
            field=models.CharField(blank=True, help_text='GSTIN Number', max_length=15, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='ifsc_code',
            field=models.CharField(blank=True, help_text='IFSC Code', max_length=11, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='invite_expires_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='invite_token',
            field=models.UUIDField(blank=True, null=True, unique=True),
        ),
        migrations.AddField(
            model_name='user',
            name='pan_number',
            field=models.CharField(blank=True, help_text='PAN Number', max_length=10, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='rejection_reason',
            field=models.TextField(blank=True, default=''),
        ),
        migrations.AddField(
            model_name='user',
            name='state',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='street',
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='zip_code',
            field=models.CharField(blank=True, max_length=10, null=True),
        ),
        migrations.AlterField(
            model_name='user',
            name='contractor_id',
            field=models.CharField(blank=True, help_text='Internal Contractor Profile ID', max_length=100, null=True),
        ),
    ]



================================================
FILE: backend/users/migrations/0003_user_is_online_user_last_seen.py
================================================
# Generated by Django 6.0 on 2025-12-23 15:00

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('users', '0002_add_user_management_fields'),
    ]

    operations = [
        migrations.AddField(
            model_name='user',
            name='is_online',
            field=models.BooleanField(default=False, help_text='Currently active status'),
        ),
        migrations.AddField(
            model_name='user',
            name='last_seen',
            field=models.DateTimeField(blank=True, help_text='Last activity timestamp', null=True),
        ),
    ]



================================================
FILE: backend/users/migrations/0004_add_password_reset_token.py
================================================
# Generated by Django 6.0 on 2026-01-02 16:50

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('users', '0003_user_is_online_user_last_seen'),
    ]

    operations = [
        migrations.AddField(
            model_name='user',
            name='password_reset_expires_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='user',
            name='password_reset_token',
            field=models.UUIDField(blank=True, null=True, unique=True),
        ),
    ]



================================================
FILE: backend/users/migrations/0005_user_registration_class.py
================================================
# Generated by Django 6.0 on 2026-01-11 07:15

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('users', '0004_add_password_reset_token'),
    ]

    operations = [
        migrations.AddField(
            model_name='user',
            name='registration_class',
            field=models.CharField(blank=True, choices=[('Class A', 'Class A (Unlimited)'), ('Class B', 'Class B (Up to â‚¹50 Cr)'), ('Class C', 'Class C (Up to â‚¹10 Cr)'), ('Class D', 'Class D (Up to â‚¹2 Cr)'), ('Class E', 'Class E (Up to â‚¹50 Lakh)')], help_text='Contractor registration class (only for EPC_Contractor role)', max_length=20, null=True),
        ),
    ]



================================================
FILE: backend/users/migrations/0006_add_government_hierarchy_roles.py
================================================
# Generated by Django 6.0.1 on 2026-01-27 17:59

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('users', '0005_user_registration_class'),
    ]

    operations = [
        migrations.AlterField(
            model_name='user',
            name='role',
            field=models.CharField(choices=[('SPV_Official', 'SPV Official'), ('PMNC_Team', 'PMNC Team'), ('EPC_Contractor', 'EPC Contractor'), ('Consultant_Design', 'Design Consultant'), ('Govt_Department', 'Government Department'), ('NICDC_HQ', 'NICDC HQ'), ('AE', 'Assistant Engineer'), ('EE', 'Executive Engineer'), ('SE', 'Superintending Engineer'), ('CE', 'Chief Engineer'), ('DA', 'Divisional Accountant'), ('PD', 'Project Director')], default='SPV_Official', help_text='Designates the functional role of the user.', max_length=50),
        ),
    ]



================================================
FILE: backend/users/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: backend/workflow/__init__.py
================================================
[Empty file]


================================================
FILE: backend/workflow/admin.py
================================================
"""
Workflow Admin Configuration
"""
from django.contrib import admin
from .models import (
    WorkflowTemplate, WorkflowStep, WorkflowTriggerRule,
    WorkflowInstance, WorkflowAuditLog, DelegationRule
)


class WorkflowStepInline(admin.TabularInline):
    model = WorkflowStep
    extra = 1
    ordering = ['sequence']


@admin.register(WorkflowTemplate)
class WorkflowTemplateAdmin(admin.ModelAdmin):
    list_display = ['name', 'module', 'is_active', 'is_default', 'step_count', 'created_at']
    list_filter = ['module', 'is_active', 'is_default']
    search_fields = ['name', 'description']
    inlines = [WorkflowStepInline]
    readonly_fields = ['created_at', 'updated_at']


@admin.register(WorkflowStep)
class WorkflowStepAdmin(admin.ModelAdmin):
    list_display = ['template', 'sequence', 'role', 'action_type', 'deadline_days', 'can_revert']
    list_filter = ['template', 'action_type', 'role']
    ordering = ['template', 'sequence']


@admin.register(WorkflowTriggerRule)
class WorkflowTriggerRuleAdmin(admin.ModelAdmin):
    list_display = ['name', 'module', 'condition_field', 'condition_operator', 'condition_value', 'template', 'priority', 'is_active']
    list_filter = ['module', 'is_active', 'condition_operator']
    search_fields = ['name', 'condition_field']
    ordering = ['module', 'priority']


@admin.register(WorkflowInstance)
class WorkflowInstanceAdmin(admin.ModelAdmin):
    list_display = ['entity_type', 'entity_id', 'template', 'current_step', 'status', 'started_at', 'is_overdue']
    list_filter = ['status', 'entity_type', 'template']
    search_fields = ['entity_id']
    readonly_fields = ['started_at', 'completed_at']
    
    def is_overdue(self, obj):
        return obj.is_overdue()
    is_overdue.boolean = True


@admin.register(WorkflowAuditLog)
class WorkflowAuditLogAdmin(admin.ModelAdmin):
    list_display = ['instance', 'step', 'action', 'performed_by', 'entered_at', 'time_spent_hours']
    list_filter = ['action', 'entered_at']
    search_fields = ['instance__entity_id', 'remarks']
    readonly_fields = ['instance', 'step', 'action', 'performed_by', 'entered_at', 'exited_at', 'time_spent_hours']


@admin.register(DelegationRule)
class DelegationRuleAdmin(admin.ModelAdmin):
    list_display = ['delegator', 'delegate_to', 'module', 'valid_from', 'valid_to', 'is_active', 'is_currently_active']
    list_filter = ['is_active', 'module']
    search_fields = ['delegator__username', 'delegate_to__username', 'reason']



================================================
FILE: backend/workflow/apps.py
================================================
from django.apps import AppConfig


class WorkflowConfig(AppConfig):
    name = 'workflow'
    default_auto_field = 'django.db.models.BigAutoField'
    
    def ready(self):
        """Connect workflow signals when app is ready."""
        from . import signals
        signals.connect_signals()



================================================
FILE: backend/workflow/engine.py
================================================
"""
Workflow Engine Service

State-machine based workflow processor for handling document approvals.
Supports starting, forwarding, reverting, and completing workflows.
"""
from django.db import transaction
from django.db.models import Q
from django.utils import timezone
from datetime import timedelta
from typing import Optional, List, Dict, Any
import logging

from .models import (
    WorkflowTemplate, WorkflowStep, WorkflowTriggerRule,
    WorkflowInstance, WorkflowAuditLog, DelegationRule,
    WorkflowModule, WorkflowStatus, AuditAction
)

logger = logging.getLogger(__name__)


class WorkflowEngine:
    """
    State-machine based workflow processor.
    
    Handles the complete lifecycle of document approval workflows:
    - Starting a workflow based on trigger rules
    - Forwarding to next step
    - Reverting to previous step
    - Rejecting workflows
    - Completing workflows
    - Calculating TAT (Turn Around Time)
    """
    
    @transaction.atomic
    def start_workflow(
        self,
        entity_type: str,
        entity_id: str,
        entity: Any,
        user,
        module: str = None
    ) -> Optional[WorkflowInstance]:
        """
        Start a new workflow for an entity.
        
        1. Determine module from entity type if not provided
        2. Evaluate trigger rules to find matching template
        3. Create WorkflowInstance
        4. Set current_step to Step 1
        5. Create audit log entry
        
        Args:
            entity_type: Model name (e.g., "RABill")
            entity_id: Primary key of the document
            entity: The actual model instance for rule evaluation
            user: User initiating the workflow
            module: Optional module override
            
        Returns:
            WorkflowInstance or None if no matching template
        """
        # Map entity types to modules
        if not module:
            module = self._get_module_for_entity(entity_type)
        
        if not module:
            logger.warning(f"No module mapping for entity type: {entity_type}")
            return None
        
        # Find matching template via trigger rules
        template = self._find_matching_template(module, entity)
        
        if not template:
            logger.warning(f"No workflow template found for {entity_type} with module {module}")
            return None
        
        # Get first step
        first_step = template.get_first_step()
        if not first_step:
            logger.error(f"Template {template.name} has no steps defined")
            return None
        
        # Check for existing active workflow
        existing = WorkflowInstance.objects.filter(
            entity_type=entity_type,
            entity_id=entity_id,
            status__in=[WorkflowStatus.PENDING, WorkflowStatus.IN_PROGRESS]
        ).first()
        
        if existing:
            logger.info(f"Active workflow already exists for {entity_type} {entity_id}")
            return existing
        
        # Create workflow instance
        instance = WorkflowInstance.objects.create(
            template=template,
            entity_type=entity_type,
            entity_id=entity_id,
            current_step=first_step,
            status=WorkflowStatus.IN_PROGRESS,
            started_by=user
        )
        
        # Create audit log
        WorkflowAuditLog.objects.create(
            instance=instance,
            step=first_step,
            action=AuditAction.STARTED,
            performed_by=user,
            remarks=f"Workflow started: {template.name}",
            to_step=first_step.sequence
        )
        
        logger.info(f"Started workflow {instance.id} for {entity_type} {entity_id}")
        return instance
    
    @transaction.atomic
    def forward(
        self,
        instance: WorkflowInstance,
        user,
        remarks: str = ""
    ) -> Dict[str, Any]:
        """
        Forward workflow to next step.
        
        1. Validate user can act on current step
        2. Log audit entry with timestamps
        3. Move to next step (or complete if last)
        4. Return result
        """
        if not self._can_user_act(instance, user):
            return {
                'success': False,
                'error': 'You are not authorized to act on this workflow step'
            }
        
        current_step = instance.current_step
        if not current_step:
            return {'success': False, 'error': 'No current step found'}
        
        # Check if remarks required
        if current_step.remarks_required and not remarks.strip():
            return {'success': False, 'error': 'Remarks are required for this step'}
        
        # Close current step audit log
        current_log = WorkflowAuditLog.objects.filter(
            instance=instance,
            step=current_step,
            exited_at__isnull=True
        ).order_by('-entered_at').first()
        
        if current_log:
            current_log.exited_at = timezone.now()
            current_log.save()
        
        # Get next step
        next_step = current_step.get_next_step()
        
        if next_step:
            # Move to next step
            instance.current_step = next_step
            instance.status = WorkflowStatus.IN_PROGRESS
            instance.save()
            
            # Create new audit log
            WorkflowAuditLog.objects.create(
                instance=instance,
                step=next_step,
                action=AuditAction.FORWARD,
                performed_by=user,
                remarks=remarks,
                from_step=current_step.sequence,
                to_step=next_step.sequence
            )
            
            return {
                'success': True,
                'message': f'Forwarded to Step {next_step.sequence}',
                'next_step': next_step,
                'is_complete': False
            }
        else:
            # This was the last step - complete the workflow
            instance.current_step = None
            instance.status = WorkflowStatus.COMPLETED
            instance.completed_at = timezone.now()
            instance.save()
            
            WorkflowAuditLog.objects.create(
                instance=instance,
                step=current_step,
                action=AuditAction.COMPLETE,
                performed_by=user,
                remarks=remarks or "Workflow completed",
                from_step=current_step.sequence
            )
            
            return {
                'success': True,
                'message': 'Workflow completed successfully',
                'is_complete': True
            }
    
    @transaction.atomic
    def revert(
        self,
        instance: WorkflowInstance,
        to_step_sequence: int,
        user,
        remarks: str = ""
    ) -> Dict[str, Any]:
        """
        Revert workflow to a previous step for clarification.
        """
        if not self._can_user_act(instance, user):
            return {
                'success': False,
                'error': 'You are not authorized to act on this workflow step'
            }
        
        current_step = instance.current_step
        if not current_step:
            return {'success': False, 'error': 'No current step found'}
        
        if to_step_sequence >= current_step.sequence:
            return {'success': False, 'error': 'Can only revert to earlier steps'}
        
        # Find target step
        target_step = instance.template.get_step_by_sequence(to_step_sequence)
        if not target_step:
            return {'success': False, 'error': f'Step {to_step_sequence} not found'}
        
        if not current_step.can_revert:
            return {'success': False, 'error': 'Current step does not allow reversion'}
        
        # Close current audit log
        current_log = WorkflowAuditLog.objects.filter(
            instance=instance,
            step=current_step,
            exited_at__isnull=True
        ).order_by('-entered_at').first()
        
        if current_log:
            current_log.exited_at = timezone.now()
            current_log.save()
        
        # Update instance
        instance.current_step = target_step
        instance.status = WorkflowStatus.REVERTED
        instance.save()
        
        # Create revert audit log
        WorkflowAuditLog.objects.create(
            instance=instance,
            step=target_step,
            action=AuditAction.REVERT,
            performed_by=user,
            remarks=remarks or "Reverted for clarification",
            from_step=current_step.sequence,
            to_step=to_step_sequence
        )
        
        return {
            'success': True,
            'message': f'Reverted to Step {to_step_sequence}',
            'target_step': target_step
        }
    
    @transaction.atomic
    def reject(
        self,
        instance: WorkflowInstance,
        user,
        remarks: str = ""
    ) -> Dict[str, Any]:
        """
        Reject the workflow entirely.
        """
        if not self._can_user_act(instance, user):
            return {
                'success': False,
                'error': 'You are not authorized to act on this workflow step'
            }
        
        current_step = instance.current_step
        
        # Close current audit log
        current_log = WorkflowAuditLog.objects.filter(
            instance=instance,
            step=current_step,
            exited_at__isnull=True
        ).order_by('-entered_at').first()
        
        if current_log:
            current_log.exited_at = timezone.now()
            current_log.save()
        
        # Update instance
        instance.status = WorkflowStatus.REJECTED
        instance.completed_at = timezone.now()
        instance.save()
        
        # Create reject audit log
        WorkflowAuditLog.objects.create(
            instance=instance,
            step=current_step,
            action=AuditAction.REJECT,
            performed_by=user,
            remarks=remarks or "Workflow rejected"
        )
        
        return {
            'success': True,
            'message': 'Workflow rejected'
        }
    
    def get_pending_for_user(self, user) -> List[WorkflowInstance]:
        """
        Get all pending workflow instances for a user.
        
        Considers:
        - User's role
        - Active delegations to user
        - Direct assignments
        """
        user_role = getattr(user, 'role', None)
        
        # Find pending instances for user's role
        role_instances = Q()
        if user_role:
            role_instances = Q(
                current_step__role=user_role,
                status__in=[WorkflowStatus.IN_PROGRESS, WorkflowStatus.REVERTED]
            )
        
        # Find direct assignments
        direct_assignments = Q(
            assigned_to=user,
            status__in=[WorkflowStatus.IN_PROGRESS, WorkflowStatus.REVERTED]
        )
        
        # Find delegated items
        delegated = Q()
        active_delegations = DelegationRule.objects.filter(
            delegate_to=user,
            is_active=True,
            valid_from__lte=timezone.now(),
            valid_to__gte=timezone.now()
        )
        
        for delegation in active_delegations:
            delegator_role = getattr(delegation.delegator, 'role', None)
            if delegator_role:
                if delegation.module:
                    delegated |= Q(
                        current_step__role=delegator_role,
                        template__module=delegation.module,
                        status__in=[WorkflowStatus.IN_PROGRESS, WorkflowStatus.REVERTED]
                    )
                else:
                    delegated |= Q(
                        current_step__role=delegator_role,
                        status__in=[WorkflowStatus.IN_PROGRESS, WorkflowStatus.REVERTED]
                    )
        
        return WorkflowInstance.objects.filter(
            role_instances | direct_assignments | delegated
        ).select_related('template', 'current_step').distinct()
    
    def get_workflow_history(self, instance: WorkflowInstance) -> List[Dict[str, Any]]:
        """
        Get complete audit history for a workflow instance.
        """
        logs = instance.audit_logs.select_related('step', 'performed_by').order_by('entered_at')
        
        history = []
        for log in logs:
            history.append({
                'id': str(log.id),
                'action': log.action,
                'action_display': log.get_action_display(),
                'step': log.step.sequence if log.step else None,
                'step_label': str(log.step) if log.step else None,
                'performed_by': log.performed_by.get_full_name() if log.performed_by else 'System',
                'performed_by_id': str(log.performed_by.id) if log.performed_by else None,
                'remarks': log.remarks,
                'entered_at': log.entered_at.isoformat(),
                'exited_at': log.exited_at.isoformat() if log.exited_at else None,
                'time_spent_hours': log.time_spent_hours,
                'from_step': log.from_step,
                'to_step': log.to_step
            })
        
        return history
    
    def calculate_tat(self, instance: WorkflowInstance) -> Dict[str, Any]:
        """
        Calculate turnaround time statistics for a workflow.
        """
        logs = instance.audit_logs.filter(
            time_spent_hours__isnull=False
        ).order_by('entered_at')
        
        step_times = {}
        total_hours = 0
        
        for log in logs:
            step_key = f"step_{log.step.sequence}" if log.step else "unknown"
            if step_key not in step_times:
                step_times[step_key] = {
                    'step_sequence': log.step.sequence if log.step else None,
                    'step_label': str(log.step) if log.step else 'Unknown',
                    'total_hours': 0,
                    'iterations': 0
                }
            step_times[step_key]['total_hours'] += log.time_spent_hours
            step_times[step_key]['iterations'] += 1
            total_hours += log.time_spent_hours
        
        # Calculate elapsed time from start
        elapsed = None
        if instance.started_at:
            end_time = instance.completed_at or timezone.now()
            elapsed = (end_time - instance.started_at).total_seconds() / 3600
        
        return {
            'total_hours': total_hours,
            'elapsed_hours': elapsed,
            'step_breakdown': list(step_times.values()),
            'average_per_step': total_hours / len(step_times) if step_times else 0,
            'is_complete': instance.is_complete
        }
    
    def _can_user_act(self, instance: WorkflowInstance, user) -> bool:
        """
        Check if user can act on the current workflow step.
        """
        if not instance.current_step:
            return False
        
        # Check direct assignment
        if instance.assigned_to == user:
            return True
        
        # Check role match - compare user role with step role
        user_role = getattr(user, 'role', None)
        step_role = instance.current_step.role
        
        if user_role and step_role and user_role == step_role:
            return True
        
        # Check delegations
        active_delegations = DelegationRule.objects.filter(
            delegate_to=user,
            is_active=True,
            valid_from__lte=timezone.now(),
            valid_to__gte=timezone.now()
        )
        
        for delegation in active_delegations:
            delegator_role = getattr(delegation.delegator, 'role', None)
            if delegator_role and step_role and delegator_role == step_role:
                # Check module filter
                if delegation.module:
                    if instance.template.module == delegation.module:
                        return True
                else:
                    return True
        
        # Check if user is superuser/admin
        if hasattr(user, 'is_superuser') and user.is_superuser:
            return True
        
        return False
    
    def _get_module_for_entity(self, entity_type: str) -> Optional[str]:
        """
        Map entity type to workflow module.
        """
        mapping = {
            'RABill': WorkflowModule.RA_BILL,
            'Tender': WorkflowModule.TENDER,
            'Design': WorkflowModule.DESIGN,
            'Variation': WorkflowModule.VARIATION,
            'VariationOrder': WorkflowModule.VARIATION,
            'Contract': WorkflowModule.CONTRACT,
            'BOQItem': WorkflowModule.BOQ,
            'Risk': WorkflowModule.RISK,
        }
        return mapping.get(entity_type)
    
    def _find_matching_template(self, module: str, entity: Any) -> Optional[WorkflowTemplate]:
        """
        Find the appropriate workflow template using trigger rules.
        
        Rules are evaluated in priority order.
        Falls back to default template if no rules match.
        """
        # Get active trigger rules for this module, ordered by priority
        rules = WorkflowTriggerRule.objects.filter(
            module=module,
            is_active=True
        ).select_related('template').order_by('priority')
        
        # Evaluate each rule
        for rule in rules:
            if rule.template.is_active and rule.evaluate(entity):
                logger.info(f"Matched trigger rule: {rule.name}")
                return rule.template
        
        # Fall back to default template
        default = WorkflowTemplate.objects.filter(
            module=module,
            is_active=True,
            is_default=True
        ).first()
        
        if default:
            logger.info(f"Using default template: {default.name}")
            return default
        
        # Return any active template as last resort
        any_template = WorkflowTemplate.objects.filter(
            module=module,
            is_active=True
        ).first()
        
        return any_template


# Singleton instance
workflow_engine = WorkflowEngine()



================================================
FILE: backend/workflow/models.py
================================================
"""
Dynamic Workflow Engine Models

State-machine based approval workflow system for government PMIS.
Supports RA Bills, Tenders, Designs, and Variations with configurable
multi-step approval chains.

Schema:
- WorkflowTemplate: Defines a reusable workflow (e.g., "High Value Bill Approval")
- WorkflowStep: Individual steps in a template with role assignments
- WorkflowTriggerRule: Conditions that determine which template to use
- WorkflowInstance: Active workflow for a specific document
- WorkflowAuditLog: Complete audit trail with timestamps
- DelegationRule: Temporary delegation of approval authority
"""
import uuid
from django.db import models
from django.conf import settings
from django.utils import timezone
from django.core.validators import MinValueValidator


class WorkflowModule(models.TextChoices):
    """Modules that support workflows."""
    RA_BILL = 'RA_BILL', 'RA Bill'
    TENDER = 'TENDER', 'Tender'
    DESIGN = 'DESIGN', 'Design Document'
    VARIATION = 'VARIATION', 'Variation Order'
    CONTRACT = 'CONTRACT', 'Contract'
    BOQ = 'BOQ', 'BOQ Item'
    RISK = 'RISK', 'Risk'


class ActionType(models.TextChoices):
    """Types of actions at each workflow step."""
    VERIFY = 'VERIFY', 'Verify & Check'
    RECOMMEND = 'RECOMMEND', 'Recommend'
    APPROVE = 'APPROVE', 'Approve'
    SANCTION = 'SANCTION', 'Sanction'
    REVIEW = 'REVIEW', 'Review'


class WorkflowStatus(models.TextChoices):
    """Status of a workflow instance."""
    PENDING = 'PENDING', 'Pending'
    IN_PROGRESS = 'IN_PROGRESS', 'In Progress'
    COMPLETED = 'COMPLETED', 'Completed'
    REJECTED = 'REJECTED', 'Rejected'
    REVERTED = 'REVERTED', 'Reverted for Clarification'
    CANCELLED = 'CANCELLED', 'Cancelled'


class AuditAction(models.TextChoices):
    """Actions recorded in audit log."""
    STARTED = 'STARTED', 'Workflow Started'
    FORWARD = 'FORWARD', 'Forwarded to Next Step'
    REVERT = 'REVERT', 'Reverted to Previous Step'
    REJECT = 'REJECT', 'Rejected'
    COMPLETE = 'COMPLETE', 'Workflow Completed'
    DELEGATE = 'DELEGATE', 'Delegated'
    ESCALATE = 'ESCALATE', 'Escalated'


class ConditionOperator(models.TextChoices):
    """Operators for trigger rule conditions."""
    GT = 'GT', 'Greater Than'
    GTE = 'GTE', 'Greater Than or Equal'
    LT = 'LT', 'Less Than'
    LTE = 'LTE', 'Less Than or Equal'
    EQ = 'EQ', 'Equals'
    NEQ = 'NEQ', 'Not Equals'
    IN = 'IN', 'In List'
    NOT_IN = 'NOT_IN', 'Not In List'
    CONTAINS = 'CONTAINS', 'Contains'


class WorkflowTemplate(models.Model):
    """
    Defines a reusable workflow template.
    
    Example: "High Value Bill Approval" for bills > 50 Lakhs
    with steps: AE Verify â†’ EE Recommend â†’ SE Approve â†’ CE Sanction
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    name = models.CharField(max_length=200)
    module = models.CharField(max_length=20, choices=WorkflowModule.choices)
    description = models.TextField(blank=True)
    
    # Template settings
    is_active = models.BooleanField(default=True)
    is_default = models.BooleanField(default=False, help_text='Use as fallback if no trigger rules match')
    
    # Metadata
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='created_workflow_templates'
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['module', 'name']
        verbose_name = 'Workflow Template'
        verbose_name_plural = 'Workflow Templates'
    
    def __str__(self):
        return f"{self.name} ({self.get_module_display()})"
    
    @property
    def step_count(self):
        return self.steps.count()
    
    def get_first_step(self):
        return self.steps.order_by('sequence').first()
    
    def get_step_by_sequence(self, sequence):
        return self.steps.filter(sequence=sequence).first()


class WorkflowStep(models.Model):
    """
    Individual step in a workflow template.
    
    Each step is assigned to a role and has an action type.
    Steps are executed in sequence order.
    """
    # Role choices - matches User.Roles from users app
    class StepRole(models.TextChoices):
        SPV_OFFICIAL = 'SPV_Official', 'SPV Official'
        PMNC_TEAM = 'PMNC_Team', 'PMNC Team'
        EPC_CONTRACTOR = 'EPC_Contractor', 'EPC Contractor'
        CONSULTANT_DESIGN = 'Consultant_Design', 'Design Consultant'
        GOVT_DEPARTMENT = 'Govt_Department', 'Government Department'
        NICDC_HQ = 'NICDC_HQ', 'NICDC HQ'
        # Common government hierarchy
        AE = 'AE', 'Assistant Engineer'
        EE = 'EE', 'Executive Engineer'
        SE = 'SE', 'Superintending Engineer'
        CE = 'CE', 'Chief Engineer'
        HOD = 'HOD', 'Head of Department'
        DGM = 'DGM', 'Deputy General Manager'
        GM = 'GM', 'General Manager'
        MD = 'MD', 'Managing Director'
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    template = models.ForeignKey(
        WorkflowTemplate,
        on_delete=models.CASCADE,
        related_name='steps'
    )
    sequence = models.PositiveIntegerField(
        validators=[MinValueValidator(1)],
        help_text='Step order (1, 2, 3...)'
    )
    
    # Who handles this step
    role = models.CharField(
        max_length=50,
        choices=StepRole.choices,
        help_text='Role responsible for this step (e.g., AE, EE, SE, CE)'
    )
    
    # What action is performed
    action_type = models.CharField(max_length=20, choices=ActionType.choices)
    action_label = models.CharField(
        max_length=100,
        blank=True,
        help_text='Custom label like "Measure & Verify" or "Technical Sanction"'
    )
    
    # Step configuration
    can_revert = models.BooleanField(
        default=True,
        help_text='Allow reverting to previous step for clarification'
    )
    deadline_days = models.PositiveIntegerField(
        default=3,
        help_text='SLA in working days'
    )
    
    # Optional: require remarks
    remarks_required = models.BooleanField(default=False)
    
    class Meta:
        ordering = ['template', 'sequence']
        unique_together = ['template', 'sequence']
        verbose_name = 'Workflow Step'
        verbose_name_plural = 'Workflow Steps'
    
    def __str__(self):
        label = self.action_label or self.get_action_type_display()
        return f"Step {self.sequence}: {label} ({self.get_role_display()})"
    
    @property
    def is_first_step(self):
        return self.sequence == 1
    
    @property
    def is_last_step(self):
        return not self.template.steps.filter(sequence__gt=self.sequence).exists()
    
    def get_next_step(self):
        return self.template.steps.filter(sequence__gt=self.sequence).order_by('sequence').first()
    
    def get_previous_step(self):
        return self.template.steps.filter(sequence__lt=self.sequence).order_by('-sequence').first()


class WorkflowTriggerRule(models.Model):
    """
    Conditions that determine which workflow template to use.
    
    Example: If RA Bill amount > 50 Lakhs, use "High Value Bill Approval" template.
    Rules are evaluated in priority order (lower = first).
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    name = models.CharField(max_length=200)
    module = models.CharField(max_length=20, choices=WorkflowModule.choices)
    
    # Condition definition
    condition_field = models.CharField(
        max_length=100,
        help_text='Field to evaluate (e.g., "amount", "type", "project.category")'
    )
    condition_operator = models.CharField(max_length=20, choices=ConditionOperator.choices)
    condition_value = models.CharField(
        max_length=500,
        help_text='Value to compare against (use comma-separated for IN/NOT_IN)'
    )
    
    # Complex logic support (JSONField for advanced conditions)
    logic_criteria = models.JSONField(
        null=True,
        blank=True,
        help_text='Advanced JSON logic for complex conditions'
    )
    
    # Template to use if condition matches
    template = models.ForeignKey(
        WorkflowTemplate,
        on_delete=models.CASCADE,
        related_name='trigger_rules'
    )
    
    # Evaluation order
    priority = models.PositiveIntegerField(
        default=100,
        help_text='Lower priority = evaluated first'
    )
    is_active = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['module', 'priority']
        verbose_name = 'Workflow Trigger Rule'
        verbose_name_plural = 'Workflow Trigger Rules'
    
    def __str__(self):
        return f"{self.name}: {self.condition_field} {self.condition_operator} {self.condition_value}"
    
    def evaluate(self, entity) -> bool:
        """
        Evaluate if this rule matches the given entity.
        """
        try:
            # Navigate nested fields (e.g., "project.category")
            value = self._get_field_value(entity, self.condition_field)
            condition_val = self.condition_value
            
            if self.condition_operator == 'GT':
                return float(value) > float(condition_val)
            elif self.condition_operator == 'GTE':
                return float(value) >= float(condition_val)
            elif self.condition_operator == 'LT':
                return float(value) < float(condition_val)
            elif self.condition_operator == 'LTE':
                return float(value) <= float(condition_val)
            elif self.condition_operator == 'EQ':
                return str(value) == str(condition_val)
            elif self.condition_operator == 'NEQ':
                return str(value) != str(condition_val)
            elif self.condition_operator == 'IN':
                values = [v.strip() for v in condition_val.split(',')]
                return str(value) in values
            elif self.condition_operator == 'NOT_IN':
                values = [v.strip() for v in condition_val.split(',')]
                return str(value) not in values
            elif self.condition_operator == 'CONTAINS':
                return str(condition_val).lower() in str(value).lower()
            
            return False
        except (AttributeError, ValueError, TypeError):
            return False
    
    def _get_field_value(self, entity, field_path: str):
        """Get nested field value from entity."""
        parts = field_path.split('.')
        value = entity
        for part in parts:
            if hasattr(value, part):
                value = getattr(value, part)
            elif isinstance(value, dict):
                value = value.get(part)
            else:
                return None
        return value


class WorkflowInstance(models.Model):
    """
    Active workflow for a specific document.
    
    Tracks which document is going through which workflow,
    what the current step is, and the overall status.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    template = models.ForeignKey(
        WorkflowTemplate,
        on_delete=models.PROTECT,
        related_name='instances'
    )
    
    # What document this workflow is for
    entity_type = models.CharField(
        max_length=50,
        help_text='Model name (e.g., "RABill", "Tender")'
    )
    entity_id = models.UUIDField(help_text='Primary key of the document')
    
    # Current state
    current_step = models.ForeignKey(
        WorkflowStep,
        on_delete=models.SET_NULL,
        null=True,
        related_name='current_instances'
    )
    status = models.CharField(
        max_length=20,
        choices=WorkflowStatus.choices,
        default=WorkflowStatus.PENDING
    )
    
    # Assigned user (if specific assignment rather than role-based)
    assigned_to = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='assigned_workflows'
    )
    
    # Timestamps
    started_at = models.DateTimeField(auto_now_add=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    
    # Initiator
    started_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='workflow_initiated'
    )
    
    class Meta:
        ordering = ['-started_at']
        verbose_name = 'Workflow Instance'
        verbose_name_plural = 'Workflow Instances'
        indexes = [
            models.Index(fields=['entity_type', 'entity_id']),
            models.Index(fields=['status']),
            models.Index(fields=['current_step']),
        ]
    
    def __str__(self):
        return f"{self.entity_type} #{str(self.entity_id)[:8]} - {self.template.name}"
    
    @property
    def is_complete(self):
        return self.status == WorkflowStatus.COMPLETED
    
    @property
    def is_pending(self):
        return self.status in [WorkflowStatus.PENDING, WorkflowStatus.IN_PROGRESS]
    
    @property
    def current_step_number(self):
        return self.current_step.sequence if self.current_step else 0
    
    @property
    def total_steps(self):
        return self.template.step_count
    
    @property
    def progress_percent(self):
        if self.is_complete:
            return 100
        if self.total_steps == 0:
            return 0
        return int((self.current_step_number / self.total_steps) * 100)
    
    def get_sla_deadline(self):
        """Calculate deadline based on current step SLA."""
        if not self.current_step:
            return None
        from datetime import timedelta
        last_log = self.audit_logs.filter(step=self.current_step).order_by('-entered_at').first()
        if last_log:
            return last_log.entered_at + timedelta(days=self.current_step.deadline_days)
        return None
    
    def is_overdue(self):
        """Check if current step has breached SLA."""
        deadline = self.get_sla_deadline()
        if deadline:
            return timezone.now() > deadline
        return False


class WorkflowAuditLog(models.Model):
    """
    Complete audit trail for workflow actions.
    
    Records every action taken on a workflow instance,
    including who did it, when, and how long it took.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    instance = models.ForeignKey(
        WorkflowInstance,
        on_delete=models.CASCADE,
        related_name='audit_logs'
    )
    step = models.ForeignKey(
        WorkflowStep,
        on_delete=models.SET_NULL,
        null=True,
        related_name='audit_logs'
    )
    
    # Action details
    action = models.CharField(max_length=20, choices=AuditAction.choices)
    performed_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='workflow_actions'
    )
    remarks = models.TextField(blank=True)
    
    # Timing for TAT calculation
    entered_at = models.DateTimeField(default=timezone.now)
    exited_at = models.DateTimeField(null=True, blank=True)
    time_spent_hours = models.FloatField(null=True, blank=True)
    
    # Additional context
    from_step = models.PositiveIntegerField(null=True, blank=True)
    to_step = models.PositiveIntegerField(null=True, blank=True)
    metadata = models.JSONField(null=True, blank=True)
    
    class Meta:
        ordering = ['-entered_at']
        verbose_name = 'Workflow Audit Log'
        verbose_name_plural = 'Workflow Audit Logs'
    
    def __str__(self):
        return f"{self.get_action_display()} by {self.performed_by} on {self.entered_at.strftime('%Y-%m-%d %H:%M')}"
    
    def save(self, *args, **kwargs):
        # Auto-calculate time spent if exited_at is set
        if self.exited_at and self.entered_at:
            delta = self.exited_at - self.entered_at
            self.time_spent_hours = delta.total_seconds() / 3600
        super().save(*args, **kwargs)


class DelegationRule(models.Model):
    """
    Temporary delegation of approval authority.
    
    Allows a user to delegate their workflow responsibilities
    to another user for a specific time period (e.g., leave).
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Who is delegating and to whom
    delegator = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='delegations_given'
    )
    delegate_to = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='delegations_received'
    )
    
    # Validity period
    valid_from = models.DateTimeField()
    valid_to = models.DateTimeField()
    
    # Optional: limit to specific module
    module = models.CharField(
        max_length=20,
        choices=WorkflowModule.choices,
        null=True,
        blank=True,
        help_text='Leave empty to delegate all modules'
    )
    
    is_active = models.BooleanField(default=True)
    reason = models.CharField(max_length=500, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['-valid_from']
        verbose_name = 'Delegation Rule'
        verbose_name_plural = 'Delegation Rules'
    
    def __str__(self):
        return f"{self.delegator} â†’ {self.delegate_to} ({self.valid_from.date()} to {self.valid_to.date()})"
    
    @property
    def is_currently_active(self):
        now = timezone.now()
        return self.is_active and self.valid_from <= now <= self.valid_to



================================================
FILE: backend/workflow/serializers.py
================================================
"""
Workflow API Serializers
"""
from rest_framework import serializers
from .models import (
    WorkflowTemplate, WorkflowStep, WorkflowTriggerRule,
    WorkflowInstance, WorkflowAuditLog, DelegationRule
)


class WorkflowStepSerializer(serializers.ModelSerializer):
    role_name = serializers.CharField(source='get_role_display', read_only=True)
    action_type_display = serializers.CharField(source='get_action_type_display', read_only=True)
    
    class Meta:
        model = WorkflowStep
        fields = [
            'id', 'sequence', 'role', 'role_name', 'action_type', 
            'action_type_display', 'action_label', 'can_revert', 
            'deadline_days', 'remarks_required', 'is_first_step', 'is_last_step'
        ]


class WorkflowTemplateListSerializer(serializers.ModelSerializer):
    module_display = serializers.CharField(source='get_module_display', read_only=True)
    step_count = serializers.IntegerField(read_only=True)
    created_by_name = serializers.CharField(source='created_by.get_full_name', read_only=True)
    
    class Meta:
        model = WorkflowTemplate
        fields = [
            'id', 'name', 'module', 'module_display', 'description',
            'is_active', 'is_default', 'step_count', 'created_by_name',
            'created_at', 'updated_at'
        ]


class WorkflowTemplateDetailSerializer(serializers.ModelSerializer):
    module_display = serializers.CharField(source='get_module_display', read_only=True)
    steps = WorkflowStepSerializer(many=True, read_only=True)
    created_by_name = serializers.CharField(source='created_by.get_full_name', read_only=True)
    
    class Meta:
        model = WorkflowTemplate
        fields = [
            'id', 'name', 'module', 'module_display', 'description',
            'is_active', 'is_default', 'steps', 'created_by_name',
            'created_at', 'updated_at'
        ]


class WorkflowTriggerRuleSerializer(serializers.ModelSerializer):
    module_display = serializers.CharField(source='get_module_display', read_only=True)
    operator_display = serializers.CharField(source='get_condition_operator_display', read_only=True)
    template_name = serializers.CharField(source='template.name', read_only=True)
    
    class Meta:
        model = WorkflowTriggerRule
        fields = [
            'id', 'name', 'module', 'module_display', 'condition_field',
            'condition_operator', 'operator_display', 'condition_value',
            'logic_criteria', 'template', 'template_name', 'priority', 
            'is_active', 'created_at'
        ]


class WorkflowAuditLogSerializer(serializers.ModelSerializer):
    action_display = serializers.CharField(source='get_action_display', read_only=True)
    step_label = serializers.SerializerMethodField()
    performed_by_name = serializers.CharField(source='performed_by.get_full_name', read_only=True)
    
    class Meta:
        model = WorkflowAuditLog
        fields = [
            'id', 'action', 'action_display', 'step', 'step_label',
            'performed_by', 'performed_by_name', 'remarks',
            'entered_at', 'exited_at', 'time_spent_hours',
            'from_step', 'to_step'
        ]
    
    def get_step_label(self, obj):
        return str(obj.step) if obj.step else None


class WorkflowInstanceListSerializer(serializers.ModelSerializer):
    template_name = serializers.CharField(source='template.name', read_only=True)
    module = serializers.CharField(source='template.module', read_only=True)
    module_display = serializers.CharField(source='template.get_module_display', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    current_step_label = serializers.SerializerMethodField()
    current_step_role = serializers.SerializerMethodField()
    started_by_name = serializers.CharField(source='started_by.get_full_name', read_only=True)
    is_overdue = serializers.BooleanField(read_only=True)
    progress_percent = serializers.IntegerField(read_only=True)
    sla_deadline = serializers.SerializerMethodField()
    
    class Meta:
        model = WorkflowInstance
        fields = [
            'id', 'template', 'template_name', 'module', 'module_display',
            'entity_type', 'entity_id', 'current_step', 'current_step_label',
            'current_step_role', 'status', 'status_display', 'progress_percent',
            'is_overdue', 'sla_deadline', 'started_at', 'completed_at',
            'started_by_name'
        ]
    
    def get_current_step_label(self, obj):
        return str(obj.current_step) if obj.current_step else 'Completed'
    
    def get_current_step_role(self, obj):
        if obj.current_step:
            return obj.current_step.get_role_display()
        return None
    
    def get_sla_deadline(self, obj):
        deadline = obj.get_sla_deadline()
        return deadline.isoformat() if deadline else None


class WorkflowInstanceDetailSerializer(WorkflowInstanceListSerializer):
    template = WorkflowTemplateDetailSerializer(read_only=True)
    audit_logs = WorkflowAuditLogSerializer(many=True, read_only=True)
    
    class Meta(WorkflowInstanceListSerializer.Meta):
        fields = WorkflowInstanceListSerializer.Meta.fields + ['template', 'audit_logs']


class DelegationRuleSerializer(serializers.ModelSerializer):
    delegator_name = serializers.CharField(source='delegator.get_full_name', read_only=True)
    delegate_to_name = serializers.CharField(source='delegate_to.get_full_name', read_only=True)
    module_display = serializers.CharField(source='get_module_display', read_only=True)
    is_currently_active = serializers.BooleanField(read_only=True)
    
    class Meta:
        model = DelegationRule
        fields = [
            'id', 'delegator', 'delegator_name', 'delegate_to', 'delegate_to_name',
            'valid_from', 'valid_to', 'module', 'module_display',
            'is_active', 'is_currently_active', 'reason', 'created_at'
        ]


class WorkflowActionSerializer(serializers.Serializer):
    """Serializer for workflow actions (forward, revert, reject)."""
    remarks = serializers.CharField(required=False, allow_blank=True)
    to_step = serializers.IntegerField(required=False)  # For revert action


class StartWorkflowSerializer(serializers.Serializer):
    """Serializer for starting a workflow."""
    entity_type = serializers.CharField()
    entity_id = serializers.UUIDField()
    module = serializers.CharField(required=False)


class WorkflowActionsResponseSerializer(serializers.Serializer):
    """
    Response serializer for /actions/ endpoint.
    Provides permission flags for the current user on a specific entity.
    """
    has_workflow = serializers.BooleanField(help_text="Whether this entity has an active workflow")
    can_approve = serializers.BooleanField(help_text="User can forward/approve this step")
    can_revert = serializers.BooleanField(help_text="User can send back to previous step")
    can_reject = serializers.BooleanField(help_text="User can reject the workflow")
    current_step_label = serializers.CharField(allow_null=True, help_text="Label of current step")
    current_step_sequence = serializers.IntegerField(allow_null=True, help_text="Sequence number of current step")
    required_role = serializers.CharField(allow_null=True, help_text="Role required for current step")
    workflow_status = serializers.CharField(allow_null=True, help_text="Current workflow status")
    workflow_id = serializers.UUIDField(allow_null=True, help_text="ID of the workflow instance")
    remarks_required = serializers.BooleanField(help_text="Whether remarks are required for this step")


class PerformActionRequestSerializer(serializers.Serializer):
    """
    Request serializer for /perform-action/ endpoint.
    """
    entity_type = serializers.CharField(help_text="Model name (e.g., 'RABill', 'Tender')")
    entity_id = serializers.UUIDField(help_text="Primary key of the document")
    action = serializers.ChoiceField(
        choices=['FORWARD', 'REVERT', 'REJECT'],
        help_text="Action to perform"
    )
    remarks = serializers.CharField(
        required=False, 
        allow_blank=True,
        help_text="Remarks/comments for the action"
    )
    to_step = serializers.IntegerField(
        required=False,
        help_text="Target step sequence (required for REVERT)"
    )
    
    def validate(self, attrs):
        """Validate that REVERT actions have to_step specified."""
        if attrs.get('action') == 'REVERT' and not attrs.get('to_step'):
            raise serializers.ValidationError({
                'to_step': 'Target step is required for REVERT action'
            })
        return attrs


class EntityHistoryRequestSerializer(serializers.Serializer):
    """Request serializer for /entity-history/ endpoint."""
    entity_type = serializers.CharField(help_text="Model name (e.g., 'RABill', 'Tender')")
    entity_id = serializers.UUIDField(help_text="Primary key of the document")




================================================
FILE: backend/workflow/signals.py
================================================
"""
Workflow Signals

Auto-starts workflows when documents are submitted.
Uses lazy imports to avoid circular dependency issues.
"""
from django.db.models.signals import post_save
from django.dispatch import receiver
import logging

logger = logging.getLogger(__name__)


def start_workflow_on_submit(sender, instance, created, **kwargs):
    """
    Generic handler to start workflow when a document is submitted.
    
    Conditions:
    1. Not a new object (update only)
    2. Status is 'SUBMITTED'
    3. No active workflow exists for this entity
    """
    # Skip if newly created (status change comes later)
    if created:
        return
    
    # Check if status is SUBMITTED
    status = getattr(instance, 'status', None)
    if status != 'SUBMITTED':
        return
    
    # Lazy import to avoid circular dependency
    from .engine import workflow_engine
    from .models import WorkflowInstance, WorkflowStatus
    
    entity_type = sender.__name__
    entity_id = str(instance.pk)
    
    # Check for existing active workflow
    existing = WorkflowInstance.objects.filter(
        entity_type=entity_type,
        entity_id=entity_id,
        status__in=[WorkflowStatus.PENDING, WorkflowStatus.IN_PROGRESS, WorkflowStatus.REVERTED]
    ).exists()
    
    if existing:
        logger.info(f"Active workflow already exists for {entity_type} {entity_id}")
        return
    
    # Start workflow - get the user who triggered the change
    # Try to get user from instance attributes (set by view)
    user = getattr(instance, '_current_user', None)
    if not user:
        # Fallback to contractor for RABill
        user = getattr(instance, 'contractor', None)
        if not user:
            # Final fallback to created_by
            user = getattr(instance, 'created_by', None)
    
    if not user:
        logger.warning(f"Cannot start workflow for {entity_type} {entity_id}: No user found")
        return
    
    try:
        result = workflow_engine.start_workflow(
            entity_type=entity_type,
            entity_id=entity_id,
            entity=instance,
            user=user
        )
        if result:
            logger.info(f"Started workflow {result.id} for {entity_type} {entity_id}")
        else:
            logger.warning(f"No workflow template found for {entity_type} {entity_id}")
    except Exception as e:
        logger.error(f"Failed to start workflow for {entity_type} {entity_id}: {str(e)}")


def connect_signals():
    """
    Connect workflow signals to models.
    Called from AppConfig.ready().
    
    Uses lazy imports to avoid circular dependencies.
    """
    # Lazy import models to avoid circular dependency
    from django.apps import apps
    
    try:
        RABill = apps.get_model('finance', 'RABill')
        post_save.connect(
            start_workflow_on_submit,
            sender=RABill,
            dispatch_uid='workflow_rabill_submit'
        )
        logger.info("Connected workflow signal to RABill")
    except LookupError:
        logger.warning("RABill model not found - skipping signal connection")
    
    try:
        Tender = apps.get_model('procurement', 'Tender')
        post_save.connect(
            start_workflow_on_submit,
            sender=Tender,
            dispatch_uid='workflow_tender_submit'
        )
        logger.info("Connected workflow signal to Tender")
    except LookupError:
        logger.warning("Tender model not found - skipping signal connection")
    
    try:
        Variation = apps.get_model('procurement', 'Variation')
        post_save.connect(
            start_workflow_on_submit,
            sender=Variation,
            dispatch_uid='workflow_variation_submit'
        )
        logger.info("Connected workflow signal to Variation")
    except LookupError:
        logger.warning("Variation model not found - skipping signal connection")



================================================
FILE: backend/workflow/tests.py
================================================
from django.test import TestCase

# Create your tests here.



================================================
FILE: backend/workflow/urls.py
================================================
"""
Workflow URL Configuration
"""
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import (
    WorkflowTemplateViewSet, WorkflowStepViewSet,
    WorkflowTriggerRuleViewSet, WorkflowInstanceViewSet,
    DelegationRuleViewSet, WorkflowActionsViewSet
)

router = DefaultRouter()
router.register(r'templates', WorkflowTemplateViewSet, basename='workflow-template')
router.register(r'steps', WorkflowStepViewSet, basename='workflow-step')
router.register(r'rules', WorkflowTriggerRuleViewSet, basename='workflow-rule')
router.register(r'instances', WorkflowInstanceViewSet, basename='workflow-instance')
router.register(r'delegations', DelegationRuleViewSet, basename='delegation')
router.register(r'actions', WorkflowActionsViewSet, basename='workflow-actions')

urlpatterns = [
    path('', include(router.urls)),
]




================================================
FILE: backend/workflow/views.py
================================================
"""
Workflow API Views

Provides REST endpoints for:
- Workflow templates (CRUD + admin)
- Workflow instances (view, forward, revert, reject)
- Pending approvals for users
- Delegation management
"""
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from django.shortcuts import get_object_or_404
from django.apps import apps

from .models import (
    WorkflowTemplate, WorkflowStep, WorkflowTriggerRule,
    WorkflowInstance, WorkflowAuditLog, DelegationRule
)
from .serializers import (
    WorkflowTemplateListSerializer, WorkflowTemplateDetailSerializer,
    WorkflowStepSerializer, WorkflowTriggerRuleSerializer,
    WorkflowInstanceListSerializer, WorkflowInstanceDetailSerializer,
    WorkflowAuditLogSerializer, DelegationRuleSerializer,
    WorkflowActionSerializer, StartWorkflowSerializer,
    WorkflowActionsResponseSerializer, PerformActionRequestSerializer,
    EntityHistoryRequestSerializer
)
from .engine import workflow_engine
from .models import WorkflowStatus


class WorkflowTemplateViewSet(viewsets.ModelViewSet):
    """
    ViewSet for managing workflow templates.
    
    Only admins can create/update/delete templates.
    All authenticated users can view templates.
    """
    queryset = WorkflowTemplate.objects.all()
    permission_classes = [permissions.IsAuthenticated]
    
    def get_serializer_class(self):
        if self.action in ['retrieve']:
            return WorkflowTemplateDetailSerializer
        return WorkflowTemplateListSerializer
    
    def get_queryset(self):
        queryset = WorkflowTemplate.objects.all()
        
        # Filter by module
        module = self.request.query_params.get('module')
        if module:
            queryset = queryset.filter(module=module)
        
        # Filter by active status
        is_active = self.request.query_params.get('is_active')
        if is_active is not None:
            queryset = queryset.filter(is_active=is_active.lower() == 'true')
        
        return queryset.select_related('created_by').prefetch_related('steps')
    
    def perform_create(self, serializer):
        serializer.save(created_by=self.request.user)
    
    @action(detail=True, methods=['post'])
    def add_step(self, request, pk=None):
        """Add a step to the template."""
        template = self.get_object()
        serializer = WorkflowStepSerializer(data=request.data)
        if serializer.is_valid():
            serializer.save(template=template)
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'])
    def reorder_steps(self, request, pk=None):
        """Reorder steps in the template."""
        template = self.get_object()
        step_order = request.data.get('step_order', [])  # List of step IDs in new order
        
        for idx, step_id in enumerate(step_order, start=1):
            WorkflowStep.objects.filter(id=step_id, template=template).update(sequence=idx)
        
        return Response({'success': True, 'message': 'Steps reordered'})


class WorkflowStepViewSet(viewsets.ModelViewSet):
    """ViewSet for managing workflow steps."""
    queryset = WorkflowStep.objects.all()
    serializer_class = WorkflowStepSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        queryset = WorkflowStep.objects.select_related('template', 'role')
        template_id = self.request.query_params.get('template')
        if template_id:
            queryset = queryset.filter(template_id=template_id)
        return queryset


class WorkflowTriggerRuleViewSet(viewsets.ModelViewSet):
    """ViewSet for managing workflow trigger rules."""
    queryset = WorkflowTriggerRule.objects.all()
    serializer_class = WorkflowTriggerRuleSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        queryset = WorkflowTriggerRule.objects.select_related('template')
        module = self.request.query_params.get('module')
        if module:
            queryset = queryset.filter(module=module)
        return queryset.order_by('module', 'priority')


class WorkflowInstanceViewSet(viewsets.ModelViewSet):
    """
    ViewSet for workflow instances.
    
    Supports:
    - List all instances (with filters)
    - View instance details and history
    - Forward/Revert/Reject actions
    - Get pending items for current user
    """
    queryset = WorkflowInstance.objects.all()
    permission_classes = [permissions.IsAuthenticated]
    http_method_names = ['get', 'post']  # No update/delete for instances
    
    def get_serializer_class(self):
        if self.action in ['retrieve']:
            return WorkflowInstanceDetailSerializer
        return WorkflowInstanceListSerializer
    
    def get_queryset(self):
        queryset = WorkflowInstance.objects.select_related(
            'template', 'current_step', 'current_step__role', 'started_by'
        )
        
        # Filter by status
        status_filter = self.request.query_params.get('status')
        if status_filter:
            queryset = queryset.filter(status=status_filter)
        
        # Filter by entity type
        entity_type = self.request.query_params.get('entity_type')
        if entity_type:
            queryset = queryset.filter(entity_type=entity_type)
        
        # Filter by entity ID
        entity_id = self.request.query_params.get('entity_id')
        if entity_id:
            queryset = queryset.filter(entity_id=entity_id)
        
        return queryset
    
    @action(detail=False, methods=['get'])
    def pending(self, request):
        """Get pending workflow items for current user."""
        try:
            instances = workflow_engine.get_pending_for_user(request.user)
            serializer = WorkflowInstanceListSerializer(instances, many=True)
            return Response({
                'count': len(serializer.data),
                'results': serializer.data
            })
        except Exception as e:
            import logging
            logger = logging.getLogger(__name__)
            logger.error(f"Error fetching pending workflows: {e}")
            return Response({
                'count': 0,
                'results': [],
                'error': str(e)
            })
    
    @action(detail=False, methods=['post'])
    def start(self, request):
        """Start a new workflow for an entity."""
        serializer = StartWorkflowSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        entity_type = serializer.validated_data['entity_type']
        entity_id = serializer.validated_data['entity_id']
        module = serializer.validated_data.get('module')
        
        # Try to get the actual entity for rule evaluation
        entity = self._get_entity(entity_type, entity_id)
        if not entity:
            return Response(
                {'error': f'Entity {entity_type} with ID {entity_id} not found'},
                status=status.HTTP_404_NOT_FOUND
            )
        
        instance = workflow_engine.start_workflow(
            entity_type=entity_type,
            entity_id=str(entity_id),
            entity=entity,
            user=request.user,
            module=module
        )
        
        if instance:
            return Response(
                WorkflowInstanceDetailSerializer(instance).data,
                status=status.HTTP_201_CREATED
            )
        return Response(
            {'error': 'No matching workflow template found'},
            status=status.HTTP_400_BAD_REQUEST
        )
    
    @action(detail=True, methods=['post'])
    def forward(self, request, pk=None):
        """Forward workflow to next step."""
        instance = self.get_object()
        serializer = WorkflowActionSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        result = workflow_engine.forward(
            instance=instance,
            user=request.user,
            remarks=serializer.validated_data.get('remarks', '')
        )
        
        if result['success']:
            return Response(result)
        return Response(result, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'])
    def revert(self, request, pk=None):
        """Revert workflow to a previous step."""
        instance = self.get_object()
        serializer = WorkflowActionSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        to_step = serializer.validated_data.get('to_step')
        if not to_step:
            return Response(
                {'error': 'to_step is required for revert action'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        result = workflow_engine.revert(
            instance=instance,
            to_step_sequence=to_step,
            user=request.user,
            remarks=serializer.validated_data.get('remarks', '')
        )
        
        if result['success']:
            return Response(result)
        return Response(result, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'])
    def reject(self, request, pk=None):
        """Reject the workflow."""
        instance = self.get_object()
        serializer = WorkflowActionSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        result = workflow_engine.reject(
            instance=instance,
            user=request.user,
            remarks=serializer.validated_data.get('remarks', '')
        )
        
        if result['success']:
            return Response(result)
        return Response(result, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['get'])
    def history(self, request, pk=None):
        """Get complete audit history for a workflow."""
        instance = self.get_object()
        history = workflow_engine.get_workflow_history(instance)
        return Response({'history': history})
    
    @action(detail=True, methods=['get'])
    def tat(self, request, pk=None):
        """Get TAT (turnaround time) statistics."""
        instance = self.get_object()
        tat_data = workflow_engine.calculate_tat(instance)
        return Response(tat_data)
    
    def _get_entity(self, entity_type: str, entity_id: str):
        """Try to get the actual entity model instance."""
        model_mapping = {
            'RABill': ('finance', 'RABill'),
            'Tender': ('procurement', 'Tender'),
            'Contract': ('procurement', 'Contract'),
            'Risk': ('projects', 'Risk'),
            'BOQItem': ('finance', 'BOQItem'),
        }
        
        if entity_type not in model_mapping:
            return None
        
        app_label, model_name = model_mapping[entity_type]
        try:
            model = apps.get_model(app_label, model_name)
            return model.objects.get(pk=entity_id)
        except Exception:
            return None


class DelegationRuleViewSet(viewsets.ModelViewSet):
    """ViewSet for managing delegation rules."""
    queryset = DelegationRule.objects.all()
    serializer_class = DelegationRuleSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        queryset = DelegationRule.objects.select_related('delegator', 'delegate_to')
        
        # Users can see their own delegations
        if not self.request.user.is_superuser:
            queryset = queryset.filter(
                models.Q(delegator=self.request.user) | 
                models.Q(delegate_to=self.request.user)
            )
        
        return queryset.order_by('-valid_from')
    
    def perform_create(self, serializer):
        # Ensure user can only delegate their own authority
        if not self.request.user.is_superuser:
            serializer.save(delegator=self.request.user)
        else:
            serializer.save()
    
    @action(detail=False, methods=['get'])
    def my_delegations(self, request):
        """Get delegations given by current user."""
        delegations = DelegationRule.objects.filter(delegator=request.user)
        serializer = self.get_serializer(delegations, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def delegated_to_me(self, request):
        """Get delegations received by current user."""
        delegations = DelegationRule.objects.filter(
            delegate_to=request.user,
            is_active=True
        )
        serializer = self.get_serializer(delegations, many=True)
        return Response(serializer.data)


class WorkflowActionsViewSet(viewsets.ViewSet):
    """
    Unified API for workflow actions on any entity.
    
    Provides a single interface for the frontend to:
    - Check what actions are available for the current user
    - Perform workflow actions (forward, revert, reject)
    - Get workflow history for an entity
    
    All endpoints use entity_type and entity_id parameters
    rather than workflow instance IDs.
    """
    permission_classes = [permissions.IsAuthenticated]
    
    # Entity type to model mapping
    ENTITY_MODEL_MAP = {
        'RABill': ('finance', 'RABill'),
        'Tender': ('procurement', 'Tender'),
        'Contract': ('procurement', 'Contract'),
        'Variation': ('procurement', 'Variation'),
        'Risk': ('projects', 'Risk'),
        'BOQItem': ('finance', 'BOQItem'),
    }
    
    def _get_entity(self, entity_type: str, entity_id: str):
        """Get the entity model instance."""
        if entity_type not in self.ENTITY_MODEL_MAP:
            return None
        
        app_label, model_name = self.ENTITY_MODEL_MAP[entity_type]
        try:
            model = apps.get_model(app_label, model_name)
            return model.objects.get(pk=entity_id)
        except Exception:
            return None
    
    def _get_active_workflow(self, entity_type: str, entity_id: str):
        """Get the active workflow instance for an entity."""
        return WorkflowInstance.objects.filter(
            entity_type=entity_type,
            entity_id=str(entity_id),
            status__in=[WorkflowStatus.PENDING, WorkflowStatus.IN_PROGRESS, WorkflowStatus.REVERTED]
        ).select_related('template', 'current_step').first()
    
    @action(detail=False, methods=['get'], url_path='actions')
    def get_actions(self, request):
        """
        Check what workflow actions the current user can perform on an entity.
        
        Query Params:
            entity_type: Model name (e.g., 'RABill', 'Tender')
            entity_id: Primary key of the document
            
        Returns:
            WorkflowActionsResponseSerializer data
        """
        entity_type = request.query_params.get('entity_type')
        entity_id = request.query_params.get('entity_id')
        
        if not entity_type or not entity_id:
            return Response(
                {'error': 'entity_type and entity_id are required'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            # Get active workflow for this entity
            instance = self._get_active_workflow(entity_type, entity_id)
            
            if not instance:
                # No active workflow
                return Response({
                    'has_workflow': False,
                    'can_approve': False,
                    'can_revert': False,
                    'can_reject': False,
                    'current_step_label': None,
                    'current_step_sequence': None,
                    'required_role': None,
                    'workflow_status': None,
                    'workflow_id': None,
                    'remarks_required': False
                })
            
            # Check if user can act on this workflow
            can_act = workflow_engine._can_user_act(instance, request.user)
            current_step = instance.current_step
            
            return Response({
                'has_workflow': True,
                'can_approve': can_act,
                'can_revert': can_act and (current_step.can_revert if current_step else False),
                'can_reject': can_act,
                'current_step_label': str(current_step) if current_step else 'Completed',
                'current_step_sequence': current_step.sequence if current_step else None,
                'required_role': current_step.get_role_display() if current_step else None,
                'workflow_status': instance.status,
                'workflow_id': str(instance.id),
                'remarks_required': current_step.remarks_required if current_step else False
            })
            
        except Exception as e:
            import logging
            logger = logging.getLogger(__name__)
            logger.error(f"Error getting workflow actions: {e}")
            return Response(
                {'error': 'Failed to check workflow actions'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )
    
    @action(detail=False, methods=['post'], url_path='perform-action')
    def perform_action(self, request):
        """
        Perform a workflow action on an entity.
        
        Request Body:
            entity_type: Model name
            entity_id: Document ID
            action: 'FORWARD', 'REVERT', or 'REJECT'
            remarks: Optional comments
            to_step: Target step (required for REVERT)
        """
        serializer = PerformActionRequestSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        data = serializer.validated_data
        entity_type = data['entity_type']
        entity_id = str(data['entity_id'])
        action_type = data['action']
        remarks = data.get('remarks', '')
        to_step = data.get('to_step')
        
        try:
            # Get active workflow
            instance = self._get_active_workflow(entity_type, entity_id)
            
            if not instance:
                return Response(
                    {'success': False, 'error': 'No active workflow found for this entity'},
                    status=status.HTTP_404_NOT_FOUND
                )
            
            # Perform the requested action
            if action_type == 'FORWARD':
                result = workflow_engine.forward(
                    instance=instance,
                    user=request.user,
                    remarks=remarks
                )
            elif action_type == 'REVERT':
                result = workflow_engine.revert(
                    instance=instance,
                    to_step_sequence=to_step,
                    user=request.user,
                    remarks=remarks
                )
            elif action_type == 'REJECT':
                result = workflow_engine.reject(
                    instance=instance,
                    user=request.user,
                    remarks=remarks
                )
            else:
                return Response(
                    {'success': False, 'error': f'Unknown action: {action_type}'},
                    status=status.HTTP_400_BAD_REQUEST
                )
            
            if result.get('success'):
                return Response(result)
            return Response(result, status=status.HTTP_400_BAD_REQUEST)
            
        except Exception as e:
            import logging
            logger = logging.getLogger(__name__)
            logger.error(f"Error performing workflow action: {e}")
            return Response(
                {'success': False, 'error': 'Failed to perform workflow action'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )
    
    @action(detail=False, methods=['get'], url_path='entity-history')
    def entity_history(self, request):
        """
        Get workflow history for an entity.
        
        Query Params:
            entity_type: Model name
            entity_id: Document ID
        """
        entity_type = request.query_params.get('entity_type')
        entity_id = request.query_params.get('entity_id')
        
        if not entity_type or not entity_id:
            return Response(
                {'error': 'entity_type and entity_id are required'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            # Get all workflow instances for this entity (including completed)
            instances = WorkflowInstance.objects.filter(
                entity_type=entity_type,
                entity_id=str(entity_id)
            ).select_related('template').order_by('-started_at')
            
            if not instances.exists():
                return Response({
                    'has_history': False,
                    'workflows': []
                })
            
            # Get history for all workflows
            all_history = []
            for instance in instances:
                history = workflow_engine.get_workflow_history(instance)
                all_history.append({
                    'workflow_id': str(instance.id),
                    'template_name': instance.template.name,
                    'status': instance.status,
                    'status_display': instance.get_status_display(),
                    'started_at': instance.started_at.isoformat() if instance.started_at else None,
                    'completed_at': instance.completed_at.isoformat() if instance.completed_at else None,
                    'history': history
                })
            
            return Response({
                'has_history': True,
                'workflows': all_history
            })
            
        except Exception as e:
            import logging
            logger = logging.getLogger(__name__)
            logger.error(f"Error getting workflow history: {e}")
            return Response(
                {'error': 'Failed to get workflow history'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )




================================================
FILE: backend/workflow/management/__init__.py
================================================
# Empty init file for management commands



================================================
FILE: backend/workflow/management/commands/__init__.py
================================================
# Empty init file for management commands



================================================
FILE: backend/workflow/management/commands/seed_workflows.py
================================================
"""
Management command to seed standard Government Approval workflow templates.

Usage:
    python manage.py seed_workflows

This command is idempotent - running it multiple times will not create duplicates.
"""
from django.core.management.base import BaseCommand
from django.db import transaction

from workflow.models import (
    WorkflowTemplate, WorkflowStep, WorkflowTriggerRule,
    WorkflowModule, ActionType, ConditionOperator
)


class Command(BaseCommand):
    help = 'Seed standard Government Approval workflow templates'

    @transaction.atomic
    def handle(self, *args, **options):
        self.stdout.write(self.style.NOTICE('Seeding workflow templates...'))
        
        # 1. RA Bill Approval Template
        self.create_ra_bill_template()
        
        # 2. Tender Approval Template
        self.create_tender_template()
        
        # 3. Variation Order Template
        self.create_variation_template()
        
        self.stdout.write(self.style.SUCCESS('âœ… All workflow templates seeded successfully!'))

    def create_ra_bill_template(self):
        """Create Standard RA Bill Approval workflow."""
        template, created = WorkflowTemplate.objects.get_or_create(
            name='Standard RA Bill Approval',
            module=WorkflowModule.RA_BILL,
            defaults={
                'description': 'Standard Government hierarchy approval flow for Running Account Bills. '
                               'AE verifies â†’ EE recommends â†’ CE sanctions.',
                'is_active': True,
                'is_default': True
            }
        )
        
        if created:
            self.stdout.write(f'  âœ“ Created template: {template.name}')
            
            # Create steps
            steps = [
                {
                    'sequence': 1,
                    'role': 'AE',
                    'action_type': ActionType.VERIFY,
                    'action_label': 'Verification',
                    'can_revert': False,
                    'deadline_days': 3,
                    'remarks_required': False
                },
                {
                    'sequence': 2,
                    'role': 'EE',
                    'action_type': ActionType.RECOMMEND,
                    'action_label': 'Technical Review',
                    'can_revert': True,
                    'deadline_days': 5,
                    'remarks_required': False
                },
                {
                    'sequence': 3,
                    'role': 'CE',
                    'action_type': ActionType.APPROVE,
                    'action_label': 'Final Sanction',
                    'can_revert': True,
                    'deadline_days': 7,
                    'remarks_required': False
                }
            ]
            
            for step_data in steps:
                WorkflowStep.objects.create(template=template, **step_data)
                self.stdout.write(f'    â†’ Step {step_data["sequence"]}: {step_data["action_label"]} ({step_data["role"]})')
            
            # Create trigger rule (always active)
            WorkflowTriggerRule.objects.create(
                name='RA Bill Default Trigger',
                module=WorkflowModule.RA_BILL,
                condition_field='net_payable',
                condition_operator=ConditionOperator.GT,
                condition_value='0',
                template=template,
                priority=10,
                is_active=True
            )
            self.stdout.write('    â†’ Created trigger rule')
        else:
            self.stdout.write(f'  â—‹ Template already exists: {template.name}')
        
        return template

    def create_tender_template(self):
        """Create High Value Tender Approval workflow."""
        template, created = WorkflowTemplate.objects.get_or_create(
            name='High Value Tender Approval',
            module=WorkflowModule.TENDER,
            defaults={
                'description': 'Approval workflow for high-value tenders. '
                               'DA checks budget â†’ SE scrutinizes â†’ PD approves.',
                'is_active': True,
                'is_default': True
            }
        )
        
        if created:
            self.stdout.write(f'  âœ“ Created template: {template.name}')
            
            steps = [
                {
                    'sequence': 1,
                    'role': 'DA',
                    'action_type': ActionType.VERIFY,
                    'action_label': 'Budget Check',
                    'can_revert': False,
                    'deadline_days': 2,
                    'remarks_required': True
                },
                {
                    'sequence': 2,
                    'role': 'SE',
                    'action_type': ActionType.RECOMMEND,
                    'action_label': 'Scrutiny',
                    'can_revert': True,
                    'deadline_days': 5,
                    'remarks_required': False
                },
                {
                    'sequence': 3,
                    'role': 'PD',
                    'action_type': ActionType.APPROVE,
                    'action_label': 'Administrative Approval',
                    'can_revert': True,
                    'deadline_days': 7,
                    'remarks_required': False
                }
            ]
            
            for step_data in steps:
                WorkflowStep.objects.create(template=template, **step_data)
                self.stdout.write(f'    â†’ Step {step_data["sequence"]}: {step_data["action_label"]} ({step_data["role"]})')
            
            # Create trigger rule
            WorkflowTriggerRule.objects.create(
                name='Tender Default Trigger',
                module=WorkflowModule.TENDER,
                condition_field='estimated_value',
                condition_operator=ConditionOperator.GT,
                condition_value='0',
                template=template,
                priority=10,
                is_active=True
            )
            self.stdout.write('    â†’ Created trigger rule')
        else:
            self.stdout.write(f'  â—‹ Template already exists: {template.name}')
        
        return template

    def create_variation_template(self):
        """Create Variation Order Approval workflow."""
        template, created = WorkflowTemplate.objects.get_or_create(
            name='Variation Order Approval',
            module=WorkflowModule.VARIATION,
            defaults={
                'description': 'Approval workflow for contract variations. '
                               'EE reviews â†’ SE recommends â†’ CE approves.',
                'is_active': True,
                'is_default': True
            }
        )
        
        if created:
            self.stdout.write(f'  âœ“ Created template: {template.name}')
            
            steps = [
                {
                    'sequence': 1,
                    'role': 'EE',
                    'action_type': ActionType.REVIEW,
                    'action_label': 'Technical Review',
                    'can_revert': False,
                    'deadline_days': 5,
                    'remarks_required': True
                },
                {
                    'sequence': 2,
                    'role': 'SE',
                    'action_type': ActionType.RECOMMEND,
                    'action_label': 'Recommendation',
                    'can_revert': True,
                    'deadline_days': 5,
                    'remarks_required': False
                },
                {
                    'sequence': 3,
                    'role': 'CE',
                    'action_type': ActionType.SANCTION,
                    'action_label': 'Final Sanction',
                    'can_revert': True,
                    'deadline_days': 7,
                    'remarks_required': False
                }
            ]
            
            for step_data in steps:
                WorkflowStep.objects.create(template=template, **step_data)
                self.stdout.write(f'    â†’ Step {step_data["sequence"]}: {step_data["action_label"]} ({step_data["role"]})')
            
            # Create trigger rule
            WorkflowTriggerRule.objects.create(
                name='Variation Default Trigger',
                module=WorkflowModule.VARIATION,
                condition_field='amount',
                condition_operator=ConditionOperator.GT,
                condition_value='0',
                template=template,
                priority=10,
                is_active=True
            )
            self.stdout.write('    â†’ Created trigger rule')
        else:
            self.stdout.write(f'  â—‹ Template already exists: {template.name}')
        
        return template



================================================
FILE: backend/workflow/migrations/0001_initial.py
================================================
# Generated by Django 6.0 on 2026-01-18 19:16

import django.core.validators
import django.db.models.deletion
import django.utils.timezone
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='WorkflowStep',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('sequence', models.PositiveIntegerField(help_text='Step order (1, 2, 3...)', validators=[django.core.validators.MinValueValidator(1)])),
                ('role', models.CharField(choices=[('SPV_Official', 'SPV Official'), ('PMNC_Team', 'PMNC Team'), ('EPC_Contractor', 'EPC Contractor'), ('Consultant_Design', 'Design Consultant'), ('Govt_Department', 'Government Department'), ('NICDC_HQ', 'NICDC HQ'), ('AE', 'Assistant Engineer'), ('EE', 'Executive Engineer'), ('SE', 'Superintending Engineer'), ('CE', 'Chief Engineer'), ('HOD', 'Head of Department'), ('DGM', 'Deputy General Manager'), ('GM', 'General Manager'), ('MD', 'Managing Director')], help_text='Role responsible for this step (e.g., AE, EE, SE, CE)', max_length=50)),
                ('action_type', models.CharField(choices=[('VERIFY', 'Verify & Check'), ('RECOMMEND', 'Recommend'), ('APPROVE', 'Approve'), ('SANCTION', 'Sanction'), ('REVIEW', 'Review')], max_length=20)),
                ('action_label', models.CharField(blank=True, help_text='Custom label like "Measure & Verify" or "Technical Sanction"', max_length=100)),
                ('can_revert', models.BooleanField(default=True, help_text='Allow reverting to previous step for clarification')),
                ('deadline_days', models.PositiveIntegerField(default=3, help_text='SLA in working days')),
                ('remarks_required', models.BooleanField(default=False)),
            ],
            options={
                'verbose_name': 'Workflow Step',
                'verbose_name_plural': 'Workflow Steps',
                'ordering': ['template', 'sequence'],
            },
        ),
        migrations.CreateModel(
            name='DelegationRule',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('valid_from', models.DateTimeField()),
                ('valid_to', models.DateTimeField()),
                ('module', models.CharField(blank=True, choices=[('RA_BILL', 'RA Bill'), ('TENDER', 'Tender'), ('DESIGN', 'Design Document'), ('VARIATION', 'Variation Order'), ('CONTRACT', 'Contract'), ('BOQ', 'BOQ Item'), ('RISK', 'Risk')], help_text='Leave empty to delegate all modules', max_length=20, null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('reason', models.CharField(blank=True, max_length=500)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('delegate_to', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='delegations_received', to=settings.AUTH_USER_MODEL)),
                ('delegator', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='delegations_given', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Delegation Rule',
                'verbose_name_plural': 'Delegation Rules',
                'ordering': ['-valid_from'],
            },
        ),
        migrations.CreateModel(
            name='WorkflowInstance',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('entity_type', models.CharField(help_text='Model name (e.g., "RABill", "Tender")', max_length=50)),
                ('entity_id', models.UUIDField(help_text='Primary key of the document')),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('IN_PROGRESS', 'In Progress'), ('COMPLETED', 'Completed'), ('REJECTED', 'Rejected'), ('REVERTED', 'Reverted for Clarification'), ('CANCELLED', 'Cancelled')], default='PENDING', max_length=20)),
                ('started_at', models.DateTimeField(auto_now_add=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('assigned_to', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='assigned_workflows', to=settings.AUTH_USER_MODEL)),
                ('started_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='workflow_initiated', to=settings.AUTH_USER_MODEL)),
                ('current_step', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='current_instances', to='workflow.workflowstep')),
            ],
            options={
                'verbose_name': 'Workflow Instance',
                'verbose_name_plural': 'Workflow Instances',
                'ordering': ['-started_at'],
            },
        ),
        migrations.CreateModel(
            name='WorkflowAuditLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('action', models.CharField(choices=[('STARTED', 'Workflow Started'), ('FORWARD', 'Forwarded to Next Step'), ('REVERT', 'Reverted to Previous Step'), ('REJECT', 'Rejected'), ('COMPLETE', 'Workflow Completed'), ('DELEGATE', 'Delegated'), ('ESCALATE', 'Escalated')], max_length=20)),
                ('remarks', models.TextField(blank=True)),
                ('entered_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('exited_at', models.DateTimeField(blank=True, null=True)),
                ('time_spent_hours', models.FloatField(blank=True, null=True)),
                ('from_step', models.PositiveIntegerField(blank=True, null=True)),
                ('to_step', models.PositiveIntegerField(blank=True, null=True)),
                ('metadata', models.JSONField(blank=True, null=True)),
                ('performed_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='workflow_actions', to=settings.AUTH_USER_MODEL)),
                ('instance', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='audit_logs', to='workflow.workflowinstance')),
                ('step', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='audit_logs', to='workflow.workflowstep')),
            ],
            options={
                'verbose_name': 'Workflow Audit Log',
                'verbose_name_plural': 'Workflow Audit Logs',
                'ordering': ['-entered_at'],
            },
        ),
        migrations.CreateModel(
            name='WorkflowTemplate',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=200)),
                ('module', models.CharField(choices=[('RA_BILL', 'RA Bill'), ('TENDER', 'Tender'), ('DESIGN', 'Design Document'), ('VARIATION', 'Variation Order'), ('CONTRACT', 'Contract'), ('BOQ', 'BOQ Item'), ('RISK', 'Risk')], max_length=20)),
                ('description', models.TextField(blank=True)),
                ('is_active', models.BooleanField(default=True)),
                ('is_default', models.BooleanField(default=False, help_text='Use as fallback if no trigger rules match')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_workflow_templates', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Workflow Template',
                'verbose_name_plural': 'Workflow Templates',
                'ordering': ['module', 'name'],
            },
        ),
        migrations.AddField(
            model_name='workflowstep',
            name='template',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='steps', to='workflow.workflowtemplate'),
        ),
        migrations.AddField(
            model_name='workflowinstance',
            name='template',
            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='instances', to='workflow.workflowtemplate'),
        ),
        migrations.CreateModel(
            name='WorkflowTriggerRule',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=200)),
                ('module', models.CharField(choices=[('RA_BILL', 'RA Bill'), ('TENDER', 'Tender'), ('DESIGN', 'Design Document'), ('VARIATION', 'Variation Order'), ('CONTRACT', 'Contract'), ('BOQ', 'BOQ Item'), ('RISK', 'Risk')], max_length=20)),
                ('condition_field', models.CharField(help_text='Field to evaluate (e.g., "amount", "type", "project.category")', max_length=100)),
                ('condition_operator', models.CharField(choices=[('GT', 'Greater Than'), ('GTE', 'Greater Than or Equal'), ('LT', 'Less Than'), ('LTE', 'Less Than or Equal'), ('EQ', 'Equals'), ('NEQ', 'Not Equals'), ('IN', 'In List'), ('NOT_IN', 'Not In List'), ('CONTAINS', 'Contains')], max_length=20)),
                ('condition_value', models.CharField(help_text='Value to compare against (use comma-separated for IN/NOT_IN)', max_length=500)),
                ('logic_criteria', models.JSONField(blank=True, help_text='Advanced JSON logic for complex conditions', null=True)),
                ('priority', models.PositiveIntegerField(default=100, help_text='Lower priority = evaluated first')),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('template', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='trigger_rules', to='workflow.workflowtemplate')),
            ],
            options={
                'verbose_name': 'Workflow Trigger Rule',
                'verbose_name_plural': 'Workflow Trigger Rules',
                'ordering': ['module', 'priority'],
            },
        ),
        migrations.AlterUniqueTogether(
            name='workflowstep',
            unique_together={('template', 'sequence')},
        ),
        migrations.AddIndex(
            model_name='workflowinstance',
            index=models.Index(fields=['entity_type', 'entity_id'], name='workflow_wo_entity__ad8afd_idx'),
        ),
        migrations.AddIndex(
            model_name='workflowinstance',
            index=models.Index(fields=['status'], name='workflow_wo_status_665f9a_idx'),
        ),
        migrations.AddIndex(
            model_name='workflowinstance',
            index=models.Index(fields=['current_step'], name='workflow_wo_current_8115ad_idx'),
        ),
    ]



================================================
FILE: backend/workflow/migrations/__init__.py
================================================
[Empty file]


================================================
FILE: docs/README.md
================================================
# PMIS ZIA - Programme Management Information System

The Programme Management Information System (PMIS) for Zaheerabad Industrial Area is a comprehensive, full-stack digital platform designed to serve as the "Single Source of Truth" for infrastructure development. It acts as a central command center for monitoring progress, financial tracking, document management, and decision-making.

##  Overview

This platform integrates various project management domains into a seamless interface, providing real-time analytics, geospatial data, and workflow automation for the Special Purpose Vehicle (SPV), Project Management Consultants (PMNC), and Contractors.

##  Tech Stack

### Frontend
- **Framework**: React.js 18
- **Language**: JavaScript (JSX)
- **Styling**: Tailwind CSS
- **Build Tool**: Vite
- **State Management**: React Hooks & Context API
- **Maps**: Leaflet (OpenStreetMap)
- **Charts**: Recharts
- **UI Components**: Lucide React Icons, Framer Motion (Animations), Sonner (Toasts)

### Backend
- **Framework**: Django REST Framework (Python)
- **Database**: PostgreSQL 
- **Authentication**: JWT & Session-based
- **API**: RESTful Endpoints

##  Key Features

### 1. Unified Dashboard
- **Centralized View**: Real-time KPIs for physical and financial progress.
- **Interactive Widgets**: Interactive charts and metric cards for quick insights.

### 2. User & Master Data Management
- **Role-Based Access Control (RBAC)**: secure access for SPV Officials, PMNC Teams, Contractors, and Consultants.
- **Interactive Status Badges**: **[NEW]** Easily activate or deactivate entities (Users, Contractors, ETP Charges) with a single click and secure confirmation modal.
- **Dynamic Master Data**: Configurable hierarchies (Zones, Circles), geography, and classification systems.

### 3. Financial Management
- **Bill Tracking**: Streamlined bill submission and approval workflow.
- **ETP Charges**: Configurable generic charges (Deductions, Recoveries) with active/inactive status toggles.
- **Cost Forecasting**: Earned value analysis and budget tracking.

### 4. Electronic Document Management System (EDMS)
- **Repository**: Centralized storage for drawings, reports, and contracts.
- **Version Control**: Track document revisions and history.

### 5. GIS & Visualisation
- **Interactive Maps**: Layered GIS data viewing project sites and utilities.
- **3D Viewer**: (Placeholder) Infrastructure component visualization.

##  Getting Started

### Prerequisites
- Node.js (v18+)
- Python (v3.10+)
- npm or yarn

### Installation

1.  **Clone the Repository**
    ```bash
    git clone https://github.com/kedar2812/pmis-2.0.git
    cd pmis-zia
    ```

2.  **Frontend Setup**
    ```bash
    cd frontend
    npm install
    npm run dev
    ```

3.  **Backend Setup**
    ```bash
    cd backend
    pip install -r requirements.txt
    python manage.py migrate
    python manage.py runserver
    ```

## Project Structure

```
pmis-zia/
â”œâ”€â”€ frontend/               # React Frontend
â”‚   â”œâ”€â”€ src/               # Source Code
â”‚   â”‚   â”œâ”€â”€ api/           # API Services & Client
â”‚   â”‚   â”œâ”€â”€ components/    # Reusable UI Components
â”‚   â”‚   â”‚   â”œâ”€â”€ ui/        # Generic UI (Buttons, StatusBadge, etc.)
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ pages/         # Application Pages
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ public/            # Static Assets
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ vite.config.js
â”‚
â”œâ”€â”€ backend/               # Django Backend
â”‚   â”œâ”€â”€ masters/           # Master Data App
â”‚   â”œâ”€â”€ users/             # User Management App
â”‚   â”œâ”€â”€ projects/          # Project Management App
â”‚   â”œâ”€â”€ finance/           # Finance & Billing App
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ README.md
â””â”€â”€ ...
```

## Roles & Permissions

- **SPV Official**: Full generic administrative access.
- **PMNC Team**: Project manager access with configuration rights.
- **EPC Contractor**: Restricted access to specific packages and bill submissions.
- **Design Consultant**: Document upload and viewing rights.

##  License

Proprietary software developed for the Zaheerabad Industrial Area development project.



================================================
FILE: docs/ARCHITECTURE.md
================================================
# PMIS ZIA - Rule-Based Architecture

## Overview

This system is built with a **rule-based architecture** where all calculations, business logic, and data processing follow centralized formulas and rules. This design ensures that when transitioning from mock data to real-time data processing, only the data source changes - the calculation logic remains identical.

## Architecture Principles

### 1. **Separation of Concerns**
- **Data Layer**: Mock data (current) â†’ API calls (production)
- **Calculation Layer**: Centralized rules in `src/lib/calculations.ts`
- **Presentation Layer**: UI components that consume calculated results

### 2. **Pure Functions**
All calculation functions are pure functions:
- No side effects
- Same input = Same output
- Easy to test
- Easy to replace data sources

### 3. **Single Source of Truth**
All business rules are defined in:
- `src/lib/calculations.ts` - Calculation functions
- `src/lib/rules.md` - Documentation of all formulas

## Current Implementation (Mock Data)

```typescript
// Example: Budget Utilization Calculation
import { calculateBudgetUtilization } from '@/lib/calculations';

// Current: Using mock data
const project = mockProjects.find(p => p.id === projectId);
const utilization = calculateBudgetUtilization(project.budget, project.spent);
```

## Production Implementation (Real-Time Data)

```typescript
// Example: Budget Utilization Calculation
import { calculateBudgetUtilization } from '@/lib/calculations';

// Production: Using API data
const project = await fetchProjectFromAPI(projectId);
const utilization = calculateBudgetUtilization(project.budget, project.spent);
// Same calculation function, different data source!
```

## Rule Categories

### 1. KPI Calculations
- Schedule Performance Index (SPI)
- Cost Performance Index (CPI)
- Cost Variation & Percentage
- Budget Utilization
- Project Progress
- Risk Scoring

### 2. Budget Calculations
- Remaining Budget
- Budget Variance
- Budget Health Status
- Land Acquisition Status
- Budget Aggregation (by Source/Utilization)

### 3. Forecast Calculations
- Cost Forecast (Trend Analysis)
- Forecast Variance

### 4. Project Status Rules
- Project Status Determination
- Project Health Score

### 5. Workflow Rules
- Next Workflow Step
- Workflow Status Determination
- Step Requirement Validation

### 6. Permission Rules
- Project Creation Permissions
- Document Approval Permissions
- Document Deletion Permissions

### 7. Validation Rules
- Budget Allocation Validation
- Project Dates Validation
- Reimbursement Amount Validation

### 8. Data Filtering Rules
- Project Status Filtering
- Document Project Hierarchy Filtering
- Risk Filtering

## Migration Path to Real-Time Data

### Step 1: Replace Data Fetching
```typescript
// Before (Mock)
import { projects } from '@/mock';

// After (API)
import { fetchProjects } from '@/services/api';
const projects = await fetchProjects();
```

### Step 2: Keep Calculation Functions
```typescript
// No changes needed!
import { calculateBudgetUtilization } from '@/lib/calculations';
const utilization = calculateBudgetUtilization(budget, spent);
```

### Step 3: Add Real-Time Updates
```typescript
// Add WebSocket or polling
useEffect(() => {
  const ws = new WebSocket('wss://api.pmis-zia.com/updates');
  ws.onmessage = (event) => {
    const updatedData = JSON.parse(event.data);
    // Update state, calculations run automatically
  };
}, []);
```

## Benefits of This Architecture

1. **Easy Testing**: All calculation functions can be unit tested independently
2. **Consistent Results**: Same formulas used everywhere
3. **Easy Migration**: Only data layer changes, not calculation logic
4. **Maintainability**: All rules in one place
5. **Documentation**: Rules are self-documenting with formulas
6. **Scalability**: Can add caching, memoization, or optimization without changing UI

## Example: Complete Flow

### Current (Mock Data)
```typescript
// 1. Get mock data
const project = projects.find(p => p.id === 'proj-1');

// 2. Calculate using rules
const utilization = calculateBudgetUtilization(project.budget, project.spent);
const status = getBudgetHealthStatus(utilization);

// 3. Display in UI
<BudgetCard utilization={utilization} status={status} />
```

### Production (Real-Time Data)
```typescript
// 1. Fetch from API
const project = await fetchProject('proj-1');

// 2. Calculate using SAME rules
const utilization = calculateBudgetUtilization(project.budget, project.spent);
const status = getBudgetHealthStatus(utilization);

// 3. Display in UI (SAME component)
<BudgetCard utilization={utilization} status={status} />
```

## Files Structure

```
src/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ calculations.ts    # All calculation functions
â”‚   â””â”€â”€ rules.md           # Documentation of all rules
â”œâ”€â”€ services/              # (Future) API service layer
â”‚   â””â”€â”€ api.ts            # API calls to replace mock data
â”œâ”€â”€ pages/                 # UI components
â”‚   â””â”€â”€ Dashboard.tsx     # Uses calculation functions
â””â”€â”€ mock/                  # Mock data (will be replaced)
    â””â”€â”€ data/
        â””â”€â”€ projects.json
```

## Next Steps for Production

1. **Create API Service Layer**
   - Replace `@/mock` imports with `@/services/api`
   - Implement data fetching functions
   - Add error handling and loading states

2. **Add Caching**
   - Cache calculated values
   - Implement cache invalidation
   - Use React Query or SWR for data management

3. **Add Real-Time Updates**
   - WebSocket connections
   - Server-Sent Events (SSE)
   - Polling for critical data

4. **Add Validation**
   - Server-side validation
   - Client-side validation using rule functions
   - Error handling and user feedback

5. **Performance Optimization**
   - Memoize expensive calculations
   - Batch API requests
   - Implement pagination and lazy loading

## Conclusion

The entire system is built on **formula-based, rule-driven architecture**. When you're ready to connect to real-time data:

1. âœ… **Keep** all calculation functions in `src/lib/calculations.ts`
2. âœ… **Keep** all UI components as-is
3. âœ… **Replace** only the data fetching layer
4. âœ… **Add** real-time update mechanisms

The calculation logic will work identically with real-time data because it's already rule-based and data-agnostic!




================================================
FILE: docs/SECURITY.md
================================================
# Security Guidelines

## API Keys and Secrets

**IMPORTANT**: Never commit API keys, secrets, or sensitive information to version control.

### Environment Variables

All sensitive configuration should be stored in `.env` files:
- `.env` - Local development (git-ignored)
- `.env.example` - Template file (safe to commit, no real keys)

### Best Practices

1. **Never commit the `.env` file** - It's already in `.gitignore`
2. **Never hardcode API keys** in source code
3. **Never share API keys** in public repositories or pull requests

### What to do if an API key is accidentally committed:

1. **Immediately revoke the key** in the respective service console
2. Generate a new API key
3. Update the `.env` file with the new key
4. If the key was pushed to GitHub, you may need to:
   - Remove it from git history (using `git filter-branch` or BFG Repo-Cleaner)
   - Or regenerate a new key and accept the exposure

## Current Configuration

- âœ… `.env` file is in `.gitignore`
- âœ… No API keys currently required (using Leaflet for maps - no API key needed)
- âœ… No hardcoded API keys in source code




================================================
FILE: docs/workflows/create_standard_modal.md
================================================
---
description: How to create a new modal component or refactor an existing one to follow the standard closing behavior.
---

# Standard Modal Implementation Pattern

All modal pop-up windows in PMIS must follow this standard pattern for consistency.

## Required Features

1. **createPortal** - Render to `document.body` to escape parent stacking contexts
2. **AnimatePresence + motion.div** - Smooth fade/scale animations
3. **z-[9999]** - Highest z-index for backdrop and content
4. **backdrop-blur-sm** - 6px blur effect on backdrop
5. **ESC key handler** - Close modal on Escape key press
6. **Click outside to close** - Backdrop click closes modal

## Required Imports

```jsx
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X } from 'lucide-react';
```

## Standard Modal Template

```jsx
const MyModal = ({ isOpen, onClose, children }) => {
    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && isOpen) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [isOpen, onClose]);

    return createPortal(
        <AnimatePresence>
            {isOpen && (
                <>
                    {/* Backdrop */}
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        onClick={onClose}
                        className="fixed inset-0 z-[9999] bg-black/50 backdrop-blur-sm"
                    />
                    {/* Modal Content */}
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95, y: 20 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.95, y: 20 }}
                        transition={{ duration: 0.2 }}
                        className="fixed inset-0 z-[9999] flex items-center justify-center p-4 pointer-events-none"
                    >
                        <div 
                            className="bg-white rounded-xl shadow-2xl pointer-events-auto"
                            onClick={(e) => e.stopPropagation()}
                        >
                            {/* Header with close button */}
                            <div className="flex justify-between items-center p-4 border-b">
                                <h2 className="text-lg font-bold">Modal Title</h2>
                                <button
                                    onClick={onClose}
                                    className="p-1 hover:bg-slate-100 rounded-full transition-colors"
                                >
                                    <X size={18} className="text-slate-500" />
                                </button>
                            </div>
                            {/* Content */}
                            <div className="p-4">
                                {children}
                            </div>
                        </div>
                    </motion.div>
                </>
            )}
        </AnimatePresence>,
        document.body
    );
};
```

## Key Rules

| Rule | Implementation |
|------|---------------|
| Backdrop z-index | `z-[9999]` |
| Content z-index | `z-[9999]` |
| Blur effect | `backdrop-blur-sm` (6px) |
| Background opacity | `bg-black/50` or `bg-slate-900/60` |
| Border radius | `rounded-xl` or `rounded-2xl` |
| Shadow | `shadow-2xl` |
| Animation duration | `0.2s` |

## Disable ESC During Loading

If modal has async operations, prevent closing during loading:

```jsx
useEffect(() => {
    const handleEscape = (e) => {
        if (e.key === 'Escape' && isOpen && !loading) {
            onClose();
        }
    };
    // ...
}, [isOpen, onClose, loading]);
```

## Example Modals Following This Pattern

- `MasterFormModal.jsx`
- `DeleteConfirmModal.jsx`
- `CreateProjectModal.jsx`
- `GenerateBillModal.jsx`
- `FundManagement.jsx` (inline modal)
- `Budgeting.jsx` (inline modal)



================================================
FILE: docs/workflows/sync-api-repo.md
================================================
---
description: How to sync backend code to the API-only GitLab repository
---

# Sync Backend to API Repository

The `backend/` folder is synced to a separate GitLab repository for API-only deployment.

## Repository Setup

- **Main Repo (Full)**: https://github.com/kedar2812/pmis-2.0.git
- **GitLab Full**: https://gitlab.com/Arthainfosystems/pmis_webapp.git
- **GitLab API Only**: https://gitlab.com/Arthainfosystems/pmis_api.git

## How It Works

The `backend/` folder is pushed to the API repo using **git subtree**. This keeps only the Django/backend code in that repository.

## Syncing Backend to API Repo

After making changes to backend code and committing:

```bash
# Push backend folder only to API repo
git subtree push --prefix=backend gitlab-api main
```

Or push to dev branch:

```bash
git subtree push --prefix=backend gitlab-api dev
```

## Full Workflow

### 1. Make Backend Changes
```bash
cd backend
# ... make your changes ...
```

### 2. Commit Changes
```bash
git add -A
git commit -m "Your commit message"
```

### 3. Push to All Repositories
```bash
# Push full code to GitHub
git push origin main

# Push full code to GitLab
git push gitlab main

# Push ONLY backend to API repo
git subtree push --prefix=backend gitlab-api main
```

## Automatic Sync Script

To make this easier, you can create a script. Save as `push-all.sh`:

```bash
#!/bin/bash
# Push to all repositories

echo "Pushing to GitHub..."
git push origin main

echo "Pushing to GitLab (full)..."
git push gitlab main

echo "Pushing backend to API repo..."
git subtree push --prefix=backend gitlab-api main

echo "âœ… All repositories synced!"
```

Make it executable:
```bash
chmod +x push-all.sh
```

Then just run:
```bash
./push-all.sh
```

## Troubleshooting

**Error: "Updates were rejected"**
Solution: Pull first, then push:
```bash
git subtree pull --prefix=backend gitlab-api main
git subtree push --prefix=backend gitlab-api main
```

**Error: "Working tree has modifications"**
Solution: Commit or stash your changes first:
```bash
git stash
git subtree push --prefix=backend gitlab-api main
git stash pop
```

## Remote List

Check all your remotes:
```bash
git remote -v
```

Should show:
- `origin` â†’ GitHub
- `gitlab` â†’ GitLab (full)
- `gitlab-api` â†’ GitLab (API only)



================================================
FILE: docs/workflows/sync-gitlab.md
================================================
---
description: How to sync code between GitHub and GitLab repositories
---

# Sync GitHub and GitLab Repositories

## Current Setup

Your repository currently has these remotes:
- **origin**: https://github.com/kedar2812/pmis-2.0.git (main GitHub repo)
- **old-origin**: https://github.com/kedar2812/pmis-zia.git (old GitHub repo)

## Step 1: Add GitLab Remote

Replace `<GITLAB_URL>` with your actual GitLab repository URL:

```bash
git remote add gitlab <GITLAB_URL>
```

Example:
```bash
git remote add gitlab https://gitlab.com/kedar2812/pmis-2.0.git
```

Or if using SSH:
```bash
git remote add gitlab git@gitlab.com:kedar2812/pmis-2.0.git
```

## Step 2: Verify Remotes

Check that all remotes are configured:

```bash
git remote -v
```

You should see:
- origin (GitHub)
- gitlab (GitLab)
- old-origin (old GitHub)

## Step 3: Push to GitLab

First time push to GitLab (creates all branches):

```bash
# Push main branch
git push gitlab main

# Push dev branch
git push gitlab dev

# Push all branches
git push gitlab --all

# Push all tags
git push gitlab --tags
```

## Step 4: Regular Workflow

### Option A: Push to Both Manually

After committing changes:

```bash
# Push to GitHub
git push origin main

# Push to GitLab
git push gitlab main
```

### Option B: Push to Both Automatically

Set up a special remote that pushes to both:

```bash
# Add both URLs to origin
git remote set-url --add --push origin https://github.com/kedar2812/pmis-2.0.git
git remote set-url --add --push origin <GITLAB_URL>
```

Then just use:
```bash
git push origin main
```

This will push to both GitHub and GitLab!

### Option C: Create an Alias

Add this to your Git config for easy dual push:

```bash
git config --global alias.pushall '!git push origin main && git push gitlab main'
```

Then use:
```bash
git pushall
```

## Step 5: Pulling Changes

If you make changes on GitLab, pull from there:

```bash
git pull gitlab main
```

If you make changes on GitHub:
```bash
git pull origin main
```

## Common Commands

| Task | Command |
|------|---------|
| View remotes | `git remote -v` |
| Remove a remote | `git remote remove <name>` |
| Rename a remote | `git remote rename <old> <new>` |
| Change remote URL | `git remote set-url <name> <new-url>` |
| Push to specific remote | `git push <remote-name> <branch>` |
| Pull from specific remote | `git pull <remote-name> <branch>` |

## Troubleshooting

**Problem**: Authentication failed
**Solution**: Use a Personal Access Token (PAT) for GitLab:
1. Go to GitLab â†’ Settings â†’ Access Tokens
2. Create token with `write_repository` scope
3. Use in URL: `https://oauth2:<TOKEN>@gitlab.com/username/repo.git`

**Problem**: Push rejected
**Solution**: Pull first, then push:
```bash
git pull gitlab main --rebase
git push gitlab main
```

## Best Practices

1. âœ… Always commit to main branch first on GitHub
2. âœ… Then push to both remotes
3. âœ… Keep both repositories in sync
4. âœ… Use `git status` to check your current state
5. âš ï¸ Be careful with force pushes (`git push -f`)



================================================
FILE: frontend/README.md
================================================
# PMIS Zia Frontend

## Theme System
The application uses a robust semantic theming system powered by Tailwind CSS variables and detailed in `tailwind.config.js`.

### Semantic Tokens
We use semantic class names rather than raw colors to ensure consistent dark mode support and theming capabilities.
- **Backgrounds**: `bg-app-bg`, `bg-app-surface`, `bg-app-card`
- **Text**: `text-app-heading`, `text-app-text`, `text-app-muted`
- **Borders**: `border-app`, `border-app-subtle`

**Do not use** hardcoded colors like `bg-slate-900` or `text-gray-500` for main UI elements. Use the `app-*` tokens which automatically switch in dark mode.

### Dark Mode
Dark mode is fully implemented and supported across all application modules.
- The `ThemeContext` handles system preference syncing.
- Toggle between Light, Dark, and System modes using the global theme switcher.

## Development

### Linting & Code Quality
We use ESLint with `eslint-plugin-tailwindcss` to enforce class sorting and best practices.

To run linter:
```bash
npm run lint
```

The configuration is in `.eslintrc.cjs` and enforces:
- Proper class ordering
- No arbitrary values (e.g. `w-[123px]`) where standard tokens apply
- Usage of valid Tailwind classes



================================================
FILE: frontend/index.html
================================================
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PMIS - Zaheerabad Industrial Area</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- FOUC Prevention: Apply dark mode before React hydrates -->
  <!-- This script runs synchronously to prevent white flash on page load -->
  <script>
    (function() {
      try {
        // Get theme from localStorage (default to 'system')
        const theme = localStorage.getItem('app-theme') || 'system';
        
        // Determine if we should apply dark mode
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const shouldBeDark = theme === 'dark' || (theme === 'system' && prefersDark);
        
        // Apply dark class immediately if needed
        if (shouldBeDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      } catch (e) {
        // Fail silently - React will handle theme on load
        console.warn('Failed to apply initial theme:', e);
      }
    })();
  </script>
</head>

<body>
  <div id="root"></div>
  <script type="module" src="/src/main.jsx"></script>
</body>

</html>


================================================
FILE: frontend/package.json
================================================
{
  "name": "pmis-zia-frontend",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint . --ext js,jsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@radix-ui/react-dialog": "^1.0.5",
    "@radix-ui/react-dropdown-menu": "^2.0.6",
    "@radix-ui/react-select": "^2.0.6",
    "@radix-ui/react-tabs": "^1.0.4",
    "axios": "^1.13.2",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.0.0",
    "date-fns": "^4.1.0",
    "framer-motion": "^10.18.0",
    "leaflet": "^1.9.4",
    "lucide-react": "^0.294.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-dropzone": "^14.3.8",
    "react-leaflet": "^4.2.1",
    "react-router-dom": "^6.28.0",
    "recharts": "^2.10.3",
    "sonner": "^1.7.4",
    "tailwind-merge": "^2.1.0",
    "three": "^0.158.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "eslint": "^8.55.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.5",
    "eslint-plugin-tailwindcss": "^3.18.2",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.3.6",
    "vite": "^7.3.1"
  }
}



================================================
FILE: frontend/postcss.config.js
================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}





================================================
FILE: frontend/tailwind.config.js
================================================
/** @type {import('tailwindcss').Config} */
export default {
  darkMode: 'class', // Enable class-based dark mode
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        // ===== SEMANTIC DESIGN TOKENS =====
        // Auto-switch between light/dark modes
        // Usage: bg-app-bg, text-app-heading, border-app, etc.

        app: {
          // Backgrounds
          bg: 'rgb(var(--bg-primary) / <alpha-value>)',
          'bg-secondary': 'rgb(var(--bg-secondary) / <alpha-value>)',
          surface: 'rgb(var(--bg-surface) / <alpha-value>)',
          card: 'rgb(var(--bg-card) / <alpha-value>)',
          hover: 'rgb(var(--bg-hover) / <alpha-value>)',
          active: 'rgb(var(--bg-active) / <alpha-value>)',

          // Text
          heading: 'rgb(var(--text-primary) / <alpha-value>)',
          text: 'rgb(var(--text-secondary) / <alpha-value>)',
          muted: 'rgb(var(--text-muted) / <alpha-value>)',
          inverse: 'rgb(var(--text-inverse) / <alpha-value>)',

          // Borders
          border: 'rgb(var(--border-default) / <alpha-value>)',
          'border-subtle': 'rgb(var(--border-muted) / <alpha-value>)',
          'border-focus': 'rgb(var(--border-focus) / <alpha-value>)',

          // Brand/Accent
          accent: 'rgb(var(--accent-primary) / <alpha-value>)',
          'accent-hover': 'rgb(var(--accent-primary-hover) / <alpha-value>)',
        },

        // ===== LEGACY COLOR PALETTE =====
        // Keep existing colors for backward compatibility
        // These will be gradually migrated to semantic tokens
        primary: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2546eb', // Blue-600 (main)
          700: '#1d4ed8', // Dark blue-700
          800: '#1e40af', // Dark blue-800
          900: '#1e3a8a', // Dark blue-900
          950: '#172554', // Very dark blue
        },
        secondary: {
          DEFAULT: '#14b8a6', // Teal-500
          50: '#f0fdfa',
          100: '#ccfbf1',
          200: '#99f6e4',
          300: '#5eead4',
          400: '#2dd4bf',
          500: '#14b8a6',
          600: '#0d9488',
          700: '#0f766e',
        },
        accent: {
          DEFAULT: '#f97316', // Coral-500 (keeping for compatibility)
          50: '#fff7ed',
          100: '#ffedd5',
          200: '#fed7aa',
          300: '#fdba74',
          400: '#fb923c',
          500: '#f97316', // Coral-500
          600: '#ea580c',
          700: '#c2410c',
          800: '#9a3412',
          900: '#7c2d12',
        },
        background: {
          DEFAULT: '#f8fafc', // Slate-50
        },
        // Semantic colors for consistent usage
        success: {
          50: '#ecfdf5',
          100: '#d1fae5',
          200: '#a7f3d0',
          300: '#6ee7b7',
          400: '#34d399',
          500: '#10b981',
          600: '#059669',
          700: '#047857',
        },
        warning: {
          50: '#fffbeb',
          100: '#fef3c7',
          200: '#fde68a',
          300: '#fcd34d',
          400: '#fbbf24',
          500: '#f59e0b',
          600: '#d97706',
          700: '#b45309',
        },
        error: {
          50: '#fef2f2',
          100: '#fee2e2',
          200: '#fecaca',
          300: '#fca5a5',
          400: '#f87171',
          500: '#ef4444',
          600: '#dc2626',
          700: '#b91c1c',
        },
        slate: {
          50: '#f8fafc',
          100: '#f1f5f9',
          200: '#e2e8f0',
          300: '#cbd5e1',
          400: '#94a3b8',
          500: '#64748b',
          600: '#475569',
          700: '#334155',
          800: '#1e293b',
          900: '#0f172a',
        },
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif'],
        heading: ['Plus Jakarta Sans', 'Inter', 'system-ui', 'sans-serif'],
      },
      boxShadow: {
        'blue-glow': '0 4px 14px 0 rgba(37, 70, 235, 0.2)',
        'indigo-glow': '0 4px 14px 0 rgba(37, 70, 235, 0.2)', // Keep for compatibility
        'teal-glow': '0 4px 14px 0 rgba(20, 184, 166, 0.2)',
        'coral-glow': '0 4px 14px 0 rgba(249, 115, 22, 0.2)',
        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.37)',
      },
      backdropBlur: {
        xs: '2px',
      },
      animation: {
        'fade-in': 'fadeIn 0.3s ease-in-out',
        'slide-in': 'slideIn 0.3s ease-out',
        'shimmer': 'shimmer 2s infinite',
        'pulse-glow': 'pulseGlow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideIn: {
          '0%': { transform: 'translateX(-10px)', opacity: '0' },
          '100%': { transform: 'translateX(0)', opacity: '1' },
        },
        shimmer: {
          '0%': { backgroundPosition: '-1000px 0' },
          '100%': { backgroundPosition: '1000px 0' },
        },
        pulseGlow: {
          '0%, 100%': { opacity: '1' },
          '50%': { opacity: '0.5' },
        },
      },
    },
  },
  plugins: [],
}




================================================
FILE: frontend/vite.config.js
================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  // Production build configuration
  build: {
    outDir: 'dist',
    sourcemap: false, // Disable sourcemaps in production for security
    rollupOptions: {
      output: {
        manualChunks: {
          // Split vendor chunks for better caching
          vendor: ['react', 'react-dom', 'react-router-dom'],
          charts: ['recharts'],
        },
      },
    },
    chunkSizeWarningLimit: 1000, // Increase limit for large apps
  },
  // Base path (use '/' for root deployment)
  base: '/',
  // Development server configuration
  server: {
    port: 5173,
    proxy: {
      // Proxy API requests to Django backend in development
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        secure: false,
      },
      '/media': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        secure: false,
      },
    },
  },
})



================================================
FILE: frontend/.eslintrc.cjs
================================================
module.exports = {
  root: true,
  env: { browser: true, es2020: true },
  extends: [
    'eslint:recommended',
    'plugin:react-hooks/recommended',
    'plugin:tailwindcss/recommended',
  ],
  ignorePatterns: ['dist', '.eslintrc.cjs'],
  parserOptions: {
    ecmaVersion: 'latest',
    sourceType: 'module',
    ecmaFeatures: {
      jsx: true,
    },
  },
  plugins: ['react-refresh', 'tailwindcss'],
  rules: {
    'react-refresh/only-export-components': [
      'warn',
      { allowConstantExport: true },
    ],
    // Enforce class order for consistency
    'tailwindcss/classnames-order': 'warn',
    // Warn on arbitrary values to encourage semantic tokens
    'tailwindcss/no-arbitrary-value': 'warn',
    // Ensure all classes are valid/exist in theme
    'tailwindcss/no-custom-classname': 'warn',
  },
  settings: {
    tailwindcss: {
      // These are the utility classes we generated in index.css or tailwind.config.js
      whitelist: ['bg-app-bg', 'text-app-heading', 'border-app'],
    },
  },
}





================================================
FILE: frontend/public/images/README.md
================================================
# NIMZ Boundary Map Image

Please place your NIMZ boundary map image in this directory with the filename:

**`nimz-boundary-map.png`**

The image will be automatically overlaid on the Google Map at the Zaheerabad, Telangana location with 65% transparency.

Supported formats: PNG, JPEG, WebP




================================================
FILE: frontend/public/locales/en/translation.json
================================================
{
  "app": {
    "title": "PMIS - Zaheerabad Industrial Area"
  },
  "common": {
    "login": "Login",
    "logout": "Logout",
    "dashboard": "Integrated Dashboard",
    "projects": "Projects",
    "schedule": "Schedule",
    "cost": "Cost Management",
    "risk": "Risk Management",
    "gis": "GIS & Mapping",
    "bim": "3D Model Viewer",
    "selectRole": "Select Role",
    "welcome": "Welcome",
    "language": "Language",
    "profile": "Profile",
    "notifications": "Notifications",
    "search": "Search",
    "filter": "Filter",
    "export": "Export",
    "upload": "Upload",
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit",
    "view": "View",
    "status": "Status",
    "progress": "Progress",
    "budget": "Budget",
    "spent": "Spent",
    "remaining": "Remaining",
    "name": "Name",
    "date": "Date",
    "actions": "Actions",
    "target": "Target",
    "found": "found",
    "type": "Type",
    "category": "Category",
    "version": "Version",
    "size": "Size",
    "uploadedBy": "Uploaded By",
    "manager": "Manager",
    "location": "Location",
    "description": "Description",
    "startDate": "Start Date",
    "endDate": "End Date",
    "assignedTo": "Assigned To",
    "priority": "Priority",
    "impact": "Impact",
    "probability": "Probability",
    "owner": "Owner",
    "identified": "Identified",
    "allStatus": "All Status",
    "allTypes": "All Types",
    "allProjects": "All Projects",
    "project": "Project",
    "total": "Total",
    "inProgress": "In Progress",
    "completed": "Completed",
    "planning": "Planning",
    "onHold": "On Hold",
    "cancelled": "Cancelled",
    "draft": "Draft",
    "underReview": "Under Review",
    "approved": "Approved",
    "rejected": "Rejected",
    "closed": "Closed",
    "mitigated": "Mitigated",
    "assessed": "Assessed",
    "low": "Low",
    "medium": "Medium",
    "high": "High",
    "critical": "Critical",
    "notStarted": "Not Started",
    "delayed": "Delayed",
    "creating": "Creating...",
    "uploading": "Uploading...",
    "authenticating": "Authenticating...",
    "comingSoon": "Coming soon",
    "accessLevel": "Access Level"
  },
  "dashboard": {
    "title": "Integrated Dashboard",
    "overview": "Overview",
    "kpis": "Key Performance Indicators",
    "recentProjects": "Recent Projects",
    "activeRisks": "Active Risks",
    "upcomingTasks": "Upcoming Tasks",
    "searchPlaceholder": "Search projects, tasks, risks...",
    "createProject": "Create Project",
    "progress": "Progress",
    "budgetVsSpent": "Budget vs Spent (in Crores)",
    "riskDistribution": "Distribution",
    "projectTimeline": "Project Timeline",
    "noRisksFound": "No risks found matching your search.",
    "noActiveRisks": "No active risks.",
    "noTasksFound": "No tasks found matching your search.",
    "noUpcomingTasks": "No upcoming tasks.",
    "navigatingToRisk": "Navigating to Risk Management",
    "viewingRiskDetails": "Viewing risk details and mitigation plans."
  },
  "login": {
    "title": "Programme Management Information System",
    "subtitle": "Zaheerabad Industrial Area",
    "selectRole": "Select your role to continue",
    "enter": "Enter System",
    "authenticating": "Authenticating...",
    "welcomeBack": "Welcome back,"
  },
  "role": {
    "SPV_Official": "SPV Official",
    "PMNC_Team": "PMNC Team",
    "EPC_Contractor": "EPC Contractor",
    "Consultant_Design": "Design Consultant",
    "Govt_Department": "Government Department",
    "NICDC_HQ": "NICDC Headquarters"
  },
  "projects": {
    "title": "Projects",
    "subtitle": "Manage and track all infrastructure projects",
    "createProject": "Create Project",
    "searchPlaceholder": "Search projects...",
    "allStatus": "All Status",
    "noProjectsFound": "No projects found",
    "adjustFilters": "Try adjusting your filters to see more results.",
    "getStarted": "Get started by creating your first project.",
    "noProjectsAvailable": "No projects available at the moment.",
    "budget": "Budget",
    "budgetUtilization": "Budget Utilization",
    "totalProjects": "Total Projects",
    "totalBudget": "Total Budget"
  },
  "scheduling": {
    "subtitle": "Project Scheduling and Timeline Tracking",
    "ganttChart": "Gantt Chart",
    "listView": "List View",
    "filterByProject": "Filter by Project:",
    "ganttChartView": "Gantt Chart View",
    "projectProgress": "Project Progress",
    "start": "Start",
    "end": "End",
    "assigned": "Assigned",
    "criticalPath": "Critical Path",
    "taskUpdated": "Task updated",
    "taskStatusUpdated": "Task status has been updated.",
    "failedToUpdate": "Failed to update task"
  },
  "cost": {
    "subtitle": "Budget Forecasting and Cost Management",
    "totalBudget": "Total Budget",
    "totalSpent": "Total Spent",
    "committed": "Committed",
    "remaining": "Remaining",
    "costForecastVsActual": "Cost Forecast vs Actual",
    "forecasted": "Forecasted",
    "actual": "Actual",
    "budgetUtilization": "Budget Utilization",
    "allocated": "Allocated",
    "budgetByCategory": "Budget by Category"
  },
  "risk": {
    "subtitle": "Risk Register and Mitigation Planning",
    "totalRisks": "Total Risks",
    "activeRisks": "Active Risks",
    "highImpact": "High Impact",
    "mitigated": "Mitigated",
    "risksByCategory": "Risks by Category",
    "risksByStatus": "Risks by Status",
    "mitigationPlan": "Mitigation Plan:"
  },
  "bim": {
    "subtitle": "3D Building Information Modeling Viewer",
    "modelViewer": "3D Model Viewer",
    "interactiveVisualization": "Interactive 3D visualization of infrastructure components",
    "infrastructureModels": "Infrastructure Models",
    "modelsDescription": "3D models of project components",
    "interactiveView": "Interactive View",
    "rotateZoomExplore": "Rotate, zoom, and explore models",
    "bimIntegration": "BIM Integration",
    "bimData": "Building Information Modeling data"
  },
  "gis": {
    "subtitle": "Geographic Information System & Spatial Mapping",
    "projectLocationsMap": "Project Locations Map - India",
    "mapDescription": "Interactive map showing all project locations and GIS features across India",
    "gisFeatures": "GIS Features"
  },
  "project": {
    "createNewProject": "Create New Project",
    "projectName": "Project Name",
    "description": "Description",
    "startDate": "Start Date",
    "endDate": "End Date",
    "budget": "Budget (â‚¹)",
    "status": "Status",
    "category": "Category",
    "projectManager": "Project Manager",
    "required": "*",
    "enterProjectName": "Enter project name",
    "enterDescription": "Enter project description",
    "enterBudget": "Enter budget amount",
    "categoryPlaceholder": "e.g., Infrastructure, Utilities",
    "enterManagerName": "Enter manager name",
    "projectNameRequired": "Project name is required",
    "descriptionRequired": "Description is required",
    "startDateRequired": "Start date is required",
    "endDateRequired": "End date is required",
    "endDateAfterStart": "End date must be after start date",
    "validBudgetRequired": "Valid budget amount is required",
    "categoryRequired": "Category is required",
    "managerRequired": "Project manager is required",
    "fixFormErrors": "Please fix the form errors",
    "createdSuccessfully": "Project created successfully!",
    "hasBeenAdded": "has been added to the system.",
    "failedToCreate": "Failed to create project",
    "tryAgain": "Please try again."
  },
  "upload": {
    "uploadDocument": "Upload Document",
    "dragAndDrop": "Drag and drop your file here",
    "or": "or",
    "browseFiles": "Browse Files",
    "fileUploadedSuccessfully": "File uploaded successfully!",
    "hasBeenAdded": "has been added to the repository.",
    "uploadFailed": "Upload failed",
    "tryAgain": "Please try again."
  },
  "header": {
    "english": "English",
    "hindi": "à¤¹à¤¿à¤‚à¤¦à¥€",
    "telugu": "à°¤à±†à°²à±à°—à±"
  },
  "sidebar": {
    "pmisZia": "PMIS ZIA",
    "programmeManagement": "Programme Management",
    "expandSidebar": "Expand sidebar",
    "collapseSidebar": "Collapse sidebar"
  },
  "status": {
    "planning": "Planning",
    "inProgress": "In Progress",
    "onHold": "On Hold",
    "completed": "Completed",
    "cancelled": "Cancelled",
    "draft": "Draft",
    "underReview": "Under Review",
    "approved": "Approved",
    "rejected": "Rejected",
    "closed": "Closed",
    "mitigated": "Mitigated",
    "assessed": "Assessed",
    "notStarted": "Not Started",
    "delayed": "Delayed"
  },
  "priority": {
    "low": "Low",
    "medium": "Medium",
    "high": "High",
    "critical": "Critical"
  },
  "impact": {
    "low": "Low",
    "medium": "Medium",
    "high": "High",
    "critical": "Critical"
  },
  "translation": {
    "translate": "Translate",
    "translating": "Translating...",
    "translationFailed": "Translation failed. Please try again.",
    "enterTextToTranslate": "Enter text to translate"
  }
}


================================================
FILE: frontend/public/locales/hi/translation.json
================================================
[Binary file]


================================================
FILE: frontend/public/locales/te/translation.json
================================================
{
  "app": {
    "title": "PMIS - à°œà°¹à±€à°°à°¾à°¬à°¾à°¦à± à°‡à°‚à°¡à°¸à±à°Ÿà±à°°à°¿à°¯à°²à± à°à°°à°¿à°¯à°¾"
  },
  "common": {
    "login": "à°²à°¾à°—à°¿à°¨à±",
    "logout": "à°²à°¾à°—à±à°…à°µà±à°Ÿà±",
    "dashboard": "à°à°•à±€à°•à±ƒà°¤ à°¡à°¾à°·à±à°¬à±‹à°°à±à°¡à±",
    "projects": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à±",
    "documents": "à°ªà°¤à±à°°à°¾à°²à±",
    "schedule": "à°·à±†à°¡à±à°¯à±‚à°²à±",
    "cost": "à°–à°°à±à°šà± à°¨à°¿à°°à±à°µà°¹à°£",
    "risk": "à°°à°¿à°¸à±à°•à± à°¨à°¿à°°à±à°µà°¹à°£",
    "gis": "GIS & à°®à±à°¯à°¾à°ªà°¿à°‚à°—à±",
    "bim": "3D à°®à±‹à°¡à°²à± à°µà±à°¯à±‚à°¯à°°à±",
    "selectRole": "à°ªà°¾à°¤à±à°° à°à°‚à°šà±à°•à±‹à°‚à°¡à°¿",
    "welcome": "à°¸à±à°µà°¾à°—à°¤à°‚",
    "language": "à°­à°¾à°·",
    "profile": "à°ªà±à°°à±Šà°«à±ˆà°²à±",
    "notifications": "à°¨à±‹à°Ÿà°¿à°«à°¿à°•à±‡à°·à°¨à±à°²à±",
    "search": "à°¶à±‹à°§à°¿à°‚à°šà±",
    "filter": "à°«à°¿à°²à±à°Ÿà°°à±",
    "export": "à°à°—à±à°®à°¤à°¿",
    "upload": "à°…à°ªà±â€Œà°²à±‹à°¡à±",
    "save": "à°¸à±‡à°µà±",
    "cancel": "à°°à°¦à±à°¦à± à°šà±‡à°¯à°¿",
    "delete": "à°¤à±Šà°²à°—à°¿à°‚à°šà±",
    "edit": "à°¸à°µà°°à°¿à°‚à°šà±",
    "view": "à°šà±‚à°¡à°‚à°¡à°¿",
    "status": "à°¸à±à°¥à°¿à°¤à°¿",
    "progress": "à°ªà±à°°à°—à°¤à°¿",
    "budget": "à°¬à°¡à±à°œà±†à°Ÿà±",
    "spent": "à°–à°°à±à°šà±",
    "remaining": "à°®à°¿à°—à°¿à°²à°¿à°¨",
    "name": "à°ªà±‡à°°à±",
    "date": "à°¤à±‡à°¦à±€",
    "actions": "à°šà°°à±à°¯à°²à±",
    "target": "à°²à°•à±à°·à±à°¯à°‚",
    "found": "à°•à°¨à±à°—à±Šà°¨à°¬à°¡à°¿à°‚à°¦à°¿",
    "type": "à°°à°•à°‚",
    "category": "à°µà°°à±à°—à°‚",
    "version": "à°¸à°‚à°¸à±à°•à°°à°£",
    "size": "à°ªà°°à°¿à°®à°¾à°£à°‚",
    "uploadedBy": "à°…à°ªà±â€Œà°²à±‹à°¡à± à°šà±‡à°¸à°¿à°¨à°µà°¾à°°à±",
    "manager": "à°¨à°¿à°°à±à°µà°¾à°¹à°•à±à°¡à±",
    "location": "à°¸à±à°¥à°¾à°¨à°‚",
    "description": "à°µà°¿à°µà°°à°£",
    "startDate": "à°ªà±à°°à°¾à°°à°‚à°­ à°¤à±‡à°¦à±€",
    "endDate": "à°®à±à°—à°¿à°‚à°ªà± à°¤à±‡à°¦à±€",
    "assignedTo": "à°•à±‡à°Ÿà°¾à°¯à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "priority": "à°ªà±à°°à°¾à°§à°¾à°¨à±à°¯à°¤",
    "impact": "à°ªà±à°°à°­à°¾à°µà°‚",
    "probability": "à°¸à°‚à°­à°¾à°µà±à°¯à°¤",
    "owner": "à°¯à°œà°®à°¾à°¨à°¿",
    "identified": "à°—à±à°°à±à°¤à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "allStatus": "à°…à°¨à±à°¨à°¿ à°¸à±à°¥à°¿à°¤à°¿",
    "allTypes": "à°…à°¨à±à°¨à°¿ à°°à°•à°¾à°²à±",
    "allProjects": "à°…à°¨à±à°¨à°¿ à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à±",
    "project": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±",
    "total": "à°®à±Šà°¤à±à°¤à°‚",
    "inProgress": "à°ªà±à°°à°—à°¤à°¿à°²à±‹ à°‰à°‚à°¦à°¿",
    "completed": "à°ªà±‚à°°à±à°¤à°¯à°¿à°‚à°¦à°¿",
    "planning": "à°ªà±à°°à°£à°¾à°³à°¿à°•",
    "onHold": "à°ªà°Ÿà±à°Ÿà±à°•à±à°¨à±à°¨à°¾à°°à±",
    "cancelled": "à°°à°¦à±à°¦à± à°šà±‡à°¯à°¬à°¡à°¿à°‚à°¦à°¿",
    "draft": "à°¡à±à°°à°¾à°«à±à°Ÿà±",
    "underReview": "à°¸à°®à±€à°•à±à°·à°²à±‹ à°‰à°‚à°¦à°¿",
    "approved": "à°…à°¨à±à°®à±‹à°¦à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "rejected": "à°¤à°¿à°°à°¸à±à°•à°°à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "closed": "à°®à±‚à°¸à°¿à°µà±‡à°¯à°¬à°¡à°¿à°‚à°¦à°¿",
    "mitigated": "à°¤à°—à±à°—à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "assessed": "à°®à°¦à°¿à°‚à°ªà± à°šà±‡à°¯à°¬à°¡à°¿à°‚à°¦à°¿",
    "low": "à°¤à°•à±à°•à±à°µ",
    "medium": "à°®à°§à±à°¯à°¸à±à°¥",
    "high": "à°à°•à±à°•à±à°µ",
    "critical": "à°•à±à°²à°¿à°·à±à°Ÿà°®à±ˆà°¨",
    "notStarted": "à°ªà±à°°à°¾à°°à°‚à°­à°¿à°‚à°šà°¬à°¡à°²à±‡à°¦à±",
    "delayed": "à°µà°¿à°²à°‚à°¬à°‚",
    "creating": "à°¸à±ƒà°·à±à°Ÿà°¿à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±...",
    "uploading": "à°…à°ªà±â€Œà°²à±‹à°¡à± à°šà±‡à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±...",
    "authenticating": "à°ªà±à°°à°¾à°®à°¾à°£à±€à°•à°°à°¿à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±...",
    "comingSoon": "à°¤à±à°µà°°à°²à±‹ à°µà°¸à±à°¤à±à°‚à°¦à°¿",
    "accessLevel": "à°ªà±à°°à°¾à°ªà±à°¯à°¤ à°¸à±à°¥à°¾à°¯à°¿"
  },
  "dashboard": {
    "title": "à°à°•à±€à°•à±ƒà°¤ à°¡à°¾à°·à±à°¬à±‹à°°à±à°¡à±",
    "overview": "à°…à°µà°²à±‹à°•à°¨à°‚",
    "kpis": "à°ªà±à°°à°§à°¾à°¨ à°ªà°¨à°¿à°¤à±€à°°à± à°¸à±‚à°šà°¿à°•à°²à±",
    "recentProjects": "à°‡à°Ÿà±€à°µà°²à°¿ à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à±",
    "activeRisks": "à°•à±à°°à°¿à°¯à°¾à°¶à±€à°² à°°à°¿à°¸à±à°•à±â€Œà°²à±",
    "upcomingTasks": "à°°à°¾à°¬à±‹à°¯à±‡ à°ªà°¨à±à°²à±",
    "searchPlaceholder": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à±, à°ªà°¨à±à°²à±, à°°à°¿à°¸à±à°•à±â€Œà°²à± à°¶à±‹à°§à°¿à°‚à°šà°‚à°¡à°¿...",
    "createProject": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°¸à±ƒà°·à±à°Ÿà°¿à°‚à°šà°‚à°¡à°¿",
    "progress": "à°ªà±à°°à°—à°¤à°¿",
    "budgetVsSpent": "à°¬à°¡à±à°œà±†à°Ÿà± à°µà°°à±à°¸à±†à°¸à± à°–à°°à±à°šà± (à°•à±‹à°Ÿà±à°²à°²à±‹)",
    "riskDistribution": "à°ªà°‚à°ªà°¿à°£à±€",
    "projectTimeline": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°Ÿà±ˆà°®à±â€Œà°²à±ˆà°¨à±",
    "noRisksFound": "à°®à±€ à°¶à±‹à°§à°¨à°•à± à°¸à°°à°¿à°ªà°¡à°¿à°¨ à°°à°¿à°¸à±à°•à±â€Œà°²à± à°•à°¨à±à°—à±Šà°¨à°¬à°¡à°²à±‡à°¦à±.",
    "noActiveRisks": "à°•à±à°°à°¿à°¯à°¾à°¶à±€à°² à°°à°¿à°¸à±à°•à±â€Œà°²à± à°²à±‡à°µà±.",
    "noTasksFound": "à°®à±€ à°¶à±‹à°§à°¨à°•à± à°¸à°°à°¿à°ªà°¡à°¿à°¨ à°ªà°¨à±à°²à± à°•à°¨à±à°—à±Šà°¨à°¬à°¡à°²à±‡à°¦à±.",
    "noUpcomingTasks": "à°°à°¾à°¬à±‹à°¯à±‡ à°ªà°¨à±à°²à± à°²à±‡à°µà±.",
    "navigatingToRisk": "à°°à°¿à°¸à±à°•à± à°¨à°¿à°°à±à°µà°¹à°£à°•à± à°µà±†à°³à±à°¤à±à°¨à±à°¨à°¾à°°à±",
    "viewingRiskDetails": "à°°à°¿à°¸à±à°•à± à°µà°¿à°µà°°à°¾à°²à± à°®à°°à°¿à°¯à± à°¤à°—à±à°—à°¿à°‚à°ªà± à°ªà±à°°à°£à°¾à°³à°¿à°•à°²à°¨à± à°šà±‚à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±."
  },
  "login": {
    "title": "à°ªà±à°°à±‹à°—à±à°°à°¾à°®à± à°®à±‡à°¨à±‡à°œà±à°®à±†à°‚à°Ÿà± à°‡à°¨à±à°«à°°à±à°®à±‡à°·à°¨à± à°¸à°¿à°¸à±à°Ÿà°®à±",
    "subtitle": "à°œà°¹à±€à°°à°¾à°¬à°¾à°¦à± à°‡à°‚à°¡à°¸à±à°Ÿà±à°°à°¿à°¯à°²à± à°à°°à°¿à°¯à°¾",
    "selectRole": "à°•à±Šà°¨à°¸à°¾à°—à°¿à°‚à°šà°¡à°¾à°¨à°¿à°•à°¿ à°®à±€ à°ªà°¾à°¤à±à°°à°¨à± à°à°‚à°šà±à°•à±‹à°‚à°¡à°¿",
    "enter": "à°¸à°¿à°¸à±à°Ÿà°®à±â€Œà°²à±‹à°•à°¿ à°ªà±à°°à°µà±‡à°¶à°¿à°‚à°šà°‚à°¡à°¿",
    "authenticating": "à°ªà±à°°à°¾à°®à°¾à°£à±€à°•à°°à°¿à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±...",
    "welcomeBack": "à°¤à°¿à°°à°¿à°—à°¿ à°¸à±à°µà°¾à°—à°¤à°‚,"
  },
  "role": {
    "SPV_Official": "SPV à°…à°§à°¿à°•à°¾à°°à°¿",
    "PMNC_Team": "PMNC à°Ÿà±€à°®à±",
    "EPC_Contractor": "EPC à°•à°¾à°‚à°Ÿà±à°°à°¾à°•à±à°Ÿà°°à±",
    "Consultant_Design": "à°¡à°¿à°œà±ˆà°¨à± à°•à°¨à±à°¸à°²à±à°Ÿà±†à°‚à°Ÿà±",
    "Govt_Department": "à°ªà±à°°à°­à±à°¤à±à°µ à°¶à°¾à°–",
    "NICDC_HQ": "NICDC à°ªà±à°°à°§à°¾à°¨ à°•à°¾à°°à±à°¯à°¾à°²à°¯à°‚"
  },
  "projects": {
    "title": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à±",
    "subtitle": "à°…à°¨à±à°¨à°¿ à°®à±Œà°²à°¿à°• à°¸à°¦à±à°ªà°¾à°¯à°¾à°² à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à°¨à± à°¨à°¿à°°à±à°µà°¹à°¿à°‚à°šà°‚à°¡à°¿ à°®à°°à°¿à°¯à± à°Ÿà±à°°à°¾à°•à± à°šà±‡à°¯à°‚à°¡à°¿",
    "createProject": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°¸à±ƒà°·à±à°Ÿà°¿à°‚à°šà°‚à°¡à°¿",
    "searchPlaceholder": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à± à°¶à±‹à°§à°¿à°‚à°šà°‚à°¡à°¿...",
    "allStatus": "à°…à°¨à±à°¨à°¿ à°¸à±à°¥à°¿à°¤à°¿",
    "noProjectsFound": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à± à°•à°¨à±à°—à±Šà°¨à°¬à°¡à°²à±‡à°¦à±",
    "adjustFilters": "à°®à°°à°¿à°¨à±à°¨à°¿ à°«à°²à°¿à°¤à°¾à°²à°¨à± à°šà±‚à°¡à°Ÿà°¾à°¨à°¿à°•à°¿ à°®à±€ à°«à°¿à°²à±à°Ÿà°°à±â€Œà°²à°¨à± à°¸à°°à±à°¦à±à°¬à°¾à°Ÿà± à°šà±‡à°¯à°¡à°¾à°¨à°¿à°•à°¿ à°ªà±à°°à°¯à°¤à±à°¨à°¿à°‚à°šà°‚à°¡à°¿.",
    "getStarted": "à°®à±€ à°®à±Šà°¦à°Ÿà°¿ à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±â€Œà°¨à± à°¸à±ƒà°·à±à°Ÿà°¿à°‚à°šà°¡à°‚ à°¦à±à°µà°¾à°°à°¾ à°ªà±à°°à°¾à°°à°‚à°­à°¿à°‚à°šà°‚à°¡à°¿.",
    "noProjectsAvailable": "à°ªà±à°°à°¸à±à°¤à±à°¤à°‚ à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à± à°…à°‚à°¦à±à°¬à°¾à°Ÿà±à°²à±‹ à°²à±‡à°µà±.",
    "budget": "à°¬à°¡à±à°œà±†à°Ÿà±",
    "budgetUtilization": "à°¬à°¡à±à°œà±†à°Ÿà± à°µà°¿à°¨à°¿à°¯à±‹à°—à°‚",
    "totalProjects": "à°®à±Šà°¤à±à°¤à°‚ à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±à°²à±",
    "totalBudget": "à°®à±Šà°¤à±à°¤à°‚ à°¬à°¡à±à°œà±†à°Ÿà±"
  },
  "edms": {
    "subtitle": "à°à°²à°•à±à°Ÿà±à°°à°¾à°¨à°¿à°•à± à°¡à°¾à°•à±à°¯à±à°®à±†à°‚à°Ÿà± à°®à±‡à°¨à±‡à°œà±â€Œà°®à±†à°‚à°Ÿà± à°¸à°¿à°¸à±à°Ÿà°®à±",
    "searchPlaceholder": "à°ªà°¤à±à°°à°¾à°²à± à°¶à±‹à°§à°¿à°‚à°šà°‚à°¡à°¿...",
    "allStatus": "à°…à°¨à±à°¨à°¿ à°¸à±à°¥à°¿à°¤à°¿",
    "allTypes": "à°…à°¨à±à°¨à°¿ à°°à°•à°¾à°²à±",
    "documentRepository": "à°ªà°¤à±à°° à°°à°¿à°ªà±‹à°œà°¿à°Ÿà°°à±€",
    "documents": "à°ªà°¤à±à°°à°¾à°²à±",
    "noDocumentsFound": "à°ªà°¤à±à°°à°¾à°²à± à°•à°¨à±à°—à±Šà°¨à°¬à°¡à°²à±‡à°¦à±",
    "adjustFilters": "à°®à°°à°¿à°¨à±à°¨à°¿ à°«à°²à°¿à°¤à°¾à°²à°¨à± à°šà±‚à°¡à°Ÿà°¾à°¨à°¿à°•à°¿ à°®à±€ à°«à°¿à°²à±à°Ÿà°°à±â€Œà°²à°¨à± à°¸à°°à±à°¦à±à°¬à°¾à°Ÿà± à°šà±‡à°¯à°¡à°¾à°¨à°¿à°•à°¿ à°ªà±à°°à°¯à°¤à±à°¨à°¿à°‚à°šà°‚à°¡à°¿.",
    "uploadFirst": "à°ªà±à°°à°¾à°°à°‚à°­à°¿à°‚à°šà°¡à°¾à°¨à°¿à°•à°¿ à°®à±€ à°®à±Šà°¦à°Ÿà°¿ à°ªà°¤à±à°°à°¾à°¨à±à°¨à°¿ à°…à°ªà±â€Œà°²à±‹à°¡à± à°šà±‡à°¯à°‚à°¡à°¿.",
    "uploadDocument": "à°ªà°¤à±à°°à°‚ à°…à°ªà±â€Œà°²à±‹à°¡à± à°šà±‡à°¯à°‚à°¡à°¿",
    "showing": "à°šà±‚à°ªà°¿à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±",
    "to": "à°•à±",
    "of": "à°²à±‹",
    "previous": "à°®à±à°¨à±à°ªà°Ÿà°¿",
    "next": "à°¤à°°à±à°µà°¾à°¤",
    "page": "à°ªà±‡à°œà±€",
    "permissionDenied": "à°…à°¨à±à°®à°¤à°¿ à°¨à°¿à°°à°¾à°•à°°à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "noDeletePermission": "à°®à±€à°•à± à°ªà°¤à±à°°à°¾à°²à°¨à± à°¤à±Šà°²à°—à°¿à°‚à°šà±‡ à°…à°¨à±à°®à°¤à°¿ à°²à±‡à°¦à±. à°®à±€ à°¨à°¿à°°à±à°µà°¾à°¹à°•à±à°¡à°¿à°¨à°¿ à°¸à°‚à°ªà±à°°à°¦à°¿à°‚à°šà°‚à°¡à°¿.",
    "documentDeleted": "à°ªà°¤à±à°°à°‚ à°¤à±Šà°²à°—à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "documentRemoved": "à°ªà°¤à±à°°à°‚ à°°à°¿à°ªà±‹à°œà°¿à°Ÿà°°à±€ à°¨à±à°‚à°¡à°¿ à°¤à±Šà°²à°—à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿.",
    "downloadStarted": "à°¡à±Œà°¨à±â€Œà°²à±‹à°¡à± à°ªà±à°°à°¾à°°à°‚à°­à°®à±ˆà°‚à°¦à°¿",
    "downloading": "à°¡à±Œà°¨à±â€Œà°²à±‹à°¡à± à°šà±‡à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±",
    "openingDocument": "à°ªà°¤à±à°°à°‚ à°¤à±†à°°à±à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±",
    "viewing": "à°šà±‚à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±"
  },
  "scheduling": {
    "subtitle": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°·à±†à°¡à±à°¯à±‚à°²à°¿à°‚à°—à± à°®à°°à°¿à°¯à± à°Ÿà±ˆà°®à±â€Œà°²à±ˆà°¨à± à°Ÿà±à°°à°¾à°•à°¿à°‚à°—à±",
    "ganttChart": "à°—à°¾à°‚à°Ÿà± à°šà°¾à°°à±à°Ÿà±",
    "listView": "à°œà°¾à°¬à°¿à°¤à°¾ à°µà±à°¯à±‚",
    "filterByProject": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°¦à±à°µà°¾à°°à°¾ à°«à°¿à°²à±à°Ÿà°°à± à°šà±‡à°¯à°‚à°¡à°¿:",
    "ganttChartView": "à°—à°¾à°‚à°Ÿà± à°šà°¾à°°à±à°Ÿà± à°µà±à°¯à±‚",
    "projectProgress": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°ªà±à°°à°—à°¤à°¿",
    "start": "à°ªà±à°°à°¾à°°à°‚à°­à°‚",
    "end": "à°®à±à°—à°¿à°‚à°ªà±",
    "assigned": "à°•à±‡à°Ÿà°¾à°¯à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "criticalPath": "à°•à±à°²à°¿à°·à±à°Ÿà°®à±ˆà°¨ à°®à°¾à°°à±à°—à°‚",
    "taskUpdated": "à°ªà°¨à°¿ à°¨à°µà±€à°•à°°à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "taskStatusUpdated": "à°ªà°¨à°¿ à°¸à±à°¥à°¿à°¤à°¿ à°¨à°µà±€à°•à°°à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿.",
    "failedToUpdate": "à°ªà°¨à°¿à°¨à°¿ à°¨à°µà±€à°•à°°à°¿à°‚à°šà°¡à°‚à°²à±‹ à°µà°¿à°«à°²à°®à±ˆà°‚à°¦à°¿"
  },
  "cost": {
    "subtitle": "à°¬à°¡à±à°œà±†à°Ÿà± à°«à±‹à°°à±â€Œà°•à°¾à°¸à±à°Ÿà± à°®à°°à°¿à°¯à± à°–à°°à±à°šà± à°¨à°¿à°°à±à°µà°¹à°£",
    "totalBudget": "à°®à±Šà°¤à±à°¤à°‚ à°¬à°¡à±à°œà±†à°Ÿà±",
    "totalSpent": "à°®à±Šà°¤à±à°¤à°‚ à°–à°°à±à°šà±",
    "committed": "à°•à°Ÿà±à°Ÿà±à°¬à°¡à°¿",
    "remaining": "à°®à°¿à°—à°¿à°²à°¿à°¨",
    "costForecastVsActual": "à°–à°°à±à°šà± à°«à±‹à°°à±â€Œà°•à°¾à°¸à±à°Ÿà± à°µà°°à±à°¸à±†à°¸à± à°µà°¾à°¸à±à°¤à°µ",
    "forecasted": "à°«à±‹à°°à±â€Œà°•à°¾à°¸à±à°Ÿà± à°šà±‡à°¯à°¬à°¡à°¿à°‚à°¦à°¿",
    "actual": "à°µà°¾à°¸à±à°¤à°µ",
    "budgetUtilization": "à°¬à°¡à±à°œà±†à°Ÿà± à°µà°¿à°¨à°¿à°¯à±‹à°—à°‚",
    "allocated": "à°•à±‡à°Ÿà°¾à°¯à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "budgetByCategory": "à°µà°°à±à°—à°‚ à°ªà±à°°à°•à°¾à°°à°‚ à°¬à°¡à±à°œà±†à°Ÿà±"
  },
  "risk": {
    "subtitle": "à°°à°¿à°¸à±à°•à± à°°à°¿à°œà°¿à°¸à±à°Ÿà°°à± à°®à°°à°¿à°¯à± à°¤à°—à±à°—à°¿à°‚à°ªà± à°ªà±à°°à°£à°¾à°³à°¿à°•",
    "totalRisks": "à°®à±Šà°¤à±à°¤à°‚ à°°à°¿à°¸à±à°•à±â€Œà°²à±",
    "activeRisks": "à°•à±à°°à°¿à°¯à°¾à°¶à±€à°² à°°à°¿à°¸à±à°•à±â€Œà°²à±",
    "highImpact": "à°à°•à±à°•à±à°µ à°ªà±à°°à°­à°¾à°µà°‚",
    "mitigated": "à°¤à°—à±à°—à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "risksByCategory": "à°µà°°à±à°—à°‚ à°ªà±à°°à°•à°¾à°°à°‚ à°°à°¿à°¸à±à°•à±â€Œà°²à±",
    "risksByStatus": "à°¸à±à°¥à°¿à°¤à°¿ à°ªà±à°°à°•à°¾à°°à°‚ à°°à°¿à°¸à±à°•à±â€Œà°²à±",
    "mitigationPlan": "à°¤à°—à±à°—à°¿à°‚à°ªà± à°ªà±à°°à°£à°¾à°³à°¿à°•:"
  },
  "bim": {
    "subtitle": "3D à°¬à°¿à°²à±à°¡à°¿à°‚à°—à± à°‡à°¨à±à°«à°°à±à°®à±‡à°·à°¨à± à°®à±‹à°¡à°²à°¿à°‚à°—à± à°µà±à°¯à±‚à°¯à°°à±",
    "modelViewer": "3D à°®à±‹à°¡à°²à± à°µà±à°¯à±‚à°¯à°°à±",
    "interactiveVisualization": "à°®à±Œà°²à°¿à°• à°¸à°¦à±à°ªà°¾à°¯à°¾à°² à°­à°¾à°—à°¾à°² à°¯à±Šà°•à±à°• à°‡à°‚à°Ÿà°°à°¾à°•à±à°Ÿà°¿à°µà± 3D à°µà°¿à°œà±à°µà°²à±ˆà°œà±‡à°·à°¨à±",
    "infrastructureModels": "à°®à±Œà°²à°¿à°• à°¸à°¦à±à°ªà°¾à°¯à°¾à°² à°®à±‹à°¡à°²à±â€Œà°²à±",
    "modelsDescription": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°­à°¾à°—à°¾à°² à°¯à±Šà°•à±à°• 3D à°®à±‹à°¡à°²à±â€Œà°²à±",
    "interactiveView": "à°‡à°‚à°Ÿà°°à°¾à°•à±à°Ÿà°¿à°µà± à°µà±à°¯à±‚",
    "rotateZoomExplore": "à°®à±‹à°¡à°²à±â€Œà°²à°¨à± à°¤à°¿à°ªà±à°ªà°‚à°¡à°¿, à°œà±‚à°®à± à°šà±‡à°¯à°‚à°¡à°¿ à°®à°°à°¿à°¯à± à°…à°¨à±à°µà±‡à°·à°¿à°‚à°šà°‚à°¡à°¿",
    "bimIntegration": "BIM à°‡à°‚à°Ÿà°¿à°—à±à°°à±‡à°·à°¨à±",
    "bimData": "à°¬à°¿à°²à±à°¡à°¿à°‚à°—à± à°‡à°¨à±à°«à°°à±à°®à±‡à°·à°¨à± à°®à±‹à°¡à°²à°¿à°‚à°—à± à°¡à±‡à°Ÿà°¾"
  },
  "gis": {
    "subtitle": "à°œà°¿à°¯à±‹à°—à±à°°à°¾à°«à°¿à°•à± à°‡à°¨à±à°«à°°à±à°®à±‡à°·à°¨à± à°¸à°¿à°¸à±à°Ÿà°®à± & à°¸à±à°ªà±‡à°·à°¿à°¯à°²à± à°®à±à°¯à°¾à°ªà°¿à°‚à°—à±",
    "projectLocationsMap": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°²à±Šà°•à±‡à°·à°¨à±â€Œà°² à°®à±à°¯à°¾à°ªà± - à°­à°¾à°°à°¤à°¦à±‡à°¶à°‚",
    "mapDescription": "à°­à°¾à°°à°¤à°¦à±‡à°¶à°‚ à°…à°‚à°¤à°Ÿà°¾ à°…à°¨à±à°¨à°¿ à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°²à±Šà°•à±‡à°·à°¨à±â€Œà°²à± à°®à°°à°¿à°¯à± GIS à°«à±€à°šà°°à±â€Œà°²à°¨à± à°šà±‚à°ªà°¿à°‚à°šà±‡ à°‡à°‚à°Ÿà°°à°¾à°•à±à°Ÿà°¿à°µà± à°®à±à°¯à°¾à°ªà±",
    "gisFeatures": "GIS à°«à±€à°šà°°à±â€Œà°²à±"
  },
  "project": {
    "createNewProject": "à°•à±Šà°¤à±à°¤ à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°¸à±ƒà°·à±à°Ÿà°¿à°‚à°šà°‚à°¡à°¿",
    "projectName": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°ªà±‡à°°à±",
    "description": "à°µà°¿à°µà°°à°£",
    "startDate": "à°ªà±à°°à°¾à°°à°‚à°­ à°¤à±‡à°¦à±€",
    "endDate": "à°®à±à°—à°¿à°‚à°ªà± à°¤à±‡à°¦à±€",
    "budget": "à°¬à°¡à±à°œà±†à°Ÿà± (â‚¹)",
    "status": "à°¸à±à°¥à°¿à°¤à°¿",
    "category": "à°µà°°à±à°—à°‚",
    "projectManager": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°¨à°¿à°°à±à°µà°¾à°¹à°•à±à°¡à±",
    "required": "*",
    "enterProjectName": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°ªà±‡à°°à± à°¨à°®à±‹à°¦à± à°šà±‡à°¯à°‚à°¡à°¿",
    "enterDescription": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°µà°¿à°µà°°à°£ à°¨à°®à±‹à°¦à± à°šà±‡à°¯à°‚à°¡à°¿",
    "enterBudget": "à°¬à°¡à±à°œà±†à°Ÿà± à°®à±Šà°¤à±à°¤à°‚ à°¨à°®à±‹à°¦à± à°šà±‡à°¯à°‚à°¡à°¿",
    "categoryPlaceholder": "à°‰à°¦à°¾., à°®à±Œà°²à°¿à°• à°¸à°¦à±à°ªà°¾à°¯à°¾à°²à±, à°¯à±à°Ÿà°¿à°²à°¿à°Ÿà±€à°²à±",
    "enterManagerName": "à°¨à°¿à°°à±à°µà°¾à°¹à°•à±à°¡à°¿ à°ªà±‡à°°à± à°¨à°®à±‹à°¦à± à°šà±‡à°¯à°‚à°¡à°¿",
    "projectNameRequired": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°ªà±‡à°°à± à°…à°µà°¸à°°à°‚",
    "descriptionRequired": "à°µà°¿à°µà°°à°£ à°…à°µà°¸à°°à°‚",
    "startDateRequired": "à°ªà±à°°à°¾à°°à°‚à°­ à°¤à±‡à°¦à±€ à°…à°µà°¸à°°à°‚",
    "endDateRequired": "à°®à±à°—à°¿à°‚à°ªà± à°¤à±‡à°¦à±€ à°…à°µà°¸à°°à°‚",
    "endDateAfterStart": "à°®à±à°—à°¿à°‚à°ªà± à°¤à±‡à°¦à±€ à°ªà±à°°à°¾à°°à°‚à°­ à°¤à±‡à°¦à±€ à°¤à°°à±à°µà°¾à°¤ à°‰à°‚à°¡à°¾à°²à°¿",
    "validBudgetRequired": "à°šà±†à°²à±à°²à±à°¬à°¾à°Ÿà± à°…à°¯à±à°¯à±‡ à°¬à°¡à±à°œà±†à°Ÿà± à°®à±Šà°¤à±à°¤à°‚ à°…à°µà°¸à°°à°‚",
    "categoryRequired": "à°µà°°à±à°—à°‚ à°…à°µà°¸à°°à°‚",
    "managerRequired": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°¨à°¿à°°à±à°µà°¾à°¹à°•à±à°¡à± à°…à°µà°¸à°°à°‚",
    "fixFormErrors": "à°¦à°¯à°šà±‡à°¸à°¿ à°«à°¾à°°à°®à± à°²à±‹à°ªà°¾à°²à°¨à± à°¸à°°à°¿à°šà±‡à°¯à°‚à°¡à°¿",
    "createdSuccessfully": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°µà°¿à°œà°¯à°µà°‚à°¤à°‚à°—à°¾ à°¸à±ƒà°·à±à°Ÿà°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿!",
    "hasBeenAdded": "à°¸à°¿à°¸à±à°Ÿà°®à±â€Œà°²à±‹ à°œà±‹à°¡à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿.",
    "failedToCreate": "à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà± à°¸à±ƒà°·à±à°Ÿà°¿à°‚à°šà°¡à°‚à°²à±‹ à°µà°¿à°«à°²à°®à±ˆà°‚à°¦à°¿",
    "tryAgain": "à°¦à°¯à°šà±‡à°¸à°¿ à°®à°³à±à°²à±€ à°ªà±à°°à°¯à°¤à±à°¨à°¿à°‚à°šà°‚à°¡à°¿."
  },
  "upload": {
    "uploadDocument": "à°ªà°¤à±à°°à°‚ à°…à°ªà±â€Œà°²à±‹à°¡à± à°šà±‡à°¯à°‚à°¡à°¿",
    "dragAndDrop": "à°®à±€ à°«à±ˆà°²à±â€Œà°¨à± à°‡à°•à±à°•à°¡ à°²à°¾à°—à°‚à°¡à°¿ à°®à°°à°¿à°¯à± à°µà°¦à°²à°‚à°¡à°¿",
    "or": "à°²à±‡à°¦à°¾",
    "browseFiles": "à°«à±ˆà°²à±â€Œà°²à°¨à± à°¬à±à°°à±Œà°œà± à°šà±‡à°¯à°‚à°¡à°¿",
    "fileUploadedSuccessfully": "à°«à±ˆà°²à± à°µà°¿à°œà°¯à°µà°‚à°¤à°‚à°—à°¾ à°…à°ªà±â€Œà°²à±‹à°¡à± à°šà±‡à°¯à°¬à°¡à°¿à°‚à°¦à°¿!",
    "hasBeenAdded": "à°°à°¿à°ªà±‹à°œà°¿à°Ÿà°°à±€à°²à±‹ à°œà±‹à°¡à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿.",
    "uploadFailed": "à°…à°ªà±â€Œà°²à±‹à°¡à± à°µà°¿à°«à°²à°®à±ˆà°‚à°¦à°¿",
    "tryAgain": "à°¦à°¯à°šà±‡à°¸à°¿ à°®à°³à±à°²à±€ à°ªà±à°°à°¯à°¤à±à°¨à°¿à°‚à°šà°‚à°¡à°¿."
  },
  "header": {
    "english": "English",
    "hindi": "à¤¹à¤¿à¤‚à¤¦à¥€",
    "telugu": "à°¤à±†à°²à±à°—à±"
  },
  "sidebar": {
    "pmisZia": "PMIS ZIA",
    "programmeManagement": "à°ªà±à°°à±‹à°—à±à°°à°¾à°®à± à°¨à°¿à°°à±à°µà°¹à°£",
    "expandSidebar": "à°¸à±ˆà°¡à±â€Œà°¬à°¾à°°à±â€Œà°¨à± à°µà°¿à°¸à±à°¤à°°à°¿à°‚à°šà°‚à°¡à°¿",
    "collapseSidebar": "à°¸à±ˆà°¡à±â€Œà°¬à°¾à°°à±â€Œà°¨à± à°•à±à°¦à°¿à°‚à°šà°‚à°¡à°¿"
  },
  "status": {
    "planning": "à°ªà±à°°à°£à°¾à°³à°¿à°•",
    "inProgress": "à°ªà±à°°à°—à°¤à°¿à°²à±‹ à°‰à°‚à°¦à°¿",
    "onHold": "à°ªà°Ÿà±à°Ÿà±à°•à±à°¨à±à°¨à°¾à°°à±",
    "completed": "à°ªà±‚à°°à±à°¤à°¯à°¿à°‚à°¦à°¿",
    "cancelled": "à°°à°¦à±à°¦à± à°šà±‡à°¯à°¬à°¡à°¿à°‚à°¦à°¿",
    "draft": "à°¡à±à°°à°¾à°«à±à°Ÿà±",
    "underReview": "à°¸à°®à±€à°•à±à°·à°²à±‹ à°‰à°‚à°¦à°¿",
    "approved": "à°…à°¨à±à°®à±‹à°¦à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "rejected": "à°¤à°¿à°°à°¸à±à°•à°°à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "closed": "à°®à±‚à°¸à°¿à°µà±‡à°¯à°¬à°¡à°¿à°‚à°¦à°¿",
    "mitigated": "à°¤à°—à±à°—à°¿à°‚à°šà°¬à°¡à°¿à°‚à°¦à°¿",
    "assessed": "à°®à°¦à°¿à°‚à°ªà± à°šà±‡à°¯à°¬à°¡à°¿à°‚à°¦à°¿",
    "notStarted": "à°ªà±à°°à°¾à°°à°‚à°­à°¿à°‚à°šà°¬à°¡à°²à±‡à°¦à±",
    "delayed": "à°µà°¿à°²à°‚à°¬à°‚"
  },
  "priority": {
    "low": "à°¤à°•à±à°•à±à°µ",
    "medium": "à°®à°§à±à°¯à°¸à±à°¥",
    "high": "à°à°•à±à°•à±à°µ",
    "critical": "à°•à±à°²à°¿à°·à±à°Ÿà°®à±ˆà°¨"
  },
  "impact": {
    "low": "à°¤à°•à±à°•à±à°µ",
    "medium": "à°®à°§à±à°¯à°¸à±à°¥",
    "high": "à°à°•à±à°•à±à°µ",
    "critical": "à°•à±à°²à°¿à°·à±à°Ÿà°®à±ˆà°¨"
  },
  "translation": {
    "translate": "à°…à°¨à±à°µà°¦à°¿à°‚à°šà±",
    "translating": "à°…à°¨à±à°µà°¾à°¦à°‚ à°šà±‡à°¸à±à°¤à±à°¨à±à°¨à°¾à°°à±...",
    "translationFailed": "à°…à°¨à±à°µà°¾à°¦à°‚ à°µà°¿à°«à°²à°®à±ˆà°‚à°¦à°¿. à°¦à°¯à°šà±‡à°¸à°¿ à°®à°³à±à°²à±€ à°ªà±à°°à°¯à°¤à±à°¨à°¿à°‚à°šà°‚à°¡à°¿.",
    "enterTextToTranslate": "à°…à°¨à±à°µà°¦à°¿à°‚à°šà°¡à°¾à°¨à°¿à°•à°¿ à°ªà°¾à° à±à°¯à°‚ à°¨à°®à±‹à°¦à± à°šà±‡à°¯à°‚à°¡à°¿"
  }
}




================================================
FILE: frontend/src/App.jsx
================================================
import { lazy } from 'react';
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import { LanguageProvider } from './contexts/LanguageContext';
import { SidebarProvider } from './contexts/SidebarContext';
import { ThemeProvider } from './contexts/ThemeContext';

import { ToastProvider } from './components/ui/Toast';
import ErrorBoundary from './components/ui/ErrorBoundary';
import AppLayout from './components/layout/AppLayout';

// Keep auth-related pages as eager imports (needed before login)
import Login from './pages/Login';
import ContractorRegistration from './pages/ContractorRegistration';
import AcceptInvite from './pages/AcceptInvite';
import ForgotPassword from './pages/ForgotPassword';
import ResetPassword from './pages/ResetPassword';

// Lazy load all protected pages for code-splitting
const Dashboard = lazy(() => import('./pages/Dashboard'));
const Projects = lazy(() => import('./pages/Projects'));
const ProjectDetailsPage = lazy(() => import('./pages/ProjectDetailsPage'));
const RABilling = lazy(() => import('./pages/RABilling'));
const FundManagement = lazy(() => import('./pages/FundManagement'));
const Budgeting = lazy(() => import('./pages/Budgeting'));
const BOQManagement = lazy(() => import('./pages/BOQManagement'));
const Scheduling = lazy(() => import('./pages/Scheduling'));
const CostManagement = lazy(() => import('./pages/CostManagement'));
const RiskManagement = lazy(() => import('./pages/RiskManagement'));
const GIS = lazy(() => import('./pages/GIS'));
const BIM = lazy(() => import('./pages/BIM'));
const WorkflowConfig = lazy(() => import('./pages/WorkflowConfig'));
const EProcurement = lazy(() => import('./pages/EProcurement'));
const Reimbursement = lazy(() => import('./pages/Reimbursement'));
const RoleManager = lazy(() => import('./pages/RoleManager'));
const AuditLogs = lazy(() => import('./pages/admin/AuditLogs'));
const MasterData = lazy(() => import('./pages/admin/MasterData'));
const UserManagement = lazy(() => import('./pages/UserManagement'));
const EDMS = lazy(() => import('./pages/EDMS'));
const DocumentViewerPage = lazy(() => import('./pages/DocumentViewerPage'));
const Communications = lazy(() => import('./pages/Communications'));
const Approvals = lazy(() => import('./pages/Approvals'));
const ETPMaster = lazy(() => import('./pages/ETPMaster'));

const ProtectedRoute = ({ children, requiredPermission }) => {
  const { user } = useAuth();
  return user ? <>{children}</> : <Navigate to="/login" replace />;
};

const AppRoutes = () => {
  return (
    <Routes>
      <Route path="/login" element={<Login />} />
      <Route path="/register" element={<ContractorRegistration />} />
      <Route path="/accept-invite/:token" element={<AcceptInvite />} />
      <Route path="/forgot-password" element={<ForgotPassword />} />
      <Route path="/reset-password/:token" element={<ResetPassword />} />
      <Route
        path="/"
        element={
          <ProtectedRoute>
            <AppLayout />
          </ProtectedRoute>
        }
      >
        <Route index element={<Navigate to="/dashboard" replace />} />
        <Route path="dashboard" element={<Dashboard />} />
        <Route path="projects" element={<Projects />} />
        <Route path="projects/:id" element={<ProjectDetailsPage />} />
        <Route path="e-procurement" element={<EProcurement />} />
        <Route path="cost/billing" element={<RABilling />} />
        <Route path="cost/funds" element={<FundManagement />} />
        <Route path="cost/budgeting" element={<Budgeting />} />
        <Route path="cost/boq" element={<BOQManagement />} />
        <Route path="admin/audit-logs" element={<AuditLogs />} />

        <Route path="scheduling" element={<Scheduling />} />
        <Route path="users" element={<UserManagement />} />
        <Route path="edms" element={<EDMS />} />
        <Route path="edms/view/:id" element={<DocumentViewerPage />} />
        <Route path="cost" element={<CostManagement />} />
        <Route path="risk" element={<RiskManagement />} />
        <Route path="gis" element={<GIS />} />
        <Route path="bim" element={<BIM />} />
        <Route path="workflow" element={<WorkflowConfig />} />
        <Route path="reimbursement" element={<Reimbursement />} />
        <Route path="admin/roles" element={<RoleManager />} />
        <Route path="admin/master-data" element={<MasterData />} />
        <Route path="communications" element={<Communications />} />
        <Route path="communications/:threadId" element={<Communications />} />
        <Route path="approvals" element={<Approvals />} />
        <Route path="etp-master" element={<ETPMaster />} />
      </Route>
    </Routes>
  );
};

function App() {
  return (
    <BrowserRouter>
      <ThemeProvider>
        <LanguageProvider>
          <AuthProvider>
            <SidebarProvider>
              <ToastProvider />
              <ErrorBoundary>
                <AppRoutes />
              </ErrorBoundary>
            </SidebarProvider>
          </AuthProvider>
        </LanguageProvider>
      </ThemeProvider>
    </BrowserRouter>
  );
}

export default App;





================================================
FILE: frontend/src/index.css
================================================
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

/* Marquee animation for long text */
@keyframes marquee {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

.animate-marquee {
  animation: marquee linear infinite;
}

.animate-marquee:hover,
.animate-pause {
  animation-play-state: paused;
}

/* ============================================
   SEMANTIC DESIGN TOKENS
   Dark Mode Architecture using CSS Variables
   ============================================ */

@layer base {
  :root {
    /* ===== Background Colors ===== */
    /* Primary: Main page background */
    --bg-primary: 255 255 255;
    /* white */
    /* Secondary: Alternate sections, sidebars */
    --bg-secondary: 248 250 252;
    /* slate-50 */
    /* Surface: Cards, panels, elevated surfaces */
    --bg-surface: 241 245 249;
    /* slate-100 */
    /* Card: Specific card backgrounds */
    --bg-card: 255 255 255;
    /* white */
    /* Hover: Interactive element hover states */
    --bg-hover: 241 245 249;
    /* slate-100 */
    /* Active: Selected/active states */
    --bg-active: 226 232 240;
    /* slate-200 */

    /* ===== Text Colors ===== */
    /* Primary: Headings, primary text */
    --text-primary: 15 23 42;
    /* slate-900 */
    /* Secondary: Body text, labels */
    --text-secondary: 71 85 105;
    /* slate-600 */
    /* Muted: Subtle text, placeholders */
    --text-muted: 100 116 139;
    /* slate-500 */
    /* Inverse: Text on dark backgrounds */
    --text-inverse: 248 250 252;
    /* slate-50 */

    /* ===== Border Colors ===== */
    /* Default: Standard borders */
    --border-default: 226 232 240;
    /* slate-200 */
    /* Muted: Subtle dividers */
    --border-muted: 241 245 249;
    /* slate-100 */
    /* Focus: Focused interactive elements */
    --border-focus: 37 99 235;
    /* blue-600 */

    /* ===== Semantic State Colors ===== */
    /* Success */
    --success-bg: 220 252 231;
    /* green-100 */
    --success-text: 22 163 74;
    /* green-600 */
    --success-border: 134 239 172;
    /* green-300 */

    /* Error */
    --error-bg: 254 226 226;
    /* red-100 */
    --error-text: 220 38 38;
    /* red-600 */
    --error-border: 252 165 165;
    /* red-300 */

    /* Warning */
    --warning-bg: 254 243 199;
    /* amber-100 */
    --warning-text: 217 119 6;
    /* amber-600 */
    --warning-border: 253 230 138;
    /* amber-200 */

    /* Info */
    --info-bg: 219 234 254;
    /* blue-100 */
    --info-text: 37 99 235;
    /* blue-600 */
    --info-border: 147 197 253;
    /* blue-300 */

    /* ===== Accent/Brand Colors ===== */
    /* Primary accent */
    --accent-primary: 37 99 235;
    /* blue-600 */
    --accent-primary-hover: 29 78 216;
    /* blue-700 */
    --accent-primary-active: 30 64 175;
    /* blue-800 */

    /* Secondary accent (if needed) */
    --accent-secondary: 99 102 241;
    /* indigo-500 */
    --accent-secondary-hover: 79 70 229;
    /* indigo-600 */

    /* ===== Shadow Colors ===== */
    --shadow-sm: 0 0 0 0;
    /* Light mode uses default shadows */
    --shadow-md: 0 0 0 0;
    --shadow-lg: 0 0 0 0;
  }

  /* DARK MODE - True Neutral (No Blue Tint) */
  .dark {
    /* ===== Only Background & Text Inversion ===== */
    /* Background: White â†’ Black */
    --bg-primary: 0 0 0;
    /* Black */
    --bg-secondary: 10 10 10;
    /* Neutral-950 (Was 17 24 39) */
    --bg-surface: 23 23 23;
    /* Neutral-900 (Was 31 41 55) */
    --bg-card: 23 23 23;
    /* Neutral-900 (Was 17 24 39) */
    --bg-hover: 38 38 38;
    /* Neutral-800 (Was 31 41 55) */
    --bg-active: 64 64 64;
    /* Neutral-700 (Was 55 65 81) */

    /* Text: Black â†’ White */
    --text-primary: 255 255 255;
    /* White */
    --text-secondary: 212 212 212;
    /* Neutral-300 (Was 209 213 219) */
    --text-muted: 163 163 163;
    /* Neutral-400 (Was 156 163 175) */
    --text-inverse: 0 0 0;
    /* Black */

    /* Borders: Adjusted for dark background */
    --border-default: 38 38 38;
    /* Neutral-800 (Was 55 65 81) */
    --border-muted: 23 23 23;
    /* Neutral-900 (Was 31 41 55) */
    --border-focus: 59 130 246;
    /* Keep blue for focus */

    /* ===== Keep All Other Colors Unchanged ===== */
    /* Success, Error, Warning, Info stay the same as light mode */
    /* Accent colors stay the same as light mode */
    /* These are defined in the :root and DON'T change in dark mode */
  }
}

/* ============================================
   ORIGINAL ROOT STYLES
   ============================================ */

:root {
  font-family: 'Inter', system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light;
  color: rgba(15, 23, 42, 0.87);
  /* Slate-900 */
  background-color: #f8fafc;
  /* Slate-50 */

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.dark {
  color-scheme: dark;
  color: #f8fafc;
  /* Slate-50 */
  background-color: #1e1e1e;
  /* Custom Dark BG */

  /* Font optimizations for dark mode */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Heading font weight adjustments for dark mode */
.dark h1,
.dark h2,
.dark h3,
.dark h4,
.dark h5,
.dark h6 {
  font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif;
  font-weight: 600;
  /* Lighter than 700 for better dark mode readability */
  color: #f8fafc;
  /* Slate-50 (white in dark) */
}

h1,
h2,
h3,
h4,
h5,
h6 {
  font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif;
  font-weight: 700;
  color: #0f172a;
  /* Slate-900 */
}

body {
  margin: 0;
  min-width: 320px;
  min-height: 100vh;
}

#root {
  width: 100%;
  min-height: 100vh;
}

/* Leaflet map styles */
.leaflet-container {
  height: 100%;
  width: 100%;
  z-index: 1;
}

/* Scrollbar styles */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: rgb(203 213 225 / 0.5);
  border-radius: 10px;
  transition: background 0.2s;
}

::-webkit-scrollbar-thumb:hover {
  background: rgb(148 163 184 / 0.7);
}

/* Dark mode scrollbar */
.dark ::-webkit-scrollbar-thumb {
  background: rgb(71 85 105 / 0.5);
}

.dark ::-webkit-scrollbar-thumb:hover {
  background: rgb(100 116 139 / 0.7);
}

/* Backdrop blur support for better browser compatibility */
@supports (backdrop-filter: blur(12px)) {
  .backdrop-blur-md {
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
}

/* Ensure modals are above all other content */
.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 50;
  /* Changed from 9999 to 50 to match standard Tailwind/Project z-index scale */
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

/* Extended Glassmorphism & Visual Polish */
.glass-panel {
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
}

.shadow-glass {
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
}

.shadow-teal-glow {
  box-shadow: 0 0 15px rgba(20, 184, 166, 0.2);
}

.shadow-blue-glow {
  box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
}

/* Gradient Text Utilities */
.text-gradient-primary {
  background: linear-gradient(135deg, #2563eb 0%, #0f172a 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ============================================
   Mobile Responsiveness Utilities
   ============================================ */

/**
 * Prevent text size adjustment on orientation change (iOS)
 * This ensures consistent typography on mobile devices
 */
html {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/**
 * Touch target optimization
 * Ensures minimum 44x44px touch targets on mobile devices
 * Apple HIG and Material Design recommend minimum 44px
 */
@media (max-width: 768px) {

  button,
  [role="button"],
  input[type="submit"],
  input[type="button"],
  input[type="checkbox"],
  input[type="radio"] {
    min-height: 44px;
  }

  /* Larger inputs for easier touch on mobile */
  input[type="text"],
  input[type="email"],
  input[type="password"],
  input[type="number"],
  input[type="tel"],
  input[type="url"],
  input[type="search"],
  input[type="date"],
  textarea,
  select {
    min-height: 44px;
    font-size: 16px;
    /* Prevents iOS zoom on focus */
  }
}

/**
 * Smooth momentum scrolling for iOS
 * Enables native-feeling scroll behavior
 */
.overflow-y-auto,
.overflow-x-auto,
.overflow-auto {
  -webkit-overflow-scrolling: touch;
}

/**
 * Safe area insets for notched devices (iPhone X+)
 * Ensures content doesn't overlap with device UI
 */
@supports (padding: max(0px)) {
  .safe-area-inset {
    padding-left: max(0px, env(safe-area-inset-left));
    padding-right: max(0px, env(safe-area-inset-right));
    padding-bottom: max(0px, env(safe-area-inset-bottom));
  }
}

/**
 * Mobile-optimized scrollbar
 * Hides scrollbar on mobile for cleaner appearance
 */
@media (max-width: 768px) {
  .mobile-hide-scrollbar::-webkit-scrollbar {
    display: none;
  }

  .mobile-hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
}

/**
 * Prevent pull-to-refresh on mobile web apps
 */
body {
  overscroll-behavior-y: contain;
}

/**
 * Responsive container utility
 * Adds appropriate padding based on screen size
 */
.container-responsive {
  width: 100%;
  padding-left: 1rem;
  padding-right: 1rem;
}

@media (min-width: 640px) {
  .container-responsive {
    padding-left: 1.5rem;
    padding-right: 1.5rem;
  }
}

@media (min-width: 1024px) {
  .container-responsive {
    padding-left: 2rem;
    padding-right: 2rem;
  }
}

/* ============================================
   FUTURE-PROOF SEMANTIC UTILITY CLASSES
   ============================================ */

@layer utilities {

  /* Background utilities - auto-switch */
  .bg-app {
    background-color: rgb(var(--bg-primary));
  }

  .bg-app-secondary {
    background-color: rgb(var(--bg-secondary));
  }

  .bg-app-surface {
    background-color: rgb(var(--bg-surface));
  }

  .bg-app-card {
    background-color: rgb(var(--bg-card));
  }

  .bg-app-hover {
    background-color: rgb(var(--bg-hover));
  }

  .bg-app-active {
    background-color: rgb(var(--bg-active));
  }

  /* Text utilities - auto-switch */
  .text-app-heading {
    color: rgb(var(--text-primary));
  }

  .text-app {
    color: rgb(var(--text-secondary));
  }

  .text-app-muted {
    color: rgb(var(--text-muted));
  }

  .text-app-inverse {
    color: rgb(var(--text-inverse));
  }

  /* Border utilities - auto-switch */
  .border-app {
    border-color: rgb(var(--border-default));
  }

  .border-app-subtle {
    border-color: rgb(var(--border-muted));
  }

  .border-app-focus {
    border-color: rgb(var(--border-focus));
  }

  /* Accent utilities */
  .bg-app-accent {
    background-color: rgb(var(--accent-primary));
  }

  .text-app-accent {
    color: rgb(var(--accent-primary));
  }
}


================================================
FILE: frontend/src/main.jsx
================================================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'

// Enhanced Error Boundary with recovery for Google Translate DOM conflicts
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props)
    this.state = { hasError: false, error: null, errorInfo: null }
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error }
  }

  componentDidCatch(error, errorInfo) {
    console.error('Application Error:', error, errorInfo)
    this.setState({ errorInfo })

    // Check if this is likely a Google Translate related error
    const isTranslateError = error?.message?.includes('removeChild') ||
      error?.message?.includes('insertBefore') ||
      error?.message?.includes('not a child');

    if (isTranslateError) {
      console.warn('This error is likely caused by Google Translate DOM manipulation. Reloading may help.');
    }
  }

  handleReload = () => {
    // Clear Google Translate cookies before reload
    document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=' + window.location.hostname;
    localStorage.removeItem('pmis_language');
    window.location.reload();
  }

  render() {
    if (this.state.hasError) {
      const isTranslateError = this.state.error?.message?.includes('removeChild') ||
        this.state.error?.message?.includes('insertBefore') ||
        this.state.error?.message?.includes('not a child');

      return (
        <div style={{
          padding: '3rem',
          fontFamily: 'system-ui, -apple-system, sans-serif',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          color: 'white',
          textAlign: 'center'
        }}>
          <div style={{
            background: 'rgba(255,255,255,0.95)',
            borderRadius: '16px',
            padding: '2.5rem',
            maxWidth: '500px',
            color: '#1a1a2e',
            boxShadow: '0 25px 50px rgba(0,0,0,0.25)'
          }}>
            <h1 style={{ margin: '0 0 1rem', fontSize: '1.5rem', color: '#e74c3c' }}>
              {isTranslateError ? 'âš ï¸ Translation Conflict' : 'âš ï¸ Something went wrong'}
            </h1>
            <p style={{ margin: '0 0 1.5rem', color: '#666', lineHeight: '1.6' }}>
              {isTranslateError
                ? 'The page translation temporarily conflicted with the app. This is a known issue with Google Translate. Click below to reload.'
                : (this.state.error?.message || 'An unexpected error occurred.')
              }
            </p>
            <button
              onClick={this.handleReload}
              style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                border: 'none',
                padding: '0.75rem 2rem',
                borderRadius: '8px',
                fontSize: '1rem',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'transform 0.2s, box-shadow 0.2s',
                boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
              }}
              onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
              onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
            >
              ğŸ”„ Reload Page
            </button>
          </div>
        </div>
      )
    }

    return this.props.children
  }
}

const rootElement = document.getElementById('root')
if (!rootElement) {
  throw new Error('Root element not found')
}

ReactDOM.createRoot(rootElement).render(
  <React.StrictMode>
    <ErrorBoundary>
      <App />
    </ErrorBoundary>
  </React.StrictMode>,
)




================================================
FILE: frontend/src/api/client.js
================================================
import axios from 'axios';

// Use environment variable in production, fall back to localhost in development
const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000/api';

const client = axios.create({
    baseURL: API_BASE_URL,
    headers: {
        'Content-Type': 'application/json',
    },
});

// Add a request interceptor to attach the token and handle FormData
client.interceptors.request.use(
    (config) => {
        const token = localStorage.getItem('access_token');
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }

        // If the request body is FormData, let the browser set the Content-Type
        // (it needs to add the boundary parameter for multipart/form-data)
        if (config.data instanceof FormData) {
            delete config.headers['Content-Type'];
        }

        return config;
    },
    (error) => {
        return Promise.reject(error);
    }
);

// Add a response interceptor to handle token refresh
client.interceptors.response.use(
    (response) => response,
    async (error) => {
        const originalRequest = error.config;

        // If error is 401 and we haven't retried yet
        if (error.response?.status === 401 && !originalRequest._retry) {
            originalRequest._retry = true;

            const refreshToken = localStorage.getItem('refresh_token');
            if (refreshToken) {
                try {
                    // Start refreshing
                    // We use axios directly or a separate instance to avoid infinite loops if this fails
                    const response = await axios.post(`${API_BASE_URL.replace('/api', '')}/api/auth/refresh/`, {
                        refresh: refreshToken
                    });

                    if (response.status === 200) {
                        const { access } = response.data;

                        // Save new token
                        localStorage.setItem('access_token', access);

                        // Update default headers for future requests
                        client.defaults.headers.common['Authorization'] = `Bearer ${access}`;

                        // Update current request headers and retry
                        originalRequest.headers['Authorization'] = `Bearer ${access}`;
                        return client(originalRequest);
                    }
                } catch (refreshError) {
                    console.error("Token refresh failed:", refreshError);
                    // Refresh failed - clean up and redirect
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    window.location.href = '/login';
                    return Promise.reject(refreshError);
                }
            } else {
                // No refresh token available
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = '/login';
            }
        }
        return Promise.reject(error);
    }
);

export default client;



================================================
FILE: frontend/src/api/services/calendarService.js
================================================
/**
 * Calendar API Service
 */
import client from '../client';

export const calendarService = {
    /**
     * Get calendar events within date range
     */
    getEvents: async (startDate, endDate, filters = {}) => {
        const params = new URLSearchParams();
        if (startDate) params.append('start', startDate);
        if (endDate) params.append('end', endDate);
        if (filters.event_types?.length) params.append('event_types', filters.event_types.join(','));
        if (filters.projects?.length) params.append('projects', filters.projects.join(','));

        const response = await client.get(`/projects/dashboard/calendar/?${params.toString()}`);
        return response.data;
    },

    /**
     * Get upcoming events (next 7 days)
     */
    getUpcoming: async (days = 7) => {
        const start = new Date().toISOString().split('T')[0];
        const end = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        return calendarService.getEvents(start, end);
    }
};

/**
 * Event type colors
 */
export const EVENT_COLORS = {
    MILESTONE: '#3b82f6',
    BILLING: '#10b981',
    RISK: '#ef4444',
    COMPLIANCE: '#f97316',
    WORKFLOW: '#8b5cf6',
    MEETING: '#06b6d4'
};

/**
 * Get event type label
 */
export const getEventTypeLabel = (type) => {
    const labels = {
        MILESTONE: 'Milestone',
        BILLING: 'Billing',
        RISK: 'Risk',
        COMPLIANCE: 'Compliance',
        WORKFLOW: 'Approval',
        MEETING: 'Meeting'
    };
    return labels[type] || type;
};

export default calendarService;



================================================
FILE: frontend/src/api/services/dashboardService.js
================================================
import client from '../client';

/**
 * Dashboard Service
 * 
 * Provides API endpoints for dashboard statistics and activity feed.
 */

const dashboardService = {
    /**
     * Get aggregated dashboard statistics
     * Returns: KPIs, financial summary, project stats, pending approvals, recent activity
     */
    getStats: async () => {
        const response = await client.get('/projects/dashboard/stats/');
        return response.data;
    },

    /**
     * Get recent activity feed
     * @param {number} limit - Maximum number of activities to return
     */
    getActivity: async (limit = 20) => {
        const response = await client.get('/projects/dashboard/activity/', {
            params: { limit }
        });
        return response.data;
    },

    /**
     * Get project status distribution for charts
     */
    getProjectDistribution: async () => {
        const stats = await dashboardService.getStats();
        return [
            { name: 'In Progress', value: stats.project_stats.in_progress, color: '#3b82f6' },
            { name: 'Planning', value: stats.project_stats.planning, color: '#f59e0b' },
            { name: 'Completed', value: stats.project_stats.completed, color: '#10b981' },
            { name: 'On Hold', value: stats.project_stats.on_hold, color: '#6b7280' },
        ].filter(item => item.value > 0);
    },

    /**
     * Get financial summary for charts
     */
    getFinancialSummary: async () => {
        const stats = await dashboardService.getStats();
        return {
            budget: stats.financial_summary.total_budget,
            spent: stats.financial_summary.total_spent,
            remaining: stats.financial_summary.remaining,
            utilization: stats.financial_summary.utilization,
        };
    },
};

export default dashboardService;



================================================
FILE: frontend/src/api/services/edmsService.js
================================================
/**
 * EDMS Service - Document Management API
 * 
 * Provides functions for interacting with the Electronic Document Management System.
 * Supports smart routing via auto_route_category for automatic folder placement.
 */
import client from '@/api/client';

const edmsService = {
    /**
     * Upload a document with optional smart routing
     * 
     * @param {Object} options - Upload options
     * @param {number} options.projectId - Target project ID
     * @param {File} options.file - File to upload
     * @param {string} [options.title] - Document title (optional, defaults to filename)
     * @param {string} [options.description] - Document description
     * @param {string} [options.documentType='OTHER'] - Document type
     * @param {string} [options.folderId] - Manual folder selection (UUID)
     * @param {string} [options.autoRouteCategory] - Smart routing category (e.g., 'FUNDING_PROOF', 'RA_BILL')
     * @param {boolean} [options.isConfidential=false] - Mark as confidential
     * @param {Function} [options.onProgress] - Progress callback (percent)
     * @returns {Promise<Object>} Uploaded document data
     */
    uploadDocument: async ({
        projectId,
        file,
        title,
        description = '',
        documentType = 'OTHER',
        folderId = null,
        autoRouteCategory = null,
        isConfidential = false,
        onProgress = null,
    }) => {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('project', projectId);
        formData.append('document_type', documentType);
        formData.append('is_confidential', isConfidential);

        // Optional fields
        if (title) {
            formData.append('title', title);
        }
        if (description) {
            formData.append('description', description);
        }

        // Smart routing: auto_route_category takes precedence over manual folder
        if (autoRouteCategory) {
            formData.append('auto_route_category', autoRouteCategory);
        } else if (folderId) {
            formData.append('folder', folderId);
        }

        const config = {
            headers: { 'Content-Type': 'multipart/form-data' },
        };

        if (onProgress) {
            config.onUploadProgress = (progressEvent) => {
                const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                onProgress(percent);
            };
        }

        const response = await client.post('/edms/documents/', formData, config);
        return response.data;
    },

    /**
     * Upload multiple documents with smart routing
     * 
     * @param {Object} options - Batch upload options
     * @param {number} options.projectId - Target project ID
     * @param {Array<{file: File, title?: string}>} options.files - Files to upload
     * @param {string} options.autoRouteCategory - Smart routing category for all files
     * @param {string} [options.documentType='OTHER'] - Document type for all files
     * @returns {Promise<{success: number, failed: number, errors: Array}>}
     */
    uploadDocumentsBatch: async ({
        projectId,
        files,
        autoRouteCategory,
        documentType = 'OTHER',
    }) => {
        const results = {
            success: 0,
            failed: 0,
            errors: [],
        };

        const uploadPromises = files.map(async ({ file, title }) => {
            try {
                await edmsService.uploadDocument({
                    projectId,
                    file,
                    title: title || file.name.replace(/\.[^/.]+$/, ''),
                    autoRouteCategory,
                    documentType,
                });
                results.success++;
            } catch (error) {
                results.failed++;
                results.errors.push({
                    fileName: file.name,
                    error: error.response?.data?.error || error.message,
                });
            }
        });

        await Promise.all(uploadPromises);
        return results;
    },

    /**
     * Get documents for a project
     */
    getDocuments: async (projectId, params = {}) => {
        const response = await client.get('/edms/documents/', {
            params: { project: projectId, ...params }
        });
        return response.data;
    },

    /**
     * Get folders for a project
     */
    getFolders: async (projectId) => {
        const response = await client.get(`/edms/folders/?project=${projectId}`);
        return Array.isArray(response.data) ? response.data : (response.data.results || []);
    },

    /**
     * Get folder tree for a project
     */
    getFolderTree: async (projectId) => {
        const response = await client.get(`/edms/folders/tree/?project=${projectId}`);
        return response.data;
    },
};

export default edmsService;



================================================
FILE: frontend/src/api/services/evmService.js
================================================
/**
 * EVM (Earned Value Management) API Service
 * 
 * Provides API calls for:
 * - EVM metrics (CPI, SPI, CV, SV, EAC, etc.)
 * - S-Curve chart data
 * - Historical snapshots
 */
import client from '../client';

const evmService = {
    /**
     * Get current EVM metrics for a project
     * @param {string} projectId 
     */
    getMetrics: (projectId) => {
        return client.get(`/finance/evm/metrics/${projectId}/`);
    },

    /**
     * Get S-Curve time-series data for charting
     * @param {string} projectId 
     * @param {Object} options - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
     */
    getSCurveData: (projectId, options = {}) => {
        const params = new URLSearchParams();
        if (options.start) params.append('start', options.start);
        if (options.end) params.append('end', options.end);
        return client.get(`/finance/evm/s-curve/${projectId}/?${params.toString()}`);
    },

    /**
     * Get EVM snapshot history
     * @param {string} projectId 
     * @param {number} limit 
     */
    getHistory: (projectId, limit = 50) => {
        return client.get(`/finance/evm/history/${projectId}/?limit=${limit}`);
    },

    /**
     * Create EVM snapshot for a project
     * @param {string} projectId 
     */
    createSnapshot: (projectId) => {
        return client.post(`/finance/evm/snapshot/${projectId}/`);
    },

    /**
     * Create EVM snapshots for all projects (admin only)
     */
    createAllSnapshots: () => {
        return client.post('/finance/evm/snapshot-all/');
    },

    // ========== HELPER METHODS ==========

    /**
     * Get status color based on CPI/SPI value
     * @param {number} value 
     */
    getPerformanceColor: (value) => {
        if (value >= 1.0) return { bg: 'bg-green-100', text: 'text-green-700', label: 'Good' };
        if (value >= 0.9) return { bg: 'bg-yellow-100', text: 'text-yellow-700', label: 'Warning' };
        return { bg: 'bg-red-100', text: 'text-red-700', label: 'Critical' };
    },

    /**
     * Format currency in Indian notation (Lakhs/Crores)
     * @param {number} value 
     */
    formatIndianCurrency: (value) => {
        if (value >= 10000000) {
            return `â‚¹${(value / 10000000).toFixed(2)} Cr`;
        } else if (value >= 100000) {
            return `â‚¹${(value / 100000).toFixed(2)} L`;
        }
        return `â‚¹${value.toLocaleString('en-IN')}`;
    },

    /**
     * Get variance status
     * @param {number} variance 
     */
    getVarianceStatus: (variance) => {
        if (variance > 0) return { color: 'text-green-600', icon: 'â†‘', label: 'Favorable' };
        if (variance < 0) return { color: 'text-red-600', icon: 'â†“', label: 'Unfavorable' };
        return { color: 'text-gray-600', icon: 'â†’', label: 'On Target' };
    }
};

export default evmService;



================================================
FILE: frontend/src/api/services/financeService.js
================================================
import client from '../client';

/**
 * Finance Service
 * 
 * Handles billing, ETP calculations, and financial operations.
 */
const financeService = {
    // ========== ETP Calculations ==========

    /**
     * Calculate ETP deductions for a bill
     * @param {Object} params - Calculation parameters
     * @param {number} params.gross_amount - Gross bill value
     * @param {number} params.gst_percentage - GST percentage (default 18)
     * @param {number} params.retention_percentage - Security deposit percentage
     * @param {number} params.other_deductions - Manual deductions
     * @param {number} params.advances_recovery - Advance recovery amount
     * @param {number} params.works_component - Optional works component
     * @param {number} params.material_cost - Optional material cost
     * @param {number} params.labour_cost - Optional labour cost
     * @returns {Promise} Complete bill summary with all calculated charges
     */
    calculateETP: (params) => client.post('/finance/bills/calculate_etp/', params),

    // ========== RA Bills ==========
    getRABills: (params = {}) => client.get('/finance/bills/', { params }),
    getRABill: (id) => client.get(`/finance/bills/${id}/`),
    createBill: (data) => client.post('/finance/bills/', data),
    updateBill: (id, data) => client.put(`/finance/bills/${id}/`, data),
    deleteBill: (id) => client.delete(`/finance/bills/${id}/`),
    verifyBill: (id) => client.post(`/finance/bills/${id}/verify/`),
    payBill: (id) => client.post(`/finance/bills/${id}/pay/`),

    // ========== BOQ Items ==========
    getBOQItems: (params = {}) => client.get('/finance/boq/', { params }),
    getBOQItem: (id) => client.get(`/finance/boq/${id}/`),
    createBOQItem: (data) => client.post('/finance/boq/', data),
    updateBOQItem: (id, data) => client.put(`/finance/boq/${id}/`, data),
    deleteBOQItem: (id) => client.delete(`/finance/boq/${id}/`),
    analyzeFile: (formData) => client.post('/finance/boq/analyze_file/', formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
    }),
    importFile: (formData) => client.post('/finance/boq/import_file/', formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
    }),
    requestFreeze: (data) => client.post('/finance/boq/request_freeze/', data),
    requestUnfreeze: (data) => client.post('/finance/boq/request_unfreeze/', data),

    // ========== Fund Heads ==========
    getFundHeads: () => client.get('/finance/funds/'),
    getFundHead: (id) => client.get(`/finance/funds/${id}/`),
    createFundHead: (data) => client.post('/finance/funds/', data),
    updateFundHead: (id, data) => client.put(`/finance/funds/${id}/`, data),

    // ========== Budget Line Items ==========
    getBudgetItems: (params = {}) => client.get('/finance/budgets/', { params }),
    createBudgetItem: (data) => client.post('/finance/budgets/', data),
    updateBudgetItem: (id, data) => client.put(`/finance/budgets/${id}/`, data),

    // ========== Schedule Tasks (for milestone linking) ==========
    getScheduleTasks: (projectId) => client.get(`/scheduling/tasks/`, { params: { project: projectId } }),

    // ========== Active ETP Charges ==========
    getActiveEtpCharges: () => client.get('/masters/etp-charges/'),

    // ========== Approval Requests ==========
    getApprovalRequests: (params = {}) => client.get('/finance/approval-requests/', { params }),
    getPendingApprovals: () => client.get('/finance/approval-requests/pending/'),
    approveRequest: (id, notes = '') => client.post(`/finance/approval-requests/${id}/approve/`, { notes }),
    rejectRequest: (id, notes = '') => client.post(`/finance/approval-requests/${id}/reject/`, { notes }),

    // ========== Notifications ==========
    getNotifications: () => client.get('/finance/notifications/'),
    getUnreadCount: () => client.get('/finance/notifications/unread_count/'),
    markRead: (id) => client.post(`/finance/notifications/${id}/mark_read/`),
    markAllRead: () => client.post('/finance/notifications/mark_all_read/'),
};

export default financeService;



================================================
FILE: frontend/src/api/services/mastersService.js
================================================
import client from '../client';

const mastersService = {
    // ========== Hierarchy ==========
    // Zones
    getZones: () => client.get('/masters/zones/'),
    getZone: (id) => client.get(`/masters/zones/${id}/`),
    createZone: (data) => client.post('/masters/zones/', data),
    updateZone: (id, data) => client.patch(`/masters/zones/${id}/`, data),
    deleteZone: (id) => client.delete(`/masters/zones/${id}/`),
    getZoneCircles: (zoneId) => client.get(`/masters/zones/${zoneId}/circles/`),

    // Circles
    getCircles: (params = {}) => client.get('/masters/circles/', { params }),
    getCircle: (id) => client.get(`/masters/circles/${id}/`),
    createCircle: (data) => client.post('/masters/circles/', data),
    updateCircle: (id, data) => client.patch(`/masters/circles/${id}/`, data),
    deleteCircle: (id) => client.delete(`/masters/circles/${id}/`),
    getCircleDivisions: (circleId) => client.get(`/masters/circles/${circleId}/divisions/`),

    // Divisions
    getDivisions: (params = {}) => client.get('/masters/divisions/', { params }),
    getDivision: (id) => client.get(`/masters/divisions/${id}/`),
    createDivision: (data) => client.post('/masters/divisions/', data),
    updateDivision: (id, data) => client.patch(`/masters/divisions/${id}/`, data),
    deleteDivision: (id) => client.delete(`/masters/divisions/${id}/`),
    getDivisionSubDivisions: (divId) => client.get(`/masters/divisions/${divId}/subdivisions/`),

    // SubDivisions
    getSubDivisions: (params = {}) => client.get('/masters/subdivisions/', { params }),
    getSubDivision: (id) => client.get(`/masters/subdivisions/${id}/`),
    createSubDivision: (data) => client.post('/masters/subdivisions/', data),
    updateSubDivision: (id, data) => client.patch(`/masters/subdivisions/${id}/`, data),
    deleteSubDivision: (id) => client.delete(`/masters/subdivisions/${id}/`),

    // ========== Geography ==========
    // Districts
    getDistricts: (params = {}) => client.get('/masters/districts/', { params }),
    getDistrict: (id) => client.get(`/masters/districts/${id}/`),
    createDistrict: (data) => client.post('/masters/districts/', data),
    updateDistrict: (id, data) => client.patch(`/masters/districts/${id}/`, data),
    deleteDistrict: (id) => client.delete(`/masters/districts/${id}/`),
    getDistrictTowns: (distId) => client.get(`/masters/districts/${distId}/towns/`),

    // Towns
    getTowns: (params = {}) => client.get('/masters/towns/', { params }),
    getTown: (id) => client.get(`/masters/towns/${id}/`),
    createTown: (data) => client.post('/masters/towns/', data),
    updateTown: (id, data) => client.patch(`/masters/towns/${id}/`, data),
    deleteTown: (id) => client.delete(`/masters/towns/${id}/`),

    // ========== Locations (Country â†’ State â†’ District â†’ City) ==========
    getCountries: (params = {}) => client.get('/masters/countries/', { params }),
    getCountry: (id) => client.get(`/masters/countries/${id}/`),

    getStates: (params = {}) => client.get('/masters/states/', { params }),
    getState: (id) => client.get(`/masters/states/${id}/`),
    getStateDistricts: (stateId) => client.get(`/masters/states/${stateId}/districts/`),

    getLocationDistricts: (params = {}) => client.get('/masters/location-districts/', { params }),
    getLocationDistrict: (id) => client.get(`/masters/location-districts/${id}/`),
    getDistrictCities: (districtId) => client.get(`/masters/location-districts/${districtId}/cities/`),

    getCities: (params = {}) => client.get('/masters/cities/', { params }),
    getCity: (id) => client.get(`/masters/cities/${id}/`),

    // ========== Classification ==========
    // Scheme Types
    getSchemeTypes: () => client.get('/masters/scheme-types/'),
    getSchemeType: (id) => client.get(`/masters/scheme-types/${id}/`),
    createSchemeType: (data) => client.post('/masters/scheme-types/', data),
    updateSchemeType: (id, data) => client.patch(`/masters/scheme-types/${id}/`, data),
    deleteSchemeType: (id) => client.delete(`/masters/scheme-types/${id}/`),

    // Schemes
    getSchemes: (params = {}) => client.get('/masters/schemes/', { params }),
    getScheme: (id) => client.get(`/masters/schemes/${id}/`),
    createScheme: (data) => client.post('/masters/schemes/', data),
    updateScheme: (id, data) => client.patch(`/masters/schemes/${id}/`, data),
    deleteScheme: (id) => client.delete(`/masters/schemes/${id}/`),

    // Work Types
    getWorkTypes: () => client.get('/masters/work-types/'),
    getWorkType: (id) => client.get(`/masters/work-types/${id}/`),
    createWorkType: (data) => client.post('/masters/work-types/', data),
    updateWorkType: (id, data) => client.patch(`/masters/work-types/${id}/`, data),
    deleteWorkType: (id) => client.delete(`/masters/work-types/${id}/`),

    // Project Categories
    getProjectCategories: () => client.get('/masters/project-categories/'),
    getProjectCategory: (id) => client.get(`/masters/project-categories/${id}/`),
    createProjectCategory: (data) => client.post('/masters/project-categories/', data),
    updateProjectCategory: (id, data) => client.patch(`/masters/project-categories/${id}/`, data),
    deleteProjectCategory: (id) => client.delete(`/masters/project-categories/${id}/`),
    // Auto-categorization based on contract value
    suggestProjectCategory: (contractValue) => client.get('/masters/project-categories/suggest_category/', {
        params: { contract_value: contractValue }
    }),

    // ========== Entities ==========
    // Contractors
    getContractors: (params = {}) => client.get('/masters/contractors/', { params }),
    getActiveContractors: () => client.get('/masters/contractors/active/'),
    getContractor: (id) => client.get(`/masters/contractors/${id}/`),
    createContractor: (data) => client.post('/masters/contractors/', data),
    updateContractor: (id, data) => client.patch(`/masters/contractors/${id}/`, data),
    deleteContractor: (id) => client.delete(`/masters/contractors/${id}/`),
    syncContractorsFromUsers: () => client.post('/masters/contractors/sync_from_users/'),

    // ========== Finance Config ==========
    // ETP Charges
    getETPCharges: (params = {}) => client.get('/masters/etp-charges/', { params }),
    getActiveETPCharges: () => client.get('/masters/etp-charges/active/'),
    getDeductions: () => client.get('/masters/etp-charges/deductions/'),
    getRecoveries: () => client.get('/masters/etp-charges/recoveries/'),
    getETPCharge: (id) => client.get(`/masters/etp-charges/${id}/`),
    createETPCharge: (data) => client.post('/masters/etp-charges/', data),
    updateETPCharge: (id, data) => client.patch(`/masters/etp-charges/${id}/`, data),
    deleteETPCharge: (id) => client.delete(`/masters/etp-charges/${id}/`),
};

export default mastersService;



================================================
FILE: frontend/src/api/services/procurementService.js
================================================
import client from '../client';

const procurementService = {
    // ========== Tenders ==========
    getTenders: async (params = {}) => {
        const response = await client.get('/procurement/tenders/', { params });
        return response.data;
    },

    getTender: async (id) => {
        const response = await client.get(`/procurement/tenders/${id}/`);
        return response.data;
    },

    createTender: async (data) => {
        const response = await client.post('/procurement/tenders/', data);
        return response.data;
    },

    updateTender: async (id, data) => {
        const response = await client.put(`/procurement/tenders/${id}/`, data);
        return response.data;
    },

    deleteTender: async (id) => {
        const response = await client.delete(`/procurement/tenders/${id}/`);
        return response.data;
    },

    // Tender Actions
    publishTender: async (id) => {
        const response = await client.post(`/procurement/tenders/${id}/publish/`);
        return response.data;
    },

    openBids: async (id) => {
        const response = await client.post(`/procurement/tenders/${id}/open_bids/`);
        return response.data;
    },

    startEvaluation: async (id) => {
        const response = await client.post(`/procurement/tenders/${id}/start_evaluation/`);
        return response.data;
    },

    awardTender: async (id, winningBidId) => {
        const response = await client.post(`/procurement/tenders/${id}/award/`, { winning_bid_id: winningBidId });
        return response.data;
    },

    getTenderBids: async (tenderId) => {
        const response = await client.get(`/procurement/tenders/${tenderId}/bids/`);
        return response.data;
    },

    // NICDC Portal Integration
    syncToNICDC: async (tenderId) => {
        const response = await client.post(`/procurement/tenders/${tenderId}/sync_to_nicdc/`);
        return response.data;
    },

    // ========== Bids ==========
    getBids: async (params = {}) => {
        const response = await client.get('/procurement/bids/', { params });
        return response.data;
    },

    createBid: async (data) => {
        const response = await client.post('/procurement/bids/', data);
        return response.data;
    },

    evaluateBid: async (id, scores) => {
        const response = await client.post(`/procurement/bids/${id}/evaluate/`, scores);
        return response.data;
    },

    qualifyBid: async (id) => {
        const response = await client.post(`/procurement/bids/${id}/qualify/`);
        return response.data;
    },

    disqualifyBid: async (id, reason) => {
        const response = await client.post(`/procurement/bids/${id}/disqualify/`, { reason });
        return response.data;
    },

    // ========== Contracts ==========
    getContracts: async (params = {}) => {
        const response = await client.get('/procurement/contracts/', { params });
        return response.data;
    },

    getContract: async (id) => {
        const response = await client.get(`/procurement/contracts/${id}/`);
        return response.data;
    },

    createContract: async (data) => {
        const response = await client.post('/procurement/contracts/', data);
        return response.data;
    },

    updateContract: async (id, data) => {
        const response = await client.put(`/procurement/contracts/${id}/`, data);
        return response.data;
    },

    // Contract Actions
    signContract: async (id, signingDate) => {
        const response = await client.post(`/procurement/contracts/${id}/sign/`, { signing_date: signingDate });
        return response.data;
    },

    activateContract: async (id) => {
        const response = await client.post(`/procurement/contracts/${id}/activate/`);
        return response.data;
    },

    completeContract: async (id) => {
        const response = await client.post(`/procurement/contracts/${id}/complete/`);
        return response.data;
    },

    getContractVariations: async (contractId) => {
        const response = await client.get(`/procurement/contracts/${contractId}/variations/`);
        return response.data;
    },

    getContractsSummary: async () => {
        const response = await client.get('/procurement/contracts/summary/');
        return response.data;
    },

    // ========== Variations ==========
    getVariations: async (params = {}) => {
        const response = await client.get('/procurement/variations/', { params });
        return response.data;
    },

    createVariation: async (data) => {
        const response = await client.post('/procurement/variations/', data);
        return response.data;
    },

    approveVariation: async (id) => {
        const response = await client.post(`/procurement/variations/${id}/approve/`);
        return response.data;
    },

    rejectVariation: async (id) => {
        const response = await client.post(`/procurement/variations/${id}/reject/`);
        return response.data;
    },
};

export default procurementService;



================================================
FILE: frontend/src/api/services/progressService.js
================================================
/**
 * Progress & BOQ Execution API Service
 * 
 * Provides API calls for:
 * - Project progress metrics
 * - BOQ execution CRUD operations
 * - Verification workflow
 * - Progress history/audit logs
 */
import client from '../client';

const progressService = {
    // ========== PROGRESS METRICS ==========

    /**
     * Get current progress metrics for a project
     * @param {string} projectId 
     */
    getProjectProgress: (projectId) => {
        return client.get(`/finance/progress/project/${projectId}/`);
    },

    /**
     * Manually trigger progress recalculation
     * @param {string} projectId 
     */
    recalculateProgress: (projectId) => {
        return client.post(`/finance/progress/recalculate/${projectId}/`);
    },

    /**
     * Get detailed BOQ progress breakdown
     * @param {string} projectId 
     */
    getBOQBreakdown: (projectId) => {
        return client.get(`/finance/progress/breakdown/${projectId}/`);
    },

    /**
     * Get schedule variance metrics
     * @param {string} projectId 
     */
    getScheduleVariance: (projectId) => {
        return client.get(`/finance/progress/schedule-variance/${projectId}/`);
    },

    /**
     * Get progress calculation history/audit log
     * @param {string} projectId 
     * @param {number} limit 
     */
    getProgressHistory: (projectId, limit = 20) => {
        return client.get(`/finance/progress/history/${projectId}/?limit=${limit}`);
    },

    // ========== BOQ EXECUTIONS ==========

    /**
     * Get all executions for a project
     * @param {Object} filters - { project, boq_item, status }
     */
    getExecutions: (filters = {}) => {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
            if (value) params.append(key, value);
        });
        return client.get(`/finance/executions/?${params.toString()}`);
    },

    /**
     * Get a single execution
     * @param {string} executionId 
     */
    getExecution: (executionId) => {
        return client.get(`/finance/executions/${executionId}/`);
    },

    /**
     * Create new BOQ execution entry
     * @param {Object} data - { boq_item, executed_quantity, execution_date, period_from, period_to, remarks }
     */
    createExecution: (data) => {
        return client.post('/finance/executions/', data);
    },

    /**
     * Update execution (only if DRAFT)
     * @param {string} executionId 
     * @param {Object} data 
     */
    updateExecution: (executionId, data) => {
        return client.put(`/finance/executions/${executionId}/`, data);
    },

    /**
     * Delete execution (only if DRAFT)
     * @param {string} executionId 
     */
    deleteExecution: (executionId) => {
        return client.delete(`/finance/executions/${executionId}/`);
    },

    /**
     * Submit execution for verification
     * @param {string} executionId 
     */
    submitExecution: (executionId) => {
        return client.post(`/finance/executions/${executionId}/submit/`);
    },

    /**
     * Verify execution (admin only)
     * @param {string} executionId 
     */
    verifyExecution: (executionId) => {
        return client.post(`/finance/executions/${executionId}/verify/`);
    },

    /**
     * Reject execution with reason (admin only)
     * @param {string} executionId 
     * @param {string} reason 
     */
    rejectExecution: (executionId, reason) => {
        return client.post(`/finance/executions/${executionId}/reject/`, { reason });
    },

    /**
     * Get pending executions for verification (admin only)
     */
    getPendingExecutions: () => {
        return client.get('/finance/executions/pending/');
    },

    // ========== HELPER METHODS ==========

    /**
     * Calculate progress percentage from BOQ data
     * @param {number} executed 
     * @param {number} sanctioned 
     */
    calculateProgress: (executed, sanctioned) => {
        if (!sanctioned || sanctioned === 0) return 0;
        const progress = (executed / sanctioned) * 100;
        return Math.min(progress, 100); // Cap at 100%
    },

    /**
     * Get progress status based on percentage
     * @param {number} progress 
     */
    getProgressStatus: (progress) => {
        if (progress >= 100) return { label: 'Complete', color: 'bg-green-500' };
        if (progress >= 75) return { label: 'On Track', color: 'bg-blue-500' };
        if (progress >= 50) return { label: 'In Progress', color: 'bg-yellow-500' };
        if (progress > 0) return { label: 'Started', color: 'bg-orange-500' };
        return { label: 'Not Started', color: 'bg-gray-400' };
    },

    /**
     * Get execution status info
     * @param {string} status 
     */
    getExecutionStatusInfo: (status) => {
        const statusMap = {
            DRAFT: { label: 'Draft', bg: 'bg-gray-100', text: 'text-gray-700' },
            SUBMITTED: { label: 'Pending Verification', bg: 'bg-blue-100', text: 'text-blue-700' },
            VERIFIED: { label: 'Verified', bg: 'bg-green-100', text: 'text-green-700' },
            REJECTED: { label: 'Rejected', bg: 'bg-red-100', text: 'text-red-700' },
            REVISED: { label: 'Revision Required', bg: 'bg-yellow-100', text: 'text-yellow-700' }
        };
        return statusMap[status] || { label: status, bg: 'bg-gray-100', text: 'text-gray-700' };
    }
};

export default progressService;



================================================
FILE: frontend/src/api/services/projectService.js
================================================
import client from '../client';

// Transform frontend project data to backend format
const transformProjectData = (data) => {
    // Map camelCase frontend fields to snake_case backend fields
    const fieldMappings = {
        startDate: 'start_date',
        endDate: 'end_date',
        managerId: 'manager',
        subDivision: 'sub_division',
        schemeType: 'scheme_type',
        workType: 'work_type',
        projectCategory: 'project_category',
        adminApprovalNo: 'admin_approval_reference_no',
        adminApprovalDate: 'admin_approval_date',
    };

    // Fields to exclude (frontend-only fields)
    const excludeFields = ['displayName', 'zoneName', 'circleName', 'divisionName',
        'subDivisionName', 'districtName', 'townName', 'schemeTypeName',
        'schemeName', 'workTypeName', 'projectCategoryName', 'location',
        'stakeholders', 'category', 'fundingPattern', 'manager', 'progress', 'spent'];

    const transformed = {};

    for (const [key, value] of Object.entries(data)) {
        // Skip excluded fields
        if (excludeFields.includes(key)) continue;

        // Apply field name mapping
        const newKey = fieldMappings[key] || key;

        // Skip empty values for optional fields
        if (value === '' || value === null || value === undefined) continue;

        transformed[newKey] = value;
    }

    // Handle fundings separately (transform from fundingPattern)
    if (data.fundingPattern && Array.isArray(data.fundingPattern)) {
        transformed.fundings = data.fundingPattern
            .filter(f => f.amount && parseFloat(f.amount) > 0)
            .map(f => ({
                source: f.source,
                amount: parseFloat(f.amount) || 0,
            }));
    }

    console.log('Transformed project data:', transformed);
    return transformed;
};

const projectService = {
    getAllProjects: async () => {
        const response = await client.get('/projects/');
        // Handle paginated response (new format with results wrapper)
        const data = response.data;
        return data.results || data; // Extract results if paginated
    },

    // Alias for getAllProjects (used by RiskManagement)
    getProjects: async () => {
        const response = await client.get('/projects/');
        return response;
    },

    getProjectById: async (id) => {
        const response = await client.get(`/projects/${id}/`);
        return response.data;
    },

    createProject: async (projectData) => {
        console.log('Original project data:', projectData);
        const transformedData = transformProjectData(projectData);
        const response = await client.post('/projects/', transformedData);
        return response.data;
    },

    updateProject: async (id, projectData) => {
        const response = await client.put(`/projects/${id}/`, projectData);
        return response.data;
    },

    deleteProject: async (id) => {
        const response = await client.delete(`/projects/${id}/`);
        return response.data;
    },

    // Work Packages
    getPackages: async (projectId) => {
        const response = await client.get(`/projects/packages/?project=${projectId}`);
        return response.data;
    },

    getWorkPackages: async () => {
        const response = await client.get('/projects/packages/');
        return response;
    },

    createPackage: async (packageData) => {
        const response = await client.post('/projects/packages/', packageData);
        return response.data;
    },

    createWorkPackage: async (packageData) => {
        const response = await client.post('/projects/packages/', packageData);
        return response.data;
    },

    updatePackage: async (id, packageData) => {
        const response = await client.put(`/projects/packages/${id}/`, packageData);
        return response.data;
    },

    deletePackage: async (id) => {
        const response = await client.delete(`/projects/packages/${id}/`);
        return response.data;
    }
};

export default projectService;




================================================
FILE: frontend/src/api/services/riskService.js
================================================
/**
 * Risk Management API Service
 * 
 * Provides API calls for:
 * - Risk CRUD operations
 * - Risk document management
 * - Mitigation action workflow
 * - Risk statistics
 */
import client from '../client';

const riskService = {
    // ========== RISK CRUD ==========

    /**
     * Get all risks with optional filters
     * @param {Object} filters - { project, status, severity, category, owner, overdue }
     */
    getRisks: (filters = {}) => {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
            if (value) params.append(key, value);
        });
        return client.get(`/projects/risks/?${params.toString()}`);
    },

    /**
     * Get risks for a specific project
     * @param {string} projectId 
     */
    getProjectRisks: (projectId) => {
        return client.get(`/projects/${projectId}/risks/`);
    },

    /**
     * Get single risk details
     * @param {string} riskId 
     */
    getRisk: (riskId) => {
        return client.get(`/projects/risks/${riskId}/`);
    },

    /**
     * Create new risk
     * @param {Object} data 
     */
    createRisk: (data) => {
        return client.post('/projects/risks/', data);
    },

    /**
     * Update risk
     * @param {string} riskId 
     * @param {Object} data 
     */
    updateRisk: (riskId, data) => {
        return client.put(`/projects/risks/${riskId}/`, data);
    },

    /**
     * Partial update risk
     * @param {string} riskId 
     * @param {Object} data 
     */
    patchRisk: (riskId, data) => {
        return client.patch(`/projects/risks/${riskId}/`, data);
    },

    /**
     * Delete risk (soft delete)
     * @param {string} riskId 
     */
    deleteRisk: (riskId) => {
        return client.delete(`/projects/risks/${riskId}/`);
    },

    // ========== RISK STATISTICS ==========

    /**
     * Get aggregated risk statistics for dashboard
     */
    getRiskStats: () => {
        return client.get('/projects/risks/stats/');
    },

    /**
     * Get audit log for a risk
     * @param {string} riskId 
     */
    getRiskAuditLog: (riskId) => {
        return client.get(`/projects/risks/${riskId}/audit_log/`);
    },

    // ========== RISK DOCUMENTS ==========

    /**
     * Get documents attached to a risk
     * @param {string} riskId 
     */
    getRiskDocuments: (riskId) => {
        return client.get(`/projects/risks/${riskId}/documents/`);
    },

    /**
     * Attach document to risk
     * @param {string} riskId 
     * @param {Object} data - { document, document_type, notes }
     */
    addRiskDocument: (riskId, data) => {
        return client.post(`/projects/risks/${riskId}/documents/`, data);
    },

    /**
     * Remove document from risk
     * @param {string} riskId 
     * @param {string} documentId 
     */
    removeRiskDocument: (riskId, documentId) => {
        return client.delete(`/projects/risks/${riskId}/documents/${documentId}/`);
    },

    // ========== MITIGATION ACTIONS ==========

    /**
     * Get mitigation actions for a risk
     * @param {string} riskId 
     */
    getMitigationActions: (riskId) => {
        return client.get(`/projects/risks/${riskId}/mitigations/`);
    },

    /**
     * Get single mitigation action details
     * @param {string} riskId 
     * @param {string} actionId 
     */
    getMitigationAction: (riskId, actionId) => {
        return client.get(`/projects/risks/${riskId}/mitigations/${actionId}/`);
    },

    /**
     * Create mitigation action
     * @param {string} riskId 
     * @param {Object} data 
     */
    createMitigationAction: (riskId, data) => {
        return client.post(`/projects/risks/${riskId}/mitigations/`, data);
    },

    /**
     * Update mitigation action
     * @param {string} riskId 
     * @param {string} actionId 
     * @param {Object} data 
     */
    updateMitigationAction: (riskId, actionId, data) => {
        return client.put(`/projects/risks/${riskId}/mitigations/${actionId}/`, data);
    },

    /**
     * Submit mitigation action for review
     * @param {string} riskId 
     * @param {string} actionId 
     */
    submitMitigationAction: (riskId, actionId) => {
        return client.post(`/projects/risks/${riskId}/mitigations/${actionId}/submit/`);
    },

    /**
     * Approve or reject mitigation action
     * @param {string} riskId 
     * @param {string} actionId 
     * @param {Object} data - { action: 'approve'|'reject', comments: string }
     */
    reviewMitigationAction: (riskId, actionId, data) => {
        return client.post(`/projects/risks/${riskId}/mitigations/${actionId}/review/`, data);
    },

    // ========== MITIGATION PROOF DOCUMENTS ==========

    /**
     * Get proof documents for a mitigation action
     * @param {string} riskId 
     * @param {string} actionId 
     */
    getMitigationProofs: (riskId, actionId) => {
        return client.get(`/projects/risks/${riskId}/mitigations/${actionId}/proofs/`);
    },

    /**
     * Upload proof document for mitigation action
     * @param {string} riskId 
     * @param {string} actionId 
     * @param {FormData} formData 
     */
    uploadMitigationProof: (riskId, actionId, formData) => {
        return client.post(
            `/projects/risks/${riskId}/mitigations/${actionId}/proofs/`,
            formData,
            { headers: { 'Content-Type': 'multipart/form-data' } }
        );
    },

    // ========== HELPER CONSTANTS ==========

    CATEGORIES: [
        { value: 'TECHNICAL', label: 'Technical' },
        { value: 'FINANCIAL', label: 'Financial' },
        { value: 'CONTRACTUAL', label: 'Contractual' },
        { value: 'ENVIRONMENTAL', label: 'Environmental' },
        { value: 'SAFETY', label: 'Safety' },
        { value: 'POLITICAL', label: 'Political' },
        { value: 'LEGAL', label: 'Legal' },
        { value: 'OPERATIONAL', label: 'Operational' },
        { value: 'SCHEDULE', label: 'Schedule/Timeline' },
        { value: 'RESOURCE', label: 'Resource/Manpower' },
        { value: 'OTHER', label: 'Other' }
    ],

    PROBABILITIES: [
        { value: 1, label: 'Very Low (Rare)' },
        { value: 2, label: 'Low (Unlikely)' },
        { value: 3, label: 'Medium (Possible)' },
        { value: 4, label: 'High (Likely)' },
        { value: 5, label: 'Very High (Almost Certain)' }
    ],

    IMPACTS: [
        { value: 1, label: 'Negligible' },
        { value: 2, label: 'Minor' },
        { value: 3, label: 'Moderate' },
        { value: 4, label: 'Major' },
        { value: 5, label: 'Critical' }
    ],

    STATUSES: [
        { value: 'IDENTIFIED', label: 'Identified' },
        { value: 'ASSESSED', label: 'Assessed' },
        { value: 'MITIGATING', label: 'Mitigating' },
        { value: 'MITIGATED', label: 'Mitigated' },
        { value: 'CLOSED', label: 'Closed' },
        { value: 'OCCURRED', label: 'Occurred' },
        { value: 'ACCEPTED', label: 'Accepted' }
    ],

    RESPONSE_STRATEGIES: [
        { value: 'AVOID', label: 'Avoid' },
        { value: 'MITIGATE', label: 'Mitigate' },
        { value: 'TRANSFER', label: 'Transfer' },
        { value: 'ACCEPT', label: 'Accept' },
        { value: 'ESCALATE', label: 'Escalate' }
    ],

    ACTION_TYPES: [
        { value: 'PREVENTIVE', label: 'Preventive Action' },
        { value: 'CORRECTIVE', label: 'Corrective Action' },
        { value: 'DETECTIVE', label: 'Detective Control' },
        { value: 'CONTINGENCY', label: 'Contingency Measure' },
        { value: 'TRANSFER', label: 'Risk Transfer (Insurance/Contract)' },
        { value: 'ACCEPTANCE', label: 'Risk Acceptance with Justification' }
    ],

    DOCUMENT_TYPES: [
        { value: 'EVIDENCE', label: 'Evidence/Proof' },
        { value: 'ASSESSMENT', label: 'Risk Assessment Report' },
        { value: 'MITIGATION_PLAN', label: 'Mitigation Plan' },
        { value: 'MITIGATION_PROOF', label: 'Mitigation Action Proof' },
        { value: 'CLOSURE_REPORT', label: 'Closure Report' },
        { value: 'INSURANCE', label: 'Insurance Claim' },
        { value: 'MEETING_NOTES', label: 'Meeting Notes' },
        { value: 'CORRESPONDENCE', label: 'Correspondence' },
        { value: 'INCIDENT_REPORT', label: 'Incident Report' },
        { value: 'OTHER', label: 'Other' }
    ],

    /**
     * Get severity color classes
     * @param {string} severity 
     */
    getSeverityColor: (severity) => {
        switch (severity) {
            case 'CRITICAL':
                return { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' };
            case 'HIGH':
                return { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-300' };
            case 'MEDIUM':
                return { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-300' };
            case 'LOW':
                return { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' };
            default:
                return { bg: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-300' };
        }
    },

    /**
     * Get status color classes
     * @param {string} status 
     */
    getStatusColor: (status) => {
        switch (status) {
            case 'IDENTIFIED':
                return { bg: 'bg-blue-100', text: 'text-blue-800' };
            case 'ASSESSED':
                return { bg: 'bg-purple-100', text: 'text-purple-800' };
            case 'MITIGATING':
                return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
            case 'MITIGATED':
                return { bg: 'bg-green-100', text: 'text-green-800' };
            case 'CLOSED':
                return { bg: 'bg-gray-100', text: 'text-gray-600' };
            case 'OCCURRED':
                return { bg: 'bg-red-100', text: 'text-red-800' };
            case 'ACCEPTED':
                return { bg: 'bg-teal-100', text: 'text-teal-800' };
            default:
                return { bg: 'bg-gray-100', text: 'text-gray-800' };
        }
    },

    /**
     * Calculate risk score from probability and impact
     * @param {number} probability 
     * @param {number} impact 
     */
    calculateRiskScore: (probability, impact) => {
        return probability * impact;
    },

    /**
     * Get severity from risk score
     * @param {number} score 
     */
    getSeverityFromScore: (score) => {
        if (score >= 16) return 'CRITICAL';
        if (score >= 10) return 'HIGH';
        if (score >= 5) return 'MEDIUM';
        return 'LOW';
    }
};

export default riskService;



================================================
FILE: frontend/src/api/services/settingsService.js
================================================
import client from '../client';

// Settings are stored in localStorage for now
// In future, this can be connected to a backend API
const SETTINGS_KEY = 'pmis_user_settings';

const settingsService = {
    // Get all settings
    getSettings: () => {
        try {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                return JSON.parse(stored);
            }
        } catch (e) {
            console.error('Error loading settings:', e);
        }
        return null;
    },

    // Save all settings
    saveSettings: (settings) => {
        try {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            return true;
        } catch (e) {
            console.error('Error saving settings:', e);
            return false;
        }
    },

    // Update a single setting
    updateSetting: (key, value) => {
        const current = settingsService.getSettings() || {};
        current[key] = value;
        return settingsService.saveSettings(current);
    },

    // Get default settings
    getDefaultSettings: () => ({
        // Notification Settings
        emailNotifications: true,
        smsNotifications: false,
        inAppNotifications: true,
        approvalAlerts: true,
        deadlineReminders: true,
        paymentNotifications: true,

        // System Settings
        darkMode: false,
        compactView: false,
        showAnimations: true,
        autoLogout: true,
        autoLogoutTime: 30,

        // Security Settings
        twoFactorAuth: false,
        sessionLogging: true,

        // Integration Settings
        nicdcSync: false,
        gisEnabled: false,
        financeMisSync: false,
    }),

    // Get audit logs
    getAuditLogs: (params = {}) => client.get('/audit/logs/', { params }),

    // Get workflow configurations
    getWorkflows: () => client.get('/workflow/configs/').catch(() => ({ data: [] })),

    // Update workflow config
    updateWorkflow: (id, data) => client.patch(`/workflow/configs/${id}/`, data),
};

export default settingsService;



================================================
FILE: frontend/src/api/services/userService.js
================================================
import client from '../client';

const userService = {
    // Get all users
    getUsers: (params = {}) => client.get('/users/', { params }),

    // Get single user
    getUser: (id) => client.get(`/users/${id}/`),

    // Get current user profile
    getProfile: () => client.get('/users/profile/'),

    // Update user profile
    updateProfile: (data) => client.patch('/users/profile/', data),

    // Update user (admin)
    updateUser: (id, data) => client.patch(`/users/${id}/`, data),

    // Toggle user status
    toggleUserStatus: (id) => client.post(`/users/${id}/toggle-status/`),

    // Invite user
    inviteUser: (data) => client.post('/users/invite/', data),

    // Get pending users
    getPendingUsers: () => client.get('/users/pending/'),

    // Approve user
    approveUser: (id, data = {}) => client.post(`/users/${id}/approve/`, data),

    // Reject user
    rejectUser: (id, data = {}) => client.post(`/users/${id}/reject/`, data),

    // Get user by role
    getUsersByRole: (role) => client.get('/users/', { params: { role } }),

    // Get users eligible to be project managers (RBAC-based)
    getEligibleManagers: () => client.get('/users/eligible-managers/'),

    // Get roles summary (count users per role)
    getRolesSummary: async () => {
        const response = await client.get('/users/');
        const users = response.data.results || response.data || [];

        const roleCounts = {};
        users.forEach(user => {
            const role = user.role || 'Unknown';
            roleCounts[role] = (roleCounts[role] || 0) + 1;
        });

        return {
            data: Object.entries(roleCounts).map(([role, count]) => ({
                id: role.toLowerCase().replace(/\s+/g, '_'),
                name: role,
                count
            }))
        };
    }
};

export default userService;



================================================
FILE: frontend/src/api/services/workflowService.js
================================================
/**
 * Workflow Engine API Service
 * 
 * Provides frontend API methods for interacting with the 
 * Dynamic Workflow Engine backend.
 */
import client from '../client';

const BASE_URL = '/workflow';

export const workflowService = {
    // ============================================
    // WORKFLOW TEMPLATES
    // ============================================

    /**
     * Get all workflow templates
     */
    getTemplates: async (filters = {}) => {
        const params = new URLSearchParams();
        if (filters.module) params.append('module', filters.module);
        if (filters.is_active !== undefined) params.append('is_active', filters.is_active);
        const response = await client.get(`${BASE_URL}/templates/?${params.toString()}`);
        return response.data;
    },

    /**
     * Get template details with steps
     */
    getTemplate: async (templateId) => {
        const response = await client.get(`${BASE_URL}/templates/${templateId}/`);
        return response.data;
    },

    /**
     * Create a new workflow template
     */
    createTemplate: async (data) => {
        const response = await client.post(`${BASE_URL}/templates/`, data);
        return response.data;
    },

    /**
     * Update a workflow template
     */
    updateTemplate: async (templateId, data) => {
        const response = await client.patch(`${BASE_URL}/templates/${templateId}/`, data);
        return response.data;
    },

    /**
     * Delete a workflow template
     */
    deleteTemplate: async (templateId) => {
        await client.delete(`${BASE_URL}/templates/${templateId}/`);
    },

    /**
     * Add a step to a template
     */
    addStep: async (templateId, stepData) => {
        const response = await client.post(`${BASE_URL}/templates/${templateId}/add_step/`, stepData);
        return response.data;
    },

    /**
     * Reorder steps in a template
     */
    reorderSteps: async (templateId, stepOrder) => {
        const response = await client.post(`${BASE_URL}/templates/${templateId}/reorder_steps/`, {
            step_order: stepOrder
        });
        return response.data;
    },

    // ============================================
    // WORKFLOW STEPS
    // ============================================

    /**
     * Get all steps (optionally filtered by template)
     */
    getSteps: async (templateId = null) => {
        const url = templateId
            ? `${BASE_URL}/steps/?template=${templateId}`
            : `${BASE_URL}/steps/`;
        const response = await client.get(url);
        return response.data;
    },

    /**
     * Update a step
     */
    updateStep: async (stepId, data) => {
        const response = await client.patch(`${BASE_URL}/steps/${stepId}/`, data);
        return response.data;
    },

    /**
     * Delete a step
     */
    deleteStep: async (stepId) => {
        await client.delete(`${BASE_URL}/steps/${stepId}/`);
    },

    // ============================================
    // TRIGGER RULES
    // ============================================

    /**
     * Get all trigger rules
     */
    getRules: async (module = null) => {
        const url = module
            ? `${BASE_URL}/rules/?module=${module}`
            : `${BASE_URL}/rules/`;
        const response = await client.get(url);
        return response.data;
    },

    /**
     * Create a trigger rule
     */
    createRule: async (data) => {
        const response = await client.post(`${BASE_URL}/rules/`, data);
        return response.data;
    },

    /**
     * Update a trigger rule
     */
    updateRule: async (ruleId, data) => {
        const response = await client.patch(`${BASE_URL}/rules/${ruleId}/`, data);
        return response.data;
    },

    /**
     * Delete a trigger rule
     */
    deleteRule: async (ruleId) => {
        await client.delete(`${BASE_URL}/rules/${ruleId}/`);
    },

    // ============================================
    // WORKFLOW INSTANCES (Active Workflows)
    // ============================================

    /**
     * Get all workflow instances
     */
    getInstances: async (filters = {}) => {
        const params = new URLSearchParams();
        if (filters.status) params.append('status', filters.status);
        if (filters.entity_type) params.append('entity_type', filters.entity_type);
        if (filters.entity_id) params.append('entity_id', filters.entity_id);
        const response = await client.get(`${BASE_URL}/instances/?${params.toString()}`);
        return response.data;
    },

    /**
     * Get instance details
     */
    getInstance: async (instanceId) => {
        const response = await client.get(`${BASE_URL}/instances/${instanceId}/`);
        return response.data;
    },

    /**
     * Get pending approvals for current user
     */
    getPendingForUser: async () => {
        const response = await client.get(`${BASE_URL}/instances/pending/`);
        return response.data;
    },

    /**
     * Start a new workflow for an entity
     */
    startWorkflow: async (entityType, entityId, module = null) => {
        const data = {
            entity_type: entityType,
            entity_id: entityId
        };
        if (module) data.module = module;
        const response = await client.post(`${BASE_URL}/instances/start/`, data);
        return response.data;
    },

    /**
     * Forward workflow to next step
     */
    forward: async (instanceId, remarks = '') => {
        const response = await client.post(`${BASE_URL}/instances/${instanceId}/forward/`, {
            remarks
        });
        return response.data;
    },

    /**
     * Revert workflow to a previous step
     */
    revert: async (instanceId, toStep, remarks = '') => {
        const response = await client.post(`${BASE_URL}/instances/${instanceId}/revert/`, {
            to_step: toStep,
            remarks
        });
        return response.data;
    },

    /**
     * Reject workflow
     */
    reject: async (instanceId, remarks = '') => {
        const response = await client.post(`${BASE_URL}/instances/${instanceId}/reject/`, {
            remarks
        });
        return response.data;
    },

    /**
     * Get workflow history/audit trail
     */
    getHistory: async (instanceId) => {
        const response = await client.get(`${BASE_URL}/instances/${instanceId}/history/`);
        return response.data;
    },

    /**
     * Get TAT (turnaround time) statistics
     */
    getTAT: async (instanceId) => {
        const response = await client.get(`${BASE_URL}/instances/${instanceId}/tat/`);
        return response.data;
    },

    // ============================================
    // DELEGATIONS
    // ============================================

    /**
     * Get delegations given by current user
     */
    getMyDelegations: async () => {
        const response = await client.get(`${BASE_URL}/delegations/my_delegations/`);
        return response.data;
    },

    /**
     * Get delegations received by current user
     */
    getDelegatedToMe: async () => {
        const response = await client.get(`${BASE_URL}/delegations/delegated_to_me/`);
        return response.data;
    },

    /**
     * Create a new delegation
     */
    createDelegation: async (data) => {
        const response = await client.post(`${BASE_URL}/delegations/`, data);
        return response.data;
    },

    /**
     * Update a delegation
     */
    updateDelegation: async (delegationId, data) => {
        const response = await client.patch(`${BASE_URL}/delegations/${delegationId}/`, data);
        return response.data;
    },

    /**
     * Revoke/delete a delegation
     */
    deleteDelegation: async (delegationId) => {
        await client.delete(`${BASE_URL}/delegations/${delegationId}/`);
    },

    // ============================================
    // ENTITY-BASED WORKFLOW ACTIONS (Universal API)
    // ============================================

    /**
     * Get available workflow actions for an entity
     * 
     * @param {string} entityType - Model name (e.g., 'RABill', 'Tender')
     * @param {string} entityId - Document primary key
     * @returns {Object} Permission flags and current step info
     */
    getActionsForEntity: async (entityType, entityId) => {
        try {
            const response = await client.get(`${BASE_URL}/actions/actions/`, {
                params: { entity_type: entityType, entity_id: entityId }
            });
            return response.data;
        } catch (error) {
            console.error('Failed to get workflow actions:', error);
            // Return safe defaults on error
            return {
                has_workflow: false,
                can_approve: false,
                can_revert: false,
                can_reject: false,
                current_step_label: null,
                required_role: null,
                workflow_status: null,
                workflow_id: null,
                remarks_required: false
            };
        }
    },

    /**
     * Perform a workflow action on an entity
     * 
     * @param {string} entityType - Model name
     * @param {string} entityId - Document primary key  
     * @param {string} action - 'FORWARD', 'REVERT', or 'REJECT'
     * @param {string} remarks - Optional remarks/comments
     * @param {number} toStep - Target step (required for REVERT)
     * @returns {Object} Action result with success flag and message
     */
    performEntityAction: async (entityType, entityId, action, remarks = '', toStep = null) => {
        const data = {
            entity_type: entityType,
            entity_id: entityId,
            action: action,
            remarks: remarks
        };
        if (toStep !== null) {
            data.to_step = toStep;
        }
        const response = await client.post(`${BASE_URL}/actions/perform-action/`, data);
        return response.data;
    },

    /**
     * Get workflow history for an entity
     * 
     * @param {string} entityType - Model name
     * @param {string} entityId - Document primary key
     * @returns {Object} Workflow history with timeline entries
     */
    getEntityHistory: async (entityType, entityId) => {
        try {
            const response = await client.get(`${BASE_URL}/actions/entity-history/`, {
                params: { entity_type: entityType, entity_id: entityId }
            });
            return response.data;
        } catch (error) {
            console.error('Failed to get workflow history:', error);
            return { has_history: false, workflows: [] };
        }
    }
};

// ============================================
// HELPER UTILITIES
// ============================================

/**
 * Workflow module options for dropdowns
 */
export const WORKFLOW_MODULES = [
    { value: 'RA_BILL', label: 'RA Bill' },
    { value: 'TENDER', label: 'Tender' },
    { value: 'DESIGN', label: 'Design Document' },
    { value: 'VARIATION', label: 'Variation Order' },
    { value: 'CONTRACT', label: 'Contract' },
    { value: 'BOQ', label: 'BOQ Item' },
    { value: 'RISK', label: 'Risk' }
];

/**
 * Action type options for workflow steps
 */
export const ACTION_TYPES = [
    { value: 'VERIFY', label: 'Verify & Check' },
    { value: 'RECOMMEND', label: 'Recommend' },
    { value: 'APPROVE', label: 'Approve' },
    { value: 'SANCTION', label: 'Sanction' },
    { value: 'REVIEW', label: 'Review' }
];

/**
 * Role options for workflow steps
 */
export const WORKFLOW_ROLES = [
    { value: 'SPV_Official', label: 'SPV Official' },
    { value: 'PMNC_Team', label: 'PMNC Team' },
    { value: 'EPC_Contractor', label: 'EPC Contractor' },
    { value: 'Consultant_Design', label: 'Design Consultant' },
    { value: 'Govt_Department', label: 'Government Department' },
    { value: 'NICDC_HQ', label: 'NICDC HQ' },
    { value: 'AE', label: 'Assistant Engineer' },
    { value: 'EE', label: 'Executive Engineer' },
    { value: 'SE', label: 'Superintending Engineer' },
    { value: 'CE', label: 'Chief Engineer' },
    { value: 'HOD', label: 'Head of Department' },
    { value: 'DGM', label: 'Deputy General Manager' },
    { value: 'GM', label: 'General Manager' },
    { value: 'MD', label: 'Managing Director' }
];

/**
 * Workflow status colors
 */
export const getStatusColor = (status) => {
    const colors = {
        'PENDING': { bg: 'bg-slate-100', text: 'text-slate-700', dark: 'dark:bg-slate-800 dark:text-slate-300' },
        'IN_PROGRESS': { bg: 'bg-blue-100', text: 'text-blue-700', dark: 'dark:bg-blue-900/30 dark:text-blue-300' },
        'COMPLETED': { bg: 'bg-green-100', text: 'text-green-700', dark: 'dark:bg-green-900/30 dark:text-green-300' },
        'REJECTED': { bg: 'bg-red-100', text: 'text-red-700', dark: 'dark:bg-red-900/30 dark:text-red-300' },
        'REVERTED': { bg: 'bg-amber-100', text: 'text-amber-700', dark: 'dark:bg-amber-900/30 dark:text-amber-300' },
        'CANCELLED': { bg: 'bg-slate-200', text: 'text-slate-600', dark: 'dark:bg-slate-700 dark:text-slate-400' }
    };
    return colors[status] || colors['PENDING'];
};

/**
 * Format workflow progress as percentage
 */
export const formatProgress = (currentStep, totalSteps) => {
    if (!totalSteps || totalSteps === 0) return 0;
    return Math.round((currentStep / totalSteps) * 100);
};

/**
 * Check if workflow is overdue based on SLA deadline
 */
export const isOverdue = (slaDeadline) => {
    if (!slaDeadline) return false;
    return new Date(slaDeadline) < new Date();
};

export default workflowService;



================================================
FILE: frontend/src/components/auth/OtpLogin.jsx
================================================
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { User, Lock, ArrowRight, Loader2, Shield, Building2, Eye, EyeOff } from 'lucide-react';
import { useNavigate, Link } from 'react-router-dom';
import { useAuth } from '@/contexts/AuthContext';

const OtpLogin = () => {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [showPassword, setShowPassword] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [focusedField, setFocusedField] = useState(null);
    const [buttonHovered, setButtonHovered] = useState(false);
    const { login, isAuthenticated } = useAuth();
    const navigate = useNavigate();

    useEffect(() => {
        if (isAuthenticated) {
            navigate('/dashboard');
        }
    }, [isAuthenticated, navigate]);

    const handleLogin = (e) => {
        console.log('========== LOGIN HANDLER CALLED ==========');
        e.preventDefault();
        e.stopPropagation();

        if (isLoading) {
            console.log('Already loading, aborting');
            return false;
        }

        console.log('Setting loading to true, username:', username);
        setIsLoading(true);

        login(username, password)
            .then(result => {
                console.log('========== LOGIN RESULT ==========', result);

                if (!result.success) {
                    console.error('LOGIN FAILED:', result.error);
                    // AuthContext already shows the toast, no need to duplicate
                    setIsLoading(false);
                } else {
                    console.log('LOGIN SUCCESS - Navigating to dashboard');
                    navigate('/dashboard');
                }
            })
            .catch(err => {
                console.error('========== LOGIN ERROR (CATCH) ==========', err);
                // This shouldn't happen as AuthContext handles all errors
                setIsLoading(false);
            });

        console.log('Returning false to prevent default');
        return false;
    };


    return (
        <div className="min-h-screen bg-app-secondary">
            <div className="min-h-screen flex">
                {/* Left Panel - Branding */}
                <div className="hidden lg:flex lg:w-1/2 relative overflow-hidden">

                    {/* Content */}
                    <div className="relative z-10 flex flex-col justify-center px-12 xl:px-20">
                        <motion.div
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ duration: 0.8 }}
                        >
                            {/* Logo */}
                            <div className="flex items-center gap-4 mb-12">
                                <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center shadow-lg shadow-primary-500/30">
                                    <Building2 className="w-8 h-8 text-white" />
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-app-heading">PMIS</h2>
                                    <p className="text-primary-600 dark:text-primary-300 text-sm">Zaheerabad Industrial Area</p>
                                </div>
                            </div>

                            {/* Main Title */}
                            <h1 className="text-4xl xl:text-5xl font-bold text-app-heading mb-6 leading-tight">
                                <span className="block">
                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-primary-400 dark:to-blue-400">P</span>
                                    <span className="text-app-heading">rogramme</span>
                                </span>
                                <span className="block">
                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-primary-400 dark:to-blue-400">M</span>
                                    <span className="text-app-heading">anagement</span>
                                </span>
                                <span className="block">
                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-primary-400 dark:to-blue-400">I</span>
                                    <span className="text-app-heading">nformation</span>
                                </span>
                                <span className="block">
                                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-primary-400 dark:to-blue-400">S</span>
                                    <span className="text-app-heading">ystem</span>
                                </span>
                            </h1>

                            <p className="text-app-muted text-lg mb-8 max-w-md pr-4">
                                Streamlining infrastructure development with integrated project tracking,
                                document management, and real-time collaboration.
                            </p>
                        </motion.div>
                    </div>
                </div>

                {/* Right Panel - Login Form */}
                <div className="w-full lg:w-1/2 flex items-center justify-center p-8">
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95 }}
                        animate={{ opacity: 1, scale: 1 }}
                        transition={{ duration: 0.5 }}
                        className="w-full max-w-md"
                    >
                        {/* Mobile Logo */}
                        <div className="lg:hidden text-center mb-8">
                            <div className="inline-flex items-center gap-3 mb-4">
                                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-primary-600 to-primary-800 flex items-center justify-center">
                                    <Building2 className="w-6 h-6 text-white" />
                                </div>
                                <div className="text-left">
                                    <h2 className="text-xl font-bold text-app-heading">PMIS</h2>
                                    <p className="text-app-muted text-xs">Zaheerabad Industrial Area</p>
                                </div>
                            </div>
                        </div>

                        {/* Form Card */}
                        <div
                            className="bg-app-card rounded-3xl p-8 md:p-10 border border-app-subtle"
                            style={{ boxShadow: '0 0 60px rgba(0, 0, 0, 0.1)' }}
                        >
                            <div className="text-center mb-8">
                                <h1 className="text-2xl font-bold text-app-heading mb-2">
                                    Welcome back
                                </h1>
                                <p className="text-app-muted">
                                    Sign in to access your dashboard
                                </p>
                            </div>

                            <form onSubmit={handleLogin} className="space-y-5" noValidate>
                                {/* Username Field */}
                                <div>
                                    <label className="block text-sm font-medium text-app-heading mb-2">
                                        Username
                                    </label>
                                    <div className="relative">
                                        <motion.div
                                            animate={{
                                                scale: focusedField === 'username' ? 1.02 : 1,
                                            }}
                                            className="relative"
                                        >
                                            <div className={`absolute left-4 top-1/2 -translate-y-1/2 transition-colors duration-200 ${focusedField === 'username' ? 'text-primary-600' : 'text-slate-400'
                                                }`}>
                                                <User size={18} />
                                            </div>
                                            <input
                                                type="text"
                                                required
                                                value={username}
                                                onChange={(e) => setUsername(e.target.value)}
                                                onFocus={() => setFocusedField('username')}
                                                onBlur={() => setFocusedField(null)}
                                                placeholder="Enter your username"
                                                className={`w-full pl-12 pr-4 py-3.5 rounded-xl border-2 transition-all duration-200 font-medium text-app-heading placeholder:text-app-muted bg-app-secondary focus:bg-app-card outline-none ${focusedField === 'username'
                                                    ? 'border-blue-500 ring-4 ring-blue-500/10'
                                                    : 'border-app hover:border-app-subtle'
                                                    }`}
                                            />
                                        </motion.div>
                                    </div>
                                </div>

                                {/* Password Field */}
                                <div>
                                    <label className="block text-sm font-medium text-app-heading mb-2">
                                        Password
                                    </label>
                                    <div className="relative">
                                        <motion.div
                                            animate={{
                                                scale: focusedField === 'password' ? 1.02 : 1,
                                            }}
                                            className="relative"
                                        >
                                            <div className={`absolute left-4 top-1/2 -translate-y-1/2 transition-colors duration-200 ${focusedField === 'password' ? 'text-primary-600' : 'text-slate-400'
                                                }`}>
                                                <Lock size={18} />
                                            </div>
                                            <input
                                                type={showPassword ? 'text' : 'password'}
                                                required
                                                value={password}
                                                onChange={(e) => setPassword(e.target.value)}
                                                onFocus={() => setFocusedField('password')}
                                                onBlur={() => setFocusedField(null)}
                                                placeholder="Enter your password"
                                                className={`w-full pl-12 pr-12 py-3.5 rounded-xl border-2 transition-all duration-200 font-medium text-app-heading placeholder:text-app-muted bg-app-secondary focus:bg-app-card outline-none ${focusedField === 'password'
                                                    ? 'border-blue-500 ring-4 ring-blue-500/10'
                                                    : 'border-app hover:border-app-subtle'
                                                    }`}
                                            />
                                            <button
                                                type="button"
                                                onClick={() => setShowPassword(!showPassword)}
                                                className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-neutral-500 hover:text-slate-600 dark:hover:text-neutral-300 transition-colors"
                                            >
                                                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                            </button>
                                        </motion.div>
                                    </div>
                                    {/* Forgot Password Link */}
                                    <div className="text-right mt-2">
                                        <Link
                                            to="/forgot-password"
                                            className="text-sm text-blue-600 dark:text-indigo-400 hover:text-blue-700 dark:hover:text-indigo-300 font-medium transition-colors"
                                        >
                                            Forgot password?
                                        </Link>
                                    </div>
                                </div>

                                {/* Submit Button */}
                                <motion.button
                                    type="submit"
                                    disabled={isLoading}
                                    onHoverStart={() => setButtonHovered(true)}
                                    onHoverEnd={() => setButtonHovered(false)}
                                    whileHover={{ scale: isLoading ? 1 : 1.01 }}
                                    whileTap={{ scale: isLoading ? 1 : 0.97 }}
                                    className={`relative w-full py-4 rounded-xl font-semibold text-white overflow-hidden transition-all duration-300 ${isLoading
                                        ? 'bg-slate-400 cursor-not-allowed'
                                        : 'shadow-lg shadow-primary-500/30 hover:shadow-xl hover:shadow-primary-500/40'
                                        }`}
                                >
                                    {/* Liquid background gradient */}
                                    {!isLoading && (
                                        <motion.div
                                            className="absolute inset-0 bg-gradient-to-r from-primary-600 via-primary-700 to-primary-600"
                                            initial={false}
                                            animate={{
                                                backgroundPosition: buttonHovered ? ['0% 50%', '100% 50%', '0% 50%'] : '0% 50%',
                                            }}
                                            transition={{
                                                duration: 1.5,
                                                repeat: buttonHovered ? Infinity : 0,
                                                ease: 'linear',
                                            }}
                                            style={{
                                                backgroundSize: '200% 100%',
                                            }}
                                        />
                                    )}

                                    {/* Shine effect */}
                                    {!isLoading && (
                                        <motion.div
                                            className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent"
                                            initial={{ x: '-100%' }}
                                            animate={{ x: buttonHovered ? '100%' : '-100%' }}
                                            transition={{ duration: 0.6, ease: 'easeInOut' }}
                                        />
                                    )}

                                    <span className="relative z-10 flex items-center justify-center gap-2">
                                        <AnimatePresence mode="wait">
                                            {isLoading ? (
                                                <motion.div
                                                    key="loading"
                                                    initial={{ opacity: 0 }}
                                                    animate={{ opacity: 1 }}
                                                    exit={{ opacity: 0 }}
                                                    className="flex items-center gap-2"
                                                >
                                                    <Loader2 className="w-5 h-5 animate-spin" />
                                                    <span>Signing in...</span>
                                                </motion.div>
                                            ) : (
                                                <motion.div
                                                    key="submit"
                                                    initial={{ opacity: 0 }}
                                                    animate={{ opacity: 1 }}
                                                    exit={{ opacity: 0 }}
                                                    className="flex items-center gap-2"
                                                >
                                                    <span>Sign In</span>
                                                    <ArrowRight className="w-5 h-5" />
                                                </motion.div>
                                            )}
                                        </AnimatePresence>
                                    </span>
                                </motion.button>

                                {/* Contractor Registration Link */}
                                <div className="mt-6 text-center">
                                    <p className="text-slate-500 text-sm">
                                        Contractor?{' '}
                                        <Link
                                            to="/register"
                                            className="text-primary-600 hover:text-primary-700 font-medium transition-colors"
                                        >
                                            Register here
                                        </Link>
                                    </p>
                                </div>
                            </form>
                        </div>
                    </motion.div>
                </div>
            </div>
        </div>
    );
};

export default OtpLogin;



================================================
FILE: frontend/src/components/billing/BillDetailModal.jsx
================================================
/**
 * Bill Detail Modal
 * 
 * Modal to view bill details and manage workflow approvals.
 * Integrates EntityWorkflowCard for workflow actions.
 */
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    X, FileText, Calendar, Building2, User, IndianRupee,
    Printer, Download, CheckCircle2, Clock, Hash
} from 'lucide-react';
import Button from '@/components/ui/Button';
import EntityWorkflowCard from '@/components/workflow/EntityWorkflowCard';

const InfoRow = ({ icon: Icon, label, value, highlight = false }) => (
    <div className="flex items-start gap-3 py-2">
        <div className="w-8 h-8 rounded-lg bg-primary-50 dark:bg-primary-900/20 flex items-center justify-center flex-shrink-0">
            <Icon size={16} className="text-primary-600 dark:text-primary-400" />
        </div>
        <div className="flex-1">
            <p className="text-xs text-app-muted">{label}</p>
            <p className={`text-sm font-medium ${highlight ? 'text-emerald-600 dark:text-emerald-400' : 'text-app-heading'}`}>
                {value || 'N/A'}
            </p>
        </div>
    </div>
);

const BillDetailModal = ({ isOpen, onClose, bill, onBillUpdate }) => {
    if (!isOpen || !bill) return null;

    const formatCurrency = (value) => {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            maximumFractionDigits: 0
        }).format(value || 0);
    };

    const getStatusColor = (status) => {
        const colors = {
            'DRAFT': 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300',
            'SUBMITTED': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
            'PENDING': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300',
            'IN_PROGRESS': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
            'APPROVED': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
            'REJECTED': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
            'PAID': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300',
        };
        return colors[status?.toUpperCase()] || colors['DRAFT'];
    };

    return createPortal(
        <AnimatePresence>
            {isOpen && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="fixed inset-0 z-[9999] flex items-center justify-center bg-app-overlay backdrop-blur-sm p-4 overflow-y-auto"
                    onClick={onClose}
                >
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95, y: 20 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.95, y: 20 }}
                        className="w-full max-w-3xl my-8 bg-app-card rounded-xl shadow-2xl overflow-hidden"
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Header */}
                        <div className="p-4 border-b border-app-subtle bg-gradient-to-r from-primary-600 to-primary-700">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center">
                                        <FileText className="text-white" size={20} />
                                    </div>
                                    <div>
                                        <h2 className="text-lg font-bold text-white">
                                            Bill #{bill.billNo}
                                        </h2>
                                        <p className="text-sm text-white/70">{bill.projectName}</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className={`px-3 py-1 text-xs font-semibold rounded-full ${getStatusColor(bill.status)}`}>
                                        {bill.status?.replace('_', ' ')}
                                    </span>
                                    <button
                                        onClick={onClose}
                                        className="p-2 hover:bg-white/10 rounded-lg transition-colors"
                                    >
                                        <X size={20} className="text-white" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-6 max-h-[calc(100vh-200px)] overflow-y-auto">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                {/* Left Column: Bill Details */}
                                <div className="space-y-4">
                                    <h3 className="text-sm font-semibold text-app-heading flex items-center gap-2 border-b border-app-subtle pb-2">
                                        <FileText size={16} className="text-primary-500" />
                                        Bill Information
                                    </h3>

                                    <div className="grid grid-cols-2 gap-x-4">
                                        <InfoRow icon={Hash} label="Bill Number" value={bill.billNo} />
                                        <InfoRow icon={Calendar} label="Submission Date" value={bill.submissionDate} />
                                        <InfoRow icon={Building2} label="Project" value={bill.projectName} />
                                        <InfoRow icon={User} label="Contractor" value={bill.contractorName} />
                                    </div>

                                    <h3 className="text-sm font-semibold text-app-heading flex items-center gap-2 border-b border-app-subtle pb-2 mt-6">
                                        <IndianRupee size={16} className="text-emerald-500" />
                                        Financial Summary
                                    </h3>

                                    <div className="bg-app-surface rounded-xl p-4 space-y-3">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-app-muted">Gross Amount</span>
                                            <span className="font-medium text-app-heading">{formatCurrency(bill.grossAmount)}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-app-muted">GST Amount</span>
                                            <span className="font-medium text-app-heading">{formatCurrency(bill.gstAmount)}</span>
                                        </div>
                                        <div className="flex justify-between items-center border-t border-app-subtle pt-2">
                                            <span className="text-sm text-app-muted">Total Amount</span>
                                            <span className="font-semibold text-app-heading">{formatCurrency(bill.totalAmount)}</span>
                                        </div>

                                        <div className="border-t border-dashed border-app-subtle pt-3 space-y-2">
                                            <div className="flex justify-between items-center text-xs">
                                                <span className="text-app-muted">TDS Deduction</span>
                                                <span className="text-red-600">- {formatCurrency(bill.tdsAmount)}</span>
                                            </div>
                                            <div className="flex justify-between items-center text-xs">
                                                <span className="text-app-muted">Labour Cess</span>
                                                <span className="text-red-600">- {formatCurrency(bill.labourCessAmount)}</span>
                                            </div>
                                            <div className="flex justify-between items-center text-xs">
                                                <span className="text-app-muted">Retention</span>
                                                <span className="text-red-600">- {formatCurrency(bill.retentionAmount)}</span>
                                            </div>
                                        </div>

                                        <div className="border-t border-app-subtle pt-3">
                                            <div className="flex justify-between items-center">
                                                <span className="text-base font-semibold text-app-heading">Net Payable</span>
                                                <span className="text-lg font-bold text-emerald-600 dark:text-emerald-400">
                                                    {formatCurrency(bill.netPayable)}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Right Column: Workflow Card */}
                                <div className="space-y-4">
                                    <h3 className="text-sm font-semibold text-app-heading flex items-center gap-2 border-b border-app-subtle pb-2">
                                        <CheckCircle2 size={16} className="text-blue-500" />
                                        Approval Workflow
                                    </h3>

                                    <EntityWorkflowCard
                                        entityType="RABill"
                                        entityId={bill.id}
                                        onActionComplete={onBillUpdate}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="p-4 border-t border-app-subtle bg-app-surface flex justify-end gap-3">
                            <Button variant="outline" onClick={onClose}>
                                Close
                            </Button>
                            <Button variant="outline" className="gap-2">
                                <Printer size={16} />
                                Print
                            </Button>
                        </div>
                    </motion.div>
                </motion.div>
            )}
        </AnimatePresence>,
        document.body
    );
};

export default BillDetailModal;



================================================
FILE: frontend/src/components/billing/GenerateBillModal.jsx
================================================
import { useState, useEffect, useRef, useCallback } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Save, Printer, RefreshCw, Calculator, FileText, IndianRupee, AlertCircle, Eye, CheckCircle, ArrowLeft, Loader2 } from 'lucide-react';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';
import { RABillTemplate } from './RABillTemplate';
import financeService from '@/api/services/financeService';

export const GenerateBillModal = ({
    isOpen,
    onClose,
    onSave,
    projects = [],
    contractors = []
}) => {
    // Modes: 'edit', 'success', 'preview'
    const [viewMode, setViewMode] = useState('edit');

    // Form State
    const [milestones, setMilestones] = useState([]);
    const [milestoneBudgets, setMilestoneBudgets] = useState({}); // {milestoneId: totalBudget}
    const [budgetWarning, setBudgetWarning] = useState(null);

    // Fetch milestones and their budget allocations when project changes
    const handleProjectChange = async (e) => {
        const pid = e.target.value;
        setFormData(prev => ({ ...prev, projectId: pid, milestoneId: '' }));
        setMilestones([]);
        setMilestoneBudgets({});
        setBudgetWarning(null);

        if (pid) {
            try {
                // Fetch milestones for the project
                const tasksData = await financeService.getScheduleTasks(pid);
                const milestonesOnly = tasksData.filter(t => t.is_milestone);

                // Fetch budget allocations
                const budgetsData = await financeService.getBudgets(pid);

                // Sum budget amounts per milestone
                const budgetMap = {};
                budgetsData.forEach(b => {
                    if (b.milestone) {
                        budgetMap[b.milestone] = (budgetMap[b.milestone] || 0) + parseFloat(b.amount || 0);
                    }
                });

                // Enhance milestones with budget info
                const enhancedMilestones = milestonesOnly.map(m => ({
                    ...m,
                    allocatedBudget: budgetMap[m.id] || 0,
                    hasBudget: !!budgetMap[m.id]
                }));

                setMilestones(enhancedMilestones);
                setMilestoneBudgets(budgetMap);
            } catch (err) {
                console.error('Failed to fetch milestones:', err);
            }
        }
    };

    const [formData, setFormData] = useState({
        projectId: '',
        milestoneId: '',
        packageCode: '',
        contractorId: '',
        workOrderNo: '',
        billNo: '',
        periodFrom: '',
        periodTo: '',
        submissionDate: new Date().toISOString().split('T')[0],
        grossAmount: 0,
        gstRate: 18,
        retentionRate: 5,
        mobilizationRecovery: 0,
        materialRecovery: 0,
        penaltyAmount: 0,
        priceAdjustment: 0,
        insuranceRecovery: 0,
        otherDeductions: 0,
        remarks: ''
    });

    const [calculations, setCalculations] = useState({
        gstAmount: 0,
        totalAmount: 0,
        statutoryDeductions: [], // Dynamic from ETPMaster
        totalStatutoryDeductions: 0,
        retentionAmount: 0,
        totalDeductions: 0,
        netPayable: 0
    });

    // ETP Calculation State
    const [etpLoading, setEtpLoading] = useState(false);
    const [etpError, setEtpError] = useState(null);
    const etpDebounceRef = useRef(null);

    // Reset on open
    useEffect(() => {
        if (isOpen) {
            setViewMode('edit');
            setFormData(prev => ({
                ...prev,
                billNo: `RA-${new Date().getFullYear()}-${Math.floor(Math.random() * 1000)}`
            }));
        }
    }, [isOpen]);

    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && isOpen) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [isOpen, onClose]);

    // MAIN CALCULATION LOGIC - Uses Backend ETP Service
    const calculateETP = useCallback(async (grossAmount, gstRate, retentionRate) => {
        if (!grossAmount || grossAmount <= 0) {
            setCalculations(prev => ({
                ...prev,
                gstAmount: 0,
                totalAmount: 0,
                statutoryDeductions: [],
                totalStatutoryDeductions: 0,
                retentionAmount: 0,
                totalDeductions: 0,
                netPayable: 0
            }));
            return;
        }

        setEtpLoading(true);
        setEtpError(null);

        try {
            // Calculate manual deductions
            const manualDeductions =
                (parseFloat(formData.mobilizationRecovery) || 0) +
                (parseFloat(formData.materialRecovery) || 0) +
                (parseFloat(formData.penaltyAmount) || 0) +
                (parseFloat(formData.priceAdjustment) || 0) +
                (parseFloat(formData.insuranceRecovery) || 0) +
                (parseFloat(formData.otherDeductions) || 0);

            // Call backend ETP calculation API
            const response = await financeService.calculateETP({
                gross_amount: grossAmount,
                gst_percentage: gstRate,
                retention_percentage: retentionRate,
                other_deductions: manualDeductions,
                advances_recovery: (parseFloat(formData.mobilizationRecovery) || 0) + (parseFloat(formData.materialRecovery) || 0)
            });

            const summary = response.data;

            // Extract all statutory charges (deductions + levies + recoveries)
            const allCharges = [
                ...(summary.statutory_charges?.deductions || []),
                ...(summary.statutory_charges?.recoveries || []),
                ...(summary.statutory_charges?.levies || [])
            ];

            setCalculations({
                gstAmount: summary.gst_amount || 0,
                totalAmount: summary.total_before_deductions || (grossAmount + (grossAmount * gstRate / 100)),
                statutoryDeductions: allCharges,
                totalStatutoryDeductions: summary.total_statutory_deductions || 0,
                retentionAmount: summary.retention_amount || 0,
                totalDeductions: summary.total_deductions || 0,
                netPayable: summary.net_payable || 0
            });

        } catch (err) {
            console.error('ETP calculation failed:', err);
            setEtpError('Failed to calculate statutory deductions');

            // Fallback to basic calculation if API fails
            const gross = parseFloat(grossAmount) || 0;
            const gstAmount = (gross * gstRate) / 100;
            const totalAmount = gross + gstAmount;
            const retentionAmount = (gross * retentionRate) / 100;

            const manualDeductions =
                (parseFloat(formData.mobilizationRecovery) || 0) +
                (parseFloat(formData.materialRecovery) || 0) +
                (parseFloat(formData.penaltyAmount) || 0) +
                (parseFloat(formData.priceAdjustment) || 0) +
                (parseFloat(formData.insuranceRecovery) || 0) +
                (parseFloat(formData.otherDeductions) || 0);

            setCalculations({
                gstAmount,
                totalAmount,
                statutoryDeductions: [],
                totalStatutoryDeductions: 0,
                retentionAmount,
                totalDeductions: retentionAmount + manualDeductions,
                netPayable: totalAmount - retentionAmount - manualDeductions
            });
        } finally {
            setEtpLoading(false);
        }
    }, [formData.mobilizationRecovery, formData.materialRecovery, formData.penaltyAmount, formData.priceAdjustment, formData.insuranceRecovery, formData.otherDeductions]);

    // Debounced ETP calculation trigger
    useEffect(() => {
        // Clear existing timeout
        if (etpDebounceRef.current) {
            clearTimeout(etpDebounceRef.current);
        }

        // Set new debounced calculation (500ms delay)
        etpDebounceRef.current = setTimeout(() => {
            calculateETP(
                parseFloat(formData.grossAmount) || 0,
                parseFloat(formData.gstRate) || 18,
                parseFloat(formData.retentionRate) || 0
            );
        }, 500);

        return () => {
            if (etpDebounceRef.current) {
                clearTimeout(etpDebounceRef.current);
            }
        };
    }, [formData.grossAmount, formData.gstRate, formData.retentionRate, formData.mobilizationRecovery, formData.materialRecovery, formData.penaltyAmount, formData.priceAdjustment, formData.insuranceRecovery, formData.otherDeductions, calculateETP]);

    // Check for budget overspend when milestoneId or grossAmount changes
    useEffect(() => {
        if (formData.milestoneId && formData.grossAmount > 0) {
            const allocatedBudget = milestoneBudgets[formData.milestoneId] || 0;
            const billAmount = parseFloat(formData.grossAmount) || 0;

            if (allocatedBudget > 0 && billAmount > allocatedBudget) {
                setBudgetWarning({
                    message: `Bill amount (â‚¹${billAmount.toLocaleString('en-IN')}) exceeds allocated budget (â‚¹${allocatedBudget.toLocaleString('en-IN')})`,
                    severity: 'warning'
                });
            } else if (allocatedBudget > 0 && billAmount > allocatedBudget * 0.8) {
                setBudgetWarning({
                    message: `Bill amount is over 80% of allocated budget (â‚¹${allocatedBudget.toLocaleString('en-IN')})`,
                    severity: 'caution'
                });
            } else {
                setBudgetWarning(null);
            }
        } else {
            setBudgetWarning(null);
        }
    }, [formData.milestoneId, formData.grossAmount, milestoneBudgets]);

    const handlePrint = () => {
        window.print();
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.projectId || !formData.contractorId) {
            toast.error("Project and Contractor are required");
            return;
        }

        const selectedProject = projects.find(p => p.id === formData.projectId);
        const selectedContractor = contractors.find(c => c.id === formData.contractorId);

        const billData = {
            ...formData,
            ...calculations,
            projectName: selectedProject?.name,
            contractorName: selectedContractor?.contractorName,
            status: 'Generated'
        };

        if (onSave) {
            await onSave(billData);
            setViewMode('success');
        }
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };



    if (!isOpen) return null;

    const selectedProject = projects.find(p => p.id === formData.projectId);
    const selectedContractor = contractors.find(c => c.id === formData.contractorId);
    const fullDataForTemplate = { ...formData, ...calculations };

    return createPortal(
        <AnimatePresence>
            {isOpen && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm print:bg-white print:static print:inset-auto"
                >
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95, y: 20 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.95, y: 20 }}
                        className="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden print:shadow-none print:w-full print:max-w-none print:max-h-none print:h-auto"
                        onClick={e => e.stopPropagation()}
                    >
                        {/* Header */}
                        <div className="flex-none bg-white dark:bg-neutral-900 border-b border-slate-200 dark:border-neutral-700 px-6 py-4 flex items-center justify-between z-10 print:hidden">
                            <div className="flex items-center gap-3">
                                {viewMode === 'preview' && (
                                    <button onClick={() => setViewMode('success')} className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-full mr-1">
                                        <ArrowLeft size={20} className="text-slate-600 dark:text-neutral-400" />
                                    </button>
                                )}
                                <div className="p-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 rounded-lg">
                                    <Calculator size={24} />
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-slate-900 dark:text-white">
                                        {viewMode === 'edit' ? 'RA Bill Calculator' : viewMode === 'preview' ? 'Bill Preview' : 'Bill Generated'}
                                    </h2>
                                    <p className="text-sm text-slate-500 dark:text-neutral-400">
                                        {viewMode === 'edit' ? 'Generate Rule-based Running Account Bills' : 'Review and Print'}
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={onClose}
                                    className="p-2 text-slate-400 dark:text-neutral-400 hover:text-slate-600 dark:hover:text-neutral-300 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                                >
                                    <X size={20} />
                                </button>
                            </div>
                        </div>

                        {/* Content Grid - Uses min-h-0 to allow nested scrolling */}
                        <div className="flex-1 min-h-0 flex flex-col lg:flex-row print:hidden bg-slate-50 dark:bg-neutral-800">

                            {/* EDIT MODE */}
                            {viewMode === 'edit' && (
                                <>
                                    {/* Left: Form - Independent Scroll */}
                                    <div className="flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-slate-200 dark:scrollbar-thumb-neutral-700 border-r border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 min-h-0">
                                        <form id="ra-bill-form" className="space-y-6">
                                            {/* Section 1: Basic Info */}
                                            <div className="space-y-4">
                                                <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-neutral-700 pb-2 flex items-center gap-2"><FileText size={16} /> Project & Vendor</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">Project</label>
                                                        <select name="projectId" value={formData.projectId} onChange={handleProjectChange} className="w-full px-3 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-slate-900 dark:text-white rounded-md text-sm">
                                                            <option value="">Select Project...</option>
                                                            {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">Contractor</label>
                                                        <select name="contractorId" value={formData.contractorId} onChange={handleChange} className="w-full px-3 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-slate-900 dark:text-white rounded-md text-sm">
                                                            <option value="">Select Contractor...</option>
                                                            {contractors.map(c => <option key={c.id} value={c.id}>{c.contractorName}</option>)}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">Linked Milestone (Schedule)</label>
                                                        <select
                                                            name="milestoneId"
                                                            value={formData.milestoneId}
                                                            onChange={handleChange}
                                                            className={`w-full px-3 py-2 border rounded-md text-sm bg-white dark:bg-neutral-900 text-slate-900 dark:text-white ${budgetWarning ? (budgetWarning.severity === 'warning' ? 'border-red-300 bg-red-50 dark:bg-red-900/10' : 'border-amber-300 bg-amber-50 dark:bg-amber-900/10') : 'border-slate-200 dark:border-neutral-700'}`}
                                                        >
                                                            <option value="">-- General / No Milestone --</option>
                                                            {milestones.filter(m => m.hasBudget).map(m => (
                                                                <option key={m.id} value={m.id}>
                                                                    {m.name} â€¢ {m.progress}% done â€¢ â‚¹{(m.allocatedBudget / 100000).toFixed(1)}L budget
                                                                </option>
                                                            ))}
                                                            {milestones.filter(m => !m.hasBudget).length > 0 && (
                                                                <optgroup label="No Budget Allocated">
                                                                    {milestones.filter(m => !m.hasBudget).map(m => (
                                                                        <option key={m.id} value={m.id} className="text-slate-400">
                                                                            {m.name} â€¢ {m.progress}% done â€¢ No budget
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                            )}
                                                        </select>
                                                        {budgetWarning && (
                                                            <p className={`mt-1 text-xs flex items-center gap-1 ${budgetWarning.severity === 'warning' ? 'text-red-600' : 'text-amber-600'}`}>
                                                                <AlertCircle size={12} />
                                                                {budgetWarning.message}
                                                            </p>
                                                        )}
                                                    </div>
                                                    <Input label="Work Order No" name="workOrderNo" value={formData.workOrderNo} onChange={handleChange} />
                                                    <Input label="RA Bill No" name="billNo" value={formData.billNo} onChange={handleChange} />
                                                    <Input label="Package Code" name="packageCode" value={formData.packageCode} onChange={handleChange} />
                                                    <Input label="Submission Date" name="submissionDate" type="date" value={formData.submissionDate} onChange={handleChange} />
                                                    <div className="col-span-2 grid grid-cols-2 gap-4">
                                                        <Input label="Period From" name="periodFrom" type="date" value={formData.periodFrom} onChange={handleChange} />
                                                        <Input label="Period To" name="periodTo" type="date" value={formData.periodTo} onChange={handleChange} />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Section 2: Bill Amount */}
                                            <div className="space-y-4">
                                                <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-neutral-700 pb-2 flex items-center gap-2"><IndianRupee size={16} /> Bill Amount</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <Input label="Gross Bill Amount" name="grossAmount" type="number" value={formData.grossAmount} onChange={handleChange} required />
                                                    <Input label="GST Rate (%)" name="gstRate" type="number" value={formData.gstRate} onChange={handleChange} />
                                                </div>
                                            </div>

                                            {/* Section 3: Deductions */}
                                            <div className="space-y-4">
                                                <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-neutral-700 pb-2 flex items-center gap-2"><AlertCircle size={16} /> Deductions & Recoveries</h3>

                                                {/* Statutory Deductions Info */}
                                                <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 p-3 rounded-lg">
                                                    <div className="flex items-start gap-2">
                                                        <Calculator size={16} className="text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" />
                                                        <div>
                                                            <p className="text-xs font-semibold text-blue-800 dark:text-blue-300">Statutory Deductions (Auto-Calculated)</p>
                                                            <p className="text-xs text-blue-600 dark:text-blue-400 mt-1">
                                                                TDS, Labour Cess, and other statutory charges are automatically calculated based on
                                                                <span className="font-semibold"> ETP Master</span> rates configured in Admin â†’ Master Data.
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Retention Rate - User configurable per project */}
                                                <div className="grid grid-cols-2 gap-4">
                                                    <Input label="Security Deposit / Retention (%)" name="retentionRate" type="number" value={formData.retentionRate} onChange={handleChange} />
                                                </div>

                                                {/* Advance Recoveries */}
                                                <div className="grid grid-cols-2 gap-4 bg-orange-50/50 p-2 rounded">
                                                    <Input label="Mobilization Advance Recovery" name="mobilizationRecovery" type="number" value={formData.mobilizationRecovery} onChange={handleChange} />
                                                    <Input label="Material Advance Recovery" name="materialRecovery" type="number" value={formData.materialRecovery} onChange={handleChange} />
                                                </div>

                                                <div className="grid grid-cols-2 gap-4 bg-red-50/50 dark:bg-red-900/10 p-2 rounded">
                                                    <Input label="Penalty / Damages" name="penaltyAmount" type="number" value={formData.penaltyAmount} onChange={handleChange} />
                                                    <Input label="Price Adjustment" name="priceAdjustment" type="number" value={formData.priceAdjustment} onChange={handleChange} />
                                                    <Input label="Insurance Recovery" name="insuranceRecovery" type="number" value={formData.insuranceRecovery} onChange={handleChange} />
                                                    <Input label="Other Deductions" name="otherDeductions" type="number" value={formData.otherDeductions} onChange={handleChange} />
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                                    {/* Right: Summary - Independent Scroll */}
                                    <div className="w-full lg:w-[400px] bg-slate-50 dark:bg-neutral-800/50 flex flex-col min-h-0 border-l border-slate-200 dark:border-neutral-700">
                                        <div className="flex-none p-4 bg-white dark:bg-neutral-900 border-b border-slate-200 dark:border-neutral-700">
                                            <h3 className="font-bold text-slate-800 dark:text-white">Calculation Summary</h3>
                                        </div>
                                        <div className="flex-1 overflow-y-scroll p-6 pb-24 space-y-4 scrollbar-thin scrollbar-thumb-slate-400 dark:scrollbar-thumb-neutral-600 scrollbar-track-slate-100 dark:scrollbar-track-neutral-800">
                                            <SummaryRow label="Gross Amount" value={formData.grossAmount} />
                                            <SummaryRow label="GST Amount" value={calculations.gstAmount} subtext={`@ ${formData.gstRate}%`} />
                                            <div className="h-px bg-slate-300 my-2" />
                                            <SummaryRow label="Total (Incl. GST)" value={calculations.totalAmount} bold />

                                            <div className="mt-6 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                                Statutory Deductions
                                                {etpLoading && <Loader2 size={12} className="animate-spin text-primary-500" />}
                                            </div>

                                            {etpError && (
                                                <div className="text-xs text-amber-600 bg-amber-50 p-2 rounded mb-2 flex items-center gap-1">
                                                    <AlertCircle size={12} />
                                                    {etpError} - Using fallback calculation
                                                </div>
                                            )}

                                            {/* Dynamic Statutory Charges from ETPMaster */}
                                            {calculations.statutoryDeductions.length > 0 ? (
                                                calculations.statutoryDeductions.map((charge, idx) => (
                                                    <SummaryRow
                                                        key={charge.code || idx}
                                                        label={`${charge.name} (${charge.rate_percentage}%)`}
                                                        value={charge.calculated_amount}
                                                        subtext={charge.basis}
                                                        isDeduction
                                                    />
                                                ))
                                            ) : (
                                                <p className="text-xs text-slate-400 italic">No statutory charges configured</p>
                                            )}

                                            {/* Retention / Security Deposit */}
                                            <SummaryRow label={`Retention (${formData.retentionRate}%)`} value={calculations.retentionAmount} isDeduction />

                                            {/* Manual Deductions */}
                                            <div className="mt-4 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">Recoveries & Other</div>
                                            <SummaryRow label="Advance Recoveries" value={(parseFloat(formData.mobilizationRecovery) || 0) + (parseFloat(formData.materialRecovery) || 0)} isDeduction />
                                            <SummaryRow label="Penalties & Adjustments" value={(parseFloat(formData.penaltyAmount) || 0) + (parseFloat(formData.priceAdjustment) || 0) + (parseFloat(formData.insuranceRecovery) || 0) + (parseFloat(formData.otherDeductions) || 0)} isDeduction />

                                            <div className="h-px bg-slate-300 my-4" />

                                            <div className="space-y-2">
                                                <h4 className="text-sm font-bold text-slate-900">Net Payable Calculation</h4>
                                                <p className="text-[10px] text-slate-500 font-mono">
                                                    (Total Amount) - (Total Deductions)
                                                </p>
                                                <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                                    <div className="flex justify-between items-end">
                                                        <div>
                                                            <p className="text-sm text-emerald-600 font-medium mb-1">Net Payable Amount</p>
                                                            <p className="text-xs text-emerald-600/70">
                                                                {new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(calculations.totalAmount)} - {new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(calculations.totalDeductions)}
                                                            </p>
                                                        </div>
                                                        <p className="text-3xl font-bold text-emerald-700">
                                                            {new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(calculations.netPayable)}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="pt-4">
                                                <Button onClick={handleSubmit} className="w-full bg-primary-950 hover:bg-primary-900 text-white shadow-lg py-3">
                                                    <Save size={18} className="mr-2" /> Generate Invoice & Save
                                                </Button>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}

                            {/* SUCCESS STATE */}
                            {viewMode === 'success' && (
                                <div className="flex-1 flex flex-col items-center justify-center bg-white dark:bg-neutral-900 p-8 animate-in fade-in zoom-in duration-300">
                                    <div className="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mb-6">
                                        <CheckCircle size={40} className="text-emerald-600 dark:text-emerald-400" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-2">Invoice Generated Successfully!</h3>
                                    <p className="text-slate-500 mb-8 text-center max-w-md">
                                        RA Bill <span className="font-mono font-bold text-slate-700">{formData.billNo}</span> has been saved to the register. What would you like to do next?
                                    </p>
                                    <div className="flex gap-4">
                                        <Button
                                            variant="outline"
                                            onClick={() => setViewMode('preview')}
                                            className="min-w-[160px] h-12 text-lg"
                                        >
                                            <Eye size={20} className="mr-2" /> View Bill
                                        </Button>
                                        <Button
                                            onClick={handlePrint}
                                            className="min-w-[160px] h-12 text-lg bg-primary-600 hover:bg-primary-700 text-white shadow-lg"
                                        >
                                            <Printer size={20} className="mr-2" /> Download PDF
                                        </Button>
                                    </div>
                                </div>
                            )}

                            {/* PREVIEW MODE */}
                            {viewMode === 'preview' && (
                                <div className="flex-1 overflow-auto bg-slate-100 p-8 flex justify-center">
                                    <div className="bg-white shadow-xl p-0 w-fit">
                                        {/* Visually render the template here for preview */}
                                        <div className="scale-[0.8] origin-top">
                                            <RABillTemplate
                                                bill={fullDataForTemplate}
                                                project={selectedProject}
                                                contractor={selectedContractor}
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Hidden Print Template (Always present for print media) */}
                        <div className="hidden print:block">
                            <RABillTemplate
                                bill={fullDataForTemplate}
                                project={selectedProject}
                                contractor={selectedContractor}
                            />
                        </div>
                    </motion.div>
                </motion.div>
            )}
        </AnimatePresence>,
        document.body
    );
};

// Sub-components
const Input = ({ label, className = "", ...props }) => (
    <div className={className}>
        <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">{label}</label>
        <input
            className="w-full px-3 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-slate-900 dark:text-white rounded-md text-sm outline-none focus:ring-2 focus:ring-primary-500 transition-all"
            {...props}
        />
    </div>
);

const SummaryRow = ({ label, value, subtext, bold, isDeduction }) => (
    <div className={`flex justify-between items-start ${bold ? 'font-bold text-slate-900 dark:text-white' : 'text-slate-600 dark:text-neutral-400'}`}>
        <div>
            <span>{label}</span>
            {subtext && <p className="text-[10px] text-slate-400 dark:text-neutral-500 font-normal">{subtext}</p>}
        </div>
        <span className={isDeduction ? 'text-red-600 dark:text-red-400' : ''}>
            {isDeduction ? '-' : ''} {new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(value)}
        </span>
    </div>
);



================================================
FILE: frontend/src/components/billing/RABillTemplate.jsx
================================================
import React from 'react';

// This component is designed to be printed using window.print()
// It mimics the exact layout of the Excel sheet provided
export const RABillTemplate = React.forwardRef(({ bill, project, contractor }, ref) => {
    // Helper to format currency
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2
        }).format(amount || 0);
    };

    const formatDate = (dateString) => {
        if (!dateString) return '-';
        return new Date(dateString).toLocaleDateString('en-IN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    };

    return (
        <div ref={ref} className="print-container bg-white p-8 text-xs font-sans text-black print:block print:w-full">
            <style type="text/css" media="print">
                {`
                    @page { size: A4 portrait; margin: 1cm; }
                    .print-container { display: block !important; }
                    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                    th, td { border: 1px solid #000; padding: 4px; vertical-align: middle; }
                    .header-cell { background-color: #f0f0f0; font-weight: bold; }
                    .section-header { background-color: #e0e0e0; font-weight: bold; text-align: left; }
                    .input-cell { text-align: right; }
                    .text-center { text-align: center; }
                    .text-right { text-align: right; }
                    .bold { font-weight: bold; }
                    .no-border-left { border-left: none; }
                    .no-border-right { border-right: none; }
                `}
            </style>

            <h1 className="text-center text-lg font-bold mb-6 uppercase border-b-2 border-black pb-2">
                RA Bill â€“ TDS & Tax Deduction Calculation Sheet
            </h1>

            {/* 1. PROJECT & VENDOR DETAILS */}
            <table>
                <tbody>
                    <tr>
                        <td colSpan="2" className="section-header">1. PROJECT & VENDOR DETAILS</td>
                        <td colSpan="2"></td>
                    </tr>
                    <tr>
                        <td className="w-1/4 bold">Project Name</td>
                        <td className="w-1/4">{project?.name || '-'}</td>
                        <td className="w-1/4 bold">TDS CATEGORY MASTER</td>
                        <td className="w-1/4 text-center bold">Rate</td>
                    </tr>
                    <tr>
                        <td className="bold">Project Code / Cost Centre</td>
                        <td>{project?.code || '-'}</td>
                        <td>194C - Individual / HUF (1%)</td>
                        <td className="text-right">1.00%</td>
                    </tr>
                    <tr>
                        <td className="bold">Package Code / Cost Centre</td>
                        <td>{bill?.packageCode || '-'}</td>
                        <td>194C - Others (2%)</td>
                        <td className="text-right">2.00%</td>
                    </tr>
                    <tr>
                        <td className="bold">Contractor / Vendor Name</td>
                        <td>{contractor?.contractorName || '-'}</td>
                        <td>194J - Professional Fees (10%)</td>
                        <td className="text-right">10.00%</td>
                    </tr>
                    <tr>
                        <td className="bold">Vendor GSTIN</td>
                        <td>{contractor?.gstinNo || '-'}</td>
                        <td colSpan="2"></td>
                    </tr>
                    <tr>
                        <td className="bold">Work Order / Contract No.</td>
                        <td>{bill?.workOrderNo || '-'}</td>
                        <td colSpan="2"></td>
                    </tr>
                    <tr>
                        <td className="bold">RA Bill No.</td>
                        <td>{bill?.billNo || '-'}</td>
                        <td colSpan="2"></td>
                    </tr>
                    <tr>
                        <td className="bold">RA Bill Period (From â€“ To)</td>
                        <td>{formatDate(bill?.periodFrom)} to {formatDate(bill?.periodTo)}</td>
                        <td colSpan="2"></td>
                    </tr>
                    <tr>
                        <td className="bold">Bill Submission Date</td>
                        <td>{formatDate(bill?.submissionDate)}</td>
                        <td colSpan="2"></td>
                    </tr>
                </tbody>
            </table>

            {/* 2. BILL AMOUNT DETAILS */}
            <table>
                <tbody>
                    <tr>
                        <td colSpan="4" className="section-header">2. BILL AMOUNT DETAILS</td>
                    </tr>
                    <tr>
                        <td className="w-1/2">Gross Bill Amount (Before GST)</td>
                        <td className="w-1/4"></td>
                        <td className="w-1/4 text-right">{formatCurrency(bill?.grossAmount)}</td>
                        <td className="w-0 border-0"></td>
                    </tr>
                    <tr>
                        <td>GST Rate (%)</td>
                        <td></td>
                        <td className="text-right">{bill?.gstRate}%</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>GST Amount</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.gstAmount)}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td className="bold">Bill Amount Including GST</td>
                        <td></td>
                        <td className="text-right bold">{formatCurrency(bill?.totalAmount)}</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            {/* 3. STATUTORY DEDUCTIONS */}
            <table>
                <tbody>
                    <tr>
                        <td colSpan="4" className="section-header">3. STATUTORY DEDUCTIONS</td>
                    </tr>
                    <tr>
                        <td colSpan="4" className="bold bg-slate-50">3A. TDS (Income Tax)</td>
                    </tr>
                    <tr>
                        <td className="w-1/2">TDS Category</td>
                        <td className="w-1/4"></td>
                        <td className="w-1/4">{bill?.tdsCategory || '-'}</td>
                        <td className="w-0 border-0"></td>
                    </tr>
                    <tr>
                        <td>TDS Rate (%)</td>
                        <td></td>
                        <td className="text-right">{bill?.tdsRate}%</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>TDS Amount</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.tdsAmount)}</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td colSpan="4" className="bold bg-slate-50">3B. LABOUR CESS</td>
                    </tr>
                    <tr>
                        <td>Labour Welfare Cess Rate (%)</td>
                        <td></td>
                        <td className="text-right">{bill?.labourCessRate}%</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Labour Welfare Cess Amount</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.labourCessAmount)}</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td colSpan="4" className="bold bg-slate-50">3C. RETENTION / SECURITY DEPOSIT</td>
                    </tr>
                    <tr>
                        <td>Retention Percentage (%)</td>
                        <td></td>
                        <td className="text-right">{bill?.retentionRate}%</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Retention Amount</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.retentionAmount)}</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td colSpan="4" className="bold bg-slate-50">3D. ADVANCE RECOVERIES</td>
                    </tr>
                    <tr>
                        <td>Mobilization Advance Recovery</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.mobilizationRecovery)}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Material Advance Recovery</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.materialRecovery)}</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td colSpan="4" className="bold bg-slate-50">3E. OTHER DEDUCTIONS</td>
                    </tr>
                    <tr>
                        <td>Penalty / Liquidated Damages</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.penaltyAmount)}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Price Adjustment</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.priceAdjustment)}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Insurance Recovery</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.insuranceRecovery)}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Any Other Deductions</td>
                        <td></td>
                        <td className="text-right">{formatCurrency(bill?.otherDeductions)}</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            {/* 4. NET PAYABLE CALCULATION */}
            <table>
                <tbody>
                    <tr>
                        <td colSpan="4" className="section-header">4. NET PAYABLE CALCULATION</td>
                    </tr>
                    <tr>
                        <td className="w-1/2">Bill Amount Including GST</td>
                        <td className="w-1/4"></td>
                        <td className="w-1/4 text-right bold">{formatCurrency(bill?.totalAmount)}</td>
                        <td className="w-0 border-0"></td>
                    </tr>
                    <tr>
                        <td>Less: Total TDS</td>
                        <td></td>
                        <td className="text-right">({formatCurrency(bill?.tdsAmount)})</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Less: Labour Cess</td>
                        <td></td>
                        <td className="text-right">({formatCurrency(bill?.labourCessAmount)})</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Less: Retention</td>
                        <td></td>
                        <td className="text-right">({formatCurrency(bill?.retentionAmount)})</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Less: Advance Recoveries</td>
                        <td></td>
                        <td className="text-right">({formatCurrency((bill?.mobilizationRecovery || 0) + (bill?.materialRecovery || 0))})</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Less: Other Deductions</td>
                        <td></td>
                        <td className="text-right">({formatCurrency((bill?.penaltyAmount || 0) + (bill?.priceAdjustment || 0) + (bill?.insuranceRecovery || 0) + (bill?.otherDeductions || 0))})</td>
                        <td></td>
                    </tr>
                    <tr className="bg-slate-100">
                        <td className="bold">NET AMOUNT PAYABLE TO CONTRACTOR</td>
                        <td></td>
                        <td className="text-right bold border-double border-4">{formatCurrency(bill?.netPayable)}</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            {/* 5. EMD */}
            <table>
                <tbody>
                    <tr>
                        <td colSpan="4" className="section-header">5. EMD (Earnest Money Deposit)</td>
                    </tr>
                    <tr>
                        <td className="w-1/2">Bid Security Amount</td>
                        <td className="w-1/4"></td>
                        <td className="w-1/4 text-right">{formatCurrency(bill?.emdAmount)}</td>
                        <td className="w-0 border-0"></td>
                    </tr>
                </tbody>
            </table>

            {/* 6. CERTIFICATION */}
            <div className="mt-8 break-inside-avoid">
                <table className="mt-4">
                    <thead>
                        <tr>
                            <td colSpan="2" className="section-header">6. CERTIFICATION</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr className="h-24">
                            <td className="w-1/3 align-bottom">
                                <div className="font-bold">Prepared By</div>
                                <div className="mt-8 pt-2 border-t border-black w-2/3">Signature & Date</div>
                            </td>
                            <td className="w-1/3 align-bottom">
                                <div className="font-bold">Verified By (Cost Manager)</div>
                                <div className="mt-8 pt-2 border-t border-black w-2/3">Signature & Date</div>
                            </td>
                        </tr>
                        <tr className="h-24">
                            <td className="w-1/3 align-bottom">
                                <div className="font-bold">Approved By (Project Manager / Finance)</div>
                                <div className="mt-8 pt-2 border-t border-black w-2/3">Signature & Date</div>
                            </td>
                            <td className="w-1/3 align-bottom">
                                <div className="font-bold">Approval Date: _________________</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div className="mt-8 text-center text-gray-500 font-mono text-[10px]">
                Generated via PMIS Zia on {new Date().toLocaleString('en-IN')}
            </div>
        </div>
    );
});



================================================
FILE: frontend/src/components/common/TranslationNavigationGuard.jsx
================================================
[Empty file]


================================================
FILE: frontend/src/components/communications/AddParticipantsModal.jsx
================================================
/**
 * AddParticipantsModal - Modal for adding users to existing group chats
 */
import { useState, useEffect } from 'react';
import { X, Search, UserPlus } from 'lucide-react';
import { toast } from 'sonner';
import { motion, AnimatePresence } from 'framer-motion';
import client from '@/api/client';
import Button from '@/components/ui/Button';

const AddParticipantsModal = ({ thread, onClose, onAdded }) => {
    const [users, setUsers] = useState([]);
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedUsers, setSelectedUsers] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [isLoadingUsers, setIsLoadingUsers] = useState(true);

    useEffect(() => {
        fetchUsers();
    }, []);

    const fetchUsers = async () => {
        setIsLoadingUsers(true);
        try {
            const res = await client.get('/users/');
            const data = Array.isArray(res.data) ? res.data : (res.data.results || []);

            // Filter out users already in the thread
            const currentParticipantIds = thread.participants?.map(p => p.id) || [];
            const availableUsers = data.filter(user => !currentParticipantIds.includes(user.id));

            setUsers(availableUsers);
        } catch (error) {
            console.error('Failed to fetch users:', error);
            toast.error('Failed to load users');
        } finally {
            setIsLoadingUsers(false);
        }
    };

    const filteredUsers = users.filter(user =>
        user.username?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        user.email?.toLowerCase().includes(searchQuery.toLowerCase())
    );

    const toggleUserSelection = (user) => {
        if (selectedUsers.find(u => u.id === user.id)) {
            setSelectedUsers(selectedUsers.filter(u => u.id !== user.id));
        } else {
            setSelectedUsers([...selectedUsers, user]);
        }
    };

    const handleAddParticipants = async () => {
        if (selectedUsers.length === 0) {
            toast.error('Please select at least one user');
            return;
        }

        setIsLoading(true);
        try {
            const response = await client.post(`/communications/threads/${thread.id}/add_participants/`, {
                participant_ids: selectedUsers.map(u => u.id)
            });

            toast.success(`Added ${selectedUsers.length} participant(s)`);

            if (onAdded) {
                onAdded(response.data.thread);
            }
            onClose();
        } catch (error) {
            console.error('Failed to add participants:', error);
            toast.error(error.response?.data?.error || 'Failed to add participants');
        } finally {
            setIsLoading(false);
        }
    };

    const getRoleBadgeColor = (role) => {
        const colors = {
            'SPV_Official': 'bg-purple-100 text-purple-700',
            'PMNC_Team': 'bg-blue-100 text-blue-700',
            'Govt_Department': 'bg-green-100 text-green-700',
            'EPC_Contractor': 'bg-orange-100 text-orange-700',
            'Consultant_Design': 'bg-cyan-100 text-cyan-700',
        };
        return colors[role] || 'bg-slate-100 text-slate-700';
    };

    return (
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                transition={{ duration: 0.2 }}
                className="fixed inset-0 bg-black/50 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center z-[9999]"
                onClick={onClose}
            >
                <motion.div
                    initial={{ scale: 0.95, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    exit={{ scale: 0.95, opacity: 0 }}
                    transition={{ duration: 0.2 }}
                    onClick={(e) => e.stopPropagation()}
                    className="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden"
                >
                    {/* Header */}
                    <div className="flex items-center justify-between p-6 border-b dark:border-neutral-700">
                        <h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                            <UserPlus className="text-primary-600" size={28} />
                            Add Participants
                        </h2>
                        <button
                            onClick={onClose}
                            className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                        >
                            <X size={20} className="dark:text-neutral-400" />
                        </button>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto p-6">
                        {/* Search */}
                        <div className="relative mb-4">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                            <input
                                type="text"
                                placeholder="Search users..."
                                className="w-full pl-10 pr-4 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        </div>

                        {/* Selected Users Badge */}
                        {selectedUsers.length > 0 && (
                            <div className="mb-4 p-3 bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-lg">
                                <div className="text-sm font-medium text-primary-900 dark:text-primary-300 mb-2">
                                    Selected ({selectedUsers.length}):
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {selectedUsers.map(user => (
                                        <span
                                            key={user.id}
                                            className="inline-flex items-center gap-2 px-3 py-1 bg-white dark:bg-neutral-900 border border-primary-300 dark:border-primary-700 rounded-full text-sm dark:text-white"
                                        >
                                            {user.username}
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    toggleUserSelection(user);
                                                }}
                                                className="hover:bg-red-100 rounded-full p-0.5 transition-colors"
                                            >
                                                <X size={14} />
                                            </button>
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* User List */}
                        {isLoadingUsers ? (
                            <div className="text-center py-8 text-slate-500 dark:text-neutral-400">
                                Loading users...
                            </div>
                        ) : filteredUsers.length === 0 ? (
                            <div className="text-center py-8 text-slate-500 dark:text-neutral-400">
                                {searchQuery ? 'No users found' : 'All users are already in this group'}
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {filteredUsers.map((user) => {
                                    const isSelected = selectedUsers.find(u => u.id === user.id);
                                    return (
                                        <button
                                            key={user.id}
                                            onClick={() => toggleUserSelection(user)}
                                            className={`w-full flex items-center justify-between p-3 rounded-lg border transition-all ${isSelected
                                                ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20'
                                                : 'border-slate-200 dark:border-neutral-700 hover:border-primary-300 hover:bg-slate-50 dark:hover:bg-neutral-800'
                                                }`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${isSelected ? 'bg-primary-600' : 'bg-slate-400'
                                                    }`}>
                                                    {user.username?.charAt(0).toUpperCase()}
                                                </div>
                                                <div className="text-left">
                                                    <div className="font-medium text-slate-900 dark:text-white">{user.username}</div>
                                                    <div className="text-xs text-slate-500 dark:text-neutral-400">{user.email}</div>
                                                </div>
                                            </div>
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${getRoleBadgeColor(user.role)}`}>
                                                {user.role?.replace(/_/g, ' ')}
                                            </span>
                                        </button>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div className="flex items-center justify-between p-6 border-t bg-slate-50">
                        <div className="text-sm text-slate-600">
                            Select users to add to this group chat
                        </div>
                        <div className="flex gap-3">
                            <Button variant="outline" onClick={onClose}>
                                Cancel
                            </Button>
                            <Button
                                onClick={handleAddParticipants}
                                disabled={isLoading || selectedUsers.length === 0}
                            >
                                {isLoading ? 'Adding...' : `Add ${selectedUsers.length || ''} User${selectedUsers.length !== 1 ? 's' : ''}`}
                            </Button>
                        </div>
                    </div>
                </motion.div>
            </motion.div>
        </AnimatePresence>
    );
};

export default AddParticipantsModal;



================================================
FILE: frontend/src/components/communications/NewThreadModal.jsx
================================================
/**
 * NewThreadModal - Enhanced with dynamic context selection and recipients
 * - Select context type â†’ fetches available items â†’ select from dropdown
 * - Select recipients (individuals or groups) like WhatsApp
 */
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { useAuth } from '@/contexts/AuthContext';
import client from '@/api/client';
import { toast } from 'sonner';
import {
    X, MessageSquare, Link2, AlertTriangle, Lock, Gavel,
    FileText, FolderOpen, Users, User, Search, Check, Loader2
} from 'lucide-react';
import Button from '@/components/ui/Button';

const NewThreadModal = ({ onClose, onCreated, preselectedContext = null }) => {
    const { user } = useAuth();
    const [step, setStep] = useState(1); // 1: Context, 2: Recipients, 3: Details
    const [subject, setSubject] = useState('');
    const [threadType, setThreadType] = useState('DISCUSSION');
    const [contextType, setContextType] = useState(preselectedContext?.type || '');
    const [contextId, setContextId] = useState(preselectedContext?.id || '');
    const [contextName, setContextName] = useState(preselectedContext?.name || '');
    const [initialMessage, setInitialMessage] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);

    // Context items (fetched from API)
    const [contextItems, setContextItems] = useState([]);
    const [isLoadingContextItems, setIsLoadingContextItems] = useState(false);
    const [contextSearch, setContextSearch] = useState('');

    // Recipients
    const [recipientType, setRecipientType] = useState('individual'); // 'individual' or 'group'
    const [availableUsers, setAvailableUsers] = useState([]);
    const [selectedRecipients, setSelectedRecipients] = useState([]);
    const [isLoadingUsers, setIsLoadingUsers] = useState(false);
    const [userSearch, setUserSearch] = useState('');

    // Available context types with icons
    const contextOptions = [
        { value: 'edms.document', label: 'Document', icon: FileText, apiEndpoint: '/edms/documents/' },
        { value: 'projects.project', label: 'Project', icon: FolderOpen, apiEndpoint: '/projects/' },
    ];

    // Thread type options based on role
    const threadTypeOptions = [
        { value: 'DISCUSSION', label: 'Discussion', icon: MessageSquare, description: 'General discussion' },
        { value: 'CLARIFICATION', label: 'Clarification', icon: AlertTriangle, description: 'Request clarification' },
        {
            value: 'INTERNAL_NOTE', label: 'Internal Note', icon: Lock, description: 'Hidden from contractors',
            enabled: ['SPV_Official', 'PMNC_Team', 'Govt_Department', 'NICDC_HQ'].includes(user?.role)
        },
        {
            value: 'RULING', label: 'Ruling', icon: Gavel, description: 'Authoritative decision',
            enabled: ['SPV_Official', 'NICDC_HQ'].includes(user?.role)
        },
    ].filter(opt => opt.enabled !== false);

    // Fetch context items when type changes
    useEffect(() => {
        if (contextType && !preselectedContext) {
            fetchContextItems();
        }
    }, [contextType]);

    // Fetch users for recipient selection
    useEffect(() => {
        fetchAvailableUsers();
    }, []);

    const fetchContextItems = async () => {
        const contextConfig = contextOptions.find(c => c.value === contextType);
        if (!contextConfig) return;

        setIsLoadingContextItems(true);
        try {
            const res = await client.get(contextConfig.apiEndpoint);
            const items = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setContextItems(items.map(item => ({
                id: item.id,
                name: item.title || item.name || `${contextConfig.label} ${item.id.substring(0, 8)}`,
                subtitle: item.status || item.category || ''
            })));
        } catch (error) {
            console.error('Failed to fetch context items:', error);
            toast.error('Failed to load items');
        } finally {
            setIsLoadingContextItems(false);
        }
    };

    const fetchAvailableUsers = async () => {
        setIsLoadingUsers(true);
        try {
            const res = await client.get('/users/');
            const users = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setAvailableUsers(users.filter(u => u.id !== user?.id)); // Exclude current user
        } catch (error) {
            console.error('Failed to fetch users:', error);
        } finally {
            setIsLoadingUsers(false);
        }
    };

    const handleContextSelect = (item) => {
        setContextId(item.id);
        setContextName(item.name);
    };

    const toggleRecipient = (recipient) => {
        setSelectedRecipients(prev => {
            const exists = prev.find(r => r.id === recipient.id);
            if (exists) {
                return prev.filter(r => r.id !== recipient.id);
            }
            return [...prev, recipient];
        });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        if (!subject.trim()) {
            toast.error('Subject is required');
            return;
        }

        if (!contextType || !contextId) {
            toast.error('Please select a context');
            return;
        }

        setIsSubmitting(true);
        try {
            const res = await client.post('/communications/threads/', {
                subject,
                context_type: contextType,
                context_id: contextId,
                thread_type: threadType,
                initial_message: initialMessage,
                recipients: selectedRecipients.map(r => r.id) // Send recipient IDs
            });

            toast.success('Thread created successfully');
            onCreated(res.data);
        } catch (error) {
            console.error('Failed to create thread:', error);
            toast.error(error.response?.data?.error || 'Failed to create thread');
        } finally {
            setIsSubmitting(false);
        }
    };

    // Filter context items by search
    const filteredContextItems = contextItems.filter(item =>
        item.name.toLowerCase().includes(contextSearch.toLowerCase())
    );

    // Filter users by search
    const filteredUsers = availableUsers.filter(u =>
        u.username?.toLowerCase().includes(userSearch.toLowerCase()) ||
        u.email?.toLowerCase().includes(userSearch.toLowerCase()) ||
        (u.first_name + ' ' + u.last_name).toLowerCase().includes(userSearch.toLowerCase())
    );

    // Role display helper
    const getRoleLabel = (role) => {
        const labels = {
            'SPV_Official': 'SPV Official',
            'PMNC_Team': 'PMNC Team',
            'EPC_Contractor': 'Contractor',
            'Consultant_Design': 'Consultant',
            'Govt_Department': 'Govt. Dept.',
            'NICDC_HQ': 'NICDC HQ'
        };
        return labels[role] || role;
    };

    return createPortal(
        <AnimatePresence>
            <div className="fixed inset-0 z-[9999] bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                <motion.div
                    initial={{ opacity: 0, scale: 0.95, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95, y: 20 }}
                    className="bg-white dark:bg-neutral-900 rounded-2xl w-full max-w-xl shadow-2xl overflow-hidden"
                >
                    {/* Header */}
                    <div className="flex justify-between items-center p-4 border-b border-slate-200 dark:border-neutral-700 bg-gradient-to-r from-primary-50 to-blue-50 dark:from-neutral-800 dark:to-neutral-800">
                        <div>
                            <h2 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <MessageSquare className="text-primary-600" size={20} />
                                New Conversation
                            </h2>
                            <p className="text-xs text-slate-500 dark:text-neutral-400 mt-0.5">
                                Step {step} of 3 â€¢ {step === 1 ? 'Select Context' : step === 2 ? 'Add Recipients' : 'Message Details'}
                            </p>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-white/50 dark:hover:bg-neutral-700 rounded-lg transition-colors">
                            <X size={20} className="text-slate-500 dark:text-neutral-400" />
                        </button>
                    </div>

                    {/* Step 1: Context Selection */}
                    {step === 1 && (
                        <div className="p-4 space-y-4 max-h-[60vh] overflow-y-auto">
                            {/* Context Type Selection */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-2">
                                    What is this conversation about?
                                </label>
                                <div className="grid grid-cols-2 gap-3">
                                    {contextOptions.map(opt => {
                                        const Icon = opt.icon;
                                        const isSelected = contextType === opt.value;
                                        return (
                                            <button
                                                key={opt.value}
                                                type="button"
                                                onClick={() => {
                                                    setContextType(opt.value);
                                                    setContextId('');
                                                    setContextName('');
                                                }}
                                                className={`p-4 rounded-xl border-2 text-left transition-all ${isSelected
                                                    ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/30 shadow-md'
                                                    : 'border-slate-200 dark:border-neutral-700 hover:border-slate-300 hover:bg-slate-50 dark:hover:bg-neutral-800'
                                                    }`}
                                            >
                                                <Icon size={24} className={isSelected ? 'text-primary-600' : 'text-slate-400'} />
                                                <span className={`block mt-2 font-semibold ${isSelected ? 'text-primary-700 dark:text-primary-400' : 'text-slate-700 dark:text-neutral-300'}`}>
                                                    {opt.label}
                                                </span>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Context Item Selection */}
                            {contextType && !preselectedContext && (
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-2">
                                        Select {contextOptions.find(c => c.value === contextType)?.label}
                                    </label>

                                    {/* Search */}
                                    <div className="relative mb-3">
                                        <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                        <input
                                            type="text"
                                            placeholder="Search..."
                                            value={contextSearch}
                                            onChange={(e) => setContextSearch(e.target.value)}
                                            className="w-full pl-9 pr-4 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                                        />
                                    </div>

                                    {/* Items List */}
                                    <div className="border border-slate-200 dark:border-neutral-700 rounded-lg max-h-48 overflow-y-auto bg-white dark:bg-neutral-800">
                                        {isLoadingContextItems ? (
                                            <div className="p-4 text-center text-slate-400 dark:text-neutral-500">
                                                <Loader2 size={20} className="animate-spin mx-auto" />
                                                <p className="text-sm mt-2">Loading...</p>
                                            </div>
                                        ) : filteredContextItems.length === 0 ? (
                                            <div className="p-4 text-center text-slate-400 dark:text-neutral-500 text-sm">
                                                No items found
                                            </div>
                                        ) : (
                                            filteredContextItems.map(item => (
                                                <button
                                                    key={item.id}
                                                    type="button"
                                                    onClick={() => handleContextSelect(item)}
                                                    className={`w-full text-left p-3 border-b border-slate-100 dark:border-neutral-700 last:border-b-0 hover:bg-slate-50 dark:hover:bg-neutral-700 transition-colors flex items-center justify-between ${contextId === item.id ? 'bg-primary-50 dark:bg-primary-900/30' : ''
                                                        }`}
                                                >
                                                    <div>
                                                        <p className="font-medium text-sm text-slate-800 dark:text-white">{item.name}</p>
                                                        {item.subtitle && (
                                                            <p className="text-xs text-slate-500 dark:text-neutral-400">{item.subtitle}</p>
                                                        )}
                                                    </div>
                                                    {contextId === item.id && (
                                                        <Check size={18} className="text-primary-600" />
                                                    )}
                                                </button>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Preselected Context Display */}
                            {preselectedContext && (
                                <div className="p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                                    <p className="text-sm text-green-800 dark:text-green-300">
                                        <strong>Linked to:</strong> {preselectedContext.name || `${contextType.split('.')[1]} (${contextId.substring(0, 8)}...)`}
                                    </p>
                                </div>
                            )}

                            <div className="pt-4 flex justify-end">
                                <Button
                                    onClick={() => setStep(2)}
                                    disabled={!contextType || !contextId}
                                >
                                    Next: Add Recipients
                                </Button>
                            </div>
                        </div>
                    )}

                    {/* Step 2: Recipient Selection */}
                    {step === 2 && (
                        <div className="p-4 space-y-4 max-h-[60vh] overflow-y-auto">
                            {/* Recipient Type */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-2">
                                    Who do you want to start this conversation with?
                                </label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button
                                        type="button"
                                        onClick={() => setRecipientType('individual')}
                                        className={`p-4 rounded-xl border-2 text-left transition-all ${recipientType === 'individual'
                                            ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/30 shadow-md'
                                            : 'border-slate-200 dark:border-neutral-700 hover:border-slate-300 dark:hover:bg-neutral-800'
                                            }`}
                                    >
                                        <User size={24} className={recipientType === 'individual' ? 'text-primary-600' : 'text-slate-400'} />
                                        <span className={`block mt-2 font-semibold ${recipientType === 'individual' ? 'text-primary-700 dark:text-primary-400' : 'text-slate-700 dark:text-neutral-300'}`}>
                                            Individual(s)
                                        </span>
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">Select specific people</p>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setRecipientType('group')}
                                        className={`p-4 rounded-xl border-2 text-left transition-all ${recipientType === 'group'
                                            ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/30 shadow-md'
                                            : 'border-slate-200 dark:border-neutral-700 hover:border-slate-300 dark:hover:bg-neutral-800'
                                            }`}
                                    >
                                        <Users size={24} className={recipientType === 'group' ? 'text-primary-600' : 'text-slate-400'} />
                                        <span className={`block mt-2 font-semibold ${recipientType === 'group' ? 'text-primary-700 dark:text-primary-400' : 'text-slate-700 dark:text-neutral-300'}`}>
                                            Group/Role
                                        </span>
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">Notify entire team</p>
                                    </button>
                                </div>
                            </div>

                            {/* User Search */}
                            <div className="relative">
                                <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                <input
                                    type="text"
                                    placeholder="Search users by name or email..."
                                    value={userSearch}
                                    onChange={(e) => setUserSearch(e.target.value)}
                                    className="w-full pl-9 pr-4 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                                />
                            </div>

                            {/* Selected Recipients Pills */}
                            {selectedRecipients.length > 0 && (
                                <div className="flex flex-wrap gap-2">
                                    {selectedRecipients.map(r => (
                                        <span
                                            key={r.id}
                                            className="inline-flex items-center gap-1 px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm"
                                        >
                                            {r.username || r.email}
                                            <button
                                                type="button"
                                                onClick={() => toggleRecipient(r)}
                                                className="hover:bg-primary-200 rounded-full p-0.5"
                                            >
                                                <X size={14} />
                                            </button>
                                        </span>
                                    ))}
                                </div>
                            )}

                            {/* Users List */}
                            <div className="border border-slate-200 dark:border-neutral-700 rounded-lg max-h-48 overflow-y-auto bg-white dark:bg-neutral-800">
                                {isLoadingUsers ? (
                                    <div className="p-4 text-center text-slate-400 dark:text-neutral-500">
                                        <Loader2 size={20} className="animate-spin mx-auto" />
                                    </div>
                                ) : filteredUsers.length === 0 ? (
                                    <div className="p-4 text-center text-slate-400 dark:text-neutral-500 text-sm">
                                        No users found
                                    </div>
                                ) : (
                                    filteredUsers.map(u => {
                                        const isSelected = selectedRecipients.find(r => r.id === u.id);
                                        return (
                                            <button
                                                key={u.id}
                                                type="button"
                                                onClick={() => toggleRecipient(u)}
                                                className={`w-full text-left p-3 border-b border-slate-100 dark:border-neutral-700 last:border-b-0 hover:bg-slate-50 dark:hover:bg-neutral-700 transition-colors flex items-center gap-3 ${isSelected ? 'bg-primary-50 dark:bg-primary-900/30' : ''
                                                    }`}
                                            >
                                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white font-semibold">
                                                    {(u.first_name?.[0] || u.username?.[0] || '?').toUpperCase()}
                                                </div>
                                                <div className="flex-1">
                                                    <p className="font-medium text-sm text-slate-800 dark:text-white">
                                                        {u.first_name && u.last_name ? `${u.first_name} ${u.last_name}` : u.username}
                                                    </p>
                                                    <p className="text-xs text-slate-500 dark:text-neutral-400">{getRoleLabel(u.role)}</p>
                                                </div>
                                                {isSelected && (
                                                    <Check size={18} className="text-primary-600" />
                                                )}
                                            </button>
                                        );
                                    })
                                )}
                            </div>

                            <div className="pt-4 flex justify-between">
                                <Button variant="outline" onClick={() => setStep(1)}>
                                    Back
                                </Button>
                                <Button onClick={() => setStep(3)}>
                                    Next: Add Details
                                </Button>
                            </div>
                        </div>
                    )}

                    {/* Step 3: Subject & Message */}
                    {step === 3 && (
                        <form onSubmit={handleSubmit} className="p-4 space-y-4">
                            {/* Thread Type */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-2">
                                    Conversation Type
                                </label>
                                <div className="flex flex-wrap gap-2">
                                    {threadTypeOptions.map(opt => {
                                        const Icon = opt.icon;
                                        return (
                                            <button
                                                key={opt.value}
                                                type="button"
                                                onClick={() => setThreadType(opt.value)}
                                                className={`flex items-center gap-2 px-3 py-2 rounded-lg border transition-all text-sm ${threadType === opt.value
                                                    ? 'border-primary-500 bg-primary-50 text-primary-700'
                                                    : 'border-slate-200 text-slate-600 hover:border-slate-300'
                                                    }`}
                                            >
                                                <Icon size={16} />
                                                {opt.label}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Subject */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Subject <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    value={subject}
                                    onChange={(e) => setSubject(e.target.value)}
                                    placeholder="Brief description of the conversation"
                                    className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"
                                    required
                                />
                            </div>

                            {/* Initial Message */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Message
                                </label>
                                <textarea
                                    value={initialMessage}
                                    onChange={(e) => setInitialMessage(e.target.value)}
                                    placeholder="Start the conversation..."
                                    className="w-full px-4 py-3 border border-slate-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"
                                    rows={4}
                                />
                            </div>

                            {/* Summary */}
                            <div className="p-3 bg-slate-50 rounded-lg text-sm">
                                <p className="text-slate-600">
                                    <strong>Context:</strong> {contextName || contextId?.substring(0, 8)}
                                </p>
                                <p className="text-slate-600">
                                    <strong>Recipients:</strong> {selectedRecipients.length > 0
                                        ? selectedRecipients.map(r => r.username || r.email).join(', ')
                                        : 'All participants will be notified'}
                                </p>
                            </div>

                            {/* Actions */}
                            <div className="flex justify-between pt-2">
                                <Button type="button" variant="outline" onClick={() => setStep(2)}>
                                    Back
                                </Button>
                                <Button type="submit" disabled={isSubmitting}>
                                    {isSubmitting ? (
                                        <>
                                            <Loader2 size={16} className="animate-spin mr-2" />
                                            Creating...
                                        </>
                                    ) : (
                                        'Start Conversation'
                                    )}
                                </Button>
                            </div>
                        </form>
                    )}
                </motion.div>
            </div>
        </AnimatePresence>,
        document.body
    );
};

export default NewThreadModal;



================================================
FILE: frontend/src/components/communications/NotificationDropdown.jsx
================================================
/**
 * NotificationDropdown - Header notification bell with dropdown
 * Displays unread count and recent notifications
 */
import { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '@/contexts/AuthContext';
import client from '@/api/client';
import {
    Bell, X, Check, MessageSquare, AlertTriangle,
    Gavel, Clock, ChevronRight, UserCheck, Users, Settings
} from 'lucide-react';
import NotificationPreferencesModal from '@/components/ui/NotificationPreferencesModal';

const NotificationDropdown = () => {
    const navigate = useNavigate();
    const { hasPermission } = useAuth();
    const [isOpen, setIsOpen] = useState(false);
    const [notifications, setNotifications] = useState([]);
    const [unreadCount, setUnreadCount] = useState(0);
    const [pendingApprovals, setPendingApprovals] = useState(0);
    const [isLoading, setIsLoading] = useState(false);
    const [showPreferences, setShowPreferences] = useState(false);
    const dropdownRef = useRef(null);

    const isAdmin = hasPermission('users:manage');

    // Fetch notifications
    useEffect(() => {
        fetchNotifications();
        if (isAdmin) {
            fetchPendingApprovals();
        }
        const interval = setInterval(() => {
            fetchUnreadCount();
            if (isAdmin) fetchPendingApprovals();
        }, 30000); // Poll every 30s
        return () => clearInterval(interval);
    }, [isAdmin]);

    // Close on outside click
    useEffect(() => {
        const handleClickOutside = (e) => {
            if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
                setIsOpen(false);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const fetchNotifications = async () => {
        setIsLoading(true);
        try {
            const res = await client.get('/communications/notifications/');
            const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setNotifications(data.slice(0, 10)); // Show latest 10
            setUnreadCount(data.filter(n => !n.is_read).length);
        } catch (error) {
            console.error('Failed to fetch notifications:', error);
        } finally {
            setIsLoading(false);
        }
    };

    const fetchPendingApprovals = async () => {
        try {
            const res = await client.get('/users/pending/');
            const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setPendingApprovals(data.length);
        } catch (error) {
            console.error('Failed to fetch pending approvals:', error);
        }
    };

    const fetchUnreadCount = async () => {
        try {
            const res = await client.get('/communications/notifications/unread_count/');
            setUnreadCount(res.data.unread_count || 0);
        } catch (error) {
            console.error('Failed to fetch unread count:', error);
        }
    };

    const markAsRead = async (notificationId) => {
        try {
            await client.patch(`/communications/notifications/${notificationId}/mark_read/`);
            setNotifications(prev => prev.map(n =>
                n.id === notificationId ? { ...n, is_read: true } : n
            ));
            setUnreadCount(prev => Math.max(0, prev - 1));
        } catch (error) {
            console.error('Failed to mark as read:', error);
        }
    };

    const markAllAsRead = async () => {
        try {
            await client.post('/communications/notifications/mark_all_read/');
            setNotifications(prev => prev.map(n => ({ ...n, is_read: true })));
            setUnreadCount(0);
        } catch (error) {
            console.error('Failed to mark all as read:', error);
        }
    };

    const handleNotificationClick = (notification) => {
        if (!notification.is_read) {
            markAsRead(notification.id);
        }
        if (notification.deep_link) {
            navigate(notification.deep_link);
            setIsOpen(false);
        }
    };

    const getNotificationIcon = (type) => {
        switch (type) {
            case 'NEW_MESSAGE':
                return <MessageSquare className="text-blue-500" size={16} />;
            case 'CLARIFICATION_REQUESTED':
            case 'CLARIFICATION_RESPONDED':
                return <AlertTriangle className="text-amber-500" size={16} />;
            case 'RULING_ISSUED':
                return <Gavel className="text-red-500" size={16} />;
            case 'ESCALATION':
            case 'DEADLINE_BREACH':
                return <Clock className="text-red-500" size={16} />;
            case 'PENDING_APPROVAL':
                return <UserCheck className="text-amber-500" size={16} />;
            default:
                return <Bell className="text-slate-400" size={16} />;
        }
    };

    const formatTime = (dateStr) => {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        return `${diffDays}d ago`;
    };

    const totalBadgeCount = unreadCount + (isAdmin ? pendingApprovals : 0);

    return (
        <div className="relative" ref={dropdownRef}>
            {/* Bell Button */}
            <button
                onClick={() => setIsOpen(!isOpen)}
                className="relative p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
            >
                <Bell size={22} className="text-slate-600 dark:text-neutral-300" />
                {totalBadgeCount > 0 && (
                    <span className="absolute -top-1 -right-1 min-w-[18px] h-[18px] bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center px-1">
                        {totalBadgeCount > 99 ? '99+' : totalBadgeCount}
                    </span>
                )}
            </button>

            {/* Dropdown */}
            <AnimatePresence>
                {isOpen && (
                    <motion.div
                        initial={{ opacity: 0, y: 10, scale: 0.95 }}
                        animate={{ opacity: 1, y: 0, scale: 1 }}
                        exit={{ opacity: 0, y: 10, scale: 0.95 }}
                        className="absolute right-0 mt-2 w-80 bg-white dark:bg-neutral-900 rounded-xl shadow-2xl border border-slate-200 dark:border-neutral-700 overflow-hidden z-50"
                    >
                        {/* Header */}
                        <div className="flex justify-between items-center p-3 border-b border-slate-200 dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
                            <h3 className="font-semibold text-slate-800 dark:text-white">Notifications</h3>
                            {unreadCount > 0 && (
                                <button
                                    onClick={markAllAsRead}
                                    className="text-xs text-primary-600 hover:text-primary-700 font-medium"
                                >
                                    Mark all read
                                </button>
                            )}
                        </div>

                        {/* Pending Approvals Banner (Admin Only) */}
                        {isAdmin && pendingApprovals > 0 && (
                            <div
                                onClick={() => {
                                    navigate('/users');
                                    setIsOpen(false);
                                }}
                                className="p-3 bg-amber-50 border-b border-amber-200 cursor-pointer hover:bg-amber-100 transition-colors"
                            >
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                                        <Users className="text-amber-600" size={20} />
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-semibold text-amber-800">
                                            {pendingApprovals} Pending Approval{pendingApprovals > 1 ? 's' : ''}
                                        </p>
                                        <p className="text-xs text-amber-600">Contractor registrations await review</p>
                                    </div>
                                    <ChevronRight className="text-amber-400" size={18} />
                                </div>
                            </div>
                        )}

                        {/* Notifications List */}
                        <div className="max-h-[400px] overflow-y-auto">
                            {isLoading ? (
                                <div className="p-4 text-center text-slate-400 dark:text-neutral-500">Loading...</div>
                            ) : notifications.length === 0 && pendingApprovals === 0 ? (
                                <div className="p-8 text-center text-slate-400 dark:text-neutral-500">
                                    <Bell size={32} className="mx-auto mb-2 opacity-30" />
                                    <p className="text-sm">No notifications</p>
                                </div>
                            ) : (
                                notifications.map(notification => (
                                    <div
                                        key={notification.id}
                                        onClick={() => handleNotificationClick(notification)}
                                        className={`p-3 border-b border-slate-100 dark:border-neutral-800 cursor-pointer transition-colors hover:bg-slate-50 dark:hover:bg-neutral-800 ${!notification.is_read ? 'bg-primary-50/50 dark:bg-indigo-900/20' : ''
                                            }`}
                                    >
                                        <div className="flex gap-3">
                                            <div className="flex-shrink-0 mt-1">
                                                {getNotificationIcon(notification.notification_type)}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <p className={`text-sm ${!notification.is_read ? 'font-semibold text-slate-800 dark:text-white' : 'text-slate-600 dark:text-neutral-300'}`}>
                                                    {notification.title}
                                                </p>
                                                <p className="text-xs text-slate-500 dark:text-neutral-400 mt-0.5 line-clamp-2">
                                                    {notification.message}
                                                </p>
                                                <p className="text-[10px] text-slate-400 dark:text-neutral-500 mt-1">
                                                    {formatTime(notification.created_at)}
                                                </p>
                                            </div>
                                            {!notification.is_read && (
                                                <div className="w-2 h-2 bg-primary-500 rounded-full flex-shrink-0 mt-2"></div>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {/* Footer */}
                        <div className="p-2 border-t border-slate-200 dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => {
                                        setShowPreferences(true);
                                        setIsOpen(false);
                                    }}
                                    className="flex-1 text-center text-sm text-slate-600 dark:text-neutral-400 hover:text-slate-800 dark:hover:text-white font-medium py-2 hover:bg-slate-100 dark:hover:bg-neutral-700 rounded transition-colors flex items-center justify-center gap-1"
                                >
                                    <Settings size={14} />
                                    Preferences
                                </button>
                                <button
                                    onClick={() => {
                                        navigate('/communications');
                                        setIsOpen(false);
                                    }}
                                    className="flex-1 text-center text-sm text-primary-600 hover:text-primary-700 font-medium py-2 hover:bg-slate-100 dark:hover:bg-neutral-700 rounded transition-colors flex items-center justify-center gap-1"
                                >
                                    View All
                                    <ChevronRight size={14} />
                                </button>
                            </div>
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>

            {/* Preferences Modal */}
            <NotificationPreferencesModal
                isOpen={showPreferences}
                onClose={() => setShowPreferences(false)}
            />
        </div>
    );
};

export default NotificationDropdown;



================================================
FILE: frontend/src/components/communications/StartChatModal.jsx
================================================
/**
 * StartChatModal - Modal for creating direct messages and group chats
 */
import { useState, useEffect } from 'react';
import { X, Search, Users, MessageCircle } from 'lucide-react';
import { toast } from 'sonner';
import { motion, AnimatePresence } from 'framer-motion';
import client from '@/api/client';
import Button from '@/components/ui/Button';

const StartChatModal = ({ onClose, onCreated }) => {
    const [activeTab, setActiveTab] = useState('dm'); // 'dm' or 'group'
    const [users, setUsers] = useState([]);
    const [searchQuery, setSearchQuery] = useState('');
    const [selectedUsers, setSelectedUsers] = useState([]);
    const [groupName, setGroupName] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [isLoadingUsers, setIsLoadingUsers] = useState(true);

    useEffect(() => {
        fetchUsers();
    }, []);

    const fetchUsers = async () => {
        setIsLoadingUsers(true);
        try {
            const res = await client.get('/users/');
            const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setUsers(data);
        } catch (error) {
            console.error('Failed to fetch users:', error);
            toast.error('Failed to load users');
        } finally {
            setIsLoadingUsers(false);
        }
    };

    const filteredUsers = users.filter(user =>
        user.username?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        user.email?.toLowerCase().includes(searchQuery.toLowerCase())
    );

    const toggleUserSelection = (user) => {
        if (activeTab === 'dm') {
            // For DM, check if already selected - if so, deselect; otherwise select
            if (selectedUsers.find(u => u.id === user.id)) {
                setSelectedUsers([]);
            } else {
                setSelectedUsers([user]);
            }
        } else {
            // For group, toggle selection
            if (selectedUsers.find(u => u.id === user.id)) {
                setSelectedUsers(selectedUsers.filter(u => u.id !== user.id));
            } else {
                setSelectedUsers([...selectedUsers, user]);
            }
        }
    };

    const handleStartChat = async () => {
        if (selectedUsers.length === 0) {
            toast.error('Please select at least one user');
            return;
        }

        setIsLoading(true);
        try {
            let response;

            if (activeTab === 'dm' && selectedUsers.length === 1) {
                // Start DM
                response = await client.post('/communications/threads/start_dm/', {
                    recipient_id: selectedUsers[0].id
                });
                toast.success(`Started chat with ${selectedUsers[0].username}`);
            } else {
                // Start group chat (2+ users)
                response = await client.post('/communications/threads/start_group_chat/', {
                    participant_ids: selectedUsers.map(u => u.id),
                    chat_name: groupName || undefined
                });
                toast.success('Group chat created');
            }

            if (onCreated) {
                onCreated(response.data);
            }
            onClose();
        } catch (error) {
            console.error('Failed to start chat:', error);
            toast.error(error.response?.data?.error || 'Failed to start chat');
        } finally {
            setIsLoading(false);
        }
    };

    const getRoleBadgeColor = (role) => {
        const colors = {
            'SPV_Official': 'bg-purple-100 text-purple-700',
            'PMNC_Team': 'bg-blue-100 text-blue-700',
            'Govt_Department': 'bg-green-100 text-green-700',
            'EPC_Contractor': 'bg-orange-100 text-orange-700',
            'Consultant_Design': 'bg-cyan-100 text-cyan-700',
        };
        return colors[role] || 'bg-slate-100 text-slate-700';
    };

    return (
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                transition={{ duration: 0.2 }}
                className="fixed inset-0 bg-black/50 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center z-[9999]"
                onClick={onClose}
            >
                <motion.div
                    initial={{ scale: 0.95, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    exit={{ scale: 0.95, opacity: 0 }}
                    transition={{ duration: 0.2 }}
                    onClick={(e) => e.stopPropagation()}
                    className="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden"
                >
                    {/* Header */}
                    <div className="flex items-center justify-between p-6 border-b dark:border-neutral-700">
                        <h2 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                            <MessageCircle className="text-primary-600" size={28} />
                            Chat with Team
                        </h2>
                        <button
                            onClick={onClose}
                            className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                        >
                            <X size={20} className="dark:text-neutral-400" />
                        </button>
                    </div>

                    {/* Tabs */}
                    <div className="flex border-b dark:border-neutral-700">
                        <button
                            onClick={() => {
                                setActiveTab('dm');
                                setSelectedUsers([]);
                                setGroupName('');
                            }}
                            className={`flex-1 py-3 px-4 font-semibold flex items-center justify-center gap-2 transition-colors ${activeTab === 'dm'
                                ? 'border-b-2 border-primary-600 text-primary-600'
                                : 'text-slate-500 dark:text-neutral-400 hover:bg-slate-50 dark:hover:bg-neutral-800'
                                }`}
                        >
                            <MessageCircle size={18} />
                            Direct Message
                        </button>
                        <button
                            onClick={() => {
                                setActiveTab('group');
                                setSelectedUsers([]);
                            }}
                            className={`flex-1 py-3 px-4 font-semibold flex items-center justify-center gap-2 transition-colors ${activeTab === 'group'
                                ? 'border-b-2 border-primary-600 text-primary-600'
                                : 'text-slate-500 dark:text-neutral-400 hover:bg-slate-50 dark:hover:bg-neutral-800'
                                }`}
                        >
                            <Users size={18} />
                            Group Chat
                        </button>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto p-6">
                        {/* Search */}
                        <div className="relative mb-4">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                            <input
                                type="text"
                                placeholder="Search users..."
                                className="w-full pl-10 pr-4 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        </div>

                        {/* Group Name Input (for group chats) */}
                        {activeTab === 'group' && (
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-2">
                                    Group Name (Optional)
                                </label>
                                <input
                                    type="text"
                                    placeholder="Enter group name..."
                                    className="w-full px-4 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    value={groupName}
                                    onChange={(e) => setGroupName(e.target.value)}
                                />
                            </div>
                        )}

                        {/* Selected Users Badge */}
                        {selectedUsers.length > 0 && (
                            <div className="mb-4 p-3 bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-lg">
                                <div className="text-sm font-medium text-primary-900 dark:text-primary-300 mb-2">
                                    {activeTab === 'dm' ? 'Selected User:' : `Selected (${selectedUsers.length}):`}
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {selectedUsers.map(user => (
                                        <span
                                            key={user.id}
                                            className="inline-flex items-center gap-2 px-3 py-1 bg-white dark:bg-neutral-900 border border-primary-300 dark:border-primary-700 rounded-full text-sm dark:text-white"
                                        >
                                            {user.username}
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    toggleUserSelection(user);
                                                }}
                                                className="hover:bg-red-100 rounded-full p-0.5 transition-colors"
                                            >
                                                <X size={14} />
                                            </button>
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* User List */}
                        {isLoadingUsers ? (
                            <div className="text-center py-8 text-slate-500 dark:text-neutral-400">
                                Loading users...
                            </div>
                        ) : filteredUsers.length === 0 ? (
                            <div className="text-center py-8 text-slate-500 dark:text-neutral-400">
                                No users found
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {filteredUsers.map((user) => {
                                    const isSelected = selectedUsers.find(u => u.id === user.id);
                                    return (
                                        <button
                                            key={user.id}
                                            onClick={() => toggleUserSelection(user)}
                                            className={`w-full flex items-center justify-between p-3 rounded-lg border transition-all ${isSelected
                                                ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20'
                                                : 'border-slate-200 dark:border-neutral-700 hover:border-primary-300 hover:bg-slate-50 dark:hover:bg-neutral-800'
                                                }`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${isSelected ? 'bg-primary-600' : 'bg-slate-400'
                                                    }`}>
                                                    {user.username?.charAt(0).toUpperCase()}
                                                </div>
                                                <div className="text-left">
                                                    <div className="font-medium text-slate-900 dark:text-white">{user.username}</div>
                                                    <div className="text-xs text-slate-500 dark:text-neutral-400">{user.email}</div>
                                                </div>
                                            </div>
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${getRoleBadgeColor(user.role)}`}>
                                                {user.role?.replace(/_/g, ' ')}
                                            </span>
                                        </button>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div className="flex items-center justify-between p-6 border-t dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
                        <div className="text-sm text-slate-600 dark:text-neutral-400">
                            {activeTab === 'dm' ? (
                                <span>Select a user to start a direct message</span>
                            ) : (
                                <span>Select 2 or more users for a group chat</span>
                            )}
                        </div>
                        <div className="flex gap-3">
                            <Button variant="outline" onClick={onClose}>
                                Cancel
                            </Button>
                            <Button
                                onClick={handleStartChat}
                                disabled={isLoading || selectedUsers.length === 0 || (activeTab === 'group' && selectedUsers.length < 1)}
                            >
                                {isLoading ? 'Creating...' : activeTab === 'dm' ? 'Start Chat' : 'Create Group'}
                            </Button>
                        </div>
                    </div>
                </motion.div>
            </motion.div>
        </AnimatePresence>
    );
};

export default StartChatModal;



================================================
FILE: frontend/src/components/communications/ThreadDetail.jsx
================================================
/**
 * ThreadDetail Component - Displays full conversation thread with message composer
 * Immutable message display, role-based message types
 */
import { useState, useRef, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useAuth } from '@/contexts/AuthContext';
import client from '@/api/client';
import { toast } from 'sonner';
import {
    CheckCircle, ChevronDown, CornerDownRight, FolderOpen, FileText, Download,
    User, Send, Clock, Gavel, Lock, AlertTriangle, X, File,
    Pin, BellOff, Bell, UserPlus, LogOut, MoreVertical, Paperclip, MessageSquare, Users
} from 'lucide-react';
import Button from '@/components/ui/Button';
import AddParticipantsModal from './AddParticipantsModal';

const ThreadDetail = ({ thread, onMessageSent, onClose }) => {
    const { user } = useAuth();
    const [messageContent, setMessageContent] = useState('');

    const [isSending, setIsSending] = useState(false);
    const [showActionsMenu, setShowActionsMenu] = useState(false);
    const [isPinned, setIsPinned] = useState(thread?.is_pinned || false);
    const [isMuted, setIsMuted] = useState(thread?.is_muted || false);
    const [showAddParticipants, setShowAddParticipants] = useState(false);
    const [showParticipants, setShowParticipants] = useState(false);
    const [attachedFiles, setAttachedFiles] = useState([]);
    const [isUploading, setIsUploading] = useState(false);
    const messagesEndRef = useRef(null);
    const fileInputRef = useRef(null);

    // Format file size
    const formatFileSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    };

    /**
     * Get display name for thread - shows OTHER participant for DMs
     * This ensures each user sees the other person's name, not their own
     */
    const getDisplayName = () => {
        if (!thread) return 'Chat';
        // For Direct Messages, show the OTHER person's name
        if (thread.thread_type === 'DIRECT_MESSAGE' && thread.participants) {
            const otherParticipant = thread.participants.find(p => p.id !== user?.id);
            if (otherParticipant) {
                return otherParticipant.full_name || otherParticipant.username || 'User';
            }
        }
        // For all other types, show the subject
        return thread.subject || 'Thread';
    };

    // Auto-scroll to bottom
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [thread?.messages]);

    // Auto-mark messages as read when viewing thread
    useEffect(() => {
        const markMessagesAsRead = async () => {
            if (!thread?.id) return;

            try {
                // Bulk mark all messages in thread as read
                await client.post(`/communications/threads/${thread.id}/mark_read/`);
            } catch (error) {
                // Silent fail - not critical
                console.log('Could not mark thread as read:', error);
            }
        };

        markMessagesAsRead();
    }, [thread?.id, thread?.messages?.length]); // Run when thread changes or new messages arrive

    // Permission checks
    const canSendMessage = ['SPV_Official', 'PMNC_Team', 'Nodal_Officer', 'EPC_Contractor', 'Consultant', 'Govt_Official'].includes(user?.role);
    const canIssueRuling = user?.role === 'SPV_Official';
    const canRequestClarification = ['SPV_Official', 'PMNC_Team', 'Nodal_Officer', 'Govt_Official'].includes(user?.role);
    const canCloseThread = ['SPV_Official', 'PMNC_Team', 'Nodal_Officer'].includes(user?.role);

    // File handling - supports multiple files
    const handleFileSelect = (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            setAttachedFiles(prev => [...prev, ...files]);
        }
        // Reset input so same file can be selected again
        if (fileInputRef.current) {
            fileInputRef.current.value = '';
        }
    };

    const handleRemoveFile = (index) => {
        setAttachedFiles(prev => prev.filter((_, i) => i !== index));
    };

    const handleClearAllFiles = () => {
        setAttachedFiles([]);
    };

    const handleSendMessage = async () => {
        if (!messageContent.trim() && attachedFiles.length === 0) return;

        setIsSending(true);
        try {
            let attachmentIds = [];

            // Upload all files first
            if (attachedFiles.length > 0) {
                setIsUploading(true);

                // Upload each file and collect IDs
                for (const file of attachedFiles) {
                    const formData = new FormData();
                    formData.append('file', file);

                    const uploadRes = await client.post('/communications/attachments/upload/', formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });
                    attachmentIds.push(uploadRes.data.id);
                }
                setIsUploading(false);
            }

            // Send message
            const payload = {
                content: messageContent || `ğŸ“ ${attachedFiles.length} file(s) attached`,
                message_type: 'STANDARD'
            };

            if (attachmentIds.length > 0) {
                payload.attachment_ids = attachmentIds;
            }

            await client.post(`/communications/threads/${thread.id}/send_message/`, payload);

            setMessageContent('');
            setAttachedFiles([]);
            onMessageSent();
            toast.success('Message sent');
        } catch (error) {
            console.error('Failed to send message:', error);
            toast.error(error.response?.data?.error || 'Failed to send message');
        } finally {
            setIsSending(false);
            setIsUploading(false);
        }
    };

    const handleCloseThread = async () => {
        try {
            await client.post(`/communications/threads/${thread.id}/close/`);
            toast.success('Thread closed');
            onMessageSent(); // Refresh
        } catch (error) {
            console.error('Failed to close thread:', error);
            toast.error(error.response?.data?.error || 'Failed to close thread');
        }
    };

    const handlePin = async () => {
        try {
            await client.post(`/communications/threads/${thread.id}/pin/`);
            setIsPinned(!isPinned);
            toast.success(isPinned ? 'Thread unpinned' : 'Thread pinned');
            onMessageSent(); // Refresh list
        } catch (error) {
            console.error('Failed to toggle pin:', error);
            toast.error('Failed to pin/unpin thread');
        }
    };

    const handleMute = async (duration = null) => {
        try {
            if (isMuted) {
                await client.post(`/communications/threads/${thread.id}/unmute/`);
                setIsMuted(false);
                toast.success('Thread unmuted');
            } else {
                const res = await client.post(`/communications/threads/${thread.id}/mute/`, { duration });
                setIsMuted(true);
                toast.success(res.data.message);
            }
            onMessageSent(); // Refresh
        } catch (error) {
            console.error('Failed to toggle mute:', error);
            toast.error('Failed to mute/unmute thread');
        }
    };

    const handleLeaveGroup = async () => {
        if (!confirm('Are you sure you want to leave this group?')) return;

        try {
            await client.post(`/communications/threads/${thread.id}/leave_group/`);
            toast.success('Left group successfully');
            onClose(); // Close detail view  
            onMessageSent(); // Refresh list
        } catch (error) {
            console.error('Failed to leave group:', error);
            toast.error(error.response?.data?.error || 'Failed to leave group');
        }
    };

    const getMessageStyles = (msg) => {
        // Use loose equality to handle potential string/number mismatches
        const isOwn = msg.sender == user?.id;
        let baseStyles = 'rounded-xl px-4 py-3 max-w-[75%] break-words';

        switch (msg.message_type) {
            case 'RULING':
                return `${baseStyles} bg-yellow-50 border-l-3 border-yellow-500 dark:bg-yellow-900/20 dark:border-yellow-600 dark:text-yellow-100`;
            case 'CLARIFICATION_REQUEST':
                return `${baseStyles} bg-blue-50 border-l-3 border-blue-500 dark:bg-blue-900/20 dark:border-blue-600 dark:text-blue-100`;
            case 'CLARIFICATION_RESPONSE':
                return `${baseStyles} bg-green-50 border-l-3 border-green-500 dark:bg-green-900/20 dark:border-green-600 dark:text-green-100`;
            case 'INTERNAL_NOTE':
                return `${baseStyles} bg-purple-50 border-l-3 border-purple-500 dark:bg-purple-900/20 dark:border-purple-600 dark:text-purple-100`;
            default:
                return isOwn
                    ? `${baseStyles} bg-primary-600 text-white ml-auto`
                    : `${baseStyles} bg-slate-100 text-slate-900 dark:bg-neutral-800 dark:text-slate-200`;
        }
    };

    const formatTimestamp = (timestamp) => {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleString();
    };



    if (!thread) return null;

    return (
        <div className="flex flex-col h-full bg-white dark:bg-neutral-900">
            {/* Header - Single row with glassmorphism effect */}
            <div className="px-3 py-3 border-b border-white/20 dark:border-white/10 bg-gradient-to-r from-slate-100/90 via-white/80 to-slate-100/90 dark:from-neutral-800/90 dark:via-neutral-900/80 dark:to-neutral-800/90 backdrop-blur-md shadow-sm sticky top-0 z-10">
                <div className="flex items-center gap-3">
                    {/* Title + Meta */}
                    <div className="min-w-0 flex-1">
                        <h2 className="text-base font-bold text-slate-800 dark:text-white truncate">{getDisplayName()}</h2>
                        <div className="flex items-center gap-3 mt-0.5 text-xs text-slate-500 dark:text-neutral-400">
                            <span className="flex items-center gap-1">
                                <User size={12} />
                                {thread.participant_count}
                            </span>
                            <span className="flex items-center gap-1">
                                <Clock size={12} />
                                {formatTimestamp(thread.created_at)}
                            </span>
                            <span className={`px-1.5 py-0.5 rounded text-xs font-medium ${thread.status === 'OPEN' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                                thread.status === 'PENDING_RESPONSE' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300' :
                                    thread.status === 'ESCALATED' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300' :
                                        'bg-gray-100 text-gray-700 dark:bg-neutral-700 dark:text-gray-300'
                                }`}>
                                {thread.status}
                            </span>
                        </div>
                    </div>

                    {/* Action Buttons - Inline */}
                    <div className="flex items-center gap-1 flex-shrink-0">
                        <button
                            onClick={() => setShowParticipants(true)}
                            className="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-neutral-700 text-slate-600 dark:text-neutral-300"
                            title="View Participants"
                        >
                            <Users size={16} />
                        </button>
                        <button
                            onClick={handlePin}
                            className={`p-1.5 rounded-lg ${isPinned ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400' : 'hover:bg-slate-100 dark:hover:bg-neutral-700 text-slate-600 dark:text-neutral-300'}`}
                            title={isPinned ? 'Unpin' : 'Pin'}
                        >
                            <Pin size={16} fill={isPinned ? 'currentColor' : 'none'} />
                        </button>
                        <button
                            onClick={() => handleMute()}
                            className={`p-1.5 rounded-lg ${isMuted ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400' : 'hover:bg-slate-100 dark:hover:bg-neutral-700 text-slate-600 dark:text-neutral-300'}`}
                            title={isMuted ? 'Unmute' : 'Mute'}
                        >
                            {isMuted ? <BellOff size={16} /> : <Bell size={16} />}
                        </button>

                        {/* More Actions (group chats) */}
                        {thread.thread_type === 'GROUP' && (
                            <div className="relative">
                                <button
                                    onClick={() => setShowActionsMenu(!showActionsMenu)}
                                    className="p-1.5 hover:bg-slate-100 dark:hover:bg-neutral-700 rounded-lg text-slate-600 dark:text-neutral-300"
                                >
                                    <MoreVertical size={16} />
                                </button>
                                <AnimatePresence>
                                    {showActionsMenu && (
                                        <motion.div
                                            initial={{ opacity: 0, scale: 0.95 }}
                                            animate={{ opacity: 1, scale: 1 }}
                                            exit={{ opacity: 0, scale: 0.95 }}
                                            className="absolute right-0 mt-2 w-48 bg-white dark:bg-neutral-800 border border-slate-200 dark:border-neutral-700 rounded-lg shadow-lg py-1 z-10"
                                        >
                                            <button
                                                onClick={() => {
                                                    setShowActionsMenu(false);
                                                    setShowAddParticipants(true);
                                                }}
                                                className="w-full flex items-center gap-2 px-4 py-2 text-sm text-slate-700 dark:text-neutral-300 hover:bg-slate-50 dark:hover:bg-neutral-700"
                                            >
                                                <UserPlus size={16} />
                                                Add Participants
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setShowActionsMenu(false);
                                                    handleLeaveGroup();
                                                }}
                                                className="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50"
                                            >
                                                <LogOut size={16} />
                                                Leave Group
                                            </button>
                                        </motion.div>
                                    )}
                                </AnimatePresence>
                            </div>
                        )}

                        {/* Close Thread */}
                        {thread.status !== 'CLOSED' && canCloseThread && (
                            <Button variant="outline" size="sm" onClick={handleCloseThread} className="text-xs px-2 py-1 h-7">
                                <CheckCircle size={12} className="mr-1" /> Close
                            </Button>
                        )}

                        {/* Close Panel */}
                        <button
                            onClick={onClose}
                            className="p-1.5 hover:bg-slate-200 dark:hover:bg-neutral-700 rounded-lg text-slate-600 dark:text-neutral-300 ml-1"
                            aria-label="Close"
                        >
                            <X size={18} />
                        </button>
                    </div>
                </div>
            </div>

            {/* Messages - Compact Layout */}
            <div className="flex-1 overflow-y-auto px-3 py-2 space-y-1.5">
                {thread.messages && thread.messages.length > 0 ? (
                    thread.messages.map((msg) => {
                        const isOwn = msg.sender === user?.id;

                        return (
                            <div
                                key={msg.id}
                                className={`flex ${isOwn ? 'justify-end' : 'justify-start'}`}
                            >
                                {/* Message Bubble */}
                                <div className={getMessageStyles(msg)}>
                                    {/* Sender + Role Row */}
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className={`text-sm font-semibold ${isOwn ? 'text-white/90' : 'text-slate-700 dark:text-slate-300'}`}>
                                            {msg.sender_name}
                                        </span>
                                        <span className={`text-xs px-1.5 py-0.5 rounded ${isOwn ? 'bg-white/20 text-white/80' : 'bg-slate-200/80 dark:bg-white/10 text-slate-500 dark:text-slate-400'}`}>
                                            {msg.sender_role?.replace('_', ' ')}
                                        </span>
                                    </div>

                                    {/* Content */}
                                    <p className={`text-base whitespace-pre-wrap leading-relaxed ${isOwn ? 'text-white' : ''}`}>{msg.content}</p>

                                    {/* Attachments */}
                                    {msg.attachments && msg.attachments.length > 0 && (
                                        <div className="mt-2 space-y-1">
                                            {msg.attachments.map((att) => (
                                                <button
                                                    key={att.id}
                                                    onClick={async (e) => {
                                                        e.preventDefault();
                                                        try {
                                                            // Download via authenticated API
                                                            const response = await client.get(
                                                                `/communications/attachments/${att.id}/download/`,
                                                                { responseType: 'blob' }
                                                            );
                                                            // Create blob URL and trigger download
                                                            const blob = new Blob([response.data], { type: att.content_type });
                                                            const url = window.URL.createObjectURL(blob);
                                                            const link = document.createElement('a');
                                                            link.href = url;
                                                            link.download = att.filename;
                                                            document.body.appendChild(link);
                                                            link.click();
                                                            document.body.removeChild(link);
                                                            window.URL.revokeObjectURL(url);
                                                        } catch (error) {
                                                            console.error('Download failed:', error);
                                                            toast.error('Failed to download file');
                                                        }
                                                    }}
                                                    className={`flex items-center gap-2 px-2 py-1.5 rounded-lg transition-colors cursor-pointer w-full text-left ${isOwn
                                                        ? 'bg-white/20 hover:bg-white/30 text-white'
                                                        : 'bg-slate-200 dark:bg-neutral-700 hover:bg-slate-300 dark:hover:bg-neutral-600 text-slate-700 dark:text-slate-200'
                                                        }`}
                                                >
                                                    <File size={14} />
                                                    <span className="text-sm flex-1 truncate">{att.filename}</span>
                                                    <span className="text-xs opacity-70">{formatFileSize(att.file_size)}</span>
                                                    <Download size={14} className="opacity-70" />
                                                </button>
                                            ))}
                                        </div>
                                    )}

                                    {/* Reference */}
                                    {msg.references_content && (
                                        <div className="mt-2 pl-3 border-l-2 border-slate-300 dark:border-slate-600 text-sm text-slate-600 dark:text-slate-300">
                                            <CornerDownRight size={14} className="inline mr-1" />
                                            {msg.references_content}
                                        </div>
                                    )}

                                    {/* Timestamp */}
                                    <div className={`text-xs mt-2 ${isOwn ? 'text-white/70' : 'text-slate-400'}`}>
                                        {formatTimestamp(msg.created_at)}
                                    </div>
                                </div>
                            </div>
                        );
                    })
                ) : (
                    <div className="flex flex-col items-center justify-center h-full text-slate-400 dark:text-neutral-500">
                        <MessageSquare size={40} className="mb-2 opacity-20" />
                        <p className="text-sm">No messages yet. Start the conversation!</p>
                    </div>
                )}
                <div ref={messagesEndRef} />
            </div>

            {/* Composer - Compact design for more message visibility */}
            {thread.status !== 'CLOSED' && canSendMessage && (
                <div className="border-t border-slate-200 dark:border-neutral-800 bg-white dark:bg-neutral-900">
                    {/* File Preview - Multiple files */}
                    {attachedFiles.length > 0 && (
                        <div className="px-3 pt-2 pb-1 space-y-1">
                            {attachedFiles.map((file, index) => (
                                <div key={index} className="flex items-center gap-2 bg-slate-100 dark:bg-neutral-800 rounded-lg px-2 py-1.5">
                                    <File size={14} className="text-slate-500 dark:text-neutral-400 flex-shrink-0" />
                                    <span className="text-xs text-slate-700 dark:text-neutral-300 flex-1 truncate">{file.name}</span>
                                    <span className="text-[10px] text-slate-500 dark:text-neutral-400 flex-shrink-0">{formatFileSize(file.size)}</span>
                                    <button
                                        onClick={() => handleRemoveFile(index)}
                                        className="p-0.5 hover:bg-slate-200 dark:hover:bg-neutral-700 rounded-full flex-shrink-0"
                                    >
                                        <X size={14} className="text-slate-500 dark:text-neutral-400" />
                                    </button>
                                </div>
                            ))}
                            {attachedFiles.length > 1 && (
                                <button
                                    onClick={handleClearAllFiles}
                                    className="text-xs text-red-500 hover:text-red-600 transition-colors"
                                >
                                    Clear all ({attachedFiles.length} files)
                                </button>
                            )}
                        </div>
                    )}

                    {/* Input Area - Compact */}
                    <div className="px-2 sm:px-3 py-1.5">
                        <div className="flex items-center gap-1">
                            {/* File Attachment Button */}
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                className="p-1.5 text-slate-500 dark:text-neutral-400 hover:text-slate-700 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-full transition-colors flex-shrink-0"
                                title="Attach files (multiple allowed)"
                            >
                                <Paperclip size={18} />
                            </button>
                            <input
                                ref={fileInputRef}
                                type="file"
                                onChange={handleFileSelect}
                                className="hidden"
                                accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.zip,.rar"
                                multiple
                            />

                            {/* Input */}
                            <input
                                type="text"
                                value={messageContent}
                                onChange={(e) => setMessageContent(e.target.value)}
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' && !e.shiftKey) {
                                        e.preventDefault();
                                        handleSendMessage();
                                    }
                                }}
                                placeholder="Type a message"
                                className="flex-1 min-w-0 px-3 py-1.5 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-full focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"
                            />

                            {/* Send Button */}
                            <button
                                onClick={handleSendMessage}
                                disabled={(!messageContent.trim() && attachedFiles.length === 0) || isSending || isUploading}
                                className="p-1.5 bg-primary-600 text-white rounded-full hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex-shrink-0"
                            >
                                {isUploading ? (
                                    <div className="w-[16px] h-[16px] border-2 border-white border-t-transparent rounded-full animate-spin" />
                                ) : (
                                    <Send size={16} />
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Closed Thread Notice */}
            {thread.status === 'CLOSED' && (
                <div className="p-4 bg-slate-100 dark:bg-neutral-800 border-t border-slate-200 dark:border-neutral-700 text-center text-sm text-slate-500 dark:text-neutral-400">
                    <CheckCircle className="inline-block mr-2 text-green-500" size={16} />
                    This thread was closed on {formatTimestamp(thread.closed_at)}
                </div>
            )}

            {/* Add Participants Modal */}
            {showAddParticipants && (
                <AddParticipantsModal
                    thread={thread}
                    onClose={() => setShowAddParticipants(false)}
                    onAdded={(updatedThread) => {
                        setShowAddParticipants(false);
                        onMessageSent();
                    }}
                />
            )}
            {/* Participants Modal */}
            <AnimatePresence>
                {showParticipants && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[60]"
                        onClick={() => setShowParticipants(false)}
                    >
                        <motion.div
                            initial={{ scale: 0.95, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            exit={{ scale: 0.95, opacity: 0 }}
                            onClick={(e) => e.stopPropagation()}
                            className="bg-white dark:bg-neutral-900 rounded-xl shadow-xl w-full max-w-sm max-h-[70vh] flex flex-col overflow-hidden border dark:border-neutral-700"
                        >
                            <div className="flex items-center justify-between p-4 border-b dark:border-neutral-700">
                                <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <Users size={18} className="text-primary-600" />
                                    Participants ({thread.participants?.length || 0})
                                </h3>
                                <button
                                    onClick={() => setShowParticipants(false)}
                                    className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-full transition-colors text-slate-600 dark:text-neutral-300"
                                >
                                    <X size={18} />
                                </button>
                            </div>
                            <div className="overflow-y-auto p-4 space-y-3">
                                {thread.participants?.map((p) => (
                                    <div key={p.id} className="flex items-center gap-3 p-2 hover:bg-slate-50 dark:hover:bg-neutral-800 rounded-lg">
                                        <div className="w-8 h-8 rounded-full bg-slate-200 dark:bg-neutral-700 flex items-center justify-center text-xs font-bold text-slate-600 dark:text-neutral-300">
                                            {p.username.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <div className="text-sm font-medium text-slate-900 dark:text-white">{p.full_name}</div>
                                            <div className="text-xs text-slate-500 dark:text-neutral-400 capitalize">{p.role?.replace(/_/g, ' ')}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>

        </div >
    );
};

export default ThreadDetail;



================================================
FILE: frontend/src/components/communications/ThreadList.jsx
================================================
/**
 * ThreadList Component - Displays list of communication threads
 * Formal, government-style list with status indicators
 * 
 * OPTIMIZED: Readable design with balanced proportions
 */
import {
    MessageSquare, AlertTriangle, CheckCircle,
    Lock, Gavel, MessageCircle, Users,
    Pin, BellOff
} from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';

const ThreadList = ({ threads, selectedThread, onSelect, isLoading }) => {
    const { user } = useAuth();

    /**
     * Get display name for thread - shows OTHER participant for DMs
     * This ensures Kedar sees "Sahil" and Sahil sees "Kedar"
     */
    const getDisplayName = (thread) => {
        // For Direct Messages, show the OTHER person's name
        if (thread.thread_type === 'DIRECT_MESSAGE' && thread.participants) {
            const otherParticipant = thread.participants.find(p => p.id !== user?.id);
            if (otherParticipant) {
                return otherParticipant.full_name || otherParticipant.username || 'User';
            }
        }
        // For all other types, show the subject
        return thread.subject || 'Untitled Thread';
    };

    const getTypeIcon = (type) => {
        const iconClass = "flex-shrink-0";
        switch (type) {
            case 'DIRECT_MESSAGE':
                return <MessageCircle size={16} className={`${iconClass} text-indigo-500`} />;
            case 'GROUP_CHAT':
                return <Users size={16} className={`${iconClass} text-purple-500`} />;
            case 'INTERNAL_NOTE':
                return <Lock size={16} className={`${iconClass} text-slate-500 dark:text-neutral-400`} />;
            case 'RULING':
                return <Gavel size={16} className={`${iconClass} text-red-500`} />;
            case 'CLARIFICATION':
                return <AlertTriangle size={16} className={`${iconClass} text-amber-500`} />;
            default:
                return <MessageSquare size={16} className={`${iconClass} text-blue-500`} />;
        }
    };

    const getTypeBorderColor = (type) => {
        switch (type) {
            case 'DIRECT_MESSAGE': return 'border-l-indigo-500';
            case 'GROUP_CHAT': return 'border-l-purple-500';
            case 'CLARIFICATION': return 'border-l-amber-500';
            case 'INTERNAL_NOTE': return 'border-l-slate-400 dark:border-l-neutral-500';
            case 'RULING': return 'border-l-red-500';
            default: return 'border-l-blue-500';
        }
    };

    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

        if (messageDate.getTime() === today.getTime()) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        } else if (messageDate.getTime() === yesterday.getTime()) {
            return 'Yesterday';
        } else {
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }
    };

    if (isLoading) {
        return (
            <div className="p-3 space-y-2">
                {[1, 2, 3, 4, 5, 6].map(i => (
                    <div key={i} className="animate-pulse">
                        <div className="h-16 bg-slate-200 dark:bg-neutral-700 rounded-lg"></div>
                    </div>
                ))}
            </div>
        );
    }

    if (threads.length === 0) {
        return (
            <div className="p-6 text-center text-slate-400 dark:text-neutral-500">
                <MessageSquare size={40} className="mx-auto mb-3 opacity-30" />
                <p className="text-base font-medium">No threads found</p>
                <p className="text-sm mt-1">Create a new thread to start</p>
            </div>
        );
    }

    return (
        <div className="divide-y divide-slate-100 dark:divide-neutral-800">
            {threads.map((thread) => (
                <div
                    key={thread.id}
                    onClick={() => onSelect(thread)}
                    className={`
                        px-3 py-3 cursor-pointer transition-colors duration-100
                        hover:bg-slate-50 dark:hover:bg-neutral-800/50
                        ${selectedThread?.id === thread.id
                            ? 'bg-primary-50 dark:bg-primary-900/20 border-l-3 border-l-primary-500'
                            : `bg-app-card border-l-3 ${getTypeBorderColor(thread.thread_type)}`
                        }
                    `}
                >
                    <div className="flex items-start gap-3">
                        {/* Avatar/Icon */}
                        <div className={`
                            w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0
                            ${thread.thread_type === 'GROUP_CHAT' ? 'bg-purple-100 dark:bg-purple-900/30' :
                                thread.thread_type === 'DIRECT_MESSAGE' ? 'bg-indigo-100 dark:bg-indigo-900/30' :
                                    thread.thread_type === 'INTERNAL_NOTE' ? 'bg-slate-100 dark:bg-neutral-700' :
                                        'bg-blue-100 dark:bg-blue-900/30'}
                        `}>
                            {getTypeIcon(thread.thread_type)}
                        </div>

                        {/* Content */}
                        <div className="flex-1 min-w-0 overflow-hidden">
                            {/* Row 1: Subject + Time */}
                            <div className="flex items-center justify-between gap-2">
                                <h3 className={`text-sm font-semibold truncate flex-1 ${selectedThread?.id === thread.id
                                    ? 'text-primary-700 dark:text-primary-400'
                                    : 'text-slate-800 dark:text-white'
                                    }`}>
                                    {getDisplayName(thread)}
                                </h3>
                                <div className="flex items-center gap-2 flex-shrink-0">
                                    {thread.unread_count > 0 && (
                                        <span className="min-w-[20px] h-5 px-1.5 bg-primary-500 text-white text-xs font-bold rounded-full flex items-center justify-center">
                                            {thread.unread_count > 99 ? '99+' : thread.unread_count}
                                        </span>
                                    )}
                                    <span className="text-xs text-slate-400 dark:text-neutral-500">
                                        {formatDate(thread.updated_at)}
                                    </span>
                                </div>
                            </div>

                            {/* Row 2: Preview */}
                            <div className="flex items-center gap-2 mt-1">
                                <div className="flex-1 min-w-0 overflow-hidden">
                                    {thread.last_message_preview ? (
                                        <p className="text-sm text-slate-500 dark:text-neutral-400 truncate">
                                            <span className="font-medium text-slate-600 dark:text-neutral-300">
                                                {thread.last_message_preview.sender}:
                                            </span>{' '}
                                            {thread.last_message_preview.content}
                                        </p>
                                    ) : (
                                        <p className="text-sm italic text-slate-400 dark:text-neutral-500">No messages yet</p>
                                    )}
                                </div>

                                {/* Status Icons */}
                                <div className="flex items-center gap-1 flex-shrink-0">
                                    {thread.is_pinned && <Pin size={12} fill="currentColor" className="text-blue-500" />}
                                    {thread.is_muted && <BellOff size={12} className="text-amber-500" />}
                                    {thread.status === 'ESCALATED' && <AlertTriangle size={12} className="text-red-500" />}
                                    {thread.status === 'CLOSED' && <CheckCircle size={12} className="text-green-500" />}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            ))}
        </div>
    );
};

export default ThreadList;



================================================
FILE: frontend/src/components/contractor/IFSCInput.jsx
================================================
/**
 * IFSC Input Component
 * Validates IFSC code and auto-fills bank branch details
 * Uses self-hosted IFSC database - NO external APIs
 * 
 * Features:
 * - Only shows errors AFTER user has interacted (touched) the field
 * - Validates format and looks up in database on blur
 * - Auto-fills bank and branch name on successful lookup
 * - Full dark mode support
 */
import { useState, useEffect } from 'react';
import { fetchIFSCDetails, isValidIFSCFormat } from '@/services/ifscService';
import { Loader2, CheckCircle, AlertCircle, Search } from 'lucide-react';
import { toast } from 'sonner';

const IFSCInput = ({
    value,
    onChange,
    onBranchDataFetched,
    disabled = false,
    error = '',
}) => {
    const [loading, setLoading] = useState(false);
    const [validated, setValidated] = useState(false);
    const [validationError, setValidationError] = useState('');
    const [touched, setTouched] = useState(false); // Track if user has interacted

    // Reset states when value is cleared externally
    useEffect(() => {
        if (!value) {
            setValidated(false);
            setValidationError('');
            setTouched(false);
        }
    }, [value]);

    const validateIFSC = async () => {
        setTouched(true); // Mark as touched on blur

        // Skip validation if empty (let form-level validation handle required)
        if (!value) {
            setValidated(false);
            setValidationError('');
            return;
        }

        // Skip if not complete (11 chars)
        if (value.length !== 11) {
            setValidationError('IFSC code must be 11 characters');
            setValidated(false);
            return;
        }

        // Check format first
        if (!isValidIFSCFormat(value)) {
            setValidationError('Invalid IFSC format (e.g., SBIN0001234)');
            setValidated(false);
            return;
        }

        setLoading(true);
        setValidationError('');

        try {
            const branchData = await fetchIFSCDetails(value);
            setValidated(true);
            setValidationError('');

            // Call parent callback with branch data
            if (onBranchDataFetched) {
                onBranchDataFetched(branchData);
            }

            toast.success(`IFSC verified: ${branchData.bank_name} - ${branchData.branch_name}`);
        } catch (err) {
            setValidationError(err.message);
            setValidated(false);
            // Only show toast for actual lookup failures, not format issues
            if (err.message.includes('not found')) {
                toast.error('IFSC code not found in database');
            }
        } finally {
            setLoading(false);
        }
    };

    const handleChange = (e) => {
        const newValue = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        onChange(newValue);
        setValidated(false);
        // Clear validation error when user starts typing again
        if (validationError) {
            setValidationError('');
        }
    };

    // Only show error if field has been touched OR there's a form-level error
    const displayError = touched ? (validationError || error) : '';

    return (
        <div>
            <label className="block text-sm font-medium text-app-heading mb-1.5">
                IFSC Code <span className="text-red-500">*</span>
            </label>
            <div className="relative">
                <input
                    type="text"
                    value={value}
                    onChange={handleChange}
                    onBlur={validateIFSC}
                    maxLength={11}
                    placeholder="SBIN0001234"
                    disabled={disabled}
                    className={`w-full px-4 py-2.5 pr-10 rounded-xl border transition-all outline-none focus:ring-2 ${displayError
                        ? 'border-red-400 focus:border-red-500 focus:ring-red-100 dark:border-red-500/50 dark:focus:ring-red-900/30'
                        : validated
                            ? 'border-green-400 focus:border-green-500 focus:ring-green-100 dark:border-green-500/50 dark:focus:ring-green-900/30'
                            : 'border-app focus:border-app-focus focus:ring-primary-100 dark:focus:ring-primary-900/30'
                        } ${disabled ? 'bg-app-hover cursor-not-allowed text-app-muted' : 'bg-app-card text-app-heading'}`}
                />
                <div className="absolute right-3 top-1/2 -translate-y-1/2">
                    {loading && (
                        <Loader2 size={18} className="animate-spin text-primary-600" />
                    )}
                    {validated && !loading && (
                        <CheckCircle size={18} className="text-green-500" />
                    )}
                    {displayError && !loading && (
                        <AlertCircle size={18} className="text-red-500" />
                    )}
                    {!loading && !validated && !displayError && value && (
                        <Search size={18} className="text-app-muted" />
                    )}
                </div>
            </div>
            {displayError && (
                <p className="mt-1 text-sm text-red-500 flex items-center gap-1">
                    <AlertCircle size={14} /> {displayError}
                </p>
            )}
            {!displayError && !validated && (
                <p className="mt-1 text-xs text-app-muted">
                    Enter 11-character IFSC code (e.g., SBIN0001234)
                </p>
            )}
            {validated && (
                <p className="mt-1 text-xs text-green-500 flex items-center gap-1">
                    <CheckCircle size={12} /> IFSC verified - branch details auto-filled
                </p>
            )}
        </div>
    );
};

export default IFSCInput;



================================================
FILE: frontend/src/components/cost/BOQMilestoneMappingModal.jsx
================================================
/**
 * BOQMilestoneMappingModal - Link BOQ items to Schedule Milestones with % allocation
 * 
 * Enables the "No Money Without Time" principle by connecting costs to schedule.
 * A BOQ item can be split across multiple milestones (e.g., 30% Foundation, 70% Superstructure)
 */
import { useState, useEffect, useMemo } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    X, Link2, Target, Percent, Plus, Trash2, Loader2,
    CheckCircle2, AlertCircle, Calendar, PieChart
} from 'lucide-react';
import Button from '@/components/ui/Button';
import financeService from '@/services/financeService';
import schedulingService from '@/services/schedulingService';
import { toast } from 'sonner';

const BOQMilestoneMappingModal = ({ boqItem, projectId, onClose, onUpdated }) => {
    const [milestones, setMilestones] = useState([]);
    const [existingMappings, setExistingMappings] = useState([]);
    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(false);

    // New mapping form
    const [selectedMilestone, setSelectedMilestone] = useState('');
    const [percentageAllocated, setPercentageAllocated] = useState('');
    const [addingNew, setAddingNew] = useState(false);

    // Load data
    useEffect(() => {
        loadData();
    }, [boqItem.id, projectId]);

    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [onClose]);

    const loadData = async () => {
        setLoading(true);
        try {
            const [milestonesData, mappingsData] = await Promise.all([
                schedulingService.getMilestones(projectId),
                financeService.getBOQMappings(boqItem.id)
            ]);
            setMilestones(milestonesData);
            setExistingMappings(mappingsData);
        } catch (error) {
            console.error('Failed to load data:', error);
            toast.error('Failed to load milestone data');
        } finally {
            setLoading(false);
        }
    };

    // Calculate allocated and remaining percentages
    const { totalAllocated, remaining } = useMemo(() => {
        const total = existingMappings.reduce((sum, m) => sum + parseFloat(m.percentage_allocated || 0), 0);
        return {
            totalAllocated: total,
            remaining: 100 - total
        };
    }, [existingMappings]);

    // Filter out already mapped milestones
    const availableMilestones = useMemo(() => {
        const mappedIds = new Set(existingMappings.map(m => m.milestone));
        return milestones.filter(m => !mappedIds.has(m.id));
    }, [milestones, existingMappings]);

    // Add new mapping
    const handleAddMapping = async () => {
        if (!selectedMilestone) {
            return toast.error('Please select a milestone');
        }

        const pct = parseFloat(percentageAllocated);
        if (isNaN(pct) || pct <= 0 || pct > 100) {
            return toast.error('Please enter a valid percentage (1-100)');
        }

        if (pct > remaining) {
            return toast.error(`Cannot allocate more than ${remaining.toFixed(1)}% remaining`);
        }

        setAddingNew(true);
        try {
            const newMapping = await financeService.createBOQMapping({
                boq_item: boqItem.id,
                milestone: selectedMilestone,
                percentage_allocated: pct.toFixed(2)
            });

            setExistingMappings(prev => [...prev, newMapping]);
            setSelectedMilestone('');
            setPercentageAllocated('');
            toast.success('Milestone linked successfully');

        } catch (error) {
            console.error('Failed to create mapping:', error);
            const errorMsg = error.response?.data?.detail || 'Failed to create mapping';
            toast.error(errorMsg);
        } finally {
            setAddingNew(false);
        }
    };

    // Delete mapping
    const handleDeleteMapping = async (mappingId) => {
        if (!confirm('Remove this milestone link?')) return;

        try {
            await financeService.deleteBOQMapping(mappingId);
            setExistingMappings(prev => prev.filter(m => m.id !== mappingId));
            toast.success('Mapping removed');
        } catch (error) {
            console.error('Failed to delete mapping:', error);
            toast.error('Failed to remove mapping');
        }
    };

    // Format currency
    const formatCurrency = (val) => {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            maximumFractionDigits: 0
        }).format(val);
    };

    // Get milestone name by ID
    const getMilestoneName = (milestoneId) => {
        const milestone = milestones.find(m => m.id === milestoneId);
        return milestone?.name || 'Unknown Milestone';
    };

    return createPortal(
        <div className="fixed inset-0 z-[9999] bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                className="bg-white dark:bg-neutral-900 rounded-2xl w-full max-w-xl shadow-2xl overflow-hidden"
            >
                {/* Header */}
                <div className="flex justify-between items-center p-4 border-b border-slate-200 dark:border-neutral-700 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-neutral-800 dark:to-neutral-800">
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <Link2 className="text-amber-600 dark:text-amber-400" size={20} />
                            Link to Milestones
                        </h2>
                        <p className="text-xs text-slate-500 dark:text-neutral-400 mt-0.5">
                            Allocate BOQ cost across schedule milestones
                        </p>
                    </div>
                    <button
                        onClick={onClose}
                        className="p-2 hover:bg-white/50 dark:hover:bg-neutral-700 rounded-lg transition-colors"
                    >
                        <X size={20} className="text-slate-500 dark:text-neutral-400" />
                    </button>
                </div>

                {/* BOQ Item Info */}
                <div className="p-4 bg-slate-50 dark:bg-neutral-800 border-b border-slate-200 dark:border-neutral-700">
                    <div className="flex items-start gap-3">
                        <div className="w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center flex-shrink-0">
                            <PieChart size={18} className="text-amber-600" />
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                                <span className="font-bold text-amber-700">{boqItem.item_code}</span>
                                <span className="text-lg font-bold text-slate-900 dark:text-white">
                                    {formatCurrency(boqItem.amount)}
                                </span>
                            </div>
                            <p className="text-sm text-slate-600 dark:text-neutral-400 line-clamp-2">{boqItem.description}</p>
                        </div>
                    </div>

                    {/* Allocation Progress Bar */}
                    <div className="mt-4">
                        <div className="flex justify-between text-xs mb-1">
                            <span className="text-slate-600 dark:text-neutral-400">Allocated to Milestones</span>
                            <span className={`font-medium ${totalAllocated >= 100 ? 'text-green-600' : 'text-amber-600'}`}>
                                {totalAllocated.toFixed(1)}% / 100%
                            </span>
                        </div>
                        <div className="h-2 bg-slate-200 dark:bg-neutral-700 rounded-full overflow-hidden">
                            <motion.div
                                className={`h-full ${totalAllocated >= 100 ? 'bg-green-500' : 'bg-amber-500'}`}
                                initial={{ width: 0 }}
                                animate={{ width: `${Math.min(totalAllocated, 100)}%` }}
                                transition={{ duration: 0.5 }}
                            />
                        </div>
                    </div>
                </div>

                {/* Content */}
                <div className="p-4 max-h-[50vh] overflow-y-auto">
                    {loading ? (
                        <div className="flex items-center justify-center py-8">
                            <Loader2 className="w-6 h-6 animate-spin text-primary-600" />
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {/* Existing Mappings */}
                            {existingMappings.length > 0 && (
                                <div className="space-y-2">
                                    <p className="text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wider">
                                        Linked Milestones
                                    </p>
                                    {existingMappings.map((mapping) => (
                                        <div
                                            key={mapping.id}
                                            className="flex items-center justify-between p-3 bg-white dark:bg-neutral-800 border border-slate-200 dark:border-neutral-700 rounded-lg hover:border-slate-300 dark:hover:border-neutral-600 transition-colors group"
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                                                    <Target size={14} className="text-green-600" />
                                                </div>
                                                <div>
                                                    <p className="text-sm font-medium text-slate-800 dark:text-white">
                                                        {mapping.milestone_name || getMilestoneName(mapping.milestone)}
                                                    </p>
                                                    <p className="text-xs text-slate-500 dark:text-neutral-400">
                                                        {formatCurrency(boqItem.amount * (parseFloat(mapping.percentage_allocated) / 100))}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="px-2 py-1 bg-green-100 text-green-700 text-sm font-bold rounded">
                                                    {parseFloat(mapping.percentage_allocated).toFixed(1)}%
                                                </span>
                                                <button
                                                    onClick={() => handleDeleteMapping(mapping.id)}
                                                    className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded opacity-0 group-hover:opacity-100 transition-all"
                                                    title="Remove mapping"
                                                >
                                                    <Trash2 size={14} />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Add New Mapping */}
                            {remaining > 0 && availableMilestones.length > 0 && (
                                <div className="p-4 bg-slate-50 dark:bg-neutral-800 rounded-xl border border-slate-200 dark:border-neutral-700 space-y-3">
                                    <p className="text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wider flex items-center gap-1">
                                        <Plus size={12} /> Add Milestone Link
                                    </p>

                                    <div className="flex gap-2">
                                        <select
                                            value={selectedMilestone}
                                            onChange={(e) => setSelectedMilestone(e.target.value)}
                                            className="flex-1 px-3 py-2 border border-slate-200 dark:border-neutral-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white dark:bg-neutral-900 dark:text-white"
                                        >
                                            <option value="">Select Milestone...</option>
                                            {availableMilestones.map(m => (
                                                <option key={m.id} value={m.id}>
                                                    {m.name} ({m.progress}% complete)
                                                </option>
                                            ))}
                                        </select>

                                        <div className="relative w-24">
                                            <input
                                                type="number"
                                                min="0.1"
                                                max={remaining}
                                                step="0.1"
                                                value={percentageAllocated}
                                                onChange={(e) => setPercentageAllocated(e.target.value)}
                                                placeholder={`Max ${remaining.toFixed(0)}%`}
                                                className="w-full px-3 py-2 border border-slate-200 dark:border-neutral-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white dark:bg-neutral-900 dark:text-white pr-7"
                                            />
                                            <Percent size={14} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400" />
                                        </div>

                                        <Button
                                            onClick={handleAddMapping}
                                            disabled={addingNew}
                                            size="sm"
                                            className="bg-amber-600 text-white hover:bg-amber-700"
                                        >
                                            {addingNew ? <Loader2 size={16} className="animate-spin" /> : <Plus size={16} />}
                                        </Button>
                                    </div>
                                </div>
                            )}

                            {/* Fully Allocated Message */}
                            {remaining <= 0 && (
                                <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg flex items-center gap-3">
                                    <CheckCircle2 size={20} className="text-green-600 dark:text-green-400" />
                                    <div>
                                        <p className="text-sm font-medium text-green-800 dark:text-green-300">Fully Allocated</p>
                                        <p className="text-xs text-green-600 dark:text-green-400">This BOQ item is 100% linked to milestones</p>
                                    </div>
                                </div>
                            )}

                            {/* No Milestones Warning */}
                            {milestones.length === 0 && (
                                <div className="p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg flex items-center gap-3">
                                    <AlertCircle size={20} className="text-amber-600 dark:text-amber-400" />
                                    <div>
                                        <p className="text-sm font-medium text-amber-800 dark:text-amber-300">No Milestones Found</p>
                                        <p className="text-xs text-amber-600 dark:text-amber-400">
                                            Import a schedule or add milestone tasks to the project first
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>

                {/* Footer */}
                <div className="flex justify-end p-4 border-t border-slate-200 dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
                    <Button
                        onClick={() => { onUpdated && onUpdated(); onClose(); }}
                        className="bg-primary-600 text-white"
                    >
                        Done
                    </Button>
                </div>
            </motion.div>
        </div>,
        document.body
    );
};

export default BOQMilestoneMappingModal;



================================================
FILE: frontend/src/components/cost/EditBOQItemModal.jsx
================================================
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Save, Key, FileText, Ruler, Calculator, IndianRupee } from 'lucide-react';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';

const EditBOQItemModal = ({ isOpen, onClose, item, onSave }) => {
    const [isLoading, setIsLoading] = useState(false);
    const [formData, setFormData] = useState({
        item_code: '',
        description: '',
        uom: '',
        quantity: '',
        rate: ''
    });

    useEffect(() => {
        if (item) {
            setFormData({
                item_code: item.item_code || '',
                description: item.description || '',
                uom: item.uom || '',
                quantity: item.quantity || '',
                rate: item.rate || ''
            });
        }
    }, [item]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const payload = {
                ...formData,
                quantity: parseFloat(formData.quantity) || 0,
                rate: parseFloat(formData.rate) || 0,
            };
            await onSave(item.id, payload);
            toast.success('BOQ Item updated successfully');
            onClose();
        } catch (error) {
            console.error('Update failed:', error);
            const msg = error.response?.data?.error || error.response?.data?.detail || 'Failed to update item';
            toast.error(msg);
        } finally {
            setIsLoading(false);
        }
    };

    if (!isOpen) return null;

    return createPortal(
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm p-4">
            <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.95 }}
                className="bg-white dark:bg-neutral-900 rounded-2xl shadow-xl w-full max-w-lg overflow-hidden"
            >
                <div className="flex items-center justify-between p-4 border-b border-slate-200 dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
                    <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <Edit2 className="w-5 h-5 text-primary-600 dark:text-indigo-400" />
                        Edit BOQ Item
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-slate-200 dark:hover:bg-neutral-700 rounded-lg">
                        <X className="w-5 h-5 text-slate-500 dark:text-neutral-400" />
                    </button>
                </div>

                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                    <div>
                        <label className="block text-xs font-semibold uppercase text-slate-500 dark:text-neutral-400 mb-1">
                            Item Code
                        </label>
                        <div className="relative">
                            <Key className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                            <input
                                required
                                name="item_code"
                                value={formData.item_code}
                                onChange={handleChange}
                                className="w-full pl-9 pr-3 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg focus:ring-2 focus:ring-primary-500 text-sm font-mono"
                                placeholder="e.g. 1.1.2"
                            />
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-semibold uppercase text-slate-500 dark:text-neutral-400 mb-1">
                            Description
                        </label>
                        <div className="relative">
                            <FileText className="absolute left-3 top-3 w-4 h-4 text-slate-400" />
                            <textarea
                                required
                                name="description"
                                value={formData.description}
                                onChange={handleChange}
                                rows={3}
                                className="w-full pl-9 pr-3 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                                placeholder="Enter item description..."
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-semibold uppercase text-slate-500 dark:text-neutral-400 mb-1">
                                UOM
                            </label>
                            <div className="relative">
                                <Ruler className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                                <input
                                    required
                                    name="uom"
                                    value={formData.uom}
                                    onChange={handleChange}
                                    className="w-full pl-9 pr-3 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                                    placeholder="e.g. Cum"
                                />
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-semibold uppercase text-slate-500 dark:text-neutral-400 mb-1">
                                Quantity
                            </label>
                            <div className="relative">
                                <Calculator className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                                <input
                                    required
                                    type="number"
                                    name="quantity"
                                    value={formData.quantity}
                                    onChange={handleChange}
                                    className="w-full pl-9 pr-3 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                                    placeholder="0.00"
                                />
                            </div>
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-semibold uppercase text-slate-500 dark:text-neutral-400 mb-1">
                            Rate
                        </label>
                        <div className="relative">
                            <IndianRupee className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                            <input
                                required
                                type="number"
                                name="rate"
                                value={formData.rate}
                                onChange={handleChange}
                                className="w-full pl-9 pr-3 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                                placeholder="0.00"
                            />
                        </div>
                    </div>

                    <div className="pt-4 flex justify-end gap-3">
                        <Button type="button" variant="secondary" onClick={onClose} disabled={isLoading}>
                            Cancel
                        </Button>
                        <Button type="submit" disabled={isLoading}>
                            {isLoading ? 'Saving...' : 'Save Changes'}
                        </Button>
                    </div>
                </form>
            </motion.div>
        </div>,
        document.body
    );
};

// Simple Edit Icon wrapper cause lucide import issues sometimes
const Edit2 = ({ ...props }) => (
    <svg
        {...props}
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
    >
        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
    </svg>
);

export default EditBOQItemModal;



================================================
FILE: frontend/src/components/dashboard/ActivityFeed.jsx
================================================
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { formatDistanceToNow } from 'date-fns';
import {
    FolderOpen, FileText, Users, IndianRupee, CheckCircle,
    AlertTriangle, Clock, ArrowRight, Loader2
} from 'lucide-react';
import { Link, useNavigate } from 'react-router-dom';
import dashboardService from '@/api/services/dashboardService';

/**
 * ActivityFeed Component
 * 
 * Displays a real-time activity feed with recent updates from all modules.
 */
const ActivityFeed = ({ limit = 10, showHeader = true, compact = false }) => {
    const [activities, setActivities] = useState([]);
    const [loading, setLoading] = useState(true);
    const navigate = useNavigate();

    useEffect(() => {
        const fetchActivities = async () => {
            try {
                const data = await dashboardService.getActivity(limit);
                setActivities(data.activities);
            } catch (err) {
                console.error('Failed to fetch activities:', err);
            } finally {
                setLoading(false);
            }
        };
        fetchActivities();
    }, [limit]);

    const getIcon = (type) => {
        const icons = {
            project: FolderOpen,
            document: FileText,
            user: Users,
            finance: IndianRupee,
            approval: CheckCircle,
            risk: AlertTriangle,
        };
        return icons[type] || Clock;
    };

    const getColor = (type) => {
        const colors = {
            project: 'bg-blue-100 text-blue-600',
            document: 'bg-green-100 text-green-600',
            user: 'bg-purple-100 text-purple-600',
            finance: 'bg-emerald-100 text-emerald-600',
            approval: 'bg-amber-100 text-amber-600',
            risk: 'bg-red-100 text-red-600',
        };
        return colors[type] || 'bg-slate-100 text-slate-600';
    };

    const formatTimestamp = (timestamp) => {
        try {
            return formatDistanceToNow(new Date(timestamp), { addSuffix: true });
        } catch {
            return 'recently';
        }
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center py-8">
                <Loader2 className="w-6 h-6 text-primary-500 animate-spin" />
            </div>
        );
    }

    if (activities.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center py-8 text-center">
                <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                    <Clock className="w-6 h-6 text-slate-400" />
                </div>
                <p className="text-slate-500 text-sm">No recent activity</p>
            </div>
        );
    }

    return (
        <div className="space-y-1">
            {showHeader && (
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-semibold text-slate-800">Recent Activity</h3>
                    <button
                        onClick={() => navigate('/approvals')}
                        className="text-sm text-primary-600 hover:text-primary-700 flex items-center gap-1"
                    >
                        View all <ArrowRight size={14} />
                    </button>
                </div>
            )}

            <div className="space-y-3">
                {activities.map((activity, index) => {
                    const Icon = getIcon(activity.type);
                    const colorClass = getColor(activity.type);

                    return (
                        <motion.div
                            key={activity.id || index}
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ delay: index * 0.05 }}
                            className={`flex items-start gap-3 p-3 rounded-xl hover:bg-slate-50 transition-colors cursor-pointer ${compact ? 'p-2' : 'p-3'
                                }`}
                            onClick={() => activity.link && navigate(activity.link)}
                        >
                            <div className={`p-2 rounded-lg ${colorClass}`}>
                                <Icon size={compact ? 14 : 16} />
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className={`font-medium text-slate-800 truncate ${compact ? 'text-sm' : ''}`}>
                                    {activity.title}
                                </p>
                                {activity.description && !compact && (
                                    <p className="text-sm text-slate-500 truncate">{activity.description}</p>
                                )}
                                <p className="text-xs text-slate-400 mt-1">
                                    {activity.user && <span className="text-slate-600">{activity.user} â€¢ </span>}
                                    {formatTimestamp(activity.timestamp)}
                                </p>
                            </div>
                        </motion.div>
                    );
                })}
            </div>
        </div>
    );
};

export default ActivityFeed;



================================================
FILE: frontend/src/components/dashboard/ConsultantDashboard.jsx
================================================
import { motion } from 'framer-motion';
import { useLanguage } from '@/contexts/LanguageContext';
import { MotionCard, MotionCardContent, MotionCardHeader, MotionCardTitle } from '@/components/ui/MotionCard';
import { Box, Layers, GitPullRequest, Eye } from 'lucide-react';

const ConsultantDashboard = ({ projects, tasks }) => {
    const { t } = useLanguage();

    const containerVariants = {
        hidden: { opacity: 0 },
        visible: { opacity: 1, transition: { staggerChildren: 0.1 } }
    };

    // Logic Calculation
    const activeBIMModels = projects.filter(p => p.status === 'Planning' || p.status === 'In Progress').length;
    const drawingsUnderReview = 0; // Document system removed

    // Simulate Change Requests from tasks related to 'Review' or 'Change'
    const changeRequests = tasks ? tasks.filter(t => t.name.includes('Review') || t.status === 'Under Review').length : 0;

    const recentDrawings = [];

    return (
        <motion.div variants={containerVariants} initial="hidden" animate="visible" className="space-y-6">
            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">{t('role.Consultant_Design')} Hub</h2>
            <p className="text-slate-500 dark:text-neutral-400">Drawing Approvals, BIM Coordination & Technical Reviews</p>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <MotionCard className="bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800">
                    <MotionCardContent className="p-6 flex flex-col items-center">
                        <Box size={32} className="text-purple-600 mb-2" />
                        <span className="text-2xl font-bold text-slate-800 dark:text-white">{activeBIMModels}</span>
                        <span className="text-sm text-purple-700">Active BIM Models</span>
                    </MotionCardContent>
                </MotionCard>
                <MotionCard className="bg-pink-50 dark:bg-pink-900/20 border-pink-200 dark:border-pink-800">
                    <MotionCardContent className="p-6 flex flex-col items-center">
                        <Layers size={32} className="text-pink-600 mb-2" />
                        <span className="text-2xl font-bold text-slate-800 dark:text-white">{drawingsUnderReview}</span>
                        <span className="text-sm text-pink-700">Drawings Under Review</span>
                    </MotionCardContent>
                </MotionCard>
                <MotionCard className="bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800">
                    <MotionCardContent className="p-6 flex flex-col items-center">
                        <GitPullRequest size={32} className="text-indigo-600 mb-2" />
                        <span className="text-2xl font-bold text-slate-800 dark:text-white">{changeRequests}</span>
                        <span className="text-sm text-indigo-700">Change Requests</span>
                    </MotionCardContent>
                </MotionCard>
                <MotionCard className="bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-neutral-700 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <MotionCardContent className="p-6 flex flex-col items-center">
                        <Eye size={32} className="text-slate-600 mb-2" />
                        <span className="text-2xl font-bold text-slate-800 dark:text-white">{t('common.view')}</span>
                        <span className="text-sm text-slate-700">Pending Actions</span>
                    </MotionCardContent>
                </MotionCard>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <MotionCard>
                    <MotionCardHeader><MotionCardTitle>Recent Drawing Uploads</MotionCardTitle></MotionCardHeader>
                    <MotionCardContent>
                        {recentDrawings.length > 0 ? (
                            <ul className="space-y-3">
                                {recentDrawings.map((doc, index) => (
                                    <li key={doc.id || index} className="flex justify-between items-center p-2 hover:bg-slate-50 dark:hover:bg-neutral-800 rounded transition-colors cursor-pointer">
                                        <div className="flex items-center gap-2 overflow-hidden">
                                            <span className="truncate text-sm font-medium text-slate-700 dark:text-neutral-300">{doc.name}</span>
                                        </div>
                                        <span className={`text-xs px-2 py-0.5 rounded ${doc.status === 'Approved' ? 'bg-green-100 text-green-700' :
                                            doc.status === 'Rejected' ? 'bg-red-100 text-red-700' :
                                                'bg-yellow-100 text-yellow-700'
                                            }`}>
                                            {doc.status || 'Pending'}
                                        </span>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <div className="text-center py-8 text-slate-500 dark:text-neutral-400 text-sm">No drawings uploaded recently.</div>
                        )}
                    </MotionCardContent>
                </MotionCard>
                <MotionCard>
                    <MotionCardHeader><MotionCardTitle>BIM Coordination Issues</MotionCardTitle></MotionCardHeader>
                    <MotionCardContent>
                        <div className="space-y-4">
                            {tasks && tasks.filter(t => t.priority === 'High').slice(0, 3).map(task => (
                                <div key={task.id} className="p-3 bg-red-50 dark:bg-red-900/20 rounded border border-red-100 dark:border-red-800 flex justify-between items-center">
                                    <span className="text-sm font-medium text-red-900 dark:text-red-200">{task.name}</span>
                                    <span className="text-xs bg-red-200 dark:bg-red-800 text-red-800 dark:text-red-200 px-2 py-1 rounded-full">High Priority</span>
                                </div>
                            ))}
                            {(!tasks || tasks.filter(t => t.priority === 'High').length === 0) && (
                                <div className="p-4 bg-slate-50 dark:bg-neutral-800 rounded border border-slate-100 dark:border-neutral-700 text-center text-slate-400 dark:text-neutral-500">
                                    No critical coordination issues detected.
                                </div>
                            )}
                        </div>
                    </MotionCardContent>
                </MotionCard>
            </div>
        </motion.div>
    );
};

export default ConsultantDashboard;



================================================
FILE: frontend/src/components/dashboard/EPCDashboard.jsx
================================================
import { useState } from 'react';
import { motion } from 'framer-motion';
import { useLanguage } from '@/contexts/LanguageContext';
import { MotionCard, MotionCardContent, MotionCardHeader, MotionCardTitle } from '@/components/ui/MotionCard';
import { Upload, FileText, CheckCircle, Calendar, AlertCircle } from 'lucide-react';
import Button from '@/components/ui/Button';
import MetricsDetailModal from '@/components/ui/MetricsDetailModal';

const EPCDashboard = ({ projects, tasks }) => {
    const { t } = useLanguage();
    const [selectedMetric, setSelectedMetric] = useState(null);

    const containerVariants = {
        hidden: { opacity: 0 },
        visible: { opacity: 1, transition: { staggerChildren: 0.1 } }
    };

    const itemVariants = {
        hidden: { opacity: 0, y: 10 },
        visible: { opacity: 1, y: 0 }
    };

    // EPC Logic via Calculation Rules
    const myTasks = tasks.filter(t => t.assignedTo === 'EPC Contractor' || t.status === 'In Progress');
    const activeSiteTasks = myTasks.length;

    // Logic: Invoices are approx 5% of spent budget for active projects that haven't been cleared
    const pendingInvoices = projects
        .filter(p => p.status === 'In Progress')
        .map((p, i) => ({
            id: `INV-${2024}-${100 + i}`,
            label: `INV-${p.name.substring(0, 4).toUpperCase()}-00${i + 1}`,
            value: `â‚¹${(p.spent * 0.05 / 100000).toFixed(1)} L`, // 5% of spent
            amount: p.spent * 0.05
        }))
        .slice(0, 3); // Top 3

    const pendingInvoicesCount = pendingInvoices.length;

    // Logic: Safety depends on overdue tasks. 0 overdue = 100%. Each overdue -5%.
    const overdueTasks = tasks.filter(t => new Date(t.endDate) < new Date() && t.status !== 'Completed').length;
    const safetyScore = Math.max(0, 100 - (overdueTasks * 5));

    const handleCardClick = (type) => {
        let data = { title: '', description: '', items: [] };
        switch (type) {
            case 'activeTasks':
                data = {
                    title: 'Active Site Tasks',
                    description: "Tasks currently designated as 'In Progress' at the construction site. This includes excavation, foundation laying, and structural erection works.",
                    items: myTasks.map(t => ({ label: t.name, value: t.endDate }))
                }
                break;
            case 'invoices':
                data = {
                    title: 'Pending Invoices',
                    description: "Invoices generated from certified works that are pending clearance from the Finance department (approx 5% of certified spent).",
                    items: pendingInvoices.map(inv => ({ label: inv.label, value: inv.value }))
                }
                break;
            case 'safety':
                data = {
                    title: 'Safety Compliance',
                    description: `Current site safety rating calculated based on task timeliness and incident reporting. Unresolved overdue tasks impact this score. (Overdue: ${overdueTasks})`,
                    items: tasks.filter(t => new Date(t.endDate) < new Date() && t.status !== 'Completed').map(t => ({ label: t.name, value: 'Overdue / Safety Risk' }))
                }
                break;
            default: return;
        }
        setSelectedMetric(data);
    }

    return (
        <>
            <motion.div variants={containerVariants} initial="hidden" animate="visible" className="space-y-6">
                <motion.div variants={itemVariants} className="flex justify-between items-center">
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 dark:text-white">{t('role.EPC_Contractor')} Operations</h2>
                        <p className="text-slate-500 dark:text-neutral-400">Site Work, Progress Reporting & Compliance</p>
                    </div>
                    <Button>
                        <Upload size={16} /> {t('common.upload')} Report
                    </Button>
                </motion.div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <MotionCard
                        variants={itemVariants}
                        onClick={() => handleCardClick('activeTasks')}
                        className="border-t-4 border-t-orange-500 cursor-pointer hover:shadow-lg transition-all"
                    >
                        <MotionCardContent className="p-6 text-center">
                            <div className="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <Calendar className="text-orange-600" size={24} />
                            </div>
                            <h3 className="text-3xl font-bold text-slate-800 dark:text-white">{activeSiteTasks}</h3>
                            <p className="text-slate-500 dark:text-neutral-400">Active Site Tasks</p>
                        </MotionCardContent>
                    </MotionCard>

                    <MotionCard
                        variants={itemVariants}
                        onClick={() => handleCardClick('invoices')}
                        className="border-t-4 border-t-blue-500 cursor-pointer hover:shadow-lg transition-all"
                    >
                        <MotionCardContent className="p-6 text-center">
                            <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <FileText className="text-blue-600" size={24} />
                            </div>
                            <h3 className="text-3xl font-bold text-slate-800 dark:text-white">{pendingInvoicesCount}</h3>
                            <p className="text-slate-500 dark:text-neutral-400">Pending Invoices</p>
                        </MotionCardContent>
                    </MotionCard>

                    <MotionCard
                        variants={itemVariants}
                        onClick={() => handleCardClick('safety')}
                        className={`border-t-4 cursor-pointer hover:shadow-lg transition-all ${safetyScore > 90 ? 'border-t-green-500' : 'border-t-red-500'}`}
                    >
                        <MotionCardContent className="p-6 text-center">
                            <div className={`w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 ${safetyScore > 90 ? 'bg-green-100' : 'bg-red-100'}`}>
                                <CheckCircle className={`${safetyScore > 90 ? 'text-green-600' : 'text-red-600'}`} size={24} />
                            </div>
                            <h3 className="text-3xl font-bold text-slate-800 dark:text-white">{safetyScore}%</h3>
                            <p className="text-slate-500 dark:text-neutral-400">Safety Compliance</p>
                        </MotionCardContent>
                    </MotionCard>
                </div>

                <MotionCard variants={itemVariants}>
                    <MotionCardHeader>
                        <MotionCardTitle>{t('dashboard.upcomingTasks')}</MotionCardTitle>
                    </MotionCardHeader>
                    <MotionCardContent>
                        <div className="space-y-3">
                            {myTasks.slice(0, 5).map(task => (
                                <div key={task.id} className="flex items-center justify-between p-4 bg-slate-50 dark:bg-neutral-800 rounded-xl transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-2 h-2 rounded-full ${task.priority === 'High' ? 'bg-red-500' : 'bg-blue-500'} `} />
                                        <span className="font-medium text-slate-800 dark:text-white">{task.name}</span>
                                    </div>
                                    <span className="text-sm text-slate-500 dark:text-neutral-400">Due: {task.endDate}</span>
                                </div>
                            ))}
                        </div>
                    </MotionCardContent>
                </MotionCard>
            </motion.div>

            <MetricsDetailModal
                isOpen={!!selectedMetric}
                onClose={() => setSelectedMetric(null)}
                title={selectedMetric?.title}
                description={selectedMetric?.description}
                items={selectedMetric?.items}
            />
        </>
    );
};

export default EPCDashboard;



================================================
FILE: frontend/src/components/dashboard/GovtDashboard.jsx
================================================
import { motion } from 'framer-motion';
import { useLanguage } from '@/contexts/LanguageContext';
import { MotionCard, MotionCardContent, MotionCardHeader, MotionCardTitle } from '@/components/ui/MotionCard';

const GovtDashboard = ({ projects, kpis }) => {
    const { t } = useLanguage();

    const containerVariants = {
        hidden: { opacity: 0 },
        visible: { opacity: 1, transition: { staggerChildren: 0.1 } }
    };

    return (
        <motion.div variants={containerVariants} initial="hidden" animate="visible" className="space-y-8">
            <div className="text-center border-b border-slate-200 dark:border-neutral-700 pb-6">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/55/Emblem_of_India.svg" alt="Govt Emblem" className="h-16 mx-auto mb-4 opacity-80" />
                <h2 className="text-2xl font-serif font-bold text-slate-900 dark:text-white">{t('role.Govt_Department')}</h2>
                <p className="text-slate-600 dark:text-neutral-400">Executive Status Report</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {(projects || []).slice(0, 3).map(project => (
                    <MotionCard key={project.id} className="border-t-4 border-t-slate-800">
                        <MotionCardHeader>
                            <MotionCardTitle>{project.name}</MotionCardTitle>
                        </MotionCardHeader>
                        <MotionCardContent className="space-y-4">
                            <div>
                                <div className="flex justify-between text-sm mb-1">
                                    <span>{t('common.progress')}</span>
                                    <span className="font-bold">{project.progress}%</span>
                                </div>
                                <div className="w-full bg-slate-200 dark:bg-neutral-700 h-2 rounded-full overflow-hidden">
                                    <div className="bg-slate-800 dark:bg-slate-400 h-full" style={{ width: `${project.progress}%` }}></div>
                                </div>
                            </div>
                            <div className="flex justify-between text-sm text-slate-600 dark:text-neutral-400 border-t dark:border-neutral-700 pt-2">
                                <span>{t('common.status')}</span>
                                <span className="font-semibold uppercase tracking-wide">{project.status}</span>
                            </div>
                        </MotionCardContent>
                    </MotionCard>
                ))}
            </div>

            <MotionCard>
                <MotionCardHeader><MotionCardTitle>Key Performance Indicators Summary</MotionCardTitle></MotionCardHeader>
                <MotionCardContent>
                    <table className="w-full text-sm text-left">
                        <thead className="bg-slate-50 dark:bg-neutral-800 text-slate-600 dark:text-neutral-400 uppercase">
                            <tr>
                                <th className="px-4 py-3">Metric</th>
                                <th className="px-4 py-3">{t('common.target')}</th>
                                <th className="px-4 py-3">{t('cost.actual')}</th>
                                <th className="px-4 py-3">{t('common.status')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {(kpis || []).slice(0, 5).map(kpi => (
                                <tr key={kpi.id} className="border-b dark:border-neutral-700">
                                    <td className="px-4 py-3 font-medium dark:text-white">{kpi.name}</td>
                                    <td className="px-4 py-3">{kpi.target} {kpi.unit}</td>
                                    <td className="px-4 py-3">{kpi.value} {kpi.unit}</td>
                                    <td className="px-4 py-3">
                                        <span className={`px-2 py-1 text-xs rounded-full ${kpi.value >= kpi.target ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'}`}>
                                            {kpi.value >= kpi.target ? t('common.onTrack') : t('common.delayed')}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </MotionCardContent>
            </MotionCard>
        </motion.div>
    );
};

export default GovtDashboard;



================================================
FILE: frontend/src/components/dashboard/HealthSummaryPanel.jsx
================================================
import { motion } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import {
    Clock, CheckSquare, AlertTriangle, TrendingUp, DollarSign,
    ArrowRight, CheckCircle, XCircle, AlertCircle
} from 'lucide-react';

/**
 * Health Summary Panel
 * Quick-glance panel showing 5 key project health metrics
 * Inspired by construction dashboard reference images
 */
const HealthSummaryPanel = ({
    scheduleHealth = {},
    projectStats = {},
    financialSummary = {},
    overdueTasks = 0,
    projects = []
}) => {
    const navigate = useNavigate();

    // Calculate health metrics
    const totalTasks = scheduleHealth.total_tasks || 0;
    const onTrackTasks = scheduleHealth.on_track || 0;
    const delayedTasks = scheduleHealth.delayed || 0;

    // Time health
    const timePercentage = scheduleHealth.percentage || 0;
    const timeStatus = scheduleHealth.no_data
        ? 'No schedule data'
        : timePercentage >= 80
            ? `${timePercentage}% on track`
            : `${100 - timePercentage}% delayed`;
    const timeHealthy = timePercentage >= 80;

    // Tasks health
    const tasksRemaining = totalTasks - onTrackTasks;
    const tasksStatus = scheduleHealth.no_data
        ? 'No tasks scheduled'
        : `${tasksRemaining} tasks to complete`;
    const tasksHealthy = tasksRemaining === 0 || scheduleHealth.no_data;

    // Overdue health
    const overdueStatus = overdueTasks > 0
        ? `${overdueTasks} tasks overdue`
        : 'No overdue tasks';
    const overdueHealthy = overdueTasks === 0;

    // Progress health
    const avgProgress = projects.length > 0
        ? Math.round(projects.reduce((sum, p) => sum + (Number(p.progress) || 0), 0) / projects.length)
        : 0;
    const progressStatus = projects.length > 0
        ? `${avgProgress}% complete`
        : 'No projects';
    const progressHealthy = avgProgress >= 50;

    // Cost health
    const budget = financialSummary.total_budget || 0;
    const spent = financialSummary.total_spent || 0;
    const utilization = financialSummary.utilization || 0;
    const costStatus = budget > 0
        ? utilization <= 100
            ? `${Math.round(100 - utilization)}% under budget`
            : `${Math.round(utilization - 100)}% over budget`
        : 'No budget data';
    const costHealthy = utilization <= 90;

    const healthItems = [
        {
            id: 'time',
            icon: Clock,
            label: 'Time',
            status: timeStatus,
            healthy: timeHealthy,
            noData: scheduleHealth.no_data,
            onClick: () => navigate('/scheduling')
        },
        {
            id: 'tasks',
            icon: CheckSquare,
            label: 'Tasks',
            status: tasksStatus,
            healthy: tasksHealthy,
            noData: scheduleHealth.no_data,
            onClick: () => navigate('/scheduling')
        },
        {
            id: 'overdue',
            icon: AlertTriangle,
            label: 'Overdue',
            status: overdueStatus,
            healthy: overdueHealthy,
            noData: false,
            onClick: () => navigate('/scheduling')
        },
        {
            id: 'progress',
            icon: TrendingUp,
            label: 'Progress',
            status: progressStatus,
            healthy: progressHealthy,
            noData: projects.length === 0,
            onClick: () => navigate('/projects')
        },
        {
            id: 'cost',
            icon: DollarSign,
            label: 'Cost',
            status: costStatus,
            healthy: costHealthy,
            noData: budget === 0,
            onClick: () => navigate('/cost/budgeting')
        }
    ];

    const getStatusIcon = (healthy, noData) => {
        if (noData) return <AlertCircle size={14} className="text-slate-400 dark:text-neutral-500" />;
        if (healthy) return <CheckCircle size={14} className="text-emerald-500" />;
        return <XCircle size={14} className="text-rose-500" />;
    };

    const getStatusColor = (healthy, noData) => {
        if (noData) return 'text-slate-500 dark:text-neutral-400';
        if (healthy) return 'text-emerald-600';
        return 'text-rose-600';
    };

    return (
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="relative overflow-hidden rounded-2xl bg-white/90 dark:bg-neutral-900/90 backdrop-blur-xl border border-slate-200 dark:border-neutral-700 shadow-sm dark:shadow-lg p-6"
        >
            <div className="absolute inset-0 bg-gradient-to-br from-white/10 dark:from-white/5 via-transparent to-transparent pointer-events-none" />

            <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-slate-800 dark:text-white">Project Health</h3>
                <span className="text-xs text-slate-400 dark:text-neutral-500 bg-slate-100 dark:bg-neutral-800 px-2 py-1 rounded">Quick Status</span>
            </div>

            <div className="space-y-3">
                {healthItems.map((item, index) => (
                    <motion.div
                        key={item.id}
                        initial={{ opacity: 0, x: -20 }}
                        animate={{ opacity: 1, x: 0 }}
                        transition={{ delay: index * 0.1 }}
                        className="flex items-center justify-between py-2 px-3 rounded-lg hover:bg-slate-50 dark:hover:bg-neutral-800 cursor-pointer group transition-colors"
                        onClick={item.onClick}
                    >
                        <div className="flex items-center gap-3">
                            <item.icon size={18} className="text-slate-600 dark:text-neutral-300" />
                            <span className="text-sm font-medium text-slate-700 dark:text-neutral-200 w-20">{item.label}</span>
                        </div>
                        <div className="flex items-center gap-2">
                            {getStatusIcon(item.healthy, item.noData)}
                            <span className={`text-sm ${getStatusColor(item.healthy, item.noData)}`}>
                                {item.status}
                            </span>
                            <ArrowRight size={14} className="text-slate-300 dark:text-neutral-600 group-hover:text-blue-500 dark:group-hover:text-indigo-400 transition-colors" />
                        </div>
                    </motion.div>
                ))}
            </div>
        </motion.div>
    );
};

export default HealthSummaryPanel;



================================================
FILE: frontend/src/components/dashboard/KPIDetailModal.jsx
================================================
import { useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, TrendingUp, TrendingDown, Minus, Calendar, Target, BarChart3 } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { DynamicChart } from '@/components/ui/DynamicChart';
import { projects } from '@/mock';
import { calculateCostVariationPercentage } from '@/lib/calculations';

export const KPIDetailModal = ({ isOpen, onClose, kpi }) => {
  // Handle Escape key
  useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape') {
        onClose();
      }
    };

    if (isOpen) {
      window.addEventListener('keydown', handleEscape);
    }

    return () => window.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose]);

  if (!isOpen || !kpi) return null;

  const isPositive = kpi.trend === 'up' || (kpi.trend === 'stable' && kpi.value >= kpi.target);
  const variance = kpi.value - kpi.target;

  // Generate historical data for the last 6 months
  const historicalData = Array.from({ length: 6 }, (_, i) => {
    const date = new Date();
    date.setMonth(date.getMonth() - (5 - i));
    const monthName = date.toLocaleDateString('en-US', { month: 'short' });
    const baseValue = kpi.value;
    const variation = (Math.random() - 0.5) * 20;
    return {
      month: monthName,
      value: Math.max(0, Math.min(100, baseValue + variation)),
      target: kpi.target,
    };
  });

  // Get project-specific data based on KPI category
  const getProjectData = () => {
    if (kpi.category === 'Schedule') {
      return projects.map((p) => ({
        name: p.name.substring(0, 15) + '...',
        progress: p.progress,
        target: 70,
      }));
    } else if (kpi.category === 'Cost') {
      return projects.map((p) => ({
        name: p.name.substring(0, 15) + '...',
        utilization: p.budget > 0 ? (p.spent / p.budget) * 100 : 0,
        target: 75,
      }));
    }
    return [];
  };

  const projectData = getProjectData();

  const getKPIDescription = () => {
    switch (kpi.id) {
      case 'kpi-1':
        return {
          title: 'Overall Project Progress',
          description:
            'This metric represents the average completion percentage across all active projects in the PMIS ZIA Programme. It provides a high-level view of how well the entire programme is progressing toward its objectives.',
          details: [
            `Current Progress: ${kpi.value}% completion across all projects`,
            `Target Achievement: ${kpi.target}% is the programme target`,
            `Variance: ${variance < 0 ? 'Behind' : 'Ahead of'} target by ${Math.abs(variance)}%`,
            `Trend: ${kpi.trend === 'up' ? 'Improving' : kpi.trend === 'down' ? 'Declining' : 'Stable'}`,
            `Last Updated: ${new Date(kpi.lastUpdated).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}`,
          ],
          insights: [
            'Several projects are contributing to the overall progress',
            'Focus areas include accelerating completion of delayed projects',
            'Resource allocation may need adjustment to meet targets',
          ],
        };
      case 'kpi-2':
        return {
          title: 'Budget Utilization',
          description:
            'Budget Utilization measures the percentage of allocated budget that has been spent across all projects. This helps track financial performance and ensures projects stay within their allocated resources.',
          details: [
            `Current Utilization: ${kpi.value}% of total allocated budget has been spent`,
            `Target Utilization: ${kpi.target}% is the expected utilization rate`,
            `Variance: ${variance < 0 ? 'Under' : 'Over'} budget by ${Math.abs(variance)}%`,
            `Trend: ${kpi.trend === 'up' ? 'Increasing' : kpi.trend === 'down' ? 'Decreasing' : 'Stable'} spending rate`,
            `Last Updated: ${new Date(kpi.lastUpdated).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}`,
          ],
          insights: [
            'Current spending is within acceptable range',
            'Monitor projects with high utilization rates closely',
            'Consider budget reallocation if needed',
          ],
        };
      case 'kpi-3':
        return {
          title: 'Project Timeline',
          description:
            'Project Timeline tracks the planned and actual project timelines. A negative value means projects are behind schedule, while a positive value indicates projects are ahead of schedule.',
          details: [
            `Current Timeline: ${kpi.value > 0 ? '+' : ''}${kpi.value} days ${kpi.value < 0 ? 'behind' : 'ahead of'} schedule`,
            `Target: ${kpi.target} days (on schedule)`,
            `Timeline Deviation: ${Math.abs(variance)} days deviation from target`,
            `Trend: ${kpi.trend === 'up' ? 'Improving' : kpi.trend === 'down' ? 'Worsening' : 'Stable'} timeline performance`,
            `Last Updated: ${new Date(kpi.lastUpdated).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}`,
          ],
          insights: [
            'Some projects are experiencing delays',
            'Critical path activities may need acceleration',
            'Resource constraints could be impacting timelines',
          ],
        };
      case 'kpi-4':
        return {
          title: 'Cost Variation',
          description:
            'Cost Variation measures the difference between budgeted and actual costs as a percentage. This metric helps identify cost overruns or savings and enables proactive financial management.',
          details: [
            `Current Variation: ${kpi.value > 0 ? '+' : ''}${kpi.value}% ${kpi.value < 0 ? 'under' : 'over'} budget`,
            `Target: ${kpi.target}% (no variation)`,
            `Variation: ${Math.abs(variance)}% deviation from budget`,
            `Trend: ${kpi.trend === 'up' ? 'Increasing' : kpi.trend === 'down' ? 'Decreasing' : 'Stable'} cost variation`,
            `Last Updated: ${new Date(kpi.lastUpdated).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}`,
          ],
          insights: [
            'Cost performance is within acceptable limits',
            'Monitor high-variance projects for cost control',
            'Review procurement and contract management processes',
          ],
        };
      default:
        return {
          title: kpi.name,
          description: `Detailed information about ${kpi.name}`,
          details: [],
          insights: [],
        };
    }
  };

  const kpiInfo = getKPIDescription();

  const modalContent = (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0, backdropFilter: 'blur(0px)' }}
        animate={{ opacity: 1, backdropFilter: 'blur(12px)' }}
        exit={{ opacity: 0, backdropFilter: 'blur(0px)' }}
        transition={{ duration: 0.3, ease: 'easeInOut' }}
        className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60"
        style={{ backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)' }}
      >
        <motion.div
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.95 }}
          transition={{ duration: 0.3, ease: 'easeInOut' }}
          className="w-full h-full max-w-7xl max-h-[95vh] overflow-y-auto bg-white dark:bg-neutral-900 rounded-lg shadow-2xl"
          onClick={(e) => e.stopPropagation()}
        >
          {/* Header */}
          <div className="sticky top-0 z-10 bg-white dark:bg-neutral-900 border-b border-slate-200 dark:border-neutral-700 px-6 py-4 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div
                className={`p-3 rounded-full ${isPositive ? 'bg-success-50 dark:bg-success-900/20' : 'bg-error-50 dark:bg-error-900/20'}`}
              >
                {isPositive ? (
                  <TrendingUp className="text-success-600 dark:text-success-400" size={28} />
                ) : kpi.trend === 'stable' ? (
                  <Minus className="text-slate-600 dark:text-neutral-400" size={28} />
                ) : (
                  <TrendingDown className="text-error-600 dark:text-error-400" size={28} />
                )}
              </div>
              <div>
                <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{kpiInfo.title}</h2>
                <p className="text-sm text-slate-600 dark:text-neutral-400 mt-1">{kpi.category} Category</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-neutral-800 transition-colors"
              aria-label="Close modal"
            >
              <X size={24} className="text-slate-600 dark:text-neutral-300" />
            </button>
          </div>

          {/* Content */}
          <div className="p-6 space-y-6">
            {/* Key Metrics Card */}
            <Card>
              <CardContent className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                  <div className="text-center md:text-left">
                    <p className="text-sm text-slate-600 dark:text-neutral-400 mb-1">Current Value</p>
                    <p className="text-3xl font-bold text-primary-950">
                      {kpi.value} {kpi.unit}
                    </p>
                  </div>
                  <div className="text-center md:text-left">
                    <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Target Value</p>
                    <p className="text-3xl font-bold text-gray-700 dark:text-neutral-300">
                      {kpi.target} {kpi.unit}
                    </p>
                  </div>
                  <div className="text-center md:text-left">
                    <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Variance</p>
                    <p
                      className={`text-3xl font-bold ${variance < 0 ? 'text-error-600' : variance > 0 ? 'text-success-600' : 'text-gray-700 dark:text-neutral-300'
                        }`}
                    >
                      {variance > 0 ? '+' : ''}
                      {variance} {kpi.unit}
                    </p>
                  </div>
                  <div className="text-center md:text-left">
                    <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Status</p>
                    <p
                      className={`text-lg font-semibold ${isPositive ? 'text-success-600' : 'text-error-600'
                        }`}
                    >
                      {isPositive ? 'On Track' : 'Needs Attention'}
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Description Card */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <BarChart3 size={20} />
                  Overview
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <p className="text-slate-700 dark:text-neutral-300 leading-relaxed">{kpiInfo.description}</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-200 dark:border-neutral-700">
                  {kpiInfo.details.map((detail, index) => (
                    <div key={index} className="flex items-start gap-2">
                      <div className="w-1.5 h-1.5 rounded-full bg-blue-600 mt-2 flex-shrink-0" />
                      <p className="text-sm text-slate-600 dark:text-neutral-400">{detail}</p>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            {/* Charts Row */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Historical Trend */}
              <Card>
                <CardHeader>
                  <CardTitle>Historical Trend (Last 6 Months)</CardTitle>
                </CardHeader>
                <CardContent>
                  <DynamicChart
                    data={historicalData}
                    dataKey="value"
                    height={300}
                    defaultType="line"
                    name="Actual"
                  />
                </CardContent>
              </Card>

              {/* Project Breakdown */}
              {projectData.length > 0 && (
                <Card>
                  <CardHeader>
                    <CardTitle>Project Breakdown</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <DynamicChart
                      data={projectData}
                      dataKey={kpi.category === 'Schedule' ? 'progress' : 'utilization'}
                      height={300}
                      defaultType="bar"
                      name={kpi.category === 'Schedule' ? 'Progress %' : 'Utilization %'}
                    />
                  </CardContent>
                </Card>
              )}
            </div>

            {/* Insights Card */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Target size={20} />
                  Key Insights & Recommendations
                </CardTitle>
              </CardHeader>
              <CardContent>
                <ul className="space-y-3">
                  {kpiInfo.insights.map((insight, index) => (
                    <li key={index} className="flex items-start gap-3">
                      <div className="w-2 h-2 rounded-full bg-blue-600 mt-2 flex-shrink-0" />
                      <p className="text-slate-700 dark:text-neutral-300">{insight}</p>
                    </li>
                  ))}
                </ul>
              </CardContent>
            </Card>

            {/* Metadata Card */}
            <Card>
              <CardContent className="p-6">
                <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-neutral-400">
                  <Calendar size={16} />
                  <span>
                    Last Updated:{' '}
                    {new Date(kpi.lastUpdated).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                    })}
                  </span>
                </div>
              </CardContent>
            </Card>
          </div>
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );

  return createPortal(modalContent, document.body);
};



================================================
FILE: frontend/src/components/dashboard/MilestonePerformanceCard.jsx
================================================
/**
 * MilestonePerformanceCard - Dashboard widget showing physical vs financial progress
 * 
 * Implements the "No Money Without Time" visualization:
 * - Compares actual physical progress (from schedule) with financial spend (from bills)
 * - Flags overspend situations (financial > physical)
 */
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Target, TrendingUp, TrendingDown, AlertTriangle, CheckCircle, Loader2 } from 'lucide-react';
import { MotionCard, MotionCardContent, MotionCardHeader, MotionCardTitle } from '@/components/ui/MotionCard';
import financeService from '@/services/financeService';

const MilestonePerformanceCard = ({ projectId, projectName }) => {
    const [milestones, setMilestones] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    useEffect(() => {
        if (projectId) {
            fetchData();
        }
    }, [projectId]);

    const fetchData = async () => {
        setLoading(true);
        setError(null);
        try {
            // Fetch milestones (tasks marked as milestones)
            const tasksData = await financeService.getScheduleTasks(projectId);
            const milestonesOnly = tasksData.filter(t => t.is_milestone);

            // Fetch budget allocations
            const budgetsData = await financeService.getBudgets(projectId);

            // Fetch bills
            const billsData = await financeService.getBills(projectId);

            // Calculate financial spend per milestone
            const spendByMilestone = {};
            billsData.forEach(b => {
                if (b.milestoneId) {
                    spendByMilestone[b.milestoneId] = (spendByMilestone[b.milestoneId] || 0) + (b.netPayable || 0);
                }
            });

            // Calculate budget per milestone
            const budgetByMilestone = {};
            budgetsData.forEach(b => {
                if (b.milestone) {
                    budgetByMilestone[b.milestone] = (budgetByMilestone[b.milestone] || 0) + parseFloat(b.amount || 0);
                }
            });

            // Combine data
            const enhancedMilestones = milestonesOnly
                .filter(m => budgetByMilestone[m.id] > 0) // Only show milestones with budget
                .map(m => {
                    const budget = budgetByMilestone[m.id] || 0;
                    const spent = spendByMilestone[m.id] || 0;
                    const physicalProgress = m.progress || 0;
                    const financialProgress = budget > 0 ? (spent / budget) * 100 : 0;
                    const variance = physicalProgress - financialProgress;

                    return {
                        id: m.id,
                        name: m.name,
                        physicalProgress,
                        financialProgress: Math.min(financialProgress, 100),
                        budget,
                        spent,
                        variance,
                        status: variance >= 0 ? 'healthy' : variance > -10 ? 'caution' : 'overspend'
                    };
                })
                .sort((a, b) => a.variance - b.variance); // Show overspend first

            setMilestones(enhancedMilestones);
        } catch (err) {
            console.error('Failed to fetch milestone performance:', err);
            setError('Failed to load data');
        } finally {
            setLoading(false);
        }
    };

    const formatCurrency = (val) => {
        if (val >= 10000000) return `â‚¹${(val / 10000000).toFixed(1)} Cr`;
        if (val >= 100000) return `â‚¹${(val / 100000).toFixed(1)} L`;
        return `â‚¹${val.toLocaleString('en-IN')}`;
    };

    const getStatusColor = (status) => {
        switch (status) {
            case 'healthy': return 'text-green-600 bg-green-50';
            case 'caution': return 'text-amber-600 bg-amber-50';
            case 'overspend': return 'text-red-600 bg-red-50';
            default: return 'text-slate-600 bg-slate-50';
        }
    };

    const getStatusIcon = (status) => {
        switch (status) {
            case 'healthy': return <CheckCircle size={14} />;
            case 'caution': return <TrendingUp size={14} />;
            case 'overspend': return <AlertTriangle size={14} />;
            default: return <Target size={14} />;
        }
    };

    if (loading) {
        return (
            <MotionCard className="shadow-lg">
                <MotionCardContent className="p-8 flex items-center justify-center">
                    <Loader2 className="w-6 h-6 animate-spin text-primary-600" />
                </MotionCardContent>
            </MotionCard>
        );
    }

    if (error || milestones.length === 0) {
        return (
            <MotionCard className="shadow-lg border-l-4 border-l-slate-300">
                <MotionCardHeader>
                    <MotionCardTitle className="flex items-center gap-2">
                        <Target size={18} className="text-slate-500" />
                        Milestone Performance
                    </MotionCardTitle>
                </MotionCardHeader>
                <MotionCardContent className="p-6 text-center text-slate-500">
                    {error || 'No milestones with budget allocations found'}
                </MotionCardContent>
            </MotionCard>
        );
    }

    const overspendCount = milestones.filter(m => m.status === 'overspend').length;

    return (
        <MotionCard className={`shadow-lg border-l-4 ${overspendCount > 0 ? 'border-l-red-500' : 'border-l-green-500'}`}>
            <MotionCardHeader className="pb-3">
                <div className="flex justify-between items-center">
                    <MotionCardTitle className="flex items-center gap-2">
                        <Target size={18} className={overspendCount > 0 ? 'text-red-500' : 'text-green-500'} />
                        Milestone Performance
                    </MotionCardTitle>
                    {overspendCount > 0 && (
                        <span className="px-2 py-1 bg-red-100 text-red-700 text-xs font-medium rounded-full flex items-center gap-1">
                            <AlertTriangle size={12} />
                            {overspendCount} Overspend
                        </span>
                    )}
                </div>
                <p className="text-xs text-slate-500 mt-1">Physical Progress vs Financial Spend</p>
            </MotionCardHeader>
            <MotionCardContent className="p-4 pt-0 space-y-3 max-h-[300px] overflow-y-auto">
                {milestones.slice(0, 5).map((m, idx) => (
                    <motion.div
                        key={m.id}
                        initial={{ opacity: 0, x: -10 }}
                        animate={{ opacity: 1, x: 0 }}
                        transition={{ delay: idx * 0.1 }}
                        className={`p-3 rounded-lg border ${m.status === 'overspend' ? 'border-red-200 dark:border-red-800 bg-red-50/50 dark:bg-red-900/20' : m.status === 'caution' ? 'border-amber-200 dark:border-amber-800 bg-amber-50/50 dark:bg-amber-900/20' : 'border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800'}`}
                    >
                        <div className="flex justify-between items-start mb-2">
                            <span className="font-medium text-sm text-slate-800 dark:text-white line-clamp-1 flex-1">{m.name}</span>
                            <span className={`ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold flex items-center gap-1 ${getStatusColor(m.status)}`}>
                                {getStatusIcon(m.status)}
                                {m.status === 'overspend' ? 'Over' : m.status === 'caution' ? 'Watch' : 'OK'}
                            </span>
                        </div>

                        {/* Dual Progress Bars */}
                        <div className="space-y-1.5">
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] text-slate-500 w-14">Physical</span>
                                <div className="flex-1 h-2 bg-slate-200 dark:bg-neutral-700 rounded-full overflow-hidden">
                                    <motion.div
                                        className="h-full bg-blue-500"
                                        initial={{ width: 0 }}
                                        animate={{ width: `${m.physicalProgress}%` }}
                                        transition={{ duration: 0.5, delay: idx * 0.1 }}
                                    />
                                </div>
                                <span className="text-[10px] font-mono text-slate-700 dark:text-slate-300 w-10 text-right">{m.physicalProgress}%</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] text-slate-500 w-14">Financial</span>
                                <div className="flex-1 h-2 bg-slate-200 dark:bg-neutral-700 rounded-full overflow-hidden">
                                    <motion.div
                                        className={`h-full ${m.status === 'overspend' ? 'bg-red-500' : m.status === 'caution' ? 'bg-amber-500' : 'bg-green-500'}`}
                                        initial={{ width: 0 }}
                                        animate={{ width: `${m.financialProgress}%` }}
                                        transition={{ duration: 0.5, delay: idx * 0.1 + 0.1 }}
                                    />
                                </div>
                                <span className="text-[10px] font-mono text-slate-700 dark:text-slate-300 w-10 text-right">{m.financialProgress.toFixed(0)}%</span>
                            </div>
                        </div>

                        {/* Budget Summary */}
                        <div className="mt-2 pt-2 border-t border-slate-100 dark:border-neutral-700 flex justify-between text-[10px] text-slate-500 dark:text-slate-400">
                            <span>Budget: {formatCurrency(m.budget)}</span>
                            <span>Spent: {formatCurrency(m.spent)}</span>
                        </div>
                    </motion.div>
                ))}

                {milestones.length > 5 && (
                    <p className="text-xs text-center text-slate-400 pt-2">
                        +{milestones.length - 5} more milestones
                    </p>
                )}
            </MotionCardContent>
        </MotionCard>
    );
};

export default MilestonePerformanceCard;



================================================
FILE: frontend/src/components/dashboard/MiniCalendarWidget.jsx
================================================
import { useState } from 'react';
import { motion } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import { ChevronLeft, ChevronRight, Calendar } from 'lucide-react';

/**
 * Mini Calendar Widget
 * Displays current month with milestone dates highlighted
 * Click on dates with milestones to view details
 */
const MiniCalendarWidget = ({ milestones = [], onDateClick }) => {
    const navigate = useNavigate();
    const [currentDate, setCurrentDate] = useState(new Date());

    const today = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();

    // Get first day of month and total days
    const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    // Convert milestones to date set for quick lookup
    const milestoneDates = new Set(
        milestones
            .filter(m => m.date)
            .map(m => {
                const d = new Date(m.date);
                return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
            })
    );

    const hasMilestone = (day) => {
        return milestoneDates.has(`${currentYear}-${currentMonth}-${day}`);
    };

    const isToday = (day) => {
        return today.getDate() === day &&
            today.getMonth() === currentMonth &&
            today.getFullYear() === currentYear;
    };

    const prevMonth = () => {
        setCurrentDate(new Date(currentYear, currentMonth - 1, 1));
    };

    const nextMonth = () => {
        setCurrentDate(new Date(currentYear, currentMonth + 1, 1));
    };

    const handleDateClick = (day) => {
        if (hasMilestone(day)) {
            if (onDateClick) {
                onDateClick(new Date(currentYear, currentMonth, day));
            } else {
                navigate('/scheduling');
            }
        }
    };

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];

    // Generate calendar grid
    const calendarDays = [];
    for (let i = 0; i < firstDayOfMonth; i++) {
        calendarDays.push(null);
    }
    for (let day = 1; day <= daysInMonth; day++) {
        calendarDays.push(day);
    }

    return (
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="relative overflow-hidden rounded-2xl bg-white/90 dark:bg-neutral-900/90 backdrop-blur-xl border border-slate-200 dark:border-neutral-700 shadow-sm dark:shadow-lg p-5"
        >
            <div className="absolute inset-0 bg-gradient-to-br from-white/10 dark:from-white/5 via-transparent to-transparent pointer-events-none" />

            {/* Header */}
            <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                    <Calendar size={18} className="text-blue-600 dark:text-indigo-400" />
                    <h3 className="text-md font-semibold text-slate-800 dark:text-white">
                        {monthNames[currentMonth]} {currentYear}
                    </h3>
                </div>
                <div className="flex items-center gap-1">
                    <button
                        onClick={prevMonth}
                        className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded transition-colors"
                    >
                        <ChevronLeft size={18} className="text-slate-500 dark:text-neutral-400" />
                    </button>
                    <button
                        onClick={nextMonth}
                        className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded transition-colors"
                    >
                        <ChevronRight size={18} className="text-slate-500 dark:text-neutral-400" />
                    </button>
                </div>
            </div>

            {/* Day names */}
            <div className="grid grid-cols-7 gap-1 mb-2">
                {dayNames.map((day, i) => (
                    <div className="text-center text-xs font-medium text-slate-400 dark:text-neutral-500 py-1">
                        {day}
                    </div>
                ))}
            </div>

            {/* Calendar grid */}
            <div className="grid grid-cols-7 gap-1">
                {calendarDays.map((day, i) => (
                    <motion.div
                        key={i}
                        whileHover={day && hasMilestone(day) ? { scale: 1.1 } : {}}
                        whileTap={day && hasMilestone(day) ? { scale: 0.95 } : {}}
                        className={`
                            relative aspect-square flex items-center justify-center text-sm rounded-lg
                            ${!day ? '' : 'cursor-pointer'}
                            ${isToday(day) ? 'bg-primary-500 text-white font-bold' : ''}
                            ${hasMilestone(day) && !isToday(day) ? 'bg-amber-100 text-amber-700 font-medium' : ''}
                            ${!isToday(day) && !hasMilestone(day) && day ? 'text-slate-600 dark:text-neutral-300 hover:bg-slate-50 dark:hover:bg-neutral-800' : ''}
                        `}
                        onClick={() => day && handleDateClick(day)}
                    >
                        {day}
                        {hasMilestone(day) && (
                            <span className="absolute bottom-0.5 left-1/2 transform -translate-x-1/2 w-1 h-1 rounded-full bg-amber-500" />
                        )}
                    </motion.div>
                ))}
            </div>

            {/* Legend */}
            <div className="flex items-center gap-4 mt-4 pt-3 border-t border-slate-100 dark:border-neutral-800">
                <div className="flex items-center gap-1.5">
                    <div className="w-2.5 h-2.5 rounded-full bg-indigo-500" />
                    <span className="text-xs text-slate-500 dark:text-neutral-400">Today</span>
                </div>
                <div className="flex items-center gap-1.5">
                    <div className="w-2.5 h-2.5 rounded-full bg-amber-400" />
                    <span className="text-xs text-slate-500 dark:text-neutral-400">Milestone</span>
                </div>
            </div>
        </motion.div>
    );
};

export default MiniCalendarWidget;



================================================
FILE: frontend/src/components/dashboard/NICDCDashboard.jsx
================================================
import { useState } from 'react';
import { motion } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import { useLanguage } from '@/contexts/LanguageContext';
import { MotionCard, MotionCardContent, MotionCardHeader, MotionCardTitle } from '@/components/ui/MotionCard';
import { Network, MapPin, BarChart3, TrendingUp } from 'lucide-react';
import { CalculationRules } from '@/lib/calculations';
import MetricsDetailModal from '@/components/ui/MetricsDetailModal';
import { DynamicChart } from '@/components/ui/DynamicChart';

const NICDCDashboard = ({ projects }) => {
    const { t } = useLanguage();
    const navigate = useNavigate();
    const [selectedMetric, setSelectedMetric] = useState(null);

    // Calculate total investment (budget)
    const totalInvestment = CalculationRules.calculateTotalProjectBudget(projects.map(p => ({ allocated: p.budget })));

    // Calculate average progress
    const overallCompletion = projects.length > 0
        ? projects.reduce((acc, p) => acc + p.progress, 0) / projects.length
        : 0;

    const formatBudget = (val) => `â‚¹${(Number(val) / 10000000).toFixed(2)} Cr`;

    const handleCardClick = (type) => {
        if (type === 'investment') {
            setSelectedMetric({
                title: 'Total Investment',
                description: "Cumulative capital allocation across all industrial nodes under NICDC purview. Represents the financial scale of infrastructure development including land, utilities, and connectivity projects.",
                items: projects.map(p => ({
                    label: p.name,
                    value: formatBudget(p.budget),
                    onClick: () => {
                        setSelectedMetric(null);
                        navigate(`/projects/${p.id}`);
                    }
                }))
            });
        }
    };

    // Prepare data for the performance matrix (Budget vs Spent)
    const performanceData = projects.map(p => ({
        name: p.name,
        budget: p.budget / 10000000, // Cr
        spent: p.spent / 10000000    // Cr
    }));


    const containerVariants = {
        hidden: { opacity: 0 },
        visible: { opacity: 1, transition: { staggerChildren: 0.1 } }
    };

    return (
        <motion.div variants={containerVariants} initial="hidden" animate="visible" className="space-y-6">
            <div className="bg-slate-800 text-white p-6 rounded-2xl shadow-xl flex items-center justify-between">
                <div>
                    <h2 className="text-2xl font-bold">{t('role.NICDC_HQ')} Central Command</h2>
                    <p className="opacity-80">National Industrial Corridor Development Corporation</p>
                </div>
                <Network size={32} className="opacity-50" />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <MotionCard>
                    <MotionCardContent className="p-6 flex items-center gap-4">
                        <div className="p-3 bg-blue-50 rounded-full"><MapPin className="text-blue-600" /></div>
                        <div>
                            <p className="text-2xl font-bold dark:text-white">{projects.length}</p>
                            <p className="text-sm text-slate-500 dark:text-neutral-400">Integrated Nodes</p>
                        </div>
                    </MotionCardContent>
                </MotionCard>
                <MotionCard
                    onClick={() => handleCardClick('investment')}
                    className="cursor-pointer hover:shadow-lg transition-shadow border-l-4 border-l-emerald-500"
                >
                    <MotionCardContent className="p-6 flex items-center gap-4">
                        <div className="p-3 bg-emerald-50 rounded-full"><BarChart3 className="text-emerald-600" /></div>
                        <div>
                            <p className="text-2xl font-bold text-slate-800 dark:text-white">{formatBudget(totalInvestment)}</p>
                            <p className="text-sm text-slate-500 dark:text-neutral-400">Total Investment</p>
                            <p className="text-xs text-emerald-600 flex items-center mt-1">
                                <TrendingUp size={12} className="mr-1" /> Approved
                            </p>
                        </div>
                    </MotionCardContent>
                </MotionCard>
                <MotionCard>
                    <MotionCardContent className="p-6 flex items-center gap-4">
                        <div className="p-3 bg-purple-50 rounded-full"><Network className="text-purple-600" /></div>
                        <div>
                            <p className="text-2xl font-bold dark:text-white">{overallCompletion.toFixed(1)}%</p>
                            <p className="text-sm text-slate-500 dark:text-neutral-400">Overall Completion</p>
                        </div>
                    </MotionCardContent>
                </MotionCard>
            </div>

            <MotionCard>
                <MotionCardHeader>
                    <MotionCardTitle>Node Performance Matrix (Budget vs Spent)</MotionCardTitle>
                </MotionCardHeader>
                <MotionCardContent>
                    <div className="h-80 w-full">
                        <DynamicChart
                            data={performanceData}
                            dataKey="budget"
                            name="Budget (Cr)"
                            height={320}
                            defaultType="bar"
                            colors={['#10b981', '#3b82f6']} // Emerald (Budget), Blue (Spent) - visualizing Budget for now
                        />
                    </div>
                </MotionCardContent>
            </MotionCard>

            <MetricsDetailModal
                isOpen={!!selectedMetric}
                onClose={() => setSelectedMetric(null)}
                title={selectedMetric?.title}
                description={selectedMetric?.description}
                items={selectedMetric?.items}
            />
        </motion.div>
    );
};

export default NICDCDashboard;



================================================
FILE: frontend/src/components/dashboard/PhaseProgressCard.jsx
================================================
import { motion } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import { ChevronRight } from 'lucide-react';

/**
 * Phase Progress Card
 * Displays project phases with horizontal progress bars
 * Each phase is clickable and shows completion percentage
 */
const PhaseProgressCard = ({
    title = "Progress by Phase",
    phases = [],
    onPhaseClick
}) => {
    const navigate = useNavigate();

    // Default phases if none provided
    const defaultPhases = [
        { id: 'design', name: 'Design', progress: 0, color: '#3b82f6' },
        { id: 'procurement', name: 'Procurement', progress: 0, color: '#8b5cf6' },
        { id: 'construction', name: 'Construction', progress: 0, color: '#f59e0b' },
        { id: 'testing', name: 'Testing', progress: 0, color: '#10b981' },
        { id: 'closeout', name: 'Closeout', progress: 0, color: '#64748b' }
    ];

    const displayPhases = phases.length > 0 ? phases : defaultPhases;

    const handlePhaseClick = (phase) => {
        if (onPhaseClick) {
            onPhaseClick(phase);
        } else {
            navigate('/projects');
        }
    };

    return (
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="relative overflow-hidden rounded-2xl bg-white/90 dark:bg-neutral-900/90 backdrop-blur-xl border border-slate-200 dark:border-neutral-700 shadow-sm dark:shadow-lg p-6"
        >
            <div className="absolute inset-0 bg-gradient-to-br from-white/10 dark:from-white/5 via-transparent to-transparent pointer-events-none" />

            <div className="flex items-center justify-between mb-5">
                <h3 className="text-lg font-semibold text-slate-800 dark:text-white">{title}</h3>
                <button
                    className="text-sm text-blue-600 dark:text-indigo-400 hover:text-blue-700 dark:hover:text-indigo-300 font-medium flex items-center gap-1"
                    onClick={() => navigate('/projects')}
                >
                    View All <ChevronRight size={16} />
                </button>
            </div>

            <div className="space-y-4">
                {displayPhases.map((phase, index) => (
                    <motion.div
                        key={phase.id || index}
                        initial={{ opacity: 0, x: -20 }}
                        animate={{ opacity: 1, x: 0 }}
                        transition={{ delay: index * 0.1 }}
                        className="group cursor-pointer"
                        onClick={() => handlePhaseClick(phase)}
                    >
                        <div className="flex items-center justify-between mb-1">
                            <span className="text-sm font-medium text-slate-700 dark:text-neutral-200 group-hover:text-slate-900 dark:group-hover:text-white transition-colors">
                                {phase.name}
                            </span>
                            <span
                                className="text-sm font-bold"
                                style={{ color: phase.color }}
                            >
                                {phase.progress}%
                            </span>
                        </div>
                        <div className="h-2.5 bg-slate-100 dark:bg-neutral-800 rounded-full overflow-hidden">
                            <motion.div
                                className="h-full rounded-full"
                                style={{ backgroundColor: phase.color }}
                                initial={{ width: 0 }}
                                animate={{ width: `${phase.progress}%` }}
                                transition={{ duration: 1, delay: index * 0.1, ease: "easeOut" }}
                            />
                        </div>
                    </motion.div>
                ))}
            </div>

            {displayPhases.length === 0 && (
                <p className="text-center text-slate-400 dark:text-neutral-500 text-sm py-4">No phase data available</p>
            )}
        </motion.div>
    );
};

export default PhaseProgressCard;



================================================
FILE: frontend/src/components/dashboard/PMNCDashboard.jsx
================================================
import { useState } from 'react';
import { motion } from 'framer-motion';
import { useLanguage } from '@/contexts/LanguageContext';
import { MotionCard, MotionCardContent, MotionCardHeader, MotionCardTitle } from '@/components/ui/MotionCard';
import { DynamicChart } from '@/components/ui/DynamicChart';
import { ClipboardList, Clock, AlertOctagon, TrendingUp, CheckSquare } from 'lucide-react';
import { CalculationRules } from '@/lib/calculations';
import MetricsDetailModal from '@/components/ui/MetricsDetailModal';

const PMNCDashboard = ({ projects, tasks, risks }) => {
    const { t } = useLanguage();
    const [selectedMetric, setSelectedMetric] = useState(null);

    const containerVariants = {
        hidden: { opacity: 0 },
        visible: { opacity: 1, transition: { staggerChildren: 0.1 } }
    };

    const itemVariants = {
        hidden: { opacity: 0, scale: 0.95 },
        visible: { opacity: 1, scale: 1 }
    };

    // PMNC Focus: Schedule Variance, Risk Heatmap, Action Items
    const delayedTasks = tasks.filter(task => {
        if (task.status === 'In Progress' || task.status === 'Not Started') {
            return new Date(task.endDate) < new Date();
        }
        return false;
    });

    const activeRiskCount = CalculationRules.filterRisks(risks, 'all', 'Open').length;
    const completedTasksCount = tasks.filter(t => t.status === 'Completed').length;
    const totalTasksCount = tasks.length;

    const handleCardClick = (type) => {
        let data = { title: '', description: '', items: [] };
        switch (type) {
            case 'delayed':
                data = {
                    title: t('common.delayed'),
                    description: "Tasks that have exceeded their planned end date. These items are on the critical path and may impact the overall project completion if not addressed immediately.",
                    items: delayedTasks.map(t => ({ label: t.name, value: `Due: ${t.endDate} ` }))
                }
                break;
            case 'risks':
                data = {
                    title: t('risk.activeRisks'),
                    description: "All currently open risks across the program. This necessitates active monitoring and execution of mitigation plans.",
                    items: risks.slice(0, 5).map(r => ({ label: r.title, value: r.impact }))
                }
                break;
            case 'completed':
                data = {
                    title: t('common.completed'),
                    description: "Milestones and tasks that have been successfully verified and closed.",
                    items: tasks.filter(t => t.status === 'Completed').slice(0, 5).map(t => ({ label: t.name, value: 'Done' }))
                }
                break;
            case 'evm':
                data = {
                    title: 'Earned Value Management',
                    description: "Detailed analysis of Planned Value (PV), Earned Value (EV), and Actual Cost (AC) to measure project performance.",
                    items: [
                        { label: 'SPI (Schedule Performance Index)', value: '0.92' },
                        { label: 'CPI (Cost Performance Index)', value: '1.05' }
                    ]
                }
                break;
            default: return;
        }
        setSelectedMetric(data);
    }

    return (
        <>
            <motion.div variants={containerVariants} initial="hidden" animate="visible" className="space-y-6">
                <motion.div variants={itemVariants}>
                    <h2 className="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                        {t('role.PMNC_Team')} {t('sidebar.programmeManagement')}
                    </h2>
                    <p className="text-slate-500">Project Management & Network Control Center</p>
                </motion.div>

                {/* PMNC KPI Bar */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <MotionCard
                        variants={itemVariants}
                        whileHover={{ scale: 1.02 }}
                        onClick={() => handleCardClick('delayed')}
                        className="bg-white dark:bg-neutral-900 border-l-4 border-indigo-500 cursor-pointer"
                    >
                        <MotionCardContent className="p-4 flex items-center gap-4">
                            <div className="p-3 bg-indigo-50 rounded-full">
                                <Clock className="text-indigo-600" size={24} />
                            </div>
                            <div>
                                <p className="text-sm text-slate-500">{t('common.delayed')}</p>
                                <p className="text-xl font-bold text-slate-800 dark:text-white">
                                    {delayedTasks.length > 0 ? `- ${delayedTasks.length} ${t('dashboard.upcomingTasks')} ` : t('common.onTrack')}
                                </p>
                            </div>
                        </MotionCardContent>
                    </MotionCard>

                    <MotionCard
                        variants={itemVariants}
                        whileHover={{ scale: 1.02 }}
                        onClick={() => handleCardClick('risks')}
                        className="bg-white dark:bg-neutral-900 border-l-4 border-amber-500 cursor-pointer"
                    >
                        <MotionCardContent className="p-4 flex items-center gap-4">
                            <div className="p-3 bg-amber-50 rounded-full">
                                <AlertOctagon className="text-amber-600" size={24} />
                            </div>
                            <div>
                                <p className="text-sm text-slate-500">{t('risk.activeRisks')}</p>
                                <p className="text-xl font-bold text-slate-800 dark:text-white">{activeRiskCount}</p>
                            </div>
                        </MotionCardContent>
                    </MotionCard>

                    <MotionCard variants={itemVariants} className="bg-white dark:bg-neutral-900 border-l-4 border-cyan-500">
                        <MotionCardContent className="p-4 flex items-center gap-4">
                            <div className="p-3 bg-cyan-50 rounded-full">
                                <ClipboardList className="text-cyan-600" size={24} />
                            </div>
                            <div>
                                <p className="text-sm text-slate-500">Open RFIs</p>
                                <p className="text-xl font-bold text-slate-800 dark:text-white">8</p>
                            </div>
                        </MotionCardContent>
                    </MotionCard>

                    <MotionCard
                        variants={itemVariants}
                        whileHover={{ scale: 1.02 }}
                        onClick={() => handleCardClick('completed')}
                        className="bg-white dark:bg-neutral-900 border-l-4 border-emerald-500 cursor-pointer"
                    >
                        <MotionCardContent className="p-4 flex items-center gap-4">
                            <div className="p-3 bg-emerald-50 rounded-full">
                                <CheckSquare className="text-emerald-600" size={24} />
                            </div>
                            <div>
                                <p className="text-sm text-slate-500">{t('common.completed')}</p>
                                <p className="text-xl font-bold text-slate-800 dark:text-white">{completedTasksCount}/{totalTasksCount}</p>
                            </div>
                        </MotionCardContent>
                    </MotionCard>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <MotionCard
                        variants={itemVariants}
                        className="lg:col-span-2 cursor-pointer hover:shadow-lg transition-shadow"
                        onClick={() => handleCardClick('evm')}
                    >
                        <MotionCardHeader>
                            <MotionCardTitle>Earned Value Analysis (EVM)</MotionCardTitle>
                        </MotionCardHeader>
                        <MotionCardContent>
                            {/* Mock EVM Chart - In real app, this would use time-series data from backend */}
                            <DynamicChart
                                data={[
                                    { name: 'Month 1', pv: 100, ev: 90, ac: 95 },
                                    { name: 'Month 2', pv: 200, ev: 190, ac: 210 },
                                    { name: 'Month 3', pv: 300, ev: 280, ac: 320 },
                                    { name: 'Month 4', pv: 400, ev: 390, ac: 410 },
                                ]}
                                dataKey="ev"
                                height={300}
                                defaultType="line"
                                colors={['#8b5cf6', '#10b981', '#f43f5e']}
                            />
                            <div className="flex justify-center gap-4 mt-2 text-sm">
                                <span className="flex items-center gap-1"><div className="w-3 h-3 bg-violet-500 rounded-full"></div> EV ({t('common.progress')})</span>
                                <span className="flex items-center gap-1"><div className="w-3 h-3 bg-emerald-500 rounded-full"></div> PV ({t('common.planning')})</span>
                                <span className="flex items-center gap-1"><div className="w-3 h-3 bg-rose-500 rounded-full"></div> AC ({t('cost.actual')})</span>
                            </div>
                        </MotionCardContent>
                    </MotionCard>

                    <MotionCard variants={itemVariants}>
                        <MotionCardHeader>
                            <MotionCardTitle>Compliance Status</MotionCardTitle>
                        </MotionCardHeader>
                        <MotionCardContent>
                            <div className="space-y-4">
                                <div className="flex justify-between items-center p-3 bg-slate-50 dark:bg-neutral-800 rounded-lg">
                                    <span className="text-sm font-medium">Safety Audits</span>
                                    <span className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">{t('common.approved')}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 dark:bg-neutral-800 rounded-lg">
                                    <span className="text-sm font-medium">Quality Checks</span>
                                    <span className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">98% Pass</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-sm font-medium">Env. Clearance</span>
                                    <span className="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full">{t('common.underReview')}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-sm font-medium">Labor Compliance</span>
                                    <span className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">{t('common.approved')}</span>
                                </div>
                            </div>
                        </MotionCardContent>
                    </MotionCard>
                </div>
            </motion.div>

            <MetricsDetailModal
                isOpen={!!selectedMetric}
                onClose={() => setSelectedMetric(null)}
                title={selectedMetric?.title}
                description={selectedMetric?.description}
                items={selectedMetric?.items}
            />
        </>
    );
};

export default PMNCDashboard;



================================================
FILE: frontend/src/components/dashboard/ProjectCalendar.jsx
================================================
/**
 * Project Calendar Widget
 * 
 * Displays aggregated events from multiple modules in a calendar/list view.
 * Supports milestones, billing, risks, compliance, and workflow events.
 */
import { useState, useEffect, useMemo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    Calendar, ChevronLeft, ChevronRight, Clock, AlertTriangle,
    CheckCircle, DollarSign, Shield, Workflow, CalendarDays,
    Filter, ChevronDown, ExternalLink
} from 'lucide-react';
import { calendarService, EVENT_COLORS, getEventTypeLabel } from '@/api/services/calendarService';

const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'];

const EventIcon = ({ type, size = 14 }) => {
    const icons = {
        MILESTONE: Calendar,
        BILLING: DollarSign,
        RISK: AlertTriangle,
        COMPLIANCE: Shield,
        WORKFLOW: Workflow,
        MEETING: CalendarDays
    };
    const Icon = icons[type] || Calendar;
    return <Icon size={size} />;
};

const EventBadge = ({ event, onClick }) => (
    <motion.div
        initial={{ scale: 0.8, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        whileHover={{ scale: 1.05 }}
        onClick={() => onClick?.(event)}
        className={`flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-medium cursor-pointer truncate ${event.is_overdue
                ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'
                : 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300'
            }`}
        style={{
            borderLeft: `3px solid ${event.color || EVENT_COLORS[event.type] || '#6b7280'}`,
        }}
        title={event.title}
    >
        <EventIcon type={event.type} size={12} />
        <span className="truncate">{event.title}</span>
    </motion.div>
);

const EventCard = ({ event, onClose }) => (
    <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: -10 }}
        className="absolute z-50 p-4 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-gray-200 dark:border-slate-700 w-72 right-0 top-full mt-2"
    >
        <div className="flex items-start justify-between mb-3">
            <div className="flex items-center gap-2">
                <div
                    className="w-10 h-10 rounded-lg flex items-center justify-center"
                    style={{ backgroundColor: `${event.color || EVENT_COLORS[event.type]}20` }}
                >
                    <EventIcon type={event.type} size={20} style={{ color: event.color || EVENT_COLORS[event.type] }} />
                </div>
                <div>
                    <span className="text-xs font-medium text-gray-500 dark:text-gray-400">
                        {getEventTypeLabel(event.type)}
                    </span>
                    <h4 className="font-semibold text-gray-900 dark:text-white text-sm line-clamp-2">
                        {event.title}
                    </h4>
                </div>
            </div>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">Ã—</button>
        </div>

        <div className="space-y-2 text-sm">
            {event.project_name && (
                <div className="flex items-center gap-2 text-gray-600 dark:text-gray-300">
                    <Calendar size={14} />
                    <span>{event.project_name}</span>
                </div>
            )}
            <div className="flex items-center gap-2 text-gray-600 dark:text-gray-300">
                <Clock size={14} />
                <span>{new Date(event.start).toLocaleDateString()}</span>
            </div>
            {event.status && (
                <div className="flex items-center gap-2">
                    <CheckCircle size={14} className={event.is_overdue ? 'text-red-500' : 'text-green-500'} />
                    <span className={event.is_overdue ? 'text-red-600' : 'text-gray-600 dark:text-gray-300'}>
                        {event.is_overdue ? 'Overdue' : event.status}
                    </span>
                </div>
            )}
        </div>

        {event.link_url && (
            <a
                href={event.link_url}
                className="mt-3 flex items-center gap-1 text-primary-600 hover:text-primary-700 text-sm font-medium"
            >
                View Details <ExternalLink size={12} />
            </a>
        )}
    </motion.div>
);

const CalendarDay = ({ date, events, isToday, isCurrentMonth, onEventClick }) => {
    const dayEvents = events.slice(0, 3);
    const moreCount = events.length - 3;

    return (
        <div className={`min-h-[80px] p-1 border-b border-r border-gray-100 dark:border-slate-700 ${!isCurrentMonth ? 'bg-gray-50 dark:bg-slate-800/50' : ''
            }`}>
            <div className={`text-xs font-medium mb-1 ${isToday
                    ? 'w-6 h-6 rounded-full bg-primary-600 text-white flex items-center justify-center'
                    : isCurrentMonth ? 'text-gray-700 dark:text-gray-300' : 'text-gray-400 dark:text-gray-600'
                }`}>
                {date.getDate()}
            </div>
            <div className="space-y-0.5">
                {dayEvents.map((event, idx) => (
                    <EventBadge key={event.id || idx} event={event} onClick={onEventClick} />
                ))}
                {moreCount > 0 && (
                    <div className="text-xs text-gray-500 dark:text-gray-400 pl-1">
                        +{moreCount} more
                    </div>
                )}
            </div>
        </div>
    );
};

const ProjectCalendar = ({ height = 400, showFilters = true }) => {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [events, setEvents] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedEvent, setSelectedEvent] = useState(null);
    const [view, setView] = useState('month'); // 'month' | 'list'
    const [filters, setFilters] = useState({
        event_types: []
    });
    const [showFilterDropdown, setShowFilterDropdown] = useState(false);

    // Fetch events when month changes
    useEffect(() => {
        fetchEvents();
    }, [currentDate, filters]);

    const fetchEvents = async () => {
        try {
            setLoading(true);
            const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const end = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0);

            const data = await calendarService.getEvents(
                start.toISOString().split('T')[0],
                end.toISOString().split('T')[0],
                filters
            );
            setEvents(data.events || []);
        } catch (error) {
            console.error('Failed to fetch calendar events:', error);
        } finally {
            setLoading(false);
        }
    };

    // Navigate between months
    const navigate = (direction) => {
        const newDate = new Date(currentDate);
        newDate.setMonth(newDate.getMonth() + direction);
        setCurrentDate(newDate);
    };

    // Generate calendar grid
    const calendarGrid = useMemo(() => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const grid = [];
        const current = new Date(startDate);

        while (current <= lastDay || grid.length < 35) {
            grid.push(new Date(current));
            current.setDate(current.getDate() + 1);
            if (grid.length >= 42) break; // Max 6 weeks
        }

        return grid;
    }, [currentDate]);

    // Group events by date
    const eventsByDate = useMemo(() => {
        const grouped = {};
        events.forEach(event => {
            const dateKey = event.start?.split('T')[0];
            if (dateKey) {
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(event);
            }
        });
        return grouped;
    }, [events]);

    // Upcoming events for list view
    const upcomingEvents = useMemo(() => {
        const today = new Date().toISOString().split('T')[0];
        return events
            .filter(e => e.start >= today)
            .sort((a, b) => new Date(a.start) - new Date(b.start))
            .slice(0, 10);
    }, [events]);

    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    const eventTypes = ['MILESTONE', 'BILLING', 'RISK', 'COMPLIANCE', 'WORKFLOW'];

    const toggleFilter = (type) => {
        setFilters(prev => {
            const types = prev.event_types.includes(type)
                ? prev.event_types.filter(t => t !== type)
                : [...prev.event_types, type];
            return { ...prev, event_types: types };
        });
    };

    return (
        <div className="bg-white dark:bg-slate-900 rounded-xl border border-gray-200 dark:border-slate-700 overflow-hidden" style={{ height }}>
            {/* Header */}
            <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-slate-700">
                <div className="flex items-center gap-3">
                    <button
                        onClick={() => navigate(-1)}
                        className="p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 text-gray-600 dark:text-gray-300"
                    >
                        <ChevronLeft size={18} />
                    </button>
                    <h3 className="font-semibold text-gray-900 dark:text-white min-w-[140px] text-center">
                        {MONTHS[currentDate.getMonth()]} {currentDate.getFullYear()}
                    </h3>
                    <button
                        onClick={() => navigate(1)}
                        className="p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 text-gray-600 dark:text-gray-300"
                    >
                        <ChevronRight size={18} />
                    </button>
                    <button
                        onClick={() => setCurrentDate(new Date())}
                        className="px-2 py-1 text-xs font-medium text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded"
                    >
                        Today
                    </button>
                </div>

                <div className="flex items-center gap-2">
                    {/* View Toggle */}
                    <div className="flex bg-gray-100 dark:bg-slate-800 rounded-lg p-0.5">
                        <button
                            onClick={() => setView('month')}
                            className={`px-3 py-1 text-xs font-medium rounded ${view === 'month'
                                    ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm'
                                    : 'text-gray-500 dark:text-gray-400'
                                }`}
                        >
                            Month
                        </button>
                        <button
                            onClick={() => setView('list')}
                            className={`px-3 py-1 text-xs font-medium rounded ${view === 'list'
                                    ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm'
                                    : 'text-gray-500 dark:text-gray-400'
                                }`}
                        >
                            List
                        </button>
                    </div>

                    {/* Filters */}
                    {showFilters && (
                        <div className="relative">
                            <button
                                onClick={() => setShowFilterDropdown(!showFilterDropdown)}
                                className="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg"
                            >
                                <Filter size={14} />
                                Filter
                                {filters.event_types.length > 0 && (
                                    <span className="ml-1 px-1.5 py-0.5 bg-primary-100 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300 text-xs rounded-full">
                                        {filters.event_types.length}
                                    </span>
                                )}
                                <ChevronDown size={14} />
                            </button>

                            <AnimatePresence>
                                {showFilterDropdown && (
                                    <motion.div
                                        initial={{ opacity: 0, y: -10 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        exit={{ opacity: 0, y: -10 }}
                                        className="absolute right-0 top-full mt-1 z-50 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-gray-200 dark:border-slate-700 p-2 min-w-[160px]"
                                    >
                                        {eventTypes.map(type => (
                                            <label
                                                key={type}
                                                className="flex items-center gap-2 px-2 py-1.5 hover:bg-gray-50 dark:hover:bg-slate-700 rounded cursor-pointer"
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={filters.event_types.length === 0 || filters.event_types.includes(type)}
                                                    onChange={() => toggleFilter(type)}
                                                    className="rounded text-primary-600"
                                                />
                                                <div className="w-3 h-3 rounded" style={{ backgroundColor: EVENT_COLORS[type] }} />
                                                <span className="text-sm text-gray-700 dark:text-gray-300">
                                                    {getEventTypeLabel(type)}
                                                </span>
                                            </label>
                                        ))}
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    )}
                </div>
            </div>

            {/* Calendar/List Content */}
            <div className="overflow-auto" style={{ height: height - 60 }}>
                {loading ? (
                    <div className="flex items-center justify-center h-full">
                        <div className="animate-spin w-8 h-8 border-2 border-primary-600 border-t-transparent rounded-full" />
                    </div>
                ) : view === 'month' ? (
                    <>
                        {/* Day Headers */}
                        <div className="grid grid-cols-7 border-b border-gray-200 dark:border-slate-700">
                            {DAYS.map(day => (
                                <div key={day} className="py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400">
                                    {day}
                                </div>
                            ))}
                        </div>

                        {/* Calendar Grid */}
                        <div className="grid grid-cols-7">
                            {calendarGrid.map((date, idx) => {
                                const dateStr = date.toISOString().split('T')[0];
                                const dayEvents = eventsByDate[dateStr] || [];
                                const isToday = dateStr === todayStr;
                                const isCurrentMonth = date.getMonth() === currentDate.getMonth();

                                return (
                                    <CalendarDay
                                        key={idx}
                                        date={date}
                                        events={dayEvents}
                                        isToday={isToday}
                                        isCurrentMonth={isCurrentMonth}
                                        onEventClick={setSelectedEvent}
                                    />
                                );
                            })}
                        </div>
                    </>
                ) : (
                    /* List View */
                    <div className="p-4 space-y-3">
                        {upcomingEvents.length === 0 ? (
                            <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                                <CalendarDays size={40} className="mx-auto mb-2 opacity-50" />
                                <p>No upcoming events</p>
                            </div>
                        ) : (
                            upcomingEvents.map(event => (
                                <div
                                    key={event.id}
                                    className="flex items-center gap-3 p-3 bg-gray-50 dark:bg-slate-800 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 cursor-pointer transition-colors"
                                    onClick={() => setSelectedEvent(event)}
                                >
                                    <div
                                        className="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"
                                        style={{ backgroundColor: `${event.color || EVENT_COLORS[event.type]}20` }}
                                    >
                                        <EventIcon
                                            type={event.type}
                                            size={18}
                                            style={{ color: event.color || EVENT_COLORS[event.type] }}
                                        />
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className="font-medium text-gray-900 dark:text-white truncate">
                                            {event.title}
                                        </p>
                                        <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                                            <span>{new Date(event.start).toLocaleDateString()}</span>
                                            {event.project_name && (
                                                <>
                                                    <span>â€¢</span>
                                                    <span className="truncate">{event.project_name}</span>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    {event.is_overdue && (
                                        <span className="px-2 py-0.5 bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300 text-xs font-medium rounded">
                                            Overdue
                                        </span>
                                    )}
                                </div>
                            ))
                        )}
                    </div>
                )}
            </div>

            {/* Event Detail Popup */}
            <AnimatePresence>
                {selectedEvent && (
                    <div className="fixed inset-0 z-50" onClick={() => setSelectedEvent(null)}>
                        <div className="absolute inset-0 bg-black/20" />
                        <div className="absolute top-1/4 left-1/2 -translate-x-1/2" onClick={e => e.stopPropagation()}>
                            <EventCard event={selectedEvent} onClose={() => setSelectedEvent(null)} />
                        </div>
                    </div>
                )}
            </AnimatePresence>
        </div>
    );
};

export default ProjectCalendar;



================================================
FILE: frontend/src/components/dashboard/RadialProgressCard.jsx
================================================
import { motion } from 'framer-motion';
import { useNavigate } from 'react-router-dom';

/**
 * Radial Progress Card
 * Animated circular progress indicator with percentage in center
 * Click to navigate to detailed view
 */
const RadialProgressCard = ({
    label,
    value = 0,
    maxValue = 100,
    color = 'primary',
    size = 'medium',
    subtext,
    navigateTo,
    onClick
}) => {
    const navigate = useNavigate();

    const percentage = Math.min(Math.round((value / maxValue) * 100), 100);

    // Size configurations
    const sizes = {
        small: { width: 80, stroke: 6, fontSize: 'text-lg' },
        medium: { width: 120, stroke: 8, fontSize: 'text-2xl' },
        large: { width: 160, stroke: 10, fontSize: 'text-3xl' }
    };

    const config = sizes[size] || sizes.medium;
    const radius = (config.width - config.stroke) / 2;
    const circumference = 2 * Math.PI * radius;
    const strokeDashoffset = circumference - (percentage / 100) * circumference;

    // Color configurations
    const colors = {
        primary: { stroke: '#6366f1', bg: 'from-primary-50 to-primary-100' },
        emerald: { stroke: '#10b981', bg: 'from-emerald-50 to-emerald-100' },
        blue: { stroke: '#3b82f6', bg: 'from-blue-50 to-blue-100' },
        amber: { stroke: '#f59e0b', bg: 'from-amber-50 to-amber-100' },
        rose: { stroke: '#f43f5e', bg: 'from-rose-50 to-rose-100' },
        violet: { stroke: '#8b5cf6', bg: 'from-violet-50 to-violet-100' }
    };

    const colorConfig = colors[color] || colors.primary;

    const handleClick = () => {
        if (onClick) {
            onClick();
        } else if (navigateTo) {
            navigate(navigateTo);
        }
    };

    return (
        <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            whileHover={{ scale: 1.02 }}
            whileTap={{ scale: 0.98 }}
            className={`
                relative overflow-hidden rounded-2xl
                bg-gradient-to-br ${colorConfig.bg}
                border border-slate-200 dark:border-neutral-700
                shadow-sm dark:shadow-lg
                p-6 cursor-pointer
                transition-all duration-300
            `}
            onClick={handleClick}
        >
            <div className="flex flex-col items-center">
                {/* SVG Circular Progress */}
                <div className="relative" style={{ width: config.width, height: config.width }}>
                    {/* Background circle */}
                    <svg
                        className="transform -rotate-90"
                        width={config.width}
                        height={config.width}
                    >
                        <circle
                            cx={config.width / 2}
                            cy={config.width / 2}
                            r={radius}
                            stroke="rgba(255,255,255,0.5)"
                            strokeWidth={config.stroke}
                            fill="none"
                        />
                        {/* Progress circle */}
                        <motion.circle
                            cx={config.width / 2}
                            cy={config.width / 2}
                            r={radius}
                            stroke={colorConfig.stroke}
                            strokeWidth={config.stroke}
                            fill="none"
                            strokeLinecap="round"
                            strokeDasharray={circumference}
                            initial={{ strokeDashoffset: circumference }}
                            animate={{ strokeDashoffset }}
                            transition={{ duration: 1.5, ease: "easeOut" }}
                        />
                    </svg>

                    {/* Center percentage */}
                    <div className="absolute inset-0 flex items-center justify-center">
                        <motion.span
                            className={`${config.fontSize} font-bold text-slate-800 dark:text-white`}
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            transition={{ delay: 0.5 }}
                        >
                            {percentage}%
                        </motion.span>
                    </div>
                </div>

                {/* Label */}
                <p className="text-sm font-semibold text-slate-700 dark:text-neutral-200 mt-3 text-center">{label}</p>

                {/* Subtext */}
                {subtext && (
                    <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1 text-center">{subtext}</p>
                )}
            </div>
        </motion.div>
    );
};

export default RadialProgressCard;



================================================
FILE: frontend/src/components/dashboard/SPVDashboard.jsx
================================================
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { useLanguage } from '@/contexts/LanguageContext';
import { MotionCard, MotionCardContent, MotionCardHeader, MotionCardTitle } from '@/components/ui/MotionCard';
import { DynamicChart } from '@/components/ui/DynamicChart';
import { TrendingUp, TrendingDown, DollarSign, AlertTriangle, CheckCircle, Activity, FolderOpen } from 'lucide-react';
import { CalculationRules } from '@/lib/calculations';
import MetricsDetailModal from '@/components/ui/MetricsDetailModal';
import GraphAnalysisModal from '@/components/ui/GraphAnalysisModal';
import MilestonePerformanceCard from '@/components/dashboard/MilestonePerformanceCard';
import { useNavigate } from 'react-router-dom';
import client from '@/api/client';

const SPVDashboard = ({ projects, kpis, risks }) => {
  const { t } = useLanguage();
  const navigate = useNavigate();
  const [selectedMetric, setSelectedMetric] = useState(null);
  const [graphModalOpen, setGraphModalOpen] = useState(false);
  const [graphMetric, setGraphMetric] = useState('budget');
  const [pendingApprovalsCount, setPendingApprovalsCount] = useState(0);

  // EDMS Integration - Fetch real pending approvals
  useEffect(() => {
    const fetchStats = async () => {
      try {
        const res = await client.get('/edms/approvals/pending/');
        const docs = Array.isArray(res.data) ? res.data : (res.data.results || []);
        setPendingApprovalsCount(docs.length);
      } catch (err) {
        console.error("Failed to load EDMS stats", err);
      }
    };
    fetchStats();
  }, []);

  // SPV Specific Metrics with Dynamic Calculations
  const runningProjects = projects.filter(p => p.status === 'In Progress');
  const totalBudget = CalculationRules.calculateTotalProjectBudget(runningProjects.map(p => ({ allocated: p.budget })));
  const totalSpent = CalculationRules.calculateTotalProjectSpent(projects.map(p => ({ spent: p.spent })));

  // Dynamic financial data for chart
  const financialData = projects.map(p => ({
    name: p.name,
    budget: p.budget / 10000000, // Convert to Crores
    spent: p.spent / 10000000,
  }));

  const activeProjectsCount = CalculationRules.filterProjectsByStatus(projects, 'In Progress').length;
  const criticalRisksCount = CalculationRules.filterRisks(risks, 'all', 'Open').filter(r => r.impact === 'Critical').length;

  // Format currency helper
  const formatBudget = (val) => `â‚¹${(Number(val) / 10000000).toFixed(2)} Cr`;

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: { opacity: 1, transition: { staggerChildren: 0.1 } }
  };

  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0 }
  };

  const handleCardClick = (metricType) => {
    let data = { title: '', description: '', items: [], documents: [] };

    switch (metricType) {
      case 'budget':
        data = {
          title: t('projects.totalBudget'),
          description: "This represents the total approved capital expenditure for running projects in the Zaheerabad Industrial Area. Click a project to view full details.",
          items: runningProjects.map(p => ({
            label: p.name,
            value: formatBudget(p.budget),
            onClick: () => {
              setSelectedMetric(null); // Close modal
              navigate(`/projects/${p.id}`);
            }
          })),
          documents: [
            { name: 'Annual_Budget_FY24.pdf', date: '21 Oct 2024', type: 'pdf' },
            { name: 'Q3_Expenditure_Report.xlsx', date: '05 Dec 2024', type: 'xlsx' },
            { name: 'Fund_Release_Order_GO_112.pdf', date: '15 Sep 2024', type: 'pdf' }
          ]
        };
        break;
      case 'activeProjects':
        data = {
          title: t('projects.totalProjects'),
          description: "Count of projects currently in the 'In Progress' phase. These projects have passed the planning stage and are actively consuming resources on-site or in design. Click individual projects in the list view for detailed Gantt charts.",
          items: projects.filter(p => p.status === 'In Progress').map(p => ({ label: p.name, value: `${p.progress}% Complete` })),
          documents: [
            { name: 'Master_Project_Schedule_v4.mpp', date: '01 Nov 2024', type: 'mpp' },
            { name: 'Site_Progress_Photos_Nov.zip', date: '30 Nov 2024', type: 'zip' }
          ]
        };
        break;
      case 'approvals':
        data = {
          title: t('common.underReview'),
          description: "Pending administrative approvals required to proceed to the next workflow stage. This primarily includes Budget Approvals, Design Sign-offs, and Contractor Selection validations.",
          items: projects.filter(p => p.status === 'Planning' || p.status === 'Under Review').map(p => ({ label: p.name, value: p.status })),
          documents: [
            { name: 'Pending_Approvals_Log.xlsx', date: 'Today', type: 'xlsx' },
            { name: 'Change_Request_CR005.pdf', date: '02 Dec 2024', type: 'pdf' }
          ]
        };
        break;
      case 'risks':
        data = {
          title: t('risk.activeRisks'),
          description: "Critical risks that have a high probability of occurrence and significant impact on project timeline or cost. Immediate mitigation strategies are required for these items.",
          items: risks.filter(r => r.impact === 'Critical' && r.status !== 'Closed').map(r => ({ label: r.title, value: r.mitigationStrategy || 'No Plan' })),
          documents: [
            { name: 'Risk_Management_Plan.pdf', date: '10 Aug 2024', type: 'pdf' },
            { name: 'Mitigation_Report_Critical.docx', date: '28 Nov 2024', type: 'docx' }
          ]
        };
        break;
      default:
        return;
    }
    setSelectedMetric(data);
  };

  const handleGraphClick = (metric) => {
    setGraphMetric(metric);
    setGraphModalOpen(true);
  }

  return (
    <>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="space-y-6"
      >
        {/* Header Section */}
        <motion.div variants={itemVariants} className="flex justify-between items-center mt-4">
          <div>
            <h2 className="text-2xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent">
              {t('role.SPV_Official')} {t('dashboard.overview')}
            </h2>
            <p className="text-slate-500">{t('dashboard.title')}</p>
          </div>
          <div className="flex gap-2">
            <span className="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-sm font-medium border border-emerald-200">
              {t('common.status')}: Online
            </span>
          </div>
        </motion.div>

        {/* High-Level KPI Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <MotionCard
            variants={itemVariants}
            whileHover={{ y: -5, scale: 1.02 }}
            whileTap={{ scale: 0.98 }}
            onClick={() => handleCardClick('budget')}
            className="bg-gradient-to-br from-white to-slate-50 border-l-4 border-l-emerald-500 cursor-pointer shadow-sm hover:shadow-md transition-all"
          >
            <MotionCardContent className="p-6">
              <div className="flex justify-between items-start">
                <div>
                  <p className="text-sm font-medium text-slate-500">{t('projects.totalBudget')}</p>
                  <h3 className="text-2xl font-bold text-slate-800 dark:text-white mt-2">{formatBudget(totalBudget)}</h3>
                  <p className="text-xs text-emerald-600 flex items-center mt-1">
                    <TrendingUp size={12} className="mr-1" /> {t('common.approved')}
                  </p>
                </div>
                <div className="p-3 bg-emerald-100 rounded-xl">
                  <DollarSign className="text-emerald-600" size={24} />
                </div>
              </div>
            </MotionCardContent>
          </MotionCard>

          <MotionCard
            variants={itemVariants}
            whileHover={{ y: -5, scale: 1.02 }}
            whileTap={{ scale: 0.98 }}
            onClick={() => handleCardClick('activeProjects')}
            className="bg-gradient-to-br from-white to-slate-50 border-l-4 border-l-blue-500 cursor-pointer shadow-sm hover:shadow-md transition-all"
          >
            <MotionCardContent className="p-6">
              <div className="flex justify-between items-start">
                <div>
                  <p className="text-sm font-medium text-slate-500">{t('projects.totalProjects')}</p>
                  <h3 className="text-2xl font-bold text-slate-800 dark:text-white mt-2">{activeProjectsCount}</h3>
                  <p className="text-xs text-blue-600 flex items-center mt-1">
                    <Activity size={12} className="mr-1" /> {t('common.inProgress')}
                  </p>
                </div>
                <div className="p-3 bg-blue-100 rounded-xl">
                  <FolderOpen className="text-blue-600" size={24} />
                </div>
              </div>
            </MotionCardContent>
          </MotionCard>

          <MotionCard
            variants={itemVariants}
            whileHover={{ y: -5, scale: 1.02 }}
            whileTap={{ scale: 0.98 }}
            onClick={() => navigate('/approvals')}
            className="bg-gradient-to-br from-white to-slate-50 border-l-4 border-l-amber-500 cursor-pointer shadow-sm hover:shadow-md transition-all"
          >
            <MotionCardContent className="p-6">
              <div className="flex justify-between items-start">
                <div>
                  <p className="text-sm font-medium text-slate-500">{t('common.underReview')}</p>
                  <h3 className="text-2xl font-bold text-slate-800 dark:text-white mt-2">{pendingApprovalsCount}</h3>
                  <p className="text-xs text-amber-600 flex items-center mt-1">
                    Click to review documents
                  </p>
                </div>
                <div className="p-3 bg-amber-100 rounded-xl">
                  <CheckCircle className="text-amber-600" size={24} />
                </div>
              </div>
            </MotionCardContent>
          </MotionCard>

          <MotionCard
            variants={itemVariants}
            whileHover={{ y: -5, scale: 1.02 }}
            whileTap={{ scale: 0.98 }}
            onClick={() => handleCardClick('risks')}
            className="bg-gradient-to-br from-white to-slate-50 border-l-4 border-l-rose-500 cursor-pointer shadow-sm hover:shadow-md transition-all"
          >
            <MotionCardContent className="p-6">
              <div className="flex justify-between items-start">
                <div>
                  <p className="text-sm font-medium text-slate-500">{t('risk.activeRisks')}</p>
                  <h3 className="text-2xl font-bold text-slate-800 dark:text-white mt-2">
                    {criticalRisksCount}
                  </h3>
                  <p className="text-xs text-rose-600 flex items-center mt-1">
                    <AlertTriangle size={12} className="mr-1" /> {t('priority.critical')}
                  </p>
                </div>
                <div className="p-3 bg-rose-100 rounded-xl">
                  <AlertTriangle className="text-rose-600" size={24} />
                </div>
              </div>
            </MotionCardContent>
          </MotionCard>
        </div>

        {/* Main Content Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <MotionCard
            variants={itemVariants}
            onClick={() => handleGraphClick('budget')}
            className="shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer border border-transparent hover:border-slate-200"
          >
            <MotionCardHeader>
              <MotionCardTitle>{t('dashboard.budgetVsSpent')}</MotionCardTitle>
            </MotionCardHeader>
            <MotionCardContent>
              <DynamicChart
                data={financialData}
                dataKey="budget"
                height={350}
                defaultType="bar"
                colors={['#10b981', '#3b82f6']}
                name={t('projects.budget')}
              />
            </MotionCardContent>
          </MotionCard>

          <MotionCard
            variants={itemVariants}
            onClick={() => handleGraphClick('progress')}
            className="shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer border border-transparent hover:border-slate-200"
          >
            <MotionCardHeader>
              <MotionCardTitle>{t('dashboard.projectTimeline')}</MotionCardTitle>
            </MotionCardHeader>
            <MotionCardContent>
              <DynamicChart
                data={projects.map(p => ({
                  name: p.name,
                  value: CalculationRules.calculateProjectProgress(p.progress, 100) * 100
                }))}
                dataKey="value"
                height={350}
                defaultType="area"
                colors={['#8b5cf6']}
                name={t('dashboard.progress')}
              />
            </MotionCardContent>
          </MotionCard>
        </div>

        {/* Milestone Performance Section */}
        {runningProjects.length > 0 && (
          <motion.div variants={itemVariants} className="mt-6">
            <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
              <Activity size={18} className="text-primary-500" />
              Cost Performance by Milestone
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {runningProjects.slice(0, 3).map(project => (
                <MilestonePerformanceCard
                  key={project.id}
                  projectId={project.id}
                  projectName={project.name}
                />
              ))}
            </div>
          </motion.div>
        )}
      </motion.div>

      <MetricsDetailModal
        isOpen={!!selectedMetric}
        onClose={() => setSelectedMetric(null)}
        title={selectedMetric?.title}
        description={selectedMetric?.description}
        items={selectedMetric?.items}
        documents={selectedMetric?.documents}
      />

      <GraphAnalysisModal
        isOpen={graphModalOpen}
        onClose={() => setGraphModalOpen(false)}
        projects={projects}
        initialMetric={graphMetric}
      />
    </>
  );
};

export default SPVDashboard;



================================================
FILE: frontend/src/components/dashboard/UnifiedDashboard.jsx
================================================
import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '@/contexts/AuthContext';
import dashboardService from '@/api/services/dashboardService';
import projectService from '@/api/services/projectService';
import { DynamicChart } from '@/components/ui/DynamicChart';
import { PageLoading } from '@/components/ui/Loading';
import GraphAnalysisModal from '@/components/ui/GraphAnalysisModal';
import InfoTooltip from '@/components/ui/InfoTooltip';
import HealthSummaryPanel from './HealthSummaryPanel';
import RadialProgressCard from './RadialProgressCard';
import PhaseProgressCard from './PhaseProgressCard';
import ProjectCalendar from './ProjectCalendar';
import WorkflowActionCards from '@/components/workflow/WorkflowActionCards';
import EVMSCurveChart from '@/components/evm/EVMSCurveChart';
import { AnimatedNumber } from '@/hooks/useAnimatedCounter';
import {
    TrendingUp, TrendingDown, DollarSign, FolderOpen, Clock, AlertTriangle,
    FileText, CheckCircle, Calendar, ChevronRight, Bell, Activity, ArrowRight,
    Target, MapPin, Flag, AlertCircle, FileSignature, BarChart3, Maximize2,
    Map, Box, Shield, GitPullRequest, Wallet, CircleDollarSign
} from 'lucide-react';

// Glass Card Component
const GlassCard = ({ children, className = '', onClick, hoverable = false }) => (
    <motion.div
        className={`
            relative overflow-hidden rounded-2xl
            bg-app-card/90 backdrop-blur-xl
            border border-app-subtle
            shadow-sm dark:shadow-lg
            ${hoverable ? 'hover:shadow-lg dark:hover:shadow-xl hover:bg-app-card dark:hover:bg-app-card/95 cursor-pointer' : ''}
            transition-all duration-300
            ${className}
        `}
        onClick={onClick}
        whileHover={hoverable ? { y: -2, scale: 1.005 } : {}}
        whileTap={hoverable ? { scale: 0.995 } : {}}
    >
        <div className="absolute inset-0 bg-gradient-to-br from-white/10 dark:from-white/5 via-transparent to-transparent pointer-events-none" />
        {children}
    </motion.div>
);

// KPI Card - Architecture compliant with info tooltip
const KPICard = ({ icon: Icon, label, value, subtext, color, trend, onClick, tooltip }) => {
    const colorClasses = {
        blue: 'from-blue-500 to-blue-600',
        emerald: 'from-emerald-500 to-emerald-600',
        amber: 'from-amber-500 to-amber-600',
        violet: 'from-violet-500 to-violet-600',
        rose: 'from-rose-500 to-rose-600',
    };

    const TrendIcon = trend === 'up' ? TrendingUp : trend === 'down' ? TrendingDown : Activity;

    return (
        <GlassCard className="p-5" hoverable onClick={onClick}>
            <div className="flex items-start justify-between">
                <div className={`p-3 rounded-xl bg-gradient-to-br ${colorClasses[color]} shadow-lg`}>
                    <Icon className="text-white" size={20} />
                </div>
                <div className="flex items-center gap-1">
                    {tooltip && <InfoTooltip content={tooltip} position="left" />}
                    {trend && (
                        <TrendIcon size={16} className={trend === 'up' ? 'text-emerald-500' : trend === 'down' ? 'text-rose-500' : 'text-slate-400'} />
                    )}
                </div>
            </div>
            <div className="mt-4">
                <p className="text-sm text-app-muted font-medium">{label}</p>
                <p className="text-2xl font-bold text-app-heading mt-1">{value}</p>
                {subtext && <p className="text-xs text-app-muted mt-1">{subtext}</p>}
            </div>
        </GlassCard>
    );
};

// Milestone Item
const MilestoneItem = ({ milestone, onClick }) => (
    <motion.div
        className="flex items-center gap-4 p-3 hover:bg-app-hover rounded-lg cursor-pointer"
        onClick={onClick}
        whileHover={{ x: 4 }}
    >
        <div className="w-3 h-3 rounded-full bg-primary-500 ring-4 ring-primary-100" />
        <div className="flex-1">
            <p className="text-sm font-medium text-app-heading">{milestone.name}</p>
            <p className="text-xs text-app-muted">{milestone.project}</p>
        </div>
        <div className="text-right">
            <p className="text-xs font-medium text-app-muted">
                {milestone.date ? new Date(milestone.date).toLocaleDateString() : 'TBD'}
            </p>
        </div>
    </motion.div>
);

// Alert Item
const AlertItem = ({ alert, onClick }) => {
    const severityColors = {
        critical: 'bg-rose-100 text-rose-700 border-rose-200 dark:bg-rose-900/30 dark:text-rose-300 dark:border-rose-800',
        warning: 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-300 dark:border-amber-800',
        info: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800',
    };

    return (
        <motion.div
            className={`p-3 rounded-lg border ${severityColors[alert.severity]} cursor-pointer`}
            onClick={onClick}
            whileHover={{ scale: 1.02 }}
        >
            <div className="flex items-center gap-2">
                <AlertCircle size={16} />
                <span className="text-sm font-medium">{alert.message}</span>
            </div>
        </motion.div>
    );
};

// Risk Badge
const RiskBadge = ({ level, count }) => {
    const colors = {
        high: 'bg-rose-500',
        medium: 'bg-amber-500',
        low: 'bg-emerald-500',
    };
    return (
        <div className="flex items-center gap-2">
            <div className={`w-3 h-3 rounded-full ${colors[level]}`} />
            <span className="text-sm font-medium text-slate-600 dark:text-neutral-300 capitalize">{level}</span>
            <span className="text-sm font-bold text-slate-800 dark:text-white">{count}</span>
        </div>
    );
};

// EVM Gauge
const EVMGauge = ({ label, value, isGood }) => (
    <div className="text-center">
        <div className={`text-3xl font-bold ${isGood ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'}`}>
            {value.toFixed(2)}
        </div>
        <div className="text-xs text-app-muted mt-1">{label}</div>
        <div className={`text-xs mt-1 ${isGood ? 'text-emerald-500 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400'}`}>
            {isGood ? 'âœ“ On Track' : 'âš  Attention'}
        </div>
    </div>
);

const UnifiedDashboard = () => {
    const { user } = useAuth();
    const navigate = useNavigate();

    const [loading, setLoading] = useState(true);
    const [stats, setStats] = useState(null);
    const [projects, setProjects] = useState([]);
    const [graphModalOpen, setGraphModalOpen] = useState(false);
    const [graphModalMetric, setGraphModalMetric] = useState('budget');
    const [error, setError] = useState(null);

    // Default stats to prevent crashes
    const defaultStats = {
        project_stats: { total: 0, in_progress: 0, completed: 0, planning: 0, on_hold: 0 },
        financial_summary: { total_budget: 0, total_spent: 0, remaining: 0, utilization: 0 },
        schedule_health: { on_track: 0, delayed: 0, critical: 0 },
        alerts: [],
        milestones: [],
        critical_path_tasks: [],
        risk_summary: { high: 0, medium: 0, low: 0 },
        change_requests: [],
        earned_value: { cpi: 1.0, spi: 1.0 },
        cash_flow: [],
        recent_activity: [],
        top_projects: [],
        // New progress tracking data
        portfolio_progress: {
            physical_progress: 0,
            financial_progress: 0,
            earned_value: 0,
            schedule_variance: 0,
            active_projects: 0
        },
        progress_state_counts: { claimed: 0, verified: 0, flagged: 0 }
    };

    useEffect(() => {
        const fetchData = async () => {
            try {
                setError(null);

                // Create a timeout promise
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Request timeout')), 10000)
                );

                // Race between actual fetch and timeout
                const [statsData, projectsData] = await Promise.race([
                    Promise.all([
                        dashboardService.getStats().catch(err => {
                            console.warn('Stats fetch failed:', err);
                            return defaultStats;
                        }),
                        projectService.getAllProjects().catch(err => {
                            console.warn('Projects fetch failed:', err);
                            return [];
                        })
                    ]),
                    timeoutPromise.then(() => [defaultStats, []])
                ]);

                setStats(statsData || defaultStats);
                setProjects(Array.isArray(projectsData) ? projectsData : projectsData?.results || []);
            } catch (error) {
                console.error('Failed to fetch dashboard data:', error);
                setError('Failed to load dashboard data');
                // Set defaults to prevent crash
                setStats(defaultStats);
                setProjects([]);
            } finally {
                setLoading(false);
            }
        };
        fetchData();
    }, []);

    if (loading) {
        return <PageLoading text="Loading Command Center..." />;
    }

    // Extract data
    const projectStats = stats?.project_stats || {};
    const financialSummary = stats?.financial_summary || {};
    const scheduleHealth = stats?.schedule_health || {};
    const alerts = stats?.alerts || [];
    const milestones = stats?.milestones || [];
    const criticalPathTasks = stats?.critical_path_tasks || [];
    const riskSummary = stats?.risk_summary || { high: 0, medium: 0, low: 0 };
    const changeRequests = stats?.change_requests || [];
    const earnedValue = stats?.earned_value || { cpi: 1.0, spi: 1.0 };
    const cashFlow = stats?.cash_flow || [];
    const recentActivity = stats?.recent_activity || [];
    const topProjects = stats?.top_projects || [];

    // NEW: Aggregated Progress from computed backend values
    const portfolioProgress = stats?.portfolio_progress || {
        physical_progress: 0,
        financial_progress: 0,
        earned_value: 0,
        schedule_variance: 0,
        active_projects: 0
    };
    const progressStateCounts = stats?.progress_state_counts || { claimed: 0, verified: 0, flagged: 0 };

    // Chart data
    const financialChartData = projects.slice(0, 8).map(p => ({
        name: (p.name || 'Project').substring(0, 12),
        budget: (Number(p.budget) || 0) / 10000000,
        spent: (Number(p.spent) || 0) / 10000000,
    }));

    const cashFlowChartData = cashFlow.map(c => ({
        name: c.month,
        inflow: c.inflow,
        outflow: c.outflow,
    }));

    // KPIs from computed backend values (not calculated client-side)
    // These are now aggregated from task-level progress data
    const physicalProgress = Math.round(portfolioProgress.physical_progress || 0);
    const financialProgress = Math.round(portfolioProgress.financial_progress || 0);
    const portfolioEarnedValue = portfolioProgress.earned_value || 0;
    const scheduleVariance = portfolioProgress.schedule_variance || 0;
    const flaggedProjects = progressStateCounts.flagged || 0;

    const greeting = () => {
        const hour = new Date().getHours();
        if (hour < 12) return 'Good Morning';
        if (hour < 17) return 'Good Afternoon';
        return 'Good Evening';
    };

    return (
        <div className="min-h-screen space-y-6 pb-8">
            {/* Header */}
            <motion.div
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
                className="flex flex-col md:flex-row md:items-center justify-between gap-4"
            >
                <div>
                    <h1 className="text-3xl font-heading font-bold text-app-heading">
                        {greeting()}, {user?.first_name || 'Admin'}
                    </h1>
                    <p className="text-app-muted mt-1">
                        PMIS Command Center â€¢ {new Date().toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                    </p>
                </div>
                {alerts.length > 0 && (
                    <motion.div
                        className="flex items-center gap-2 px-4 py-2 bg-rose-100 text-rose-700 rounded-xl"
                        animate={{ scale: [1, 1.02, 1] }}
                        transition={{ repeat: Infinity, duration: 2 }}
                    >
                        <Bell size={18} />
                        <span className="font-medium">{alerts.length} alerts require attention</span>
                    </motion.div>
                )}
            </motion.div>

            {/* Section 1: KPI Metrics Row - Reordered for logical flow */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <KPICard
                    icon={Target}
                    label="Physical Progress"
                    value={`${physicalProgress}%`}
                    subtext={`${projectStats.in_progress || 0} active projects`}
                    color="blue"
                    trend={physicalProgress >= 50 ? 'up' : 'down'}
                    onClick={() => navigate('/projects')}
                    tooltip="Weighted average of BOQ completion across all active projects. Calculated from actual quantities vs planned quantities."
                />
                <KPICard
                    icon={Clock}
                    label="Schedule Health"
                    value={scheduleHealth.no_data ? 'No Data' : `${scheduleHealth.percentage || 0}%`}
                    subtext={scheduleHealth.no_data ? 'No schedules created yet' : `${scheduleHealth.on_track || 0} on track`}
                    color={scheduleHealth.no_data ? 'violet' : (scheduleHealth.percentage >= 80 ? 'emerald' : 'amber')}
                    trend={scheduleHealth.no_data ? null : (scheduleHealth.percentage >= 80 ? 'up' : 'down')}
                    onClick={() => navigate('/scheduling')}
                    tooltip="Percentage of tasks/milestones on track. Green (â‰¥80%) indicates healthy schedule, amber indicates delays."
                />
                <KPICard
                    icon={CircleDollarSign}
                    label="Financial Progress"
                    value={`${financialProgress}%`}
                    subtext={`â‚¹${((financialSummary.total_spent || 0) / 10000000).toFixed(1)} Cr spent`}
                    color="emerald"
                    trend={financialProgress <= 80 ? 'up' : 'down'}
                    onClick={() => navigate('/cost/budgeting')}
                    tooltip="Budget utilization rate. (Total Paid RA Bills / Total Contract Value) Ã— 100. Usually lags behind physical progress."
                />
                <KPICard
                    icon={FileSignature}
                    label="Pending Approvals"
                    value={stats?.pending_approvals || 0}
                    subtext="documents awaiting review"
                    color={stats?.pending_approvals > 0 ? 'amber' : 'emerald'}
                    onClick={() => navigate('/approvals')}
                    tooltip="Number of documents, RA bills, or change requests pending your approval or review action."
                />
            </div>

            {/* Section 2: EVM S-Curve - Full Width */}
            <GlassCard className="p-6">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                        <BarChart3 size={20} className="text-emerald-600" />
                        Earned Value Analysis (S-Curve)
                    </h3>
                    <InfoTooltip content="S-Curve shows Planned Value (PV), Earned Value (EV), and Actual Cost (AC) over time. CPI > 1 means under budget, SPI > 1 means ahead of schedule." />
                </div>
                {projects.length > 0 ? (
                    <React.Suspense fallback={<div className="h-[400px] flex items-center justify-center text-app-muted">Loading chart...</div>}>
                        <EVMSCurveChart
                            projectId={projects[0]?.id}
                            height={320}
                            showMetricsPanel={true}
                        />
                    </React.Suspense>
                ) : (
                    <div className="h-[400px] flex flex-col items-center justify-center text-center">
                        <BarChart3 size={48} className="text-slate-300 dark:text-slate-600 mb-3" />
                        <p className="text-slate-500 dark:text-slate-400 mb-1">No projects available</p>
                        <p className="text-xs text-slate-400 dark:text-slate-500">S-Curve shows PV, EV, AC trends over time</p>
                    </div>
                )}
            </GlassCard>

            {/* Section 2.5: Cash Flow - Full Width Below EVM */}
            <GlassCard className="p-6">
                <div className="flex items-center justify-between mb-2">
                    <h3 className="text-lg font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                        <Wallet size={20} className="text-blue-600" />
                        Cash Flow Trend
                    </h3>
                    <button
                        className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                        onClick={() => { setGraphModalMetric('spent'); setGraphModalOpen(true); }}
                    >
                        <Maximize2 size={16} className="text-slate-400 hover:text-primary-500" />
                    </button>
                </div>
                <DynamicChart
                    data={cashFlowChartData}
                    dataKey="inflow"
                    height={280}
                    colors={['#10b981', '#3b82f6', '#8b5cf6']}
                    name="Inflow"
                    defaultType="area"
                />
            </GlassCard>

            {/* Section 3: Project Portfolio Table (Moved up) */}
            <GlassCard className="overflow-hidden">
                <div className="p-6 border-b border-slate-200 dark:border-neutral-800">
                    <div className="flex items-center justify-between">
                        <h3 className="text-lg font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                            <FolderOpen size={20} className="text-primary-600" />
                            Project Portfolio
                        </h3>
                        <button
                            className="flex items-center gap-1 text-sm text-primary-600 hover:text-primary-700 font-medium"
                            onClick={() => navigate('/projects')}
                        >
                            View all <ArrowRight size={16} />
                        </button>
                    </div>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead className="bg-app-secondary">
                            <tr className="text-xs font-medium text-app-muted uppercase tracking-wider">
                                <th className="py-3 pl-6 text-left">Project</th>
                                <th className="py-3 text-left">Status</th>
                                <th className="py-3 text-right">Budget</th>
                                <th className="py-3 text-right">Spent</th>
                                <th className="py-3 pr-6">Progress</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                            {(topProjects.length > 0 ? topProjects : projects.slice(0, 5)).map((project, idx) => {
                                const budget = Number(project.budget) || 0;
                                const spent = Number(project.spent) || 0;
                                const progress = Number(project.progress) || 0;
                                const statusColors = {
                                    'In Progress': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
                                    'Planning': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300',
                                    'Completed': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
                                    'On Hold': 'bg-slate-100 text-slate-700 dark:bg-neutral-700 dark:text-slate-300',
                                };
                                return (
                                    <tr key={project.id || idx} className="hover:bg-app-hover cursor-pointer" onClick={() => navigate(`/projects/${project.id}`)}>
                                        <td className="py-3 pl-6">
                                            <p className="font-medium text-app-heading">{project.name}</p>
                                        </td>
                                        <td className="py-3">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColors[project.status] || 'bg-slate-100 text-slate-700 dark:bg-neutral-700 dark:text-slate-300'}`}>
                                                {project.status || 'Unknown'}
                                            </span>
                                        </td>
                                        <td className="py-3 text-right text-sm font-medium text-app-text">
                                            â‚¹{(budget / 10000000).toFixed(2)} Cr
                                        </td>
                                        <td className="py-3 text-right text-sm text-app-muted">
                                            â‚¹{(spent / 10000000).toFixed(2)} Cr
                                        </td>
                                        <td className="py-3 pr-6">
                                            <div className="flex items-center gap-2">
                                                <div className="flex-1 h-2 bg-app-secondary rounded-full overflow-hidden">
                                                    <div
                                                        className="h-full bg-gradient-to-r from-primary-500 to-primary-600 rounded-full"
                                                        style={{ width: `${progress}%` }}
                                                    />
                                                </div>
                                                <span className="text-xs font-medium text-app-muted w-10 text-right">{progress}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                );
                            })}
                            {topProjects.length === 0 && projects.length === 0 && (
                                <tr>
                                    <td colSpan={5} className="py-8 text-center text-slate-400 dark:text-neutral-500">No projects found</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </GlassCard>

            {/* Section 4: Health Summary + Phase Progress */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Health Summary Panel */}
                <HealthSummaryPanel
                    scheduleHealth={scheduleHealth}
                    projectStats={projectStats}
                    financialSummary={financialSummary}
                    overdueTasks={stats?.overdue_tasks || 0}
                    projects={projects}
                />

                {/* Phase Progress */}
                <PhaseProgressCard
                    title="Progress by Phase"
                    phases={[
                        { id: 'design', name: 'Design', progress: Math.min(physicalProgress * 1.5, 100), color: '#3b82f6' },
                        { id: 'procurement', name: 'Procurement', progress: Math.min(physicalProgress * 1.2, 100), color: '#8b5cf6' },
                        { id: 'construction', name: 'Construction', progress: physicalProgress, color: '#f59e0b' },
                        { id: 'testing', name: 'Testing', progress: Math.max(physicalProgress - 30, 0), color: '#10b981' },
                        { id: 'closeout', name: 'Closeout', progress: Math.max(physicalProgress - 60, 0), color: '#64748b' }
                    ]}
                />
            </div>

            {/* Section 1.6: Budget vs Spent & Project Status Charts */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Budget vs Spent Chart */}
                <GlassCard className="p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-app-heading flex items-center gap-2">
                            <DollarSign size={20} className="text-emerald-600" />
                            Budget vs Spent
                        </h3>
                        <button
                            className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                            onClick={(e) => { e.stopPropagation(); setGraphModalMetric('budget'); setGraphModalOpen(true); }}
                        >
                            <Maximize2 size={16} className="text-slate-400 hover:text-primary-500" />
                        </button>
                    </div>
                    <DynamicChart
                        data={financialChartData}
                        dataKey="budget"
                        secondaryDataKey="spent"
                        height={280}
                        colors={['#10b981', '#3b82f6']}
                        name="Budget"
                        secondaryName="Spent"
                        defaultType="bar"
                    />
                </GlassCard>

                {/* Project Status Chart */}
                <GlassCard className="p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-app-heading flex items-center gap-2">
                            <Activity size={20} className="text-blue-600" />
                            Project Status Distribution
                        </h3>
                        <button
                            className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                            onClick={(e) => { e.stopPropagation(); setGraphModalMetric('count'); setGraphModalOpen(true); }}
                        >
                            <Maximize2 size={16} className="text-slate-400 hover:text-primary-500" />
                        </button>
                    </div>
                    <DynamicChart
                        data={[
                            { name: 'In Progress', value: projectStats.in_progress || 0 },
                            { name: 'Planning', value: projectStats.planning || 0 },
                            { name: 'Completed', value: projectStats.completed || 0 },
                            { name: 'On Hold', value: projectStats.on_hold || 0 },
                        ]}
                        dataKey="value"
                        height={280}
                        colors={['#3b82f6', '#f59e0b', '#10b981', '#64748b']}
                        name="Projects"
                        defaultType="pie"
                    />
                </GlassCard>
            </div>

            {/* Section 2: Schedule & Timeline + Alerts */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Milestones */}
                <GlassCard className="p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-app-heading flex items-center gap-2">
                            <Flag size={20} className="text-primary-600" />
                            Upcoming Milestones
                        </h3>
                        <button className="text-sm text-primary-600 hover:text-primary-700 font-medium" onClick={() => navigate('/scheduling')}>
                            View Schedule â†’
                        </button>
                    </div>
                    <div className="space-y-1">
                        {milestones.length > 0 ? (
                            milestones.slice(0, 5).map((m, idx) => (
                                <MilestoneItem key={m.id || idx} milestone={m} onClick={() => navigate('/scheduling')} />
                            ))
                        ) : (
                            <p className="text-center py-8 text-app-muted text-sm">No upcoming milestones</p>
                        )}
                    </div>
                </GlassCard>

                {/* Alerts & Critical Path */}
                <GlassCard className="p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-app-heading flex items-center gap-2">
                            <AlertTriangle size={20} className="text-amber-500" />
                            Alerts & Critical Items
                        </h3>
                    </div>
                    <div className="space-y-3">
                        {alerts.length > 0 ? (
                            alerts.slice(0, 4).map((alert, idx) => (
                                <AlertItem key={idx} alert={alert} onClick={() => navigate(alert.link || '/')} />
                            ))
                        ) : (
                            <div className="text-center py-6">
                                <CheckCircle size={32} className="mx-auto text-emerald-400 mb-2" />
                                <p className="text-sm text-app-muted">All systems operational</p>
                            </div>
                        )}
                        {criticalPathTasks.length > 0 && (
                            <div className="mt-4 pt-4 border-t border-app-subtle">
                                <p className="text-xs font-medium text-app-muted uppercase mb-2">Critical Path Tasks</p>
                                {criticalPathTasks.slice(0, 2).map((t, idx) => (
                                    <div key={idx} className={`text-sm py-1 ${t.is_overdue ? 'text-rose-600' : 'text-app-text'}`}>
                                        â€¢ {t.name} ({t.project})
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </GlassCard>
            </div>

            {/* Section 3: Calendar + Pending Approvals */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Project Calendar Widget */}
                <GlassCard className="overflow-hidden">
                    <ProjectCalendar height={380} showFilters={true} />
                </GlassCard>

                {/* Pending Workflow Approvals */}
                <GlassCard className="p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-app-heading flex items-center gap-2">
                            <Clock size={20} className="text-primary-600" />
                            Pending Approvals
                        </h3>
                        <button
                            className="text-sm text-primary-600 hover:text-primary-700 font-medium"
                            onClick={() => navigate('/approvals')}
                        >
                            View All â†’
                        </button>
                    </div>
                    <WorkflowActionCards maxItems={3} />
                </GlassCard>
            </div>

            {/* Section 4: Risk & Compliance + Change Requests */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Risk Summary */}
                <GlassCard className="p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                            <Shield size={20} className="text-rose-500" />
                            Risk Summary
                        </h3>
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                        <RiskBadge level="high" count={riskSummary.high || 0} />
                        <RiskBadge level="medium" count={riskSummary.medium || 0} />
                        <RiskBadge level="low" count={riskSummary.low || 0} />
                    </div>
                    {riskSummary.top_risks?.length > 0 && (
                        <div className="mt-4 pt-4 border-t border-slate-100 dark:border-neutral-700">
                            <p className="text-xs font-medium text-slate-400 uppercase mb-2">Top Risks</p>
                            {riskSummary.top_risks.map((r, idx) => (
                                <div key={idx} className="text-sm text-rose-600 py-1">â€¢ {r.title}</div>
                            ))}
                        </div>
                    )}
                </GlassCard>

                {/* Change Requests */}
                <GlassCard className="p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                            <GitPullRequest size={20} className="text-violet-500" />
                            Change Requests / Variations
                        </h3>
                        <button
                            className="text-sm text-violet-600 hover:text-violet-700 font-medium"
                            onClick={() => navigate('/e-procurement')}
                        >
                            View All â†’
                        </button>
                    </div>
                    <div className="space-y-2">
                        {changeRequests.length > 0 ? (
                            changeRequests.slice(0, 3).map((cr, idx) => (
                                <motion.div
                                    key={idx}
                                    className="p-3 bg-violet-50 dark:bg-violet-900/20 rounded-lg border border-violet-100 dark:border-violet-800 cursor-pointer hover:bg-violet-100 dark:hover:bg-violet-900/30 transition-colors"
                                    onClick={() => navigate('/e-procurement')}
                                    whileHover={{ scale: 1.01 }}
                                    whileTap={{ scale: 0.99 }}
                                >
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="text-sm font-medium text-slate-700 dark:text-neutral-300">{cr.title}</p>
                                            <p className="text-xs text-slate-400">{cr.contract}</p>
                                        </div>
                                        <span className="text-xs px-2 py-1 bg-violet-200 text-violet-700 dark:bg-violet-800 dark:text-violet-200 rounded">
                                            {cr.status}
                                        </span>
                                    </div>
                                </motion.div>
                            ))
                        ) : (
                            <p className="text-center py-6 text-slate-400 text-sm">No pending variations</p>
                        )}
                    </div>
                </GlassCard>
            </div>

            {/* Graph Analysis Modal */}
            <GraphAnalysisModal
                isOpen={graphModalOpen}
                onClose={() => setGraphModalOpen(false)}
                projects={projects}
                initialMetric={graphModalMetric}
            />
        </div>
    );
};

export default UnifiedDashboard;



================================================
FILE: frontend/src/components/edms/AddNoteModal.jsx
================================================
/**
 * AddNoteModal - Modal for creating new noting sheet entries
 * 
 * Features:
 * - Note type selector
 * - Content textarea
 * - Reference to previous notes
 * - Ruling action (for RULING type)
 * - Save as Draft vs Submit
 */
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion } from 'framer-motion';
import {
    X, MessageSquare, AlertTriangle, CheckCircle, Gavel,
    CornerDownRight, Loader2, Save, Send
} from 'lucide-react';
import client from '@/api/client';
import { toast } from 'sonner';
import Button from '@/components/ui/Button';

const AddNoteModal = ({
    documentId,
    document,
    onClose,
    onSuccess,
    canAddRuling = false
}) => {
    const [formData, setFormData] = useState({
        note_type: 'REMARK',
        subject: '',
        content: '',
        references_note: '',
        ruling_action: 'NONE'
    });
    const [saving, setSaving] = useState(false);
    const [submitting, setSubmitting] = useState(false);

    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && !saving && !submitting) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [onClose, saving, submitting]);

    const noteTypes = [
        { value: 'REMARK', label: 'Remark/Observation', icon: MessageSquare, color: 'text-slate-600' },
        { value: 'CLARIFICATION_REQUEST', label: 'Request Clarification', icon: AlertTriangle, color: 'text-amber-600' },
        { value: 'CLARIFICATION_RESPONSE', label: 'Respond to Clarification', icon: CornerDownRight, color: 'text-blue-600' },
        { value: 'RECOMMENDATION', label: 'Recommendation', icon: CheckCircle, color: 'text-purple-600' },
        ...(canAddRuling ? [{ value: 'RULING', label: 'Ruling/Decision', icon: Gavel, color: 'text-green-600' }] : [])
    ];

    const rulingActions = [
        { value: 'NONE', label: 'No action' },
        { value: 'VALIDATE', label: 'Validate Document' },
        { value: 'APPROVE', label: 'Approve Document' },
        { value: 'REJECT', label: 'Reject Document' },
        { value: 'REQUEST_REVISION', label: 'Request Revision' }
    ];

    const handleSave = async (isDraft = true) => {
        if (!formData.content.trim()) {
            toast.error('Please enter note content');
            return;
        }

        isDraft ? setSaving(true) : setSubmitting(true);

        try {
            await client.post('/edms/noting-sheets/', {
                document: documentId,
                note_type: formData.note_type,
                subject: formData.subject,
                content: formData.content,
                references_note: formData.references_note || null,
                ruling_action: formData.note_type === 'RULING' ? formData.ruling_action : 'NONE',
                is_draft: isDraft
            });

            toast.success(isDraft ? 'Draft saved' : 'Note submitted successfully');
            onSuccess();
        } catch (error) {
            console.error('Failed to save note:', error);
            toast.error(error.response?.data?.error || 'Failed to save note');
        } finally {
            setSaving(false);
            setSubmitting(false);
        }
    };

    return createPortal(
        <div className="fixed inset-0 z-[9999] bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.95, y: 20 }}
                className="bg-white dark:bg-neutral-900 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden"
            >
                {/* Header */}
                <div className="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-neutral-700 bg-gradient-to-r from-slate-50 to-primary-50 dark:from-neutral-800 dark:to-neutral-800">
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 dark:text-white">Add Noting Entry</h2>
                        <p className="text-sm text-slate-500 dark:text-neutral-400 truncate max-w-[350px]">{document?.title}</p>
                    </div>
                    <button
                        onClick={onClose}
                        className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-700 rounded-lg transition-colors"
                    >
                        <X size={20} className="text-slate-500 dark:text-neutral-400" />
                    </button>
                </div>

                {/* Form */}
                <div className="p-6 space-y-4">
                    {/* Note Type */}
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">
                            Note Type
                        </label>
                        <div className="grid grid-cols-2 gap-2">
                            {noteTypes.map((type) => {
                                const TypeIcon = type.icon;
                                const isSelected = formData.note_type === type.value;
                                return (
                                    <button
                                        key={type.value}
                                        type="button"
                                        onClick={() => setFormData(prev => ({ ...prev, note_type: type.value }))}
                                        className={`flex items-center gap-2 p-2.5 rounded-lg border transition-all text-left ${isSelected
                                            ? 'border-primary-500 bg-primary-50'
                                            : 'border-slate-200 hover:border-slate-300'
                                            }`}
                                    >
                                        <TypeIcon size={18} className={isSelected ? 'text-primary-600' : type.color} />
                                        <span className={`text-sm font-medium ${isSelected ? 'text-primary-700' : 'text-slate-700'}`}>
                                            {type.label}
                                        </span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* Ruling Action (only for RULING type) */}
                    {formData.note_type === 'RULING' && (
                        <motion.div initial={{ height: 0, opacity: 0 }} animate={{ height: 'auto', opacity: 1 }} className="overflow-hidden">
                            <label className="block text-sm font-medium text-slate-700 mb-2">
                                Ruling Action
                            </label>
                            <select
                                value={formData.ruling_action}
                                onChange={(e) => setFormData(prev => ({ ...prev, ruling_action: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            >
                                {rulingActions.map(action => (
                                    <option key={action.value} value={action.value}>
                                        {action.label}
                                    </option>
                                ))}
                            </select>
                        </motion.div>
                    )}

                    {/* Subject (Optional) */}
                    <div>
                        <input
                            type="text"
                            value={formData.subject}
                            onChange={(e) => setFormData(prev => ({ ...prev, subject: e.target.value }))}
                            placeholder="Subject line (optional)"
                            className="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        />
                    </div>

                    {/* Content */}
                    <div>
                        <textarea
                            value={formData.content}
                            onChange={(e) => setFormData(prev => ({ ...prev, content: e.target.value }))}
                            placeholder="Enter your observations, remarks, or decision..."
                            rows={5}
                            className="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none"
                            required
                        />
                    </div>

                    {/* Reference Note (Optional) */}
                    <div>
                        <input
                            type="text"
                            value={formData.references_note}
                            onChange={(e) => setFormData(prev => ({ ...prev, references_note: e.target.value }))}
                            placeholder="Reference Note ID (optional)"
                            className="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        />
                    </div>
                </div>

                {/* Footer */}
                <div className="flex items-center justify-between px-6 py-4 border-t border-slate-200 bg-slate-50">
                    <p className="text-xs text-slate-400">
                        Immutable once submitted.
                    </p>
                    <div className="flex items-center gap-2">
                        <Button variant="outline" size="sm" onClick={onClose}>
                            Cancel
                        </Button>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => handleSave(true)}
                            disabled={saving || submitting}
                        >
                            {saving ? (
                                <Loader2 size={14} className="animate-spin mr-1" />
                            ) : (
                                <Save size={14} className="mr-1" />
                            )}
                            Save Draft
                        </Button>
                        <Button
                            size="sm"
                            onClick={() => handleSave(false)}
                            disabled={saving || submitting || !formData.content.trim()}
                        >
                            {submitting ? (
                                <Loader2 size={14} className="animate-spin mr-1" />
                            ) : (
                                <Send size={14} className="mr-1" />
                            )}
                            Submit Note
                        </Button>
                    </div>
                </div>
            </motion.div>
        </div>,
        window.document.body
    );
};

export default AddNoteModal;



================================================
FILE: frontend/src/components/edms/AddVersionModal.jsx
================================================
/**
 * AddVersionModal - Upload a new file as a version to an existing document
 */
import { useState, useCallback, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion } from 'framer-motion';
import { useDropzone } from 'react-dropzone';
import {
    X, Upload, RefreshCw, Loader2, FileText, Search,
    ChevronDown, AlertCircle
} from 'lucide-react';
import client from '@/api/client';
import { toast } from 'sonner';
import Button from '@/components/ui/Button';

const AddVersionModal = ({ onClose, projectId, currentFolderId = null, onVersionAdded }) => {
    const [documents, setDocuments] = useState([]);
    const [filteredDocuments, setFilteredDocuments] = useState([]);
    const [selectedDocumentId, setSelectedDocumentId] = useState('');
    const [searchQuery, setSearchQuery] = useState('');
    const [showResults, setShowResults] = useState(false);
    const [file, setFile] = useState(null);
    const [changeNotes, setChangeNotes] = useState('');
    const [isUploading, setIsUploading] = useState(false);
    const [loadingDocuments, setLoadingDocuments] = useState(true);

    useEffect(() => {
        fetchDocuments();
    }, [projectId, currentFolderId]);

    useEffect(() => {
        // Filter documents based on search query
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            setFilteredDocuments(
                documents.filter(doc =>
                    doc.title.toLowerCase().includes(query) ||
                    doc.document_number?.toLowerCase().includes(query)
                )
            );
        } else {
            setFilteredDocuments(documents);
        }
    }, [searchQuery, documents]);

    // Close results dropdown when clicking outside
    useEffect(() => {
        const handleClickOutside = (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                setShowResults(false);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && !isUploading) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [onClose, isUploading]);

    const fetchDocuments = async () => {
        setLoadingDocuments(true);
        try {
            const params = { project: projectId };
            if (currentFolderId) {
                params.folder = currentFolderId;
            }
            const res = await client.get('/edms/documents/', { params });
            const docList = Array.isArray(res.data) ? res.data : (res.data.results || []);

            // Filter out archived documents
            const activeDocuments = docList.filter(doc => doc.status !== 'ARCHIVED');
            setDocuments(activeDocuments);
            setFilteredDocuments(activeDocuments);
        } catch (error) {
            console.error('Failed to fetch documents:', error);
            toast.error('Failed to load documents');
        } finally {
            setLoadingDocuments(false);
        }
    };

    const onDrop = useCallback((acceptedFiles, fileRejections) => {
        if (fileRejections.length > 0) {
            const rejection = fileRejections[0];
            const errorMsg = rejection.errors[0]?.message || 'File type not supported';
            toast.error(`Cannot upload ${rejection.file.name}: ${errorMsg}`);
            return;
        }

        if (acceptedFiles.length > 1) {
            toast.error('Please upload only one file at a time');
            return;
        }

        if (acceptedFiles.length === 1) {
            setFile(acceptedFiles[0]);
        }
    }, []);

    const { getRootProps, getInputProps, isDragActive } = useDropzone({
        onDrop,
        multiple: false,
        accept: {
            'application/pdf': ['.pdf'],
            'application/msword': ['.doc'],
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
            'application/vnd.ms-excel': ['.xls'],
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
            'text/csv': ['.csv'],
            'application/vnd.ms-powerpoint': ['.ppt'],
            'application/vnd.openxmlformats-officedocument.presentationml.presentation': ['.pptx'],
            'text/plain': ['.txt'],
            'text/rtf': ['.rtf'],
            'image/*': ['.png', '.jpg', '.jpeg', '.gif', '.webp'],
            'video/*': ['.mp4', '.mov', '.avi', '.webm'],
            'application/octet-stream': ['.dwg', '.dxf'],
            'image/vnd.dxf': ['.dxf'],
        }
    });

    const removeFile = () => {
        setFile(null);
    };

    const formatFileSize = (bytes) => {
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        if (!selectedDocumentId) {
            toast.error('Please select a document');
            return;
        }

        if (!file) {
            toast.error('Please upload a file');
            return;
        }

        setIsUploading(true);

        const formData = new FormData();
        formData.append('file', file);
        if (changeNotes.trim()) {
            formData.append('change_notes', changeNotes.trim());
        }

        try {
            await client.post(`/edms/documents/${selectedDocumentId}/upload_version/`, formData, {
                headers: { 'Content-Type': 'multipart/form-data' }
            });

            toast.success('New version added successfully');
            onVersionAdded && onVersionAdded();
            onClose();
        } catch (error) {
            console.error('Failed to add version:', error);
            const errorMsg = error.response?.data?.error || 'Failed to add version';
            toast.error(errorMsg);
        } finally {
            setIsUploading(false);
        }
    };

    const selectedDocument = documents.find(doc => doc.id === selectedDocumentId);

    return createPortal(
        <div className="fixed inset-0 z-[9999] bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                className="bg-white dark:bg-neutral-900 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden max-h-[90vh] flex flex-col"
            >
                {/* Header */}
                <div className="flex justify-between items-center p-4 border-b border-slate-200 dark:border-neutral-700 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-neutral-800 dark:to-neutral-800">
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <RefreshCw className="text-blue-600" size={20} />
                            Add New Version
                        </h2>
                        <p className="text-xs text-slate-500 dark:text-neutral-400 mt-0.5">Upload a new file as a version to an existing document</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-white/50 dark:hover:bg-neutral-700 rounded-lg transition-colors">
                        <X size={20} className="text-slate-500 dark:text-neutral-400" />
                    </button>
                </div>

                <form onSubmit={handleSubmit} className="p-4 space-y-4 overflow-y-auto flex-1">
                    {/* Document Selector with Autocomplete */}
                    <div>
                        <label className="block text-sm font-semibold text-slate-700 mb-2">
                            Select Document <span className="text-red-500">*</span>
                        </label>

                        {loadingDocuments ? (
                            <div className="flex items-center justify-center py-8 text-slate-400">
                                <Loader2 className="animate-spin mr-2" size={20} />
                                Loading documents...
                            </div>
                        ) : documents.length === 0 ? (
                            <div className="p-4 bg-slate-50 rounded-lg border border-slate-200 text-center">
                                <AlertCircle className="mx-auto text-slate-400 mb-2" size={32} />
                                <p className="text-sm text-slate-600">No documents available</p>
                                <p className="text-xs text-slate-400 mt-1">Upload a document first before adding versions</p>
                            </div>
                        ) : (
                            <div className="relative autocomplete-container">
                                {/* Autocomplete Search Input */}
                                <div className="relative">
                                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => {
                                            setSearchQuery(e.target.value);
                                            setSelectedDocumentId(''); // Clear selected ID when typing
                                        }}
                                        onFocus={() => setShowResults(true)}
                                        placeholder="Type to search documents..."
                                        className="w-full pl-10 pr-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                    {searchQuery && (
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setSearchQuery('');
                                                setSelectedDocumentId('');
                                                setShowResults(false); // Close results when clearing
                                            }}
                                            className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                                        >
                                            <X size={16} />
                                        </button>
                                    )}
                                </div>

                                {/* Autocomplete Results Dropdown */}
                                {showResults && searchQuery && filteredDocuments.length > 0 && (
                                    <div className="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                        {filteredDocuments.map(doc => (
                                            <button
                                                key={doc.id}
                                                type="button"
                                                onClick={() => {
                                                    setSelectedDocumentId(doc.id);
                                                    setSearchQuery(doc.title);
                                                    setShowResults(false);
                                                }}
                                                className="w-full px-3 py-2.5 text-left hover:bg-blue-50 transition-colors border-b border-slate-100 last:border-0 flex items-start gap-2"
                                            >
                                                <FileText className="text-slate-400 flex-shrink-0 mt-0.5" size={16} />
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-medium text-slate-700 truncate">
                                                        {doc.title}
                                                    </p>
                                                    <div className="flex items-center gap-2 mt-0.5 text-xs text-slate-500">
                                                        <span>v{doc.current_version_number}</span>
                                                        <span>â€¢</span>
                                                        <span className={`px-1.5 py-0.5 rounded ${doc.status === 'DRAFT' ? 'bg-slate-100 text-slate-600' :
                                                            doc.status === 'APPROVED' ? 'bg-green-100 text-green-600' :
                                                                doc.status === 'VALIDATED' ? 'bg-blue-100 text-blue-600' :
                                                                    'bg-yellow-100 text-yellow-600'
                                                            }`}>
                                                            {doc.status}
                                                        </span>
                                                        {doc.document_number && (
                                                            <>
                                                                <span>â€¢</span>
                                                                <span>{doc.document_number}</span>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                )}

                                {/* No Results Message */}
                                {showResults && searchQuery && filteredDocuments.length === 0 && (
                                    <div className="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg p-3">
                                        <p className="text-sm text-slate-500 text-center">No documents found matching "{searchQuery}"</p>
                                    </div>
                                )}

                                {/* Selected Document Info */}
                                {selectedDocument && (
                                    <div className="mt-2 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                        <div className="flex items-start gap-2">
                                            <FileText className="text-blue-600 flex-shrink-0 mt-0.5" size={16} />
                                            <div className="flex-1 min-w-0">
                                                <p className="text-sm font-medium text-slate-700 truncate">{selectedDocument.title}</p>
                                                <div className="flex items-center gap-3 mt-1 text-xs text-slate-500">
                                                    <span>Current: v{selectedDocument.current_version_number}</span>
                                                    <span>â€¢</span>
                                                    <span className={`px-2 py-0.5 rounded-full ${selectedDocument.status === 'DRAFT' ? 'bg-slate-100 text-slate-700' :
                                                        selectedDocument.status === 'APPROVED' ? 'bg-green-100 text-green-700' :
                                                            selectedDocument.status === 'VALIDATED' ? 'bg-blue-100 text-blue-700' :
                                                                'bg-yellow-100 text-yellow-700'
                                                        }`}>
                                                        {selectedDocument.status}
                                                    </span>
                                                </div>
                                                <p className="text-xs text-blue-600 mt-1">
                                                    â†’ New version will be v{selectedDocument.current_version_number + 1}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* File Upload */}
                    <div>
                        <label className="block text-sm font-semibold text-slate-700 mb-2">
                            Upload New Version <span className="text-red-500">*</span>
                        </label>

                        {!file ? (
                            <div
                                {...getRootProps()}
                                className={`border-2 border-dashed rounded-xl p-6 text-center cursor-pointer transition-all ${isDragActive
                                    ? 'border-blue-500 bg-blue-50'
                                    : 'border-slate-300 hover:border-slate-400'
                                    }`}
                            >
                                <input {...getInputProps()} />
                                <Upload size={32} className={`mx-auto ${isDragActive ? 'text-blue-600' : 'text-slate-400'}`} />
                                <p className="text-sm text-slate-600 mt-2">
                                    {isDragActive ? 'Drop file here' : 'Drag & drop file, or click to browse'}
                                </p>
                                <p className="text-xs text-slate-400 mt-1">
                                    Any filename accepted - will be versioned under selected document
                                </p>
                            </div>
                        ) : (
                            <div className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <div className="w-10 h-10 rounded bg-white flex items-center justify-center border border-slate-200">
                                    <FileText size={20} className="text-slate-500" />
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-slate-700 truncate">{file.name}</p>
                                    <p className="text-xs text-slate-400">{formatFileSize(file.size)}</p>
                                </div>
                                {!isUploading && (
                                    <button
                                        type="button"
                                        onClick={removeFile}
                                        className="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-red-500 transition-colors"
                                    >
                                        <X size={16} />
                                    </button>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Change Notes */}
                    <div>
                        <label className="block text-sm font-semibold text-slate-700 mb-2">
                            Change Notes <span className="text-slate-400">(optional)</span>
                        </label>
                        <textarea
                            value={changeNotes}
                            onChange={(e) => setChangeNotes(e.target.value)}
                            placeholder="Describe what changed in this version..."
                            className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows={3}
                        />
                        <p className="text-xs text-slate-500 mt-1">
                            ğŸ’¡ Good practice: Document what changed, why, and by whom
                        </p>
                    </div>

                    {/* Actions */}
                    <div className="flex justify-end gap-2 pt-2">
                        <Button type="button" variant="outline" onClick={onClose} disabled={isUploading}>
                            Cancel
                        </Button>
                        <Button
                            type="submit"
                            disabled={isUploading || !selectedDocumentId || !file || documents.length === 0}
                        >
                            {isUploading ? (
                                <>
                                    <Loader2 size={16} className="animate-spin mr-2" />
                                    Adding Version...
                                </>
                            ) : (
                                <>
                                    <RefreshCw size={16} className="mr-2" />
                                    Add Version
                                </>
                            )}
                        </Button>
                    </div>
                </form>
            </motion.div>
        </div>,
        document.body
    );
};

export default AddVersionModal;



================================================
FILE: frontend/src/components/edms/DocumentDetailModal.jsx
================================================
/**
 * DocumentDetailModal - Full document view with preview, versions, and workflow
 */
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    X, Download, MessageSquare, Upload, History,
    CheckCircle, XCircle, Clock, AlertTriangle, Edit,
    FileText, Eye, Send, ArrowRight, Loader2, Lock,
    BookOpen
} from 'lucide-react';
import { format, formatDistanceToNow } from 'date-fns';
import client from '@/api/client';
import { toast } from 'sonner';
import Button from '@/components/ui/Button';

const DocumentDetailModal = ({
    document: initialDoc,
    onClose,
    onUpdate,
    onDiscuss,
    onViewWithNoting, // Opens document viewer with noting sheet
    userRole = 'SPV_Official' // Default for testing
}) => {
    const [document, setDocument] = useState(initialDoc);
    const [activeTab, setActiveTab] = useState('details');
    const [loading, setLoading] = useState(true);
    const [actionLoading, setActionLoading] = useState(false);
    const [showVersionUpload, setShowVersionUpload] = useState(false);
    const [newVersionFile, setNewVersionFile] = useState(null);
    const [changeNotes, setChangeNotes] = useState('');
    const [approvalComment, setApprovalComment] = useState('');

    useEffect(() => {
        fetchDocumentDetails();
    }, [initialDoc.id]);

    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && !actionLoading) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [onClose, actionLoading]);

    const fetchDocumentDetails = async () => {
        try {
            const res = await client.get(`/edms/documents/${initialDoc.id}/`);
            setDocument(res.data);
        } catch (error) {
            console.error('Failed to fetch document:', error);
            toast.error('Failed to load document details');
        } finally {
            setLoading(false);
        }
    };

    const handleDownload = async () => {
        try {
            const res = await client.get(`/edms/documents/${document.id}/download/`, {
                responseType: 'blob'
            });
            const url = window.URL.createObjectURL(res.data);
            const a = window.document.createElement('a');
            a.href = url;
            a.download = document.current_version?.file_name || 'document';
            a.click();
            window.URL.revokeObjectURL(url);
            toast.success('Download started');
        } catch (error) {
            toast.error('Failed to download');
        }
    };

    const handleVersionUpload = async () => {
        if (!newVersionFile) return;

        setActionLoading(true);
        const formData = new FormData();
        formData.append('file', newVersionFile);
        formData.append('change_notes', changeNotes);

        try {
            await client.post(`/edms/documents/${document.id}/upload_version/`, formData, {
                headers: { 'Content-Type': 'multipart/form-data' }
            });
            toast.success('New version uploaded');
            setShowVersionUpload(false);
            setNewVersionFile(null);
            setChangeNotes('');
            fetchDocumentDetails();
            onUpdate?.();
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to upload version');
        } finally {
            setActionLoading(false);
        }
    };

    const handleSubmitForReview = async () => {
        setActionLoading(true);
        try {
            await client.post(`/edms/documents/${document.id}/submit_for_review/`);
            toast.success('Document submitted for review');
            fetchDocumentDetails();
            onUpdate?.();
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to submit');
        } finally {
            setActionLoading(false);
        }
    };

    const handleValidate = async () => {
        setActionLoading(true);
        try {
            await client.post(`/edms/documents/${document.id}/validate/`,
                { comments: approvalComment },
                { headers: { 'Content-Type': 'application/json' } }
            );
            toast.success('Document validated');
            setApprovalComment('');
            fetchDocumentDetails();
            onUpdate?.();
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to validate');
        } finally {
            setActionLoading(false);
        }
    };

    const handleRequestRevision = async () => {
        if (!approvalComment.trim()) {
            toast.error('Please provide comments for the revision request');
            return;
        }
        setActionLoading(true);
        try {
            await client.post(`/edms/documents/${document.id}/request_revision/`,
                { comments: approvalComment },
                { headers: { 'Content-Type': 'application/json' } }
            );
            toast.success('Revision requested');
            setApprovalComment('');
            fetchDocumentDetails();
            onUpdate?.();
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to request revision');
        } finally {
            setActionLoading(false);
        }
    };

    const handleApprove = async () => {
        setActionLoading(true);
        try {
            await client.post(`/edms/documents/${document.id}/approve/`, {
                comments: approvalComment
            });
            toast.success('Document approved');
            setApprovalComment('');
            fetchDocumentDetails();
            onUpdate?.();
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to approve');
        } finally {
            setActionLoading(false);
        }
    };

    const handleReject = async () => {
        if (!approvalComment.trim()) {
            toast.error('Please provide a reason for rejection');
            return;
        }
        setActionLoading(true);
        try {
            await client.post(`/edms/documents/${document.id}/reject/`, {
                comments: approvalComment
            });
            toast.success('Document rejected');
            setApprovalComment('');
            fetchDocumentDetails();
            onUpdate?.();
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to reject');
        } finally {
            setActionLoading(false);
        }
    };

    const getStatusConfig = (status) => {
        const configs = {
            DRAFT: { color: 'bg-slate-100 text-slate-700', icon: Edit, label: 'Draft' },
            UNDER_REVIEW: { color: 'bg-amber-100 text-amber-700', icon: Clock, label: 'Under Review' },
            REVISION_REQUESTED: { color: 'bg-orange-100 text-orange-700', icon: AlertTriangle, label: 'Revision Requested' },
            VALIDATED: { color: 'bg-blue-100 text-blue-700', icon: CheckCircle, label: 'Validated' },
            APPROVED: { color: 'bg-green-100 text-green-700', icon: CheckCircle, label: 'Approved' },
            REJECTED: { color: 'bg-red-100 text-red-700', icon: XCircle, label: 'Rejected' },
        };
        return configs[status] || configs.DRAFT;
    };

    const statusConfig = getStatusConfig(document.status);
    const StatusIcon = statusConfig.icon;

    // Determine available actions based on status and role
    const canEdit = document.can_edit;
    const canSubmit = document.status === 'DRAFT' && canEdit;
    const canValidate = document.status === 'UNDER_REVIEW' && ['PMNC_Team', 'SPV_Official', 'NICDC_HQ'].includes(userRole);
    const canApprove = document.status === 'VALIDATED' && ['SPV_Official', 'NICDC_HQ'].includes(userRole);

    if (loading) {
        return createPortal(
            <div className="fixed inset-0 z-[9999] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center">
                <Loader2 size={32} className="animate-spin text-white" />
            </div>,
            window.document.body
        );
    }

    return createPortal(
        <div className="fixed inset-0 z-[9999] bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                className="bg-white dark:bg-neutral-900 rounded-2xl w-full max-w-4xl max-h-[90vh] shadow-2xl overflow-hidden flex flex-col"
            >
                {/* Header */}
                <div className="flex justify-between items-start p-4 border-b border-slate-200 dark:border-neutral-700 bg-gradient-to-r from-slate-50 to-blue-50 dark:from-neutral-800 dark:to-neutral-800">
                    <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                            <h2 className="text-lg font-bold text-slate-800 dark:text-white truncate">
                                {document.title}
                            </h2>
                            {document.is_confidential && (
                                <Lock size={16} className="text-amber-500" />
                            )}
                        </div>
                        <div className="flex items-center gap-3 text-sm text-slate-500">
                            <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${statusConfig.color}`}>
                                <StatusIcon size={12} />
                                {statusConfig.label}
                            </span>
                            <span>v{document.current_version?.version_number || 1}</span>
                            <span>{document.document_type?.replace('_', ' ')}</span>
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                        {onViewWithNoting && (
                            <Button variant="outline" size="sm" onClick={() => onViewWithNoting(document)}>
                                <BookOpen size={16} className="mr-1" />
                                View
                            </Button>
                        )}
                        <Button variant="outline" size="sm" onClick={handleDownload}>
                            <Download size={16} className="mr-1" />
                            Download
                        </Button>
                        <Button variant="outline" size="sm" onClick={() => onDiscuss?.(document)}>
                            <MessageSquare size={16} className="mr-1" />
                            Discuss
                        </Button>
                        <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg">
                            <X size={20} className="text-slate-500" />
                        </button>
                    </div>
                </div>

                {/* Tabs */}
                <div className="flex border-b border-slate-200 px-4">
                    {['details', 'versions', 'workflow'].map(tab => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === tab
                                ? 'border-primary-600 text-primary-600'
                                : 'border-transparent text-slate-500 hover:text-slate-700'
                                }`}
                        >
                            {tab.charAt(0).toUpperCase() + tab.slice(1)}
                        </button>
                    ))}
                </div>

                {/* Content */}
                <div className="flex-1 overflow-y-auto p-4">
                    <AnimatePresence mode="wait">
                        {/* Details Tab */}
                        {activeTab === 'details' && (
                            <motion.div
                                key="details"
                                initial={{ opacity: 0, x: -20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: 20 }}
                                transition={{ duration: 0.2, ease: "easeInOut" }}
                                className="space-y-4"
                            >
                                {/* Document Info */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="p-3 bg-slate-50 rounded-lg">
                                        <p className="text-xs text-slate-500 mb-1">Document Number</p>
                                        <p className="font-medium text-slate-800">{document.document_number || '-'}</p>
                                    </div>
                                    <div className="p-3 bg-slate-50 rounded-lg">
                                        <p className="text-xs text-slate-500 mb-1">Folder</p>
                                        <p className="font-medium text-slate-800">{document.folder_path || 'Root'}</p>
                                    </div>
                                    <div className="p-3 bg-slate-50 rounded-lg">
                                        <p className="text-xs text-slate-500 mb-1">Uploaded By</p>
                                        <p className="font-medium text-slate-800">{document.uploaded_by_name}</p>
                                    </div>
                                    <div className="p-3 bg-slate-50 rounded-lg">
                                        <p className="text-xs text-slate-500 mb-1">Uploaded</p>
                                        <p className="font-medium text-slate-800">
                                            {format(new Date(document.created_at), 'dd MMM yyyy, HH:mm')}
                                        </p>
                                    </div>
                                </div>

                                {/* Description */}
                                {document.description && (
                                    <div className="p-3 bg-slate-50 rounded-lg">
                                        <p className="text-xs text-slate-500 mb-1">Description</p>
                                        <p className="text-sm text-slate-700">{document.description}</p>
                                    </div>
                                )}

                                {/* Current Version Info */}
                                {document.current_version && (
                                    <div className="p-3 bg-blue-50 rounded-lg">
                                        <p className="text-xs text-blue-600 mb-1">Current Version</p>
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="font-medium text-slate-800">{document.current_version.file_name}</p>
                                                <p className="text-xs text-slate-500">
                                                    {document.current_version.file_size_display} â€¢ {document.current_version.mime_type}
                                                </p>
                                            </div>
                                            <span className="text-sm font-semibold text-blue-600">
                                                v{document.current_version.version_number}
                                            </span>
                                        </div>
                                    </div>
                                )}

                                {/* Upload New Version */}
                                {canEdit && (
                                    <div className="border border-dashed border-slate-300 rounded-lg p-4">
                                        {!showVersionUpload ? (
                                            <button
                                                onClick={() => setShowVersionUpload(true)}
                                                className="flex items-center gap-2 text-sm text-primary-600 hover:text-primary-700"
                                            >
                                                <Upload size={16} />
                                                Upload New Version
                                            </button>
                                        ) : (
                                            <div className="space-y-3">
                                                <input
                                                    type="file"
                                                    onChange={(e) => setNewVersionFile(e.target.files?.[0] || null)}
                                                    className="text-sm"
                                                />
                                                <textarea
                                                    value={changeNotes}
                                                    onChange={(e) => setChangeNotes(e.target.value)}
                                                    placeholder="What changed in this version?"
                                                    className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm resize-none"
                                                    rows={2}
                                                />
                                                <div className="flex gap-2">
                                                    <Button
                                                        size="sm"
                                                        onClick={handleVersionUpload}
                                                        disabled={!newVersionFile || actionLoading}
                                                    >
                                                        {actionLoading ? <Loader2 size={14} className="animate-spin mr-1" /> : null}
                                                        Upload
                                                    </Button>
                                                    <Button
                                                        size="sm"
                                                        variant="outline"
                                                        onClick={() => {
                                                            setShowVersionUpload(false);
                                                            setNewVersionFile(null);
                                                        }}
                                                    >
                                                        Cancel
                                                    </Button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </motion.div>
                        )}

                        {/* Versions Tab */}
                        {activeTab === 'versions' && (
                            <motion.div
                                key="versions"
                                initial={{ opacity: 0, x: -20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: 20 }}
                                transition={{ duration: 0.2, ease: "easeInOut" }}
                                className="space-y-3"
                            >
                                {document.versions?.map((version, index) => (
                                    <div
                                        key={version.id}
                                        className={`p-3 rounded-lg border ${version.id === document.current_version?.id
                                            ? 'border-primary-200 bg-primary-50'
                                            : 'border-slate-200'
                                            }`}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${version.id === document.current_version?.id
                                                    ? 'bg-primary-600 text-white'
                                                    : 'bg-slate-200 text-slate-600'
                                                    }`}>
                                                    v{version.version_number}
                                                </span>
                                                <div>
                                                    <p className="font-medium text-sm text-slate-800">{version.file_name}</p>
                                                    <p className="text-xs text-slate-500">
                                                        By {version.uploaded_by_name} â€¢ {formatDistanceToNow(new Date(version.created_at), { addSuffix: true })}
                                                    </p>
                                                </div>
                                            </div>
                                            <Button variant="ghost" size="sm" onClick={handleDownload}>
                                                <Download size={14} />
                                            </Button>
                                        </div>
                                        {version.change_notes && (
                                            <p className="text-xs text-slate-600 mt-2 italic">
                                                "{version.change_notes}"
                                            </p>
                                        )}
                                    </div>
                                ))}
                            </motion.div>
                        )}

                        {/* Workflow Tab */}
                        {activeTab === 'workflow' && (
                            <motion.div
                                key="workflow"
                                initial={{ opacity: 0, x: -20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: 20 }}
                                transition={{ duration: 0.2, ease: "easeInOut" }}
                                className="space-y-4"
                            >
                                {document.workflow ? (
                                    <div className="space-y-3">
                                        {document.workflow.steps?.map((step, index) => {
                                            const isComplete = step.action !== 'PENDING';
                                            return (
                                                <div key={step.id} className="flex items-start gap-3">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isComplete ? 'bg-green-100' : 'bg-slate-100'
                                                        }`}>
                                                        {isComplete ? (
                                                            <CheckCircle size={16} className="text-green-600" />
                                                        ) : (
                                                            <Clock size={16} className="text-slate-400" />
                                                        )}
                                                    </div>
                                                    <div className="flex-1">
                                                        <p className="font-medium text-sm text-slate-800">
                                                            {step.step_type?.replace('_', ' ')}
                                                        </p>
                                                        {isComplete ? (
                                                            <p className="text-xs text-slate-500">
                                                                {step.action} by {step.actor_name} â€¢ {formatDistanceToNow(new Date(step.acted_at), { addSuffix: true })}
                                                            </p>
                                                        ) : (
                                                            <p className="text-xs text-slate-400">Pending</p>
                                                        )}
                                                        {step.comments && (
                                                            <p className="text-xs text-slate-600 mt-1 italic">"{step.comments}"</p>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <div className="text-center py-8 text-slate-400">
                                        <Clock size={32} className="mx-auto mb-2" />
                                        <p>No workflow started yet</p>
                                    </div>
                                )}

                                {/* Workflow Actions */}
                                <div className="border-t border-slate-200 pt-4 space-y-3">
                                    {/* Submit for Review */}
                                    {canSubmit && (
                                        <Button onClick={handleSubmitForReview} disabled={actionLoading} className="w-full">
                                            <Send size={16} className="mr-2" />
                                            Submit for Review
                                        </Button>
                                    )}

                                    {/* PMNC Actions */}
                                    {canValidate && (
                                        <>
                                            <textarea
                                                value={approvalComment}
                                                onChange={(e) => setApprovalComment(e.target.value)}
                                                placeholder="Add comments (required for revision/rejection)"
                                                className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm resize-none"
                                                rows={2}
                                            />
                                            <div className="flex gap-2">
                                                <Button onClick={handleValidate} disabled={actionLoading} className="flex-1">
                                                    <CheckCircle size={16} className="mr-1" />
                                                    Validate
                                                </Button>
                                                <Button
                                                    variant="outline"
                                                    onClick={handleRequestRevision}
                                                    disabled={actionLoading}
                                                    className="flex-1"
                                                >
                                                    <AlertTriangle size={16} className="mr-1" />
                                                    Request Revision
                                                </Button>
                                            </div>
                                        </>
                                    )}

                                    {/* SPV Actions */}
                                    {canApprove && (
                                        <>
                                            <textarea
                                                value={approvalComment}
                                                onChange={(e) => setApprovalComment(e.target.value)}
                                                placeholder="Add comments (required for rejection)"
                                                className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm resize-none"
                                                rows={2}
                                            />
                                            <div className="flex gap-2">
                                                <Button onClick={handleApprove} disabled={actionLoading} className="flex-1 bg-green-600 hover:bg-green-700">
                                                    <CheckCircle size={16} className="mr-1" />
                                                    Final Approval
                                                </Button>
                                                <Button
                                                    variant="outline"
                                                    onClick={handleReject}
                                                    disabled={actionLoading}
                                                    className="flex-1 text-red-600 border-red-200 hover:bg-red-50"
                                                >
                                                    <XCircle size={16} className="mr-1" />
                                                    Reject
                                                </Button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>
            </motion.div>
        </div>,
        window.document.body
    );
};

export default DocumentDetailModal;



================================================
FILE: frontend/src/components/edms/DocumentList.jsx
================================================
/**
 * DocumentList - Table/Grid view of documents with actions
 * Displays documents with status, type, version, and quick actions
 */
import { useState } from 'react';
import { motion } from 'framer-motion';
import {
    FileText, Download, Eye, MessageSquare, CheckCircle, XCircle,
    Clock, AlertTriangle, Edit, MoreHorizontal, Grid, List,
    FileImage, FileSpreadsheet, File, Loader2, BookOpen
} from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';

const DocumentList = ({
    documents,
    loading,
    viewMode = 'table',
    onView,
    onViewWithNoting,  // Opens document viewer with noting sheet
    onDownload,
    onDiscuss,
    selectedDocId
}) => {
    const getStatusConfig = (status) => {
        const configs = {
            DRAFT: { color: 'bg-slate-100 text-slate-700', icon: Edit, label: 'Draft' },
            UNDER_REVIEW: { color: 'bg-amber-100 text-amber-700', icon: Clock, label: 'Under Review' },
            REVISION_REQUESTED: { color: 'bg-orange-100 text-orange-700', icon: AlertTriangle, label: 'Revision Requested' },
            VALIDATED: { color: 'bg-blue-100 text-blue-700', icon: CheckCircle, label: 'Validated' },
            APPROVED: { color: 'bg-green-100 text-green-700', icon: CheckCircle, label: 'Approved' },
            REJECTED: { color: 'bg-red-100 text-red-700', icon: XCircle, label: 'Rejected' },
            ARCHIVED: { color: 'bg-gray-100 text-gray-500', icon: File, label: 'Archived' }
        };
        return configs[status] || configs.DRAFT;
    };

    const getTypeIcon = (type) => {
        const icons = {
            DRAWING: FileImage,
            REPORT: FileText,
            CONTRACT: FileSpreadsheet,
            CORRESPONDENCE: FileText,
            SPECIFICATION: FileText,
            INVOICE: FileSpreadsheet,
            MEDIA: FileImage,
            OTHER: File
        };
        return icons[type] || File;
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center py-16">
                <Loader2 size={32} className="animate-spin text-slate-400" />
            </div>
        );
    }

    if (!documents || documents.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center py-16 text-center">
                <div className="w-16 h-16 bg-slate-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mb-4">
                    <FileText size={32} className="text-slate-400 dark:text-neutral-500" />
                </div>
                <h3 className="text-lg font-semibold text-slate-700 dark:text-white">No Documents</h3>
                <p className="text-sm text-slate-500 dark:text-neutral-400 mt-1">
                    Upload your first document to get started
                </p>
            </div>
        );
    }

    // Table View
    if (viewMode === 'table') {
        return (
            <div className="overflow-x-auto">
                <table className="w-full">
                    <thead>
                        <tr className="border-b border-slate-200 dark:border-neutral-700">
                            <th className="text-left py-3 px-4 text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wider">
                                Document
                            </th>
                            <th className="text-left py-3 px-4 text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wider">
                                Type
                            </th>
                            <th className="text-left py-3 px-4 text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wider">
                                Status
                            </th>
                            <th className="text-left py-3 px-4 text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wider">
                                Version
                            </th>
                            <th className="text-left py-3 px-4 text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wider">
                                Uploaded
                            </th>
                            <th className="text-right py-3 px-4 text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {documents.map((doc, index) => {
                            const statusConfig = getStatusConfig(doc.status);
                            const StatusIcon = statusConfig.icon;
                            const TypeIcon = getTypeIcon(doc.document_type);
                            const isSelected = selectedDocId === doc.id;

                            return (
                                <motion.tr
                                    key={doc.id}
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    transition={{ delay: index * 0.03 }}
                                    className={`border-b border-slate-100 dark:border-neutral-800 hover:bg-slate-50 dark:hover:bg-neutral-800 cursor-pointer transition-colors ${isSelected ? 'bg-primary-50 dark:bg-primary-900/20' : ''
                                        }`}
                                    onClick={() => onView(doc)}
                                >
                                    <td className="py-3 px-4">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-lg bg-slate-100 dark:bg-neutral-800 flex items-center justify-center">
                                                <TypeIcon size={20} className="text-slate-500 dark:text-neutral-400" />
                                            </div>
                                            <div>
                                                <p className="font-medium text-slate-800 dark:text-white text-sm line-clamp-1">
                                                    {doc.title}
                                                </p>
                                                {doc.document_number && (
                                                    <p className="text-xs text-slate-500">{doc.document_number}</p>
                                                )}
                                            </div>
                                        </div>
                                    </td>
                                    <td className="py-3 px-4">
                                        <span className="text-sm text-slate-600 dark:text-neutral-400">
                                            {doc.document_type.replace('_', ' ')}
                                        </span>
                                    </td>
                                    <td className="py-3 px-4">
                                        <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${statusConfig.color}`}>
                                            <StatusIcon size={12} />
                                            {statusConfig.label}
                                        </span>
                                    </td>
                                    <td className="py-3 px-4">
                                        <span className="text-sm text-slate-600 dark:text-neutral-400">
                                            v{doc.current_version_number || 1}
                                        </span>
                                    </td>
                                    <td className="py-3 px-4">
                                        <div>
                                            <p className="text-sm text-slate-600 dark:text-neutral-400">{doc.uploaded_by_name}</p>
                                            <p className="text-xs text-slate-400 dark:text-neutral-500">
                                                {formatDistanceToNow(new Date(doc.created_at), { addSuffix: true })}
                                            </p>
                                        </div>
                                    </td>
                                    <td className="py-3 px-4">
                                        <div className="flex items-center justify-end gap-1">
                                            {onViewWithNoting && (
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onViewWithNoting(doc);
                                                    }}
                                                    className="p-2 hover:bg-primary-100 rounded-lg transition-colors"
                                                    title="View with Noting Sheet"
                                                >
                                                    <BookOpen size={16} className="text-primary-600" />
                                                </button>
                                            )}
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    onView(doc);
                                                }}
                                                className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-700 rounded-lg transition-colors"
                                                title="Quick View"
                                            >
                                                <Eye size={16} className="text-slate-500" />
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    onDownload(doc);
                                                }}
                                                className="p-2 hover:bg-slate-100 rounded-lg transition-colors"
                                                title="Download"
                                            >
                                                <Download size={16} className="text-slate-500" />
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    onDiscuss(doc);
                                                }}
                                                className="p-2 hover:bg-slate-100 rounded-lg transition-colors"
                                                title="Discuss"
                                            >
                                                <MessageSquare size={16} className="text-slate-500" />
                                            </button>
                                        </div>
                                    </td>
                                </motion.tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        );
    }

    // Grid View
    return (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-4">
            {documents.map((doc, index) => {
                const statusConfig = getStatusConfig(doc.status);
                const StatusIcon = statusConfig.icon;
                const TypeIcon = getTypeIcon(doc.document_type);
                const isSelected = selectedDocId === doc.id;

                return (
                    <motion.div
                        key={doc.id}
                        initial={{ opacity: 0, scale: 0.95 }}
                        animate={{ opacity: 1, scale: 1 }}
                        transition={{ delay: index * 0.03 }}
                        className={`bg-white rounded-xl border p-4 cursor-pointer hover:shadow-md transition-all ${isSelected ? 'border-primary-500 ring-2 ring-primary-100' : 'border-slate-200'
                            }`}
                        onClick={() => onView(doc)}
                    >
                        {/* Icon & Type */}
                        <div className="flex items-start justify-between mb-3">
                            <div className="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center">
                                <TypeIcon size={24} className="text-slate-500" />
                            </div>
                            <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${statusConfig.color}`}>
                                <StatusIcon size={10} />
                                {statusConfig.label}
                            </span>
                        </div>

                        {/* Title */}
                        <h3 className="font-semibold text-slate-800 text-sm line-clamp-2 mb-1">
                            {doc.title}
                        </h3>
                        {doc.document_number && (
                            <p className="text-xs text-slate-500 mb-2">{doc.document_number}</p>
                        )}

                        {/* Meta */}
                        <div className="flex items-center justify-between text-xs text-slate-400 mt-3 pt-3 border-t border-slate-100">
                            <span>v{doc.current_version_number || 1}</span>
                            <span>{formatDistanceToNow(new Date(doc.created_at), { addSuffix: true })}</span>
                        </div>

                        {/* Quick Actions */}
                        <div className="flex items-center gap-1 mt-3">
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    onDownload(doc);
                                }}
                                className="flex-1 py-2 text-xs text-slate-600 hover:bg-slate-100 rounded-lg transition-colors flex items-center justify-center gap-1"
                            >
                                <Download size={14} />
                                Download
                            </button>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    onDiscuss(doc);
                                }}
                                className="flex-1 py-2 text-xs text-slate-600 hover:bg-slate-100 rounded-lg transition-colors flex items-center justify-center gap-1"
                            >
                                <MessageSquare size={14} />
                                Discuss
                            </button>
                        </div>
                    </motion.div>
                );
            })}
        </div>
    );
};

export default DocumentList;



================================================
FILE: frontend/src/components/edms/DocumentUploadModal.jsx
================================================
/**
 * DocumentUploadModal - Drag & drop file upload with folder selection
 */
import { useState, useCallback, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion } from 'framer-motion';
import { useDropzone } from 'react-dropzone';
import {
    X, Upload, FileText, Loader2, Check,
    FileImage, FileSpreadsheet, File, AlertCircle,
    Folder, Plus, ChevronDown
} from 'lucide-react';
import client from '@/api/client';
import { toast } from 'sonner';
import Button from '@/components/ui/Button';
import Toggle from '@/components/ui/Toggle';

const DocumentUploadModal = ({ onClose, projectId, currentFolderId = null, onUploaded }) => {
    const [files, setFiles] = useState([]);
    const [title, setTitle] = useState(''); // Only used for single file
    const [description, setDescription] = useState('');
    const [documentType, setDocumentType] = useState('OTHER');
    const [isConfidential, setIsConfidential] = useState(false);
    const [isUploading, setIsUploading] = useState(false);

    // Auto-routing: Category-based smart filing
    const [useCategory, setUseCategory] = useState(true); // Default to category mode
    const [selectedCategory, setSelectedCategory] = useState(''); // Auto-route category

    // Folder selection (fallback/manual mode)
    const [folders, setFolders] = useState([]);
    const [selectedFolderId, setSelectedFolderId] = useState(currentFolderId);
    const [showCreateFolder, setShowCreateFolder] = useState(false);
    const [newFolderName, setNewFolderName] = useState('');
    const [isCreatingFolder, setIsCreatingFolder] = useState(false);
    const [loadingFolders, setLoadingFolders] = useState(true);

    // All 35 auto-routing categories matching backend DirectoryService
    const routeCategories = [
        { value: '', label: '-- Select Category --', group: '' },
        // Planning & Approvals
        { value: 'ADMIN_APPROVAL', label: 'Admin Approval', group: 'Planning & Approvals' },
        { value: 'DPR', label: 'Detailed Project Report (DPR)', group: 'Planning & Approvals' },
        { value: 'FEASIBILITY', label: 'Feasibility Report', group: 'Planning & Approvals' },
        { value: 'SITE_SURVEY', label: 'Site Survey', group: 'Planning & Approvals' },
        { value: 'ENV_CLEARANCE', label: 'Environmental Clearance', group: 'Planning & Approvals' },
        // Procurement & Contracts
        { value: 'TENDER', label: 'Tender Document', group: 'Procurement & Contracts' },
        { value: 'AGREEMENT', label: 'Agreement', group: 'Procurement & Contracts' },
        { value: 'WORK_ORDER', label: 'Work Order', group: 'Procurement & Contracts' },
        { value: 'LOA', label: 'Letter of Acceptance', group: 'Procurement & Contracts' },
        { value: 'TENDER_EVALUATION', label: 'Tender Evaluation', group: 'Procurement & Contracts' },
        // Engineering & Design
        { value: 'DRAWING', label: 'Drawing', group: 'Engineering & Design' },
        { value: 'BOQ', label: 'Bill of Quantities', group: 'Engineering & Design' },
        { value: 'TECH_SPEC', label: 'Technical Specification', group: 'Engineering & Design' },
        { value: 'AS_BUILT', label: 'As-Built Drawing', group: 'Engineering & Design' },
        // Financials
        { value: 'RA_BILL', label: 'RA Bill', group: 'Financials' },
        { value: 'INVOICE', label: 'Tax Invoice', group: 'Financials' },
        { value: 'PAYMENT_ADVICE', label: 'Payment Advice', group: 'Financials' },
        { value: 'BUDGET', label: 'Budget Estimate', group: 'Financials' },
        { value: 'FINAL_BILL', label: 'Final Bill', group: 'Financials' },
        { value: 'FUNDING_PROOF', label: 'Fund Sanction Order', group: 'Financials' },
        // Site Execution
        { value: 'DAILY_REPORT', label: 'Daily Progress Report', group: 'Site Execution' },
        { value: 'SITE_PHOTO', label: 'Site Photograph', group: 'Site Execution' },
        { value: 'INSPECTION', label: 'Inspection Report', group: 'Site Execution' },
        { value: 'RISK_EVIDENCE', label: 'Risk Evidence', group: 'Site Execution' },
        { value: 'QUALITY_REPORT', label: 'Quality Report', group: 'Site Execution' },
        { value: 'SAFETY_REPORT', label: 'Safety Report', group: 'Site Execution' },
        // Legal & Compliance
        { value: 'INSURANCE', label: 'Insurance', group: 'Legal & Compliance' },
        { value: 'BANK_GUARANTEE', label: 'Bank Guarantee', group: 'Legal & Compliance' },
        { value: 'NOTICE', label: 'Notice', group: 'Legal & Compliance' },
        { value: 'NOC', label: 'No Objection Certificate', group: 'Legal & Compliance' },
        { value: 'LICENSE', label: 'License', group: 'Legal & Compliance' },
        // Correspondence
        { value: 'CORRESPONDENCE_IN', label: 'Incoming Correspondence', group: 'Correspondence' },
        { value: 'CORRESPONDENCE_OUT', label: 'Outgoing Correspondence', group: 'Correspondence' },
        { value: 'MEETING_MINUTES', label: 'Meeting Minutes', group: 'Correspondence' },
        // Fallback
        { value: 'OTHER', label: 'Other/Miscellaneous', group: 'Other' },
    ];

    const documentTypes = [
        { value: 'DRAWING', label: 'Drawing' },
        { value: 'REPORT', label: 'Report' },
        { value: 'CONTRACT', label: 'Contract' },
        { value: 'CORRESPONDENCE', label: 'Correspondence' },
        { value: 'SPECIFICATION', label: 'Specification' },
        { value: 'INVOICE', label: 'Invoice' },
        { value: 'MEDIA', label: 'Media' },
        { value: 'OTHER', label: 'Other' },
    ];

    useEffect(() => {
        fetchFolders();
    }, [projectId]);

    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && !isUploading) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [onClose, isUploading]);

    const fetchFolders = async () => {
        setLoadingFolders(true);
        try {
            const res = await client.get(`/edms/folders/?project=${projectId}`);
            const folderList = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setFolders(folderList);
        } catch (error) {
            console.error('Failed to fetch folders:', error);
        } finally {
            setLoadingFolders(false);
        }
    };

    const handleCreateFolder = async () => {
        if (!newFolderName.trim()) return;

        setIsCreatingFolder(true);
        try {
            const res = await client.post('/edms/folders/', {
                name: newFolderName.trim(),
                project: projectId,
                parent: currentFolderId || null
            });
            toast.success('Folder created');
            setNewFolderName('');
            setShowCreateFolder(false);
            setFolders(prev => [...prev, res.data]);
            setSelectedFolderId(res.data.id);
        } catch (error) {
            toast.error('Failed to create folder');
        } finally {
            setIsCreatingFolder(false);
        }
    };

    const onDrop = useCallback((acceptedFiles, fileRejections) => {
        if (fileRejections.length > 0) {
            const rejection = fileRejections[0];
            const errorMsg = rejection.errors[0]?.message || 'File type not supported';
            toast.error(`Cannot upload ${rejection.file.name}: ${errorMsg}`);
        }

        if (acceptedFiles.length > 0) {
            const newFiles = acceptedFiles.map(f => ({
                file: f,
                id: Math.random().toString(36).substring(7),
                status: 'pending', // pending, uploading, success, error
                progress: 0
            }));

            setFiles(prev => {
                const updated = [...prev, ...newFiles];
                // Auto-fill title if this is the ONLY file and no title set
                if (updated.length === 1 && !title) {
                    setTitle(updated[0].file.name.replace(/\.[^/.]+$/, ''));
                }
                return updated;
            });

            // Auto-detect type from first file if not set
            const firstExt = acceptedFiles[0].name.split('.').pop().toLowerCase();
            if (['pdf', 'doc', 'docx', 'txt', 'rtf'].includes(firstExt)) {
                setDocumentType('REPORT');
            } else if (['dwg', 'dxf', 'cad'].includes(firstExt)) {
                setDocumentType('DRAWING');
            } else if (['xls', 'xlsx', 'csv'].includes(firstExt)) {
                setDocumentType('INVOICE');
            } else if (['jpg', 'jpeg', 'png', 'gif', 'mp4', 'mov', 'avi'].includes(firstExt)) {
                setDocumentType('MEDIA');
            }
        }
    }, [title]);

    const { getRootProps, getInputProps, isDragActive } = useDropzone({
        onDrop,
        multiple: true,
        accept: {
            'application/pdf': ['.pdf'],
            'application/msword': ['.doc'],
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
            'application/vnd.ms-excel': ['.xls'],
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
            'text/csv': ['.csv'],
            'application/vnd.ms-powerpoint': ['.ppt'],
            'application/vnd.openxmlformats-officedocument.presentationml.presentation': ['.pptx'],
            'text/plain': ['.txt'],
            'text/rtf': ['.rtf'],
            'image/*': ['.png', '.jpg', '.jpeg', '.gif', '.webp'],
            'video/*': ['.mp4', '.mov', '.avi', '.webm'],
            'application/octet-stream': ['.dwg', '.dxf'],
            'image/vnd.dxf': ['.dxf'],
        }
    });

    const removeFile = (id) => {
        setFiles(prev => prev.filter(f => f.id !== id));
    };

    const getFileIcon = (fileName) => {
        const ext = fileName.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return FileImage;
        if (['xls', 'xlsx', 'csv'].includes(ext)) return FileSpreadsheet;
        return FileText;
    };

    const formatFileSize = (bytes) => {
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        if (files.length === 0) {
            toast.error('Please select at least one file');
            return;
        }

        // ROBUST VALIDATION: Require category when in category mode
        if (useCategory && !selectedCategory) {
            toast.error('Please select a document category');
            return;
        }

        // Title is now optional - backend will use filename if not provided

        setIsUploading(true);
        let successCount = 0;

        for (const fileObj of files) {
            if (fileObj.status === 'success') {
                successCount++;
                continue;
            }

            // Update status to uploading
            setFiles(prev => prev.map(f => f.id === fileObj.id ? { ...f, status: 'uploading' } : f));

            const formData = new FormData();
            formData.append('file', fileObj.file);
            // Use manual title for single file, otherwise filename
            const finalTitle = (files.length === 1 && title.trim())
                ? title.trim()
                : fileObj.file.name.replace(/\.[^/.]+$/, '');

            formData.append('title', finalTitle);
            formData.append('description', description);
            formData.append('document_type', documentType);
            formData.append('project', projectId);
            formData.append('is_confidential', isConfidential);

            // ROBUST ROUTING: Category takes precedence over manual folder
            if (useCategory && selectedCategory) {
                formData.append('auto_route_category', selectedCategory);
                // DO NOT send folder when using category (backend handles it)
            } else if (selectedFolderId) {
                // Manual folder mode
                formData.append('folder', selectedFolderId);
            }
            // If neither, backend will use root folder

            try {
                await client.post('/edms/documents/', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' },
                    onUploadProgress: (progressEvent) => {
                        const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        setFiles(prev => prev.map(f => f.id === fileObj.id ? { ...f, progress: percent } : f));
                    }
                });

                setFiles(prev => prev.map(f => f.id === fileObj.id ? { ...f, status: 'success', progress: 100 } : f));
                successCount++;
            } catch (error) {
                console.error('Upload failed for', fileObj.file.name, error);
                setFiles(prev => prev.map(f => f.id === fileObj.id ? { ...f, status: 'error' } : f));
                toast.error(`Failed to upload ${fileObj.file.name}`);
            }
        }

        setIsUploading(false);

        if (successCount === files.length) {
            toast.success(`Successfully uploaded ${successCount} document(s)`);
            onUploaded && onUploaded(); // Refresh parent
            onClose();
        } else if (successCount > 0) {
            toast.warning(`Uploaded ${successCount} of ${files.length} documents. Some failed.`);
            onUploaded && onUploaded();
        }
    };

    const getSelectedFolderPath = () => {
        if (!selectedFolderId) return 'Root (No folder)';
        const folder = folders.find(f => f.id === selectedFolderId);
        return folder?.full_path || folder?.name || 'Selected folder';
    };

    return createPortal(
        <div className="fixed inset-0 z-[9999] bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                className="bg-white dark:bg-neutral-900 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden max-h-[90vh] flex flex-col"
            >
                {/* Header */}
                <div className="flex justify-between items-center p-4 border-b border-slate-200 dark:border-neutral-700 bg-gradient-to-r from-primary-50 to-blue-50 dark:from-neutral-800 dark:to-neutral-800">
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <Upload className="text-primary-600" size={20} />
                            Upload Document(s)
                        </h2>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-white/50 dark:hover:bg-neutral-700 rounded-lg transition-colors">
                        <X size={20} className="text-slate-500 dark:text-neutral-400" />
                    </button>
                </div>

                <form onSubmit={handleSubmit} className="p-4 space-y-4 overflow-y-auto flex-1">
                    {/* Dropzone */}
                    <div
                        {...getRootProps()}
                        className={`border-2 border-dashed rounded-xl p-6 text-center cursor-pointer transition-all ${isDragActive
                            ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20'
                            : 'border-slate-300 dark:border-neutral-600 hover:border-slate-400 dark:hover:border-neutral-500 bg-white dark:bg-neutral-800'
                            }`}
                    >
                        <input {...getInputProps()} />
                        <Upload size={32} className={`mx-auto ${isDragActive ? 'text-primary-600' : 'text-slate-400'}`} />
                        <p className="text-sm text-slate-600 dark:text-neutral-300 mt-2">
                            {isDragActive ? 'Drop files here' : 'Drag & drop files, or click to browse'}
                        </p>
                        <p className="text-xs text-slate-400 dark:text-neutral-500 mt-1">
                            PDF, Word, Excel, Images, Media, CAD
                        </p>
                    </div>

                    {/* File List */}
                    {files.length > 0 && (
                        <div className="space-y-2 max-h-40 overflow-y-auto pr-1">
                            {files.map((fObj) => {
                                const Icon = getFileIcon(fObj.file.name);
                                return (
                                    <div key={fObj.id} className="flex items-center gap-3 p-2 bg-slate-50 dark:bg-neutral-800 rounded-lg border border-slate-100 dark:border-neutral-700">
                                        <div className="w-8 h-8 rounded bg-white dark:bg-neutral-900 flex items-center justify-center border border-slate-200 dark:border-neutral-700">
                                            <Icon size={16} className="text-slate-500 dark:text-neutral-400" />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <p className="text-sm font-medium text-slate-700 dark:text-neutral-200 truncate">{fObj.file.name}</p>
                                            <div className="flex items-center gap-2 text-xs text-slate-400 dark:text-neutral-500">
                                                <span>{formatFileSize(fObj.file.size)}</span>
                                                {fObj.status === 'uploading' && <span className="text-primary-600">Uploading {fObj.progress}%</span>}
                                                {fObj.status === 'success' && <span className="text-green-600">Done</span>}
                                                {fObj.status === 'error' && <span className="text-red-500">Failed</span>}
                                            </div>
                                            {fObj.status === 'uploading' && (
                                                <div className="h-1 bg-slate-200 dark:bg-neutral-700 rounded-full mt-1 overflow-hidden">
                                                    <div className="h-full bg-primary-500 transition-all duration-300" style={{ width: `${fObj.progress}%` }} />
                                                </div>
                                            )}
                                        </div>
                                        {!isUploading && fObj.status !== 'success' && (
                                            <button type="button" onClick={() => removeFile(fObj.id)} className="p-1 hover:bg-slate-200 dark:hover:bg-neutral-700 rounded text-slate-400 hover:text-red-500">
                                                <X size={14} />
                                            </button>
                                        )}
                                        {fObj.status === 'success' && <Check size={16} className="text-green-600" />}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Common Metadata */}
                    <div className="p-3 bg-slate-50 dark:bg-neutral-800 rounded-xl border border-slate-200/60 dark:border-neutral-700 space-y-3">
                        <p className="text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wider">Common Settings</p>

                        {/* Smart Routing Toggle */}
                        <div className="flex items-center justify-between mb-3 pb-3 border-b border-slate-200/60 dark:border-neutral-700">
                            <div>
                                <label className="text-xs font-medium text-slate-700 dark:text-neutral-300">Filing Mode</label>
                                <p className="text-[10px] text-slate-400 dark:text-neutral-500 mt-0.5">
                                    {useCategory ? 'Smart auto-filing by category' : 'Manual folder selection'}
                                </p>
                            </div>
                            <Toggle
                                checked={useCategory}
                                onCheckedChange={setUseCategory}
                            />
                        </div>

                        {/* Category Selection (Smart Mode) */}
                        {useCategory ? (
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                    Document Category <span className="text-red-500">*</span>
                                </label>
                                <select
                                    value={selectedCategory}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    required={useCategory}
                                    className="w-full px-2 py-1.5 bg-white dark:bg-neutral-900 dark:text-white border border-slate-200 dark:border-neutral-700 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                                >
                                    {routeCategories.map((cat) => (
                                        <option key={cat.value} value={cat.value}>
                                            {cat.label}
                                        </option>
                                    ))}
                                </select>
                                <p className="text-[10px] text-slate-400 dark:text-neutral-500 mt-1">
                                    Documents will auto-file to the correct folder
                                </p>
                            </div>
                        ) : (
                            /* Manual Folder Selection */
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">Folder</label>
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <select
                                            value={selectedFolderId || ''}
                                            onChange={(e) => setSelectedFolderId(e.target.value || null)}
                                            disabled={loadingFolders}
                                            className="w-full pl-2 pr-8 py-1.5 bg-white dark:bg-neutral-900 dark:text-white border border-slate-200 dark:border-neutral-700 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                                        >
                                            <option value="">Root (No folder)</option>
                                            {folders.map(folder => (
                                                <option key={folder.id} value={folder.id}>
                                                    {folder.full_path || folder.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <Button
                                        type="button"
                                        variant="outline"
                                        size="sm"
                                        onClick={() => setShowCreateFolder(!showCreateFolder)}
                                    >
                                        <Plus size={14} />
                                    </Button>
                                </div>
                            </div>
                        )}

                        {/* Create Folder Form (Manual Mode Only) */}
                        {!useCategory && showCreateFolder && (
                            <div className="mt-2 flex gap-2">
                                <input
                                    type="text"
                                    value={newFolderName}
                                    onChange={(e) => setNewFolderName(e.target.value)}
                                    placeholder="Folder name"
                                    onKeyPress={(e) => e.key === 'Enter' && handleCreateFolder()}
                                    className="flex-1 px-3 py-1.5 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 dark:text-white rounded text-sm"
                                />
                                <Button type="button" size="sm" onClick={handleCreateFolder} disabled={isCreatingFolder || !newFolderName.trim()}>
                                    {isCreatingFolder ? <Loader2 className="animate-spin" size={14} /> : 'Create'}
                                </Button>
                            </div>
                        )}

                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">Type</label>
                                <select
                                    value={documentType}
                                    onChange={(e) => setDocumentType(e.target.value)}
                                    className="w-full px-2 py-1.5 bg-white dark:bg-neutral-900 dark:text-white border border-slate-200 dark:border-neutral-700 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                                >
                                    {documentTypes.map(t => (
                                        <option key={t.value} value={t.value}>{t.label}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex items-end">
                                <div className="flex items-center gap-3 pb-2">
                                    <Toggle
                                        checked={isConfidential}
                                        onChange={(val) => setIsConfidential(val)}
                                        size="sm"
                                    />
                                    <span className="text-sm text-slate-700 dark:text-neutral-300 font-medium">Confidential</span>
                                </div>
                            </div>
                        </div>

                        {/* Title Input - Only show if single file */}
                        {
                            files.length <= 1 && (
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                        Title <span className="text-slate-400 dark:text-neutral-500">(optional)</span>
                                    </label>
                                    <input
                                        type="text"
                                        value={title}
                                        onChange={(e) => setTitle(e.target.value)}
                                        placeholder="Leave blank to use filename"
                                        className="w-full px-3 py-1.5 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 dark:text-white rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                    <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">
                                        ğŸ’¡ If a document with this name exists, a new version will be created
                                    </p>
                                </div>
                            )
                        }

                        {/* Document Number Input Removed */}

                        < div >
                            <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">Description</label>
                            <textarea
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder="Description (applied to all files)"
                                className="w-full px-3 py-1.5 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 dark:text-white rounded text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary-500"
                                rows={2}
                            />
                        </div >
                    </div >

                    {/* Actions */}
                    < div className="flex justify-end gap-2 pt-2" >
                        <Button type="button" variant="outline" onClick={onClose} disabled={isUploading}>
                            Cancel
                        </Button>
                        <Button type="submit" disabled={isUploading || files.length === 0}>
                            {isUploading ? (
                                <>
                                    <Loader2 size={16} className="animate-spin mr-2" />
                                    Uploading {files.length} files...
                                </>
                            ) : (
                                <>
                                    <Upload size={16} className="mr-2" />
                                    Upload {files.length > 0 ? `${files.length} Files` : ''}
                                </>
                            )}
                        </Button>
                    </div >
                </form >
            </motion.div >
        </div >,
        document.body
    );
};

export default DocumentUploadModal;



================================================
FILE: frontend/src/components/edms/FolderTree.jsx
================================================
/**
 * FolderTree - Hierarchical folder navigation for EDMS
 * Per-project folder structure with create/move capabilities
 */
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    Folder, FolderOpen, ChevronRight, ChevronDown,
    Plus, MoreVertical, Home, Loader2
} from 'lucide-react';
import client from '@/api/client';
import { toast } from 'sonner';

const FolderTree = ({
    projectId,
    selectedFolderId,
    onFolderSelect,
    onCreateFolder,
    canCreateFolder = false
}) => {
    const [folders, setFolders] = useState([]);
    const [loading, setLoading] = useState(true);
    const [expandedFolders, setExpandedFolders] = useState(new Set());
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [newFolderName, setNewFolderName] = useState('');
    const [createInFolder, setCreateInFolder] = useState(null);

    useEffect(() => {
        if (projectId) {
            fetchFolderTree();
        }
    }, [projectId]);

    const fetchFolderTree = async () => {
        setLoading(true);
        try {
            const res = await client.get(`/edms/folders/tree/?project=${projectId}`);
            setFolders(res.data);
        } catch (error) {
            console.error('Failed to fetch folders:', error);
        } finally {
            setLoading(false);
        }
    };

    const toggleExpand = (folderId) => {
        setExpandedFolders(prev => {
            const next = new Set(prev);
            if (next.has(folderId)) {
                next.delete(folderId);
            } else {
                next.add(folderId);
            }
            return next;
        });
    };

    const handleCreateFolder = async () => {
        if (!newFolderName.trim()) return;

        try {
            await client.post('/edms/folders/', {
                name: newFolderName.trim(),
                project: projectId,
                parent: createInFolder
            });
            toast.success('Folder created');
            setShowCreateModal(false);
            setNewFolderName('');
            setCreateInFolder(null);
            fetchFolderTree();
        } catch (error) {
            toast.error('Failed to create folder');
        }
    };

    const openCreateModal = (parentId = null) => {
        setCreateInFolder(parentId);
        setShowCreateModal(true);
    };

    const renderFolder = (folder, depth = 0) => {
        const isExpanded = expandedFolders.has(folder.id);
        const isSelected = selectedFolderId === folder.id;
        const hasChildren = folder.children && folder.children.length > 0;

        return (
            <div key={folder.id}>
                <div
                    className={`flex items-center gap-1 px-2 py-1.5 rounded-lg cursor-pointer group transition-all ${isSelected
                        ? 'bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400'
                        : 'hover:bg-slate-100 dark:hover:bg-neutral-800 text-slate-700 dark:text-neutral-300'
                        }`}
                    style={{ paddingLeft: `${depth * 16 + 8}px` }}
                    onClick={() => onFolderSelect(folder.id)}
                >
                    {/* Expand/Collapse */}
                    <button
                        onClick={(e) => {
                            e.stopPropagation();
                            toggleExpand(folder.id);
                        }}
                        className={`p-0.5 rounded hover:bg-slate-200 dark:hover:bg-neutral-700 ${!hasChildren ? 'invisible' : ''}`}
                    >
                        {isExpanded ? (
                            <ChevronDown size={14} />
                        ) : (
                            <ChevronRight size={14} />
                        )}
                    </button>

                    {/* Folder Icon */}
                    {isExpanded ? (
                        <FolderOpen size={16} className={isSelected ? 'text-primary-600' : 'text-amber-500'} />
                    ) : (
                        <Folder size={16} className={isSelected ? 'text-primary-600' : 'text-amber-500'} />
                    )}

                    {/* Name */}
                    <span className="flex-1 text-sm font-medium truncate">
                        {folder.name}
                    </span>

                    {/* Document Count */}
                    {folder.document_count > 0 && (
                        <span className="text-xs text-slate-400 dark:text-neutral-500 bg-slate-100 dark:bg-neutral-800 px-1.5 py-0.5 rounded">
                            {folder.document_count}
                        </span>
                    )}

                    {/* Create Subfolder */}
                    {canCreateFolder && (
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                openCreateModal(folder.id);
                            }}
                            className="opacity-0 group-hover:opacity-100 p-1 hover:bg-slate-200 dark:hover:bg-neutral-700 rounded transition-opacity"
                        >
                            <Plus size={14} />
                        </button>
                    )}
                </div>

                {/* Children */}
                <AnimatePresence>
                    {isExpanded && hasChildren && (
                        <motion.div
                            initial={{ height: 0, opacity: 0 }}
                            animate={{ height: 'auto', opacity: 1 }}
                            exit={{ height: 0, opacity: 0 }}
                            transition={{ duration: 0.2 }}
                        >
                            {folder.children.map(child => renderFolder(child, depth + 1))}
                        </motion.div>
                    )}
                </AnimatePresence>
            </div>
        );
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center py-8">
                <Loader2 size={20} className="animate-spin text-slate-400" />
            </div>
        );
    }

    return (
        <div className="space-y-1">
            {/* Root (All Documents) */}
            <div
                className={`flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-all ${selectedFolderId === null
                    ? 'bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400'
                    : 'hover:bg-slate-100 dark:hover:bg-neutral-800 text-slate-700 dark:text-neutral-300'
                    }`}
                onClick={() => onFolderSelect(null)}
            >
                <Home size={16} className={selectedFolderId === null ? 'text-primary-600' : 'text-slate-500'} />
                <span className="text-sm font-medium">All Documents</span>
            </div>

            {/* Folder Tree */}
            <div className="pl-2">
                {folders.map(folder => renderFolder(folder))}
            </div>

            {/* Create Root Folder Button */}
            {canCreateFolder && (
                <button
                    onClick={() => openCreateModal(null)}
                    className="flex items-center gap-2 px-3 py-2 text-sm text-slate-500 dark:text-neutral-400 hover:text-slate-700 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg w-full transition-colors"
                >
                    <Plus size={16} />
                    <span>New Folder</span>
                </button>
            )}

            {/* Create Folder Modal */}
            {showCreateModal && (
                <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="bg-white dark:bg-neutral-900 rounded-xl p-4 w-full max-w-sm shadow-xl border dark:border-neutral-700"
                    >
                        <h3 className="text-lg font-semibold text-slate-800 dark:text-white mb-3">
                            Create Folder
                        </h3>
                        <input
                            type="text"
                            value={newFolderName}
                            onChange={(e) => setNewFolderName(e.target.value)}
                            placeholder="Folder name"
                            className="w-full px-3 py-2 border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                            autoFocus
                            onKeyDown={(e) => e.key === 'Enter' && handleCreateFolder()}
                        />
                        <div className="flex justify-end gap-2 mt-4">
                            <button
                                onClick={() => {
                                    setShowCreateModal(false);
                                    setNewFolderName('');
                                }}
                                className="px-4 py-2 text-sm text-slate-600 dark:text-neutral-400 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleCreateFolder}
                                className="px-4 py-2 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700"
                            >
                                Create
                            </button>
                        </div>
                    </motion.div>
                </div>
            )}
        </div>
    );
};

export default FolderTree;





================================================
FILE: frontend/src/components/edms/NotingPanel.jsx
================================================
/**
 * NotingPanel - Displays chronological noting sheet entries
 * 
 * Features:
 * - Color-coded note types
 * - Draft vs submitted distinction
 * - Click to view referenced page
 * - Submit draft notes
 */
import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    MessageSquare, AlertTriangle, CheckCircle, Gavel,
    Clock, Edit, CornerDownRight, User, Calendar,
    Loader2, Send, Trash2
} from 'lucide-react';
import { format, formatDistanceToNow } from 'date-fns';
import client from '@/api/client';
import { toast } from 'sonner';
import Button from '@/components/ui/Button';

const NotingPanel = ({
    notings,
    documentId,
    onRefresh,
    canAddNoting,
    canAddRuling
}) => {
    const [submittingId, setSubmittingId] = useState(null);
    const [expandedId, setExpandedId] = useState(null);

    // Get current user
    const user = JSON.parse(localStorage.getItem('user') || '{}');

    const getNoteTypeConfig = (type) => {
        const configs = {
            REMARK: {
                color: 'border-l-slate-400 bg-slate-50',
                icon: MessageSquare,
                label: 'Remark'
            },
            CLARIFICATION_REQUEST: {
                color: 'border-l-amber-400 bg-amber-50',
                icon: AlertTriangle,
                label: 'Clarification Request'
            },
            CLARIFICATION_RESPONSE: {
                color: 'border-l-blue-400 bg-blue-50',
                icon: CornerDownRight,
                label: 'Clarification Response'
            },
            RECOMMENDATION: {
                color: 'border-l-purple-400 bg-purple-50',
                icon: CheckCircle,
                label: 'Recommendation'
            },
            RULING: {
                color: 'border-l-green-500 bg-green-50',
                icon: Gavel,
                label: 'Ruling/Decision'
            }
        };
        return configs[type] || configs.REMARK;
    };

    const getRulingActionLabel = (action) => {
        const labels = {
            VALIDATE: 'Validated Document',
            APPROVE: 'Approved Document',
            REJECT: 'Rejected Document',
            REQUEST_REVISION: 'Requested Revision'
        };
        return labels[action] || null;
    };

    const handleSubmit = async (noteId) => {
        setSubmittingId(noteId);
        try {
            await client.post(`/edms/noting-sheets/${noteId}/submit/`);
            toast.success('Note submitted successfully');
            onRefresh();
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to submit note');
        } finally {
            setSubmittingId(null);
        }
    };

    const handleDelete = async (noteId) => {
        if (!window.confirm('Are you sure you want to delete this draft?')) return;

        try {
            await client.delete(`/edms/noting-sheets/${noteId}/`);
            toast.success('Draft deleted');
            onRefresh();
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to delete');
        }
    };

    const submittedNotes = notings.filter(n => !n.is_draft);
    const draftNotes = notings.filter(n => n.is_draft && n.author === user?.id);

    if (notings.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center py-16 text-center px-4">
                <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                    <MessageSquare size={32} className="text-slate-400" />
                </div>
                <h3 className="text-lg font-semibold text-slate-700">No Notes Yet</h3>
                <p className="text-sm text-slate-500 mt-1">
                    {canAddNoting
                        ? 'Add the first noting entry to this document.'
                        : 'No noting entries have been added to this document.'}
                </p>
            </div>
        );
    }

    return (
        <div className="p-4 space-y-4">
            {/* My Drafts Section */}
            {draftNotes.length > 0 && (
                <div className="mb-6">
                    <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <Edit size={14} />
                        My Drafts ({draftNotes.length})
                    </h3>
                    <div className="space-y-3">
                        {draftNotes.map((note) => {
                            const config = getNoteTypeConfig(note.note_type);
                            const NoteIcon = config.icon;
                            const isSubmitting = submittingId === note.id;

                            return (
                                <motion.div
                                    key={note.id}
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    className={`border-l-4 ${config.color} rounded-lg p-3 border border-amber-200`}
                                >
                                    <div className="flex items-start justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <span className="bg-amber-100 text-amber-700 text-xs px-2 py-0.5 rounded-full font-medium">
                                                DRAFT
                                            </span>
                                            <span className="text-xs text-slate-500">{config.label}</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button
                                                onClick={() => handleDelete(note.id)}
                                                className="p-1 hover:bg-red-100 rounded text-red-500"
                                                title="Delete Draft"
                                            >
                                                <Trash2 size={14} />
                                            </button>
                                        </div>
                                    </div>

                                    {note.subject && (
                                        <p className="font-medium text-slate-700 text-sm mb-1">{note.subject}</p>
                                    )}
                                    <p className="text-sm text-slate-600 whitespace-pre-wrap">{note.content}</p>

                                    <div className="flex items-center justify-between mt-3 pt-3 border-t border-amber-200">
                                        <span className="text-xs text-slate-400">
                                            Created {formatDistanceToNow(new Date(note.created_at), { addSuffix: true })}
                                        </span>
                                        <Button
                                            size="sm"
                                            onClick={() => handleSubmit(note.id)}
                                            disabled={isSubmitting}
                                        >
                                            {isSubmitting ? (
                                                <Loader2 size={14} className="animate-spin mr-1" />
                                            ) : (
                                                <Send size={14} className="mr-1" />
                                            )}
                                            Submit
                                        </Button>
                                    </div>
                                </motion.div>
                            );
                        })}
                    </div>
                </div>
            )}

            {/* Submitted Notes */}
            <div>
                <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">
                    Official Notes ({submittedNotes.length})
                </h3>
                <div className="space-y-3">
                    {submittedNotes.map((note, index) => {
                        const config = getNoteTypeConfig(note.note_type);
                        const NoteIcon = config.icon;
                        const isExpanded = expandedId === note.id;
                        const rulingLabel = getRulingActionLabel(note.ruling_action);

                        return (
                            <motion.div
                                key={note.id}
                                initial={{ opacity: 0, y: 10 }}
                                animate={{ opacity: 1, y: 0 }}
                                transition={{ delay: index * 0.05 }}
                                className={`border-l-4 ${config.color} rounded-lg p-3 cursor-pointer hover:shadow-sm transition-shadow`}
                                onClick={() => setExpandedId(isExpanded ? null : note.id)}
                            >
                                {/* Note Header */}
                                <div className="flex items-start justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <span className="bg-slate-200 text-slate-700 text-xs px-2 py-0.5 rounded-full font-bold">
                                            #{note.note_number}
                                        </span>
                                        <NoteIcon size={14} className="text-slate-500" />
                                        <span className="text-xs text-slate-500">{config.label}</span>
                                    </div>
                                    {note.references_note && (
                                        <span className="text-xs text-blue-500 flex items-center gap-1">
                                            <CornerDownRight size={12} />
                                            Re: #{note.references_note}
                                        </span>
                                    )}
                                </div>

                                {/* Subject */}
                                {note.subject && (
                                    <p className="font-medium text-slate-700 text-sm mb-1">{note.subject}</p>
                                )}

                                {/* Content - truncated unless expanded */}
                                <p className={`text-sm text-slate-600 whitespace-pre-wrap ${!isExpanded ? 'line-clamp-3' : ''}`}>
                                    {note.content}
                                </p>

                                {/* Ruling Action */}
                                {rulingLabel && (
                                    <div className="mt-2 inline-flex items-center gap-1 bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-medium">
                                        <Gavel size={12} />
                                        {rulingLabel}
                                    </div>
                                )}

                                {/* Author & Timestamp */}
                                <div className="flex items-center justify-between mt-3 pt-3 border-t border-slate-200">
                                    <div className="flex items-center gap-2 text-xs text-slate-500">
                                        <User size={12} />
                                        <span className="font-medium text-slate-700">{note.author_name}</span>
                                        <span>({note.author_role})</span>
                                    </div>
                                    <div className="flex items-center gap-1 text-xs text-slate-400">
                                        <Calendar size={12} />
                                        {note.submitted_at && format(new Date(note.submitted_at), 'dd MMM yyyy, HH:mm')}
                                    </div>
                                </div>
                            </motion.div>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};

export default NotingPanel;



================================================
FILE: frontend/src/components/evm/EVMSCurveChart.jsx
================================================
/**
 * EVMSCurveChart - Earned Value Management S-Curve Visualization
 * 
 * Displays PV (Planned Value), EV (Earned Value), and AC (Actual Cost)
 * time-series data in a professional S-Curve chart format.
 * 
 * Features:
 * - Three-line chart (PV, EV, AC)
 * - Interactive tooltips with full metrics
 * - Performance indicators (CPI, SPI)
 * - Responsive design with dark mode support
 */
import React, { useState, useEffect, useMemo } from 'react';
import { motion } from 'framer-motion';
import {
    LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend,
    ResponsiveContainer, ReferenceLine, Area, ComposedChart
} from 'recharts';
import { TrendingUp, TrendingDown, AlertCircle, RefreshCw, BarChart3 } from 'lucide-react';
import evmService from '../../api/services/evmService';

// Custom tooltip for S-Curve
const CustomTooltip = ({ active, payload, label }) => {
    if (!active || !payload || !payload.length) return null;

    const data = payload[0]?.payload || {};

    return (
        <div className="bg-white dark:bg-neutral-800 p-4 rounded-lg shadow-xl border border-app-subtle min-w-[200px]">
            <p className="font-semibold text-slate-800 dark:text-white mb-2 border-b border-app-subtle pb-2">
                {label}
            </p>
            <div className="space-y-2 text-sm">
                <div className="flex justify-between items-center">
                    <span className="flex items-center gap-2">
                        <span className="w-3 h-3 rounded-full bg-blue-500"></span>
                        <span className="text-slate-600 dark:text-slate-300">Planned (PV)</span>
                    </span>
                    <span className="font-medium text-slate-800 dark:text-white">
                        {evmService.formatIndianCurrency(data.pv || 0)}
                    </span>
                </div>
                <div className="flex justify-between items-center">
                    <span className="flex items-center gap-2">
                        <span className="w-3 h-3 rounded-full bg-green-500"></span>
                        <span className="text-slate-600 dark:text-slate-300">Earned (EV)</span>
                    </span>
                    <span className="font-medium text-slate-800 dark:text-white">
                        {evmService.formatIndianCurrency(data.ev || 0)}
                    </span>
                </div>
                <div className="flex justify-between items-center">
                    <span className="flex items-center gap-2">
                        <span className="w-3 h-3 rounded-full bg-red-500"></span>
                        <span className="text-slate-600 dark:text-slate-300">Actual (AC)</span>
                    </span>
                    <span className="font-medium text-slate-800 dark:text-white">
                        {evmService.formatIndianCurrency(data.ac || 0)}
                    </span>
                </div>
                {data.planned_percent !== undefined && (
                    <div className="pt-2 mt-2 border-t border-app-subtle text-xs text-slate-500 dark:text-slate-400">
                        <div className="flex justify-between">
                            <span>Planned %:</span>
                            <span>{data.planned_percent?.toFixed(1)}%</span>
                        </div>
                        <div className="flex justify-between">
                            <span>Actual %:</span>
                            <span>{data.actual_percent?.toFixed(1)}%</span>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// Performance Badge Component
const PerformanceBadge = ({ label, value, threshold = 1.0 }) => {
    const isGood = value >= threshold;
    const isWarning = value >= 0.9 && value < threshold;

    return (
        <div className="flex flex-col items-center p-3 rounded-lg bg-app-secondary">
            <span className="text-xs text-app-muted mb-1">{label}</span>
            <span className={`text-2xl font-bold ${isGood ? 'text-green-600 dark:text-green-400' :
                isWarning ? 'text-yellow-600 dark:text-yellow-400' :
                    'text-red-600 dark:text-red-400'
                }`}>
                {value?.toFixed(2) || 'â€”'}
            </span>
            <span className={`text-xs mt-1 flex items-center gap-1 ${isGood ? 'text-green-600 dark:text-green-400' :
                isWarning ? 'text-yellow-600 dark:text-yellow-400' :
                    'text-red-600 dark:text-red-400'
                }`}>
                {isGood ? <TrendingUp size={12} /> : <TrendingDown size={12} />}
                {isGood ? 'On Track' : isWarning ? 'Warning' : 'At Risk'}
            </span>
        </div>
    );
};

// Variance Display Component
const VarianceCard = ({ label, value, suffix = '' }) => {
    const status = evmService.getVarianceStatus(value);

    // Format value - use currency formatting only if not a percentage
    const formattedValue = suffix === '%'
        ? `${Math.abs(value || 0).toFixed(1)}`
        : evmService.formatIndianCurrency(Math.abs(value || 0));

    return (
        <div className="text-center p-2 bg-app-secondary rounded-lg">
            <span className="text-xs text-app-muted block mb-1">{label}</span>
            <span className={`text-lg font-semibold ${status.color}`}>
                {status.icon} {formattedValue}{suffix}
            </span>
        </div>
    );
};

const EVMSCurveChart = ({
    projectId,
    height = 320,
    showMetricsPanel = true,
    className = ''
}) => {
    const [data, setData] = useState([]);
    const [metrics, setMetrics] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Fetch S-Curve data and metrics
    const fetchData = async () => {
        if (!projectId) return;

        setLoading(true);
        setError(null);

        try {
            const [sCurveRes, metricsRes] = await Promise.all([
                evmService.getSCurveData(projectId),
                evmService.getMetrics(projectId)
            ]);

            setData(sCurveRes.data?.data || []);
            setMetrics(metricsRes.data || null);
        } catch (err) {
            console.error('Failed to fetch EVM data:', err);
            setError('Failed to load EVM data');
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, [projectId]);

    // Format Y-axis values
    const formatYAxis = (value) => {
        if (value >= 10000000) return `${(value / 10000000).toFixed(1)}Cr`;
        if (value >= 100000) return `${(value / 100000).toFixed(0)}L`;
        if (value >= 1000) return `${(value / 1000).toFixed(0)}K`;
        return value;
    };

    // Calculate Y-axis domain
    const yDomain = useMemo(() => {
        if (!data.length) return [0, 100];
        const maxValue = Math.max(
            ...data.map(d => Math.max(d.pv || 0, d.ev || 0, d.ac || 0, d.bac || 0))
        );
        return [0, Math.ceil(maxValue * 1.1)];
    }, [data]);

    if (loading) {
        return (
            <div className={`flex items-center justify-center bg-app-card rounded-lg ${className}`} style={{ height }}>
                <div className="flex items-center gap-2 text-app-muted">
                    <RefreshCw className="animate-spin" size={20} />
                    <span>Loading EVM data...</span>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className={`flex items-center justify-center bg-app-card rounded-lg ${className}`} style={{ height }}>
                <div className="flex items-center gap-2 text-red-500">
                    <AlertCircle size={20} />
                    <span>{error}</span>
                </div>
            </div>
        );
    }

    if (!data.length) {
        return (
            <div className={`flex flex-col items-center justify-center bg-app-card rounded-lg ${className}`} style={{ height }}>
                <BarChart3 size={40} className="text-slate-400 mb-2" />
                <span className="text-app-muted">No S-Curve data available</span>
                <span className="text-xs text-slate-400 mt-1">Create EVM snapshots to visualize progress</span>
            </div>
        );
    }

    return (
        <motion.div
            className={className}
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.3 }}
        >
            {/* Metrics Summary Panel - Enhanced with more details */}
            {showMetricsPanel && metrics && (
                <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-4">
                    <PerformanceBadge label="CPI" value={metrics.cpi} />
                    <PerformanceBadge label="SPI" value={metrics.spi} />
                    <VarianceCard label="Cost Variance" value={metrics.cv} />
                    <VarianceCard label="CV %" value={metrics.cv_percent} suffix="%" />
                    <VarianceCard label="Schedule Variance" value={metrics.sv} />
                    <VarianceCard label="SV %" value={metrics.sv_percent} suffix="%" />
                </div>
            )}

            {/* S-Curve Chart */}
            <div className="bg-app-card rounded-lg p-2">
                <ResponsiveContainer width="100%" height={height}>
                    <ComposedChart data={data} margin={{ top: 10, right: 30, left: 10, bottom: 10 }}>
                        <defs>
                            <linearGradient id="pvGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.2} />
                                <stop offset="95%" stopColor="#3b82f6" stopOpacity={0} />
                            </linearGradient>
                        </defs>

                        <CartesianGrid
                            strokeDasharray="3 3"
                            stroke="#e2e8f0"
                            className="dark:opacity-20"
                        />

                        <XAxis
                            dataKey="label"
                            tick={{ fontSize: 11, fill: '#64748b' }}
                            tickLine={false}
                            axisLine={{ stroke: '#e2e8f0' }}
                        />

                        <YAxis
                            tickFormatter={formatYAxis}
                            tick={{ fontSize: 11, fill: '#64748b' }}
                            tickLine={false}
                            axisLine={{ stroke: '#e2e8f0' }}
                            domain={yDomain}
                        />

                        <Tooltip content={<CustomTooltip />} />

                        <Legend
                            verticalAlign="top"
                            height={36}
                            iconType="line"
                            wrapperStyle={{ fontSize: '12px' }}
                        />

                        {/* BAC Reference Line */}
                        {metrics?.bac && (
                            <ReferenceLine
                                y={metrics.bac}
                                stroke="#94a3b8"
                                strokeDasharray="5 5"
                                label={{
                                    value: `BAC: ${evmService.formatIndianCurrency(metrics.bac)}`,
                                    position: 'right',
                                    fill: '#64748b',
                                    fontSize: 10
                                }}
                            />
                        )}

                        {/* Area under PV for visual effect */}
                        <Area
                            type="monotone"
                            dataKey="pv"
                            fill="url(#pvGradient)"
                            stroke="none"
                        />

                        {/* PV Line - Blue */}
                        <Line
                            type="monotone"
                            dataKey="pv"
                            name="Planned Value (PV)"
                            stroke="#3b82f6"
                            strokeWidth={2.5}
                            dot={{ r: 3, fill: '#3b82f6' }}
                            activeDot={{ r: 6, stroke: '#fff', strokeWidth: 2 }}
                        />

                        {/* EV Line - Green */}
                        <Line
                            type="monotone"
                            dataKey="ev"
                            name="Earned Value (EV)"
                            stroke="#10b981"
                            strokeWidth={2.5}
                            dot={{ r: 3, fill: '#10b981' }}
                            activeDot={{ r: 6, stroke: '#fff', strokeWidth: 2 }}
                        />

                        {/* AC Line - Red */}
                        <Line
                            type="monotone"
                            dataKey="ac"
                            name="Actual Cost (AC)"
                            stroke="#ef4444"
                            strokeWidth={2.5}
                            dot={{ r: 3, fill: '#ef4444' }}
                            activeDot={{ r: 6, stroke: '#fff', strokeWidth: 2 }}
                        />
                    </ComposedChart>
                </ResponsiveContainer>
            </div>

            {/* EAC/VAC Summary */}
            {metrics && (
                <div className="mt-4 pt-4 border-t border-app-subtle flex justify-around text-center">
                    <div>
                        <span className="text-xs text-app-muted block">Est. At Completion (EAC)</span>
                        <span className="text-lg font-semibold text-slate-800 dark:text-white">
                            {evmService.formatIndianCurrency(metrics.eac || 0)}
                        </span>
                    </div>
                    <div>
                        <span className="text-xs text-app-muted block">Est. To Complete (ETC)</span>
                        <span className="text-lg font-semibold text-slate-800 dark:text-white">
                            {evmService.formatIndianCurrency(metrics.etc || 0)}
                        </span>
                    </div>
                    <div>
                        <span className="text-xs text-app-muted block">Variance At Completion</span>
                        <span className={`text-lg font-semibold ${metrics.vac >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'
                            }`}>
                            {metrics.vac >= 0 ? '+' : ''}{evmService.formatIndianCurrency(metrics.vac || 0)}
                        </span>
                    </div>
                </div>
            )}
        </motion.div>
    );
};

export default EVMSCurveChart;



================================================
FILE: frontend/src/components/gis/LeafletMap.jsx
================================================
import { useEffect, useRef, useState } from 'react';
import Toggle from '@/components/ui/Toggle';
import { MapContainer, TileLayer, Marker, Popup, Polygon, Polyline, LayersControl, useMap } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

// Fix for default marker icons in Leaflet with Vite
import icon from 'leaflet/dist/images/marker-icon.png';
import iconShadow from 'leaflet/dist/images/marker-shadow.png';

const DefaultIcon = L.icon({
  iconUrl: icon,
  shadowUrl: iconShadow,
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41],
});

L.Marker.prototype.options.icon = DefaultIcon;

const MapController = ({ center, zoom }) => {
  const map = useMap();
  useEffect(() => {
    map.setView(center, zoom);
  }, [map, center, zoom]);
  return null;
};

export const LeafletMap = ({ projects, gisFeatures }) => {
  const [activeLayers, setActiveLayers] = useState({
    satellite: false,
    street: true,
    parcels: true,
    utilities: true,
  });

  // Center on Zaheerabad
  const center = [17.6816, 77.6077];
  const zoom = 13;

  return (
    <div className="relative">
      <MapContainer center={center} zoom={zoom} className="h-[600px] w-full rounded-lg z-0">
        <LayersControl position="topright">
          {activeLayers.street && (
            <LayersControl.BaseLayer checked name="Street Map">
              <TileLayer
                attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
              />
            </LayersControl.BaseLayer>
          )}
          {activeLayers.satellite && (
            <LayersControl.BaseLayer name="Satellite View">
              <TileLayer
                attribution='&copy; <a href="https://www.esri.com/">Esri</a>'
                url="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
              />
            </LayersControl.BaseLayer>
          )}
        </LayersControl>

        {/* Project Markers */}
        {projects.map((project) => (
          <Marker key={project.id} position={[project.location.lat, project.location.lng]}>
            <Popup>
              <div className="p-2">
                <h3 className="font-semibold text-sm mb-1">{project.name}</h3>
                <p className="text-xs text-gray-600 mb-2">{project.description}</p>
                <div className="text-xs space-y-1">
                  <p><strong>Status:</strong> {project.status}</p>
                  <p><strong>Progress:</strong> {project.progress}%</p>
                  <p><strong>Manager:</strong> {project.manager}</p>
                </div>
              </div>
            </Popup>
          </Marker>
        ))}

        {/* GIS Features */}
        {gisFeatures.map((feature) => {
          if (feature.geometry.type === 'Point') {
            const [lng, lat] = feature.geometry.coordinates[0];
            return (
              <Marker key={feature.id} position={[lat, lng]}>
                <Popup>
                  <div className="p-2">
                    <h3 className="font-semibold text-sm mb-1">{feature.properties.name}</h3>
                    <p className="text-xs text-gray-600">{feature.properties.description}</p>
                    <p className="text-xs mt-1"><strong>Type:</strong> {feature.type}</p>
                  </div>
                </Popup>
              </Marker>
            );
          } else if (feature.geometry.type === 'Polygon' && activeLayers.parcels) {
            const coords = feature.geometry.coordinates[0].map(([lng, lat]) => [lat, lng]);
            return (
              <Polygon
                key={feature.id}
                positions={coords}
                pathOptions={{ color: '#0284c7', fillOpacity: 0.35 }}
              >
                <Popup>
                  <div className="p-2">
                    <h3 className="font-semibold text-sm mb-1">{feature.properties.name}</h3>
                    <p className="text-xs text-gray-600">{feature.properties.description}</p>
                  </div>
                </Popup>
              </Polygon>
            );
          } else if (feature.geometry.type === 'LineString' && activeLayers.utilities) {
            const coords = feature.geometry.coordinates.map(([lng, lat]) => [lat, lng]);
            return (
              <Polyline
                key={feature.id}
                positions={coords}
                pathOptions={{ color: '#f97316', weight: 3 }}
              >
                <Popup>
                  <div className="p-2">
                    <h3 className="font-semibold text-sm mb-1">{feature.properties.name}</h3>
                    <p className="text-xs text-gray-600">{feature.properties.description}</p>
                  </div>
                </Popup>
              </Polyline>
            );
          }
          return null;
        })}

        <MapController center={center} zoom={zoom} />
      </MapContainer>

      {/* Layer Control Widget */}
      <div className="absolute top-4 left-4 z-[1000] bg-white/95 backdrop-blur-xl rounded-xl shadow-glass border border-slate-200/50 p-4">
        <h4 className="font-semibold text-sm mb-3">Layer Controls</h4>
        <div className="space-y-2">
          <div className="flex items-center justify-between gap-4">
            <span className="text-sm">Satellite View</span>
            <Toggle
              checked={activeLayers.satellite}
              onChange={(val) => setActiveLayers({ ...activeLayers, satellite: val })}
              size="sm"
            />
          </div>
          <div className="flex items-center justify-between gap-4">
            <span className="text-sm">Street Map</span>
            <Toggle
              checked={activeLayers.street}
              onChange={(val) => setActiveLayers({ ...activeLayers, street: val })}
              size="sm"
            />
          </div>
          <div className="flex items-center justify-between gap-4">
            <span className="text-sm">Parcel Boundaries</span>
            <Toggle
              checked={activeLayers.parcels}
              onChange={(val) => setActiveLayers({ ...activeLayers, parcels: val })}
              size="sm"
            />
          </div>
          <div className="flex items-center justify-between gap-4">
            <span className="text-sm">Utility Lines</span>
            <Toggle
              checked={activeLayers.utilities}
              onChange={(val) => setActiveLayers({ ...activeLayers, utilities: val })}
              size="sm"
            />
          </div>
        </div>
      </div>
    </div>
  );
};









================================================
FILE: frontend/src/components/layout/AppLayout.jsx
================================================
import { Suspense, useState, useEffect, useCallback } from 'react';
import { Outlet, useLocation } from 'react-router-dom';
import { motion } from 'framer-motion';
import { useSidebar } from '@/contexts/SidebarContext';
import Sidebar from './Sidebar';
import Header from './Header';
import { Breadcrumbs } from '@/components/ui/Breadcrumbs';
import { PageLoading } from '@/components/ui/Loading';

/**
 * AppLayout - Main application layout component
 * 
 * Handles responsive layout behavior:
 * - Desktop (â‰¥1024px): Content has left padding for sidebar
 * - Mobile (<1024px): Content fills full width, sidebar overlays
 * 
 * Uses React state to track viewport size for smooth animations
 */
const AppLayout = () => {
  const location = useLocation();
  const { isCollapsed } = useSidebar();



  // Track if we're on desktop viewport for responsive layout
  const [isDesktop, setIsDesktop] = useState(
    typeof window !== 'undefined' ? window.innerWidth >= 1024 : true
  );

  // Memoized resize handler for performance
  const handleResize = useCallback(() => {
    setIsDesktop(window.innerWidth >= 1024);
  }, []);

  // Listen for viewport changes
  useEffect(() => {
    // Set initial value
    handleResize();

    // Add resize listener with debounce for performance
    let timeoutId;
    const debouncedResize = () => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(handleResize, 100);
    };

    window.addEventListener('resize', debouncedResize);
    return () => {
      window.removeEventListener('resize', debouncedResize);
      clearTimeout(timeoutId);
    };
  }, [handleResize]);

  // Calculate content padding based on viewport and sidebar state
  const getContentPadding = () => {
    if (!isDesktop) {
      return '0px'; // Mobile: no sidebar offset
    }
    // Desktop: offset based on sidebar state
    // Collapsed: 96px (sidebar) + 8px (gap) = 104px
    // Expanded: 288px (sidebar) + 16px (gap) = 304px
    return isCollapsed ? '104px' : '304px';
  };

  return (
    <div className="min-h-screen bg-app-secondary">
      <Sidebar />
      <motion.div
        animate={{
          paddingLeft: getContentPadding(),
        }}
        transition={{
          type: 'spring',
          stiffness: 300,
          damping: 30,
          mass: 0.5,
        }}
        className="relative min-h-screen"
      >
        <Header isDesktop={isDesktop} />
        <main className="px-4 sm:px-6 pb-4 sm:pb-6" style={{ paddingTop: '88px' }}>
          <Breadcrumbs />
          <motion.div
            key={location.pathname}
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.1 }}
          >
            <Suspense fallback={
              <div className="flex items-center justify-center py-12">
                <PageLoading text="Loading..." />
              </div>
            }>
              <Outlet />
            </Suspense>
          </motion.div>
        </main>
      </motion.div>
    </div>
  );
};

export default AppLayout;



================================================
FILE: frontend/src/components/layout/Header.jsx
================================================
import { useAuth } from '@/contexts/AuthContext';
import { useLanguage } from '@/contexts/LanguageContext';
import { useSidebar } from '@/contexts/SidebarContext';
import { Settings } from 'lucide-react';
import { useState, useEffect, useRef } from 'react';
import { motion } from 'framer-motion';
import Button from '@/components/ui/Button';
import GoogleTranslateWidget from '@/components/ui/GoogleTranslateWidget';
import LanguageDropdown from '@/components/ui/LanguageDropdown';
import NotificationDropdown from '@/components/communications/NotificationDropdown';
import ThemeToggle from '@/components/ui/ThemeToggle';
import SettingsModal from '@/components/settings/SettingsModal';
import GlobalSearchBar from '@/components/search/GlobalSearchBar';

/**
 * Header - Top navigation bar component
 * 
 * Props:
 * - isDesktop: boolean - Whether viewport is desktop size (passed from AppLayout)
 * 
 * Responsive behavior:
 * - Desktop: Positioned after sidebar with dynamic left offset
 * - Mobile: Full width with left margin for hamburger menu
 * - Hidden when mobile sidebar is open
 * 
 * Dark Mode: Uses semantic design tokens for automatic theme switching
 */
const Header = ({ isDesktop = true }) => {
  const { user, logout } = useAuth();
  const { isCollapsed, isMobileMenuOpen } = useSidebar();
  const [showNotifications, setShowNotifications] = useState(false);
  const [showProfile, setShowProfile] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const notificationsRef = useRef(null);
  const profileRef = useRef(null);

  // Close dropdowns when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (notificationsRef.current && !notificationsRef.current.contains(event.target)) {
        setShowNotifications(false);
      }
      if (profileRef.current && !profileRef.current.contains(event.target)) {
        setShowProfile(false);
      }
    };

    if (showNotifications || showProfile) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showNotifications, showProfile]);

  const handleLogout = () => {
    logout();
    window.location.href = '/login';
  };

  /**
   * Calculate header left position based on viewport and sidebar state
   * - Mobile: 56px (after hamburger menu button)
   * - Desktop collapsed: 112px (96px sidebar + 16px gap)
   * - Desktop expanded: 312px (288px sidebar + 24px gap)
   */
  const getHeaderLeftPosition = () => {
    if (!isDesktop) {
      return '56px'; // Mobile: after hamburger menu
    }
    return isCollapsed ? '112px' : '312px';
  };

  // Hide header when mobile sidebar is open
  if (isMobileMenuOpen && !isDesktop) {
    return null;
  }

  return (
    <motion.header
      animate={{
        left: getHeaderLeftPosition(),
      }}
      transition={{
        type: 'spring',
        stiffness: 300,
        damping: 30,
        mass: 0.5,
      }}
      className="absolute top-4 right-4 z-40 h-14 bg-app-card/90 backdrop-blur-xl border border-app-subtle rounded-2xl shadow-sm flex items-center justify-between px-3 sm:px-4"
    >
      {/* Global Search Bar - Full bar on desktop, icon on mobile */}
      <GlobalSearchBar isDesktop={isDesktop} />

      <div className="flex items-center gap-2 sm:gap-3">
        {/* Google Translate Widget (hidden) */}
        <div className="hidden">
          <GoogleTranslateWidget />
        </div>

        {/* Language Dropdown - Beautiful redesigned */}
        <LanguageDropdown />

        {/* Theme Toggle - NEW */}
        <ThemeToggle />

        {/* Settings Icon */}
        <button
          onClick={() => setShowSettings(true)}
          className="p-2 rounded-xl hover:bg-app-layer-2 transition-all duration-200 hover:scale-105 group"
          title="Settings"
        >
          <Settings size={20} className="text-app-muted group-hover:text-primary-600 transition-all duration-300" />
        </button>

        {/* Notifications - Using Communications NotificationDropdown */}
        <NotificationDropdown />

        {/* User Profile */}
        <div className="relative" ref={profileRef}>
          <button
            onClick={() => {
              setShowProfile(!showProfile);
              setShowNotifications(false);
            }}
            className="flex items-center gap-2 px-2 sm:px-3 py-2 rounded-xl hover:bg-app-layer-2 transition-all duration-200 hover:scale-105"
          >
            <div className="w-8 h-8 rounded-full bg-gradient-to-r from-primary-600 to-primary-700 flex items-center justify-center text-white text-sm font-semibold shadow-lg ring-2 ring-primary-100 dark:ring-primary-500/30">
              {user?.name.charAt(0).toUpperCase()}
            </div>
            <span className="hidden md:block text-sm font-semibold text-app-text">
              {user?.name}
            </span>
          </button>

          {showProfile && (
            <div className="absolute right-0 mt-2 w-56 bg-app-card backdrop-blur-xl rounded-2xl shadow-xl border border-app-subtle z-[60]">
              <div className="p-4 border-b border-app-subtle">
                <p className="font-semibold text-sm text-app-heading">{user?.name}</p>
                <p className="text-xs text-app-muted">{user?.email}</p>
                <p className="text-xs text-app-muted mt-1">{user?.role}</p>
              </div>
              <div className="p-2">
                <Button
                  variant="ghost"
                  className="w-full justify-start"
                  onClick={handleLogout}
                >
                  Logout
                </Button>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Settings Modal */}
      <SettingsModal
        isOpen={showSettings}
        onClose={() => setShowSettings(false)}
      />
    </motion.header>
  );
};

export default Header;



================================================
FILE: frontend/src/components/layout/Sidebar.jsx
================================================
import { Link, useLocation } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { useAuth } from '@/contexts/AuthContext';
import { useLanguage } from '@/contexts/LanguageContext';
import { useSidebar } from '@/contexts/SidebarContext';
import {
  LayoutDashboard,
  FileText,
  Calendar,
  IndianRupee,
  AlertTriangle,
  Map,
  Box,
  Menu,
  X,
  ChevronLeft,
  ChevronRight,
  FolderOpen,
  Workflow,
  Shield,
  MessageSquare,
  Clock,
  Users,
  Building2,
  PieChart,
  Calculator,
} from 'lucide-react';
import { useState, useEffect, useCallback } from 'react';
import { cn } from '@/lib/utils';

/**
 * Sidebar Component
 * 
 * Features:
 * - Collapsible on desktop (icons only vs full labels)
 * - Slide-out drawer on mobile with overlay
 * - Auto-close when navigating on mobile
 * - Scrollbar only visible when sidebar is expanded
 * - Smooth spring animations
 * - Dark Mode: Uses semantic design tokens for automatic theme switching
 */

// Sidebar width variants for liquid motion
const sidebarVariants = {
  expanded: { width: '18rem' }, // 288px
  collapsed: { width: '6rem' }, // 96px
};

// Text label variants for smooth fade/slide
const textVariants = {
  expanded: {
    opacity: 1,
    x: 0,
    display: 'block',
  },
  collapsed: {
    opacity: 0,
    x: -10,
    transitionEnd: { display: 'none' },
  },
};

// Header text variants
const headerTextVariants = {
  expanded: {
    opacity: 1,
    x: 0,
  },
  collapsed: {
    opacity: 0,
    x: -10,
  },
};

// Transition timing - optimized for performance
const sidebarTransition = {
  type: 'spring',
  stiffness: 300,
  damping: 30,
  mass: 0.5,
};

const textTransition = {
  duration: 0.15,
};

const Sidebar = () => {
  const { hasPermission } = useAuth();
  const { t } = useLanguage();
  const location = useLocation();
  const { isCollapsed, setIsCollapsed, isMobileMenuOpen, setIsMobileMenuOpen, isMobile } = useSidebar();

  // Close mobile menu when route changes
  useEffect(() => {
    setIsMobileMenuOpen(false);
  }, [location.pathname, setIsMobileMenuOpen]);

  // Handle link click - close mobile menu
  const handleLinkClick = () => {
    if (isMobile) {
      setIsMobileMenuOpen(false);
    }
  };

  // Sidebar should appear expanded on mobile (show labels, not just icons)
  const shouldShowExpanded = isMobile ? true : !isCollapsed;
  const animationState = shouldShowExpanded ? 'expanded' : 'collapsed';

  const menuItems = [
    {
      id: 'dashboard',
      label: t('common.dashboard'),
      icon: LayoutDashboard,
      path: '/dashboard',
      permission: 'dashboard:view',
    },
    {
      id: 'projects',
      label: t('common.projects'),
      icon: FolderOpen,
      path: '/projects',
      permission: 'dashboard:view',
    },
    {
      id: 'edms',
      label: 'EDMS',
      icon: FileText,
      path: '/edms',
      permission: 'edms:view',
      noTranslate: true,
    },
    {
      id: 'communications',
      label: 'Communications',
      icon: MessageSquare,
      path: '/communications',
      permission: 'dashboard:view',
    },
    {
      id: 'approvals',
      label: 'Approvals',
      icon: Clock,
      path: '/approvals',
      permission: 'dashboard:view',
    },
    {
      id: 'etp-master',
      label: 'ETP Charges',
      icon: Calculator,
      path: '/etp-master',
      permission: 'dashboard:view',
      noTranslate: true,
    },
    {
      id: 'scheduling',
      label: t('common.schedule'),
      icon: Calendar,
      path: '/scheduling',
      permission: 'scheduling:view',
    },
    {
      id: 'user-management',
      label: 'User Management',
      icon: Users,
      path: '/users',
      permission: 'users:manage',
    },
    {
      id: 'cost',
      label: t('common.cost'),
      icon: IndianRupee,
      path: '/cost',
      permission: 'cost:view',
    },
    {
      id: 'risk',
      label: t('common.risk'),
      icon: AlertTriangle,
      path: '/risk',
      permission: 'risk:view',
    },
    {
      id: 'gis',
      label: 'GIS',
      icon: Map,
      path: '/gis',
      permission: 'gis:view',
      noTranslate: true,
    },
    {
      id: 'bim',
      label: 'BIM',
      icon: Box,
      path: '/bim',
      permission: 'bim:view',
      noTranslate: true,
    },
    {
      id: 'e-procurement',
      label: 'e-Procurement',
      icon: Building2,
      path: '/e-procurement',
      permission: 'dashboard:view',
    },
    {
      id: 'cost-boq',
      label: 'BOQ Management',
      icon: FileText,
      path: '/cost/boq',
      permission: 'cost:view',
      noTranslate: true,
    },
    {
      id: 'cost-funds',
      label: 'Fund Management',
      icon: IndianRupee,
      path: '/cost/funds',
      permission: 'cost:view',
    },
    {
      id: 'cost-budgeting',
      label: 'Budgeting',
      icon: PieChart,
      path: '/cost/budgeting',
      permission: 'cost:view',
    },
    {
      id: 'ra-billing',
      label: 'RA Billing',
      icon: FileText,
      path: '/cost/billing',
      permission: 'dashboard:view',
      noTranslate: true,
    },
    {
      id: 'workflow',
      label: 'Workflow Config',
      icon: Workflow,
      path: '/workflow',
      permission: 'users:manage',
    },
    {
      id: 'audit-logs',
      label: 'Audit System',
      icon: Shield,
      path: '/admin/audit-logs',
      permission: 'users:manage',
    },
    {
      id: 'master-data',
      label: 'Master Data',
      icon: Building2,
      path: '/admin/master-data',
      permission: 'users:manage',
    },
  ];

  const visibleItems = menuItems.filter((item) => hasPermission(item.permission));

  return (
    <>
      {/* Mobile menu hamburger button - only visible when sidebar is CLOSED */}
      {!isMobileMenuOpen && (
        <motion.button
          className="lg:hidden fixed top-4 left-4 z-50 p-2 rounded-xl bg-app-card/90 backdrop-blur-md shadow-lg border border-app-border min-w-[44px] min-h-[44px] flex items-center justify-center"
          onClick={() => setIsMobileMenuOpen(true)}
          whileTap={{ scale: 0.95 }}
          whileHover={{ scale: 1.05 }}
          aria-label="Open menu"
        >
          <Menu size={24} className="text-app-text" />
        </motion.button>
      )}

      {/* Sidebar */}
      <motion.aside
        layout
        initial={false}
        animate={animationState}
        variants={sidebarVariants}
        transition={sidebarTransition}
        className={cn(
          // Base styles
          'fixed top-4 left-4 z-40 h-[calc(100vh-2rem)]',
          'bg-app-card/90 backdrop-blur-xl border border-app-subtle',
          'rounded-2xl shadow-lg overflow-hidden',
          // Mobile: slide in/out with smooth transition
          'transition-transform duration-300 ease-out',
          isMobileMenuOpen ? 'translate-x-0' : '-translate-x-[120%]',
          // Desktop: always visible
          'lg:translate-x-0',
          // Print: hidden
          'print:hidden'
        )}
      >
        <div className="h-full flex flex-col overflow-hidden">
          {/* Header with logo and collapse button */}
          <div
            className={cn(
              'border-b border-app-subtle flex items-center justify-between overflow-hidden flex-shrink-0',
              shouldShowExpanded ? 'p-6' : 'p-3'
            )}
          >
            <div
              className={cn(
                'flex-1 overflow-hidden',
                !shouldShowExpanded && 'flex justify-center'
              )}
            >
              {shouldShowExpanded ? (
                <motion.div
                  variants={headerTextVariants}
                  initial="collapsed"
                  animate="expanded"
                  transition={textTransition}
                  className="flex items-center gap-3 whitespace-nowrap min-w-0"
                >
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-md flex-shrink-0">
                    <Building2 className="w-6 h-6 text-white" />
                  </div>
                  <div className="min-w-0">
                    <h2 className="text-lg font-heading font-bold text-blue-600 truncate notranslate">
                      PMIS
                    </h2>
                    <p className="text-xs text-app-muted truncate">
                      Zaheerabad Industrial Area
                    </p>
                  </div>
                </motion.div>
              ) : (
                <motion.div
                  initial={{ opacity: 0, scale: 0.8 }}
                  animate={{ opacity: 1, scale: 1 }}
                  transition={textTransition}
                  className="w-full flex items-center justify-center"
                >
                  <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-md">
                    <Building2 className="w-5 h-5 text-white" />
                  </div>
                </motion.div>
              )}
            </div>

            {/* Mobile close button - inside sidebar header, top right */}
            {isMobile && isMobileMenuOpen && (
              <motion.button
                onClick={() => setIsMobileMenuOpen(false)}
                className="lg:hidden p-2 hover:bg-app-layer-2 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center"
                whileTap={{ scale: 0.9 }}
                aria-label="Close menu"
              >
                <X size={24} className="text-app-muted" />
              </motion.button>
            )}

            {/* Collapse/Expand button - desktop only */}
            <motion.button
              layout
              onClick={() => setIsCollapsed(!isCollapsed)}
              className={cn(
                'hidden lg:flex rounded-lg hover:bg-app-layer-2 transition-colors flex-shrink-0',
                isCollapsed ? 'p-1.5' : 'p-2'
              )}
              whileHover={{ scale: 1.1 }}
              whileTap={{ scale: 0.9 }}
              aria-label={isCollapsed ? t('sidebar.expandSidebar') : t('sidebar.collapseSidebar')}
            >
              {isCollapsed ? (
                <ChevronRight size={18} className="text-app-muted" />
              ) : (
                <ChevronLeft size={20} className="text-app-muted" />
              )}
            </motion.button>
          </div>

          {/* Navigation - Scrollbar only visible when expanded */}
          <nav
            className={cn(
              'flex-1 p-4 space-y-2',
              // Only show scrollbar when sidebar is expanded
              shouldShowExpanded
                ? 'overflow-y-auto overflow-x-hidden'
                : 'overflow-hidden'
            )}
          >
            {visibleItems.map((item) => {
              const Icon = item.icon;
              const isActive = location.pathname === item.path;

              return (
                <motion.div
                  key={item.id}
                  whileHover={{ scale: 1.01, x: 2 }}
                  whileTap={{ scale: 0.99 }}
                  transition={{ duration: 0.2, ease: 'easeOut' }}
                >
                  <Link
                    to={item.path}
                    onClick={handleLinkClick}
                    className={cn(
                      'flex items-center gap-3 rounded-xl transition-all duration-200 overflow-hidden',
                      'focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-neutral-900',
                      isActive
                        ? 'bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-400 font-semibold shadow-sm pl-3 py-3 pr-4'
                        : 'text-app-heading hover:bg-app-hover hover:text-primary-600 dark:hover:text-primary-400 px-4 py-3'
                    )}
                    title={!shouldShowExpanded ? item.label : undefined}
                    aria-label={item.label}
                  >
                    {/* Active indicator pill */}
                    {isActive && (
                      <motion.div
                        className="h-6 w-1 bg-gradient-to-b from-blue-600 to-blue-700 rounded-full shadow-md flex-shrink-0"
                        layoutId="activeIndicator"
                        initial={{ scaleY: 0 }}
                        animate={{ scaleY: 1 }}
                        transition={{ duration: 0.2, ease: 'easeOut' }}
                      />
                    )}
                    <Icon size={20} className="flex-shrink-0" />
                    <AnimatePresence mode="wait">
                      {shouldShowExpanded && (
                        <motion.span
                          key="text"
                          variants={textVariants}
                          initial="collapsed"
                          animate="expanded"
                          exit="collapsed"
                          transition={textTransition}
                          className={`whitespace-nowrap ${item.noTranslate ? 'notranslate' : ''}`}
                        >
                          {item.label}
                        </motion.span>
                      )}
                    </AnimatePresence>
                  </Link>
                </motion.div>
              );
            })}
          </nav>
        </div>
      </motion.aside>

      {/* Backdrop overlay for mobile */}
      <AnimatePresence>
        {isMobileMenuOpen && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="lg:hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-30"
            onClick={() => setisMobileMenuOpen(false)}
            aria-hidden="true"
          />
        )}
      </AnimatePresence>
    </>
  );
};

export default Sidebar;



================================================
FILE: frontend/src/components/masters/ChainedHierarchySelector.jsx
================================================
import { useState, useEffect, useCallback } from 'react';
import { ChevronDown, Loader2, Building2 } from 'lucide-react';
import mastersService from '@/api/services/mastersService';

/**
 * Chained Hierarchy Selector Component
 * Provides dependent dropdowns: Zone â†’ Circle â†’ Division â†’ SubDivision
 * 
 * @param {object} value - Current selection { zone, circle, division, subDivision }
 * @param {function} onChange - Called with updated selection object
 * @param {boolean} showSubDivision - Whether to show the 4th level
 * @param {boolean} disabled - Disable all selects
 */
const ChainedHierarchySelector = ({
    value = {},
    onChange,
    showSubDivision = true,
    disabled = false,
    className = ''
}) => {
    // Master data lists
    const [zones, setZones] = useState([]);
    const [circles, setCircles] = useState([]);
    const [divisions, setDivisions] = useState([]);
    const [subDivisions, setSubDivisions] = useState([]);

    // Loading states
    const [loading, setLoading] = useState({
        zones: true,
        circles: false,
        divisions: false,
        subDivisions: false,
    });

    // Fetch zones on mount
    useEffect(() => {
        fetchZones();
    }, []);

    const fetchZones = async () => {
        setLoading(prev => ({ ...prev, zones: true }));
        try {
            const res = await mastersService.getZones();
            // Handle both paginated ({results: [...]}) and non-paginated ([...]) responses
            const zonesData = res.data?.results || res.data || [];
            setZones(zonesData.filter(z => z.status === 'Active'));
        } catch (error) {
            console.error('Failed to fetch zones:', error);
        } finally {
            setLoading(prev => ({ ...prev, zones: false }));
        }
    };

    // Fetch circles when zone changes
    const fetchCircles = useCallback(async (zoneId) => {
        if (!zoneId) {
            setCircles([]);
            return;
        }
        setLoading(prev => ({ ...prev, circles: true }));
        try {
            const res = await mastersService.getZoneCircles(zoneId);
            // Handle both paginated and non-paginated responses
            const circlesData = res.data?.results || res.data || [];
            setCircles(circlesData);
        } catch (error) {
            console.error('Failed to fetch circles:', error);
            // Fallback: filter from all circles
            try {
                const allCircles = await mastersService.getCircles({ zone: zoneId });
                const circlesData = allCircles.data?.results || allCircles.data || [];
                setCircles(circlesData.filter(c => c.status === 'Active'));
            } catch {
                setCircles([]);
            }
        } finally {
            setLoading(prev => ({ ...prev, circles: false }));
        }
    }, []);

    // Fetch divisions when circle changes
    const fetchDivisions = useCallback(async (circleId) => {
        if (!circleId) {
            setDivisions([]);
            return;
        }
        setLoading(prev => ({ ...prev, divisions: true }));
        try {
            const res = await mastersService.getCircleDivisions(circleId);
            const divisionsData = res.data?.results || res.data || [];
            setDivisions(divisionsData);
        } catch (error) {
            console.error('Failed to fetch divisions:', error);
            try {
                const allDivisions = await mastersService.getDivisions({ circle: circleId });
                const divisionsData = allDivisions.data?.results || allDivisions.data || [];
                setDivisions(divisionsData.filter(d => d.status === 'Active'));
            } catch {
                setDivisions([]);
            }
        } finally {
            setLoading(prev => ({ ...prev, divisions: false }));
        }
    }, []);

    // Fetch subdivisions when division changes
    const fetchSubDivisions = useCallback(async (divisionId) => {
        if (!divisionId || !showSubDivision) {
            setSubDivisions([]);
            return;
        }
        setLoading(prev => ({ ...prev, subDivisions: true }));
        try {
            const res = await mastersService.getDivisionSubDivisions(divisionId);
            const subDivisionsData = res.data?.results || res.data || [];
            setSubDivisions(subDivisionsData);
        } catch (error) {
            console.error('Failed to fetch subdivisions:', error);
            try {
                const allSubs = await mastersService.getSubDivisions({ division: divisionId });
                const subDivisionsData = allSubs.data?.results || allSubs.data || [];
                setSubDivisions(subDivisionsData);
            } catch {
                setSubDivisions([]);
            }
        } finally {
            setLoading(prev => ({ ...prev, subDivisions: false }));
        }
    }, [showSubDivision]);

    // Handle zone change
    const handleZoneChange = (zoneId) => {
        const zone = zones.find(z => z.id === zoneId);
        onChange({
            zone: zoneId,
            zoneName: zone?.name || '',
            circle: '',
            circleName: '',
            division: '',
            divisionName: '',
            subDivision: '',
            subDivisionName: '',
        });
        setCircles([]);
        setDivisions([]);
        setSubDivisions([]);
        if (zoneId) {
            fetchCircles(zoneId);
        }
    };

    // Handle circle change
    const handleCircleChange = (circleId) => {
        const circle = circles.find(c => c.id === circleId);
        onChange({
            ...value,
            circle: circleId,
            circleName: circle?.name || '',
            division: '',
            divisionName: '',
            subDivision: '',
            subDivisionName: '',
        });
        setDivisions([]);
        setSubDivisions([]);
        if (circleId) {
            fetchDivisions(circleId);
        }
    };

    // Handle division change
    const handleDivisionChange = (divisionId) => {
        const division = divisions.find(d => d.id === divisionId);
        onChange({
            ...value,
            division: divisionId,
            divisionName: division?.name || '',
            subDivision: '',
            subDivisionName: '',
        });
        setSubDivisions([]);
        if (divisionId && showSubDivision) {
            fetchSubDivisions(divisionId);
        }
    };

    // Handle subdivision change
    const handleSubDivisionChange = (subDivisionId) => {
        const subDiv = subDivisions.find(s => s.id === subDivisionId);
        onChange({
            ...value,
            subDivision: subDivisionId,
            subDivisionName: subDiv?.name || '',
        });
    };

    // Common select styles
    const selectClasses = `
    w-full px-3 py-2.5 rounded-lg border border-app
    bg-app-input text-app-text text-sm
    focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900/30
    outline-none transition-all appearance-none cursor-pointer
    disabled:bg-app-surface disabled:cursor-not-allowed disabled:text-app-muted
  `;

    const renderSelect = (label, value, options, onChange, isLoading, placeholder, disabled = false) => (
        <div className="relative">
            <label className="block text-sm font-medium text-app-text mb-1.5">
                {label}
            </label>
            <div className="relative">
                <select
                    value={value || ''}
                    onChange={(e) => onChange(e.target.value)}
                    disabled={disabled || isLoading || options.length === 0}
                    className={selectClasses}
                >
                    <option value="">{isLoading ? 'Loading...' : placeholder}</option>
                    {options.map(opt => (
                        <option key={opt.id} value={opt.id}>
                            {opt.code} - {opt.name}
                        </option>
                    ))}
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                    {isLoading ? (
                        <Loader2 size={16} className="animate-spin text-app-muted" />
                    ) : (
                        <ChevronDown size={16} className="text-app-muted" />
                    )}
                </div>
            </div>
        </div>
    );

    return (
        <div className={`grid grid-cols-1 md:grid-cols-2 gap-4 ${className}`}>
            {/* Zone */}
            {renderSelect(
                'Zone',
                value.zone,
                zones,
                handleZoneChange,
                loading.zones,
                'Select Zone',
                disabled
            )}

            {/* Circle */}
            {renderSelect(
                'Circle',
                value.circle,
                circles,
                handleCircleChange,
                loading.circles,
                value.zone ? 'Select Circle' : 'Select Zone first',
                disabled || !value.zone
            )}

            {/* Division */}
            {renderSelect(
                'Division',
                value.division,
                divisions,
                handleDivisionChange,
                loading.divisions,
                value.circle ? 'Select Division' : 'Select Circle first',
                disabled || !value.circle
            )}

            {/* SubDivision */}
            {showSubDivision && renderSelect(
                'Sub-Division',
                value.subDivision,
                subDivisions,
                handleSubDivisionChange,
                loading.subDivisions,
                value.division ? 'Select Sub-Division' : 'Select Division first',
                disabled || !value.division
            )}
        </div>
    );
};

export default ChainedHierarchySelector;



================================================
FILE: frontend/src/components/masters/ClassificationSelector.jsx
================================================
import { useState, useEffect, useCallback } from 'react';
import { ChevronDown, Loader2 } from 'lucide-react';
import mastersService from '@/api/services/mastersService';

/**
 * Classification Selector Component
 * Independent dropdowns for: SchemeType â†’ Scheme, WorkType, ProjectCategory
 */
const ClassificationSelector = ({
    value = {},
    onChange,
    disabled = false,
    className = ''
}) => {
    const [schemeTypes, setSchemeTypes] = useState([]);
    const [schemes, setSchemes] = useState([]);
    const [workTypes, setWorkTypes] = useState([]);
    const [projectCategories, setProjectCategories] = useState([]);

    const [loading, setLoading] = useState({
        schemeTypes: true,
        schemes: false,
        workTypes: true,
        projectCategories: true,
    });

    useEffect(() => {
        fetchInitialData();
    }, []);

    const fetchInitialData = async () => {
        try {
            const [stRes, wtRes, pcRes] = await Promise.all([
                mastersService.getSchemeTypes(),
                mastersService.getWorkTypes(),
                mastersService.getProjectCategories(),
            ]);
            setSchemeTypes(stRes.data);
            setWorkTypes(wtRes.data);
            setProjectCategories(pcRes.data);
        } catch (error) {
            console.error('Failed to fetch classification data:', error);
        } finally {
            setLoading(prev => ({
                ...prev,
                schemeTypes: false,
                workTypes: false,
                projectCategories: false
            }));
        }
    };

    const fetchSchemes = useCallback(async (schemeTypeId) => {
        if (!schemeTypeId) {
            setSchemes([]);
            return;
        }
        setLoading(prev => ({ ...prev, schemes: true }));
        try {
            const res = await mastersService.getSchemes({ scheme_type: schemeTypeId });
            setSchemes(res.data);
        } catch (error) {
            console.error('Failed to fetch schemes:', error);
            setSchemes([]);
        } finally {
            setLoading(prev => ({ ...prev, schemes: false }));
        }
    }, []);

    const handleSchemeTypeChange = (schemeTypeId) => {
        const schemeType = schemeTypes.find(st => st.id === schemeTypeId);
        onChange({
            ...value,
            schemeType: schemeTypeId,
            schemeTypeName: schemeType?.name || '',
            scheme: '',
            schemeName: '',
        });
        setSchemes([]);
        if (schemeTypeId) {
            fetchSchemes(schemeTypeId);
        }
    };

    const handleSchemeChange = (schemeId) => {
        const scheme = schemes.find(s => s.id === schemeId);
        onChange({
            ...value,
            scheme: schemeId,
            schemeName: scheme?.name || '',
        });
    };

    const handleWorkTypeChange = (workTypeId) => {
        const workType = workTypes.find(wt => wt.id === workTypeId);
        onChange({
            ...value,
            workType: workTypeId,
            workTypeName: workType?.name || '',
        });
    };

    const handleProjectCategoryChange = (categoryId) => {
        const category = projectCategories.find(c => c.id === categoryId);
        onChange({
            ...value,
            projectCategory: categoryId,
            projectCategoryName: category?.name || '',
        });
    };

    const selectClasses = `
    w-full px-3 py-2.5 rounded-lg border border-app
    bg-app-input text-app-text text-sm
    focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900/30
    outline-none transition-all appearance-none cursor-pointer
    disabled:bg-app-surface disabled:cursor-not-allowed disabled:text-app-muted
  `;

    const renderSelect = (label, val, options, onChangeHandler, isLoading, placeholder, isDisabled = false) => (
        <div className="relative">
            <label className="block text-sm font-medium text-app-text mb-1.5">{label}</label>
            <div className="relative">
                <select
                    value={val || ''}
                    onChange={(e) => onChangeHandler(e.target.value)}
                    disabled={isDisabled || isLoading}
                    className={selectClasses}
                >
                    <option value="">{isLoading ? 'Loading...' : placeholder}</option>
                    {options.map(opt => (
                        <option key={opt.id} value={opt.id}>
                            {opt.code} - {opt.name}
                        </option>
                    ))}
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                    {isLoading ? (
                        <Loader2 size={16} className="animate-spin text-app-muted" />
                    ) : (
                        <ChevronDown size={16} className="text-app-muted" />
                    )}
                </div>
            </div>
        </div>
    );

    return (
        <div className={`grid grid-cols-1 md:grid-cols-2 gap-4 ${className}`}>
            {renderSelect('Scheme Type', value.schemeType, schemeTypes, handleSchemeTypeChange, loading.schemeTypes, 'Select Scheme Type', disabled)}
            {renderSelect('Scheme', value.scheme, schemes, handleSchemeChange, loading.schemes, value.schemeType ? 'Select Scheme' : 'Select Scheme Type first', disabled || !value.schemeType)}
            {renderSelect('Work Type', value.workType, workTypes, handleWorkTypeChange, loading.workTypes, 'Select Work Type', disabled)}
            {renderSelect('Project Category', value.projectCategory, projectCategories, handleProjectCategoryChange, loading.projectCategories, 'Select Category', disabled)}
        </div>
    );
};

export default ClassificationSelector;



================================================
FILE: frontend/src/components/masters/ContractorSelector.jsx
================================================
/**
 * ContractorSelector Component
 * 
 * A smart dropdown for selecting contractors with blacklist guardrails.
 * - Fetches contractors from /api/masters/contractors/
 * - Shows status badges (Active, Blacklisted, Expired)
 * - BLOCKS selection of blacklisted or expired contractors
 * - Optionally can filter to show only active contractors
 */
import { useState, useEffect } from 'react';
import { AlertTriangle, Ban, Clock, CheckCircle2, Search, X } from 'lucide-react';
import mastersService from '@/api/services/mastersService';

const ContractorSelector = ({
    value,
    onChange,
    onContractorSelect,
    showOnlyActive = false,
    disabled = false,
    className = '',
    label = 'Contractor',
    required = false,
    error = null,
}) => {
    const [contractors, setContractors] = useState([]);
    const [loading, setLoading] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [isOpen, setIsOpen] = useState(false);
    const [selectedContractor, setSelectedContractor] = useState(null);

    // Fetch contractors on mount
    useEffect(() => {
        const fetchContractors = async () => {
            setLoading(true);
            try {
                // Use active endpoint if showOnlyActive, else fetch all
                const response = showOnlyActive
                    ? await mastersService.getActiveContractors()
                    : await mastersService.getContractors();
                setContractors(response.data || []);
            } catch (err) {
                console.error('Failed to fetch contractors:', err);
                setContractors([]);
            } finally {
                setLoading(false);
            }
        };
        fetchContractors();
    }, [showOnlyActive]);

    // Set selected contractor when value changes
    useEffect(() => {
        if (value && contractors.length > 0) {
            const found = contractors.find(c => c.id === value);
            setSelectedContractor(found || null);
        } else {
            setSelectedContractor(null);
        }
    }, [value, contractors]);

    // Filter contractors by search term
    const filteredContractors = contractors.filter(c =>
        c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.code.toLowerCase().includes(searchTerm.toLowerCase())
    );

    // Get status color and icon
    const getStatusStyle = (contractor) => {
        if (contractor.blacklisted) {
            return {
                bg: 'bg-red-100 dark:bg-red-900/30',
                text: 'text-red-700 dark:text-red-300',
                icon: Ban,
                label: 'Blacklisted',
                blocked: true
            };
        }
        if (contractor.is_valid === false) {
            return {
                bg: 'bg-amber-100 dark:bg-amber-900/30',
                text: 'text-amber-700 dark:text-amber-300',
                icon: Clock,
                label: 'Expired',
                blocked: true
            };
        }
        return {
            bg: 'bg-emerald-100 dark:bg-emerald-900/30',
            text: 'text-emerald-700 dark:text-emerald-300',
            icon: CheckCircle2,
            label: 'Active',
            blocked: false
        };
    };

    // Handle contractor selection
    const handleSelect = (contractor) => {
        const status = getStatusStyle(contractor);

        // Block if blacklisted or expired
        if (status.blocked) {
            return; // Don't allow selection
        }

        setSelectedContractor(contractor);
        onChange?.(contractor.id);
        onContractorSelect?.(contractor);
        setIsOpen(false);
        setSearchTerm('');
    };

    // Clear selection
    const handleClear = () => {
        setSelectedContractor(null);
        onChange?.('');
        onContractorSelect?.(null);
    };

    return (
        <div className={`relative ${className}`}>
            {/* Label */}
            {label && (
                <label className="block text-xs font-medium text-slate-700 dark:text-neutral-300 mb-1">
                    {label} {required && <span className="text-red-500">*</span>}
                </label>
            )}

            {/* Selected Value Display */}
            <div
                onClick={() => !disabled && setIsOpen(!isOpen)}
                className={`
                    w-full px-3 py-2 border rounded-lg bg-white dark:bg-neutral-900 cursor-pointer
                    flex items-center justify-between
                    ${disabled ? 'bg-slate-100 dark:bg-neutral-800 cursor-not-allowed' : 'hover:border-primary-400 dark:hover:border-primary-500'}
                    ${error ? 'border-red-300 dark:border-red-500/50' : 'border-slate-300 dark:border-neutral-700'}
                    ${isOpen ? 'border-primary-500 ring-2 ring-primary-100 dark:ring-primary-900/30' : ''}
                `}
            >
                {selectedContractor ? (
                    <div className="flex items-center gap-2 flex-1 min-w-0">
                        <span className="truncate text-sm">
                            {selectedContractor.code} - {selectedContractor.name}
                        </span>
                        {(() => {
                            const status = getStatusStyle(selectedContractor);
                            const Icon = status.icon;
                            return (
                                <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${status.bg} ${status.text}`}>
                                    <Icon size={12} />
                                    {status.label}
                                </span>
                            );
                        })()}
                    </div>
                ) : (
                    <span className="text-slate-400 dark:text-neutral-500 text-sm">Select contractor...</span>
                )}

                <div className="flex items-center gap-1">
                    {selectedContractor && !disabled && (
                        <button
                            type="button"
                            onClick={(e) => { e.stopPropagation(); handleClear(); }}
                            className="p-1 hover:bg-slate-100 rounded"
                        >
                            <X size={14} className="text-slate-400" />
                        </button>
                    )}
                </div>
            </div>

            {/* Error Message */}
            {error && <p className="text-xs text-red-500 mt-1">{error}</p>}

            {/* Dropdown */}
            {isOpen && (
                <div className="absolute z-50 mt-1 w-full bg-white dark:bg-neutral-900 border border-slate-200 dark:border-neutral-700 rounded-lg shadow-lg max-h-80 overflow-hidden">
                    {/* Search */}
                    <div className="p-2 border-b border-slate-100 dark:border-neutral-800">
                        <div className="relative">
                            <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                            <input
                                type="text"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                placeholder="Search by name or code..."
                                className="w-full pl-9 pr-3 py-2 text-sm border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-slate-900 dark:text-white rounded-md focus:outline-none focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900/30 focus:border-primary-500"
                                autoFocus
                            />
                        </div>
                    </div>

                    {/* Options */}
                    <div className="max-h-60 overflow-y-auto">
                        {loading ? (
                            <div className="p-4 text-center text-slate-500 text-sm">Loading...</div>
                        ) : filteredContractors.length === 0 ? (
                            <div className="p-4 text-center text-slate-500 text-sm">No contractors found</div>
                        ) : (
                            filteredContractors.map((contractor) => {
                                const status = getStatusStyle(contractor);
                                const Icon = status.icon;

                                return (
                                    <div
                                        key={contractor.id}
                                        onClick={() => handleSelect(contractor)}
                                        className={`
                                            px-3 py-2 flex items-center justify-between
                                            ${status.blocked
                                                ? 'opacity-60 cursor-not-allowed bg-slate-50 dark:bg-neutral-800'
                                                : 'cursor-pointer hover:bg-slate-50 dark:hover:bg-neutral-800'
                                            }
                                            ${value === contractor.id ? 'bg-primary-50 dark:bg-primary-900/30' : ''}
                                        `}
                                    >
                                        <div className="min-w-0 flex-1">
                                            <p className="text-sm font-medium text-slate-900 dark:text-white truncate">
                                                {contractor.code} - {contractor.name}
                                            </p>
                                            <p className="text-xs text-slate-500 dark:text-neutral-400">
                                                {contractor.contractor_type} â€¢ {contractor.registration_class || 'Unclassified'}
                                            </p>
                                            {contractor.blacklisted && contractor.blacklist_reason && (
                                                <p className="text-xs text-red-500 mt-1 flex items-center gap-1">
                                                    <AlertTriangle size={10} />
                                                    {contractor.blacklist_reason}
                                                </p>
                                            )}
                                        </div>

                                        <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${status.bg} ${status.text} ml-2 flex-shrink-0`}>
                                            <Icon size={12} />
                                            {status.label}
                                        </span>
                                    </div>
                                );
                            })
                        )}
                    </div>

                    {/* Guardrail Notice */}
                    {!showOnlyActive && (
                        <div className="p-2 bg-slate-50 dark:bg-neutral-800 border-t border-slate-100 dark:border-neutral-700">
                            <p className="text-xs text-slate-500 dark:text-neutral-400 flex items-center gap-1">
                                <Ban size={10} className="text-red-400" />
                                Blacklisted and expired contractors cannot be selected
                            </p>
                        </div>
                    )}
                </div>
            )}

            {/* Backdrop to close dropdown */}
            {isOpen && (
                <div
                    className="fixed inset-0 z-40"
                    onClick={() => setIsOpen(false)}
                />
            )}
        </div>
    );
};

export default ContractorSelector;



================================================
FILE: frontend/src/components/masters/DeleteConfirmModal.jsx
================================================
import { useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { AlertTriangle, X, Loader2 } from 'lucide-react';
import Button from '@/components/ui/Button';

/**
 * Confirmation modal for delete operations
 * Uses createPortal to render above all layout elements
 */
const DeleteConfirmModal = ({
    isOpen,
    onClose,
    onConfirm,
    title = 'Delete Record',
    message = 'Are you sure you want to delete this record? This action cannot be undone.',
    itemName = '',
    loading = false
}) => {
    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && isOpen && !loading) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [isOpen, onClose, loading]);

    const modalContent = (
        <AnimatePresence>
            {isOpen && (
                <>
                    {/* Backdrop */}
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        onClick={onClose}
                        className="fixed inset-0 bg-black/50 dark:bg-black/70 backdrop-blur-sm z-[9999]"
                    />

                    {/* Modal */}
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95, y: 20 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.95, y: 20 }}
                        className="fixed inset-0 z-[9999] flex items-center justify-center p-4"
                    >
                        <div className="bg-app-card rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                            {/* Header */}
                            <div className="flex items-center justify-between px-6 py-4 border-b border-app-subtle">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-red-100 dark:bg-red-900/30 rounded-lg">
                                        <AlertTriangle size={20} className="text-red-600 dark:text-red-400" />
                                    </div>
                                    <h2 className="text-lg font-semibold text-app-heading">{title}</h2>
                                </div>
                                <button
                                    onClick={onClose}
                                    className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                                    disabled={loading}
                                >
                                    <X size={20} className="text-slate-500 dark:text-neutral-400" />
                                </button>
                            </div>

                            {/* Content */}
                            <div className="p-6">
                                <p className="text-app-text">{message}</p>
                                {itemName && (
                                    <div className="mt-3 p-3 bg-app-secondary rounded-lg border border-app-subtle">
                                        <p className="text-sm font-medium text-app-heading">{itemName}</p>
                                    </div>
                                )}
                            </div>

                            {/* Actions */}
                            <div className="flex justify-end gap-3 px-6 py-4 border-t border-app-subtle bg-app-secondary">
                                <Button
                                    variant="outline"
                                    onClick={onClose}
                                    disabled={loading}
                                >
                                    Cancel
                                </Button>
                                <Button
                                    variant="danger"
                                    onClick={onConfirm}
                                    disabled={loading}
                                    className="bg-red-600 hover:bg-red-700 text-white"
                                >
                                    {loading ? (
                                        <>
                                            <Loader2 size={16} className="animate-spin mr-2" />
                                            Deleting...
                                        </>
                                    ) : (
                                        'Delete'
                                    )}
                                </Button>
                            </div>
                        </div>
                    </motion.div>
                </>
            )}
        </AnimatePresence>
    );

    return createPortal(modalContent, document.body);
};

export default DeleteConfirmModal;



================================================
FILE: frontend/src/components/masters/fieldConfigs.js
================================================
/**
 * Field configurations for each master data type
 * Used by MasterFormModal to dynamically render forms
 */

// Hierarchy Masters
export const zoneFields = [
    { name: 'code', label: 'Zone Code', required: true, placeholder: 'e.g., ZN-SOUTH', helpText: 'Unique identifier for this zone' },
    { name: 'name', label: 'Zone Name', required: true, placeholder: 'e.g., South Operations Zone' },
    { name: 'state_covered', label: 'State/Region', placeholder: 'e.g., Telangana' },
    {
        name: 'head_user',
        label: 'Zone Head',
        type: 'user-select',
        placeholder: 'Select or invite Zone Head user',
        helpText: 'Select a user for Zone Head'
    },
    { name: 'head', label: 'Zone Head Name (Legacy)', type: 'hidden' },
    {
        name: 'status',
        label: 'Status',
        type: 'select',
        defaultValue: 'Active',
        options: [
            { value: 'Active', label: 'Active' },
            { value: 'Inactive', label: 'Inactive' },
        ]
    },
];

export const circleFields = (zones = []) => [
    { name: 'code', label: 'Circle Code', required: true, placeholder: 'e.g., C-CIVIL' },
    { name: 'name', label: 'Circle Name', required: true, placeholder: 'e.g., Civil Engineering Circle' },
    {
        name: 'zone',
        label: 'Parent Zone',
        type: 'select',
        required: true,
        options: zones.map(z => ({ value: z.id, label: `${z.code} - ${z.name}` }))
    },
    {
        name: 'authority_level',
        label: 'Authority Level',
        type: 'select',
        defaultValue: 'SE',
        options: [
            { value: 'CE', label: 'Chief Engineer' },
            { value: 'SE', label: 'Superintending Engineer' },
        ]
    },
    {
        name: 'status',
        label: 'Status',
        type: 'select',
        defaultValue: 'Active',
        options: [
            { value: 'Active', label: 'Active' },
            { value: 'Inactive', label: 'Inactive' },
        ]
    },
];

export const divisionFields = (circles = [], users = []) => [
    { name: 'code', label: 'Division Code', required: true, placeholder: 'e.g., DIV-NGR' },
    { name: 'name', label: 'Division Name', required: true, placeholder: 'e.g., North Gandhinagar Division' },
    {
        name: 'circle',
        label: 'Parent Circle',
        type: 'select',
        required: true,
        options: circles.map(c => ({ value: c.id, label: `${c.code} - ${c.name}` }))
    },
    {
        name: 'hod_user',
        label: 'Head of Division (HOD)',
        type: 'user-select',
        placeholder: 'Select or invite HOD user',
        autoFillFields: ['contact_email', 'contact_phone'],
        helpText: 'Select a user to auto-fill contact details'
    },
    { name: 'hod', label: 'HOD Name (Legacy)', type: 'hidden' },
    { name: 'contact_email', label: 'Contact Email', type: 'email', placeholder: 'Auto-filled from user', helpText: 'You can edit after auto-fill' },
    { name: 'contact_phone', label: 'Contact Phone', placeholder: 'Auto-filled from user', helpText: 'You can edit after auto-fill' },
    { name: 'effective_date', label: 'Effective Date', type: 'date' },
    {
        name: 'status',
        label: 'Status',
        type: 'select',
        defaultValue: 'Active',
        options: [
            { value: 'Active', label: 'Active' },
            { value: 'Inactive', label: 'Inactive' },
        ]
    },
];

export const subDivisionFields = (divisions = [], users = []) => [
    { name: 'code', label: 'Sub-Division Code', required: true, placeholder: 'e.g., SD-01-W' },
    { name: 'name', label: 'Sub-Division Name', required: true, placeholder: 'e.g., West Sub-Division' },
    {
        name: 'division',
        label: 'Parent Division',
        type: 'select',
        required: true,
        options: divisions.map(d => ({ value: d.id, label: `${d.code} - ${d.name}` }))
    },
    { name: 'jurisdiction_area', label: 'Jurisdiction Area', placeholder: 'Geographic area covered' },
    {
        name: 'reporting_officer_user',
        label: 'Reporting Officer (SDE)',
        type: 'user-select',
        placeholder: 'Select or invite officer',
        helpText: 'Sub-Divisional Engineer responsible for this area'
    },
    { name: 'reporting_officer', label: 'Officer Name (Legacy)', type: 'hidden' },
];

// Geography Masters
export const districtFields = [
    { name: 'code', label: 'District Code', required: true, placeholder: 'e.g., D-410' },
    { name: 'name', label: 'District Name', required: true, placeholder: 'e.g., Medak' },
    { name: 'state_name', label: 'State', required: true, placeholder: 'e.g., Telangana' },
    { name: 'pincode_range', label: 'Pincode Range', placeholder: 'e.g., 502001 to 502999' },
];

export const townFields = (districts = []) => [
    { name: 'code', label: 'Town Code', required: true, placeholder: 'e.g., T-0010' },
    { name: 'name', label: 'Town/City Name', required: true, placeholder: 'e.g., Zaheerabad' },
    {
        name: 'district',
        label: 'District',
        type: 'select',
        required: true,
        options: districts.map(d => ({ value: d.id, label: `${d.code} - ${d.name}` }))
    },
    {
        name: 'classification',
        label: 'Classification',
        type: 'select',
        defaultValue: 'Town',
        options: [
            { value: 'Metropolitan', label: 'Metropolitan' },
            { value: 'Municipality', label: 'Municipality' },
            { value: 'Town', label: 'Town' },
            { value: 'Village', label: 'Village' },
        ]
    },
    { name: 'population', label: 'Population', type: 'number', placeholder: 'Estimated population' },
];

// Classification Masters
export const schemeTypeFields = [
    { name: 'code', label: 'Scheme Type Code', required: true, placeholder: 'e.g., ST-CS' },
    { name: 'name', label: 'Scheme Type Name', required: true, placeholder: 'e.g., Centrally Sponsored' },
    {
        name: 'category',
        label: 'Category',
        type: 'select',
        defaultValue: 'Infrastructure',
        options: [
            { value: 'Infrastructure', label: 'Infrastructure' },
            { value: 'Social Sector', label: 'Social Sector' },
            { value: 'Education', label: 'Education' },
            { value: 'Health', label: 'Health' },
            { value: 'Agriculture', label: 'Agriculture' },
            { value: 'Other', label: 'Other' },
        ]
    },
];

export const schemeFields = (schemeTypes = [], fundingSources = []) => [
    { name: 'code', label: 'Scheme Code', required: true, placeholder: 'e.g., PMSGY' },
    { name: 'name', label: 'Scheme Name', required: true, placeholder: 'e.g., Pradhan Mantri Gram Sadak Yojana' },
    {
        name: 'scheme_type',
        label: 'Scheme Type',
        type: 'select',
        required: true,
        options: schemeTypes.map(st => ({ value: st.id, label: `${st.code} - ${st.name}` }))
    },
    {
        name: 'funding_agency',
        label: 'Funding Agency',
        type: 'select',
        options: [
            { value: '', label: '-- Select Funding Agency --' },
            ...fundingSources.map(fs => ({
                value: fs.source_name || fs.name,
                label: fs.source_name || fs.name
            }))
        ],
        helpText: 'Linked to Fund Management sources'
    },
    { name: 'start_date', label: 'Start Date', type: 'date' },
    { name: 'end_date', label: 'End Date', type: 'date' },
    { name: 'budget_head_code', label: 'Budget Head Code', placeholder: 'Accounting code' },
    { name: 'objective', label: 'Objective', type: 'textarea', placeholder: 'Brief description of scheme goals' },
];

export const workTypeFields = [
    { name: 'code', label: 'Work Type Code', required: true, placeholder: 'e.g., WT-ROAD' },
    { name: 'name', label: 'Work Type Name', required: true, placeholder: 'e.g., Road Construction' },
    {
        name: 'sector',
        label: 'Sector',
        type: 'select',
        defaultValue: 'PWD',
        options: [
            { value: 'PWD', label: 'Public Works Department' },
            { value: 'Irrigation', label: 'Irrigation' },
            { value: 'Health', label: 'Health' },
            { value: 'Education', label: 'Education' },
            { value: 'Roads', label: 'Roads & Highways' },
            { value: 'Water Supply', label: 'Water Supply' },
            { value: 'Other', label: 'Other' },
        ]
    },
    { name: 'unit_of_measurement', label: 'Unit of Measurement', placeholder: 'e.g., Km, Sq.m' },
];

export const projectCategoryFields = [
    { name: 'code', label: 'Category Code', required: true, placeholder: 'e.g., PC-MAJ' },
    { name: 'name', label: 'Category Name', required: true, placeholder: 'e.g., Major Project' },
    { name: 'threshold_value', label: 'Threshold Value (â‚¹)', type: 'number', step: '0.01', placeholder: 'Minimum value in INR' },
    {
        name: 'approval_authority',
        label: 'Approval Authority',
        type: 'select',
        required: true,
        options: [
            { value: 'Chief Engineer', label: 'Chief Engineer (CE)' },
            { value: 'Superintending Engineer', label: 'Superintending Engineer (SE)' },
            { value: 'Executive Engineer', label: 'Executive Engineer (EE)' },
            { value: 'Assistant Engineer', label: 'Assistant Engineer (AE)' },
            { value: 'Sub-Divisional Engineer', label: 'Sub-Divisional Engineer (SDE)' },
            { value: 'SPV Management', label: 'SPV Management' },
            { value: 'Board/Committee', label: 'Board/Committee' },
        ],
        helpText: 'Authority level for project approvals'
    },
];

// Entity Masters
export const contractorFields = [
    { name: 'code', label: 'Contractor Code', required: true, placeholder: 'e.g., C-10025' },
    { name: 'name', label: 'Contractor/Firm Name', required: true, placeholder: 'Full legal name' },
    {
        name: 'contractor_type',
        label: 'Contractor Type',
        type: 'select',
        defaultValue: 'Proprietorship',
        options: [
            { value: 'Proprietorship', label: 'Proprietorship' },
            { value: 'Partnership', label: 'Partnership' },
            { value: 'Private Limited', label: 'Private Limited' },
            { value: 'Public Limited', label: 'Public Limited' },
            { value: 'LLP', label: 'LLP' },
            { value: 'Government', label: 'Government Entity' },
            { value: 'Other', label: 'Other' },
        ]
    },
    {
        name: 'registration_class',
        label: 'Registration Class',
        type: 'select',
        options: [
            { value: 'Class A', label: 'Class A (Unlimited)' },
            { value: 'Class B', label: 'Class B (Up to â‚¹50 Cr)' },
            { value: 'Class C', label: 'Class C (Up to â‚¹10 Cr)' },
            { value: 'Class D', label: 'Class D (Up to â‚¹2 Cr)' },
            { value: 'Class E', label: 'Class E (Up to â‚¹50 Lakh)' },
        ]
    },
    { name: 'registration_number', label: 'Registration Number', placeholder: 'License/Reg number' },
    { name: 'pan', label: 'PAN', placeholder: '10-digit PAN', pattern: /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/, patternMessage: 'Invalid PAN format' },
    { name: 'gstin', label: 'GSTIN', placeholder: '15-digit GSTIN' },
    { name: 'tds_rate', label: 'TDS Rate (%)', type: 'number', step: '0.01', defaultValue: '2.00' },
    { name: 'contact_person', label: 'Contact Person', placeholder: 'Key representative name' },
    { name: 'email', label: 'Email', type: 'email', placeholder: 'official@company.com' },
    { name: 'phone', label: 'Phone', placeholder: '+91...' },
    { name: 'address', label: 'Registered Address', type: 'textarea', placeholder: 'Full address' },
    { name: 'validity_date', label: 'Validity Date', type: 'date', helpText: 'Registration expiry date' },
    { name: 'blacklisted', label: 'Blacklisted', type: 'checkbox', checkboxLabel: 'Contractor is blacklisted' },
];

// Finance Config - ETP Charges
export const etpFields = [
    {
        name: 'code',
        label: 'ETP Code',
        required: true,
        placeholder: 'e.g., LABOUR-CESS',
        helpText: 'Unique identifier for this charge'
    },
    {
        name: 'name',
        label: 'Charge Name',
        required: true,
        placeholder: 'e.g., Labour Welfare Cess',
        helpText: 'Official name as per government notification'
    },
    {
        name: 'charge_type',
        label: 'Charge Type',
        type: 'select',
        required: true,
        defaultValue: 'Deduction',
        options: [
            { value: 'Deduction', label: 'Deduction' },
            { value: 'Recovery', label: 'Recovery' },
            { value: 'Levy', label: 'Levy' },
            { value: 'Addition', label: 'Addition' },
        ],
        helpText: 'How this charge affects the bill calculation'
    },
    {
        name: 'rate_percentage',
        label: 'Rate (%)',
        type: 'number',
        step: '0.001',
        required: true,
        placeholder: 'e.g., 1.000',
        helpText: 'Percentage rate to apply'
    },
    {
        name: 'basis_of_calculation',
        label: 'Basis of Calculation',
        type: 'select',
        required: true,
        defaultValue: 'Gross Bill Value',
        options: [
            { value: 'Gross Bill Value', label: 'Gross Bill Value' },
            { value: 'Works Component Only', label: 'Works Component Only' },
            { value: 'Material Cost', label: 'Material Cost' },
            { value: 'Labour Cost', label: 'Labour Cost' },
            { value: 'Net Payable', label: 'Net Payable' },
        ],
        helpText: 'Which amount the percentage is applied to'
    },
    {
        name: 'effective_date',
        label: 'Effective Date',
        type: 'date',
        required: true,
        helpText: 'Charge becomes active ON this date. Bills before this date will not include this charge.'
    },
    {
        name: 'govt_reference',
        label: 'Govt. Reference',
        placeholder: 'Circular/Order number',
        helpText: 'Government order or circular reference'
    },
    {
        name: 'account_head',
        label: 'Account Head/Ledger',
        placeholder: 'Finance code',
        helpText: 'Internal finance ledger code for accounting'
    },
    {
        name: 'is_active',
        label: 'Active Status',
        type: 'checkbox',
        checkboxLabel: 'Charge is currently active',
        defaultValue: true,
        helpText: 'Uncheck to permanently disable this charge'
    },
];



================================================
FILE: frontend/src/components/masters/GeographySelector.jsx
================================================
import { useState, useEffect, useCallback } from 'react';
import { ChevronDown, Loader2 } from 'lucide-react';
import mastersService from '@/api/services/mastersService';

/**
 * Geography Selector Component
 * Provides dependent dropdowns: District â†’ Town
 */
const GeographySelector = ({
    value = {},
    onChange,
    disabled = false,
    className = ''
}) => {
    const [districts, setDistricts] = useState([]);
    const [towns, setTowns] = useState([]);
    const [loading, setLoading] = useState({ districts: true, towns: false });

    useEffect(() => {
        fetchDistricts();
    }, []);

    const fetchDistricts = async () => {
        setLoading(prev => ({ ...prev, districts: true }));
        try {
            const res = await mastersService.getDistricts();
            setDistricts(res.data);
        } catch (error) {
            console.error('Failed to fetch districts:', error);
        } finally {
            setLoading(prev => ({ ...prev, districts: false }));
        }
    };

    const fetchTowns = useCallback(async (districtId) => {
        if (!districtId) {
            setTowns([]);
            return;
        }
        setLoading(prev => ({ ...prev, towns: true }));
        try {
            const res = await mastersService.getDistrictTowns(districtId);
            setTowns(res.data);
        } catch (error) {
            try {
                const allTowns = await mastersService.getTowns({ district: districtId });
                setTowns(allTowns.data);
            } catch {
                setTowns([]);
            }
        } finally {
            setLoading(prev => ({ ...prev, towns: false }));
        }
    }, []);

    const handleDistrictChange = (districtId) => {
        const district = districts.find(d => d.id === districtId);
        onChange({
            district: districtId,
            districtName: district?.name || '',
            town: '',
            townName: '',
        });
        setTowns([]);
        if (districtId) {
            fetchTowns(districtId);
        }
    };

    const handleTownChange = (townId) => {
        const town = towns.find(t => t.id === townId);
        onChange({
            ...value,
            town: townId,
            townName: town?.name || '',
        });
    };

    const selectClasses = `
    w-full px-3 py-2.5 rounded-lg border border-app
    bg-app-input text-app-text text-sm
    focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900/30
    outline-none transition-all appearance-none cursor-pointer
    disabled:bg-app-surface disabled:cursor-not-allowed disabled:text-app-muted
  `;

    const renderSelect = (label, val, options, onChangeHandler, isLoading, placeholder, isDisabled = false, displayKey = 'name') => (
        <div className="relative">
            <label className="block text-sm font-medium text-app-text mb-1.5">{label}</label>
            <div className="relative">
                <select
                    value={val || ''}
                    onChange={(e) => onChangeHandler(e.target.value)}
                    disabled={isDisabled || isLoading}
                    className={selectClasses}
                >
                    <option value="">{placeholder}</option>
                    {options.map(opt => (
                        <option key={opt.id} value={opt.id}>
                            {opt.code ? `${opt.code} - ${opt[displayKey]}` : opt[displayKey]}
                        </option>
                    ))}
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                    {isLoading ? (
                        <Loader2 size={16} className="animate-spin text-app-muted" />
                    ) : (
                        <ChevronDown size={16} className="text-app-muted" />
                    )}
                </div>
            </div>
        </div>
    );

    return (
        <div className={`grid grid-cols-1 md:grid-cols-2 gap-4 ${className}`}>
            {renderSelect('District', value.district, districts, handleDistrictChange, loading.districts, 'Select District', disabled)}
            {renderSelect('Town/City', value.town, towns, handleTownChange, loading.towns, value.district ? 'Select Town' : 'Select District first', disabled || !value.district)}
        </div>
    );
};

export default GeographySelector;



================================================
FILE: frontend/src/components/masters/LocationSelector.jsx
================================================
import React, { useState, useEffect, useCallback } from 'react';
import mastersService from '../../api/services/mastersService';
import { MapPin, Building2, Globe, Navigation, Loader2, ChevronDown, Check } from 'lucide-react';

/**
 * LocationSelector - Cascading dropdown for Country â†’ State â†’ District â†’ City
 * Premium dark theme styling with glassmorphism design
 * 
 * Props:
 * - value: { country: id, state: id, district: id, city: id }
 * - onChange: (value) => void
 * - disabled: boolean
 * - required: boolean
 * - className: string
 */
const LocationSelector = ({
    value,
    onChange,
    disabled = false,
    required = false,
    className = ''
}) => {
    // Normalize value to empty object if null/undefined
    const normalizedValue = value || {};

    const [countries, setCountries] = useState([]);
    const [states, setStates] = useState([]);
    const [districts, setDistricts] = useState([]);
    const [cities, setCities] = useState([]);

    const [loading, setLoading] = useState({
        countries: true,
        states: false,
        districts: false,
        cities: false
    });

    const [openDropdown, setOpenDropdown] = useState(null);

    // Fetch countries on mount
    useEffect(() => {
        fetchCountries();
    }, []);

    // Fetch states when country changes
    useEffect(() => {
        if (normalizedValue.country) {
            fetchStates(normalizedValue.country);
        } else {
            setStates([]);
            setDistricts([]);
            setCities([]);
        }
    }, [normalizedValue.country]);

    // Fetch districts when state changes
    useEffect(() => {
        if (normalizedValue.state) {
            fetchDistricts(normalizedValue.state);
        } else {
            setDistricts([]);
            setCities([]);
        }
    }, [normalizedValue.state]);

    // Fetch cities when district changes
    useEffect(() => {
        if (normalizedValue.district) {
            fetchCities(normalizedValue.district);
        } else {
            setCities([]);
        }
    }, [normalizedValue.district]);

    const fetchCountries = async () => {
        setLoading(prev => ({ ...prev, countries: true }));
        try {
            console.log('[LocationSelector] Fetching countries...');
            const res = await mastersService.getCountries();
            console.log('[LocationSelector] Countries response:', res);

            // Handle various response formats
            let data = [];
            if (Array.isArray(res.data)) {
                data = res.data;
            } else if (res.data?.results && Array.isArray(res.data.results)) {
                data = res.data.results;
            } else if (res.data && typeof res.data === 'object') {
                // Check if it's iterable
                data = Object.values(res.data).filter(item => item && typeof item === 'object' && item.id);
            }

            console.log('[LocationSelector] Parsed countries data:', data);
            setCountries(data);

            // Auto-select India if it's the only country (UX improvement)
            if (data.length === 1 && !normalizedValue.country) {
                console.log('[LocationSelector] Auto-selecting India');
                onChange({
                    country: data[0].id,
                    countryName: data[0].name,
                    state: '',
                    stateName: '',
                    district: '',
                    districtName: '',
                    city: '',
                    cityName: ''
                });
            }
        } catch (error) {
            console.error('[LocationSelector] Failed to fetch countries:', error);
            console.error('[LocationSelector] Error details:', error.response?.data || error.message);
            setCountries([]);
        } finally {
            setLoading(prev => ({ ...prev, countries: false }));
        }
    };

    const fetchStates = useCallback(async (countryId) => {
        if (!countryId) return;
        setLoading(prev => ({ ...prev, states: true }));
        try {
            const res = await mastersService.getStates({ country: countryId });
            const data = Array.isArray(res.data) ? res.data : (res.data?.results || []);
            setStates(data);
        } catch (error) {
            console.error('Failed to fetch states:', error);
            setStates([]);
        } finally {
            setLoading(prev => ({ ...prev, states: false }));
        }
    }, []);

    const fetchDistricts = useCallback(async (stateId) => {
        if (!stateId) return;
        setLoading(prev => ({ ...prev, districts: true }));
        try {
            const res = await mastersService.getStateDistricts(stateId);
            const data = Array.isArray(res.data) ? res.data : (res.data?.results || []);
            setDistricts(data);
        } catch (error) {
            console.error('Failed to fetch districts:', error);
            setDistricts([]);
        } finally {
            setLoading(prev => ({ ...prev, districts: false }));
        }
    }, []);

    const fetchCities = useCallback(async (districtId) => {
        if (!districtId) return;
        setLoading(prev => ({ ...prev, cities: true }));
        try {
            const res = await mastersService.getDistrictCities(districtId);
            const data = Array.isArray(res.data) ? res.data : (res.data?.results || []);
            setCities(data);
        } catch (error) {
            console.error('Failed to fetch cities:', error);
            setCities([]);
        } finally {
            setLoading(prev => ({ ...prev, cities: false }));
        }
    }, []);

    const handleSelect = (field, id, name, options) => {
        const nextValue = { ...normalizedValue, [field]: id };
        const nameField = `${field}Name`;
        nextValue[nameField] = name;

        // Reset dependent fields
        if (field === 'country') {
            nextValue.state = '';
            nextValue.stateName = '';
            nextValue.district = '';
            nextValue.districtName = '';
            nextValue.city = '';
            nextValue.cityName = '';
        } else if (field === 'state') {
            nextValue.district = '';
            nextValue.districtName = '';
            nextValue.city = '';
            nextValue.cityName = '';
        } else if (field === 'district') {
            nextValue.city = '';
            nextValue.cityName = '';
        }

        onChange(nextValue);
        setOpenDropdown(null);
    };

    const getSelectedName = (field, options) => {
        const id = normalizedValue[field];
        if (!id) return null;
        const option = options.find(opt => String(opt.id) === String(id));
        return option?.name || null;
    };

    // Custom Select Component
    const SelectField = ({ label, field, options, icon: Icon, isLoading, placeholder, fieldDisabled }) => {
        const isOpen = openDropdown === field;
        const selectedName = getSelectedName(field, options);
        const isDisabled = disabled || fieldDisabled || isLoading;

        return (
            <div className="flex-1 min-w-0">
                <label className="block text-sm font-medium text-app-muted mb-2 flex items-center gap-1.5">
                    <Icon size={14} className="text-primary-500" />
                    {label} {required && <span className="text-red-500">*</span>}
                </label>
                <div className="relative">
                    <button
                        type="button"
                        onClick={() => !isDisabled && setOpenDropdown(isOpen ? null : field)}
                        disabled={isDisabled}
                        className={`
                            w-full px-4 py-3 rounded-xl text-left transition-all duration-200
                            flex items-center justify-between gap-2
                            bg-app-input border border-app
                            ${isDisabled
                                ? 'opacity-50 cursor-not-allowed'
                                : 'hover:border-primary-500/50 hover:bg-app-hover cursor-pointer'
                            }
                            ${isOpen ? 'border-primary-500 ring-2 ring-primary-500/20' : ''}
                            ${selectedName ? 'text-app-heading' : 'text-app-muted'}
                        `}
                    >
                        <span className="truncate">
                            {isLoading ? 'Loading...' : (selectedName || placeholder)}
                        </span>
                        <span className="flex-shrink-0">
                            {isLoading ? (
                                <Loader2 size={16} className="animate-spin text-primary-500" />
                            ) : (
                                <ChevronDown
                                    size={16}
                                    className={`text-app-muted transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}
                                />
                            )}
                        </span>
                    </button>

                    {/* Dropdown Menu - Opens UPWARD */}
                    {isOpen && options.length > 0 && (
                        <div className="absolute z-50 w-full bottom-full mb-2 py-2 rounded-xl border border-app bg-app-card shadow-xl max-h-60 overflow-y-auto">
                            {options.map(opt => {
                                const isSelected = String(normalizedValue[field]) === String(opt.id);
                                return (
                                    <button
                                        key={opt.id}
                                        type="button"
                                        onClick={() => handleSelect(field, opt.id, opt.name, options)}
                                        className={`
                                            w-full px-4 py-2.5 text-left flex items-center justify-between
                                            transition-colors duration-150
                                            ${isSelected
                                                ? 'bg-primary-500/10 text-primary-500'
                                                : 'text-app-text hover:bg-app-hover'
                                            }
                                        `}
                                    >
                                        <span className="truncate">{opt.name}</span>
                                        {isSelected && <Check size={16} className="text-primary-500 flex-shrink-0" />}
                                    </button>
                                );
                            })}
                        </div>
                    )}

                    {/* Empty state - Opens UPWARD */}
                    {isOpen && options.length === 0 && !isLoading && (
                        <div className="absolute z-50 w-full bottom-full mb-2 py-4 rounded-xl border border-app bg-app-card shadow-xl text-center text-app-muted text-sm">
                            No options available
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // Close dropdown when clicking outside
    useEffect(() => {
        const handleClickOutside = (e) => {
            if (!e.target.closest('[data-location-selector]')) {
                setOpenDropdown(null);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    return (
        <div
            data-location-selector
            className={`grid grid-cols-2 lg:grid-cols-4 gap-4 ${className}`}
        >
            <SelectField
                label="Country"
                field="country"
                options={countries}
                icon={Globe}
                isLoading={loading.countries}
                placeholder="Select Country"
            />

            <SelectField
                label="State"
                field="state"
                options={states}
                icon={MapPin}
                isLoading={loading.states}
                placeholder="Select State"
                fieldDisabled={!normalizedValue.country}
            />

            <SelectField
                label="District"
                field="district"
                options={districts}
                icon={Navigation}
                isLoading={loading.districts}
                placeholder="Select District"
                fieldDisabled={!normalizedValue.state}
            />

            <SelectField
                label="City/Area"
                field="city"
                options={cities}
                icon={Building2}
                isLoading={loading.cities}
                placeholder="Select City"
                fieldDisabled={!normalizedValue.district}
            />
        </div>
    );
};

export default LocationSelector;



================================================
FILE: frontend/src/components/masters/MasterFormModal.jsx
================================================
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Save, Loader2 } from 'lucide-react';
import Button from '@/components/ui/Button';
import Toggle from '@/components/ui/Toggle';
import UserSelectField from '@/components/masters/UserSelectField';

/**
 * Reusable modal for creating/editing master data records
 * @param {boolean} isOpen - Whether modal is open
 * @param {function} onClose - Close handler
 * @param {function} onSubmit - Submit handler (receives form data)
 * @param {string} title - Modal title
 * @param {array} fields - Field configuration array
 * @param {object} initialData - Initial form data for editing
 * @param {boolean} loading - Whether submission is in progress
 */
const MasterFormModal = ({
    isOpen,
    onClose,
    onSubmit,
    title,
    fields,
    initialData = null,
    loading = false
}) => {
    const [formData, setFormData] = useState({});
    const [errors, setErrors] = useState({});

    // Initialize form data when modal opens or initialData changes
    useEffect(() => {
        if (isOpen) {
            if (initialData) {
                setFormData(initialData);
            } else {
                // Set default values from field config
                const defaults = {};
                fields.forEach(field => {
                    defaults[field.name] = field.defaultValue ?? '';
                });
                setFormData(defaults);
            }
            setErrors({});
        }
    }, [isOpen, initialData, fields]);

    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && isOpen && !loading) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [isOpen, onClose, loading]);

    const handleChange = (name, value) => {
        setFormData(prev => ({ ...prev, [name]: value }));
        // Clear error when user types
        if (errors[name]) {
            setErrors(prev => ({ ...prev, [name]: null }));
        }
    };

    const validate = () => {
        const newErrors = {};
        fields.forEach(field => {
            if (field.required && !formData[field.name]) {
                newErrors[field.name] = `${field.label} is required`;
            }
            if (field.pattern && formData[field.name]) {
                if (!field.pattern.test(formData[field.name])) {
                    newErrors[field.name] = field.patternMessage || 'Invalid format';
                }
            }
        });
        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        if (validate()) {
            onSubmit(formData);
        }
    };

    const renderField = (field) => {
        const commonClasses = `w-full px-4 py-2.5 rounded-lg border bg-app-card text-app-heading ${errors[field.name]
            ? 'border-red-300 focus:border-red-500 focus:ring-red-100 dark:border-red-500/50'
            : 'border-app focus:border-app-focus focus:ring-primary-100'
            } focus:ring-2 outline-none transition-all text-sm`;

        switch (field.type) {
            case 'select':
                return (
                    <select
                        value={formData[field.name] || ''}
                        onChange={(e) => handleChange(field.name, e.target.value)}
                        className={commonClasses}
                        disabled={loading}
                    >
                        <option value="">Select {field.label}</option>
                        {field.options?.map(opt => (
                            <option key={opt.value} value={opt.value}>
                                {opt.label}
                            </option>
                        ))}
                    </select>
                );

            case 'textarea':
                return (
                    <textarea
                        value={formData[field.name] || ''}
                        onChange={(e) => handleChange(field.name, e.target.value)}
                        placeholder={field.placeholder}
                        rows={3}
                        className={commonClasses}
                        disabled={loading}
                    />
                );

            case 'number':
                return (
                    <input
                        type="number"
                        value={formData[field.name] || ''}
                        onChange={(e) => handleChange(field.name, e.target.value)}
                        placeholder={field.placeholder}
                        step={field.step || 1}
                        min={field.min}
                        max={field.max}
                        className={commonClasses}
                        disabled={loading}
                    />
                );

            case 'date':
                return (
                    <input
                        type="date"
                        value={formData[field.name] || ''}
                        onChange={(e) => handleChange(field.name, e.target.value)}
                        className={commonClasses}
                        disabled={loading}
                    />
                );

            case 'checkbox':
                return (
                    <div className="flex items-center gap-3 pt-2">
                        <Toggle
                            checked={formData[field.name] || false}
                            onChange={(val) => handleChange(field.name, val)}
                            size="sm"
                        />
                        <span className="text-sm font-medium text-slate-700 dark:text-neutral-300">
                            {field.checkboxLabel || field.label}
                        </span>
                    </div>
                );

            case 'user-select':
                return (
                    <UserSelectField
                        value={formData[field.name] || null}
                        onChange={(userId) => handleChange(field.name, userId)}
                        onUserSelect={(user) => {
                            // Auto-fill related fields if specified
                            if (user && field.autoFillFields) {
                                if (field.autoFillFields.includes('contact_email') && user.email) {
                                    handleChange('contact_email', user.email);
                                }
                                if (field.autoFillFields.includes('contact_phone') && user.phone_number) {
                                    handleChange('contact_phone', user.phone_number);
                                }
                                // Also fill legacy text field with user's full name
                                const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
                                if (field.name === 'hod_user') {
                                    handleChange('hod', fullName);
                                } else if (field.name === 'reporting_officer_user') {
                                    handleChange('reporting_officer', fullName);
                                }
                            }
                        }}
                        label=""
                        placeholder={field.placeholder}
                        disabled={loading}
                        error={errors[field.name]}
                    />
                );

            case 'hidden':
                return null;

            default: // text, email, etc.
                return (
                    <input
                        type={field.type || 'text'}
                        value={formData[field.name] || ''}
                        onChange={(e) => handleChange(field.name, e.target.value)}
                        placeholder={field.placeholder}
                        className={commonClasses}
                        disabled={loading}
                    />
                );
        }
    };

    const modalContent = (
        <AnimatePresence>
            {isOpen && (
                <>
                    {/* Backdrop */}
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        onClick={onClose}
                        className="fixed inset-0 bg-black/50 dark:bg-black/70 backdrop-blur-sm z-[9999]"
                    />

                    {/* Modal */}
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95, y: 20 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.95, y: 20 }}
                        className="fixed inset-0 z-[9999] flex items-center justify-center p-4"
                    >
                        <div className="bg-app-card rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden">
                            {/* Header */}
                            <div className="flex items-center justify-between px-6 py-4 border-b border-app-subtle">
                                <h2 className="text-lg font-semibold text-app-heading">{title}</h2>
                                <button
                                    onClick={onClose}
                                    className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                                    disabled={loading}
                                >
                                    <X size={20} className="text-slate-500 dark:text-neutral-400" />
                                </button>
                            </div>

                            {/* Form */}
                            <form onSubmit={handleSubmit} className="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                                <div className="space-y-4">
                                    {fields.map(field => (
                                        <div key={field.name}>
                                            {field.type !== 'checkbox' && (
                                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1.5">
                                                    {field.label}
                                                    {field.required && <span className="text-red-500 ml-1">*</span>}
                                                </label>
                                            )}
                                            {renderField(field)}
                                            {errors[field.name] && (
                                                <p className="mt-1 text-xs text-red-500">{errors[field.name]}</p>
                                            )}
                                            {field.helpText && (
                                                <p className="mt-1 text-xs text-slate-400 dark:text-neutral-500">{field.helpText}</p>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                {/* Actions */}
                                <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-app-subtle">
                                    <Button
                                        type="button"
                                        variant="outline"
                                        onClick={onClose}
                                        disabled={loading}
                                    >
                                        Cancel
                                    </Button>
                                    <Button type="submit" disabled={loading}>
                                        {loading ? (
                                            <>
                                                <Loader2 size={16} className="animate-spin mr-2" />
                                                Saving...
                                            </>
                                        ) : (
                                            <>
                                                <Save size={16} className="mr-2" />
                                                {initialData ? 'Update' : 'Create'}
                                            </>
                                        )}
                                    </Button>
                                </div>
                            </form>
                        </div>
                    </motion.div>
                </>
            )}
        </AnimatePresence>
    );

    return createPortal(modalContent, document.body);
};

export default MasterFormModal;




================================================
FILE: frontend/src/components/masters/UserSelectField.jsx
================================================
/**
 * UserSelectField Component
 * 
 * A searchable dropdown for selecting system users with:
 * - Search/filter by name or email
 * - User details display (name, email, role)
 * - "Invite New User" option at the bottom
 * - Auto-fill callback for email/phone when user selected
 * 
 * Used in Division (HOD), SubDivision (Reporting Officer), etc.
 */
import { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    Search, User, Mail, Phone, ChevronDown, Check, UserPlus,
    X, Loader2, Building2
} from 'lucide-react';
import api from '@/api/client';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';

const UserSelectField = ({
    value,
    onChange,
    onUserSelect,  // Callback with full user object for auto-fill
    label = 'Select User',
    placeholder = 'Search or select user...',
    required = false,
    disabled = false,
    error = '',
    filterRoles = null,  // Array of roles to filter, e.g., ['SPV_Official', 'PMNC_Team']
    excludeRoles = ['EPC_Contractor'],  // Exclude contractors by default
    showInviteOption = true,
}) => {
    const [isOpen, setIsOpen] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(false);
    const [selectedUser, setSelectedUser] = useState(null);
    const [inviteModalOpen, setInviteModalOpen] = useState(false);

    const containerRef = useRef(null);
    const inputRef = useRef(null);

    // Fetch users
    useEffect(() => {
        if (isOpen && users.length === 0) {
            fetchUsers();
        }
    }, [isOpen]);

    // Find selected user when value changes
    useEffect(() => {
        if (value && users.length > 0) {
            const found = users.find(u => u.id === value);
            setSelectedUser(found || null);
        } else if (!value) {
            setSelectedUser(null);
        }
    }, [value, users]);

    // Close on outside click
    useEffect(() => {
        const handleClickOutside = (e) => {
            if (containerRef.current && !containerRef.current.contains(e.target)) {
                setIsOpen(false);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const fetchUsers = async () => {
        setLoading(true);
        try {
            const response = await api.get('/users/');
            let data = Array.isArray(response.data) ? response.data : (response.data.results || []);

            // Filter by roles if specified
            if (filterRoles && filterRoles.length > 0) {
                data = data.filter(u => filterRoles.includes(u.role));
            }

            // Exclude roles (contractors by default)
            if (excludeRoles && excludeRoles.length > 0) {
                data = data.filter(u => !excludeRoles.includes(u.role));
            }

            // Only active users
            data = data.filter(u => u.account_status === 'ACTIVE');

            setUsers(data);
        } catch (err) {
            console.error('Failed to fetch users:', err);
            toast.error('Failed to load users');
        } finally {
            setLoading(false);
        }
    };

    const filteredUsers = users.filter(u => {
        const query = searchQuery.toLowerCase();
        return (
            (u.first_name || '').toLowerCase().includes(query) ||
            (u.last_name || '').toLowerCase().includes(query) ||
            (u.email || '').toLowerCase().includes(query) ||
            (u.username || '').toLowerCase().includes(query)
        );
    });

    const handleSelect = (user) => {
        setSelectedUser(user);
        onChange(user.id);
        if (onUserSelect) {
            onUserSelect(user);
        }
        setIsOpen(false);
        setSearchQuery('');
    };

    const handleClear = (e) => {
        e.stopPropagation();
        setSelectedUser(null);
        onChange(null);
        if (onUserSelect) {
            onUserSelect(null);
        }
    };

    const handleInviteSuccess = async () => {
        setInviteModalOpen(false);
        toast.success('Invite sent! User will appear after activation.');
        await fetchUsers();
    };

    const getRoleBadgeColor = (role) => {
        const colors = {
            'SPV_Official': 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
            'PMNC_Team': 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300',
            'Consultant_Design': 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-300',
            'Govt_Department': 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300',
            'NICDC_HQ': 'bg-pink-100 text-pink-700 dark:bg-pink-900/30 dark:text-pink-300',
        };
        return colors[role] || 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300';
    };

    return (
        <div className="relative" ref={containerRef}>
            {/* Label */}
            {label && (
                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                    {label} {required && <span className="text-red-500 dark:text-red-400">*</span>}
                </label>
            )}

            {/* Trigger Button */}
            <button
                type="button"
                disabled={disabled}
                onClick={() => setIsOpen(!isOpen)}
                className={`w-full flex items-center justify-between px-4 py-2.5 bg-white dark:bg-neutral-900 border rounded-xl text-left transition-all ${error ? 'border-red-300 dark:border-red-700 focus:ring-red-100 dark:focus:ring-red-900' :
                    isOpen ? 'border-primary-500 dark:border-primary-400 ring-2 ring-primary-100 dark:ring-primary-900' :
                        'border-slate-200 dark:border-neutral-700 hover:border-slate-300 dark:hover:border-neutral-600'
                    } ${disabled ? 'bg-slate-50 dark:bg-neutral-800 cursor-not-allowed' : 'cursor-pointer'}`}
            >
                {selectedUser ? (
                    <div className="flex items-center gap-3 flex-1 min-w-0">
                        <div className="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 dark:text-primary-400 font-medium flex-shrink-0">
                            {(selectedUser.first_name?.[0] || selectedUser.username?.[0] || '?').toUpperCase()}
                        </div>
                        <div className="min-w-0 flex-1">
                            <p className="font-medium text-slate-800 dark:text-white truncate">
                                {selectedUser.first_name} {selectedUser.last_name}
                            </p>
                            <p className="text-xs text-slate-500 dark:text-neutral-400 truncate">{selectedUser.email}</p>
                        </div>
                        {!disabled && (
                            <div
                                role="button"
                                tabIndex={0}
                                onClick={handleClear}
                                onKeyDown={(e) => (e.key === 'Enter' || e.key === ' ') && handleClear(e)}
                                className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-full text-slate-400 dark:text-neutral-500 hover:text-slate-600 dark:hover:text-neutral-300 cursor-pointer"
                            >
                                <X size={16} />
                            </div>
                        )}
                    </div>
                ) : (
                    <span className="text-slate-400 dark:text-neutral-500">{placeholder}</span>
                )}
                <ChevronDown
                    size={18}
                    className={`text-slate-400 dark:text-neutral-500 transition-transform ${isOpen ? 'rotate-180' : ''} ${selectedUser ? 'ml-2' : ''}`}
                />
            </button>

            {/* Error Message */}
            {error && <p className="text-sm text-red-500 dark:text-red-400 mt-1">{error}</p>}

            {/* Dropdown */}
            <AnimatePresence>
                {isOpen && (
                    <motion.div
                        initial={{ opacity: 0, y: -8 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: -8 }}
                        transition={{ duration: 0.15 }}
                        className="absolute z-50 w-full mt-1 bg-white dark:bg-neutral-800 border border-slate-200 dark:border-neutral-700 rounded-xl shadow-lg overflow-hidden"
                    >
                        {/* Search */}
                        <div className="p-2 border-b border-slate-100 dark:border-neutral-700">
                            <div className="relative">
                                <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-neutral-500" />
                                <input
                                    ref={inputRef}
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="Search by name or email..."
                                    className="w-full pl-9 pr-4 py-2 text-sm border border-slate-200 dark:border-neutral-600 bg-white dark:bg-neutral-900 text-slate-900 dark:text-white rounded-lg focus:outline-none focus:border-primary-500 dark:focus:border-primary-400 placeholder:text-slate-400 dark:placeholder:text-neutral-500"
                                    autoFocus
                                />
                            </div>
                        </div>

                        {/* User List */}
                        <div className="max-h-60 overflow-y-auto">
                            {loading ? (
                                <div className="py-8 text-center">
                                    <Loader2 className="animate-spin mx-auto text-primary-500 dark:text-primary-400 mb-2" size={24} />
                                    <p className="text-sm text-slate-500 dark:text-neutral-400">Loading users...</p>
                                </div>
                            ) : filteredUsers.length === 0 ? (
                                <div className="py-8 text-center">
                                    <User className="mx-auto text-slate-300 dark:text-neutral-600 mb-2" size={32} />
                                    <p className="text-sm text-slate-500 dark:text-neutral-400">
                                        {searchQuery ? 'No users match your search' : 'No users available'}
                                    </p>
                                </div>
                            ) : (
                                filteredUsers.map((user) => (
                                    <button
                                        key={user.id}
                                        type="button"
                                        onClick={() => handleSelect(user)}
                                        className={`w-full flex items-center gap-3 px-3 py-2.5 text-left hover:bg-slate-50 dark:hover:bg-neutral-700 transition-colors border-b border-slate-100 dark:border-neutral-700 last:border-0 ${selectedUser?.id === user.id ? 'bg-primary-50 dark:bg-primary-900/20' : ''
                                            }`}
                                    >
                                        <div className="w-9 h-9 rounded-full bg-slate-100 dark:bg-neutral-700 flex items-center justify-center text-slate-600 dark:text-neutral-300 font-medium flex-shrink-0">
                                            {(user.first_name?.[0] || user.username?.[0] || '?').toUpperCase()}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <p className="font-medium text-slate-800 dark:text-white truncate">
                                                {user.first_name} {user.last_name}
                                            </p>
                                            <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-neutral-400">
                                                <Mail size={12} />
                                                <span className="truncate">{user.email}</span>
                                            </div>
                                        </div>
                                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${getRoleBadgeColor(user.role)}`}>
                                            {user.role?.replace('_', ' ')}
                                        </span>
                                        {selectedUser?.id === user.id && (
                                            <Check size={18} className="text-primary-600 dark:text-primary-400 flex-shrink-0" />
                                        )}
                                    </button>
                                ))
                            )}
                        </div>

                        {/* Invite New User Option */}
                        {showInviteOption && (
                            <div className="border-t border-slate-100 dark:border-neutral-700 p-2">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setIsOpen(false);
                                        setInviteModalOpen(true);
                                    }}
                                    className="w-full flex items-center gap-2 px-3 py-2.5 text-primary-600 dark:text-primary-400 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-colors font-medium text-sm">
                                    <UserPlus size={18} />
                                    Invite New User
                                </button>
                            </div>
                        )}
                    </motion.div>
                )}
            </AnimatePresence>

            {/* Invite Modal */}
            {inviteModalOpen && (
                <InviteUserModal
                    isOpen={inviteModalOpen}
                    onClose={() => setInviteModalOpen(false)}
                    onSuccess={handleInviteSuccess}
                />
            )}
        </div>
    );
};

// Inline Invite Modal (same as UserManagement)
const InviteUserModal = ({ isOpen, onClose, onSuccess }) => {
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [formData, setFormData] = useState({
        email: '',
        first_name: '',
        last_name: '',
        role: 'PMNC_Team',
        department: '',
        phone_number: '',
    });
    const [errors, setErrors] = useState({});

    // ESC key handler
    useEffect(() => {
        const handleEsc = (e) => {
            if (e.key === 'Escape') onClose();
        };
        window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
    }, [onClose]);

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.email || !formData.first_name || !formData.last_name) {
            setErrors({
                email: !formData.email ? 'Email is required' : '',
                first_name: !formData.first_name ? 'First name is required' : '',
                last_name: !formData.last_name ? 'Last name is required' : '',
            });
            return;
        }

        setIsSubmitting(true);
        try {
            await api.post('/users/invite/', formData);
            toast.success(`Invite sent to ${formData.email}`);
            onSuccess();
        } catch (error) {
            console.error('Invite failed:', error);
            if (error.response?.data) {
                setErrors(error.response.data);
            }
            toast.error('Failed to send invite');
        } finally {
            setIsSubmitting(false);
        }
    };

    if (!isOpen) return null;

    return createPortal(
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
            <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                exit={{ opacity: 0, scale: 0.95 }}
                className="bg-white dark:bg-neutral-900 rounded-2xl shadow-xl w-full max-w-lg mx-4 border border-slate-100 dark:border-neutral-800"
            >
                <div className="p-6 border-b border-slate-200 dark:border-neutral-800 flex items-center justify-between">
                    <div>
                        <h2 className="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                            <UserPlus className="text-primary-600 dark:text-primary-400" size={24} />
                            Invite New User
                        </h2>
                        <p className="text-sm text-slate-500 dark:text-neutral-400 mt-1">Send an invite to a new team member</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg text-slate-400 dark:text-neutral-500 transition-colors">
                        <X size={20} />
                    </button>
                </div>

                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                            Email <span className="text-red-500 dark:text-red-400">*</span>
                        </label>
                        <input
                            type="email"
                            value={formData.email}
                            onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                            className={`w-full px-4 py-2 rounded-lg border bg-white dark:bg-neutral-800 dark:text-white ${errors.email ? 'border-red-300 dark:border-red-700' : 'border-slate-200 dark:border-neutral-700'} focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 placeholder:text-slate-400 dark:placeholder:text-neutral-500`}
                            placeholder="user@example.com"
                        />
                        {errors.email && <p className="text-sm text-red-500 dark:text-red-400 mt-1">{errors.email}</p>}
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                First Name <span className="text-red-500 dark:text-red-400">*</span>
                            </label>
                            <input
                                type="text"
                                value={formData.first_name}
                                onChange={(e) => setFormData(prev => ({ ...prev, first_name: e.target.value }))}
                                className={`w-full px-4 py-2 rounded-lg border bg-white dark:bg-neutral-800 dark:text-white ${errors.first_name ? 'border-red-300 dark:border-red-700' : 'border-slate-200 dark:border-neutral-700'} focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 placeholder:text-slate-400 dark:placeholder:text-neutral-500`}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                Last Name <span className="text-red-500 dark:text-red-400">*</span>
                            </label>
                            <input
                                type="text"
                                value={formData.last_name}
                                onChange={(e) => setFormData(prev => ({ ...prev, last_name: e.target.value }))}
                                className={`w-full px-4 py-2 rounded-lg border bg-white dark:bg-neutral-800 dark:text-white ${errors.last_name ? 'border-red-300 dark:border-red-700' : 'border-slate-200 dark:border-neutral-700'} focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 placeholder:text-slate-400 dark:placeholder:text-neutral-500`}
                            />
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                            Role <span className="text-red-500 dark:text-red-400">*</span>
                        </label>
                        <select
                            value={formData.role}
                            onChange={(e) => setFormData(prev => ({ ...prev, role: e.target.value }))}
                            className="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400"
                        >
                            <option value="SPV_Official">SPV Official</option>
                            <option value="PMNC_Team">PMNC Team</option>
                            <option value="Consultant_Design">Design Consultant</option>
                            <option value="Govt_Department">Government Department</option>
                            <option value="NICDC_HQ">NICDC HQ</option>
                        </select>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">Department</label>
                            <input
                                type="text"
                                value={formData.department}
                                onChange={(e) => setFormData(prev => ({ ...prev, department: e.target.value }))}
                                className="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 placeholder:text-slate-400 dark:placeholder:text-neutral-500"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">Phone</label>
                            <input
                                type="text"
                                value={formData.phone_number}
                                onChange={(e) => setFormData(prev => ({ ...prev, phone_number: e.target.value }))}
                                className="w-full px-4 py-2 rounded-lg border border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 placeholder:text-slate-400 dark:placeholder:text-neutral-500"
                            />
                        </div>
                    </div>

                    <div className="flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-neutral-800">
                        <Button variant="outline" type="button" onClick={onClose} className="dark:border-neutral-700 dark:text-neutral-300 dark:hover:bg-neutral-800">Cancel</Button>
                        <Button type="submit" disabled={isSubmitting}>
                            {isSubmitting ? <Loader2 className="animate-spin mr-2" size={18} /> : <Mail className="mr-2" size={18} />}
                            Send Invite
                        </Button>
                    </div>
                </form>
            </motion.div>
        </div>,
        document.body
    );
};

export default UserSelectField;



================================================
FILE: frontend/src/components/messaging/MessagingCenter.jsx
================================================
import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { MessageSquare, X, Send, Bell, AlertCircle, CheckCircle, Info } from 'lucide-react';
import { Card, CardContent } from '@/components/ui/Card';
import Button from '@/components/ui/Button';
import { useLanguage } from '@/contexts/LanguageContext';
import { useAuth } from '@/contexts/AuthContext';
import { toast } from 'sonner';

export const MessagingCenter = ({ isOpen, onClose, notifications }) => {
  const { t } = useLanguage();
  const { user } = useAuth();
  const [activeTab, setActiveTab] = useState('alerts');

  const systemAlerts = notifications.filter((n) => n.type === 'Error' || n.type === 'Warning' || n.type === 'Info');
  const teamMessages = notifications.filter((n) => n.type === 'Success');

  const getIcon = (type) => {
    switch (type) {
      case 'Error':
        return <AlertCircle className="text-red-600" size={18} />;
      case 'Warning':
        return <AlertCircle className="text-yellow-600" size={18} />;
      case 'Success':
        return <CheckCircle className="text-green-600" size={18} />;
      default:
        return <Info className="text-blue-600" size={18} />;
    }
  };

  const formatTimestamp = (timestamp) => {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-end p-4 pointer-events-none">
      <motion.div
        initial={{ opacity: 0, x: 400 }}
        animate={{ opacity: 1, x: 0 }}
        exit={{ opacity: 0, x: 400 }}
        className="bg-white rounded-2xl shadow-glass w-full max-w-md h-[80vh] flex flex-col overflow-hidden pointer-events-auto border border-slate-200/50"
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-slate-200 bg-slate-50">
          <div className="flex items-center gap-2">
            <Bell className="text-primary-600" size={20} />
            <h2 className="font-semibold text-slate-900">Messaging Center</h2>
          </div>
          <button
            onClick={onClose}
            className="p-2 rounded-lg hover:bg-slate-100 transition-colors"
            aria-label="Close"
          >
            <X size={20} className="text-slate-600" />
          </button>
        </div>

        {/* Tabs */}
        <div className="flex border-b border-slate-200">
          <button
            onClick={() => setActiveTab('alerts')}
            className={`flex-1 px-4 py-3 text-sm font-medium transition-colors ${
              activeTab === 'alerts'
                ? 'text-primary-600 border-b-2 border-primary-600'
                : 'text-slate-600 hover:text-slate-900'
            }`}
          >
            System Alerts ({systemAlerts.length})
          </button>
          <button
            onClick={() => setActiveTab('messages')}
            className={`flex-1 px-4 py-3 text-sm font-medium transition-colors ${
              activeTab === 'messages'
                ? 'text-primary-600 border-b-2 border-primary-600'
                : 'text-slate-600 hover:text-slate-900'
            }`}
          >
            Team Messages ({teamMessages.length})
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-4 space-y-3">
          <AnimatePresence mode="wait">
            {activeTab === 'alerts' ? (
              <motion.div
                key="alerts"
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                className="space-y-3"
              >
                {systemAlerts.length === 0 ? (
                  <div className="text-center py-12 text-slate-500">
                    <Bell size={48} className="mx-auto mb-4 text-slate-300" />
                    <p>No system alerts</p>
                  </div>
                ) : (
                  systemAlerts.map((alert) => (
                    <Card key={alert.id} className="border-slate-200">
                      <CardContent className="p-4">
                        <div className="flex items-start gap-3">
                          {getIcon(alert.type)}
                          <div className="flex-1">
                            <h4 className="font-semibold text-sm mb-1">{alert.title}</h4>
                            <p className="text-xs text-slate-600 mb-2">{alert.message}</p>
                            <p className="text-xs text-slate-400">{formatTimestamp(alert.timestamp)}</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  ))
                )}
              </motion.div>
            ) : (
              <motion.div
                key="messages"
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                className="space-y-3"
              >
                {teamMessages.length === 0 ? (
                  <div className="text-center py-12 text-slate-500">
                    <MessageSquare size={48} className="mx-auto mb-4 text-slate-300" />
                    <p>No team messages</p>
                  </div>
                ) : (
                  teamMessages.map((message) => (
                    <Card key={message.id} className="border-slate-200">
                      <CardContent className="p-4">
                        <div className="flex items-start gap-3">
                          <MessageSquare className="text-primary-600" size={18} />
                          <div className="flex-1">
                            <h4 className="font-semibold text-sm mb-1">{message.title}</h4>
                            <p className="text-xs text-slate-600 mb-2">{message.message}</p>
                            <p className="text-xs text-slate-400">{formatTimestamp(message.timestamp)}</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  ))
                )}
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </motion.div>
    </div>
  );
};









================================================
FILE: frontend/src/components/packages/CreatePackageModal.jsx
================================================
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Loader2, FolderOpen, Calendar, DollarSign, FileText, Upload, CheckCircle } from 'lucide-react';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';
import UserSelectField from '@/components/masters/UserSelectField';
import ContractorSearchDropdown from '@/components/ui/ContractorSearchDropdown';
import client from '@/api/client';

export const CreatePackageModal = ({ isOpen, onClose, projects, onSave, preSelectedProjectId }) => {
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [eligibleStaff, setEligibleStaff] = useState([]);
    const [selectedProject, setSelectedProject] = useState(null);
    const [agreementFile, setAgreementFile] = useState(null);
    const [fileError, setFileError] = useState('');

    const [formData, setFormData] = useState({
        projectId: '',
        name: '',
        description: '',
        contractor: null, // Now stores contractor object
        responsibleStaff: null, // Now stores user object
        agreementNo: '',
        agreementDate: '',
        contractValue: '',
        startDate: '',
        endDate: '',
        status: 'Pending',
    });

    const [touched, setTouched] = useState({});
    const [errors, setErrors] = useState({});

    useEffect(() => {
        if (isOpen) {
            if (preSelectedProjectId) {
                setFormData(prev => ({ ...prev, projectId: preSelectedProjectId }));
                const project = projects.find(p => p.id === preSelectedProjectId);
                setSelectedProject(project);
                if (project) {
                    fetchEligibleStaff(project.id);
                }
            } else {
                resetForm();
            }
            setErrors({});
            setTouched({}); // Reset touched state on open
            setFileError('');
            setAgreementFile(null);
        }
    }, [isOpen, preSelectedProjectId]);

    // ... (fetchEligibleStaff remains same)

    const resetForm = () => {
        setFormData({
            projectId: '',
            name: '',
            description: '',
            contractor: null,
            responsibleStaff: null,
            agreementNo: '',
            agreementDate: '',
            contractValue: '',
            startDate: '',
            endDate: '',
            status: 'Pending',
        });
        setSelectedProject(null);
        setEligibleStaff([]);
        setAgreementFile(null);
        setFileError('');
        setTouched({});
    };

    const handleBlur = (field) => {
        setTouched(prev => ({ ...prev, [field]: true }));
    };

    // ... (rest of useEffects) ...

    const validate = () => {
        const newErrors = {};
        if (!formData.projectId) newErrors.projectId = 'Please select a project';
        if (!formData.name.trim()) newErrors.name = 'Package Name is required';
        if (!formData.contractor) newErrors.contractor = 'Contractor is required';
        if (!formData.responsibleStaff) newErrors.responsibleStaff = 'Responsible Staff is required';
        if (!formData.agreementNo.trim()) newErrors.agreementNo = 'Agreement No. is required';
        if (!formData.agreementDate) newErrors.agreementDate = 'Agreement Date is required';
        if (!formData.contractValue) newErrors.contractValue = 'Contract Value is required';
        if (!formData.endDate) newErrors.endDate = 'Due Date of Completion is required';
        if (!agreementFile) newErrors.agreementDocument = 'Agreement document is required';

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        // Mark all fields as touched on submit
        setTouched({
            projectId: true,
            name: true,
            contractor: true,
            responsibleStaff: true,
            agreementNo: true,
            agreementDate: true,
            contractValue: true,
            endDate: true,
            agreementDocument: true
        });

        if (!validate()) {
            toast.error('Please fill all required fields');
            return;
        }

        setIsSubmitting(true);
        // ... (rest of submit logic) ...
    };

    // Helper to check if error should be shown
    const showError = (field) => {
        return touched[field] && errors[field];
    };

    // ... (render logic) ...

    if (!isOpen) return null;

    return createPortal(
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 dark:bg-black/60 backdrop-blur-sm p-4"
                onClick={onClose}
            >
                <motion.div
                    initial={{ opacity: 0, scale: 0.95, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95, y: 20 }}
                    className="w-full max-w-3xl bg-white dark:bg-neutral-900 rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]"
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header */}
                    <div className="p-6 border-b border-slate-100 dark:border-neutral-700 flex justify-between items-center bg-gradient-to-r from-primary-50 to-white dark:from-neutral-900 dark:to-neutral-900">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Create Work Package</h2>
                            <p className="text-sm text-slate-500 dark:text-neutral-400">Enter contract details and upload agreement</p>
                        </div>
                        <button type="button" onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-full transition-colors">
                            <X size={24} className="text-slate-500 dark:text-neutral-400" />
                        </button>
                    </div>

                    {/* Form Content */}
                    <form onSubmit={(e) => e.preventDefault()} className="flex-1 overflow-y-auto p-6 space-y-6">

                        {/* Project Selection */}
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                Select Project <span className="text-red-500 dark:text-red-400">*</span>
                            </label>
                            <div className="relative">
                                <select
                                    value={formData.projectId}
                                    onChange={(e) => {
                                        setFormData({ ...formData, projectId: e.target.value });
                                        if (e.target.value) setTouched(prev => ({ ...prev, projectId: true }));
                                    }}
                                    onBlur={() => handleBlur('projectId')}
                                    disabled={!!preSelectedProjectId}
                                    className={`w-full p-2 pl-10 border rounded-lg appearance-none bg-white dark:bg-neutral-900 dark:text-white ${showError('projectId') ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'
                                        } ${!!preSelectedProjectId ? 'bg-slate-50 dark:bg-neutral-800' : ''}`}
                                >
                                    <option value="">-- Select Project --</option>
                                    {projects.map((p) => (
                                        <option key={p.id} value={p.id}>{p.name}</option>
                                    ))}
                                </select>
                                <FolderOpen className="absolute left-3 top-2.5 text-slate-400 dark:text-neutral-500" size={18} />
                            </div>
                            {showError('projectId') && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.projectId}</p>}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Package Name */}
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                    Package Name <span className="text-red-500 dark:text-red-400">*</span>
                                </label>
                                <input
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    onBlur={() => handleBlur('name')}
                                    className={`w-full p-2 border rounded-lg bg-white dark:bg-neutral-900 dark:text-white ${showError('name') ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'}`}
                                    placeholder="E.g. Civil Works - Phase 1"
                                />
                                {showError('name') && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.name}</p>}
                            </div>

                            {/* Contractor Dropdown */}
                            <div>
                                <ContractorSearchDropdown
                                    value={formData.contractor?.id}
                                    onSelect={(contractor) => {
                                        setFormData({ ...formData, contractor });
                                        setTouched(prev => ({ ...prev, contractor: true }));
                                    }}
                                    label="Contractor"
                                    required
                                    error={showError('contractor')}
                                />
                            </div>

                            {/* Responsible Staff Dropdown */}
                            <div>
                                <UserSelectField
                                    value={formData.responsibleStaff?.id}
                                    onChange={(userId) => {
                                        const user = eligibleStaff.find(s => s.id === userId);
                                        setFormData({ ...formData, responsibleStaff: user || { id: userId } });
                                        setTouched(prev => ({ ...prev, responsibleStaff: true }));
                                    }}
                                    label="Responsible Staff"
                                    required
                                    placeholder="Select or invite responsible staff"
                                    error={showError('responsibleStaff')}
                                    showInviteOption={true}
                                />
                            </div>

                            {/* Agreement Number */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                    Agreement No. <span className="text-red-500 dark:text-red-400">*</span>
                                </label>
                                <input
                                    value={formData.agreementNo}
                                    onChange={(e) => setFormData({ ...formData, agreementNo: e.target.value })}
                                    onBlur={() => handleBlur('agreementNo')}
                                    className={`w-full p-2 border rounded-lg bg-white dark:bg-neutral-900 dark:text-white ${showError('agreementNo') ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'}`}
                                    placeholder="Agreement Number"
                                />
                                {showError('agreementNo') && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.agreementNo}</p>}
                            </div>

                            {/* Agreement Date */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                    Agreement Date <span className="text-red-500 dark:text-red-400">*</span>
                                </label>
                                <div className="relative">
                                    <input
                                        type="date"
                                        value={formData.agreementDate}
                                        onChange={(e) => setFormData({ ...formData, agreementDate: e.target.value })}
                                        onBlur={() => handleBlur('agreementDate')}
                                        className={`w-full p-2 pl-10 border rounded-lg bg-white dark:bg-neutral-900 dark:text-white ${showError('agreementDate') ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'}`}
                                    />
                                    <Calendar className="absolute left-3 top-2.5 text-slate-400 dark:text-neutral-500" size={18} />
                                </div>
                                {showError('agreementDate') && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.agreementDate}</p>}
                            </div>

                            {/* Agreement Document Upload */}
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                    Agreement Document <span className="text-red-500 dark:text-red-400">*</span>
                                </label>
                                <div className={`relative border-2 border-dashed rounded-lg p-4 transition-colors ${agreementFile ? 'border-green-500 bg-green-50 dark:bg-green-900/10' : showError('agreementDocument') ? 'border-red-500 bg-red-50 dark:bg-red-900/10' : 'border-slate-200 dark:border-neutral-700 hover:border-primary-400'
                                    }`}>
                                    <input
                                        type="file"
                                        onChange={(e) => {
                                            handleFileChange(e);
                                            setTouched(prev => ({ ...prev, agreementDocument: true }));
                                        }}
                                        accept=".pdf,.doc,.docx"
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    />
                                    <div className="text-center">
                                        {agreementFile ? (
                                            <>
                                                <CheckCircle className="mx-auto text-green-600 dark:text-green-400 mb-2" size={32} />
                                                <p className="text-sm font-medium text-slate-900 dark:text-white">{agreementFile.name}</p>
                                                <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">
                                                    {(agreementFile.size / 1024 / 1024).toFixed(2)} MB
                                                </p>
                                            </>
                                        ) : (
                                            <>
                                                <Upload className="mx-auto text-slate-400 dark:text-neutral-500 mb-2" size={32} />
                                                <p className="text-sm text-slate-600 dark:text-neutral-300">
                                                    Click or drag file to upload
                                                </p>
                                                <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">
                                                    PDF, DOC, or DOCX (Max 10MB)
                                                </p>
                                            </>
                                        )}
                                    </div>
                                </div>
                                {(showError('agreementDocument') || fileError) && (
                                    <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.agreementDocument || fileError}</p>
                                )}
                            </div>

                            {/* Contract Value */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                    Contract Value (â‚¹) <span className="text-red-500 dark:text-red-400">*</span>
                                </label>
                                <div className="relative">
                                    <input
                                        type="number"
                                        value={formData.contractValue}
                                        onChange={(e) => setFormData({ ...formData, contractValue: e.target.value })}
                                        onBlur={() => handleBlur('contractValue')}
                                        className={`w-full p-2 pl-10 border rounded-lg bg-white dark:bg-neutral-900 dark:text-white ${showError('contractValue') ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'}`}
                                        placeholder="0.00"
                                    />
                                    <DollarSign className="absolute left-3 top-2.5 text-slate-400 dark:text-neutral-500" size={18} />
                                </div>
                                {showError('contractValue') && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.contractValue}</p>}
                            </div>

                            {/* Due Date of Completion */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                    Due Date of Completion <span className="text-red-500 dark:text-red-400">*</span>
                                </label>
                                <div className="relative">
                                    <input
                                        type="date"
                                        value={formData.endDate}
                                        onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                                        onBlur={() => handleBlur('endDate')}
                                        className={`w-full p-2 pl-10 border rounded-lg bg-white dark:bg-neutral-900 dark:text-white ${showError('endDate') ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'}`}
                                    />
                                    <Calendar className="absolute left-3 top-2.5 text-slate-400 dark:text-neutral-500" size={18} />
                                </div>
                                {showError('endDate') && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.endDate}</p>}
                            </div>
                        </div>
                    </form>

                    {/* Footer */}
                    <div className="p-6 border-t border-slate-100 dark:border-neutral-700 flex justify-end gap-3 bg-slate-50 dark:bg-neutral-800/50">
                        <Button
                            variant="secondary"
                            onClick={onClose}
                            disabled={isSubmitting}
                        >
                            Cancel
                        </Button>
                        <Button
                            onClick={handleSubmit}
                            disabled={isSubmitting}
                            className="min-w-[120px]"
                        >
                            {isSubmitting ? (
                                <>
                                    <Loader2 className="animate-spin mr-2" size={18} />
                                    Creating...
                                </>
                            ) : (
                                'Create Package'
                            )}
                        </Button>
                    </div>
                </motion.div>
            </motion.div>
        </AnimatePresence>,
        document.body
    );
};

export default CreatePackageModal;



================================================
FILE: frontend/src/components/procurement/AddContractorModal.jsx
================================================
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Save, Building2, FileText, MapPin, Phone, Mail, AlertCircle, CheckCircle2, Briefcase, Package, Plus } from 'lucide-react';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';
import { CreateProjectModal } from '@/components/projects/CreateProjectModal';
import { CreatePackageModal } from '@/components/packages/CreatePackageModal';

export const AddContractorModal = ({
    isOpen,
    onClose,
    onSave,
    projects = [],
    packages = [],
    onAddProject,
    onAddPackage,
    contractor = null
}) => {
    const isEditing = !!contractor;

    // Normalize projects and packages to always be arrays
    // Handle both paginated ({results: [...]}) and non-paginated ([...]) formats
    const normalizedProjects = Array.isArray(projects)
        ? projects
        : (projects?.results || projects?.data?.results || []);
    const normalizedPackages = Array.isArray(packages)
        ? packages
        : (packages?.results || packages?.data?.results || []);

    const [formData, setFormData] = useState({
        panNo: '',
        gstinNo: '',
        contractorName: '',
        buildingNumber: '',
        contractorStreet: '',
        area: '',
        city: '',
        state: '',
        country: '',
        zipCode: '',
        email: '',
        mobile: '',
        projectId: '',
        packageId: ''
    });

    const [errors, setErrors] = useState({});
    const [isSubmitting, setIsSubmitting] = useState(false);

    // Sub-modal states
    const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
    const [isPackageModalOpen, setIsPackageModalOpen] = useState(false);

    // Filter packages based on selected project
    const projectPackages = formData.projectId
        ? normalizedPackages.filter(pkg => pkg.projectId === formData.projectId)
        : [];

    // Reset form when modal opens
    useEffect(() => {
        if (isOpen) {
            if (contractor) {
                // Editing mode - pre-fill data
                // Parse address components if possible - wait, we stored them individually in state previously?
                // The formatting was done on submit. But wait, did we store individual fields in the mock?
                // Let's check how we stored it. In handleSubmit we used ...formData.
                // So the individual fields should assume to be in the contractor object if we structure our mock correctly.
                // If the mock data structure is flat with all fields, this is easy.
                // If it only has 'address', then we have a problem reverse engineering the address.
                // Assuming we expanded the mock to store these fields or we just refill what we can.
                // Since this is a "PMIS", preserving data fields is key. 
                // In `addContractor` inside modal we did `...formData`. So all fields ARE saved. Great.

                // We need to handle assignedProjectIds/assignedPackageIds for pre-selection
                const currentProjectId = contractor.assignedProjectIds?.[0] || '';
                const currentPackageId = contractor.assignedPackageIds?.[0] || '';

                setFormData({
                    panNo: contractor.panNo || '',
                    gstinNo: contractor.gstinNo || '',
                    contractorName: contractor.contractorName || '',
                    buildingNumber: contractor.buildingNumber || '',
                    contractorStreet: contractor.contractorStreet || '',
                    area: contractor.area || '',
                    city: contractor.city || '',
                    state: contractor.state || '',
                    country: contractor.country || '',
                    zipCode: contractor.zipCode || '',
                    email: contractor.email || '',
                    mobile: contractor.mobile || '',
                    projectId: currentProjectId,
                    packageId: currentPackageId
                });
            } else {
                // Add mode - reset
                setFormData({
                    panNo: '',
                    gstinNo: '',
                    contractorName: '',
                    buildingNumber: '',
                    contractorStreet: '',
                    area: '',
                    city: '',
                    state: '',
                    country: '',
                    zipCode: '',
                    email: '',
                    mobile: '',
                    projectId: '',
                    packageId: ''
                });
            }
            setErrors({});
        }
    }, [isOpen, contractor]);

    // Handle Escape key press (only if sub-modals are not open)
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && !isProjectModalOpen && !isPackageModalOpen) {
                onClose();
            }
        };

        if (isOpen) {
            window.addEventListener('keydown', handleEscape);
        }

        return () => {
            window.removeEventListener('keydown', handleEscape);
        };
    }, [isOpen, onClose, isProjectModalOpen, isPackageModalOpen]);

    if (!isOpen) return null;

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => {
            const updates = { ...prev, [name]: value };
            // Clear package if project changes
            if (name === 'projectId') {
                updates.packageId = '';
            }
            return updates;
        });

        // Clear error when user types
        if (errors[name]) {
            setErrors(prev => ({ ...prev, [name]: '' }));
        }
    };

    const handleProjectCreated = async (newProject) => {
        try {
            const created = await onAddProject(newProject);
            setFormData(prev => ({ ...prev, projectId: created.id }));
            setIsProjectModalOpen(false);
            toast.success("Project created and selected");
        } catch (error) {
            console.error("Failed to create project:", error);
            toast.error("Failed to create project");
        }
    };

    const handlePackageCreated = async (newPackage) => {
        try {
            // Ensure the package is linked to the currently selected project
            const packageWithProject = { ...newPackage, projectId: formData.projectId };
            const created = await onAddPackage(packageWithProject);
            setFormData(prev => ({ ...prev, packageId: created.id }));
            setIsPackageModalOpen(false);
            toast.success("Package created and selected");
        } catch (error) {
            console.error("Failed to create package:", error);
            toast.error("Failed to create package");
        }
    };

    const validate = () => {
        const newErrors = {};
        if (!formData.contractorName.trim()) newErrors.contractorName = 'Contractor Name is required';
        if (!formData.panNo.trim()) newErrors.panNo = 'PAN No is required';
        if (!formData.gstinNo.trim()) newErrors.gstinNo = 'GSTIN No is required';
        if (!formData.email.trim()) {
            newErrors.email = 'Email is required';
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
            newErrors.email = 'Invalid email format';
        }
        if (!formData.mobile.trim()) {
            newErrors.mobile = 'Mobile is required';
        } else if (!/^\d{10}$/.test(formData.mobile.replace(/\D/g, ''))) {
            newErrors.mobile = 'Invalid mobile number';
        }

        // Project/Package assignment is optional correctly? 
        // Request said: "add an option to select... if neither... give an option to create"
        // It didn't explicitly say it's mandatory, but usually assignment is key.
        // I will match existing behavior and keep it optional unless specified otherwise.

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validate()) {
            toast.error('Please fix the errors in the form');
            return;
        }

        setIsSubmitting(true);
        try {
            // Format address for display consistency
            const fullAddress = `${formData.buildingNumber}, ${formData.contractorStreet}, ${formData.area}, ${formData.city}, ${formData.state}, ${formData.country} - ${formData.zipCode}`;

            await onSave({
                ...formData,
                address: fullAddress,
                status: 'Active',
                projects: formData.projectId ? 1 : 0, // Simple count for now
                assignedProjectIds: formData.projectId ? [formData.projectId] : [],
                assignedPackageIds: formData.packageId ? [formData.packageId] : []
            });

            toast.success('Contractor added successfully');
            onClose();
        } catch (error) {
            console.error('Error adding contractor:', error);
            toast.error('Failed to add contractor');
        } finally {
            setIsSubmitting(false);
        }
    };

    const modalContent = (
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-slate-900/50 dark:bg-black/70 backdrop-blur-sm"
            >
                <motion.div
                    initial={{ opacity: 0, scale: 0.95, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95, y: 20 }}
                    className="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden"
                    onClick={e => e.stopPropagation()}
                >
                    <div className="flex-none bg-white dark:bg-neutral-900 border-b border-slate-200 dark:border-neutral-700 px-6 py-4 flex items-center justify-between z-10">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-primary-50 dark:bg-primary-900/30 text-white rounded-lg">
                                <Building2 size={24} className="text-primary-600 dark:text-primary-400" />
                            </div>
                            <div>
                                <h2 className="text-xl font-bold text-slate-900 dark:text-white">{isEditing ? 'Edit Contractor' : 'Add New Contractor'}</h2>
                                <p className="text-sm text-slate-500 dark:text-neutral-400">{isEditing ? 'Update contractor details' : 'Enter contractor details for procurement'}</p>
                            </div>
                        </div>
                        <button
                            onClick={onClose}
                            className="p-2 text-slate-400 dark:text-neutral-500 hover:text-slate-600 dark:hover:text-neutral-300 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                        >
                            <X size={20} />
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-slate-200 scrollbar-track-transparent">
                        <form onSubmit={handleSubmit} className="space-y-6">

                            {/* Section 1: Identification */}
                            <div className="space-y-4">
                                <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-neutral-700 pb-2 mb-4 flex items-center gap-2">
                                    <FileText size={16} /> Legal Identification
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <InputField
                                        label="PAN No"
                                        name="panNo"
                                        value={formData.panNo}
                                        onChange={handleChange}
                                        error={errors.panNo}
                                        placeholder="Ex: ABCDE1234F"
                                        required
                                    />
                                    <InputField
                                        label="GSTIN No"
                                        name="gstinNo"
                                        value={formData.gstinNo}
                                        onChange={handleChange}
                                        error={errors.gstinNo}
                                        placeholder="Ex: 29ABCDE1234F1Z5"
                                        required
                                    />
                                </div>
                            </div>

                            {/* Section 2: Basic Info */}
                            <div className="space-y-4">
                                <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-neutral-700 pb-2 mb-4 flex items-center gap-2">
                                    <Building2 size={16} /> Company Details
                                </h3>
                                <InputField
                                    label="Contractor Name"
                                    name="contractorName"
                                    value={formData.contractorName}
                                    onChange={handleChange}
                                    error={errors.contractorName}
                                    placeholder="Full legal name of the entity"
                                    required
                                />
                            </div>

                            {/* Section: Project & Package Assignment */}
                            <div className="space-y-4 bg-slate-50 dark:bg-neutral-800 p-4 rounded-xl border border-slate-200 dark:border-neutral-700">
                                <h3 className="text-sm font-semibold text-slate-900 dark:text-white flex items-center gap-2">
                                    <Briefcase size={16} /> Project & Package Assignment
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Project Selector */}
                                    <div className="space-y-2">
                                        <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300">Assign to Project</label>
                                        <div className="flex gap-2">
                                            <select
                                                name="projectId"
                                                value={formData.projectId}
                                                onChange={handleChange}
                                                className="flex-1 w-full px-3 py-2 bg-white dark:bg-neutral-900 border border-slate-200 dark:border-neutral-700 rounded-lg text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-100 focus:border-primary-500"
                                            >
                                                <option value="">Select Project...</option>
                                                {normalizedProjects.map(p => (
                                                    <option key={p.id} value={p.id}>{p.name}</option>
                                                ))}
                                            </select>
                                            <Button
                                                type="button"
                                                variant="outline"
                                                onClick={() => setIsProjectModalOpen(true)}
                                                className="whitespace-nowrap"
                                                title="Create New Project"
                                            >
                                                <Plus size={16} /> New
                                            </Button>
                                        </div>
                                    </div>

                                    {/* Package Selector (Disabled until Project selected) */}
                                    <div className="space-y-2">
                                        <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300">Assign to Package</label>
                                        <div className="flex gap-2">
                                            <select
                                                name="packageId"
                                                value={formData.packageId}
                                                onChange={handleChange}
                                                disabled={!formData.projectId}
                                                className="flex-1 w-full px-3 py-2 bg-white dark:bg-neutral-900 border border-slate-200 dark:border-neutral-700 rounded-lg text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-100 focus:border-primary-500 disabled:bg-slate-100 dark:disabled:bg-neutral-800 disabled:text-slate-400 dark:disabled:text-neutral-500"
                                            >
                                                <option value="">Select Package...</option>
                                                {projectPackages.map(pkg => (
                                                    <option key={pkg.id} value={pkg.id}>{pkg.name}</option>
                                                ))}
                                            </select>
                                            <Button
                                                type="button"
                                                variant="outline"
                                                onClick={() => setIsPackageModalOpen(true)}
                                                disabled={!formData.projectId}
                                                className="whitespace-nowrap"
                                                title="Create New Package"
                                            >
                                                <Plus size={16} /> New
                                            </Button>
                                        </div>
                                        {!formData.projectId && (
                                            <p className="text-xs text-slate-500">Select a project first</p>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Section 3: Address */}
                            <div className="space-y-4">
                                <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-neutral-700 pb-2 mb-4 flex items-center gap-2">
                                    <MapPin size={16} /> Address Details
                                </h3>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <InputField
                                        label="Building Number"
                                        name="buildingNumber"
                                        value={formData.buildingNumber}
                                        onChange={handleChange}
                                        placeholder="Ex: Building 4A"
                                    />
                                    <InputField
                                        label="Contractor Street"
                                        name="contractorStreet"
                                        value={formData.contractorStreet}
                                        onChange={handleChange}
                                        placeholder="Ex: MG Road"
                                    />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <InputField
                                        label="Area"
                                        name="area"
                                        value={formData.area}
                                        onChange={handleChange}
                                        placeholder="Ex: Indiranagar"
                                    />
                                    <InputField
                                        label="City"
                                        name="city"
                                        value={formData.city}
                                        onChange={handleChange}
                                        placeholder="Ex: Bengaluru"
                                    />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <InputField
                                        label="State"
                                        name="state"
                                        value={formData.state}
                                        onChange={handleChange}
                                        placeholder="Ex: Karnataka"
                                    />
                                    <InputField
                                        label="Country"
                                        name="country"
                                        value={formData.country}
                                        onChange={handleChange}
                                        placeholder="Ex: India"
                                    />
                                    <InputField
                                        label="Zip Code"
                                        name="zipCode"
                                        value={formData.zipCode}
                                        onChange={handleChange}
                                        placeholder="Ex: 560038"
                                    />
                                </div>
                            </div>

                            {/* Section 4: Contact */}
                            <div className="space-y-4">
                                <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-200 dark:border-neutral-700 pb-2 mb-4 flex items-center gap-2">
                                    <Phone size={16} /> Contact Information
                                </h3>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <InputField
                                        label="Email"
                                        name="email"
                                        type="email"
                                        value={formData.email}
                                        onChange={handleChange}
                                        error={errors.email}
                                        icon={Mail}
                                        placeholder="contact@company.com"
                                        required
                                    />
                                    <InputField
                                        label="Mobile"
                                        name="mobile"
                                        value={formData.mobile}
                                        onChange={handleChange}
                                        error={errors.mobile}
                                        icon={Phone}
                                        placeholder="+91 XXXXX XXXXX"
                                        required
                                    />
                                </div>
                            </div>

                            {/* Actions */}
                            <div className="flex items-center justify-end gap-3 pt-6 border-t border-slate-200 dark:border-neutral-700">
                                <Button
                                    type="button"
                                    variant="outline"
                                    onClick={onClose}
                                    disabled={isSubmitting}
                                >
                                    Cancel
                                </Button>
                                <Button
                                    type="submit"
                                    className="bg-primary-950 dark:bg-white hover:bg-primary-900 dark:hover:bg-gray-100 text-white dark:text-primary-950 min-w-[120px]"
                                    disabled={isSubmitting}
                                >
                                    {isSubmitting ? (
                                        <span className="flex items-center gap-2">
                                            <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                                            {isEditing ? 'Updating...' : 'Saving...'}
                                        </span>
                                    ) : (
                                        <span className="flex items-center gap-2">
                                            <CheckCircle2 size={18} />
                                            {isEditing ? 'Update Contractor' : 'Save Contractor'}
                                        </span>
                                    )}
                                </Button>
                            </div>
                        </form>
                    </div>
                </motion.div>
            </motion.div>

            {/* Sub-modals for creation */}
            <CreateProjectModal
                isOpen={isProjectModalOpen}
                onClose={() => setIsProjectModalOpen(false)}
                onSave={handleProjectCreated}
            />
            {/* CreatePackageModal needs the pre-selected project ID */}
            <CreatePackageModal
                isOpen={isPackageModalOpen}
                onClose={() => setIsPackageModalOpen(false)}
                onSave={handlePackageCreated}
                preSelectedProjectId={formData.projectId}
            />

        </AnimatePresence>
    );

    return createPortal(modalContent, document.body);
};

const InputField = ({ label, name, error, required, icon: Icon, className = "", ...props }) => (
    <div className={className}>
        <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1.5">
            {label} {required && <span className="text-red-500">*</span>}
        </label>
        <div className="relative">
            <input
                name={name}
                className={`w-full px-3 py-2 ${Icon ? 'pl-9' : ''} bg-white dark:bg-neutral-900 border rounded-lg text-sm text-slate-900 dark:text-white transition-all outline-none focus:ring-2 disabled:bg-slate-50 dark:disabled:bg-neutral-800 disabled:text-slate-500 dark:disabled:text-neutral-500 ${error
                    ? 'border-red-300 focus:border-red-500 focus:ring-red-100 dark:border-red-500/50'
                    : 'border-slate-200 dark:border-neutral-700 focus:border-primary-500 focus:ring-primary-100 dark:focus:ring-primary-900/30'
                    }`}
                {...props}
            />
            {Icon && <Icon className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />}
        </div>
        {error && (
            <div className="flex items-center gap-1 mt-1 text-xs text-red-500">
                <AlertCircle size={12} />
                <span>{error}</span>
            </div>
        )}
    </div>
);



================================================
FILE: frontend/src/components/procurement/ContractorDetailModal.jsx
================================================
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Building2, MapPin, Phone, Mail, FileText } from 'lucide-react';
import Button from '@/components/ui/Button';
import Switch from '@/components/ui/Switch';
import { useModalClose } from '@/hooks/useModalClose';
import { useAuth } from '@/contexts/AuthContext';
import { toast } from 'sonner';

export const ContractorDetailModal = ({ isOpen, onClose, contractor, onUpdate }) => {
    useModalClose(isOpen, onClose);
    const { user } = useAuth();

    // Check if user is Admin (SPV_Official has accessLevel: Admin)
    const isAdmin = user?.role === 'SPV_Official';

    if (!isOpen || !contractor) return null;

    const handleStatusChange = async (newStatus) => {
        if (!isAdmin) return;

        try {
            await onUpdate(contractor.id, { status: newStatus ? 'Active' : 'Inactive' });
            toast.success(`Contractor marked as ${newStatus ? 'Active' : 'Inactive'}`);
        } catch (error) {
            toast.error('Failed to update status');
        }
    };

    const isActive = contractor.status === 'Active' || !contractor.status; // Default to Active if undefined

    return createPortal(
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
            >
                <motion.div
                    initial={{ opacity: 0, scale: 0.95, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95, y: 20 }}
                    className="bg-white dark:bg-neutral-900 rounded-2xl shadow-xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]"
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header */}
                    <div className="flex items-center justify-between p-6 border-b border-slate-100 dark:border-neutral-800 bg-slate-50/50 dark:bg-neutral-800/50">
                        <div className="flex items-center gap-4">
                            <div className="p-3 bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400 rounded-xl">
                                <Building2 size={28} />
                            </div>
                            <div>
                                <div className="flex items-center gap-3">
                                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{contractor.contractorName}</h2>
                                    {isAdmin && (
                                        <div className="flex items-center gap-2 px-3 py-1 bg-slate-100 dark:bg-neutral-800 rounded-full border border-slate-200 dark:border-neutral-700">
                                            <span className={`text-xs font-semibold uppercase ${isActive ? 'text-green-600 dark:text-green-400' : 'text-slate-500 dark:text-neutral-500'}`}>
                                                {isActive ? 'Active' : 'Inactive'}
                                            </span>
                                            <Switch
                                                checked={isActive}
                                                onChange={handleStatusChange}
                                                className={isActive ? 'bg-green-500' : 'bg-slate-300'}
                                            />
                                        </div>
                                    )}
                                </div>
                                <div className="flex items-center gap-2 mt-1">
                                    {!isAdmin && (
                                        <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${isActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                                            }`}>
                                            {contractor.status || 'Active'}
                                        </span>
                                    )}
                                    <span className="text-slate-400 dark:text-neutral-500">â€¢</span>
                                    <span className="text-sm text-slate-500 dark:text-neutral-400">{contractor.projects || 0} Active Projects</span>
                                </div>
                            </div>
                        </div>
                        <button
                            onClick={onClose}
                            className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-full transition-colors text-slate-400 dark:text-neutral-500 hover:text-slate-600 dark:hover:text-neutral-300"
                        >
                            <X size={24} />
                        </button>
                    </div>

                    {/* Content */}
                    <div className="p-8 overflow-y-auto space-y-8">

                        {/* 1. Legal Identification */}
                        <section>
                            <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-100 dark:border-neutral-800 pb-2 mb-4 flex items-center gap-2 uppercase tracking-wide">
                                <FileText size={16} className="text-slate-400 dark:text-neutral-500" /> Identity & Taxes
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-slate-50 dark:bg-neutral-800 p-4 rounded-lg border border-slate-100 dark:border-neutral-700">
                                    <span className="text-xs text-slate-500 dark:text-neutral-400 uppercase font-bold block mb-1">PAN Number</span>
                                    <span className="font-mono text-slate-700 dark:text-neutral-300 font-medium text-lg tracking-wide">{contractor.panNo || 'N/A'}</span>
                                </div>
                                <div className="bg-slate-50 dark:bg-neutral-800 p-4 rounded-lg border border-slate-100 dark:border-neutral-700">
                                    <span className="text-xs text-slate-500 dark:text-neutral-400 uppercase font-bold block mb-1">GSTIN</span>
                                    <span className="font-mono text-slate-700 dark:text-neutral-300 font-medium text-lg tracking-wide">{contractor.gstinNo || 'N/A'}</span>
                                </div>
                            </div>
                        </section>

                        {/* 2. Contact Information */}
                        <section>
                            <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-100 dark:border-neutral-800 pb-2 mb-4 flex items-center gap-2 uppercase tracking-wide">
                                <Phone size={16} className="text-slate-400 dark:text-neutral-500" /> Contact Details
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="flex items-center gap-3 p-2">
                                    <div className="p-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-lg">
                                        <Mail size={18} />
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 font-medium">Email Address</p>
                                        <p className="text-slate-900 dark:text-white">{contractor.email || 'N/A'} (Login ID)</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3 p-2">
                                    <div className="p-2 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 rounded-lg">
                                        <Phone size={18} />
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 font-medium">Mobile Number</p>
                                        <p className="text-slate-900 dark:text-white">{contractor.mobile || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        {/* 3. Address */}
                        <section>
                            <h3 className="text-sm font-semibold text-slate-900 dark:text-white border-b border-slate-100 dark:border-neutral-800 pb-2 mb-4 flex items-center gap-2 uppercase tracking-wide">
                                <MapPin size={16} className="text-slate-400 dark:text-neutral-500" /> Registered Address
                            </h3>
                            <div className="bg-slate-50 dark:bg-neutral-800 p-5 rounded-xl border border-slate-100 dark:border-neutral-700 text-slate-700 dark:text-neutral-300 leading-relaxed">
                                {contractor.address ? (
                                    <p>{contractor.address}</p>
                                ) : (
                                    <div className="space-y-1">
                                        <p>{contractor.buildingNumber} {contractor.contractorStreet}</p>
                                        <p>{contractor.area}</p>
                                        <p>{contractor.city}, {contractor.state} - {contractor.zipCode}</p>
                                        <p>{contractor.country}</p>
                                    </div>
                                )}
                            </div>
                        </section>

                    </div>

                    {/* Footer */}
                    <div className="p-6 border-t border-slate-100 dark:border-neutral-800 bg-slate-50 dark:bg-neutral-800/50 flex justify-end">
                        <Button onClick={onClose} variant="outline" className="dark:text-white dark:border-neutral-700 dark:hover:bg-neutral-700">Close Details</Button>
                    </div>

                </motion.div>
            </motion.div>
        </AnimatePresence>,
        document.body
    );
};



================================================
FILE: frontend/src/components/projects/CreateProjectModal.jsx
================================================
import { useState, useEffect, useCallback, useRef } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Loader2, ChevronRight, Check, Upload, Paperclip, Plus, AlertCircle, Trash2 } from 'lucide-react';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';
import { useAuth } from '@/contexts/AuthContext';
import { useLanguage } from '@/contexts/LanguageContext';
import { SmartInput } from '@/components/ui/SmartInput';
import { useModalClose } from '@/hooks/useModalClose';
import ChainedHierarchySelector from '@/components/masters/ChainedHierarchySelector';
import GeographySelector from '@/components/masters/GeographySelector';
import ClassificationSelector from '@/components/masters/ClassificationSelector';
import userService from '@/api/services/userService';
import edmsService from '@/api/services/edmsService';

const STEPS = [
  { id: 1, title: 'General Info' },
  { id: 2, title: 'Location & Jurisdiction' },
  { id: 3, title: 'Classification' },
  { id: 4, title: 'Funding Pattern' },
  { id: 5, title: 'Approvals' },
];

// Default funding sources
const DEFAULT_FUNDING_SOURCES = [
  { id: 1, source: 'Government of India', amount: '', document: null },
  { id: 2, source: 'Government of Telangana', amount: '', document: null },
  { id: 3, source: 'Financial Institutions (Loan)', amount: '', document: null },
  { id: 4, source: 'ULB Share', amount: '', document: null },
  { id: 5, source: 'RDPR', amount: '', document: null },
];

// Format number with Indian comma system (e.g., 10,00,000)
const formatIndianNumber = (num) => {
  if (!num && num !== 0) return '';
  const numStr = String(num).replace(/,/g, '');
  const parsed = parseFloat(numStr);
  if (isNaN(parsed)) return '';
  return parsed.toLocaleString('en-IN');
};

// Parse formatted string back to number
const parseFormattedNumber = (str) => {
  if (!str) return '';
  return str.replace(/,/g, '');
};

export const CreateProjectModal = ({ isOpen, onClose, onSave }) => {
  const { t } = useLanguage();
  const { user } = useAuth();
  const [currentStep, setCurrentStep] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submissionStatus, setSubmissionStatus] = useState(''); // Two-step save status
  const [direction, setDirection] = useState(0);

  // Eligible managers state
  const [eligibleManagers, setEligibleManagers] = useState([]);
  const [loadingManagers, setLoadingManagers] = useState(false);

  // Use standard hook for Escape key closing
  useModalClose(isOpen, onClose);

  // Fetch eligible managers on mount
  useEffect(() => {
    if (isOpen) {
      fetchEligibleManagers();
    } else {
      // Reset form state when modal closes
      setCurrentStep(1);
      setErrors({});
      setFormData({
        name: '',
        description: '',
        status: 'Planning',
        startDate: '',
        endDate: '',
        budget: '',
        managerId: '',
        hierarchy: { zone: '', zoneName: '', circle: '', circleName: '', division: '', divisionName: '', subDivision: '', subDivisionName: '' },
        geography: { district: '', districtName: '', town: '', townName: '' },
        classification: { schemeType: '', schemeTypeName: '', scheme: '', schemeName: '', workType: '', workTypeName: '', projectCategory: '', projectCategoryName: '' },
        fundingPattern: DEFAULT_FUNDING_SOURCES.map(item => ({ ...item })),
        adminApprovalNo: '',
        adminApprovalDate: '',
        adminApprovalDoc: null,
      });
    }
  }, [isOpen]);

  const fetchEligibleManagers = async () => {
    setLoadingManagers(true);
    try {
      const response = await userService.getEligibleManagers();
      // Defensive: ensure we always set an array, never an object
      const managersData = response.data;
      if (Array.isArray(managersData)) {
        setEligibleManagers(managersData);
      } else if (managersData?.results && Array.isArray(managersData.results)) {
        // Handle paginated response
        setEligibleManagers(managersData.results);
      } else {
        // API returned error object or unexpected format
        console.error('Unexpected managers data format:', managersData);
        setEligibleManagers([]);
        toast.error('Failed to load project managers');
      }
    } catch (error) {
      console.error('Failed to fetch eligible managers:', error);
      // CRITICAL: Always set an empty array on error, never leave it undefined
      setEligibleManagers([]);
      toast.error('Failed to load project managers');
    } finally {
      setLoadingManagers(false);
    }
  };

  const [formData, setFormData] = useState({
    // Step 1: General
    name: '',
    description: '',
    status: 'Planning',
    startDate: '',
    endDate: '',
    budget: '',
    managerId: '', // Changed from manager string to managerId

    // Step 2: Location (hierarchy + geography)
    hierarchy: {
      zone: '',
      zoneName: '',
      circle: '',
      circleName: '',
      division: '',
      divisionName: '',
      subDivision: '',
      subDivisionName: '',
    },
    geography: {
      district: '',
      districtName: '',
      town: '',
      townName: '',
    },

    // Step 3: Classification
    classification: {
      schemeType: '',
      schemeTypeName: '',
      scheme: '',
      schemeName: '',
      workType: '',
      workTypeName: '',
      projectCategory: '',
      projectCategoryName: '',
    },

    // Step 4: Funding (Array of objects with documents)
    fundingPattern: DEFAULT_FUNDING_SOURCES.map(item => ({ ...item })),

    // Step 5: Approvals
    adminApprovalNo: '',
    adminApprovalDate: '',
    adminApprovalDoc: null,
  });

  const [errors, setErrors] = useState({});

  // Calculate funding totals
  const fundingTotal = formData.fundingPattern.reduce((sum, item) => {
    return sum + (parseFloat(item.amount) || 0);
  }, 0);

  const projectBudget = parseFloat(formData.budget) || 0;
  const fundingMismatch = projectBudget > 0 && Math.abs(fundingTotal - projectBudget) > 0.01;

  const validateStep = (step) => {
    const newErrors = {};

    if (step === 1) {
      if (!formData.name.trim()) newErrors.name = t('project.projectNameRequired');
      if (!formData.startDate) newErrors.startDate = t('project.startDateRequired');
      if (!formData.endDate) newErrors.endDate = t('project.endDateRequired');
      if (!formData.budget) newErrors.budget = t('project.validBudgetRequired');
      if (!formData.managerId) newErrors.managerId = 'Project Manager is required';
    }

    if (step === 2) {
      if (!formData.hierarchy.zone) newErrors.zone = 'Zone is required';
      if (!formData.hierarchy.division) newErrors.division = 'Division is required';
      if (!formData.geography.district) newErrors.district = 'District is required';
    }

    if (step === 3) {
      if (!formData.classification.schemeType) newErrors.schemeType = 'Scheme Type is required';
      if (!formData.classification.scheme) newErrors.scheme = 'Scheme is required';
      if (!formData.classification.workType) newErrors.workType = 'Work Type is required';
      if (!formData.classification.projectCategory) newErrors.projectCategory = 'Project Category is required';
    }

    if (step === 4) {
      // Validate funding matches budget
      if (fundingMismatch) {
        newErrors.fundingMismatch = `Fund allocation (â‚¹${fundingTotal.toLocaleString('en-IN')}) does not match project budget (â‚¹${projectBudget.toLocaleString('en-IN')})`;
      }
      // Validate each source with amount > 0 has document
      formData.fundingPattern.forEach((item, idx) => {
        if (parseFloat(item.amount) > 0 && !item.document) {
          newErrors[`funding_${idx}`] = `Proof document required for ${item.source}`;
        }
      });
    }

    if (step === 5) {
      if (!formData.adminApprovalNo.trim()) newErrors.adminApprovalNo = 'Administrative Approval Number is required';
      if (!formData.adminApprovalDoc) newErrors.adminApprovalDoc = 'Administrative Approval Document is required';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleNext = () => {
    if (validateStep(currentStep)) {
      setDirection(1);
      setCurrentStep((prev) => Math.min(prev + 1, STEPS.length));
    }
  };

  const handleBack = () => {
    setDirection(-1);
    setCurrentStep((prev) => Math.max(prev - 1, 1));
  };

  const updateFunding = (index, field, value) => {
    const newFunding = [...formData.fundingPattern];
    newFunding[index][field] = value;
    setFormData({ ...formData, fundingPattern: newFunding });
  };

  const addCustomFundingSource = () => {
    const newId = Math.max(...formData.fundingPattern.map(f => f.id)) + 1;
    setFormData({
      ...formData,
      fundingPattern: [
        ...formData.fundingPattern,
        { id: newId, source: '', amount: '', document: null, isCustom: true }
      ]
    });
  };

  const removeFundingSource = (index) => {
    const newFunding = formData.fundingPattern.filter((_, idx) => idx !== index);
    setFormData({ ...formData, fundingPattern: newFunding });
  };

  // Drag and drop handlers for admin approval document
  const [isDragging, setIsDragging] = useState(false);
  const dropRef = useRef(null);

  const handleDragOver = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(true);
  }, []);

  const handleDragLeave = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);
  }, []);

  const handleDrop = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);

    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      const file = files[0];
      setFormData(prev => ({ ...prev, adminApprovalDoc: file }));
      toast.success('Document attached successfully');
    }
  }, []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!validateStep(currentStep)) return;

    setIsSubmitting(true);
    setSubmissionStatus('Creating Project...');

    try {
      // ============================================================
      // STEP A: Create the Project first (to get the ID)
      // ============================================================
      const selectedManager = eligibleManagers.find(m => m.id === parseInt(formData.managerId));

      // Format project name with approval number
      const displayName = formData.adminApprovalNo
        ? `${formData.name} (${formData.adminApprovalNo})`
        : formData.name;

      const projectData = {
        name: formData.name,
        displayName: displayName,
        description: formData.description,
        status: formData.status,
        startDate: formData.startDate,
        endDate: formData.endDate,
        budget: formData.budget,
        managerId: formData.managerId,
        manager: selectedManager ? `${selectedManager.first_name} ${selectedManager.last_name}` : '',

        // Hierarchy
        zone: formData.hierarchy.zone,
        zoneName: formData.hierarchy.zoneName,
        circle: formData.hierarchy.circle,
        circleName: formData.hierarchy.circleName,
        division: formData.hierarchy.division,
        divisionName: formData.hierarchy.divisionName,
        subDivision: formData.hierarchy.subDivision,
        subDivisionName: formData.hierarchy.subDivisionName,

        // Geography
        district: formData.geography.district,
        districtName: formData.geography.districtName,
        town: formData.geography.town,
        townName: formData.geography.townName,

        // Classification
        schemeType: formData.classification.schemeType,
        schemeTypeName: formData.classification.schemeTypeName,
        scheme: formData.classification.scheme,
        schemeName: formData.classification.schemeName,
        workType: formData.classification.workType,
        workTypeName: formData.classification.workTypeName,
        projectCategory: formData.classification.projectCategory,
        projectCategoryName: formData.classification.projectCategoryName,

        // Funding & Approvals
        fundingPattern: formData.fundingPattern.map(f => ({
          source: f.source,
          amount: f.amount,
          hasDocument: !!f.document
        })),
        adminApprovalNo: formData.adminApprovalNo,
        adminApprovalDate: formData.adminApprovalDate,

        // Computed/default fields
        progress: 0,
        spent: 0,
        location: {
          address: `${formData.geography.townName || ''}, ${formData.geography.districtName || ''}`.replace(/^, |, $/g, ''),
        },
        stakeholders: [],
        category: formData.classification.projectCategoryName || 'General',
      };

      // Create the project and get the new ID
      const projectResult = await onSave(projectData);

      // ROBUST ID EXTRACTION: Handle all possible API response formats
      let newProjectId = null;

      if (projectResult) {
        // Try direct ID (if result is the project object)
        newProjectId = projectResult.id;

        // Try axios response wrapper (result.data.id)
        if (!newProjectId && projectResult.data) {
          newProjectId = projectResult.data.id;
        }

        // Try nested response (result.data.data.id - some APIs double-wrap)
        if (!newProjectId && projectResult.data?.data) {
          newProjectId = projectResult.data.data.id;
        }

        // Convert to number if it's a string number
        if (newProjectId && typeof newProjectId === 'string') {
          const parsed = parseInt(newProjectId, 10);
          if (!isNaN(parsed)) {
            newProjectId = parsed;
          }
        }
      }

      if (!newProjectId) {
        throw new Error('Project created but ID not returned');
      }

      // ============================================================
      // STEP B: Upload Funding Proof Documents to EDMS
      // ============================================================
      const fundingDocsToUpload = formData.fundingPattern.filter(
        item => item.document && parseFloat(item.amount) > 0
      );

      // Also include admin approval doc if present
      const adminDoc = formData.adminApprovalDoc;
      const totalDocs = fundingDocsToUpload.length + (adminDoc ? 1 : 0);

      if (totalDocs > 0) {
        setSubmissionStatus(`Uploading ${totalDocs} Sanction Order(s)...`);

        let uploadSuccess = 0;
        let uploadFailed = 0;

        // Upload funding proof documents
        const uploadPromises = fundingDocsToUpload.map(async (item) => {
          try {
            await edmsService.uploadDocument({
              projectId: newProjectId,
              file: item.document,
              title: `Sanction Order - ${item.source}`,
              autoRouteCategory: 'FUNDING_PROOF',
              documentType: 'CONTRACT', // Sanction orders are contractual
            });
            uploadSuccess++;
          } catch (error) {
            console.error(`Failed to upload funding doc for ${item.source}:`, error);
            uploadFailed++;
          }
        });

        // Upload admin approval document
        if (adminDoc) {
          uploadPromises.push(
            (async () => {
              try {
                await edmsService.uploadDocument({
                  projectId: newProjectId,
                  file: adminDoc,
                  title: `Administrative Approval - ${formData.adminApprovalNo}`,
                  autoRouteCategory: 'ADMIN_APPROVAL',
                  documentType: 'CONTRACT',
                });
                uploadSuccess++;
              } catch (error) {
                console.error('Failed to upload admin approval doc:', error);
                uploadFailed++;
              }
            })()
          );
        }

        // Wait for all uploads to complete
        await Promise.all(uploadPromises);

        // Show appropriate message based on upload results
        if (uploadFailed > 0) {
          toast.warning(
            `Project created successfully, but ${uploadFailed} document(s) failed to upload. Please upload them manually in EDMS.`,
            { duration: 6000 }
          );
        } else {
          toast.success(
            `${t('project.createdSuccessfully')} ${uploadSuccess} document(s) uploaded.`,
            { duration: 4000 }
          );
        }
      } else {
        toast.success(t('project.createdSuccessfully'));
      }

      onClose();
    } catch (error) {
      console.error('Project creation failed:', error);
      toast.error(t('project.failedToCreate'));
    } finally {
      setIsSubmitting(false);
      setSubmissionStatus('');
    }
  };

  if (!isOpen) return null;

  // Common input classes matching website UI
  const inputClasses = "w-full px-3 py-2.5 rounded-lg border border-app bg-app-input text-app-text text-sm focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-indigo-500/30 outline-none transition-all";
  const labelClasses = "block text-sm font-medium text-app-text mb-1.5";
  const errorClasses = "text-xs text-red-500 dark:text-red-400 mt-1";

  return createPortal(
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="fixed inset-0 z-[9999] flex items-center justify-center bg-app-overlay backdrop-blur-sm p-4"
    >
      <motion.div
        initial={{ opacity: 0, scale: 0.95, y: 20 }}
        animate={{ opacity: 1, scale: 1, y: 0 }}
        exit={{ opacity: 0, scale: 0.95, y: 20 }}
        className="w-full max-w-4xl bg-app-card rounded-xl sm:rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[95vh] sm:max-h-[90vh]"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="p-4 sm:p-6 border-b border-app-subtle flex justify-between items-center bg-app-card z-10">
          <div>
            <h2 className="text-xl sm:text-2xl font-bold text-app-heading">Create New Project</h2>
            <p className="text-xs sm:text-sm text-app-muted">Step {currentStep} of {STEPS.length}: {STEPS[currentStep - 1].title}</p>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-app-surface rounded-full transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center">
            <X size={24} className="text-app-muted" />
          </button>
        </div>

        {/* Progress Bar */}
        <div className="h-1 w-full bg-app-surface">
          <motion.div
            className="h-full bg-primary-600"
            initial={{ width: 0 }}
            animate={{ width: `${(currentStep / STEPS.length) * 100}%` }}
            transition={{ duration: 0.3 }}
          />
        </div>

        {/* Form Content */}
        <div className="flex-1 overflow-y-auto p-4 sm:p-6">
          <AnimatePresence mode="wait" custom={direction}>
            <motion.div
              key={currentStep}
              custom={direction}
              initial={{ x: direction * 20, opacity: 0 }}
              animate={{ x: 0, opacity: 1 }}
              exit={{ x: direction * -20, opacity: 0 }}
              transition={{ duration: 0.2 }}
              className="space-y-6"
            >
              {/* STEP 1: GENERAL INFO */}
              {currentStep === 1 && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="md:col-span-2">
                    <label className={labelClasses}>Project Name *</label>
                    <input
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      className={`${inputClasses} ${errors.name ? 'border-red-500' : ''}`}
                      placeholder="Enter project name"
                    />
                    {errors.name && <p className={errorClasses}>{errors.name}</p>}
                  </div>

                  <div className="md:col-span-2">
                    <SmartInput
                      label="Description"
                      value={formData.description}
                      onChange={(val) => setFormData({ ...formData, description: val })}
                      placeholder="Project description..."
                      rows={3}
                    />
                  </div>

                  <div>
                    <label className={labelClasses}>Start Date *</label>
                    <input
                      type="date"
                      value={formData.startDate}
                      onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                      className={inputClasses}
                    />
                    {errors.startDate && <p className={errorClasses}>{errors.startDate}</p>}
                  </div>
                  <div>
                    <label className={labelClasses}>End Date *</label>
                    <input
                      type="date"
                      value={formData.endDate}
                      onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                      className={inputClasses}
                    />
                    {errors.endDate && <p className={errorClasses}>{errors.endDate}</p>}
                  </div>

                  <div>
                    <label className={labelClasses}>Project Cost (â‚¹) *</label>
                    <input
                      type="text"
                      value={formatIndianNumber(formData.budget)}
                      onChange={(e) => {
                        const raw = parseFormattedNumber(e.target.value);
                        if (raw === '' || /^\d*\.?\d*$/.test(raw)) {
                          setFormData({ ...formData, budget: raw });
                        }
                      }}
                      className={inputClasses}
                      placeholder="e.g. 10,00,000"
                    />
                    {errors.budget && <p className={errorClasses}>{errors.budget}</p>}
                  </div>

                  <div>
                    <label className={labelClasses}>Project Manager *</label>
                    <div className="relative">
                      <select
                        value={formData.managerId}
                        onChange={(e) => setFormData({ ...formData, managerId: e.target.value })}
                        disabled={loadingManagers}
                        className={`${inputClasses} appearance-none cursor-pointer ${errors.managerId ? 'border-red-500' : ''}`}
                      >
                        <option value="">
                          {loadingManagers ? 'Loading managers...' : 'Select Project Manager'}
                        </option>
                        {eligibleManagers.map((manager) => (
                          <option key={manager.id} value={manager.id}>
                            {manager.first_name} {manager.last_name} ({manager.role_display || manager.role})
                          </option>
                        ))}
                      </select>
                      <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                        {loadingManagers ? (
                          <Loader2 size={16} className="animate-spin text-app-muted" />
                        ) : (
                          <ChevronRight size={16} className="text-app-muted rotate-90" />
                        )}
                      </div>
                    </div>
                    {errors.managerId && <p className={errorClasses}>{errors.managerId}</p>}
                  </div>
                </div>
              )}

              {/* STEP 2: LOCATION */}
              {currentStep === 2 && (
                <div className="space-y-6">
                  {Object.keys(errors).length > 0 && (
                    <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3">
                      <p className="text-sm font-medium text-red-800 dark:text-red-300">Please fill in the required fields:</p>
                      <ul className="mt-1 text-sm text-red-600 dark:text-red-400 list-disc list-inside">
                        {errors.zone && <li>Zone is required</li>}
                        {errors.division && <li>Division is required</li>}
                        {errors.district && <li>District is required</li>}
                      </ul>
                    </div>
                  )}
                  <div>
                    <h3 className="text-sm font-semibold text-app-heading mb-3 flex items-center gap-2">
                      <span className="w-6 h-6 rounded-full bg-primary-100 text-primary-700 flex items-center justify-center text-xs">1</span>
                      Administrative Hierarchy <span className="text-red-500">*</span>
                    </h3>
                    <ChainedHierarchySelector
                      value={formData.hierarchy}
                      onChange={(val) => setFormData({ ...formData, hierarchy: val })}
                    />
                    <p className="text-xs text-app-muted mt-2">Zone and Division are required</p>
                  </div>
                  <div className="border-t border-app-subtle pt-6">
                    <h3 className="text-sm font-semibold text-app-heading mb-3 flex items-center gap-2">
                      <span className="w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-xs">2</span>
                      Geographic Location <span className="text-red-500">*</span>
                    </h3>
                    <GeographySelector
                      value={formData.geography}
                      onChange={(val) => setFormData({ ...formData, geography: val })}
                    />
                    <p className="text-xs text-app-muted mt-2">District is required</p>
                  </div>
                </div>
              )}

              {/* STEP 3: CLASSIFICATION */}
              {currentStep === 3 && (
                <div>
                  {Object.keys(errors).length > 0 && (
                    <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 mb-4">
                      <p className="text-sm font-medium text-red-800 dark:text-red-300">Please fill in all classification fields:</p>
                      <ul className="mt-1 text-sm text-red-600 dark:text-red-400 list-disc list-inside">
                        {errors.schemeType && <li>Scheme Type is required</li>}
                        {errors.scheme && <li>Scheme is required</li>}
                        {errors.workType && <li>Work Type is required</li>}
                        {errors.projectCategory && <li>Project Category is required</li>}
                      </ul>
                    </div>
                  )}
                  <p className="text-sm text-app-muted mb-4">
                    Select the scheme, work type, and category for this project. <span className="text-red-500">All fields are required.</span>
                  </p>
                  <ClassificationSelector
                    value={formData.classification}
                    onChange={(val) => setFormData({ ...formData, classification: val })}
                  />
                </div>
              )}

              {/* STEP 4: FUNDING PATTERN */}
              {currentStep === 4 && (
                <div className="space-y-4">
                  {/* Budget Display */}
                  <div className="bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-lg p-4">
                    <div className="flex items-center justify-between">
                      <span className="text-sm font-medium text-primary-800 dark:text-primary-300">Project Budget:</span>
                      <span className="text-lg font-bold text-primary-900 dark:text-primary-200">
                        â‚¹{projectBudget.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                      </span>
                    </div>
                  </div>

                  {/* Funding Mismatch Error */}
                  {errors.fundingMismatch && (
                    <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 flex items-start gap-2">
                      <AlertCircle size={18} className="text-red-500 mt-0.5 flex-shrink-0" />
                      <p className="text-sm text-red-700 dark:text-red-300">{errors.fundingMismatch}</p>
                    </div>
                  )}

                  <h3 className="font-medium text-app-heading">Add Funding Pattern</h3>
                  <div className="border border-app-subtle rounded-lg overflow-hidden">
                    <table className="w-full text-sm text-left">
                      <thead className="bg-app-surface text-app-muted">
                        <tr>
                          <th className="p-3 font-medium">Source</th>
                          <th className="p-3 font-medium">Amount (â‚¹)</th>
                          <th className="p-3 font-medium">Proof Document *</th>
                          <th className="p-3 w-12"></th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                        {formData.fundingPattern.map((item, idx) => (
                          <tr key={item.id}>
                            <td className="p-3">
                              {item.isCustom ? (
                                <input
                                  type="text"
                                  value={item.source}
                                  onChange={(e) => updateFunding(idx, 'source', e.target.value)}
                                  className={`${inputClasses} py-1.5`}
                                  placeholder="Enter source name"
                                />
                              ) : (
                                <span className="text-app-text">{item.source}</span>
                              )}
                            </td>
                            <td className="p-3">
                              <input
                                type="text"
                                value={formatIndianNumber(item.amount)}
                                onChange={(e) => {
                                  const raw = parseFormattedNumber(e.target.value);
                                  if (raw === '' || /^\d*\.?\d*$/.test(raw)) {
                                    updateFunding(idx, 'amount', raw);
                                  }
                                }}
                                className={`${inputClasses} py-1.5 ${errors[`funding_${idx}`] ? 'border-red-500' : ''}`}
                                placeholder="e.g. 5,00,000"
                              />
                            </td>
                            <td className="p-3">
                              <div className="flex items-center gap-2">
                                <input
                                  type="file"
                                  id={`funding-doc-${idx}`}
                                  className="hidden"
                                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                  onChange={(e) => {
                                    const file = e.target.files?.[0];
                                    if (file) {
                                      updateFunding(idx, 'document', file);
                                      toast.success(`Document attached for ${item.source}`);
                                    }
                                  }}
                                />
                                <button
                                  type="button"
                                  onClick={() => document.getElementById(`funding-doc-${idx}`).click()}
                                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${item.document
                                    ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-900/50'
                                    : 'bg-app-surface text-app-muted hover:bg-app-subtle'
                                    }`}
                                >
                                  <Paperclip size={14} />
                                  {item.document ? 'Attached âœ“' : 'Attach'}
                                </button>
                                {item.document && (
                                  <span className="text-xs text-app-muted truncate max-w-[100px]">
                                    {item.document.name}
                                  </span>
                                )}
                              </div>
                              {errors[`funding_${idx}`] && (
                                <p className="text-xs text-red-500 mt-1">{errors[`funding_${idx}`]}</p>
                              )}
                            </td>
                            <td className="p-3">
                              {item.isCustom && (
                                <button
                                  type="button"
                                  onClick={() => removeFundingSource(idx)}
                                  className="p-1.5 hover:bg-red-100 rounded text-red-500 transition-colors"
                                >
                                  <Trash2 size={16} />
                                </button>
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  {/* Total and Add Custom Button */}
                  <div className="flex items-center justify-between pt-2">
                    <button
                      type="button"
                      onClick={addCustomFundingSource}
                      className="flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-primary-600 hover:bg-primary-50 rounded-lg transition-colors"
                    >
                      <Plus size={16} />
                      Add Custom Funding Source
                    </button>

                    <div className="text-right">
                      <p className="text-sm text-app-muted">Total Allocated:</p>
                      <p className={`text-lg font-bold ${fundingMismatch ? 'text-red-600' : 'text-green-600'}`}>
                        â‚¹{fundingTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                        {!fundingMismatch && projectBudget > 0 && (
                          <span className="text-sm font-normal text-green-600 ml-2">âœ“ Matches Budget</span>
                        )}
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* STEP 5: APPROVALS */}
              {currentStep === 5 && (
                <div className="space-y-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label className={labelClasses}>Administrative Approval Number *</label>
                      <input
                        value={formData.adminApprovalNo}
                        onChange={(e) => setFormData({ ...formData, adminApprovalNo: e.target.value })}
                        className={`${inputClasses} ${errors.adminApprovalNo ? 'border-red-500' : ''}`}
                        placeholder="Enter approval number"
                      />
                      {errors.adminApprovalNo && <p className={errorClasses}>{errors.adminApprovalNo}</p>}
                    </div>
                    <div>
                      <label className={labelClasses}>Approval Date</label>
                      <input
                        type="date"
                        value={formData.adminApprovalDate}
                        onChange={(e) => setFormData({ ...formData, adminApprovalDate: e.target.value })}
                        className={inputClasses}
                      />
                    </div>
                  </div>

                  {/* Drag and Drop Upload Zone */}
                  <div
                    ref={dropRef}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                    onClick={() => document.getElementById('admin-approval-upload').click()}
                    className={`p-8 border-2 border-dashed rounded-xl flex flex-col items-center justify-center text-center transition-colors cursor-pointer ${errors.adminApprovalDoc ? 'border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/20' :
                      isDragging ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/30' :
                        formData.adminApprovalDoc ? 'border-green-500 dark:border-green-600 bg-green-50 dark:bg-green-900/20' :
                          'border-app-subtle hover:bg-app-surface'
                      }`}
                  >
                    <input
                      id="admin-approval-upload"
                      type="file"
                      className="hidden"
                      accept=".pdf,.doc,.docx"
                      onChange={(e) => {
                        const file = e.target.files?.[0];
                        if (file) {
                          setFormData({ ...formData, adminApprovalDoc: file });
                          toast.success('Document attached successfully');
                        }
                      }}
                    />
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center mb-3 ${formData.adminApprovalDoc ? 'bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-400' :
                      isDragging ? 'bg-primary-100 dark:bg-primary-900/50 text-primary-600 dark:text-primary-400' :
                        'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400'
                      }`}>
                      {formData.adminApprovalDoc ? <Check size={24} /> : <Upload size={24} />}
                    </div>
                    {formData.adminApprovalDoc ? (
                      <>
                        <p className="font-medium text-green-700 dark:text-green-400">Document Selected</p>
                        <p className="text-sm text-green-600 dark:text-green-500 mt-1">{formData.adminApprovalDoc.name}</p>
                        <p className="text-xs text-green-500 dark:text-green-600 mt-2">Click or drag to replace</p>
                      </>
                    ) : (
                      <>
                        <p className="font-medium text-app-heading">Upload Administrative Approval Document *</p>
                        <p className="text-sm text-app-muted mt-1">
                          {isDragging ? 'Drop file here' : 'Drag and drop or click to browse'}
                        </p>
                        <p className="text-xs text-app-muted mt-2">Supported formats: PDF, DOC, DOCX</p>
                      </>
                    )}
                  </div>
                  {errors.adminApprovalDoc && (
                    <p className={errorClasses}>{errors.adminApprovalDoc}</p>
                  )}
                </div>
              )}
            </motion.div>
          </AnimatePresence>
        </div>

        {/* Footer */}
        <div className="p-4 sm:p-6 border-t border-app-subtle bg-app-surface flex flex-col sm:flex-row justify-between gap-3">
          <Button
            variant="outline"
            onClick={currentStep === 1 ? onClose : handleBack}
            disabled={isSubmitting}
            className="min-h-[44px]"
          >
            {currentStep === 1 ? 'Cancel' : 'Back'}
          </Button>

          {currentStep < STEPS.length ? (
            <Button onClick={handleNext} className="min-h-[44px] bg-primary-950 text-white hover:bg-primary-900">
              Next Step <ChevronRight size={16} className="ml-1" />
            </Button>
          ) : (
            <Button onClick={handleSubmit} disabled={isSubmitting} className="min-h-[44px] bg-green-600 text-white hover:bg-green-700">
              {isSubmitting ? (
                <>
                  <Loader2 className="animate-spin mr-2" size={16} />
                  {submissionStatus || 'Creating Project...'}
                </>
              ) : 'Create Project'}
            </Button>
          )}
        </div>
      </motion.div>
    </motion.div>,
    document.body
  );
};



================================================
FILE: frontend/src/components/projects/LandStats.jsx
================================================
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Map, Info } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { MultiProgressBar } from './MultiProgressBar';
import { cn } from '@/lib/utils';

export const LandStats = ({ project, className }) => {
  const navigate = useNavigate();
  const [hoveredSegment, setHoveredSegment] = useState(null);

  if (!project.land_data) {
    return null;
  }

  const { total_required_acres, acquired_acres, notification_issued_acres, litigation_acres } =
    project.land_data;

  // Calculate remaining acres
  const remaining_acres = Math.max(
    0,
    total_required_acres - acquired_acres - notification_issued_acres - litigation_acres
  );

  // Build segments (always show all three, even if value is 0)
  const segments = [
    {
      id: 'possession',
      value: acquired_acres,
      color: 'bg-emerald-500',
      label: 'Possession Taken',
      tooltip: `${acquired_acres.toLocaleString()} acres (${(acquired_acres * 0.404686).toFixed(2)} hectares)`,
    },
    {
      id: 'notification',
      value: notification_issued_acres,
      color: 'bg-amber-400',
      label: 'Under Notification (Section 11/19)',
      tooltip: `${notification_issued_acres.toLocaleString()} acres (${(notification_issued_acres * 0.404686).toFixed(2)} hectares)`,
    },
    {
      id: 'litigation',
      value: litigation_acres,
      color: 'bg-rose-500',
      label: 'In Litigation/Court Stay',
      tooltip: `${litigation_acres.toLocaleString()} acres (${(litigation_acres * 0.404686).toFixed(2)} hectares)`,
    },
  ];

  // Calculate percentages
  const possessionPercent = (acquired_acres / total_required_acres) * 100;
  const notificationPercent = (notification_issued_acres / total_required_acres) * 100;
  const litigationPercent = (litigation_acres / total_required_acres) * 100;
  const shouldPulseLitigation = litigationPercent > 10;

  const handleSegmentClick = (segmentId) => {
    navigate(`/gis?layer=land_parcels&status=${segmentId === 'possession' ? 'acquired' : segmentId === 'notification' ? 'pending' : 'litigation'}&project=${project.id}`);
  };

  const handleMapClick = () => {
    navigate(`/gis?layer=land_parcels&project=${project.id}`);
  };

  return (
    <div className={cn('space-y-3', className)}>
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Info size={16} className="text-gray-500 dark:text-gray-400" />
          <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Land Acquisition Status</span>
        </div>
        <motion.button
          onClick={handleMapClick}
          className="p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-neutral-800 transition-colors text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400"
          whileHover={{ scale: 1.1 }}
          whileTap={{ scale: 0.95 }}
          title="View on Map"
        >
          <Map size={16} />
        </motion.button>
      </div>

      {/* Multi-segment Progress Bar */}
      <div className="relative group">
        <MultiProgressBar
          segments={segments}
          total={total_required_acres}
          height={10}
          showPulse={shouldPulseLitigation}
          onSegmentClick={handleSegmentClick}
          className="shadow-sm"
        />
      </div>

      {/* Legend with Tooltips */}
      <div className="grid grid-cols-3 gap-2 text-xs">
        {segments.map((segment) => {
          const percent = (segment.value / total_required_acres) * 100;
          const isLitigation = segment.id === 'litigation';
          const shouldPulse = isLitigation && percent > 10;

          return (
            <div
              key={segment.id}
              className={cn(
                'relative flex items-center gap-1.5 cursor-pointer hover:bg-gray-50 p-1.5 rounded transition-colors',
                shouldPulse && 'animate-pulse'
              )}
              onMouseEnter={() => setHoveredSegment(segment.id)}
              onMouseLeave={() => setHoveredSegment(null)}
              onClick={() => handleSegmentClick(segment.id)}
            >
              <div className={cn('w-3 h-3 rounded flex-shrink-0', segment.color)} />
              <span className="text-gray-600 dark:text-gray-400 truncate text-xs">{segment.label.split(' ')[0]}</span>
              <span className="text-gray-900 dark:text-white font-semibold ml-auto text-xs">
                {percent.toFixed(1)}%
              </span>

              {/* Tooltip on hover */}
              {hoveredSegment === segment.id && (
                <motion.div
                  initial={{ opacity: 0, y: -5 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -5 }}
                  className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-20 whitespace-nowrap pointer-events-none"
                >
                  <div className="font-semibold mb-1">{segment.label}</div>
                  <div className="text-gray-300">{segment.tooltip}</div>
                  <div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900" />
                </motion.div>
              )}
            </div>
          );
        })}
      </div>

      {/* Summary Stats */}
      <div className="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 pt-1 border-t border-gray-200 dark:border-gray-700">
        <span>
          Total: <span className="font-semibold text-gray-700 dark:text-gray-300">{total_required_acres.toLocaleString()} acres</span>
        </span>
        <span>
          Acquired: <span className="font-semibold text-emerald-600 dark:text-emerald-400">{acquired_acres.toLocaleString()} acres</span>
        </span>
      </div>
    </div>
  );
};



================================================
FILE: frontend/src/components/projects/MultiProgressBar.jsx
================================================
import React from 'react';
import { motion } from 'framer-motion';
import { cn } from '@/lib/utils';

export const MultiProgressBar = ({
  segments,
  total,
  height = 8,
  showPulse = false,
  onSegmentClick,
  className,
}) => {
  if (total === 0) {
    return (
      <div
        className={cn('w-full bg-gray-200 rounded-full overflow-hidden', className)}
        style={{ height }}
      >
        <div className="w-full h-full bg-gray-100" />
      </div>
    );
  }

  return (
    <div
      className={cn('w-full bg-gray-200 rounded-full overflow-hidden flex', className)}
      style={{ height }}
    >
      {segments.map((segment, index) => {
        const widthPercent = (segment.value / total) * 100;
        const hasValue = segment.value > 0;

        return (
          <motion.div
            key={segment.id}
            initial={{ width: 0 }}
            animate={{ width: `${widthPercent}%` }}
            transition={{
              duration: 0.5,
              delay: index * 0.1,
              ease: 'easeOut',
            }}
            className={cn(
              'h-full transition-all duration-200 relative',
              segment.color,
              hasValue && 'cursor-pointer hover:opacity-90'
            )}
            style={{
              animation: showPulse && segment.id === 'litigation' && widthPercent > 10 
                ? 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite' 
                : undefined
            }}
            onClick={() => hasValue && onSegmentClick?.(segment.id)}
            whileHover={hasValue ? { scale: 1.02 } : {}}
            title={segment.tooltip || segment.label}
          />
        );
      })}
    </div>
  );
};



================================================
FILE: frontend/src/components/projects/ProjectDetailModal.jsx
================================================
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
  X,
  Calendar,
  DollarSign,
  MapPin,
  User,
  TrendingUp,
  TrendingDown,
  FolderOpen,
  Clock,
  Target,
  BarChart3,
  Users,
  Briefcase,
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { tasks, risks } from '@/mock';
import { DynamicChart } from '@/components/ui/DynamicChart';
import { getStatusColor } from '@/lib/colors';
import {
  calculateRemainingBudget,
  calculateBudgetUtilization,
  calculateCostVariationPercentage,
} from '@/lib/calculations';
import { EmptyState } from '@/components/ui/EmptyState';
import { AddContractorModal } from '@/components/procurement/AddContractorModal';
import Button from '@/components/ui/Button';

export const ProjectDetailModal = ({ isOpen, onClose, project, packages = [], contractors = [], onAddContractor }) => {
  if (!isOpen || !project) return null;

  const [activeTab, setActiveTab] = useState('overview');
  const [isAddContractorModalOpen, setIsAddContractorModalOpen] = useState(false);

  // Handle Escape key
  useEffect(() => {
    const handleEscape = (e) => {
      // Only close if the top modal (AddContractorModal) is NOT open
      if (e.key === 'Escape' && !isAddContractorModalOpen) {
        onClose();
      }
    };

    if (isOpen) {
      window.addEventListener('keydown', handleEscape);
    }

    return () => window.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose, isAddContractorModalOpen]);

  const projectTasks = tasks.filter((task) => task.projectId === project.id);
  const projectRisks = risks.filter((risk) => risk.projectId === project.id);

  const budgetUtilization = calculateBudgetUtilization(project.budget, project.spent);
  const budgetRemaining = calculateRemainingBudget(project.budget, project.spent, 0);
  const costVariancePercentage = calculateCostVariationPercentage(project.budget, project.spent);

  const statusColors = getStatusColor(project.status);

  const formatCurrency = (amount) => {
    if (amount >= 10000000) {
      return `â‚¹${(amount / 10000000).toFixed(2)} Cr`;
    }
    return `â‚¹${(amount / 100000).toFixed(2)} L`;
  };

  // Calculate days remaining - with null checks
  const endDateValue = project.endDate || project.end_date;
  const endDate = endDateValue ? new Date(endDateValue) : null;
  const today = new Date();
  const daysRemaining = endDate && !isNaN(endDate.getTime())
    ? Math.ceil((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))
    : 0;
  const isOverdue = endDate && !isNaN(endDate.getTime()) ? daysRemaining < 0 : false;

  // Generate progress history (last 6 months)
  const progressHistory = Array.from({ length: 6 }, (_, i) => {
    const date = new Date();
    date.setMonth(date.getMonth() - (5 - i));
    const monthName = date.toLocaleDateString('en-US', { month: 'short' });
    const baseProgress = project.progress;
    const variation = (Math.random() - 0.5) * 15;
    return {
      month: monthName,
      progress: Math.max(0, Math.min(100, baseProgress + variation)),
    };
  });

  // Generate budget history
  const budgetHistory = Array.from({ length: 6 }, (_, i) => {
    const date = new Date();
    date.setMonth(date.getMonth() - (5 - i));
    const monthName = date.toLocaleDateString('en-US', { month: 'short' });
    const monthlySpend = project.spent / 6;
    return {
      month: monthName,
      spent: monthlySpend * (i + 1),
      budget: (project.budget / 6) * (i + 1),
    };
  });

  const taskStatusCounts = projectTasks.reduce(
    (acc, task) => {
      acc[task.status] = (acc[task.status] || 0) + 1;
      return acc;
    },
    {}
  );

  const riskImpactCounts = projectRisks.reduce(
    (acc, risk) => {
      acc[risk.impact] = (acc[risk.impact] || 0) + 1;
      return acc;
    },
    {}
  );

  const modalContent = (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0, backdropFilter: 'blur(0px)' }}
        animate={{ opacity: 1, backdropFilter: 'blur(12px)' }}
        exit={{ opacity: 0, backdropFilter: 'blur(0px)' }}
        transition={{ duration: 0.3, ease: 'easeInOut' }}
        className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60 dark:bg-black/80 backdrop-blur-sm"
        style={{ backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)' }}
        onClick={onClose}
      >
        <motion.div
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.95 }}
          transition={{ duration: 0.3, ease: 'easeInOut' }}
          className="w-full h-full max-w-7xl max-h-[95vh] overflow-y-auto bg-white dark:bg-neutral-900 rounded-lg shadow-2xl"
          onClick={(e) => e.stopPropagation()}
        >
          {/* Header */}
          <div className="sticky top-0 z-10 bg-white dark:bg-neutral-900 border-b border-gray-200 dark:border-neutral-700 px-6 py-4 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className={`p-3 rounded-full ${statusColors.bg}`}>
                <FolderOpen className={statusColors.text} size={28} />
              </div>
              <div>
                <h2 className="text-2xl font-bold text-primary-950 dark:text-white">{project.name}</h2>
                <div className="flex items-center gap-2 mt-1">
                  <span className="text-sm text-gray-600 dark:text-neutral-400">{project.category}</span>
                  <span className="w-1 h-1 bg-gray-300 dark:bg-neutral-600 rounded-full"></span>
                  <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${statusColors.bg} ${statusColors.text}`}>
                    {project.status}
                  </span>
                </div>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-neutral-800 transition-colors"
              aria-label="Close modal"
            >
              <X size={24} className="text-slate-700 dark:text-neutral-300" />
            </button>
          </div>

          {/* Tab Navigation */}
          <div className="px-6 border-b border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 sticky top-[88px] z-10">
            <div className="flex gap-6">
              {['Overview', 'Packages', 'Procurements', 'Budget', 'Risks'].map((tab) => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab.toLowerCase())}
                  className={`py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === tab.toLowerCase()
                    ? 'border-primary-600 text-primary-600'
                    : 'border-transparent text-slate-500 dark:text-neutral-400 hover:text-slate-700 dark:hover:text-neutral-200'
                    }`}
                >
                  {tab}
                </button>
              ))}
            </div>
          </div>


          {/* Content */}
          <div className="p-6 space-y-6">

            {activeTab === 'overview' && (
              <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-6">
                {/* Key Metrics Cards */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <Card>
                    <CardContent className="p-4">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Project Progress</p>
                          <p className="text-2xl font-bold text-primary-950 dark:text-white">{project.progress}%</p>
                        </div>
                        <Target className="text-primary-600" size={32} />
                      </div>
                      <div className="mt-3 w-full h-2 bg-gray-200 dark:bg-neutral-700 rounded-full">
                        <div
                          className={`h-2 rounded-full ${project.progress === 100
                            ? 'bg-success-600'
                            : project.progress >= 50
                              ? 'bg-primary-600'
                              : 'bg-warning-500'
                            }`}
                          style={{ width: `${project.progress}%` }}
                        />
                      </div>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardContent className="p-4">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Budget Utilization</p>
                          <p className="text-2xl font-bold text-primary-950 dark:text-white">{budgetUtilization.toFixed(1)}%</p>
                        </div>
                        <DollarSign className="text-primary-600" size={32} />
                      </div>
                      <div className="mt-3 w-full h-2 bg-gray-200 dark:bg-neutral-700 rounded-full">
                        <div
                          className={`h-2 rounded-full ${budgetUtilization > 90
                            ? 'bg-error-600'
                            : budgetUtilization > 75
                              ? 'bg-warning-500'
                              : 'bg-success-600'
                            }`}
                          style={{ width: `${Math.min(budgetUtilization, 100)}%` }}
                        />
                      </div>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardContent className="p-4">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Days Remaining</p>
                          <p className={`text-2xl font-bold ${isOverdue ? 'text-error-600' : 'text-primary-950 dark:text-white'}`}>
                            {Math.abs(daysRemaining)}
                          </p>
                        </div>
                        <Clock className="text-gray-600 dark:text-neutral-400" size={32} />
                      </div>
                      <p className={`text-xs mt-2 ${isOverdue ? 'text-error-600' : 'text-gray-600 dark:text-neutral-400'}`}>
                        {isOverdue ? 'Overdue' : 'On Schedule'}
                      </p>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardContent className="p-4">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Cost Variation</p>
                          <p
                            className={`text-2xl font-bold ${costVariancePercentage > 0 ? 'text-error-600' : 'text-success-600'
                              }`}
                          >
                            {costVariancePercentage > 0 ? '+' : ''}
                            {costVariancePercentage.toFixed(1)}%
                          </p>
                        </div>
                        {costVariancePercentage > 0 ? (
                          <TrendingUp className="text-error-600" size={32} />
                        ) : (
                          <TrendingDown className="text-success-600" size={32} />
                        )}
                      </div>
                    </CardContent>
                  </Card>
                </div>

                {/* Project Overview */}
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <BarChart3 size={20} />
                      Project Overview
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <p className="text-gray-700 dark:text-neutral-300 leading-relaxed">{project.description}</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-neutral-700">
                      <div className="flex items-start gap-3">
                        <Calendar className="text-gray-400 mt-1" size={18} />
                        <div>
                          <p className="text-sm font-medium text-gray-700 dark:text-neutral-300">Project Timeline</p>
                          <p className="text-sm text-gray-600 dark:text-neutral-400">
                            {project.startDate || project.start_date
                              ? new Date(project.startDate || project.start_date).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                              })
                              : 'Not set'}{' '}
                            -{' '}
                            {project.endDate || project.end_date
                              ? new Date(project.endDate || project.end_date).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                              })
                              : 'Not set'}
                          </p>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <User className="text-gray-400 mt-1" size={18} />
                        <div>
                          <p className="text-sm font-medium text-gray-700 dark:text-neutral-300">Project Manager</p>
                          <p className="text-sm text-gray-600 dark:text-neutral-400">{project.manager}</p>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <MapPin className="text-gray-400 mt-1" size={18} />
                        <div>
                          <p className="text-sm font-medium text-gray-700 dark:text-neutral-300">Location</p>
                          <p className="text-sm text-gray-600 dark:text-neutral-400">{project.location?.address || 'N/A'}</p>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <Users className="text-gray-400 mt-1" size={18} />
                        <div>
                          <p className="text-sm font-medium text-gray-700 dark:text-neutral-300">Stakeholders</p>
                          <p className="text-sm text-gray-600 dark:text-neutral-400">
                            {project.stakeholders?.length > 0
                              ? project.stakeholders.join(', ')
                              : 'No stakeholders assigned'}
                          </p>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </motion.div>
            )}

            {activeTab === 'procurements' && (
              <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-4">
                <div className="flex justify-between items-center">
                  <h3 className="text-lg font-bold text-slate-900 dark:text-white">Contractors & Procurements</h3>
                  <Button onClick={() => setIsAddContractorModalOpen(true)} className="bg-primary-950 dark:bg-white hover:bg-primary-900 dark:hover:bg-gray-100 text-white dark:text-primary-950">
                    + Add Contractor
                  </Button>
                </div>

                {contractors && contractors.length > 0 ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {contractors.map((contractor) => (
                      <Card key={contractor.id}>
                        <CardContent className="p-4">
                          <div className="flex items-start justify-between mb-3">
                            <div>
                              <h4 className="font-semibold text-slate-900 dark:text-white">{contractor.contractorName}</h4>
                              <div className="flex items-center gap-1 text-xs text-slate-500 mt-1">
                                <MapPin size={12} /> {contractor.city}, {contractor.state}
                              </div>
                            </div>
                            <span className="p-1.5 bg-slate-100 dark:bg-neutral-800 rounded-lg text-slate-500 dark:text-neutral-400">
                              <Briefcase size={16} />
                            </span>
                          </div>

                          <div className="space-y-2 mt-4 text-sm">
                            <div className="flex justify-between p-2 bg-slate-50 dark:bg-neutral-800 rounded">
                              <span className="text-slate-500 dark:text-neutral-400 text-xs uppercase font-medium">PAN</span>
                              <span className="text-slate-700 dark:text-neutral-300 font-mono tracking-wide">{contractor.panNo}</span>
                            </div>
                            <div className="flex justify-between p-2 bg-slate-50 dark:bg-neutral-800 rounded">
                              <span className="text-slate-500 dark:text-neutral-400 text-xs uppercase font-medium">GSTIN</span>
                              <span className="text-slate-700 dark:text-neutral-300 font-mono tracking-wide">{contractor.gstinNo}</span>
                            </div>
                            <div className="pt-2 flex flex-col gap-1">
                              <span className="flex items-center gap-2 text-slate-600">
                                <User size={14} className="text-slate-400" /> {contractor.email}
                              </span>
                              <span className="flex items-center gap-2 text-slate-600">
                                <DollarSign size={14} className="text-slate-400" /> {contractor.mobile}
                              </span>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                ) : (
                  <div className="border border-dashed border-slate-300 dark:border-neutral-700 rounded-xl p-12 text-center bg-slate-50 dark:bg-neutral-800">
                    <div className="w-16 h-16 bg-slate-100 dark:bg-neutral-700 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                      <Briefcase size={32} />
                    </div>
                    <h4 className="text-slate-900 dark:text-white font-medium mb-1">No Contractors Added</h4>
                    <p className="text-slate-500 dark:text-neutral-400 text-sm mb-4">Add contractors to manage procurements for this project.</p>
                    <Button onClick={() => setIsAddContractorModalOpen(true)} variant="outline">
                      Add Your First Contractor
                    </Button>
                  </div>
                )}
              </motion.div>
            )}

            {activeTab === 'packages' && (
              <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-4">
                <div className="flex justify-between items-center">
                  <h3 className="text-lg font-bold text-slate-900">Work Packages</h3>
                  {/* Contextual create button could go here */}
                </div>

                {packages.filter(p => p.projectId === project.id).length > 0 ? (
                  <div className="grid grid-cols-1 gap-4 max-h-[500px] overflow-y-auto pr-2">
                    {packages.filter(p => p.projectId === project.id).map((pkg) => (
                      <Card key={pkg.id}>
                        <CardContent className="p-4">
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <h4 className="font-semibold text-lg text-slate-900 dark:text-white">{pkg.name}</h4>
                              {pkg.description && <p className="text-sm text-slate-500 mb-2">{pkg.description}</p>}
                            </div>
                            <span className="px-2 py-1 bg-blue-50 text-blue-700 text-xs font-medium rounded-full shrink-0">
                              {pkg.status}
                            </span>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-2 gap-x-4 text-sm text-slate-600 dark:text-neutral-400 bg-slate-50 dark:bg-neutral-800 p-3 rounded-lg">
                            <div className="flex flex-col">
                              <span className="text-xs text-slate-400 dark:text-neutral-500 uppercase font-medium">Contractor</span>
                              <span className="flex items-center gap-1 font-medium text-slate-700 dark:text-neutral-300">
                                <User size={14} className="text-slate-400" /> {pkg.contractor}
                              </span>
                            </div>
                            <div className="flex flex-col">
                              <span className="text-xs text-slate-400 dark:text-neutral-500 uppercase font-medium">Responsible Staff</span>
                              <span className="font-medium text-slate-700 dark:text-neutral-300">{pkg.responsibleStaff || '-'}</span>
                            </div>
                            <div className="flex flex-col">
                              <span className="text-xs text-slate-400 dark:text-neutral-500 uppercase font-medium">Contract Value</span>
                              <span className="flex items-center gap-1 font-medium text-slate-700 dark:text-neutral-300">
                                <DollarSign size={14} className="text-slate-400" /> {formatCurrency(pkg.contractValue || pkg.budget)}
                              </span>
                            </div>
                            <div className="flex flex-col">
                              <span className="text-xs text-slate-400 dark:text-neutral-500 uppercase font-medium">Agreement No.</span>
                              <span className="font-medium text-slate-700 dark:text-neutral-300">{pkg.agreementNo || '-'}</span>
                            </div>
                            <div className="flex flex-col">
                              <span className="text-xs text-slate-400 dark:text-neutral-500 uppercase font-medium">Agreement Date</span>
                              <span className="flex items-center gap-1 font-medium text-slate-700 dark:text-neutral-300">
                                <Calendar size={14} className="text-slate-400" /> {pkg.agreementDate ? new Date(pkg.agreementDate).toLocaleDateString() : '-'}
                              </span>
                            </div>
                            <div className="flex flex-col">
                              <span className="text-xs text-slate-400 dark:text-neutral-500 uppercase font-medium">Due Date</span>
                              <span className="flex items-center gap-1 font-medium text-slate-700 dark:text-neutral-300">
                                <Calendar size={14} className="text-slate-400" /> {pkg.endDate ? new Date(pkg.endDate).toLocaleDateString() : '-'}
                              </span>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                ) : (
                  <div className="border border-dashed border-slate-300 dark:border-neutral-700 rounded-xl p-12 text-center bg-slate-50 dark:bg-neutral-800">
                    <div className="w-16 h-16 bg-slate-100 dark:bg-neutral-700 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                      <FolderOpen size={32} />
                    </div>
                    <h4 className="text-slate-900 dark:text-white font-medium mb-1">No Packages Created Yet</h4>
                    <p className="text-slate-500 dark:text-neutral-400 text-sm mb-4">Create packages from the Projects page to assign work.</p>
                  </div>
                )}
              </motion.div>
            )}

            {activeTab === 'budget' && (
              <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-6">
                {/* Budget Details */}
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <DollarSign size={20} />
                      Budget & Financial Details
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                      <div className="p-4 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                        <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Total Budget</p>
                        <p className="text-xl font-bold text-primary-950 dark:text-white">{formatCurrency(project.budget)}</p>
                      </div>
                      <div className="p-4 bg-warning-50 dark:bg-warning-900/20 rounded-lg">
                        <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Amount Spent</p>
                        <p className="text-xl font-bold text-warning-700 dark:text-warning-500">{formatCurrency(project.spent)}</p>
                      </div>
                      <div className="p-4 bg-success-50 dark:bg-success-900/20 rounded-lg">
                        <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Remaining Budget</p>
                        <p className="text-xl font-bold text-success-700 dark:text-success-500">{formatCurrency(budgetRemaining)}</p>
                      </div>
                      <div className="p-4 bg-gray-50 dark:bg-neutral-800 rounded-lg">
                        <p className="text-sm text-gray-600 dark:text-neutral-400 mb-1">Utilization Rate</p>
                        <p className="text-xl font-bold text-gray-700 dark:text-neutral-300">{budgetUtilization.toFixed(1)}%</p>
                      </div>
                    </div>
                    <DynamicChart
                      data={budgetHistory.map((item) => ({ name: item.month, value: item.spent, budget: item.budget }))}
                      dataKey="value"
                      height={300}
                      defaultType="bar"
                      name="Spent"
                    />
                  </CardContent>
                </Card>
              </motion.div>
            )}

            {activeTab === 'risks' && (
              <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }}>
                {/* Risks Overview */}
                {projectRisks.length > 0 ? (
                  <Card>
                    <CardHeader>
                      <CardTitle>Risk Overview</CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {Object.entries(riskImpactCounts).map(([impact, count]) => {
                          const impactColors = {
                            Low: 'bg-success-50 text-success-700',
                            Medium: 'bg-warning-50 text-warning-700',
                            High: 'bg-accent-50 text-accent-700',
                            Critical: 'bg-error-50 text-error-700',
                          };
                          return (
                            <div key={impact} className="text-center p-4 rounded-lg bg-gray-50">
                              <p className="text-2xl font-bold">{count}</p>
                              <p className={`text-sm mt-1 px-2 py-1 rounded ${impactColors[impact]}`}>
                                {impact}
                              </p>
                            </div>
                          );
                        })}
                      </div>
                    </CardContent>
                  </Card>
                ) : (
                  <EmptyState
                    icon={Target}
                    title="No Risks Identified"
                    description="No risks have been recorded for this project yet."
                  />
                )}
              </motion.div>
            )}

          </div>
        </motion.div>
        <AddContractorModal
          isOpen={isAddContractorModalOpen}
          onClose={() => setIsAddContractorModalOpen(false)}
          onSave={onAddContractor}
        />
      </motion.div>
    </AnimatePresence>
  );
  return createPortal(modalContent, document.body);
};









================================================
FILE: frontend/src/components/projects/ProjectDetailView.jsx
================================================
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import {
    Calendar,
    DollarSign,
    MapPin,
    User,
    TrendingUp,
    TrendingDown,
    FolderOpen,
    Clock,
    Target,
    BarChart3,
    Users,
    Briefcase,
    MessageSquare,
    Shield,
    AlertTriangle,
    Plus,
    ExternalLink,
    Loader2,
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { tasks } from '@/mock';
import { DynamicChart } from '@/components/ui/DynamicChart';
import { getStatusColor } from '@/lib/colors';
import {
    calculateRemainingBudget,
    calculateBudgetUtilization,
    calculateCostVariationPercentage,
} from '@/lib/calculations';
import { EmptyState } from '@/components/ui/EmptyState';
import { AddContractorModal } from '@/components/procurement/AddContractorModal';
import Button from '@/components/ui/Button';
import NewThreadModal from '@/components/communications/NewThreadModal';
import { toast } from 'sonner';
import riskService from '@/api/services/riskService';

export const ProjectDetailView = ({ project, packages = [], contractors = [], onAddContractor }) => {
    const navigate = useNavigate();
    const [activeTab, setActiveTab] = useState('overview');
    const [isAddContractorModalOpen, setIsAddContractorModalOpen] = useState(false);
    const [showNewThread, setShowNewThread] = useState(false);

    // Risk state
    const [projectRisks, setProjectRisks] = useState([]);
    const [risksLoading, setRisksLoading] = useState(false);

    // Fetch project risks
    useEffect(() => {
        const fetchRisks = async () => {
            if (!project?.id) return;
            setRisksLoading(true);
            try {
                const res = await riskService.getProjectRisks(project.id);
                setProjectRisks(res.data || []);
            } catch (err) {
                console.error('Failed to fetch project risks:', err);
            } finally {
                setRisksLoading(false);
            }
        };
        fetchRisks();
    }, [project?.id]);

    if (!project) return null;

    const projectTasks = tasks.filter((task) => task.projectId === project.id);

    const budgetUtilization = calculateBudgetUtilization(project.budget, project.spent);
    const budgetRemaining = calculateRemainingBudget(project.budget, project.spent, 0);
    const costVariancePercentage = calculateCostVariationPercentage(project.budget, project.spent);

    const statusColors = getStatusColor(project.status);

    const formatCurrency = (amount) => {
        if (amount >= 10000000) {
            return `â‚¹${(amount / 10000000).toFixed(2)} Cr`;
        }
        return `â‚¹${(amount / 100000).toFixed(2)} L`;
    };

    // Calculate days remaining
    const endDate = new Date(project.endDate);
    const today = new Date();
    const daysRemaining = Math.ceil((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
    const isOverdue = daysRemaining < 0;

    // Generate progress history (last 6 months)
    const progressHistory = Array.from({ length: 6 }, (_, i) => {
        const date = new Date();
        date.setMonth(date.getMonth() - (5 - i));
        const monthName = date.toLocaleDateString('en-US', { month: 'short' });
        const baseProgress = project.progress;
        const variation = (Math.random() - 0.5) * 15;
        return {
            month: monthName,
            progress: Math.max(0, Math.min(100, baseProgress + variation)),
        };
    });

    // Generate budget history
    const budgetHistory = Array.from({ length: 6 }, (_, i) => {
        const date = new Date();
        date.setMonth(date.getMonth() - (5 - i));
        const monthName = date.toLocaleDateString('en-US', { month: 'short' });
        const monthlySpend = project.spent / 6;
        return {
            month: monthName,
            spent: monthlySpend * (i + 1),
            budget: (project.budget / 6) * (i + 1),
        };
    });

    const taskStatusCounts = projectTasks.reduce(
        (acc, task) => {
            acc[task.status] = (acc[task.status] || 0) + 1;
            return acc;
        },
        {}
    );

    // Count risks by severity from real data
    const riskSeverityCounts = projectRisks.reduce(
        (acc, risk) => {
            const sev = risk.severity || 'LOW';
            acc[sev] = (acc[sev] || 0) + 1;
            return acc;
        },
        {}
    );

    return (
        <div className="w-full h-full bg-app-card rounded-lg shadow-sm">
            {/* Header */}
            <div className="sticky top-0 z-10 bg-app-card border-b border-app-subtle px-6 py-4 flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <div className={`p-3 rounded-full ${statusColors.bg}`}>
                        <FolderOpen className={statusColors.text} size={28} />
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold text-app-heading">{project.name}</h2>
                        <div className="flex items-center gap-2 mt-1">
                            <span className="text-sm text-app-muted">{project.category}</span>
                            <span className="w-1 h-1 bg-app-subtle rounded-full"></span>
                            <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${statusColors.bg} ${statusColors.text}`}>
                                {project.status}
                            </span>
                        </div>
                    </div>
                </div>
                {/* Actions */}
                <Button
                    variant="outline"
                    onClick={() => setShowNewThread(true)}
                    className="bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100 dark:bg-blue-900/30 dark:border-blue-800 dark:text-blue-300 dark:hover:bg-blue-900/50"
                >
                    <MessageSquare size={16} className="mr-2" /> Discuss Project
                </Button>
            </div>

            {/* Tab Navigation */}
            <div className="px-6 border-b border-app-subtle bg-app-card sticky top-[88px] z-10">
                <div className="flex gap-6">
                    {['Overview', 'Packages', 'Procurements', 'Budget', 'Risks'].map((tab) => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab.toLowerCase())}
                            className={`py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === tab.toLowerCase()
                                ? 'border-primary-600 text-primary-600 dark:text-primary-400'
                                : 'border-transparent text-app-muted hover:text-app-heading'
                                }`}
                        >
                            {tab}
                        </button>
                    ))}
                </div>
            </div>


            {/* Content */}
            <div className="p-6 space-y-6">

                {activeTab === 'overview' && (
                    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-6">
                        {/* Key Metrics Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <Card>
                                <CardContent className="p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm text-app-muted mb-1">Project Progress</p>
                                            <p className="text-2xl font-bold text-app-heading">{project.progress}%</p>
                                        </div>
                                        <Target className="text-primary-600" size={32} />
                                    </div>
                                    <div className="mt-3 w-full h-2 bg-app-secondary rounded-full">
                                        <div
                                            className={`h-2 rounded-full ${project.progress === 100
                                                ? 'bg-success-600'
                                                : project.progress >= 50
                                                    ? 'bg-primary-600'
                                                    : 'bg-warning-500'
                                                }`}
                                            style={{ width: `${project.progress}%` }}
                                        />
                                    </div>
                                </CardContent>
                            </Card>

                            <Card>
                                <CardContent className="p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm text-app-muted mb-1">Budget Utilization</p>
                                            <p className="text-2xl font-bold text-app-heading">{budgetUtilization.toFixed(1)}%</p>
                                        </div>
                                        <DollarSign className="text-primary-600" size={32} />
                                    </div>
                                    <div className="mt-3 w-full h-2 bg-app-secondary rounded-full">
                                        <div
                                            className={`h-2 rounded-full ${budgetUtilization > 90
                                                ? 'bg-error-600'
                                                : budgetUtilization > 75
                                                    ? 'bg-warning-500'
                                                    : 'bg-success-600'
                                                }`}
                                            style={{ width: `${Math.min(budgetUtilization, 100)}%` }}
                                        />
                                    </div>
                                </CardContent>
                            </Card>

                            <Card>
                                <CardContent className="p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm text-app-muted mb-1">Days Remaining</p>
                                            <p className={`text-2xl font-bold ${isOverdue ? 'text-error-600' : 'text-app-heading'}`}>
                                                {Math.abs(daysRemaining)}
                                            </p>
                                        </div>
                                        <Clock className="text-app-muted" size={32} />
                                    </div>
                                    <p className={`text-xs mt-2 ${isOverdue ? 'text-error-600' : 'text-app-muted'}`}>
                                        {isOverdue ? 'Overdue' : 'On Schedule'}
                                    </p>
                                </CardContent>
                            </Card>

                            <Card>
                                <CardContent className="p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm text-app-muted mb-1">Cost Variation</p>
                                            <p
                                                className={`text-2xl font-bold ${costVariancePercentage > 0 ? 'text-error-600' : 'text-success-600'
                                                    }`}
                                            >
                                                {costVariancePercentage > 0 ? '+' : ''}
                                                {costVariancePercentage.toFixed(1)}%
                                            </p>
                                        </div>
                                        {costVariancePercentage > 0 ? (
                                            <TrendingUp className="text-error-600" size={32} />
                                        ) : (
                                            <TrendingDown className="text-success-600" size={32} />
                                        )}
                                    </div>
                                </CardContent>
                            </Card>
                        </div>

                        {/* Project Overview */}
                        <Card>
                            <CardHeader>
                                <CardTitle className="flex items-center gap-2">
                                    <BarChart3 size={20} />
                                    Project Overview
                                </CardTitle>
                            </CardHeader>
                            <CardContent className="space-y-4">
                                <p className="text-app-text leading-relaxed">{project.description}</p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-app-subtle">
                                    <div className="flex items-start gap-3">
                                        <Calendar className="text-app-muted mt-1" size={18} />
                                        <div>
                                            <p className="text-sm font-medium text-app-heading">Project Timeline</p>
                                            <p className="text-sm text-app-muted">
                                                {new Date(project.startDate).toLocaleDateString('en-US', {
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric',
                                                })}{' '}
                                                -{' '}
                                                {new Date(project.endDate).toLocaleDateString('en-US', {
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric',
                                                })}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <User className="text-app-muted mt-1" size={18} />
                                        <div>
                                            <p className="text-sm font-medium text-app-heading">Project Manager</p>
                                            <p className="text-sm text-app-muted">{project.manager}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <MapPin className="text-app-muted mt-1" size={18} />
                                        <div>
                                            <p className="text-sm font-medium text-app-heading">Location</p>
                                            <p className="text-sm text-app-muted">{project.location?.address || 'N/A'}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <Users className="text-app-muted mt-1" size={18} />
                                        <div>
                                            <p className="text-sm font-medium text-app-heading">Stakeholders</p>
                                            <p className="text-sm text-app-muted">
                                                {project.stakeholders?.length > 0
                                                    ? project.stakeholders.join(', ')
                                                    : 'No stakeholders assigned'}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    </motion.div>
                )}

                {activeTab === 'procurements' && (
                    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h3 className="text-lg font-bold text-app-heading">Contractors & Procurements</h3>
                            <Button
                                onClick={() => setIsAddContractorModalOpen(true)}
                                className="bg-primary-950 text-white hover:bg-primary-900 shadow-lg shadow-primary-950/20 flex items-center gap-2"
                            >
                                + Add Contractor
                            </Button>
                        </div>

                        {contractors && contractors.length > 0 ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {contractors.map((contractor) => (
                                    <Card key={contractor.id}>
                                        <CardContent className="p-4">
                                            <div className="flex items-start justify-between mb-3">
                                                <div>
                                                    <h4 className="font-semibold text-app-heading">{contractor.contractorName}</h4>
                                                    <div className="flex items-center gap-1 text-xs text-app-muted mt-1">
                                                        <MapPin size={12} /> {contractor.city}, {contractor.state}
                                                    </div>
                                                </div>
                                                <span className="p-1.5 bg-app-secondary rounded-lg text-app-muted">
                                                    <Briefcase size={16} />
                                                </span>
                                            </div>

                                            <div className="space-y-2 mt-4 text-sm">
                                                <div className="flex justify-between p-2 bg-app-secondary rounded">
                                                    <span className="text-app-muted text-xs uppercase font-medium">PAN</span>
                                                    <span className="text-app-text font-mono tracking-wide">{contractor.panNo}</span>
                                                </div>
                                                <div className="flex justify-between p-2 bg-app-secondary rounded">
                                                    <span className="text-app-muted text-xs uppercase font-medium">GSTIN</span>
                                                    <span className="text-app-text font-mono tracking-wide">{contractor.gstinNo}</span>
                                                </div>
                                                <div className="pt-2 flex flex-col gap-1">
                                                    <span className="flex items-center gap-2 text-app-muted">
                                                        <User size={14} className="text-app-muted" /> {contractor.email}
                                                    </span>
                                                    <span className="flex items-center gap-2 text-app-muted">
                                                        <DollarSign size={14} className="text-app-muted" /> {contractor.mobile}
                                                    </span>
                                                </div>
                                            </div>
                                        </CardContent>
                                    </Card>
                                ))}
                            </div>
                        ) : (
                            <div className="border border-dashed border-app-subtle rounded-xl p-12 text-center bg-app-secondary">
                                <div className="w-16 h-16 bg-app-surface rounded-full flex items-center justify-center mx-auto mb-4 text-app-muted">
                                    <Briefcase size={32} />
                                </div>
                                <h4 className="text-app-heading font-medium mb-1">No Contractors Added</h4>
                                <p className="text-app-muted text-sm mb-4">Add contractors to manage procurements for this project.</p>
                                <button
                                    onClick={() => setIsAddContractorModalOpen(true)}
                                    className="px-4 py-2 border border-app rounded-lg text-sm font-medium text-app-text hover:bg-app-surface transition-colors"
                                >
                                    Add Your First Contractor
                                </button>
                            </div>
                        )}
                    </motion.div>
                )}

                {activeTab === 'packages' && (
                    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-4">
                        <div className="flex justify-between items-center">
                            <h3 className="text-lg font-bold text-app-heading">Work Packages</h3>
                            {/* Contextual create button - we might want to reinject the create logic purely for context later, for now just view */}
                        </div>

                        {packages.filter(p => p.projectId === project.id).length > 0 ? (
                            <div className="grid grid-cols-1 gap-4">
                                {packages.filter(p => p.projectId === project.id).map((pkg) => (
                                    <Card key={pkg.id}>
                                        <CardContent className="p-4">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h4 className="font-semibold text-lg text-app-heading">{pkg.name}</h4>
                                                    {pkg.description && <p className="text-sm text-app-muted mb-2">{pkg.description}</p>}
                                                </div>
                                                <span className="px-2 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs font-medium rounded-full shrink-0">
                                                    {pkg.status}
                                                </span>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-2 gap-x-4 text-sm text-app-text bg-app-secondary p-3 rounded-lg">
                                                <div className="flex flex-col">
                                                    <span className="text-xs text-app-muted uppercase font-medium">Contractor</span>
                                                    <span className="flex items-center gap-1 font-medium text-app-heading">
                                                        <User size={14} className="text-app-muted" /> {pkg.contractor}
                                                    </span>
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-xs text-app-muted uppercase font-medium">Responsible Staff</span>
                                                    <span className="font-medium text-app-heading">{pkg.responsibleStaff || '-'}</span>
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-xs text-app-muted uppercase font-medium">Contract Value</span>
                                                    <span className="flex items-center gap-1 font-medium text-app-heading">
                                                        <DollarSign size={14} className="text-app-muted" /> {formatCurrency(pkg.contractValue || pkg.budget)}
                                                    </span>
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-xs text-app-muted uppercase font-medium">Agreement No.</span>
                                                    <span className="font-medium text-app-heading">{pkg.agreementNo || '-'}</span>
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-xs text-app-muted uppercase font-medium">Agreement Date</span>
                                                    <span className="flex items-center gap-1 font-medium text-app-heading">
                                                        <Calendar size={14} className="text-app-muted" /> {pkg.agreementDate ? new Date(pkg.agreementDate).toLocaleDateString() : '-'}
                                                    </span>
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-xs text-app-muted uppercase font-medium">Due Date</span>
                                                    <span className="flex items-center gap-1 font-medium text-app-heading">
                                                        <Calendar size={14} className="text-app-muted" /> {pkg.endDate ? new Date(pkg.endDate).toLocaleDateString() : '-'}
                                                    </span>
                                                </div>
                                            </div>


                                        </CardContent>
                                    </Card>
                                ))}
                            </div>
                        ) : (
                            <div className="border border-dashed border-app-subtle rounded-xl p-12 text-center bg-app-secondary">
                                <div className="w-16 h-16 bg-app-surface rounded-full flex items-center justify-center mx-auto mb-4 text-app-muted">
                                    <FolderOpen size={32} />
                                </div>
                                <h4 className="text-app-heading font-medium mb-1">No Packages Created Yet</h4>
                                <p className="text-app-muted text-sm mb-4">Create packages from the Projects page to assign work.</p>
                            </div>
                        )}
                    </motion.div>
                )}

                {activeTab === 'budget' && (
                    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-6">
                        {/* Budget Details */}
                        <Card>
                            <CardHeader>
                                <CardTitle className="flex items-center gap-2">
                                    <DollarSign size={20} />
                                    Budget & Financial Details
                                </CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <div className="p-4 bg-primary-50 dark:bg-primary-900/10 rounded-lg">
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Total Budget</p>
                                        <p className="text-xl font-bold text-primary-950 dark:text-primary-100">{formatCurrency(project.budget)}</p>
                                    </div>
                                    <div className="p-4 bg-warning-50 dark:bg-yellow-900/10 rounded-lg">
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Amount Spent</p>
                                        <p className="text-xl font-bold text-warning-700 dark:text-yellow-400">{formatCurrency(project.spent)}</p>
                                    </div>
                                    <div className="p-4 bg-success-50 dark:bg-green-900/10 rounded-lg">
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Remaining Budget</p>
                                        <p className="text-xl font-bold text-success-700 dark:text-green-400">{formatCurrency(budgetRemaining)}</p>
                                    </div>
                                    <div className="p-4 bg-gray-50 dark:bg-neutral-800 rounded-lg">
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Utilization Rate</p>
                                        <p className="text-xl font-bold text-gray-700 dark:text-gray-200">{budgetUtilization.toFixed(1)}%</p>
                                    </div>
                                </div>
                                <DynamicChart
                                    data={budgetHistory.map((item) => ({ name: item.month, value: item.spent, budget: item.budget }))}
                                    dataKey="value"
                                    height={300}
                                    defaultType="bar"
                                    name="Spent"
                                />
                            </CardContent>
                        </Card>
                    </motion.div>
                )}

                {activeTab === 'risks' && (
                    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="space-y-4">
                        {/* Header */}
                        <div className="flex justify-between items-center">
                            <h3 className="text-lg font-bold text-app-heading flex items-center gap-2">
                                <Shield size={20} className="text-orange-500" />
                                Project Risks
                            </h3>
                            <Button
                                onClick={() => navigate(`/risk?project=${project.id}`)}
                                className="bg-orange-600 text-white hover:bg-orange-700 flex items-center gap-2"
                            >
                                <Plus size={16} /> Add Risk
                            </Button>
                        </div>

                        {risksLoading ? (
                            <div className="flex items-center justify-center py-12">
                                <Loader2 className="animate-spin text-primary-600" size={32} />
                            </div>
                        ) : projectRisks.length > 0 ? (
                            <>
                                {/* Risk Summary Cards */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'].map((severity) => {
                                        const count = riskSeverityCounts[severity] || 0;
                                        const colors = {
                                            CRITICAL: 'bg-red-50 text-red-700 border-red-200 dark:bg-red-900/20 dark:text-red-300 dark:border-red-800',
                                            HIGH: 'bg-orange-50 text-orange-700 border-orange-200 dark:bg-orange-900/20 dark:text-orange-300 dark:border-orange-800',
                                            MEDIUM: 'bg-yellow-50 text-yellow-700 border-yellow-200 dark:bg-yellow-900/20 dark:text-yellow-300 dark:border-yellow-800',
                                            LOW: 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-300 dark:border-green-800',
                                        };
                                        return (
                                            <div key={severity} className={`text-center p-4 rounded-lg border ${colors[severity]}`}>
                                                <p className="text-3xl font-bold">{count}</p>
                                                <p className="text-sm font-medium mt-1">{severity}</p>
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* Risk List */}
                                <Card>
                                    <CardHeader>
                                        <CardTitle className="text-base">Active Risks</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-3">
                                        {projectRisks.slice(0, 10).map((risk) => {
                                            const sevColors = riskService.getSeverityColor(risk.severity);
                                            const statusColors = riskService.getStatusColor(risk.status);
                                            return (
                                                <div
                                                    key={risk.id}
                                                    className="p-3 bg-app-secondary rounded-lg border border-app-subtle hover:border-primary-300 cursor-pointer transition-colors"
                                                    onClick={() => navigate(`/risk?risk=${risk.id}`)}
                                                >
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className="text-xs text-app-muted font-mono">{risk.risk_code}</span>
                                                                <span className={`px-2 py-0.5 rounded-full text-xs ${sevColors.bg} ${sevColors.text}`}>
                                                                    {risk.severity}
                                                                </span>
                                                                <span className={`px-2 py-0.5 rounded-full text-xs ${statusColors.bg} ${statusColors.text}`}>
                                                                    {risk.status}
                                                                </span>
                                                            </div>
                                                            <h4 className="font-medium text-app-heading">{risk.title}</h4>
                                                            <p className="text-sm text-app-muted mt-1 line-clamp-1">{risk.description}</p>
                                                        </div>
                                                        <div className="text-right ml-4">
                                                            <div className="text-2xl font-bold text-app-heading">{risk.risk_score}</div>
                                                            <div className="text-xs text-app-muted">Score</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {projectRisks.length > 10 && (
                                            <button
                                                onClick={() => navigate(`/risk?project=${project.id}`)}
                                                className="w-full py-2 text-primary-600 hover:text-primary-700 text-sm font-medium flex items-center justify-center gap-1"
                                            >
                                                View all {projectRisks.length} risks <ExternalLink size={14} />
                                            </button>
                                        )}
                                    </CardContent>
                                </Card>
                            </>
                        ) : (
                            <div className="border border-dashed border-app-subtle rounded-xl p-12 text-center bg-app-secondary">
                                <div className="w-16 h-16 bg-orange-100 dark:bg-orange-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <AlertTriangle size={32} className="text-orange-500" />
                                </div>
                                <h4 className="text-app-heading font-medium mb-1">No Risks Identified</h4>
                                <p className="text-app-muted text-sm mb-4">Start tracking potential risks for this project.</p>
                                <Button
                                    onClick={() => navigate(`/risk?project=${project.id}`)}
                                    variant="outline"
                                >
                                    <Plus size={16} className="mr-1" /> Add First Risk
                                </Button>
                            </div>
                        )}
                    </motion.div>
                )}

            </div>
            {/* Add Contractor Modal */}
            <AddContractorModal
                isOpen={isAddContractorModalOpen}
                onClose={() => setIsAddContractorModalOpen(false)}
                onSave={onAddContractor}
            />

            {/* Communications Modal */}
            {showNewThread && (
                <NewThreadModal
                    onClose={() => setShowNewThread(false)}
                    onCreated={(thread) => {
                        setShowNewThread(false);
                        toast.success(`Discussion thread created: ${thread.subject}`);
                    }}
                    preselectedContext={{
                        type: 'projects.project',
                        id: project.id
                    }}
                />
            )}
        </div>
    );
};



================================================
FILE: frontend/src/components/risks/CreateRiskModal.jsx
================================================
import { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { X, AlertTriangle, ChevronRight, ChevronLeft, Save, Loader2, Upload, Check, FileText, Trash2 } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import riskService from '@/api/services/riskService';
import Button from '@/components/ui/Button';
import { useModalClose } from '@/hooks/useModalClose';
import { toast } from 'sonner';

/**
 * Multi-step modal for creating or editing a risk.
 * Steps: 1. Basic Info, 2. Assessment, 3. Response Plan
 */
const CreateRiskModal = ({ isOpen, onClose, onSuccess, projects, editingRisk = null }) => {
    const isEditing = !!editingRisk;

    // Form state
    const [step, setStep] = useState(1);
    const [loading, setSaving] = useState(false);
    const [error, setError] = useState(null);

    // Use standard hook for Escape key closing
    useModalClose(isOpen, onClose);

    // Form data
    const [formData, setFormData] = useState({
        // Step 1: Basic Info
        title: '',
        description: '',
        project: '',
        category: 'OTHER',
        risk_source: 'INTERNAL',

        // Step 2: Assessment
        probability: 3,
        impact: 3,
        status: 'IDENTIFIED',
        target_resolution: '',
        owner: '',

        // Step 3: Response Plan
        response_strategy: '',
        mitigation_plan: '',
        contingency_plan: '',
        cost_impact: '',
        schedule_impact_days: '',

        // Proof document
        proofDocument: null
    });

    // Drag and drop state
    const [isDragging, setIsDragging] = useState(false);
    const dropRef = useRef(null);

    // Reset form when modal opens/closes
    useEffect(() => {
        if (!isOpen) {
            setStep(1);
            setError(null);
            if (!editingRisk) {
                setFormData({
                    title: '',
                    description: '',
                    project: '',
                    category: 'OTHER',
                    risk_source: 'INTERNAL',
                    probability: 3,
                    impact: 3,
                    status: 'IDENTIFIED',
                    target_resolution: '',
                    owner: '',
                    response_strategy: '',
                    mitigation_plan: '',
                    contingency_plan: '',
                    cost_impact: '',
                    schedule_impact_days: '',
                    proofDocument: null
                });
            }
        }
    }, [isOpen, editingRisk]);

    // Initialize with editing risk data
    useEffect(() => {
        if (editingRisk) {
            setFormData({
                title: editingRisk.title || '',
                description: editingRisk.description || '',
                project: editingRisk.project || '',
                category: editingRisk.category || 'OTHER',
                risk_source: editingRisk.risk_source || 'INTERNAL',
                probability: editingRisk.probability || 3,
                impact: editingRisk.impact || 3,
                status: editingRisk.status || 'IDENTIFIED',
                target_resolution: editingRisk.target_resolution || '',
                owner: editingRisk.owner || '',
                response_strategy: editingRisk.response_strategy || '',
                mitigation_plan: editingRisk.mitigation_plan || '',
                contingency_plan: editingRisk.contingency_plan || '',
                cost_impact: editingRisk.cost_impact || '',
                schedule_impact_days: editingRisk.schedule_impact_days || ''
            });
        }
    }, [editingRisk]);

    // Calculate risk score
    const riskScore = formData.probability * formData.impact;
    const severity = riskService.getSeverityFromScore(riskScore);
    const severityColors = riskService.getSeverityColor(severity);

    // Handle input change
    const handleChange = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
        setError(null);
    };

    // Navigation
    const canProceed = () => {
        if (step === 1) {
            // Require proof document when creating a new risk
            return formData.title && formData.project && formData.description && (isEditing || formData.proofDocument);
        }
        if (step === 2) {
            return formData.probability && formData.impact;
        }
        return true;
    };

    const nextStep = () => {
        if (step < 3 && canProceed()) setStep(step + 1);
    };

    const prevStep = () => {
        if (step > 1) setStep(step - 1);
    };

    // Submit form
    const handleSubmit = async () => {
        if (!canProceed()) return;

        setSaving(true);
        setError(null);

        try {
            const payload = {
                ...formData,
                cost_impact: formData.cost_impact ? parseFloat(formData.cost_impact) : 0,
                schedule_impact_days: formData.schedule_impact_days ? parseInt(formData.schedule_impact_days) : 0
            };

            // Remove empty optional fields
            if (!payload.owner) delete payload.owner;
            if (!payload.target_resolution) delete payload.target_resolution;
            if (!payload.response_strategy) delete payload.response_strategy;

            let response;
            if (isEditing) {
                response = await riskService.updateRisk(editingRisk.id, payload);
            } else {
                response = await riskService.createRisk(payload);
            }

            onSuccess(response.data);
        } catch (err) {
            console.error('Failed to save risk:', err);
            setError(err.response?.data?.detail || 'Failed to save risk. Please try again.');
        } finally {
            setSaving(false);
        }
    };

    // Common input classes matching website UI
    const inputClasses = "w-full px-3 py-2.5 rounded-lg border border-app bg-app-input text-app-text text-sm focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-indigo-500/30 outline-none transition-all";
    const labelClasses = "block text-sm font-medium text-app-text mb-1.5";
    const errorClasses = "text-xs text-red-500 dark:text-red-400 mt-1";

    // Risk matrix component
    const RiskMatrix = () => {
        const matrix = [];
        for (let p = 5; p >= 1; p--) {
            const row = [];
            for (let i = 1; i <= 5; i++) {
                const score = p * i;
                const sev = riskService.getSeverityFromScore(score);
                const colors = riskService.getSeverityColor(sev);
                const isSelected = formData.probability === p && formData.impact === i;
                row.push(
                    <button
                        key={`${p}-${i}`}
                        type="button"
                        onClick={() => {
                            handleChange('probability', p);
                            handleChange('impact', i);
                        }}
                        className={`
                            w-10 h-10 text-xs font-bold rounded-md transition-all
                            ${colors.bg} ${colors.text} ${colors.border}
                            ${isSelected ? 'ring-2 ring-offset-2 ring-primary-500 scale-110' : 'hover:scale-105'}
                        `}
                    >
                        {score}
                    </button>
                );
            }
            matrix.push(
                <div key={p} className="flex gap-1 items-center">
                    <span className="w-6 text-xs text-app-muted text-right">{p}</span>
                    {row}
                </div>
            );
        }
        return (
            <div className="p-4 bg-app-surface rounded-lg">
                <div className="flex flex-col gap-1">
                    {matrix}
                    <div className="flex gap-1 mt-1 pl-7">
                        {[1, 2, 3, 4, 5].map(i => (
                            <span key={i} className="w-10 text-center text-xs text-app-muted">{i}</span>
                        ))}
                    </div>
                </div>
                <div className="flex justify-between mt-4 text-xs text-app-muted">
                    <span>Impact â†’</span>
                    <span>â†‘ Probability</span>
                </div>
            </div>
        );
    };

    if (!isOpen) return null;

    return createPortal(
        <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-[9999] flex items-center justify-center bg-app-overlay backdrop-blur-sm p-4"
        >
            <motion.div
                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.95, y: 20 }}
                className="w-full max-w-2xl bg-app-card rounded-xl sm:rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[95vh] sm:max-h-[90vh]"
                onClick={(e) => e.stopPropagation()}
            >
                {/* Header */}
                <div className="p-4 sm:p-6 border-b border-app-subtle flex justify-between items-center bg-app-card z-10">
                    <div>
                        <h2 className="text-xl sm:text-2xl font-bold text-app-heading flex items-center gap-2">
                            <AlertTriangle className="text-amber-500" size={24} />
                            {isEditing ? 'Edit Risk' : 'Register New Risk'}
                        </h2>
                        <p className="text-xs sm:text-sm text-app-muted">
                            Step {step} of 3: {step === 1 ? 'Basic Information' : step === 2 ? 'Risk Assessment' : 'Response Plan'}
                        </p>
                    </div>
                    <button
                        onClick={onClose}
                        className="p-2 hover:bg-app-surface rounded-full transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center"
                    >
                        <X size={24} className="text-app-muted" />
                    </button>
                </div>

                {/* Progress Bar */}
                <div className="h-1 w-full bg-app-surface">
                    <motion.div
                        className="h-full bg-primary-600"
                        initial={{ width: 0 }}
                        animate={{ width: `${(step / 3) * 100}%` }}
                        transition={{ duration: 0.3 }}
                    />
                </div>

                {/* Form Content */}
                <div className="flex-1 overflow-y-auto p-4 sm:p-6">
                    {error && (
                        <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-700 dark:text-red-300 text-sm">
                            {error}
                        </div>
                    )}

                    <AnimatePresence mode="wait">
                        <motion.div
                            key={step}
                            initial={{ x: 20, opacity: 0 }}
                            animate={{ x: 0, opacity: 1 }}
                            exit={{ x: -20, opacity: 0 }}
                            transition={{ duration: 0.2 }}
                            className="space-y-6"
                        >
                            {/* Step 1: Basic Info */}
                            {step === 1 && (
                                <div className="space-y-4">
                                    <div>
                                        <label className={labelClasses}>
                                            Project <span className="text-red-500">*</span>
                                        </label>
                                        <div className="relative">
                                            <select
                                                value={formData.project}
                                                onChange={(e) => handleChange('project', e.target.value)}
                                                className={`${inputClasses} appearance-none cursor-pointer`}
                                            >
                                                <option value="">Select a project</option>
                                                {projects && projects.length > 0 ? (
                                                    projects.map(p => (
                                                        <option key={p.id} value={p.id}>{p.name}</option>
                                                    ))
                                                ) : (
                                                    <option disabled>No projects available</option>
                                                )}
                                            </select>
                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                                                <ChevronRight size={16} className="text-app-muted rotate-90" />
                                            </div>
                                        </div>
                                        {(!projects || projects.length === 0) && (
                                            <p className="text-xs text-amber-600 dark:text-amber-400 mt-1">
                                                No projects found. Please create a project first.
                                            </p>
                                        )}
                                    </div>

                                    <div>
                                        <label className={labelClasses}>
                                            Risk Title <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.title}
                                            onChange={(e) => handleChange('title', e.target.value)}
                                            placeholder="Brief risk title (e.g., 'Monsoon delay risk')"
                                            className={inputClasses}
                                        />
                                    </div>

                                    <div>
                                        <label className={labelClasses}>
                                            Description <span className="text-red-500">*</span>
                                        </label>
                                        <textarea
                                            value={formData.description}
                                            onChange={(e) => handleChange('description', e.target.value)}
                                            placeholder="Detailed description of the risk..."
                                            rows={4}
                                            className={inputClasses}
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={labelClasses}>Category</label>
                                            <select
                                                value={formData.category}
                                                onChange={(e) => handleChange('category', e.target.value)}
                                                className={`${inputClasses} appearance-none cursor-pointer`}
                                            >
                                                {riskService.CATEGORIES.map(c => (
                                                    <option key={c.value} value={c.value}>{c.label}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className={labelClasses}>Risk Source</label>
                                            <select
                                                value={formData.risk_source}
                                                onChange={(e) => handleChange('risk_source', e.target.value)}
                                                className={`${inputClasses} appearance-none cursor-pointer`}
                                            >
                                                <option value="INTERNAL">Internal</option>
                                                <option value="EXTERNAL">External</option>
                                            </select>
                                        </div>
                                    </div>

                                    {/* Proof Document Upload - Required */}
                                    <div>
                                        <label className={labelClasses}>
                                            Proof Document <span className="text-red-500">*</span>
                                        </label>
                                        <p className="text-xs text-app-muted mb-2">Upload photos, reports, or documents supporting the risk identification</p>
                                        <div
                                            ref={dropRef}
                                            onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                                            onDragLeave={() => setIsDragging(false)}
                                            onDrop={(e) => {
                                                e.preventDefault();
                                                setIsDragging(false);
                                                const file = e.dataTransfer.files?.[0];
                                                if (file) {
                                                    handleChange('proofDocument', file);
                                                    toast.success('Document attached successfully');
                                                }
                                            }}
                                            onClick={() => document.getElementById('risk-proof-upload').click()}
                                            className={`p-6 border-2 border-dashed rounded-xl flex flex-col items-center justify-center text-center transition-colors cursor-pointer ${isDragging ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/30' :
                                                    formData.proofDocument ? 'border-green-500 dark:border-green-600 bg-green-50 dark:bg-green-900/20' :
                                                        'border-app-subtle hover:border-app-muted hover:bg-app-surface'
                                                }`}
                                        >
                                            <input
                                                id="risk-proof-upload"
                                                type="file"
                                                className="hidden"
                                                accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif"
                                                onChange={(e) => {
                                                    const file = e.target.files?.[0];
                                                    if (file) {
                                                        handleChange('proofDocument', file);
                                                        toast.success('Document attached successfully');
                                                    }
                                                }}
                                            />
                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center mb-3 ${formData.proofDocument ? 'bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-400' :
                                                    isDragging ? 'bg-primary-100 dark:bg-primary-900/50 text-primary-600 dark:text-primary-400' :
                                                        'bg-app-subtle text-app-muted'
                                                }`}>
                                                {formData.proofDocument ? <Check size={24} /> : <Upload size={24} />}
                                            </div>
                                            {formData.proofDocument ? (
                                                <>
                                                    <p className="font-medium text-green-700 dark:text-green-400">Document Selected</p>
                                                    <div className="flex items-center gap-2 mt-1">
                                                        <FileText size={14} className="text-green-600 dark:text-green-500" />
                                                        <p className="text-sm text-green-600 dark:text-green-500">{formData.proofDocument.name}</p>
                                                    </div>
                                                    <button
                                                        type="button"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            handleChange('proofDocument', null);
                                                        }}
                                                        className="mt-2 text-xs text-red-500 hover:text-red-700 flex items-center gap-1"
                                                    >
                                                        <Trash2 size={12} /> Remove
                                                    </button>
                                                </>
                                            ) : (
                                                <>
                                                    <p className="font-medium text-app-heading">Upload Proof Document</p>
                                                    <p className="text-sm text-app-muted mt-1">
                                                        {isDragging ? 'Drop file here' : 'Drag and drop or click to browse'}
                                                    </p>
                                                    <p className="text-xs text-app-muted mt-2">Supported: PDF, DOC, DOCX, JPG, PNG</p>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Step 2: Risk Assessment */}
                            {step === 2 && (
                                <div className="space-y-6">
                                    <div>
                                        <label className={labelClasses}>Risk Assessment Matrix</label>
                                        <p className="text-sm text-app-muted mb-4">
                                            Click on a cell to set probability (vertical) and impact (horizontal)
                                        </p>
                                        <RiskMatrix />
                                    </div>

                                    <div className="flex items-center justify-center gap-6 py-4 bg-app-surface rounded-lg">
                                        <div className="text-center">
                                            <div className="text-sm text-app-muted mb-1">Risk Score</div>
                                            <div className={`text-4xl font-bold ${severityColors.text}`}>
                                                {riskScore}
                                            </div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-sm text-app-muted mb-1">Severity</div>
                                            <span className={`px-4 py-2 rounded-full text-lg font-medium ${severityColors.bg} ${severityColors.text}`}>
                                                {severity}
                                            </span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={labelClasses}>Status</label>
                                            <select
                                                value={formData.status}
                                                onChange={(e) => handleChange('status', e.target.value)}
                                                className={`${inputClasses} appearance-none cursor-pointer`}
                                            >
                                                {riskService.STATUSES.map(s => (
                                                    <option key={s.value} value={s.value}>{s.label}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className={labelClasses}>Target Resolution Date</label>
                                            <input
                                                type="date"
                                                value={formData.target_resolution}
                                                onChange={(e) => handleChange('target_resolution', e.target.value)}
                                                className={inputClasses}
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Step 3: Response Plan */}
                            {step === 3 && (
                                <div className="space-y-4">
                                    <div>
                                        <label className={labelClasses}>Response Strategy</label>
                                        <div className="grid grid-cols-5 gap-2">
                                            {riskService.RESPONSE_STRATEGIES.map(s => (
                                                <button
                                                    key={s.value}
                                                    type="button"
                                                    onClick={() => handleChange('response_strategy', s.value)}
                                                    className={`
                                                        px-3 py-2 text-sm rounded-lg border transition-all
                                                        ${formData.response_strategy === s.value
                                                            ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400'
                                                            : 'border-app bg-app-surface text-app-muted hover:border-app-muted'}
                                                    `}
                                                >
                                                    {s.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <label className={labelClasses}>Mitigation Plan</label>
                                        <textarea
                                            value={formData.mitigation_plan}
                                            onChange={(e) => handleChange('mitigation_plan', e.target.value)}
                                            placeholder="Describe actions to reduce probability or impact..."
                                            rows={3}
                                            className={inputClasses}
                                        />
                                    </div>

                                    <div>
                                        <label className={labelClasses}>Contingency Plan</label>
                                        <textarea
                                            value={formData.contingency_plan}
                                            onChange={(e) => handleChange('contingency_plan', e.target.value)}
                                            placeholder="Describe actions if risk materializes..."
                                            rows={3}
                                            className={inputClasses}
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className={labelClasses}>Cost Impact (â‚¹)</label>
                                            <input
                                                type="number"
                                                value={formData.cost_impact}
                                                onChange={(e) => handleChange('cost_impact', e.target.value)}
                                                placeholder="Estimated financial impact"
                                                className={inputClasses}
                                            />
                                        </div>

                                        <div>
                                            <label className={labelClasses}>Schedule Impact (days)</label>
                                            <input
                                                type="number"
                                                value={formData.schedule_impact_days}
                                                onChange={(e) => handleChange('schedule_impact_days', e.target.value)}
                                                placeholder="Estimated delay in days"
                                                className={inputClasses}
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </motion.div>
                    </AnimatePresence>
                </div>

                {/* Footer */}
                <div className="p-4 sm:p-6 border-t border-app-subtle bg-app-surface flex flex-col sm:flex-row justify-between gap-3">
                    <Button
                        variant="outline"
                        onClick={step === 1 ? onClose : prevStep}
                        disabled={loading}
                        className="min-h-[44px]"
                    >
                        {step === 1 ? 'Cancel' : (
                            <>
                                <ChevronLeft size={16} className="mr-1" />
                                Back
                            </>
                        )}
                    </Button>

                    {step < 3 ? (
                        <Button
                            onClick={nextStep}
                            disabled={!canProceed()}
                            className="min-h-[44px]"
                        >
                            Next Step <ChevronRight size={16} className="ml-1" />
                        </Button>
                    ) : (
                        <Button
                            onClick={handleSubmit}
                            disabled={loading || !canProceed()}
                            className="min-h-[44px]"
                        >
                            {loading ? (
                                <>
                                    <Loader2 size={18} className="animate-spin mr-2" />
                                    Saving...
                                </>
                            ) : (
                                <>
                                    <Save size={18} className="mr-2" />
                                    {isEditing ? 'Update Risk' : 'Create Risk'}
                                </>
                            )}
                        </Button>
                    )}
                </div>
            </motion.div>
        </motion.div>,
        document.body
    );
};

export default CreateRiskModal;



================================================
FILE: frontend/src/components/risks/index.js
================================================
// Risk Management Components Export
export { default as CreateRiskModal } from './CreateRiskModal';
export { default as RiskDetailPanel } from './RiskDetailPanel';



================================================
FILE: frontend/src/components/risks/RiskDetailPanel.jsx
================================================
import { useState, useEffect, useCallback } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import riskService from '@/api/services/riskService';
import Button from '@/components/ui/Button';
import {
    X, AlertTriangle, AlertCircle, CheckCircle, Clock, FileText, Plus,
    Edit2, Save, ChevronDown, ChevronRight, Loader2, Upload, Trash2,
    User, Calendar, Target, DollarSign, Timer, Shield, History,
    Send, ThumbsUp, ThumbsDown, ExternalLink
} from 'lucide-react';

/**
 * Side panel for viewing and managing a single risk.
 * Includes:
 * - Risk details and editing
 * - Document attachments
 * - Mitigation actions with mandatory proof uploads
 */
const RiskDetailPanel = ({ isOpen, onClose, risk: initialRisk, onUpdate }) => {
    const [risk, setRisk] = useState(initialRisk);
    const [loading, setLoading] = useState(false);
    const [activeTab, setActiveTab] = useState('details');
    const [mitigationActions, setMitigationActions] = useState([]);
    const [documents, setDocuments] = useState([]);
    const [auditLogs, setAuditLogs] = useState([]);

    // Mitigation modal state
    const [showAddMitigation, setShowAddMitigation] = useState(false);
    const [selectedMitigation, setSelectedMitigation] = useState(null);

    // Fetch full risk details
    const fetchRiskDetails = useCallback(async () => {
        if (!risk?.id) return;
        setLoading(true);
        try {
            const [riskRes, mitigationsRes, docsRes] = await Promise.all([
                riskService.getRisk(risk.id),
                riskService.getMitigationActions(risk.id),
                riskService.getRiskDocuments(risk.id)
            ]);
            setRisk(riskRes.data);
            setMitigationActions(mitigationsRes.data || []);
            setDocuments(docsRes.data || []);
        } catch (err) {
            console.error('Failed to fetch risk details:', err);
        } finally {
            setLoading(false);
        }
    }, [risk?.id]);

    useEffect(() => {
        if (isOpen && risk?.id) {
            fetchRiskDetails();
        }
    }, [isOpen, risk?.id, fetchRiskDetails]);

    // Fetch audit logs when tab changes
    const fetchAuditLogs = async () => {
        if (!risk?.id || auditLogs.length > 0) return;
        try {
            const res = await riskService.getRiskAuditLog(risk.id);
            setAuditLogs(res.data || []);
        } catch (err) {
            console.error('Failed to fetch audit logs:', err);
        }
    };

    useEffect(() => {
        if (activeTab === 'history') {
            fetchAuditLogs();
        }
    }, [activeTab]);

    // Get colors
    const severityColors = riskService.getSeverityColor(risk?.severity);
    const statusColors = riskService.getStatusColor(risk?.status);

    if (!isOpen) return null;

    // Severity badge styling
    const getSeverityBadge = (severity) => {
        const colors = {
            CRITICAL: 'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-400 border-red-200 dark:border-red-800',
            HIGH: 'bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-400 border-orange-200 dark:border-orange-800',
            MEDIUM: 'bg-yellow-100 dark:bg-yellow-900/40 text-yellow-700 dark:text-yellow-400 border-yellow-200 dark:border-yellow-800',
            LOW: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800'
        };
        return colors[severity] || colors.MEDIUM;
    };

    return createPortal(
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="fixed inset-0 z-[9999] flex items-center justify-center bg-app-overlay backdrop-blur-sm p-4"
                onClick={onClose}
            >
                {/* Panel - Center modal like other windows */}
                <motion.div
                    initial={{ opacity: 0, scale: 0.95, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95, y: 20 }}
                    transition={{ type: 'spring', damping: 25, stiffness: 300 }}
                    className="relative w-full max-w-3xl bg-app-card rounded-xl sm:rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[95vh] sm:max-h-[90vh]"
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header - Clean design matching system UI */}
                    <div className="px-6 py-4 border-b border-app-subtle bg-app-card">
                        <div className="flex items-start justify-between">
                            <div className="flex-1">
                                <div className="flex items-center gap-3 mb-2">
                                    <span className="px-2 py-1 rounded text-xs font-mono bg-app-surface text-app-muted">
                                        {risk?.risk_code}
                                    </span>
                                    <span className={`px-2 py-1 rounded-full text-xs font-medium border ${getSeverityBadge(risk?.severity)}`}>
                                        {risk?.severity}
                                    </span>
                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColors.bg} ${statusColors.text}`}>
                                        {riskService.STATUSES.find(s => s.value === risk?.status)?.label}
                                    </span>
                                </div>
                                <h2 className="text-xl font-semibold text-app-heading">{risk?.title}</h2>
                                <p className="text-sm text-app-muted mt-1">{risk?.project_name}</p>
                            </div>
                            <button
                                onClick={onClose}
                                className="p-2 hover:bg-app-surface rounded-lg transition-colors"
                            >
                                <X size={20} className="text-app-muted" />
                            </button>
                        </div>

                        {/* Risk Score Display - Compact */}
                        <div className="flex items-center gap-6 mt-4 pt-4 border-t border-app-subtle">
                            <div className="text-center">
                                <div className="text-2xl font-bold text-app-heading">{risk?.risk_score}</div>
                                <div className="text-xs text-app-muted">Risk Score</div>
                            </div>
                            <div className="text-center">
                                <div className="flex gap-1">
                                    {[1, 2, 3, 4, 5].map(i => (
                                        <div
                                            key={i}
                                            className={`w-2 h-5 rounded ${i <= risk?.probability ? 'bg-primary-500' : 'bg-app-subtle'}`}
                                        />
                                    ))}
                                </div>
                                <div className="text-xs text-app-muted mt-1">Probability</div>
                            </div>
                            <div className="text-center">
                                <div className="flex gap-1">
                                    {[1, 2, 3, 4, 5].map(i => (
                                        <div
                                            key={i}
                                            className={`w-2 h-5 rounded ${i <= risk?.impact ? 'bg-primary-500' : 'bg-app-subtle'}`}
                                        />
                                    ))}
                                </div>
                                <div className="text-xs text-app-muted mt-1">Impact</div>
                            </div>
                            {risk?.residual_risk_score && (
                                <div className="text-center border-l border-app-subtle pl-6">
                                    <div className="text-xl font-bold text-app-heading">{risk.residual_risk_score}</div>
                                    <div className="text-xs text-app-muted">Residual</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex border-b border-app-subtle bg-app-card">
                        {[
                            { id: 'details', label: 'Details', icon: AlertTriangle },
                            { id: 'mitigations', label: 'Mitigations', icon: Shield, count: mitigationActions.length },
                            { id: 'documents', label: 'Documents', icon: FileText, count: documents.length },
                            { id: 'history', label: 'History', icon: History }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex-1 py-3 px-4 text-sm font-medium flex items-center justify-center gap-2 transition-colors ${activeTab === tab.id
                                    ? 'text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 bg-primary-50/50 dark:bg-primary-900/20'
                                    : 'text-app-muted hover:text-app-text hover:bg-app-surface'
                                    }`}
                            >
                                <tab.icon size={16} />
                                {tab.label}
                                {tab.count > 0 && (
                                    <span className="px-1.5 py-0.5 rounded-full text-xs bg-app-subtle text-app-text-medium">
                                        {tab.count}
                                    </span>
                                )}
                            </button>
                        ))}
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto p-6 bg-app-card">
                        {loading ? (
                            <div className="flex items-center justify-center h-40">
                                <Loader2 className="w-8 h-8 animate-spin text-primary-500" />
                            </div>
                        ) : (
                            <>
                                {/* Details Tab */}
                                {activeTab === 'details' && (
                                    <DetailsTab risk={risk} onUpdate={onUpdate} onRefresh={fetchRiskDetails} />
                                )}

                                {/* Mitigations Tab */}
                                {activeTab === 'mitigations' && (
                                    <MitigationsTab
                                        risk={risk}
                                        mitigationActions={mitigationActions}
                                        onRefresh={fetchRiskDetails}
                                        showAddModal={showAddMitigation}
                                        setShowAddModal={setShowAddMitigation}
                                        selectedMitigation={selectedMitigation}
                                        setSelectedMitigation={setSelectedMitigation}
                                    />
                                )}

                                {/* Documents Tab */}
                                {activeTab === 'documents' && (
                                    <DocumentsTab
                                        risk={risk}
                                        documents={documents}
                                        onRefresh={fetchRiskDetails}
                                    />
                                )}

                                {/* History Tab */}
                                {activeTab === 'history' && (
                                    <HistoryTab auditLogs={auditLogs} />
                                )}
                            </>
                        )}
                    </div>
                </motion.div>
            </motion.div>
        </AnimatePresence>,
        document.body
    );
};

/**
 * Details Tab Component
 */
const DetailsTab = ({ risk, onUpdate, onRefresh }) => {
    return (
        <div className="space-y-6">
            {/* Description */}
            <div>
                <h3 className="text-sm font-medium text-app-muted mb-2">Description</h3>
                <p className="text-app-text">{risk?.description || 'No description provided'}</p>
            </div>

            {/* Key Information */}
            <div className="grid grid-cols-2 gap-4">
                <InfoItem
                    icon={Target}
                    label="Category"
                    value={riskService.CATEGORIES.find(c => c.value === risk?.category)?.label || risk?.category}
                />
                <InfoItem
                    icon={User}
                    label="Owner"
                    value={risk?.owner_name || 'Not assigned'}
                />
                <InfoItem
                    icon={Calendar}
                    label="Identified"
                    value={risk?.identified_date ? new Date(risk.identified_date).toLocaleDateString() : '-'}
                />
                <InfoItem
                    icon={Clock}
                    label="Target Resolution"
                    value={risk?.target_resolution ? new Date(risk.target_resolution).toLocaleDateString() : 'Not set'}
                    highlight={risk?.is_overdue}
                />
                <InfoItem
                    icon={DollarSign}
                    label="Cost Impact"
                    value={risk?.cost_impact ? `â‚¹${parseFloat(risk.cost_impact).toLocaleString()}` : '-'}
                />
                <InfoItem
                    icon={Timer}
                    label="Schedule Impact"
                    value={risk?.schedule_impact_days ? `${risk.schedule_impact_days} days` : '-'}
                />
            </div>

            {/* Response Strategy */}
            {risk?.response_strategy && (
                <div>
                    <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Response Strategy</h3>
                    <span className="px-3 py-1 bg-primary-100 text-primary-700 dark:bg-primary-900/30 dark:text-primary-400 rounded-full text-sm font-medium">
                        {riskService.RESPONSE_STRATEGIES.find(s => s.value === risk.response_strategy)?.label}
                    </span>
                </div>
            )}

            {/* Mitigation Plan */}
            {risk?.mitigation_plan && (
                <div>
                    <h3 className="text-sm font-medium text-app-muted mb-2">Mitigation Plan</h3>
                    <p className="text-app-text bg-app-surface p-3 rounded-lg">{risk.mitigation_plan}</p>
                </div>
            )}

            {/* Contingency Plan */}
            {risk?.contingency_plan && (
                <div>
                    <h3 className="text-sm font-medium text-app-muted mb-2">Contingency Plan</h3>
                    <p className="text-app-text bg-app-surface p-3 rounded-lg">{risk.contingency_plan}</p>
                </div>
            )}

            {/* Stats */}
            <div className="grid grid-cols-3 gap-4 pt-4 border-t border-app-subtle">
                <div className="text-center p-3 bg-app-surface rounded-lg">
                    <div className="text-2xl font-bold text-app-text">{risk?.days_open || 0}</div>
                    <div className="text-xs text-app-muted">Days Open</div>
                </div>
                <div className="text-center p-3 bg-app-surface rounded-lg">
                    <div className="text-2xl font-bold text-app-text">{risk?.mitigation_count || 0}</div>
                    <div className="text-xs text-app-muted">Mitigations</div>
                </div>
                <div className="text-center p-3 bg-app-surface rounded-lg">
                    <div className="text-2xl font-bold text-app-text">{risk?.risk_documents?.length || 0}</div>
                    <div className="text-xs text-app-muted">Documents</div>
                </div>
            </div>
        </div>
    );
};

/**
 * Info Item Component
 */
const InfoItem = ({ icon: Icon, label, value, highlight = false }) => (
    <div className={`flex items-start gap-3 p-3 rounded-lg ${highlight ? 'bg-red-50 border border-red-200 dark:bg-red-900/20 dark:border-red-800' : 'bg-app-surface'}`}>
        <Icon size={18} className={highlight ? 'text-red-500' : 'text-app-muted'} />
        <div>
            <div className="text-xs text-app-muted">{label}</div>
            <div className={`text-sm font-medium ${highlight ? 'text-red-700 dark:text-red-400' : 'text-app-text'}`}>{value}</div>
        </div>
    </div>
);

/**
 * Mitigations Tab Component
 */
const MitigationsTab = ({ risk, mitigationActions, onRefresh, showAddModal, setShowAddModal }) => {
    const [expandedAction, setExpandedAction] = useState(null);
    const [showProofUpload, setShowProofUpload] = useState(null);
    const [proofFile, setProofFile] = useState(null);
    const [proofDescription, setProofDescription] = useState('');
    const [submitting, setSubmitting] = useState(false);
    const [error, setError] = useState(null);

    // Handle proof upload
    const handleProofUpload = async (actionId) => {
        if (!proofFile) return;

        setSubmitting(true);
        setError(null);

        try {
            const formData = new FormData();
            formData.append('file', proofFile);
            formData.append('description', proofDescription);

            await riskService.uploadMitigationProof(risk.id, actionId, formData);
            setShowProofUpload(null);
            setProofFile(null);
            setProofDescription('');
            onRefresh();
        } catch (err) {
            setError('Failed to upload proof document');
            console.error(err);
        } finally {
            setSubmitting(false);
        }
    };

    // Handle submit for review
    const handleSubmitForReview = async (actionId) => {
        setSubmitting(true);
        try {
            await riskService.submitMitigationAction(risk.id, actionId);
            onRefresh();
        } catch (err) {
            setError(err.response?.data?.message || 'Failed to submit. Ensure proof documents are attached.');
            console.error(err);
        } finally {
            setSubmitting(false);
        }
    };

    // Handle review (approve/reject)
    const handleReview = async (actionId, action, comments = '') => {
        setSubmitting(true);
        try {
            await riskService.reviewMitigationAction(risk.id, actionId, { action, comments });
            onRefresh();
        } catch (err) {
            setError('Failed to process review');
            console.error(err);
        } finally {
            setSubmitting(false);
        }
    };

    return (
        <div className="space-y-4">
            {/* Add Button */}
            <div className="flex justify-between items-center">
                <h3 className="text-lg font-medium text-app-text">Mitigation Actions</h3>
                <Button
                    onClick={() => setShowAddModal(true)}
                    size="sm"
                >
                    <Plus size={16} />
                    Add Mitigation
                </Button>
            </div>

            {error && (
                <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg text-red-700 dark:text-red-400 text-sm flex items-center gap-2">
                    <AlertCircle size={16} />
                    {error}
                    <button onClick={() => setError(null)} className="ml-auto">
                        <X size={14} />
                    </button>
                </div>
            )}

            {/* Actions List */}
            {mitigationActions.length === 0 ? (
                <div className="text-center py-12 text-app-muted">
                    <Shield className="mx-auto mb-3 text-app-muted" size={40} />
                    <p>No mitigation actions yet.</p>
                    <p className="text-sm">Click "Add Mitigation" to record your first action.</p>
                </div>
            ) : (
                <div className="space-y-3">
                    {mitigationActions.map(action => (
                        <div key={action.id} className="border rounded-lg overflow-hidden">
                            {/* Action Header */}
                            <div
                                className="p-4 bg-app-surface cursor-pointer hover:bg-app-surface-hover transition-colors"
                                onClick={() => setExpandedAction(expandedAction === action.id ? null : action.id)}
                            >
                                <div className="flex items-start justify-between">
                                    <div className="flex items-start gap-3">
                                        {expandedAction === action.id ? (
                                            <ChevronDown className="text-app-muted mt-1" size={18} />
                                        ) : (
                                            <ChevronRight className="text-app-muted mt-1" size={18} />
                                        )}
                                        <div>
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-xs text-app-muted">#{action.action_number}</span>
                                                <StatusBadge status={action.status} />
                                                {!action.has_proof && action.status === 'DRAFT' && (
                                                    <span className="px-2 py-0.5 bg-yellow-100 dark:bg-yellow-900/40 text-yellow-700 dark:text-yellow-400 rounded-full text-xs">
                                                        Needs Proof
                                                    </span>
                                                )}
                                            </div>
                                            <h4 className="font-medium text-app-text">{action.title}</h4>
                                            <p className="text-sm text-app-muted mt-1">
                                                {riskService.ACTION_TYPES.find(t => t.value === action.action_type)?.label}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="text-right text-sm text-app-muted">
                                        {action.action_date && new Date(action.action_date).toLocaleDateString()}
                                    </div>
                                </div>
                            </div>

                            {/* Expanded Content */}
                            <AnimatePresence>
                                {expandedAction === action.id && (
                                    <motion.div
                                        initial={{ height: 0, opacity: 0 }}
                                        animate={{ height: 'auto', opacity: 1 }}
                                        exit={{ height: 0, opacity: 0 }}
                                        className="border-t border-app-subtle"
                                    >
                                        <div className="p-4 space-y-4">
                                            <p className="text-app-text">{action.description}</p>

                                            {/* Effectiveness */}
                                            {action.effectiveness_rating && (
                                                <div className="flex items-center gap-4">
                                                    <span className="text-sm text-app-muted">Effectiveness:</span>
                                                    <div className="flex gap-1">
                                                        {[1, 2, 3, 4, 5].map(i => (
                                                            <div
                                                                key={i}
                                                                className={`w-6 h-6 rounded ${i <= action.effectiveness_rating ? 'bg-green-500' : 'bg-gray-200'}`}
                                                            />
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Proof Documents */}
                                            <div>
                                                <div className="flex items-center justify-between mb-2">
                                                    <h5 className="text-sm font-medium text-app-text-medium">
                                                        Proof Documents {action.status === 'DRAFT' && <span className="text-red-500">*</span>}
                                                    </h5>
                                                    {action.status === 'DRAFT' && (
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setShowProofUpload(action.id);
                                                            }}
                                                            className="flex items-center gap-1 text-sm text-primary-600 hover:text-primary-700"
                                                        >
                                                            <Upload size={14} />
                                                            Upload Proof
                                                        </button>
                                                    )}
                                                </div>

                                                {/* Upload Form */}
                                                {showProofUpload === action.id && (
                                                    <div className="p-3 bg-app-surface rounded-lg mb-3 space-y-3">
                                                        <input
                                                            type="file"
                                                            onChange={(e) => setProofFile(e.target.files[0])}
                                                            className="w-full text-sm"
                                                        />
                                                        <textarea
                                                            placeholder="Description of what this document proves..."
                                                            value={proofDescription}
                                                            onChange={(e) => setProofDescription(e.target.value)}
                                                            className="w-full px-3 py-2 border rounded-lg text-sm"
                                                            rows={2}
                                                        />
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => handleProofUpload(action.id)}
                                                                disabled={!proofFile || submitting}
                                                                className="px-3 py-1.5 bg-primary-600 text-white rounded text-sm disabled:opacity-50"
                                                            >
                                                                {submitting ? <Loader2 className="animate-spin" size={14} /> : 'Upload'}
                                                            </button>
                                                            <button
                                                                onClick={() => {
                                                                    setShowProofUpload(null);
                                                                    setProofFile(null);
                                                                }}
                                                                className="px-3 py-1.5 text-gray-600 hover:text-gray-900 text-sm"
                                                            >
                                                                Cancel
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Document List */}
                                                {action.proof_documents?.length > 0 ? (
                                                    <div className="space-y-2">
                                                        {action.proof_documents.map(doc => (
                                                            <div key={doc.id} className="flex items-center gap-2 p-2 bg-green-50 dark:bg-green-900/30 rounded text-sm">
                                                                <FileText size={16} className="text-green-600 dark:text-green-400" />
                                                                <span className="flex-1 text-app-text">{doc.document_title}</span>
                                                                <a
                                                                    href={doc.document_url}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="text-primary-600 hover:text-primary-700"
                                                                >
                                                                    <ExternalLink size={14} />
                                                                </a>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <p className="text-sm text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/30 p-2 rounded">
                                                        âš ï¸ No proof documents attached. Required before submission.
                                                    </p>
                                                )}
                                            </div>

                                            {/* Action Buttons */}
                                            <div className="flex gap-2 pt-3 border-t border-app-subtle">
                                                {action.status === 'DRAFT' && (
                                                    <Button
                                                        onClick={() => handleSubmitForReview(action.id)}
                                                        disabled={!action.has_proof || submitting}
                                                        size="sm"
                                                    >
                                                        <Send size={14} />
                                                        Submit for Review
                                                    </Button>
                                                )}
                                                {action.status === 'SUBMITTED' && (
                                                    <>
                                                        <Button
                                                            onClick={() => handleReview(action.id, 'approve')}
                                                            disabled={submitting}
                                                            variant="success"
                                                            size="sm"
                                                        >
                                                            <ThumbsUp size={14} />
                                                            Approve
                                                        </Button>
                                                        <Button
                                                            onClick={() => {
                                                                const reason = prompt('Enter rejection reason:');
                                                                if (reason) handleReview(action.id, 'reject', reason);
                                                            }}
                                                            disabled={submitting}
                                                            variant="danger"
                                                            size="sm"
                                                        >
                                                            <ThumbsDown size={14} />
                                                            Reject
                                                        </Button>
                                                    </>
                                                )}
                                            </div>

                                            {/* Review Comments */}
                                            {action.review_comments && (
                                                <div className="p-3 bg-app-surface rounded-lg">
                                                    <div className="text-xs text-app-muted mb-1">
                                                        Review by {action.reviewed_by_name} on {new Date(action.reviewed_at).toLocaleDateString()}
                                                    </div>
                                                    <p className="text-sm text-app-text">{action.review_comments}</p>
                                                </div>
                                            )}
                                        </div>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    ))}
                </div>
            )}

            {/* Add Mitigation Modal */}
            {showAddModal && (
                <AddMitigationModal
                    risk={risk}
                    onClose={() => setShowAddModal(false)}
                    onSuccess={() => {
                        setShowAddModal(false);
                        onRefresh();
                    }}
                />
            )}
        </div>
    );
};

/**
 * Mitigation Status Badge
 */
const StatusBadge = ({ status }) => {
    const colors = {
        DRAFT: 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300',
        SUBMITTED: 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400',
        APPROVED: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-400',
        REJECTED: 'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-400'
    };
    return (
        <span className={`px-2 py-0.5 rounded-full text-xs ${colors[status] || colors.DRAFT}`}>
            {status}
        </span>
    );
};

/**
 * Add Mitigation Modal
 */
const AddMitigationModal = ({ risk, onClose, onSuccess }) => {
    const [formData, setFormData] = useState({
        action_type: 'CORRECTIVE',
        title: '',
        description: '',
        action_date: new Date().toISOString().split('T')[0],
        target_completion: '',
        effectiveness_rating: '',
        residual_probability: '',
        residual_impact: '',
        cost_incurred: ''
    });
    const [saving, setSaving] = useState(false);
    const [error, setError] = useState(null);

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.title || !formData.description) {
            setError('Title and description are required');
            return;
        }

        setSaving(true);
        setError(null);

        try {
            await riskService.createMitigationAction(risk.id, {
                ...formData,
                effectiveness_rating: formData.effectiveness_rating || null,
                residual_probability: formData.residual_probability || null,
                residual_impact: formData.residual_impact || null,
                cost_incurred: formData.cost_incurred || 0
            });
            onSuccess();
        } catch (err) {
            setError(err.response?.data?.detail || 'Failed to create mitigation action');
        } finally {
            setSaving(false);
        }
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
            <div className="absolute inset-0 bg-black/50" onClick={onClose} />
            <div className="relative bg-app-card rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto m-4">
                <div className="p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-app-text">Add Mitigation Action</h3>
                        <button onClick={onClose} className="text-app-muted hover:text-app-text">
                            <X size={20} />
                        </button>
                    </div>

                    {error && (
                        <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg text-red-700 dark:text-red-400 text-sm">
                            {error}
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-app-text-medium mb-1">Action Type</label>
                            <select
                                value={formData.action_type}
                                onChange={(e) => setFormData({ ...formData, action_type: e.target.value })}
                                className="w-full px-4 py-2 border border-app bg-app-input text-app-text rounded-lg"
                            >
                                {riskService.ACTION_TYPES.map(t => (
                                    <option key={t.value} value={t.value}>{t.label}</option>
                                ))}
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-app-text-medium mb-1">Title *</label>
                            <input
                                type="text"
                                value={formData.title}
                                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                                placeholder="Brief action title"
                                className="w-full px-4 py-2 border border-app bg-app-input text-app-text rounded-lg"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-app-text-medium mb-1">Description *</label>
                            <textarea
                                value={formData.description}
                                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                placeholder="Describe the mitigation action taken..."
                                rows={3}
                                className="w-full px-4 py-2 border border-app bg-app-input text-app-text rounded-lg"
                                required
                            />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-app-text-medium mb-1">Action Date</label>
                                <input
                                    type="date"
                                    value={formData.action_date}
                                    onChange={(e) => setFormData({ ...formData, action_date: e.target.value })}
                                    className="w-full px-4 py-2 border border-app bg-app-input text-app-text rounded-lg"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-app-text-medium mb-1">Target Completion</label>
                                <input
                                    type="date"
                                    value={formData.target_completion}
                                    onChange={(e) => setFormData({ ...formData, target_completion: e.target.value })}
                                    className="w-full px-4 py-2 border border-app bg-app-input text-app-text rounded-lg"
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-app-text-medium mb-1">Cost Incurred (â‚¹)</label>
                            <input
                                type="number"
                                value={formData.cost_incurred}
                                onChange={(e) => setFormData({ ...formData, cost_incurred: e.target.value })}
                                placeholder="0"
                                className="w-full px-4 py-2 border border-app bg-app-input text-app-text rounded-lg"
                            />
                        </div>

                        <div className="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
                            <p className="text-sm text-yellow-700 dark:text-yellow-400">
                                <strong>Note:</strong> After creating this action, you must upload proof documents before submitting for review.
                            </p>
                        </div>

                        <div className="flex gap-3 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 py-2 border border-app rounded-lg text-app-text hover:bg-app-surface"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                disabled={saving}
                                className="flex-1 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 flex items-center justify-center gap-2"
                            >
                                {saving ? <Loader2 className="animate-spin" size={16} /> : <Save size={16} />}
                                Create Action
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    );
};

/**
 * Documents Tab Component
 */
const DocumentsTab = ({ risk, documents, onRefresh }) => {
    return (
        <div className="space-y-4">
            <div className="flex justify-between items-center">
                <h3 className="text-lg font-medium text-app-text">Risk Documents</h3>
                <Button size="sm">
                    <Upload size={16} />
                    Upload Document
                </Button>
            </div>

            {documents.length === 0 ? (
                <div className="text-center py-12 text-app-muted">
                    <FileText className="mx-auto mb-3 text-app-muted" size={40} />
                    <p>No documents attached yet.</p>
                </div>
            ) : (
                <div className="space-y-2">
                    {documents.map(doc => (
                        <div key={doc.id} className="flex items-center gap-3 p-3 bg-app-surface rounded-lg hover:bg-app-surface-hover">
                            <FileText className="text-primary-600" size={20} />
                            <div className="flex-1">
                                <div className="font-medium text-app-text">{doc.document_title}</div>
                                <div className="text-sm text-app-muted">
                                    {riskService.DOCUMENT_TYPES.find(t => t.value === doc.document_type)?.label}
                                    {doc.uploaded_by_name && ` â€¢ Uploaded by ${doc.uploaded_by_name}`}
                                </div>
                            </div>
                            {doc.document_url && (
                                <a
                                    href={doc.document_url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="p-2 text-app-muted hover:text-primary-600"
                                >
                                    <ExternalLink size={18} />
                                </a>
                            )}
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

/**
 * History/Audit Tab Component
 */
const HistoryTab = ({ auditLogs }) => {
    return (
        <div className="space-y-4">
            <h3 className="text-lg font-medium text-app-text">Audit Trail</h3>

            {auditLogs.length === 0 ? (
                <div className="text-center py-12 text-app-muted">
                    <History className="mx-auto mb-3 text-app-muted" size={40} />
                    <p>No audit history available.</p>
                </div>
            ) : (
                <div className="space-y-3">
                    {auditLogs.map((log, index) => (
                        <div key={log.id} className="flex gap-3">
                            <div className="relative">
                                <div className="w-3 h-3 bg-primary-500 rounded-full mt-1.5" />
                                {index < auditLogs.length - 1 && (
                                    <div className="absolute top-4 left-1.5 w-0.5 h-full bg-app-subtle" />
                                )}
                            </div>
                            <div className="flex-1 pb-4">
                                <div className="text-sm font-medium text-app-text">{log.action}</div>
                                <div className="text-xs text-app-muted mt-1">
                                    {log.actor_name || 'System'} â€¢ {new Date(log.timestamp).toLocaleString()}
                                </div>
                                {log.details && Object.keys(log.details).length > 0 && (
                                    <div className="mt-2 text-xs text-app-text-medium bg-app-surface p-2 rounded">
                                        {JSON.stringify(log.details)}
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

export default RiskDetailPanel;



================================================
FILE: frontend/src/components/scheduling/AddScheduleTaskModal.jsx
================================================
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Calendar, Flag, Target, Scale, DollarSign, AlertCircle, ChevronDown } from 'lucide-react';
import Button from '@/components/ui/Button';
import Toggle from '@/components/ui/Toggle';
import { toast } from 'sonner';
import schedulingService from '@/services/schedulingService';

// Progress measurement methods
const PROGRESS_METHODS = [
    { value: 'QUANTITY', label: 'Quantity-Based', description: 'Progress = Executed / Planned quantity' },
    { value: 'MILESTONE', label: 'Milestone-Based', description: 'Progress jumps at milestone completion' },
    { value: 'COST', label: 'Cost-Based', description: 'Progress = Actual / Budgeted cost' },
    { value: 'TIME', label: 'Time-Based', description: 'Progress = Days elapsed / Duration' },
    { value: 'MANUAL', label: 'Manual (Restricted)', description: 'Requires justification' },
];

const AddScheduleTaskModal = ({ isOpen, onClose, projectId, onTaskCreated, editTask = null }) => {
    const [isLoading, setIsLoading] = useState(false);
    const [isMilestone, setIsMilestone] = useState(editTask?.is_milestone || false);
    const [isCritical, setIsCritical] = useState(editTask?.is_critical || false);

    // Progress tracking fields
    const [progressMethod, setProgressMethod] = useState(editTask?.progress_method || 'QUANTITY');
    const [plannedQuantity, setPlannedQuantity] = useState(editTask?.planned_quantity || '');
    const [executedQuantity, setExecutedQuantity] = useState(editTask?.executed_quantity || '');
    const [uom, setUom] = useState(editTask?.uom || '');
    const [budgetedCost, setBudgetedCost] = useState(editTask?.budgeted_cost || '');
    const [actualCost, setActualCost] = useState(editTask?.actual_cost || '');
    const [weight, setWeight] = useState(editTask?.weight || '');

    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && isOpen && !isLoading) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [isOpen, onClose, isLoading]);

    // Calculate computed progress based on method
    const computedProgress = (() => {
        if (progressMethod === 'QUANTITY' && plannedQuantity > 0) {
            return Math.min(100, ((executedQuantity || 0) / plannedQuantity) * 100);
        }
        if (progressMethod === 'COST' && budgetedCost > 0) {
            return Math.min(100, ((actualCost || 0) / budgetedCost) * 100);
        }
        return 0;
    })();

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);

        const form = e.target;
        const formData = new FormData(form);

        const taskData = {
            name: formData.get('name'),
            description: formData.get('description') || '',
            start_date: formData.get('startDate'),
            end_date: formData.get('endDate'),
            is_milestone: isMilestone,
            is_critical: isCritical,

            // Progress tracking fields
            progress_method: progressMethod,
            planned_quantity: parseFloat(plannedQuantity) || null,
            executed_quantity: parseFloat(executedQuantity) || null,
            uom: uom || null,
            budgeted_cost: parseFloat(budgetedCost) || null,
            actual_cost: parseFloat(actualCost) || null,
            weight: parseFloat(weight) || null,
        };

        try {
            if (editTask) {
                await schedulingService.updateTask(editTask.id, taskData);
                toast.success("Task updated successfully");
            } else {
                await schedulingService.createTask(taskData, projectId);
                toast.success("Task created successfully");
            }
            onTaskCreated();
            onClose();
        } catch (error) {
            console.error('Task operation failed:', error);
            const msg = error.response?.data?.error || error.response?.data?.detail || "Failed to save task";
            toast.error(msg);
        } finally {
            setIsLoading(false);
        }
    };

    if (!isOpen) return null;

    const inputClasses = "w-full border border-slate-200 dark:border-neutral-600 bg-white dark:bg-neutral-900 dark:text-white rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all outline-none";
    const labelClasses = "block text-sm font-semibold text-slate-700 dark:text-neutral-300 mb-1.5";

    return createPortal(
        <AnimatePresence>
            {isOpen && (
                <>
                    {/* Backdrop */}
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        onClick={!isLoading ? onClose : undefined}
                        className="fixed inset-0 z-[9999] bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm"
                    />
                    {/* Modal Content */}
                    <motion.div
                        initial={{ opacity: 0, scale: 0.95, y: 20 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.95, y: 20 }}
                        transition={{ duration: 0.2 }}
                        className="fixed inset-0 z-[9999] flex items-center justify-center p-4 pointer-events-none"
                    >
                        <div
                            className="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl pointer-events-auto w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col"
                            onClick={(e) => e.stopPropagation()}
                        >
                            {/* Header */}
                            <div className="flex justify-between items-center p-5 border-b border-slate-100 dark:border-neutral-700 bg-slate-50/50 dark:bg-neutral-800/50 flex-shrink-0">
                                <h2 className="text-lg font-bold text-slate-800 dark:text-white">
                                    {editTask ? 'Edit Task' : 'Add Schedule Task'}
                                </h2>
                                <button
                                    onClick={onClose}
                                    disabled={isLoading}
                                    className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-700 rounded-full transition-colors disabled:opacity-50"
                                >
                                    <X size={20} className="text-slate-500 dark:text-neutral-400" />
                                </button>
                            </div>

                            {/* Content - Scrollable */}
                            <form onSubmit={handleSubmit} className="p-6 space-y-5 overflow-y-auto flex-1">
                                {/* Basic Info */}
                                <div>
                                    <label className={labelClasses}>Task Name *</label>
                                    <input
                                        name="name"
                                        required
                                        autoFocus
                                        disabled={isLoading}
                                        defaultValue={editTask?.name || ''}
                                        className={inputClasses}
                                        placeholder="e.g. Foundation Work - Phase 1"
                                    />
                                </div>

                                <div>
                                    <label className={labelClasses}>Description</label>
                                    <textarea
                                        name="description"
                                        disabled={isLoading}
                                        defaultValue={editTask?.description || ''}
                                        rows={2}
                                        className={inputClasses}
                                        placeholder="Task description (optional)"
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className={`${labelClasses} flex items-center gap-1.5`}>
                                            <Calendar className="w-3.5 h-3.5 text-slate-400" />
                                            Start Date *
                                        </label>
                                        <input
                                            name="startDate"
                                            type="date"
                                            required
                                            disabled={isLoading}
                                            defaultValue={editTask?.start_date || ''}
                                            className={inputClasses}
                                        />
                                    </div>
                                    <div>
                                        <label className={`${labelClasses} flex items-center gap-1.5`}>
                                            <Calendar className="w-3.5 h-3.5 text-slate-400" />
                                            End Date *
                                        </label>
                                        <input
                                            name="endDate"
                                            type="date"
                                            required
                                            disabled={isLoading}
                                            defaultValue={editTask?.end_date || ''}
                                            className={inputClasses}
                                        />
                                    </div>
                                </div>

                                {/* Progress Tracking Section */}
                                <div className="border-t border-slate-100 dark:border-neutral-700 pt-5">
                                    <h3 className="text-sm font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                        <Target size={16} className="text-primary-600" />
                                        Progress Tracking
                                    </h3>

                                    {/* Progress Method */}
                                    <div className="mb-4">
                                        <label className={labelClasses}>Progress Measurement Method</label>
                                        <div className="relative">
                                            <select
                                                value={progressMethod}
                                                onChange={(e) => setProgressMethod(e.target.value)}
                                                disabled={isLoading}
                                                className={`${inputClasses} appearance-none cursor-pointer`}
                                            >
                                                {PROGRESS_METHODS.map(m => (
                                                    <option key={m.value} value={m.value}>{m.label}</option>
                                                ))}
                                            </select>
                                            <ChevronDown size={16} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" />
                                        </div>
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">
                                            {PROGRESS_METHODS.find(m => m.value === progressMethod)?.description}
                                        </p>
                                    </div>

                                    {/* Quantity Fields (shown for QUANTITY method) */}
                                    {progressMethod === 'QUANTITY' && (
                                        <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-100 dark:border-blue-800 space-y-3">
                                            <div className="grid grid-cols-3 gap-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-slate-600 dark:text-neutral-400 mb-1">Planned Qty *</label>
                                                    <input
                                                        type="number"
                                                        value={plannedQuantity}
                                                        onChange={(e) => setPlannedQuantity(e.target.value)}
                                                        disabled={isLoading}
                                                        className={inputClasses}
                                                        placeholder="e.g. 100"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-slate-600 dark:text-neutral-400 mb-1">Executed Qty</label>
                                                    <input
                                                        type="number"
                                                        value={executedQuantity}
                                                        onChange={(e) => setExecutedQuantity(e.target.value)}
                                                        disabled={isLoading}
                                                        className={inputClasses}
                                                        placeholder="e.g. 50"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-slate-600 dark:text-neutral-400 mb-1">Unit (UOM)</label>
                                                    <input
                                                        type="text"
                                                        value={uom}
                                                        onChange={(e) => setUom(e.target.value)}
                                                        disabled={isLoading}
                                                        className={inputClasses}
                                                        placeholder="e.g. mÂ³"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Cost Fields (shown for COST method) */}
                                    {progressMethod === 'COST' && (
                                        <div className="bg-emerald-50 dark:bg-emerald-900/20 rounded-lg p-4 border border-emerald-100 dark:border-emerald-800 space-y-3">
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-slate-600 dark:text-neutral-400 mb-1 flex items-center gap-1">
                                                        <DollarSign size={12} /> Budgeted Cost (â‚¹) *
                                                    </label>
                                                    <input
                                                        type="number"
                                                        value={budgetedCost}
                                                        onChange={(e) => setBudgetedCost(e.target.value)}
                                                        disabled={isLoading}
                                                        className={inputClasses}
                                                        placeholder="e.g. 1000000"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-slate-600 dark:text-neutral-400 mb-1">Actual Cost (â‚¹)</label>
                                                    <input
                                                        type="number"
                                                        value={actualCost}
                                                        onChange={(e) => setActualCost(e.target.value)}
                                                        disabled={isLoading}
                                                        className={inputClasses}
                                                        placeholder="e.g. 500000"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Weight (for all methods) */}
                                    <div className="mt-4">
                                        <label className={`${labelClasses} flex items-center gap-1.5`}>
                                            <Scale size={14} className="text-slate-400" />
                                            Task Weight (0-100)
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="100"
                                            value={weight}
                                            onChange={(e) => setWeight(e.target.value)}
                                            disabled={isLoading}
                                            className={`${inputClasses} max-w-[150px]`}
                                            placeholder="Auto-calculated"
                                        />
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">
                                            Leave empty for automatic weight based on duration
                                        </p>
                                    </div>

                                    {/* Computed Progress Display */}
                                    {((progressMethod === 'QUANTITY' && plannedQuantity > 0) || (progressMethod === 'COST' && budgetedCost > 0)) ? (
                                        <div className="mt-4 bg-slate-50 dark:bg-neutral-800 rounded-lg p-3 border border-slate-200 dark:border-neutral-700">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-sm font-medium text-slate-700 dark:text-neutral-300">Computed Progress</span>
                                                <span className="text-sm font-bold text-primary-600">{computedProgress.toFixed(1)}%</span>
                                            </div>
                                            <div className="h-2 bg-slate-200 dark:bg-neutral-700 rounded-full overflow-hidden">
                                                <div
                                                    className="h-full bg-gradient-to-r from-primary-500 to-primary-600 transition-all duration-300"
                                                    style={{ width: `${computedProgress}%` }}
                                                />
                                            </div>
                                            <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">
                                                This value is computed automatically and cannot be manually overridden.
                                            </p>
                                        </div>
                                    ) : null}
                                </div>

                                {/* Milestone & Critical Path Toggles */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-amber-50 dark:bg-amber-900/20 rounded-lg p-3 border border-amber-100 dark:border-amber-800">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <Flag className="w-4 h-4 text-amber-600 dark:text-amber-400" />
                                                <label className="text-sm font-medium text-slate-800 dark:text-white cursor-pointer">
                                                    Milestone
                                                </label>
                                            </div>
                                            <Toggle
                                                checked={isMilestone}
                                                onChange={() => setIsMilestone(!isMilestone)}
                                                size="sm"
                                            />
                                        </div>
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">
                                            Required for budget allocation
                                        </p>
                                    </div>

                                    <div className="bg-rose-50 dark:bg-rose-900/20 rounded-lg p-3 border border-rose-100 dark:border-rose-800">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <AlertCircle className="w-4 h-4 text-rose-600 dark:text-rose-400" />
                                                <label className="text-sm font-medium text-slate-800 dark:text-white cursor-pointer">
                                                    Critical Path
                                                </label>
                                            </div>
                                            <Toggle
                                                checked={isCritical}
                                                onChange={() => setIsCritical(!isCritical)}
                                                size="sm"
                                            />
                                        </div>
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">
                                            Delays affect project timeline
                                        </p>
                                    </div>
                                </div>

                                {/* Action Buttons */}
                                <div className="grid grid-cols-2 gap-3 pt-2">
                                    <Button
                                        type="button"
                                        variant="outline"
                                        onClick={onClose}
                                        disabled={isLoading}
                                        className="w-full"
                                    >
                                        Cancel
                                    </Button>
                                    <Button
                                        type="submit"
                                        disabled={isLoading}
                                        className="w-full bg-primary-600 hover:bg-primary-700 text-white flex items-center justify-center gap-2"
                                    >
                                        {isLoading ? 'Saving...' : (editTask ? 'Update Task' : 'Create Task')}
                                    </Button>
                                </div>
                            </form>
                        </div>
                    </motion.div>
                </>
            )}
        </AnimatePresence>,
        document.body
    );
};

export default AddScheduleTaskModal;



================================================
FILE: frontend/src/components/scheduling/GanttChart.jsx
================================================
import React, { useState, useMemo } from 'react';
import { motion } from 'framer-motion';
import { Calendar, ChevronLeft, ChevronRight, Flag, Layers } from 'lucide-react';
import { format, addMonths, startOfMonth, getDaysInMonth, differenceInDays } from 'date-fns';

export const GanttChart = ({ tasks, onTaskClick }) => {
  const [viewDate, setViewDate] = useState(new Date());

  // 1. Calculate Timeline Range (View Month)
  const startDate = startOfMonth(viewDate);
  const totalDays = getDaysInMonth(viewDate);

  // 2. Helper to position bars
  const getBarPosition = (taskStart, taskEnd) => {
    const start = new Date(taskStart);
    const end = new Date(taskEnd);

    // Clamp to current view
    const effectiveStart = start < startDate ? startDate : start;
    const effectiveEnd = end > addMonths(startDate, 1) ? addMonths(startDate, 1) : end;

    if (end < startDate || start > addMonths(startDate, 1)) return null; // Not visible

    const startOffset = differenceInDays(effectiveStart, startDate);
    const duration = differenceInDays(effectiveEnd, effectiveStart) + 1;

    return {
      left: `${(startOffset / totalDays) * 100}%`,
      width: `${(duration / totalDays) * 100}%`
    };
  };

  const nextMonth = () => setViewDate(addMonths(viewDate, 1));
  const prevMonth = () => setViewDate(addMonths(viewDate, -1));

  return (
    <div className="bg-white dark:bg-neutral-900 rounded-xl shadow-sm border border-slate-200 dark:border-neutral-700 flex flex-col h-full overflow-hidden">
      {/* Header / Controls */}
      <div className="p-4 border-b border-slate-200 dark:border-neutral-700 flex justify-between items-center bg-slate-50 dark:bg-neutral-800">
        <div className="flex items-center gap-2">
          <Layers size={20} className="text-primary-600" />
          <h3 className="font-bold text-slate-700 dark:text-white">Project Timeline</h3>
        </div>
        <div className="flex items-center gap-4 bg-white dark:bg-neutral-900 px-3 py-1 rounded-lg border border-slate-200 dark:border-neutral-700 shadow-sm">
          <button onClick={prevMonth} className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded"><ChevronLeft size={18} className="dark:text-neutral-300" /></button>
          <span className="text-sm font-semibold w-32 text-center text-slate-800 dark:text-white">
            {format(viewDate, 'MMMM yyyy')}
          </span>
          <button onClick={nextMonth} className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded"><ChevronRight size={18} className="dark:text-neutral-300" /></button>
        </div>
      </div>

      {/* Timeline Header (Days) */}
      <div className="flex-1 overflow-auto relative custom-scrollbar">
        <div className="min-w-[800px]">
          <div className="grid grid-cols-[250px_1fr] bg-slate-50 dark:bg-neutral-800 sticky top-0 z-20 border-b border-slate-200 dark:border-neutral-700">
            <div className="p-3 text-xs font-bold text-slate-500 dark:text-neutral-400 uppercase tracking-wider border-r border-slate-200 dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
              Task Name
            </div>
            <div className="relative h-10 bg-slate-50 dark:bg-neutral-800">
              {/* Render Day Markers roughly every 5 days to avoid clutter */}
              {Array.from({ length: totalDays }).map((_, i) => (
                (i % 5 === 0 || i === totalDays - 1) && (
                  <div
                    key={i}
                    className="absolute text-[10px] text-slate-400 dark:text-neutral-500 border-l border-slate-200 dark:border-neutral-700 pl-1 h-full flex items-center"
                    style={{ left: `${(i / totalDays) * 100}%` }}
                  >
                    {i + 1}
                  </div>
                )
              ))}
            </div>
          </div>

          {/* Task Rows */}
          <div className="divide-y divide-slate-100 dark:divide-neutral-800">
            {tasks.map(task => {
              const pos = getBarPosition(task.startDate, task.endDate);
              const isOverdue = new Date(task.endDate) < new Date() && task.progress < 100;

              return (
                <div key={task.id} className="grid grid-cols-[250px_1fr] hover:bg-slate-50 dark:hover:bg-neutral-800 group">
                  {/* Task Info Column */}
                  <div className="p-3 border-r border-slate-200 dark:border-neutral-700 flex items-center justify-between text-sm">
                    <div className="flex items-center gap-2 overflow-hidden">
                      {task.isMilestone && <Flag size={14} className="text-amber-500 fill-amber-500 flex-shrink-0" />}
                      <span className="truncate font-medium text-slate-700 dark:text-neutral-300">{task.name}</span>
                    </div>
                    <span className={`text-[10px] px-2 py-0.5 rounded-full ${task.progress === 100 ? 'bg-emerald-100 text-emerald-700' :
                      'bg-slate-100 text-slate-600'
                      }`}>
                      {task.progress}%
                    </span>
                  </div>

                  {/* Timeline Bar Column */}
                  <div className="relative h-12">
                    {/* Grid Lines */}
                    {Array.from({ length: 6 }).map((_, i) => (
                      <div key={i} className="absolute h-full border-r border-slate-100 dark:border-neutral-800" style={{ left: `${i * 20}%` }} />
                    ))}

                    {/* The Bar */}
                    {pos && (
                      <motion.div
                        layoutId={task.id}
                        className={`absolute top-3 h-6 rounded-md shadow-sm cursor-pointer border border-white/20 flex items-center px-2 text-xs text-white overflow-hidden whitespace-nowrap
                                                    ${isOverdue ? 'bg-red-500' :
                            task.isMilestone ? 'bg-amber-500' : 'bg-blue-500'}
                                                    hover:brightness-110 transition-all
                                                `}
                        style={{ left: pos.left, width: pos.width }}
                        onClick={() => onTaskClick(task)}
                        whileHover={{ scale: 1.02 }}
                      >
                        {task.name}
                      </motion.div>
                    )}
                    {!pos && (
                      <div className="text-[10px] text-slate-300 dark:text-neutral-600 italic p-4">
                        (Outside View)
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
            {tasks.length === 0 && (
              <div className="p-8 text-center text-slate-400 dark:text-neutral-500 text-sm">
                No tasks found for this period. Add a task to get started.
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};



================================================
FILE: frontend/src/components/scheduling/ImportScheduleModal.jsx
================================================
/**
 * ImportScheduleModal - Multi-step wizard for importing schedule files
 * Supports: Excel (.xlsx), MS Project (.xml), Primavera P6 (.xer)
 * 
 * Steps:
 * 1. Upload file
 * 2. Map columns to database fields
 * 3. View import results
 */
import { useState, useCallback, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { useDropzone } from 'react-dropzone';
import {
    X, Upload, FileSpreadsheet, CheckCircle2, AlertCircle,
    ArrowRight, ArrowLeft, Loader2, FileText, Calendar,
    Target, Hash, Percent
} from 'lucide-react';
import Button from '@/components/ui/Button';
import schedulingService from '@/services/schedulingService';
import { toast } from 'sonner';

// Database fields that can be mapped
const DB_FIELDS = [
    { key: 'name', label: 'Task Name', icon: FileText, required: true },
    { key: 'start_date', label: 'Start Date', icon: Calendar, required: true },
    { key: 'end_date', label: 'End Date', icon: Calendar, required: true },
    { key: 'progress', label: 'Progress %', icon: Percent, required: false },
    { key: 'external_id', label: 'External ID', icon: Hash, required: false },
];

const SUPPORTED_FORMATS = {
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
    'application/xml': ['.xml'],
    'text/xml': ['.xml'],
    'application/octet-stream': ['.xer'],
};

const ImportScheduleModal = ({ onClose, projectId, onImported }) => {
    // Wizard state
    const [step, setStep] = useState(1); // 1: Upload, 2: Mapping, 3: Result

    // File state
    const [file, setFile] = useState(null);
    const [fileHeaders, setFileHeaders] = useState([]);
    const [analyzing, setAnalyzing] = useState(false);

    // Mapping state: { dbField: fileHeader }
    const [mapping, setMapping] = useState({});

    // Import state
    const [importing, setImporting] = useState(false);
    const [uploadProgress, setUploadProgress] = useState(0);
    const [importResult, setImportResult] = useState(null);
    const [importError, setImportError] = useState(null);

    // ESC key handler
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && !importing && !analyzing) {
                onClose();
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [onClose, importing, analyzing]);

    // File drop handler
    const onDrop = useCallback(async (acceptedFiles, rejections) => {
        if (rejections.length > 0) {
            const error = rejections[0].errors[0]?.message || 'Unsupported file format';
            toast.error(`Cannot upload: ${error}`);
            return;
        }

        if (acceptedFiles.length === 0) return;

        const selectedFile = acceptedFiles[0];
        setFile(selectedFile);
        setAnalyzing(true);
        setImportError(null);

        try {
            const result = await schedulingService.analyzeFile(selectedFile);
            setFileHeaders(result.headers || []);

            // Auto-map common column names
            const autoMapping = {};
            const lowerHeaders = result.headers.map(h => h.toLowerCase());

            // Smart matching for common patterns
            const patterns = {
                name: ['name', 'task name', 'task_name', 'activity', 'description', 'title'],
                start_date: ['start', 'start date', 'start_date', 'begin', 'from'],
                end_date: ['end', 'end date', 'end_date', 'finish', 'to', 'due'],
                progress: ['progress', '%', 'percent', 'complete', 'percentage', 'percentcomplete'],
                external_id: ['id', 'uid', 'code', 'task_code', 'wbs', 'task id'],
            };

            Object.entries(patterns).forEach(([dbField, keywords]) => {
                const matchIdx = lowerHeaders.findIndex(h =>
                    keywords.some(kw => h.includes(kw))
                );
                if (matchIdx !== -1) {
                    autoMapping[dbField] = result.headers[matchIdx];
                }
            });

            setMapping(autoMapping);
            setStep(2); // Move to mapping step

        } catch (error) {
            console.error('File analysis failed:', error);
            setImportError(error.response?.data?.error || 'Failed to analyze file');
            toast.error('Failed to analyze file');
        } finally {
            setAnalyzing(false);
        }
    }, []);

    const { getRootProps, getInputProps, isDragActive } = useDropzone({
        onDrop,
        multiple: false,
        accept: SUPPORTED_FORMATS,
    });

    // Handle mapping change
    const handleMappingChange = (dbField, fileHeader) => {
        setMapping(prev => ({
            ...prev,
            [dbField]: fileHeader || undefined
        }));
    };

    // Validate mapping before import
    const validateMapping = () => {
        const requiredFields = DB_FIELDS.filter(f => f.required);
        const missingFields = requiredFields.filter(f => !mapping[f.key]);

        if (missingFields.length > 0) {
            toast.error(`Please map required fields: ${missingFields.map(f => f.label).join(', ')}`);
            return false;
        }
        return true;
    };

    // Execute import
    const handleImport = async () => {
        if (!validateMapping()) return;

        setImporting(true);
        setUploadProgress(0);
        setImportError(null);

        try {
            const result = await schedulingService.importFile(
                file,
                projectId,
                mapping,
                (progress) => setUploadProgress(progress)
            );

            setImportResult(result);
            setStep(3); // Move to result step
            toast.success(`Imported ${result.created} new, updated ${result.updated} tasks`);

        } catch (error) {
            console.error('Import failed:', error);
            const errorMsg = error.response?.data?.error || 'Import failed';
            setImportError(errorMsg);
            toast.error(errorMsg);
        } finally {
            setImporting(false);
        }
    };

    // Format file size
    const formatSize = (bytes) => {
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    };

    // Get file type label
    const getFileTypeLabel = (filename) => {
        const ext = filename.split('.').pop().toLowerCase();
        switch (ext) {
            case 'xlsx': return 'Excel Spreadsheet';
            case 'xml': return 'MS Project XML';
            case 'xer': return 'Primavera P6';
            default: return 'Schedule File';
        }
    };

    // Render step indicator
    const renderStepIndicator = () => (
        <div className="flex items-center justify-center gap-2 mb-6">
            {[1, 2, 3].map((s) => (
                <div key={s} className="flex items-center">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all ${step >= s
                        ? 'bg-primary-600 text-white'
                        : 'bg-slate-200 dark:bg-neutral-700 text-slate-500 dark:text-neutral-400'
                        }`}>
                        {step > s ? <CheckCircle2 size={16} /> : s}
                    </div>
                    {s < 3 && (
                        <div className={`w-12 h-0.5 mx-1 ${step > s ? 'bg-primary-600' : 'bg-slate-200 dark:bg-neutral-700'
                            }`} />
                    )}
                </div>
            ))}
        </div>
    );

    // Step 1: Upload
    const renderUploadStep = () => (
        <div className="space-y-4">
            <p className="text-sm text-slate-600 dark:text-neutral-300 text-center">
                Upload your project schedule file to import tasks
            </p>

            <div
                {...getRootProps()}
                className={`border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-all ${isDragActive
                    ? 'border-primary-500 bg-primary-50'
                    : 'border-slate-300 dark:border-neutral-600 hover:border-slate-400 dark:hover:border-neutral-500 hover:bg-slate-50 dark:hover:bg-neutral-800'
                    }`}
            >
                <input {...getInputProps()} />
                {analyzing ? (
                    <>
                        <Loader2 size={40} className="mx-auto text-primary-600 animate-spin" />
                        <p className="text-sm text-slate-600 dark:text-neutral-300 mt-3">Analyzing file structure...</p>
                    </>
                ) : (
                    <>
                        <Upload size={40} className={`mx-auto ${isDragActive ? 'text-primary-600' : 'text-slate-400'}`} />
                        <p className="text-sm text-slate-600 dark:text-neutral-300 mt-3">
                            {isDragActive ? 'Drop your file here' : 'Drag & drop, or click to browse'}
                        </p>
                        <div className="flex justify-center gap-3 mt-3">
                            <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">.xlsx</span>
                            <span className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-medium">.xml (MSP)</span>
                            <span className="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded font-medium">.xer (P6)</span>
                        </div>
                    </>
                )}
            </div>

            {importError && (
                <div className="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg flex items-center gap-2 text-red-700 dark:text-red-300 text-sm">
                    <AlertCircle size={16} />
                    {importError}
                </div>
            )}
        </div>
    );

    // Step 2: Mapping
    const renderMappingStep = () => (
        <div className="space-y-4">
            {/* File info */}
            <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-neutral-800 rounded-lg border border-slate-200 dark:border-neutral-700">
                <div className="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                    <FileSpreadsheet size={20} className="text-primary-600" />
                </div>
                <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-slate-800 dark:text-white truncate">{file?.name}</p>
                    <p className="text-xs text-slate-500 dark:text-neutral-400">{formatSize(file?.size)} â€¢ {getFileTypeLabel(file?.name)}</p>
                </div>
                <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium">
                    {fileHeaders.length} columns
                </span>
            </div>

            {/* Mapping UI */}
            <div className="space-y-3">
                <p className="text-sm font-medium text-slate-700 dark:text-neutral-300">Map file columns to task fields:</p>

                {DB_FIELDS.map((field) => {
                    const Icon = field.icon;
                    return (
                        <div key={field.key} className="flex items-center gap-3">
                            <div className={`w-40 flex items-center gap-2 ${field.required ? 'font-medium' : ''}`}>
                                <Icon size={16} className="text-slate-500" />
                                <span className="text-sm text-slate-700 dark:text-neutral-300">
                                    {field.label}
                                    {field.required && <span className="text-red-500 ml-1">*</span>}
                                </span>
                            </div>
                            <ArrowLeft size={16} className="text-slate-400" />
                            <select
                                value={mapping[field.key] || ''}
                                onChange={(e) => handleMappingChange(field.key, e.target.value)}
                                className={`flex-1 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 ${field.required && !mapping[field.key]
                                    ? 'border-amber-300 bg-amber-50 dark:bg-amber-900/20 dark:border-amber-700'
                                    : 'border-slate-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 dark:text-white'
                                    }`}
                            >
                                <option value="">-- Select Column --</option>
                                {fileHeaders.map((header) => (
                                    <option key={header} value={header}>{header}</option>
                                ))}
                            </select>
                        </div>
                    );
                })}
            </div>

            {/* Import progress */}
            {importing && (
                <div className="space-y-2">
                    <div className="flex justify-between text-sm text-slate-600">
                        <span>Importing tasks...</span>
                        <span>{uploadProgress}%</span>
                    </div>
                    <div className="h-2 bg-slate-200 dark:bg-neutral-700 rounded-full overflow-hidden">
                        <motion.div
                            className="h-full bg-primary-600"
                            initial={{ width: 0 }}
                            animate={{ width: `${uploadProgress}%` }}
                        />
                    </div>
                </div>
            )}

            {importError && (
                <div className="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg flex items-center gap-2 text-red-700 dark:text-red-300 text-sm">
                    <AlertCircle size={16} />
                    {importError}
                </div>
            )}
        </div>
    );

    // Step 3: Result
    const renderResultStep = () => (
        <div className="space-y-6 py-4">
            <div className="text-center">
                <div className="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
                    <CheckCircle2 size={32} className="text-green-600" />
                </div>
                <h3 className="text-lg font-bold text-slate-800 dark:text-white">Import Successful!</h3>
                <p className="text-sm text-slate-600 dark:text-neutral-400 mt-1">
                    Your schedule has been imported into the project
                </p>
            </div>

            <div className="grid grid-cols-2 gap-4">
                <div className="p-4 bg-green-50 rounded-xl border border-green-200 text-center">
                    <div className="text-3xl font-bold text-green-700">{importResult?.created || 0}</div>
                    <div className="text-sm text-green-600 font-medium">New Tasks Created</div>
                </div>
                <div className="p-4 bg-blue-50 rounded-xl border border-blue-200 text-center">
                    <div className="text-3xl font-bold text-blue-700">{importResult?.updated || 0}</div>
                    <div className="text-sm text-blue-600 font-medium">Tasks Updated</div>
                </div>
            </div>

            <div className="p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2 text-amber-800 text-sm">
                <Target size={16} className="mt-0.5 flex-shrink-0" />
                <div>
                    <span className="font-medium">Next Steps:</span> Mark tasks as "Milestones" in the Gantt chart to enable budget allocation and billing.
                </div>
            </div>
        </div>
    );

    return createPortal(
        <div className="fixed inset-0 z-[9999] bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                className="bg-white dark:bg-neutral-900 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden"
            >
                {/* Header */}
                <div className="flex justify-between items-center p-4 border-b border-slate-200 dark:border-neutral-700 bg-gradient-to-r from-primary-50 to-blue-50 dark:from-neutral-800 dark:to-neutral-800">
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <FileSpreadsheet className="text-primary-600 dark:text-indigo-400" size={20} />
                            Import Schedule
                        </h2>
                        <p className="text-xs text-slate-500 dark:text-neutral-400 mt-0.5">
                            {step === 1 && 'Step 1: Upload File'}
                            {step === 2 && 'Step 2: Map Columns'}
                            {step === 3 && 'Step 3: Complete'}
                        </p>
                    </div>
                    <button
                        onClick={onClose}
                        className="p-2 hover:bg-white/50 dark:hover:bg-neutral-700 rounded-lg transition-colors"
                        disabled={importing}
                    >
                        <X size={20} className="text-slate-500 dark:text-neutral-400" />
                    </button>
                </div>

                {/* Content */}
                <div className="p-5">
                    {renderStepIndicator()}

                    <AnimatePresence mode="wait">
                        <motion.div
                            key={step}
                            initial={{ opacity: 0, x: 20 }}
                            animate={{ opacity: 1, x: 0 }}
                            exit={{ opacity: 0, x: -20 }}
                            transition={{ duration: 0.2 }}
                        >
                            {step === 1 && renderUploadStep()}
                            {step === 2 && renderMappingStep()}
                            {step === 3 && renderResultStep()}
                        </motion.div>
                    </AnimatePresence>
                </div>

                {/* Footer */}
                <div className="flex justify-between items-center p-4 border-t border-slate-200 dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
                    {step === 1 && (
                        <>
                            <div />
                            <Button variant="outline" onClick={onClose}>Cancel</Button>
                        </>
                    )}

                    {step === 2 && (
                        <>
                            <Button
                                variant="outline"
                                onClick={() => { setStep(1); setFile(null); setFileHeaders([]); }}
                                disabled={importing}
                            >
                                <ArrowLeft size={16} className="mr-1" /> Back
                            </Button>
                            <Button
                                onClick={handleImport}
                                disabled={importing}
                                className="bg-primary-600 text-white"
                            >
                                {importing ? (
                                    <>
                                        <Loader2 size={16} className="mr-2 animate-spin" />
                                        Importing...
                                    </>
                                ) : (
                                    <>
                                        Import Schedule <ArrowRight size={16} className="ml-1" />
                                    </>
                                )}
                            </Button>
                        </>
                    )}

                    {step === 3 && (
                        <>
                            <div />
                            <Button
                                onClick={() => { onImported && onImported(); onClose(); }}
                                className="bg-primary-600 text-white"
                            >
                                <CheckCircle2 size={16} className="mr-2" /> Done
                            </Button>
                        </>
                    )}
                </div>
            </motion.div>
        </div>,
        document.body
    );
};

export default ImportScheduleModal;



================================================
FILE: frontend/src/components/search/GlobalSearchBar.jsx
================================================
import { useState, useEffect, useCallback, useRef } from 'react';
import { createPortal } from 'react-dom';
import { useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    Search,
    X,
    ArrowRight,
    FileText,
    Users,
    FolderOpen,
    Calendar,
    MessageSquare,
    Building2,
    LayoutDashboard,
    Clock,
    Filter,
    Command
} from 'lucide-react';
import SearchModal from './SearchModal';

/**
 * GlobalSearchBar - Main search component for the header
 * 
 * Features:
 * - Full search bar on desktop, icon on mobile
 * - Opens SearchModal on focus/click
 * - Keyboard shortcut: Ctrl+K (Windows) / Cmd+K (Mac)
 * - Responsive design matching the app's glassmorphism UI
 * - Uses React Portal to render modal outside header hierarchy
 */
const GlobalSearchBar = ({ isDesktop = true }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [isFocused, setIsFocused] = useState(false);
    const inputRef = useRef(null);
    const navigate = useNavigate();

    // Global keyboard shortcut handler
    useEffect(() => {
        const handleKeyDown = (e) => {
            // Ctrl+K (Windows) or Cmd+K (Mac)
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                setIsModalOpen(true);
            }
            // Escape to close
            if (e.key === 'Escape' && isModalOpen) {
                setIsModalOpen(false);
            }
        };

        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
    }, [isModalOpen]);

    const handleSearchBarClick = useCallback(() => {
        setIsModalOpen(true);
    }, []);

    const handleCloseModal = useCallback(() => {
        setIsModalOpen(false);
    }, []);

    const handleResultSelect = useCallback((result) => {
        setIsModalOpen(false);
        if (result.path) {
            navigate(result.path);
        }
        if (result.action) {
            result.action();
        }
    }, [navigate]);

    // Render modal via Portal to document.body (outside header hierarchy)
    const renderModal = () => {
        if (!isModalOpen) return null;

        return createPortal(
            <AnimatePresence>
                <SearchModal
                    isOpen={isModalOpen}
                    onClose={handleCloseModal}
                    onResultSelect={handleResultSelect}
                />
            </AnimatePresence>,
            document.body
        );
    };

    // Desktop: Full search bar
    if (isDesktop) {
        return (
            <>
                <motion.div
                    className="relative flex-1 max-w-xl mx-4"
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.3 }}
                >
                    <div
                        onClick={handleSearchBarClick}
                        className={`
              flex items-center gap-3 px-4 py-2.5 
              bg-slate-50/80 dark:bg-neutral-800/80 hover:bg-slate-100/80 dark:hover:bg-neutral-700/80
              border border-slate-200/60 dark:border-neutral-600/60 hover:border-slate-300/80 dark:hover:border-neutral-500/80
              rounded-xl cursor-text
              transition-all duration-200 ease-out
              group
              ${isFocused ? 'ring-2 ring-primary-500/20 border-primary-400/60 dark:border-primary-600/60' : ''}
            `}
                    >
                        <Search
                            size={18}
                            className="text-slate-400 dark:text-neutral-400 group-hover:text-slate-500 dark:group-hover:text-neutral-300 transition-colors"
                        />
                        <span className="text-slate-400 dark:text-neutral-400 text-sm flex-1 select-none">
                            Search anything...
                        </span>
                        <div className="flex items-center gap-1 px-2 py-1 bg-white/80 dark:bg-neutral-700/80 rounded-md border border-slate-200/60 dark:border-neutral-600/60">
                            <Command size={12} className="text-slate-400 dark:text-neutral-400" />
                            <span className="text-xs text-slate-400 dark:text-neutral-400 font-medium">K</span>
                        </div>
                    </div>
                </motion.div>

                {renderModal()}
            </>
        );
    }

    // Mobile: Search icon button
    return (
        <>
            <motion.button
                onClick={handleSearchBarClick}
                className="p-2 rounded-xl hover:bg-slate-100/60 dark:hover:bg-neutral-800/60 transition-all duration-200 hover:scale-105 group"
                whileTap={{ scale: 0.95 }}
                title="Search (Ctrl+K)"
            >
                <Search
                    size={20}
                    className="text-slate-500 dark:text-neutral-400 group-hover:text-primary-600 dark:group-hover:text-primary-500 transition-colors"
                />
            </motion.button>

            {renderModal()}
        </>
    );
};

export default GlobalSearchBar;




================================================
FILE: frontend/src/components/search/index.js
================================================
// Search Components Index
export { default as GlobalSearchBar } from './GlobalSearchBar';
export { default as SearchModal } from './SearchModal';
export { default as SearchResultItem } from './SearchResultItem';
export { default as SearchFilters } from './SearchFilters';



================================================
FILE: frontend/src/components/search/SearchFilters.jsx
================================================
import { memo, useMemo } from 'react';
import { motion } from 'framer-motion';
import {
    Search,
    LayoutDashboard,
    Briefcase,
    FileText,
    Users,
    MessageSquare,
    Calendar,
    X
} from 'lucide-react';

// Filter categories configuration
const FILTER_CATEGORIES = [
    { id: 'all', label: 'All', icon: Search },
    { id: 'pages', label: 'Pages', icon: LayoutDashboard },
    { id: 'projects', label: 'Projects', icon: Briefcase },
    { id: 'documents', label: 'Documents', icon: FileText },
    { id: 'users', label: 'Users', icon: Users },
    { id: 'communications', label: 'Messages', icon: MessageSquare },
    { id: 'tasks', label: 'Tasks', icon: Calendar },
];

/**
 * SearchFilters - Category filter pills for search results
 * 
 * Props:
 * - activeFilter: string - Currently active filter ID
 * - onFilterChange: (filterId: string) => void
 * - resultCounts?: { [category]: number } - Optional counts per category
 */
const SearchFilters = memo(({ activeFilter, onFilterChange, resultCounts = {} }) => {
    return (
        <motion.div
            className="flex flex-wrap gap-2"
            initial={{ opacity: 0, y: -10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.2 }}
        >
            {FILTER_CATEGORIES.map((filter) => {
                const Icon = filter.icon;
                const count = resultCounts[filter.id];
                const isActive = activeFilter === filter.id;

                return (
                    <motion.button
                        key={filter.id}
                        onClick={() => onFilterChange(filter.id)}
                        className={`
              flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium
              transition-all duration-150
              ${isActive
                                ? 'bg-primary-100 text-primary-700 border border-primary-200 shadow-sm'
                                : 'bg-white text-slate-600 border border-slate-200 hover:border-slate-300 hover:bg-slate-50'
                            }
            `}
                        whileHover={{ scale: 1.02 }}
                        whileTap={{ scale: 0.98 }}
                    >
                        <Icon size={14} />
                        <span>{filter.label}</span>
                        {count !== undefined && count > 0 && (
                            <span className={`
                ml-1 px-1.5 py-0.5 text-xs rounded-full
                ${isActive
                                    ? 'bg-primary-200 text-primary-800'
                                    : 'bg-slate-100 text-slate-500'
                                }
              `}>
                                {count > 99 ? '99+' : count}
                            </span>
                        )}
                    </motion.button>
                );
            })}
        </motion.div>
    );
});

SearchFilters.displayName = 'SearchFilters';

export default SearchFilters;



================================================
FILE: frontend/src/components/search/SearchModal.jsx
================================================
import { useState, useEffect, useCallback, useRef, useMemo } from 'react';
import { motion } from 'framer-motion';
import {
    Search,
    X,
    ArrowRight,
    FileText,
    Users,
    FolderOpen,
    Calendar,
    MessageSquare,
    Building2,
    LayoutDashboard,
    Clock,
    Filter,
    ChevronRight,
    ArrowUp,
    ArrowDown,
    CornerDownLeft,
    Loader2,
    Settings,
    CheckCircle2,
    Briefcase,
    Receipt,
    Map,
    Box,
    Workflow,
    CreditCard,
    Shield,
    BookOpen
} from 'lucide-react';
import SearchResultItem from './SearchResultItem';
import SearchFilters from './SearchFilters';
import { searchService } from '@/services/searchService';

// Navigation pages for quick access
const NAVIGATION_PAGES = [
    { id: 'nav-dashboard', title: 'Dashboard', description: 'View your dashboard', path: '/dashboard', icon: LayoutDashboard, category: 'pages', keywords: ['dashboard', 'home', 'main'] },
    { id: 'nav-projects', title: 'Projects', description: 'Manage all projects', path: '/projects', icon: Briefcase, category: 'pages', keywords: ['projects', 'proj', 'project list'] },
    { id: 'nav-edms', title: 'EDMS', description: 'Document management system', path: '/edms', icon: FolderOpen, category: 'pages', keywords: ['documents', 'docs', 'edms', 'files', 'file manager'], noTranslate: true },
    { id: 'nav-scheduling', title: 'Scheduling', description: 'View schedules and Gantt charts', path: '/scheduling', icon: Calendar, category: 'pages', keywords: ['schedule', 'scheduling', 'gantt', 'timeline', 'tasks'] },
    { id: 'nav-communications', title: 'Communications', description: 'Messages and threads', path: '/communications', icon: MessageSquare, category: 'pages', keywords: ['communications', 'messages', 'chat', 'inbox'] },
    { id: 'nav-billing', title: 'RA Billing', description: 'Running account bills', path: '/cost/billing', icon: Receipt, category: 'pages', keywords: ['billing', 'ra billing', 'bills', 'invoices'], noTranslate: true },
    { id: 'nav-funds', title: 'Fund Management', description: 'Manage project funds', path: '/cost/funds', icon: CreditCard, category: 'pages', keywords: ['funds', 'fund management', 'finance'] },
    { id: 'nav-budgeting', title: 'Budgeting', description: 'Budget planning and tracking', path: '/cost/budgeting', icon: CreditCard, category: 'pages', keywords: ['budget', 'budgeting', 'cost planning'] },
    { id: 'nav-boq', title: 'BOQ Management', description: 'Bill of quantities', path: '/cost/boq', icon: FileText, category: 'pages', keywords: ['boq', 'bill of quantities', 'quantities'], noTranslate: true },
    { id: 'nav-users', title: 'User Management', description: 'Manage users and permissions', path: '/users', icon: Users, category: 'pages', keywords: ['users', 'user management', 'people', 'team'] },
    { id: 'nav-approvals', title: 'Approvals', description: 'Pending approvals', path: '/approvals', icon: CheckCircle2, category: 'pages', keywords: ['approvals', 'pending', 'approve', 'review'] },
    { id: 'nav-procurement', title: 'E-Procurement', description: 'Tenders and contracts', path: '/e-procurement', icon: Briefcase, category: 'pages', keywords: ['procurement', 'e-procurement', 'tenders', 'contracts'] },
    { id: 'nav-gis', title: 'GIS', description: 'Geographic information system', path: '/gis', icon: Map, category: 'pages', keywords: ['gis', 'map', 'location', 'geo'], noTranslate: true },
    { id: 'nav-bim', title: 'BIM', description: 'Building information modeling', path: '/bim', icon: Box, category: 'pages', keywords: ['bim', 'building', '3d model'], noTranslate: true },
    { id: 'nav-workflow', title: 'Workflow Config', description: 'Configure workflows', path: '/workflow', icon: Workflow, category: 'pages', keywords: ['workflow', 'workflows', 'automation'] },
    { id: 'nav-risk', title: 'Risk Management', description: 'Manage project risks', path: '/risk', icon: Shield, category: 'pages', keywords: ['risk', 'risks', 'risk management'] },
    { id: 'nav-etp', title: 'ETP Master', description: 'ETP configuration', path: '/etp-master', icon: Settings, category: 'pages', keywords: ['etp', 'etp master', 'configuration'], noTranslate: true },
    { id: 'nav-audit', title: 'Audit Logs', description: 'View system audit logs', path: '/admin/audit-logs', icon: BookOpen, category: 'pages', keywords: ['audit', 'logs', 'audit logs', 'history'] },
    { id: 'nav-master-data', title: 'Master Data', description: 'Manage master data', path: '/admin/master-data', icon: Settings, category: 'pages', keywords: ['master data', 'masters', 'configuration'] },
];

// Filter categories - comprehensive system-wide search
const FILTER_CATEGORIES = [
    { id: 'all', label: 'All', icon: Search },
    { id: 'pages', label: 'Pages', icon: LayoutDashboard },
    { id: 'projects', label: 'Projects', icon: Briefcase },
    { id: 'documents', label: 'Documents', icon: FileText },
    { id: 'users', label: 'Users', icon: Users },
    { id: 'communications', label: 'Messages', icon: MessageSquare },
    { id: 'tasks', label: 'Tasks', icon: Calendar },
    { id: 'risks', label: 'Risks', icon: Shield },
    { id: 'billing', label: 'Billing', icon: Receipt },
    { id: 'boq', label: 'BOQ', icon: FileText },
    { id: 'funds', label: 'Funds', icon: CreditCard },
    { id: 'procurement', label: 'Procurement', icon: Briefcase },
];

/**
 * SearchModal - Full-screen search modal with filters and keyboard navigation
 * 
 * Features:
 * - Fuzzy search with typo tolerance
 * - Category filters
 * - Recent searches
 * - Keyboard navigation (arrow keys, Enter, Escape)
 * - Debounced API calls
 * - Highlighted matching text
 */
const SearchModal = ({ isOpen, onClose, onResultSelect }) => {
    const [query, setQuery] = useState('');
    const [results, setResults] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [activeFilter, setActiveFilter] = useState('all');
    const [selectedIndex, setSelectedIndex] = useState(0);
    const [recentSearches, setRecentSearches] = useState([]);
    const [showFilters, setShowFilters] = useState(false);
    const inputRef = useRef(null);
    const resultsContainerRef = useRef(null);

    // Load recent searches on mount
    useEffect(() => {
        const recent = searchService.getRecentSearches();
        setRecentSearches(recent);
    }, []);

    // Focus input when modal opens
    useEffect(() => {
        if (isOpen && inputRef.current) {
            setTimeout(() => inputRef.current?.focus(), 100);
        }
    }, [isOpen]);

    // Fuzzy match helper for local navigation pages
    const fuzzyMatch = useCallback((text, searchQuery) => {
        if (!searchQuery) return false;
        const normalizedText = text.toLowerCase();
        const normalizedQuery = searchQuery.toLowerCase().trim();

        // Direct match
        if (normalizedText.includes(normalizedQuery)) return true;

        // Simple Levenshtein-like tolerance for short queries
        if (normalizedQuery.length >= 3) {
            // Check if at least 70% of characters match in order
            let queryIndex = 0;
            for (const char of normalizedText) {
                if (char === normalizedQuery[queryIndex]) {
                    queryIndex++;
                    if (queryIndex === normalizedQuery.length) return true;
                }
            }
        }

        return false;
    }, []);

    // Search navigation pages locally
    const searchNavigationPages = useCallback((searchQuery) => {
        if (!searchQuery || searchQuery.length < 1) return [];

        const normalizedQuery = searchQuery.toLowerCase().trim();

        return NAVIGATION_PAGES.filter(page => {
            // Match title
            if (fuzzyMatch(page.title, normalizedQuery)) return true;
            // Match description
            if (fuzzyMatch(page.description, normalizedQuery)) return true;
            // Match keywords
            return page.keywords.some(keyword =>
                fuzzyMatch(keyword, normalizedQuery) || keyword.includes(normalizedQuery)
            );
        }).map(page => ({
            ...page,
            type: 'page',
            relevanceScore: page.title.toLowerCase().startsWith(normalizedQuery) ? 100 : 50
        }));
    }, [fuzzyMatch]);

    // Debounced search
    useEffect(() => {
        if (!query || query.length < 2) {
            setResults([]);
            setIsLoading(false);
            return;
        }

        setIsLoading(true);
        const debounceTimer = setTimeout(async () => {
            try {
                // Search navigation pages locally (instant)
                const pageResults = searchNavigationPages(query);

                // Search backend for other entities
                const apiResults = await searchService.globalSearch(query, activeFilter);

                // Combine and sort results
                const allResults = [...pageResults, ...apiResults];

                // Sort by relevance score (higher first), then by category priority
                allResults.sort((a, b) => {
                    // Pages always first if they match well
                    if (a.category === 'pages' && a.relevanceScore >= 100) return -1;
                    if (b.category === 'pages' && b.relevanceScore >= 100) return 1;

                    return (b.relevanceScore || 0) - (a.relevanceScore || 0);
                });

                // Filter by active category if not 'all'
                const filteredResults = activeFilter === 'all'
                    ? allResults
                    : allResults.filter(r => r.category === activeFilter);

                setResults(filteredResults.slice(0, 20)); // Limit to 20 results
                setSelectedIndex(0);
            } catch (error) {
                console.error('Search error:', error);
                // Still show local navigation results on error
                const pageResults = searchNavigationPages(query);
                setResults(pageResults);
            } finally {
                setIsLoading(false);
            }
        }, 300); // 300ms debounce

        return () => clearTimeout(debounceTimer);
    }, [query, activeFilter, searchNavigationPages]);

    // Keyboard navigation
    useEffect(() => {
        const handleKeyDown = (e) => {
            if (!isOpen) return;

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    setSelectedIndex(prev => Math.min(prev + 1, results.length - 1));
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    setSelectedIndex(prev => Math.max(prev - 1, 0));
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (results[selectedIndex]) {
                        handleSelectResult(results[selectedIndex]);
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    onClose();
                    break;
            }
        };

        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
    }, [isOpen, results, selectedIndex, onClose]);

    // Scroll selected item into view
    useEffect(() => {
        if (resultsContainerRef.current && results.length > 0) {
            const selectedElement = resultsContainerRef.current.children[selectedIndex];
            if (selectedElement) {
                selectedElement.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }
    }, [selectedIndex, results.length]);

    const handleSelectResult = useCallback((result) => {
        // Save to recent searches
        if (query) {
            searchService.saveRecentSearch(query);
        }
        onResultSelect(result);
    }, [query, onResultSelect]);

    const handleRecentSearchClick = useCallback((searchTerm) => {
        setQuery(searchTerm);
        inputRef.current?.focus();
    }, []);

    const clearRecentSearches = useCallback(() => {
        searchService.clearRecentSearches();
        setRecentSearches([]);
    }, []);

    // Group results by category for display
    const groupedResults = useMemo(() => {
        const groups = {};
        results.forEach(result => {
            const category = result.category || 'other';
            if (!groups[category]) groups[category] = [];
            groups[category].push(result);
        });
        return groups;
    }, [results]);

    if (!isOpen) return null;

    return (
        <motion.div
            className="fixed inset-0 z-[9999] flex items-start justify-center pt-[10vh] px-4"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ duration: 0.15 }}
        >
            {/* Backdrop */}
            <motion.div
                className="absolute inset-0 bg-slate-900/40 dark:bg-black/60 backdrop-blur-sm"
                onClick={onClose}
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
            />

            {/* Modal Content */}
            <motion.div
                className="relative w-full max-w-2xl bg-white/95 dark:bg-neutral-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-200/60 dark:border-neutral-700/60 overflow-hidden"
                initial={{ opacity: 0, scale: 0.95, y: -20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.95, y: -20 }}
                transition={{ type: 'spring', stiffness: 400, damping: 30 }}
            >
                {/* Search Input Section */}
                <div className="flex items-center gap-3 p-4 border-b border-slate-200 dark:border-neutral-700">
                    <Search size={20} className="text-slate-400 flex-shrink-0" />
                    <input
                        ref={inputRef}
                        type="text"
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        placeholder="Search projects, documents, users, pages..."
                        className="flex-1 bg-transparent text-slate-900 dark:text-white text-base placeholder-slate-400 dark:placeholder-neutral-500 focus:outline-none"
                        autoComplete="off"
                        spellCheck="false"
                    />
                    {isLoading && (
                        <Loader2 size={18} className="text-primary-500 animate-spin flex-shrink-0" />
                    )}
                    {query && !isLoading && (
                        <button
                            onClick={() => setQuery('')}
                            className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-lg transition-colors"
                        >
                            <X size={16} className="text-slate-400" />
                        </button>
                    )}
                    <button
                        onClick={() => setShowFilters(!showFilters)}
                        className={`p-2 rounded-lg transition-colors ${showFilters ? 'bg-primary-100 dark:bg-primary-900/30 text-primary-600' : 'hover:bg-slate-100 dark:hover:bg-neutral-800 text-slate-500 dark:text-neutral-400'}`}
                        title="Toggle filters"
                    >
                        <Filter size={16} />
                    </button>
                </div>

                {/* Filter Pills */}
                {showFilters && (
                    <motion.div
                        className="px-4 py-3 border-b border-slate-200 dark:border-neutral-700 bg-slate-50/50 dark:bg-neutral-800/50"
                        initial={{ height: 0, opacity: 0 }}
                        animate={{ height: 'auto', opacity: 1 }}
                        exit={{ height: 0, opacity: 0 }}
                    >
                        <div className="flex flex-wrap gap-2">
                            {FILTER_CATEGORIES.map((filter) => {
                                const Icon = filter.icon;
                                return (
                                    <button
                                        key={filter.id}
                                        onClick={() => setActiveFilter(filter.id)}
                                        className={`
                      flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium
                      transition-all duration-150
                      ${activeFilter === filter.id
                                                ? 'bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400 border border-primary-200 dark:border-primary-700'
                                                : 'bg-white dark:bg-neutral-800 text-slate-600 dark:text-neutral-300 border border-slate-200 dark:border-neutral-700 hover:border-slate-300 dark:hover:border-neutral-600 hover:bg-slate-50 dark:hover:bg-neutral-700'
                                            }
                    `}
                                    >
                                        <Icon size={14} />
                                        {filter.label}
                                    </button>
                                );
                            })}
                        </div>
                    </motion.div>
                )}

                {/* Results Section */}
                <div
                    ref={resultsContainerRef}
                    className="max-h-[60vh] overflow-y-auto overscroll-contain"
                >
                    {/* No query - show recent searches */}
                    {!query && recentSearches.length > 0 && (
                        <div className="p-4">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wide">
                                    Recent Searches
                                </h3>
                                <button
                                    onClick={clearRecentSearches}
                                    className="text-xs text-slate-400 dark:text-neutral-500 hover:text-slate-600 dark:hover:text-neutral-300 transition-colors"
                                >
                                    Clear all
                                </button>
                            </div>
                            <div className="space-y-1">
                                {recentSearches.slice(0, 5).map((term, index) => (
                                    <button
                                        key={index}
                                        onClick={() => handleRecentSearchClick(term)}
                                        className="flex items-center gap-3 w-full px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-neutral-800 transition-colors text-left group"
                                    >
                                        <Clock size={14} className="text-slate-400" />
                                        <span className="text-sm text-slate-600 dark:text-neutral-300 flex-1">{term}</span>
                                        <ArrowRight size={14} className="text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity" />
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* No query and no recent - show quick navigation */}
                    {!query && recentSearches.length === 0 && (
                        <div className="p-4">
                            <h3 className="text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wide mb-3">
                                Quick Navigation
                            </h3>
                            <div className="grid grid-cols-2 gap-2">
                                {NAVIGATION_PAGES.slice(0, 8).map((page) => {
                                    const Icon = page.icon;
                                    return (
                                        <button
                                            key={page.id}
                                            onClick={() => handleSelectResult(page)}
                                            className="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-neutral-800 transition-colors text-left group"
                                        >
                                            <div className="p-1.5 rounded-md bg-slate-100 dark:bg-neutral-700 group-hover:bg-primary-100 dark:group-hover:bg-primary-900/30 transition-colors">
                                                <Icon size={14} className="text-slate-500 dark:text-neutral-400 group-hover:text-primary-600" />
                                            </div>
                                            <span className={`text-sm font-medium text-slate-700 dark:text-neutral-200 ${page.noTranslate ? 'notranslate' : ''}`}>{page.title}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Search Results */}
                    {query && results.length > 0 && (
                        <div className="py-2">
                            {Object.entries(groupedResults).map(([category, items]) => (
                                <div key={category} className="mb-4">
                                    <h3 className="px-4 py-2 text-xs font-semibold text-slate-500 dark:text-neutral-400 uppercase tracking-wide bg-slate-50/50 dark:bg-neutral-800/50">
                                        {category === 'pages' ? 'Navigation Pages' :
                                            category === 'projects' ? 'Projects' :
                                                category === 'documents' ? 'Documents' :
                                                    category === 'users' ? 'Users' :
                                                        category === 'communications' ? 'Messages' :
                                                            category === 'tasks' ? 'Tasks' :
                                                                category}
                                    </h3>
                                    <div>
                                        {items.map((result, index) => {
                                            const globalIndex = results.indexOf(result);
                                            return (
                                                <SearchResultItem
                                                    key={result.id}
                                                    result={result}
                                                    isSelected={globalIndex === selectedIndex}
                                                    onClick={() => handleSelectResult(result)}
                                                    query={query}
                                                />
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* No results */}
                    {query && query.length >= 2 && results.length === 0 && !isLoading && (
                        <div className="py-12 text-center">
                            <Search size={40} className="mx-auto text-slate-300 mb-3" />
                            <p className="text-slate-500 dark:text-neutral-400 font-medium">No results found for "{query}"</p>
                            <p className="text-slate-400 dark:text-neutral-500 text-sm mt-1">Try a different search term</p>
                        </div>
                    )}

                    {/* Loading shimmer */}
                    {isLoading && query && (
                        <div className="p-4 space-y-3">
                            {[1, 2, 3].map((i) => (
                                <div key={i} className="flex items-center gap-3 animate-pulse">
                                    <div className="w-10 h-10 bg-slate-200 dark:bg-neutral-700 rounded-lg" />
                                    <div className="flex-1">
                                        <div className="h-4 bg-slate-200 dark:bg-neutral-700 rounded w-1/3 mb-2" />
                                        <div className="h-3 bg-slate-100 dark:bg-neutral-800 rounded w-2/3" />
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* Footer with keyboard hints */}
                <div className="px-4 py-3 border-t border-slate-200/60 dark:border-neutral-700/60 bg-slate-50/50 dark:bg-neutral-800/50">
                    <div className="flex items-center justify-between text-xs text-slate-400 dark:text-neutral-500">
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-1">
                                <kbd className="px-1.5 py-0.5 bg-white dark:bg-neutral-800 rounded border border-slate-200 dark:border-neutral-700 font-mono">
                                    <ArrowUp size={10} />
                                </kbd>
                                <kbd className="px-1.5 py-0.5 bg-white dark:bg-neutral-800 rounded border border-slate-200 dark:border-neutral-700 font-mono">
                                    <ArrowDown size={10} />
                                </kbd>
                                <span className="ml-1">Navigate</span>
                            </div>
                            <div className="flex items-center gap-1">
                                <kbd className="px-1.5 py-0.5 bg-white dark:bg-neutral-800 rounded border border-slate-200 dark:border-neutral-700 font-mono text-[10px]">
                                    Enter
                                </kbd>
                                <span className="ml-1">Select</span>
                            </div>
                            <div className="flex items-center gap-1">
                                <kbd className="px-1.5 py-0.5 bg-white dark:bg-neutral-800 rounded border border-slate-200 dark:border-neutral-700 font-mono text-[10px]">
                                    Esc
                                </kbd>
                                <span className="ml-1">Close</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-1">
                            <Filter size={12} />
                            <span>Press Tab to filter</span>
                        </div>
                    </div>
                </div>
            </motion.div>
        </motion.div>
    );
};

export default SearchModal;



================================================
FILE: frontend/src/components/search/SearchResultItem.jsx
================================================
import { memo, useMemo } from 'react';
import { motion } from 'framer-motion';
import {
    FileText,
    Users,
    FolderOpen,
    Calendar,
    MessageSquare,
    Building2,
    LayoutDashboard,
    ChevronRight,
    Briefcase,
    Receipt,
    Map,
    Box,
    Workflow,
    CreditCard,
    Shield,
    Settings,
    CheckCircle2,
    BookOpen,
    ArrowRight
} from 'lucide-react';

// Icon map for different result types
const ICON_MAP = {
    page: LayoutDashboard,
    pages: LayoutDashboard,
    project: Briefcase,
    projects: Briefcase,
    document: FileText,
    documents: FileText,
    user: Users,
    users: Users,
    message: MessageSquare,
    communications: MessageSquare,
    task: Calendar,
    tasks: Calendar,
    contractor: Building2,
    contractors: Building2,
    approval: CheckCircle2,
    approvals: CheckCircle2,
    default: FileText,
};

// Category color map
const CATEGORY_COLORS = {
    pages: 'bg-blue-100 text-blue-600',
    projects: 'bg-emerald-100 text-emerald-600',
    documents: 'bg-amber-100 text-amber-600',
    users: 'bg-purple-100 text-purple-600',
    communications: 'bg-pink-100 text-pink-600',
    tasks: 'bg-cyan-100 text-cyan-600',
    contractors: 'bg-orange-100 text-orange-600',
    default: 'bg-slate-100 text-slate-600',
};

/**
 * Highlights matching text in the title
 */
const highlightMatch = (text, query) => {
    if (!query || !text) return text;

    const normalizedQuery = query.toLowerCase().trim();
    const normalizedText = text.toLowerCase();
    const index = normalizedText.indexOf(normalizedQuery);

    if (index === -1) return text;

    return (
        <>
            {text.slice(0, index)}
            <mark className="bg-primary-100 text-primary-700 rounded px-0.5">
                {text.slice(index, index + query.length)}
            </mark>
            {text.slice(index + query.length)}
        </>
    );
};

/**
 * SearchResultItem - Individual search result with icon, title, description
 * 
 * Props:
 * - result: { id, title, description, category, path, icon?, metadata? }
 * - isSelected: boolean - Currently selected via keyboard
 * - onClick: () => void
 * - query: string - Search query for highlighting
 */
const SearchResultItem = memo(({ result, isSelected, onClick, query }) => {
    // Get icon component
    const IconComponent = useMemo(() => {
        if (result.icon) return result.icon;
        return ICON_MAP[result.type] || ICON_MAP[result.category] || ICON_MAP.default;
    }, [result.icon, result.type, result.category]);

    // Get category color
    const categoryColor = useMemo(() => {
        return CATEGORY_COLORS[result.category] || CATEGORY_COLORS.default;
    }, [result.category]);

    return (
        <motion.button
            onClick={onClick}
            className={`
        w-full flex items-center gap-3 px-4 py-3 text-left
        transition-all duration-150 group
        ${isSelected
                    ? 'bg-primary-50 border-l-2 border-l-primary-500'
                    : 'hover:bg-slate-50 border-l-2 border-l-transparent'
                }
      `}
            initial={false}
            animate={{
                backgroundColor: isSelected ? 'rgb(239 246 255)' : 'transparent'
            }}
            transition={{ duration: 0.1 }}
        >
            {/* Icon */}
            <div className={`
        flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center
        transition-colors duration-150
        ${isSelected ? 'bg-primary-100' : categoryColor}
      `}>
                <IconComponent
                    size={18}
                    className={isSelected ? 'text-primary-600' : ''}
                />
            </div>

            {/* Content */}
            <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                    <span className={`
            font-medium text-sm truncate
            ${isSelected ? 'text-primary-900' : 'text-slate-800'}
            ${result.noTranslate ? 'notranslate' : ''}
          `}>
                        {highlightMatch(result.title, query)}
                    </span>
                    {result.metadata?.status && (
                        <span className={`
              text-xs px-2 py-0.5 rounded-full
              ${result.metadata.status === 'active' ? 'bg-green-100 text-green-700' :
                                result.metadata.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                    'bg-slate-100 text-slate-600'}
            `}>
                            {result.metadata.status}
                        </span>
                    )}
                </div>
                {result.description && (
                    <p className={`
            text-xs truncate mt-0.5
            ${isSelected ? 'text-primary-600' : 'text-slate-500'}
          `}>
                        {result.description}
                    </p>
                )}
                {result.metadata?.breadcrumb && (
                    <p className="text-xs text-slate-400 truncate mt-0.5 flex items-center gap-1">
                        {result.metadata.breadcrumb.map((crumb, i) => (
                            <span key={i} className="flex items-center">
                                {i > 0 && <ChevronRight size={10} className="mx-0.5" />}
                                {crumb}
                            </span>
                        ))}
                    </p>
                )}
            </div>

            {/* Arrow indicator */}
            <div className={`
        flex-shrink-0 transition-all duration-150
        ${isSelected ? 'opacity-100 translate-x-0' : 'opacity-0 -translate-x-2'}
      `}>
                <ArrowRight size={16} className="text-primary-500" />
            </div>
        </motion.button>
    );
});

SearchResultItem.displayName = 'SearchResultItem';

export default SearchResultItem;



================================================
FILE: frontend/src/components/ui/AnimatedChart.jsx
================================================
import { useId } from 'react';
import {
  BarChart,
  Bar,
  LineChart,
  Line,
  PieChart,
  Pie,
  Cell,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from 'recharts';

// Custom tooltip style
const tooltipStyle = {
  backgroundColor: 'rgba(255, 255, 255, 0.98)',
  backdropFilter: 'blur(12px)',
  border: '1px solid #e2e8f0',
  borderRadius: '12px',
  padding: '12px',
  boxShadow: '0 10px 40px -10px rgba(0, 0, 0, 0.15)',
};

export const AnimatedBarChart = ({
  data,
  dataKey,
  secondaryDataKey,
  height = 300,
  color = '#10b981',
  secondaryColor = '#3b82f6',
  name,
  secondaryName
}) => {
  // Use stable ID for gradients
  const id = useId();
  const gradientId = `barGradient-${id.replace(/:/g, '')}`;
  const secondaryGradientId = `barGradient2-${id.replace(/:/g, '')}`;

  return (
    <ResponsiveContainer width="100%" height={height}>
      <BarChart data={data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
        <defs>
          <linearGradient id={gradientId} x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor={color} stopOpacity={1} />
            <stop offset="100%" stopColor={color} stopOpacity={0.7} />
          </linearGradient>
          {secondaryDataKey && (
            <linearGradient id={secondaryGradientId} x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stopColor={secondaryColor} stopOpacity={1} />
              <stop offset="100%" stopColor={secondaryColor} stopOpacity={0.7} />
            </linearGradient>
          )}
        </defs>
        <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" vertical={false} />
        <XAxis
          dataKey="name"
          angle={-45}
          textAnchor="end"
          height={100}
          stroke="#64748b"
          tick={{ fontSize: 12 }}
          axisLine={{ stroke: '#e2e8f0' }}
        />
        <YAxis
          stroke="#64748b"
          tick={{ fontSize: 12 }}
          axisLine={{ stroke: '#e2e8f0' }}
        />
        <Tooltip
          contentStyle={tooltipStyle}
          cursor={{ fill: 'rgba(0, 0, 0, 0.04)' }}
        />
        {(name || secondaryName) && <Legend />}
        <Bar
          dataKey={dataKey}
          fill={`url(#${gradientId})`}
          radius={[4, 4, 0, 0]}
          animationBegin={100}
          animationDuration={1200}
          animationEasing="ease-out"
          name={name || dataKey}
        >
          {data.map((_entry, index) => (
            <Cell
              key={`cell-${index}`}
              fill={`url(#${gradientId})`}
              style={{
                filter: 'drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1))',
                transition: 'all 0.3s ease',
              }}
            />
          ))}
        </Bar>
        {secondaryDataKey && (
          <Bar
            dataKey={secondaryDataKey}
            fill={`url(#${secondaryGradientId})`}
            radius={[4, 4, 0, 0]}
            animationBegin={200}
            animationDuration={1200}
            animationEasing="ease-out"
            name={secondaryName || secondaryDataKey}
          >
            {data.map((_entry, index) => (
              <Cell
                key={`cell2-${index}`}
                fill={`url(#${secondaryGradientId})`}
                style={{
                  filter: 'drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1))',
                  transition: 'all 0.3s ease',
                }}
              />
            ))}
          </Bar>
        )}
      </BarChart>
    </ResponsiveContainer>
  );
};

export const AnimatedLineChart = ({ data, dataKey, height = 300, color = '#8b5cf6', name }) => {
  // Use stable ID for gradients
  const id = useId();
  const gradientId = `lineGradient-${id.replace(/:/g, '')}`;
  const glowFilterId = `glow-${id.replace(/:/g, '')}`;

  return (
    <ResponsiveContainer width="100%" height={height}>
      <LineChart data={data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
        <defs>
          <linearGradient id={gradientId} x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor={color} stopOpacity={0.3} />
            <stop offset="100%" stopColor={color} stopOpacity={0} />
          </linearGradient>
          <filter id={glowFilterId}>
            <feGaussianBlur stdDeviation="2" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>
        </defs>
        <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" vertical={false} />
        <XAxis
          dataKey="name"
          angle={-45}
          textAnchor="end"
          height={100}
          stroke="#64748b"
          tick={{ fontSize: 12 }}
          axisLine={{ stroke: '#e2e8f0' }}
        />
        <YAxis
          stroke="#64748b"
          tick={{ fontSize: 12 }}
          axisLine={{ stroke: '#e2e8f0' }}
        />
        <Tooltip contentStyle={tooltipStyle} />
        {name && <Legend />}
        <Line
          type="monotone"
          dataKey={dataKey}
          stroke={color}
          strokeWidth={3}
          dot={{
            fill: '#fff',
            stroke: color,
            strokeWidth: 2,
            r: 5,
            filter: `url(#${glowFilterId})`
          }}
          activeDot={{
            r: 8,
            fill: color,
            stroke: '#fff',
            strokeWidth: 2,
            filter: `url(#${glowFilterId})`
          }}
          animationBegin={200}
          animationDuration={1500}
          animationEasing="ease-out"
        />
      </LineChart>
    </ResponsiveContainer>
  );
};

// Custom label renderer with animation
const renderCustomLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent, name }) => {
  const RADIAN = Math.PI / 180;
  const radius = innerRadius + (outerRadius - innerRadius) * 1.4;
  const x = cx + radius * Math.cos(-midAngle * RADIAN);
  const y = cy + radius * Math.sin(-midAngle * RADIAN);

  if (percent < 0.05) return null; // Don't show labels for very small slices

  return (
    <text
      x={x}
      y={y}
      fill="#475569"
      textAnchor={x > cx ? 'start' : 'end'}
      dominantBaseline="central"
      style={{
        fontSize: '12px',
        fontWeight: 500,
        textShadow: '0 1px 2px rgba(255,255,255,0.8)'
      }}
    >
      {`${name}: ${(percent * 100).toFixed(0)}%`}
    </text>
  );
};

export const AnimatedPieChart = ({
  data,
  dataKey,
  height = 300,
  colors = ['#10b981', '#8b5cf6', '#f59e0b', '#f43f5e', '#06b6d4'], // Emerald, Violet, Amber, Rose, Cyan
  nameKey = 'name',
  showCenterLabel = true,
  centerLabel = 'Total',
}) => {
  // Use stable ID for gradients and filters
  const id = useId();
  const baseId = id.replace(/:/g, '');
  const shadowFilterId = `pieShadow-${baseId}`;

  // Calculate total for center label
  const total = data.reduce((sum, item) => sum + (item[dataKey] || 0), 0);

  // Custom center label component
  const renderCenterLabel = () => {
    if (!showCenterLabel) return null;
    return (
      <g>
        <text
          x="50%"
          y="46%"
          textAnchor="middle"
          dominantBaseline="middle"
          className="fill-slate-800 dark:fill-white"
          style={{ fontSize: '24px', fontWeight: 700 }}
        >
          {total}
        </text>
        <text
          x="50%"
          y="56%"
          textAnchor="middle"
          dominantBaseline="middle"
          className="fill-slate-500 dark:fill-neutral-400"
          style={{ fontSize: '11px', fontWeight: 500 }}
        >
          {centerLabel}
        </text>
      </g>
    );
  };

  return (
    <ResponsiveContainer width="100%" height={height}>
      <PieChart>
        <defs>
          {colors.map((color, index) => (
            <linearGradient key={index} id={`pieGradient-${baseId}-${index}`} x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stopColor={color} stopOpacity={1} />
              <stop offset="100%" stopColor={color} stopOpacity={0.8} />
            </linearGradient>
          ))}
          <filter id={shadowFilterId} x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="4" stdDeviation="4" floodOpacity="0.15" />
          </filter>
        </defs>
        <Pie
          data={data}
          cx="50%"
          cy="50%"
          labelLine={false}
          label={renderCustomLabel}
          outerRadius={85}
          innerRadius={50}
          fill="#8884d8"
          dataKey={dataKey}
          nameKey={nameKey}
          animationBegin={0}
          animationDuration={1200}
          animationEasing="ease-out"
          paddingAngle={3}
          style={{ filter: `url(#${shadowFilterId})` }}
        >
          {data.map((_entry, index) => (
            <Cell
              key={`cell-${index}`}
              fill={`url(#pieGradient-${baseId}-${index % colors.length})`}
              stroke="#fff"
              strokeWidth={2}
              style={{
                transition: 'all 0.3s ease',
                cursor: 'pointer',
              }}
            />
          ))}
        </Pie>
        {renderCenterLabel()}
        <Tooltip
          contentStyle={tooltipStyle}
          formatter={(value, name) => [`${value} projects`, name]}
        />
        <Legend
          layout="horizontal"
          verticalAlign="bottom"
          align="center"
          wrapperStyle={{ paddingTop: '10px' }}
        />
      </PieChart>
    </ResponsiveContainer>
  );
};










================================================
FILE: frontend/src/components/ui/Breadcrumbs.jsx
================================================
import { Link, useLocation } from 'react-router-dom';
import { ChevronRight, Home } from 'lucide-react';
import { useLanguage } from '@/contexts/LanguageContext';
import { cn } from '@/lib/utils';

export const Breadcrumbs = () => {
  const location = useLocation();
  const { t } = useLanguage();

  const pathMap = {
    '/dashboard': t('common.dashboard'),

    '/scheduling': t('common.schedule'),
    '/cost': t('common.cost'),
    '/risk': t('common.risk'),
    '/gis': t('common.gis'),
    '/bim': t('common.bim'),
  };

  const generateBreadcrumbs = () => {
    const paths = location.pathname.split('/').filter(Boolean);
    const breadcrumbs = [{ label: t('common.dashboard'), path: '/dashboard' }];

    if (paths.length === 0) return breadcrumbs;

    paths.forEach((path, index) => {
      const fullPath = '/' + paths.slice(0, index + 1).join('/');
      const label = pathMap[fullPath] || path.charAt(0).toUpperCase() + path.slice(1);
      breadcrumbs.push({
        label,
        path: index === paths.length - 1 ? undefined : fullPath,
      });
    });

    return breadcrumbs;
  };

  const breadcrumbs = generateBreadcrumbs();

  if (breadcrumbs.length <= 1) return null;

  return (
    <nav className="flex items-center space-x-2 text-sm mb-4" aria-label="Breadcrumb">
      {breadcrumbs.map((crumb, index) => {
        const isLast = index === breadcrumbs.length - 1;
        return (
          <div key={crumb.path || index} className="flex items-center">
            {index === 0 ? (
              <Link
                to={crumb.path || '#'}
                className={cn(
                  'flex items-center text-slate-500 dark:text-neutral-400 hover:text-slate-700 dark:hover:text-neutral-200',
                  isLast && 'text-slate-900 dark:text-white font-medium'
                )}
                aria-label="Home"
              >
                <Home size={16} />
              </Link>
            ) : (
              <>
                <ChevronRight size={16} className="text-slate-400 dark:text-neutral-600 mx-2" />
                {isLast ? (
                  <span className="text-slate-900 dark:text-white font-medium">{crumb.label}</span>
                ) : (
                  <Link
                    to={crumb.path || '#'}
                    className="text-slate-500 dark:text-neutral-400 hover:text-slate-700 dark:hover:text-neutral-200 transition-colors"
                  >
                    {crumb.label}
                  </Link>
                )}
              </>
            )}
          </div>
        );
      })}
    </nav>
  );
};










================================================
FILE: frontend/src/components/ui/Button.jsx
================================================
import { forwardRef, useState } from 'react';
import { motion } from 'framer-motion';
import { cn } from '@/lib/utils';

const Button = forwardRef(
  ({ className, variant = 'default', size = 'md', children, ...props }, ref) => {
    const [hovered, setHovered] = useState(false);

    if (variant === 'default') {
      return (
        <motion.button
          ref={ref}
          className={cn(
            'relative inline-flex items-center justify-center rounded-xl font-medium',
            'overflow-hidden transition-all duration-200',
            'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary-600 focus-visible:ring-offset-2',
            'disabled:pointer-events-none disabled:opacity-50',
            {
              'h-8 px-3 text-sm': size === 'sm',
              'h-10 px-4': size === 'md',
              'h-12 px-6 text-lg': size === 'lg',
            },
            className
          )}
          onHoverStart={() => setHovered(true)}
          onHoverEnd={() => setHovered(false)}
          whileTap={{ scale: 0.97 }}
          whileHover={{ scale: 1.01 }}
          {...props}
        >
          {/* Liquid background gradient */}
          <motion.div
            className="absolute inset-0 bg-gradient-to-r from-primary-600 via-primary-700 to-primary-600"
            initial={false}
            animate={{
              backgroundPosition: hovered ? ['0% 50%', '100% 50%', '0% 50%'] : '0% 50%',
            }}
            transition={{
              duration: 1.5,
              repeat: hovered ? Infinity : 0,
              ease: 'linear',
            }}
            style={{
              backgroundSize: '200% 100%',
            }}
          />

          {/* Shine effect */}
          <motion.div
            className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent"
            initial={{ x: '-100%' }}
            animate={{ x: hovered ? '100%' : '-100%' }}
            transition={{ duration: 0.6, ease: 'easeInOut' }}
          />

          <span className="relative z-10 text-white font-semibold flex items-center gap-2 whitespace-nowrap">{children}</span>
        </motion.button>
      );
    }

    return (
      <motion.button
        ref={ref}
        className={cn(
          'inline-flex items-center justify-center rounded-xl font-medium transition-all duration-200',
          'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary-600 focus-visible:ring-offset-2',
          'disabled:pointer-events-none disabled:opacity-50',
          {
            'border border-app-subtle bg-app-card text-app-heading hover:bg-app-hover': variant === 'outline',
            'text-app-heading hover:bg-app-hover': variant === 'ghost',
            'bg-red-600 dark:bg-red-700 text-white hover:bg-red-700 dark:hover:bg-red-800': variant === 'destructive',
            'h-8 px-3 text-sm': size === 'sm',
            'h-10 px-4': size === 'md',
            'h-12 px-6 text-lg': size === 'lg',
          },
          className
        )}
        whileTap={{ scale: 0.97 }}
        whileHover={{ scale: 1.01, y: -1 }}
        {...props}
      >
        <span className="flex items-center gap-2 whitespace-nowrap">{children}</span>
      </motion.button>
    );
  }
);

Button.displayName = 'Button';

export default Button;










================================================
FILE: frontend/src/components/ui/Card.jsx
================================================
import { forwardRef } from 'react';
import { cn } from '@/lib/utils';

const Card = forwardRef(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn('rounded-2xl border border-app-subtle bg-app-card/90 backdrop-blur-md shadow-sm dark:shadow-md', className)}
        {...props}
      />
    );
  }
);

Card.displayName = 'Card';

const CardHeader = forwardRef(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn('flex flex-col space-y-1.5 p-6', className)}
        {...props}
      />
    );
  }
);

CardHeader.displayName = 'CardHeader';

const CardTitle = forwardRef(
  ({ className, ...props }, ref) => {
    return (
      <h3
        ref={ref}
        className={cn('text-lg font-semibold leading-none tracking-tight text-app-heading', className)}
        {...props}
      />
    );
  }
);

CardTitle.displayName = 'CardTitle';

const CardContent = forwardRef(
  ({ className, ...props }, ref) => {
    return <div ref={ref} className={cn('p-6 pt-0', className)} {...props} />;
  }
);

CardContent.displayName = 'CardContent';

export { Card, CardHeader, CardTitle, CardContent };










================================================
FILE: frontend/src/components/ui/ContractorSearchDropdown.jsx
================================================
import { useState, useEffect, useRef } from 'react';
import { Search, User, X, Loader2, Building2 } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import client from '@/api/client';

/**
 * ContractorSearchDropdown - Searchable dropdown for contractor selection
 * 
 * Government-grade component matching uploaded UI design with:
 * - Active contractors with linked accounts only
 * - Avatar circles with contractor initials
 * - Display contractor code, class, registration info
 * - Dark mode support
 * - Keyboard navigation
 * - NO Invite option (contractors self-register)
 * 
 * @param {Object} props
 * @param {Function} props.onSelect - Callback when contractor is selected
 * @param {string} props.value - Selected contractor ID
 * @param {string} props.label - Label text
 * @param {boolean} props.required - Whether field is required
 * @param {string} props.placeholder - Placeholder text
 * @param {string} props.error - Error message to display
 */
export const ContractorSearchDropdown = ({
    onSelect,
    value,
    label = "Select Contractor",
    required = false,
    placeholder = "Select or search contractors...",
    error = null
}) => {
    const [isOpen, setIsOpen] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [contractors, setContractors] = useState([]);
    const [allContractors, setAllContractors] = useState([]);
    const [loading, setLoading] = useState(false);
    const [highlightedIndex, setHighlightedIndex] = useState(0);
    const [selectedContractor, setSelectedContractor] = useState(null);

    const dropdownRef = useRef(null);
    const searchInputRef = useRef(null);

    // Load active contractors with linked accounts on mount
    useEffect(() => {
        const fetchContractors = async () => {
            setLoading(true);
            try {
                const response = await client.get('/masters/contractors/active_with_accounts/');
                const contractorsList = response.data?.results || response.data || [];
                setAllContractors(contractorsList);
                setContractors(contractorsList);
            } catch (err) {
                console.error('Failed to load contractors:', err);
            } finally {
                setLoading(false);
            }
        };

        fetchContractors();
    }, []);

    // Filter contractors based on search query (client-side for performance)
    useEffect(() => {
        if (!searchQuery) {
            setContractors(allContractors);
            return;
        }

        const query = searchQuery.toLowerCase();
        const filtered = allContractors.filter(contractor =>
            contractor.name?.toLowerCase().includes(query) ||
            contractor.code?.toLowerCase().includes(query) ||
            contractor.pan?.toLowerCase().includes(query) ||
            contractor.email?.toLowerCase().includes(query)
        );

        setContractors(filtered);
    }, [searchQuery, allContractors]);

    // Load selected contractor if value is provided
    useEffect(() => {
        if (value && !selectedContractor) {
            const contractor = allContractors.find(c => c.id === value);
            if (contractor) {
                setSelectedContractor(contractor);
            }
        }
    }, [value, allContractors, selectedContractor]);

    // Close dropdown when clicking outside
    useEffect(() => {
        const handleClickOutside = (e) => {
            if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
                setIsOpen(false);
            }
        };

        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    // Handle keyboard navigation
    const handleKeyDown = (e) => {
        if (!isOpen) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                setIsOpen(true);
                setTimeout(() => searchInputRef.current?.focus(), 100);
            }
            return;
        }

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                setHighlightedIndex(prev =>
                    prev < contractors.length - 1 ? prev + 1 : prev
                );
                break;
            case 'ArrowUp':
                e.preventDefault();
                setHighlightedIndex(prev => prev > 0 ? prev - 1 : 0);
                break;
            case 'Enter':
                e.preventDefault();
                if (contractors[highlightedIndex]) {
                    handleSelect(contractors[highlightedIndex]);
                }
                break;
            case 'Escape':
                e.preventDefault();
                setIsOpen(false);
                break;
            default:
                break;
        }
    };

    const handleSelect = (contractor) => {
        setSelectedContractor(contractor);
        onSelect(contractor);
        setIsOpen(false);
        setSearchQuery('');
    };

    const handleClear = (e) => {
        e.stopPropagation();
        setSelectedContractor(null);
        onSelect(null);
        setSearchQuery('');
    };

    return (
        <div className="relative" ref={dropdownRef} onKeyDown={handleKeyDown}>
            {/* Label */}
            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                {label} {required && <span className="text-red-500 dark:text-red-400">*</span>}
            </label>

            {/* Dropdown Trigger */}
            <button
                type="button"
                onClick={() => setIsOpen(!isOpen)}
                className={`
                    w-full flex items-center justify-between px-4 py-2.5 border rounded-xl text-left transition-all
                    ${error ? 'border-red-500 dark:border-red-700' : isOpen ? 'border-primary-500 dark:border-primary-400 ring-2 ring-primary-100 dark:ring-primary-900' : 'border-slate-200 dark:border-neutral-700 hover:border-slate-300 dark:hover:border-neutral-600'}
                    bg-white dark:bg-neutral-900
                `}
                tabIndex={0}
            >
                {selectedContractor ? (
                    <div className="flex items-center gap-3 flex-1 min-w-0">
                        <div className="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 dark:text-primary-400 font-bold text-sm flex-shrink-0">
                            {selectedContractor.code?.slice(-2) || '??'}
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="font-medium text-slate-800 dark:text-white truncate">{selectedContractor.name}</p>
                            <p className="text-xs text-slate-500 dark:text-neutral-400 truncate">{selectedContractor.code}</p>
                        </div>
                        <div
                            onClick={handleClear}
                            className="p-1 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-full text-slate-400 dark:text-neutral-500 hover:text-slate-600 dark:hover:text-neutral-300 cursor-pointer"
                        >
                            <X size={16} />
                        </div>
                    </div>
                ) : (
                    <span className="text-slate-400 dark:text-neutral-500">{placeholder}</span>
                )}
            </button>

            {/* Error Message */}
            {error && (
                <p className="text-xs text-red-500 dark:text-red-400 mt-1">{error}</p>
            )}

            {/* Dropdown Menu */}
            <AnimatePresence>
                {isOpen && (
                    <motion.div
                        initial={{ opacity: 0, y: -10 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: -10 }}
                        transition={{ duration: 0.15 }}
                        className="absolute z-50 w-full mt-1 bg-white dark:bg-neutral-800 border border-slate-200 dark:border-neutral-700 rounded-xl shadow-lg overflow-hidden"
                    >
                        {/* Search Input */}
                        <div className="p-2 border-b border-slate-100 dark:border-neutral-700">
                            <div className="relative">
                                <Search className="absolute left-3 top-2.5 text-slate-400 dark:text-neutral-500" size={16} />
                                <input
                                    ref={searchInputRef}
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="Search by name, code, PAN..."
                                    className="w-full pl-9 pr-3 py-2 border border-slate-200 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 outline-none text-sm placeholder:text-slate-400 dark:placeholder:text-neutral-500"
                                    autoFocus
                                />
                            </div>
                        </div>

                        {/* Results */}
                        <div className="max-h-64 overflow-y-auto">
                            {loading ? (
                                <div className="p-4 text-center text-slate-500 dark:text-neutral-400">
                                    <Loader2 className="animate-spin inline-block" size={20} />
                                    <span className="ml-2">Loading contractors...</span>
                                </div>
                            ) : contractors.length === 0 ? (
                                <div className="p-4 text-center text-slate-500 dark:text-neutral-400">
                                    {searchQuery ? 'No contractors found matching your search' : 'No active contractors with user accounts'}
                                </div>
                            ) : (
                                contractors.map((contractor, index) => (
                                    <button
                                        key={contractor.id}
                                        onClick={() => handleSelect(contractor)}
                                        className={`
                                            w-full flex items-center gap-3 px-3 py-2.5 text-left transition-colors
                                            ${highlightedIndex === index ? 'bg-primary-50 dark:bg-primary-900/20' : 'hover:bg-slate-50 dark:hover:bg-neutral-700'}
                                        `}
                                        onMouseEnter={() => setHighlightedIndex(index)}
                                    >
                                        <div className="w-9 h-9 rounded-full bg-slate-100 dark:bg-neutral-700 flex items-center justify-center text-slate-600 dark:text-neutral-300 font-bold text-sm flex-shrink-0">
                                            {contractor.code?.slice(-2) || '??'}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center justify-between gap-2">
                                                <p className="text-sm font-medium text-slate-900 dark:text-white truncate">
                                                    {contractor.name}
                                                </p>
                                                <span className="text-xs font-mono text-slate-500 dark:text-neutral-400 shrink-0">
                                                    {contractor.code}
                                                </span>
                                            </div>
                                            <div className="flex items-center gap-2 mt-1">
                                                {contractor.registration_class && (
                                                    <span className="inline-block px-2 py-0.5 text-xs rounded bg-slate-100 dark:bg-neutral-700 text-slate-600 dark:text-neutral-300">
                                                        {contractor.registration_class}
                                                    </span>
                                                )}
                                                {contractor.email && (
                                                    <span className="text-xs text-slate-500 dark:text-neutral-400 truncate">
                                                        {contractor.email}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </button>
                                ))
                            )}
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    );
};

export default ContractorSearchDropdown;



================================================
FILE: frontend/src/components/ui/DynamicChart.jsx
================================================
import { useState, useEffect, useId } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { BarChart3, LineChart as LineChartIcon, PieChart as PieChartIcon, AreaChart, Loader2 } from 'lucide-react';
import { AnimatedBarChart, AnimatedLineChart, AnimatedPieChart } from './AnimatedChart';
import { AreaChart as RechartsAreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { cn } from '@/lib/utils';

// Skeleton loader component for charts
const ChartSkeleton = ({ height }) => (
  <div className="w-full relative overflow-hidden" style={{ height }}>
    {/* Animated gradient background */}
    <div className="absolute inset-0 bg-gradient-to-r from-slate-100 via-slate-200 to-slate-100 animate-pulse rounded-xl" />

    {/* Shimmer effect */}
    <motion.div
      className="absolute inset-0 bg-gradient-to-r from-transparent via-white/60 to-transparent"
      initial={{ x: '-100%' }}
      animate={{ x: '100%' }}
      transition={{
        duration: 1.5,
        repeat: Infinity,
        ease: 'linear',
      }}
    />

    {/* Skeleton bars */}
    <div className="absolute bottom-8 left-12 right-8 flex items-end justify-around gap-4">
      {[65, 85, 45, 70, 55].map((h, i) => (
        <motion.div
          key={i}
          className="flex-1 bg-slate-200/80 rounded-t-lg"
          initial={{ height: 0 }}
          animate={{ height: `${h}%` }}
          transition={{
            duration: 0.5,
            delay: i * 0.1,
            ease: 'easeOut',
          }}
          style={{ maxHeight: height - 60 }}
        />
      ))}
    </div>

    {/* Loading indicator */}
    <div className="absolute inset-0 flex items-center justify-center">
      <motion.div
        initial={{ opacity: 0, scale: 0.8 }}
        animate={{ opacity: 1, scale: 1 }}
        className="flex items-center gap-2 bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full shadow-lg"
      >
        <Loader2 className="w-5 h-5 text-primary-600 animate-spin" />
        <span className="text-sm font-medium text-slate-600">Loading chart...</span>
      </motion.div>
    </div>
  </div>
);

export const DynamicChart = ({
  data,
  dataKey,
  secondaryDataKey,
  height = 300,
  colors = ['#10b981', '#8b5cf6', '#f59e0b', '#f43f5e', '#06b6d4'],
  name,
  secondaryName,
  nameKey = 'name',
  title,
  defaultType = 'bar',
  loading: externalLoading,
}) => {
  const [chartType, setChartType] = useState(defaultType);
  const [isLoading, setIsLoading] = useState(true);
  const [showChart, setShowChart] = useState(false);

  // Simulate initial loading animation
  useEffect(() => {
    const loadingTimer = setTimeout(() => {
      setIsLoading(false);
    }, 800);

    const showTimer = setTimeout(() => {
      setShowChart(true);
    }, 900);

    return () => {
      clearTimeout(loadingTimer);
      clearTimeout(showTimer);
    };
  }, []);

  // Handle chart type change with loading animation
  const handleChartTypeChange = (type) => {
    if (type === chartType) return;
    setShowChart(false);
    setTimeout(() => {
      setChartType(type);
      setShowChart(true);
    }, 200);
  };

  const loading = externalLoading !== undefined ? externalLoading : isLoading;

  const chartTypes = [
    { type: 'bar', icon: BarChart3, label: 'Bar' },
    { type: 'line', icon: LineChartIcon, label: 'Line' },
    { type: 'pie', icon: PieChartIcon, label: 'Pie' },
    { type: 'area', icon: AreaChart, label: 'Area' },
  ];

  // Use stable ID for gradients to avoid conflicts between multiple charts
  const id = useId();
  const gradientId = `areaGradient-${id.replace(/:/g, '')}`;

  const renderChart = () => {
    switch (chartType) {
      case 'bar':
        return (
          <AnimatedBarChart
            data={data}
            dataKey={dataKey}
            secondaryDataKey={secondaryDataKey}
            height={height}
            color={colors[0]}
            secondaryColor={colors[1]}
            name={name}
            secondaryName={secondaryName}
          />
        );
      case 'line':
        return <AnimatedLineChart data={data} dataKey={dataKey} height={height} color={colors[1]} name={name} />;
      case 'pie':
        return <AnimatedPieChart data={data} dataKey={dataKey} height={height} colors={colors} nameKey={nameKey} />;
      case 'area':
        return (
          <ResponsiveContainer width="100%" height={height}>
            <RechartsAreaChart data={data}>
              <defs>
                <linearGradient id={gradientId} x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={colors[2]} stopOpacity={0.8} />
                  <stop offset="95%" stopColor={colors[2]} stopOpacity={0.1} />
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
              <XAxis dataKey={nameKey} angle={-45} textAnchor="end" height={100} stroke="#64748b" />
              <YAxis stroke="#64748b" />
              <Tooltip
                contentStyle={{
                  backgroundColor: 'rgba(255, 255, 255, 0.95)',
                  backdropFilter: 'blur(12px)',
                  border: '1px solid #e2e8f0',
                  borderRadius: '12px',
                  padding: '8px',
                }}
              />
              {name && <Legend />}
              <Area
                type="monotone"
                dataKey={dataKey}
                stroke={colors[2]}
                fill={`url(#${gradientId})`}
                strokeWidth={3}
                animationDuration={1000}
              />
            </RechartsAreaChart>
          </ResponsiveContainer>
        );
      default:
        return <AnimatedBarChart data={data} dataKey={dataKey} height={height} color={colors[0]} name={name} />;
    }
  };

  return (
    <div className="w-full">
      {(title || true) && (
        <div className="flex items-center justify-between mb-4">
          {title && <h3 className="text-lg font-semibold text-slate-900">{title}</h3>}
          <div className="flex items-center gap-2 bg-slate-100/50 rounded-lg p-1">
            {chartTypes.map(({ type, icon: Icon, label }) => (
              <motion.button
                key={type}
                onClick={() => handleChartTypeChange(type)}
                className={cn(
                  'flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all duration-200',
                  chartType === type
                    ? 'bg-white text-primary-600 shadow-sm'
                    : 'text-slate-600 hover:text-slate-900 hover:bg-white/50'
                )}
                whileHover={{ scale: 1.02 }}
                whileTap={{ scale: 0.98 }}
                aria-label={`Switch to ${label} chart`}
                disabled={loading}
              >
                <Icon size={16} />
                <span className="hidden sm:inline">{label}</span>
              </motion.button>
            ))}
          </div>
        </div>
      )}
      <AnimatePresence mode="wait">
        {loading ? (
          <motion.div
            key="skeleton"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ duration: 0.3 }}
          >
            <ChartSkeleton height={height} />
          </motion.div>
        ) : (
          <motion.div
            key={`chart-${chartType}`}
            initial={{ opacity: 0, y: 20, scale: 0.95 }}
            animate={{
              opacity: showChart ? 1 : 0,
              y: showChart ? 0 : 20,
              scale: showChart ? 1 : 0.95
            }}
            exit={{ opacity: 0, y: -20, scale: 0.95 }}
            transition={{
              duration: 0.4,
              ease: [0.4, 0, 0.2, 1],
              opacity: { duration: 0.3 }
            }}
          >
            {renderChart()}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

// Default export for compatibility
export default DynamicChart;










================================================
FILE: frontend/src/components/ui/EmptyState.jsx
================================================
import { motion } from 'framer-motion';
import { FileX, FolderOpen, Users, FileText, Search, Plus, Inbox } from 'lucide-react';

/**
 * EmptyState Component
 * 
 * Displays a professional empty state when no data is available.
 * Supports preset variants for common scenarios.
 */
export const EmptyState = ({
  icon: IconComponent = FileX,
  title = 'No data found',
  description = 'There are no items to display at the moment.',
  actionLabel = null,
  onAction = null,
  variant = null, // 'projects' | 'users' | 'documents' | 'search' | 'filter'
}) => {
  // Preset configurations for common variants
  const presets = {
    projects: {
      icon: FolderOpen,
      title: 'No projects found',
      description: 'Start by creating your first project to manage progress, schedules, and budgets.',
    },
    users: {
      icon: Users,
      title: 'No users found',
      description: 'Invite team members to collaborate on projects and review documents.',
    },
    documents: {
      icon: FileText,
      title: 'No documents found',
      description: 'Upload documents to maintain a centralized record for all project files.',
    },
    search: {
      icon: Search,
      title: 'No results found',
      description: 'Try adjusting your search terms or filters to find what you\'re looking for.',
    },
    filter: {
      icon: Search,
      title: 'No matching items',
      description: 'No items match your current filters. Try adjusting or clearing filters.',
    },
    inbox: {
      icon: Inbox,
      title: 'All caught up!',
      description: 'You have no pending items at this time.',
    },
  };

  const preset = variant ? presets[variant] : {};
  const FinalIcon = preset.icon || IconComponent;
  const finalTitle = preset.title || title;
  const finalDescription = preset.description || description;

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.4 }}
      className="flex flex-col items-center justify-center py-16 px-4 text-center"
    >
      <div className="w-20 h-20 bg-slate-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mb-6">
        <FinalIcon className="w-10 h-10 text-slate-400 dark:text-neutral-500" />
      </div>

      <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
        {finalTitle}
      </h3>

      <p className="text-slate-600 dark:text-neutral-400 max-w-md mb-6">
        {finalDescription}
      </p>

      {actionLabel && onAction && (
        <button
          onClick={onAction}
          className="inline-flex items-center gap-2 px-5 py-2.5 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors"
        >
          <Plus size={18} />
          {actionLabel}
        </button>
      )}
    </motion.div>
  );
};

/**
 * TableEmptyState Component
 * For use inside table tbody when no data
 */
export const TableEmptyState = ({
  message = 'No data available',
  colSpan = 1,
  icon: IconComponent = FileX,
}) => {
  return (
    <tr>
      <td colSpan={colSpan} className="py-16">
        <div className="flex flex-col items-center justify-center text-center">
          <div className="w-16 h-16 bg-slate-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mb-4">
            <IconComponent className="w-8 h-8 text-slate-400 dark:text-neutral-500" />
          </div>
          <p className="text-slate-500 dark:text-neutral-400 font-medium">{message}</p>
        </div>
      </td>
    </tr>
  );
};

/**
 * CardEmptyState Component
 * For use in card grids with col-span-full
 */
export const CardEmptyState = ({
  title = 'No items',
  description = 'Get started by creating your first item.',
  onAction = null,
  actionLabel = 'Create',
}) => {
  return (
    <div className="col-span-full">
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        className="bg-white/50 dark:bg-neutral-900/50 backdrop-blur-sm border-2 border-dashed border-slate-200 dark:border-neutral-700 rounded-2xl py-16 px-8"
      >
        <div className="flex flex-col items-center justify-center text-center">
          <div className="w-16 h-16 bg-slate-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mb-4">
            <FileX className="w-8 h-8 text-slate-400 dark:text-neutral-500" />
          </div>
          <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">{title}</h3>
          <p className="text-slate-500 dark:text-neutral-400 mb-6 max-w-sm">{description}</p>
          {onAction && (
            <button
              onClick={onAction}
              className="inline-flex items-center gap-2 px-5 py-2.5 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors"
            >
              <Plus size={18} />
              {actionLabel}
            </button>
          )}
        </div>
      </motion.div>
    </div>
  );
};

export default EmptyState;






================================================
FILE: frontend/src/components/ui/ErrorBoundary.jsx
================================================
import React from 'react';
import { AlertTriangle, RefreshCw, Home } from 'lucide-react';
import { Link } from 'react-router-dom';

/**
 * ErrorBoundary Component
 * 
 * Catches JavaScript errors anywhere in child component tree and displays
 * a fallback UI instead of crashing the entire application.
 * 
 * Features:
 * - Professional government-style error display
 * - Option to retry (refresh page)
 * - Option to go back to dashboard
 * - Logs errors for debugging
 */
class ErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
    }

    static getDerivedStateFromError(error) {
        // Update state so the next render shows the fallback UI
        return { hasError: true };
    }

    componentDidCatch(error, errorInfo) {
        // Log the error to console (in production, send to error reporting service)
        console.error('ErrorBoundary caught an error:', error, errorInfo);
        this.setState({
            error: error,
            errorInfo: errorInfo
        });

        // Could send to error reporting service here
        // logErrorToService(error, errorInfo);
    }

    handleRetry = () => {
        this.setState({ hasError: false, error: null, errorInfo: null });
        window.location.reload();
    };

    render() {
        if (this.state.hasError) {
            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full p-8 text-center">
                        {/* Icon */}
                        <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <AlertTriangle className="w-10 h-10 text-red-600" />
                        </div>

                        {/* Title */}
                        <h1 className="text-2xl font-bold text-slate-900 mb-3">
                            Something went wrong
                        </h1>

                        {/* Description */}
                        <p className="text-slate-600 mb-6">
                            An unexpected error occurred. Our team has been notified and is working on a fix.
                        </p>

                        {/* Error details (development only) */}
                        {process.env.NODE_ENV === 'development' && this.state.error && (
                            <div className="mb-6 p-4 bg-slate-100 rounded-lg text-left">
                                <p className="text-sm font-mono text-red-600 mb-2">
                                    {this.state.error.toString()}
                                </p>
                                {this.state.errorInfo && (
                                    <details className="text-xs text-slate-600">
                                        <summary className="cursor-pointer hover:text-slate-800">
                                            Stack trace
                                        </summary>
                                        <pre className="mt-2 overflow-x-auto whitespace-pre-wrap">
                                            {this.state.errorInfo.componentStack}
                                        </pre>
                                    </details>
                                )}
                            </div>
                        )}

                        {/* Actions */}
                        <div className="flex flex-col sm:flex-row gap-3 justify-center">
                            <button
                                onClick={this.handleRetry}
                                className="inline-flex items-center justify-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 transition-colors"
                            >
                                <RefreshCw size={18} />
                                Try Again
                            </button>
                            <Link
                                to="/dashboard"
                                className="inline-flex items-center justify-center gap-2 px-6 py-3 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200 transition-colors"
                            >
                                <Home size={18} />
                                Go to Dashboard
                            </Link>
                        </div>

                        {/* Support info */}
                        <p className="mt-6 text-sm text-slate-500">
                            If the problem persists, please contact support at{' '}
                            <a href="mailto:support@pmis.gov.in" className="text-primary-600 hover:underline">
                                support@pmis.gov.in
                            </a>
                        </p>
                    </div>
                </div>
            );
        }

        return this.props.children;
    }
}

export default ErrorBoundary;



================================================
FILE: frontend/src/components/ui/GoogleTranslateWidget.jsx
================================================
import { useEffect, useRef, useState } from 'react';

/**
 * GoogleTranslateWidget - Conditional Loading
 * 
 * IMPORTANT: Only loads Google Translate when a non-English language is selected.
 * When in English mode, this component renders nothing and loads no scripts.
 * This prevents CORS errors and unwanted translation interference.
 */
const GoogleTranslateWidget = () => {
    const initializedRef = useRef(false);
    const [shouldLoad, setShouldLoad] = useState(false);

    // Check if we need to load Google Translate
    useEffect(() => {
        const savedLang = localStorage.getItem('pmis_language');
        const needsTranslation = savedLang && savedLang !== 'en';
        setShouldLoad(needsTranslation);

        // If English, aggressively clean up any existing Google Translate artifacts
        if (!needsTranslation) {
            cleanupGoogleTranslate();
        }
    }, []);

    // Listen for language changes (same tab via custom event, cross-tab via storage)
    useEffect(() => {
        const handleLanguageChange = (event) => {
            // Get language from custom event detail or from localStorage
            const newLang = event.detail?.language || localStorage.getItem('pmis_language');
            const needsTranslation = newLang && newLang !== 'en';

            if (needsTranslation && !shouldLoad) {
                // Switching TO a non-English language - need to load script
                initializedRef.current = false; // Reset so script loads
            }

            setShouldLoad(needsTranslation);

            if (!needsTranslation) {
                cleanupGoogleTranslate();
            }
        };

        // Custom event for same-tab changes (from LanguageContext)
        window.addEventListener('pmis-language-change', handleLanguageChange);
        // Storage event for cross-tab changes
        window.addEventListener('storage', handleLanguageChange);

        return () => {
            window.removeEventListener('pmis-language-change', handleLanguageChange);
            window.removeEventListener('storage', handleLanguageChange);
        };
    }, [shouldLoad]);

    // Cleanup function to remove all Google Translate artifacts
    const cleanupGoogleTranslate = () => {
        // Clear cookies
        const domain = window.location.hostname;
        const pastDate = 'Thu, 01 Jan 1970 00:00:00 UTC';
        document.cookie = `googtrans=; expires=${pastDate}; path=/;`;
        document.cookie = `googtrans=; expires=${pastDate}; path=/; domain=${domain}`;
        document.cookie = `googtrans=; expires=${pastDate}; path=/; domain=.${domain}`;

        // Clear subdomains
        const parts = domain.split('.');
        while (parts.length > 1) {
            const d = parts.join('.');
            document.cookie = `googtrans=; expires=${pastDate}; path=/; domain=.${d}`;
            parts.shift();
        }

        // Reset body position if it was modified
        if (document.body.style.top) {
            document.body.style.top = '0px';
        }

        // Remove translated class from html
        document.documentElement.classList.remove('translated-ltr', 'translated-rtl');
    };

    // Only load Google Translate when needed
    useEffect(() => {
        if (!shouldLoad || initializedRef.current) return;
        initializedRef.current = true;

        // Add CSS to hide Google Translate UI bar
        const styleId = 'google-translate-hide-bar';
        if (!document.getElementById(styleId)) {
            const style = document.createElement('style');
            style.id = styleId;
            style.innerHTML = `
                .goog-te-banner-frame,
                iframe.goog-te-banner-frame,
                .skiptranslate > iframe,
                body > .skiptranslate:first-child {
                    display: none !important;
                    height: 0 !important;
                }
                body { top: 0 !important; }
                html.translated-ltr body,
                html.translated-rtl body { top: 0 !important; }
                #google_translate_element {
                    position: absolute !important;
                    left: -9999px !important;
                    visibility: hidden !important;
                }
                .goog-te-gadget,
                .goog-logo-link,
                .goog-te-gadget-icon,
                .goog-te-gadget-simple,
                .VIpgJd-ZVi9od-ORHb-OEVmcd { display: none !important; }
                .goog-tooltip,
                .goog-tooltip:hover,
                .goog-te-balloon-frame,
                #goog-gt-tt {
                    display: none !important;
                    visibility: hidden !important;
                    opacity: 0 !important;
                    pointer-events: none !important;
                }
            `;
            document.head.appendChild(style);
        }

        // Initialize Google Translate
        window.googleTranslateElementInit = () => {
            try {
                if (document.getElementById('google_translate_element') && window.google?.translate) {
                    new window.google.translate.TranslateElement(
                        {
                            pageLanguage: 'en',
                            autoDisplay: false,
                            multilanguagePage: true,
                        },
                        'google_translate_element'
                    );

                    // Trigger translation to saved language
                    const savedLang = localStorage.getItem('pmis_language');
                    if (savedLang && savedLang !== 'en') {
                        setTimeout(() => {
                            const googleSelect = document.querySelector('.goog-te-combo');
                            if (googleSelect) {
                                googleSelect.value = savedLang;
                                googleSelect.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }, 500);
                    }
                }
            } catch (err) {
                console.error("Google Translate Init Error:", err);
            }
        };

        // Load Google Translate script
        if (!document.getElementById('google-translate-script')) {
            const script = document.createElement('script');
            script.id = 'google-translate-script';
            script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
            script.async = true;
            document.body.appendChild(script);
        } else if (window.google?.translate) {
            window.googleTranslateElementInit();
        }

        // Fix body position continuously
        const bodyPositionFix = setInterval(() => {
            if (document.body.style.top && document.body.style.top !== '0px') {
                document.body.style.top = '0px';
            }
        }, 500);

        return () => clearInterval(bodyPositionFix);
    }, [shouldLoad]);

    // Don't render anything if English is selected
    if (!shouldLoad) {
        return null;
    }

    return (
        <div id="google_translate_element" style={{ display: 'none', height: 0, overflow: 'hidden' }}></div>
    );
};

export default GoogleTranslateWidget;




================================================
FILE: frontend/src/components/ui/GraphAnalysisModal.jsx
================================================
import { useState, useMemo, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, BarChart3, LineChart, PieChart, Settings2, Download, RefreshCw } from 'lucide-react';
import { createPortal } from 'react-dom';
import { DynamicChart } from '@/components/ui/DynamicChart';
import Button from '@/components/ui/Button';

const GraphAnalysisModal = ({ isOpen, onClose, projects, initialMetric = 'budget' }) => {
    if (!isOpen) return null;

    const [groupBy, setGroupBy] = useState('project'); // project, status, type, location
    const [chartType, setChartType] = useState('bar');
    const [metric, setMetric] = useState(initialMetric);
    const [isGenerating, setIsGenerating] = useState(false);

    // Handle Escape key
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                onClose();
            }
        };

        if (isOpen) {
            window.addEventListener('keydown', handleEscape);
        }

        return () => window.removeEventListener('keydown', handleEscape);
    }, [isOpen, onClose]);

    // Dynamic Data Aggregation Engine
    const chartData = useMemo(() => {
        if (!projects) return [];

        // 1. Group Data
        const grouped = projects.reduce((acc, curr) => {
            let key = '';

            switch (groupBy) {
                case 'project':
                    key = curr.name;
                    break;
                case 'status':
                    key = curr.status;
                    break;
                case 'category':
                    key = curr.category || 'Uncategorized';
                    break;
                case 'manager':
                    key = curr.manager || 'Unassigned';
                    break;
                default:
                    key = curr.name;
            }

            if (!acc[key]) {
                acc[key] = {
                    name: key,
                    count: 0,
                    budget: 0,
                    spent: 0,
                    progressSum: 0
                };
            }

            acc[key].count += 1;
            acc[key].budget += curr.budget || 0;
            acc[key].spent += curr.spent || 0;
            acc[key].progressSum += curr.progress || 0;

            return acc;
        }, {});

        // 2. Transform to Chart Format based on Metric
        return Object.values(grouped).map(group => {
            let value = 0;
            switch (metric) {
                case 'budget':
                    value = group.budget / 10000000; // Cr
                    break;
                case 'spent':
                    value = group.spent / 10000000; // Cr
                    break;
                case 'progress':
                    value = groupBy === 'project' ? group.progressSum : (group.progressSum / group.count); // Average for groups
                    break;
                case 'count':
                    value = group.count;
                    break;
                case 'utilization':
                    value = group.budget > 0 ? (group.spent / group.budget) * 100 : 0;
                    break;
                default:
                    value = 0;
            }

            return {
                name: group.name,
                value: Number(value.toFixed(2))
            };
        }).sort((a, b) => b.value - a.value); // Descending sort for better viz
    }, [projects, groupBy, metric]);

    const metricLabels = {
        budget: 'Total Allocated Budget (â‚¹ Cr)',
        spent: 'Total Amount Spent (â‚¹ Cr)',
        progress: 'Average Progress (%)',
        count: 'Project Count',
        utilization: 'Budget Utilization (%)'
    };

    const handleGenerate = () => {
        setIsGenerating(true);
        setTimeout(() => setIsGenerating(false), 800);
    };

    const handleExport = () => {
        const headers = ['Name', metricLabels[metric]];
        const csvContent = [
            headers.join(','),
            ...chartData.map(row => `${row.name},${row.value}`)
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `PMIS_Report_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    return createPortal(
        <AnimatePresence>
            <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="absolute inset-0 bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm"
                />

                <motion.div
                    initial={{ opacity: 0, scale: 0.95, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95, y: 20 }}
                    className="relative w-full max-w-5xl bg-white dark:bg-neutral-900 rounded-2xl shadow-2xl flex flex-col max-h-[90vh]"
                >
                    {/* Header */}
                    <div className="flex justify-between items-center p-6 border-b border-slate-200 dark:border-neutral-700">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 rounded-lg">
                                <Settings2 size={24} />
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-slate-800 dark:text-white">Custom Report Generator</h3>
                                <p className="text-sm text-slate-500 dark:text-neutral-400">Analyze project portfolio dimensions</p>
                            </div>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-full text-slate-500 dark:text-neutral-400">
                            <X size={24} />
                        </button>
                    </div>

                    {/* Scrollable Content Container */}
                    <div className="flex-1 overflow-y-auto custom-scrollbar">
                        <div className="p-6 space-y-8">

                            {/* Generator Controls */}
                            <div className="bg-slate-50 dark:bg-neutral-800 p-5 rounded-xl border border-slate-200 dark:border-neutral-700 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">

                                {/* Group By (X-Axis) */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-neutral-400 uppercase mb-2">Group By (X-Axis)</label>
                                    <select
                                        value={groupBy}
                                        onChange={(e) => { setGroupBy(e.target.value); handleGenerate(); }}
                                        className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-neutral-600 bg-white dark:bg-neutral-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700"
                                    >
                                        <option value="project">Individual Projects</option>
                                        <option value="status">Project Status</option>
                                        <option value="category">Project Category</option>
                                        <option value="manager">Project Manager</option>
                                    </select>
                                </div>

                                {/* Metric (Y-Axis) */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-neutral-400 uppercase mb-2">Metric (Y-Axis)</label>
                                    <select
                                        value={metric}
                                        onChange={(e) => { setMetric(e.target.value); handleGenerate(); }}
                                        className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-neutral-600 bg-white dark:bg-neutral-900 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-slate-700"
                                    >
                                        <option value="budget">Total Budget</option>
                                        <option value="spent">Total Spent</option>
                                        <option value="utilization">Budget Utilization</option>
                                        <option value="progress">Avg. Progress</option>
                                        <option value="count">Count of Projects</option>
                                    </select>
                                </div>

                                {/* Generate Button */}
                                <Button
                                    onClick={handleGenerate}
                                    className="h-[42px] bg-indigo-600 hover:bg-indigo-700 text-white shadow-md active:scale-95 transition-all"
                                >
                                    {isGenerating ? <RefreshCw className="animate-spin" size={18} /> : <Settings2 size={18} />}
                                    <span className="ml-2">Generate Graph</span>
                                </Button>
                            </div>

                            {/* Chart Visualization Area */}
                            <div className="min-h-[450px] bg-white dark:bg-neutral-800 rounded-xl border border-slate-100 dark:border-neutral-700 shadow-sm p-4">
                                <div className="flex justify-between items-center mb-6 pl-2">
                                    <h4 className="text-lg font-bold text-slate-800 dark:text-white">Analysis Results</h4>
                                    <div className="text-sm text-slate-500 dark:text-neutral-400">
                                        {metricLabels[metric]} vs {groupBy === 'project' ? 'Projects' : groupBy}
                                    </div>
                                </div>

                                <DynamicChart
                                    data={chartData}
                                    dataKey="value"
                                    name={metricLabels[metric]}
                                    defaultType={chartType}
                                    height={400}
                                    loading={isGenerating}
                                    colors={['#4f46e5', '#3b82f6', '#f59e0b', '#10b981', '#ef4444']}
                                />
                            </div>

                            {/* Data Summary Table (Optional logic enhancement) */}
                            <div className="bg-slate-50 dark:bg-neutral-800 rounded-xl p-6 border border-slate-200 dark:border-neutral-700">
                                <h4 className="text-sm font-bold text-slate-700 dark:text-neutral-300 mb-4 uppercase">Data Summary</h4>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="p-4 bg-white dark:bg-neutral-900 rounded-lg border border-slate-200 dark:border-neutral-700 shadow-sm">
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 mb-1">Total Datapoints</p>
                                        <p className="text-2xl font-bold text-slate-800 dark:text-white">{chartData.length}</p>
                                    </div>
                                    <div className="p-4 bg-white dark:bg-neutral-900 rounded-lg border border-slate-200 dark:border-neutral-700 shadow-sm">
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 mb-1">Highest Value</p>
                                        <p className="text-2xl font-bold text-emerald-600">
                                            {Math.max(...chartData.map(d => d.value)).toFixed(2)}
                                        </p>
                                    </div>
                                    <div className="p-4 bg-white dark:bg-neutral-900 rounded-lg border border-slate-200 dark:border-neutral-700 shadow-sm">
                                        <p className="text-xs text-slate-500 dark:text-neutral-400 mb-1">Average Value</p>
                                        <p className="text-2xl font-bold text-blue-600">
                                            {(chartData.reduce((a, b) => a + b.value, 0) / chartData.length).toFixed(2)}
                                        </p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    {/* Footer */}
                    <div className="p-4 bg-slate-50 dark:bg-neutral-800 border-t border-slate-200 dark:border-neutral-700 flex justify-between items-center z-10 rounded-b-2xl">
                        <p className="text-xs text-slate-500 dark:text-neutral-400">
                            Generated by <span className="font-semibold text-slate-700 dark:text-neutral-300">PMIS Analytics Engine</span> â€¢ {new Date().toLocaleDateString()}
                        </p>
                        <Button variant="outline" className="flex items-center gap-2 text-sm h-9" onClick={handleExport}>
                            <Download size={14} /> Export Report
                        </Button>
                    </div>
                </motion.div>
            </div>
        </AnimatePresence>,
        document.body
    );
};

export default GraphAnalysisModal;



================================================
FILE: frontend/src/components/ui/GraphLoader.jsx
================================================
import { motion } from 'framer-motion';

export const GraphLoader = ({ height = 300, type = 'bar' }) => {
  const shimmerVariants = {
    animate: {
      backgroundPosition: ['0% 0%', '100% 0%'],
      transition: {
        duration: 2,
        repeat: Infinity,
        ease: 'linear',
      },
    },
  };

  if (type === 'pie') {
    return (
      <div className="flex items-center justify-center" style={{ height }}>
        <motion.div
          className="relative w-64 h-64"
          animate={{ rotate: 360 }}
          transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}
        >
          <div className="absolute inset-0 rounded-full border-8 border-slate-200 dark:border-neutral-800 border-t-primary-600" />
        </motion.div>
      </div>
    );
  }

  if (type === 'line') {
    return (
      <div className="space-y-4 p-6" style={{ height }}>
        <motion.div
          className="h-4 rounded-lg"
          style={{
            background: 'linear-gradient(90deg, #e2e8f0 0%, #f1f5f9 50%, #e2e8f0 100%)',
            backgroundSize: '200% 100%',
          }}
          variants={shimmerVariants}
          animate="animate"
        />
        <motion.div
          className="h-4 rounded-lg w-3/4"
          style={{
            background: 'linear-gradient(90deg, #e2e8f0 0%, #f1f5f9 50%, #e2e8f0 100%)',
            backgroundSize: '200% 100%',
          }}
          variants={shimmerVariants}
          animate="animate"
        />
        <motion.div
          className="h-4 rounded-lg w-5/6"
          style={{
            background: 'linear-gradient(90deg, #e2e8f0 0%, #f1f5f9 50%, #e2e8f0 100%)',
            backgroundSize: '200% 100%',
          }}
          variants={shimmerVariants}
          animate="animate"
        />
        <motion.div
          className="h-4 rounded-lg w-2/3"
          style={{
            background: 'linear-gradient(90deg, #e2e8f0 0%, #f1f5f9 50%, #e2e8f0 100%)',
            backgroundSize: '200% 100%',
          }}
          variants={shimmerVariants}
          animate="animate"
        />
      </div>
    );
  }

  // Bar chart skeleton
  return (
    <div className="flex items-end justify-between gap-2 p-6" style={{ height }}>
      {[0.3, 0.6, 0.4, 0.8, 0.5, 0.7, 0.45].map((height, index) => (
        <motion.div
          key={index}
          className="flex-1 rounded-t-lg"
          style={{
            height: `${height * 100}%`,
            background: 'linear-gradient(180deg, #e2e8f0 0%, #f1f5f9 50%, #e2e8f0 100%)',
            backgroundSize: '100% 200%',
          }}
          variants={shimmerVariants}
          animate="animate"
          transition={{
            delay: index * 0.1,
            duration: 2,
            repeat: Infinity,
            ease: 'linear',
          }}
        />
      ))}
    </div>
  );
};










================================================
FILE: frontend/src/components/ui/InfoTooltip.jsx
================================================
import { useState, useRef, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { Info } from 'lucide-react';

/**
 * InfoTooltip - Animated tooltip with "i" icon for explaining dashboard cards
 * 
 * Features:
 * - Portal rendering to avoid parent overflow issues
 * - Smooth enter/exit animations
 * - Auto-positioning (avoids screen edges)
 * - Dark mode compliant
 * - Mobile responsive (touch support)
 */
const InfoTooltip = ({
    content,
    position = 'left', // 'top' | 'bottom' | 'left' | 'right'
    className = ''
}) => {
    const [isVisible, setIsVisible] = useState(false);
    const [tooltipPosition, setTooltipPosition] = useState({ top: 0, left: 0 });
    const [mounted, setMounted] = useState(false);
    const buttonRef = useRef(null);

    // Ensure component is mounted before using portal
    useEffect(() => {
        setMounted(true);
        return () => setMounted(false);
    }, []);

    // Calculate tooltip position based on button position
    useEffect(() => {
        if (isVisible && buttonRef.current) {
            const rect = buttonRef.current.getBoundingClientRect();
            const tooltipWidth = 300; // Max width of tooltip
            const tooltipHeight = 100; // Approximate height

            let top = 0;
            let left = 0;

            // Calculate position based on preference
            switch (position) {
                case 'top':
                    top = rect.top - tooltipHeight - 8;
                    left = rect.left + rect.width / 2 - tooltipWidth / 2;
                    break;
                case 'bottom':
                    top = rect.bottom + 8;
                    left = rect.left + rect.width / 2 - tooltipWidth / 2;
                    break;
                case 'left':
                    top = rect.top + rect.height / 2 - tooltipHeight / 2;
                    left = rect.left - tooltipWidth - 8;
                    break;
                case 'right':
                    top = rect.top + rect.height / 2 - tooltipHeight / 2;
                    left = rect.right + 8;
                    break;
                default:
                    top = rect.top - tooltipHeight - 8;
                    left = rect.left + rect.width / 2 - tooltipWidth / 2;
            }

            // Boundary checks - keep tooltip on screen
            if (left < 10) left = 10;
            if (left + tooltipWidth > window.innerWidth - 10) left = window.innerWidth - tooltipWidth - 10;
            if (top < 10) top = rect.bottom + 8; // Flip to bottom if no space on top
            if (top + tooltipHeight > window.innerHeight - 10) top = rect.top - tooltipHeight - 8;

            setTooltipPosition({ top, left });
        }
    }, [isVisible, position]);

    const handleMouseEnter = () => setIsVisible(true);
    const handleMouseLeave = () => setIsVisible(false);
    const handleClick = (e) => {
        e.stopPropagation();
        setIsVisible(!isVisible);
    };

    return (
        <div className={`relative inline-flex ${className}`}>
            {/* Info Button */}
            <button
                ref={buttonRef}
                onMouseEnter={handleMouseEnter}
                onMouseLeave={handleMouseLeave}
                onFocus={handleMouseEnter}
                onBlur={handleMouseLeave}
                onClick={handleClick}
                className="p-1.5 rounded-full text-slate-400 hover:text-primary-600 dark:text-neutral-400 dark:hover:text-primary-400 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary-500/50"
                aria-label="More information"
                type="button"
            >
                <Info size={16} />
            </button>

            {/* Tooltip - Rendered as Portal to avoid overflow clipping */}
            {mounted && createPortal(
                <AnimatePresence>
                    {isVisible && (
                        <motion.div
                            initial={{ opacity: 0, scale: 0.95 }}
                            animate={{ opacity: 1, scale: 1 }}
                            exit={{ opacity: 0, scale: 0.95 }}
                            transition={{ duration: 0.15, ease: [0.4, 0, 0.2, 1] }}
                            style={{
                                position: 'fixed',
                                top: tooltipPosition.top,
                                left: tooltipPosition.left,
                                zIndex: 99999,
                                pointerEvents: 'none',
                            }}
                            role="tooltip"
                        >
                            <div className="px-4 py-3 text-sm text-white bg-slate-800 dark:bg-neutral-700 rounded-xl shadow-2xl max-w-[300px] leading-relaxed border border-slate-700 dark:border-neutral-600">
                                {content}
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence>,
                document.body
            )}
        </div>
    );
};

/**
 * InfoTooltipWrapper - Wrapper component for adding info tooltip to any element
 * Places the tooltip button in the top-right corner
 */
export const InfoTooltipWrapper = ({ children, content, className = '' }) => {
    return (
        <div className={`relative ${className}`}>
            {children}
            <div className="absolute top-2 right-2 z-10">
                <InfoTooltip content={content} position="left" />
            </div>
        </div>
    );
};

export default InfoTooltip;



================================================
FILE: frontend/src/components/ui/LanguageDropdown.jsx
================================================
import { useState, useRef, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { ChevronDown, Globe, Check, Search, Star } from 'lucide-react';
import { useLanguage, SUPPORTED_LANGUAGES } from '@/contexts/LanguageContext';

// Popular languages in specified order
const POPULAR_LANGUAGES = [
    { code: 'en', name: 'English', native: 'English' },
    { code: 'hi', name: 'Hindi', native: 'à¤¹à¤¿à¤‚à¤¦à¥€' },
    { code: 'mr', name: 'Marathi', native: 'à¤®à¤°à¤¾à¤ à¥€' },
    { code: 'ta', name: 'Tamil', native: 'à®¤à®®à®¿à®´à¯' },
    { code: 'te', name: 'Telugu', native: 'à°¤à±†à°²à±à°—à±' },
    { code: 'kn', name: 'Kannada', native: 'à²•à²¨à³à²¨à²¡' },
    { code: 'ml', name: 'Malayalam', native: 'à´®à´²à´¯à´¾à´³à´‚' },
    { code: 'pa', name: 'Punjabi', native: 'à¨ªà©°à¨œà¨¾à¨¬à©€' },
    { code: 'gu', name: 'Gujarati', native: 'àª—à«àªœàª°àª¾àª¤à«€' },
    { code: 'bn', name: 'Bengali', native: 'à¦¬à¦¾à¦‚à¦²à¦¾' },
    { code: 'ur', name: 'Urdu', native: 'Ø§Ø±Ø¯Ùˆ' },
];

// Get popular language codes for filtering
const popularCodes = POPULAR_LANGUAGES.map(l => l.code);

/**
 * Trigger Google Translate programmatically
 * Uses multiple methods to ensure translation works even after bar is closed
 */
const triggerTranslation = (langCode) => {
    // Method 1: Try the combo box
    const googleSelect = document.querySelector('.goog-te-combo');
    if (googleSelect) {
        googleSelect.value = langCode;
        googleSelect.dispatchEvent(new Event('change', { bubbles: true }));
        return true;
    }

    // Method 2: Try using the Google Translate API directly
    if (window.google && window.google.translate && window.google.translate.TranslateElement) {
        try {
            // Re-initialize if needed
            const element = document.getElementById('google_translate_element');
            if (element && !element.querySelector('.goog-te-combo')) {
                new window.google.translate.TranslateElement(
                    { pageLanguage: 'en', autoDisplay: false },
                    'google_translate_element'
                );
                // Try again after re-initialization
                setTimeout(() => {
                    const combo = document.querySelector('.goog-te-combo');
                    if (combo) {
                        combo.value = langCode;
                        combo.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }, 100);
            }
            return true;
        } catch (e) {
            console.error('Google Translate re-init failed:', e);
        }
    }

    // Method 3: Set cookies (translation will apply on next page load, NO forced reload)
    if (langCode === 'en') {
        // Reset to English by removing the translation cookie
        document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.' + window.location.hostname;
    } else {
        // Set translation cookie
        document.cookie = `googtrans=/en/${langCode}; path=/;`;
        document.cookie = `googtrans=/en/${langCode}; path=/; domain=.${window.location.hostname}`;
    }

    return false;
};


/**
 * LanguageDropdown - Beautiful, modern language selector
 * 
 * Features:
 * - Two sections: Popular & All Languages
 * - Excluded from Google Translate (always in English)
 * - Robust translation triggering
 */
const LanguageDropdown = () => {
    const { language, setLanguage } = useLanguage();
    const [isOpen, setIsOpen] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const dropdownRef = useRef(null);
    const searchInputRef = useRef(null);

    // Get current language info
    const currentLang = POPULAR_LANGUAGES.find(l => l.code === language) ||
        SUPPORTED_LANGUAGES.find(l => l.code === language) ||
        { code: 'en', name: 'English', native: 'English' };

    // Filter languages based on search
    const filteredPopular = POPULAR_LANGUAGES.filter(lang =>
        lang.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        lang.native.toLowerCase().includes(searchQuery.toLowerCase())
    );

    const allLanguages = SUPPORTED_LANGUAGES.filter(l => !popularCodes.includes(l.code));
    const filteredAll = allLanguages.filter(lang =>
        lang.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        lang.native.toLowerCase().includes(searchQuery.toLowerCase())
    );

    // Close dropdown when clicking outside
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsOpen(false);
                setSearchQuery('');
            }
        };

        if (isOpen) {
            document.addEventListener('mousedown', handleClickOutside);
        }

        return () => {
            document.removeEventListener('mousedown', handleClickOutside);
        };
    }, [isOpen]);

    // Focus search input when dropdown opens
    useEffect(() => {
        if (isOpen && searchInputRef.current) {
            setTimeout(() => searchInputRef.current?.focus(), 100);
        }
    }, [isOpen]);

    const handleSelect = (langCode) => {
        setLanguage(langCode);
        setIsOpen(false);
        setSearchQuery('');

        // Trigger translation after a brief delay
        setTimeout(() => {
            triggerTranslation(langCode);
        }, 100);
    };

    const LanguageItem = ({ lang, isActive }) => (
        <motion.button
            onClick={() => handleSelect(lang.code)}
            className={`
        w-full flex items-center gap-3 px-4 py-2.5 text-left
        transition-all duration-150 rounded-lg mx-1
        ${isActive
                    ? 'bg-blue-100 dark:bg-primary-900/30 text-blue-700 dark:text-primary-300'
                    : 'hover:bg-slate-50 dark:hover:bg-neutral-800 text-slate-700 dark:text-neutral-200'}
      `}
            whileHover={{ x: 2 }}
            whileTap={{ scale: 0.98 }}
        >
            <div className="flex-1 min-w-0">
                <span className="text-sm font-medium">{lang.native}</span>
                <span className="text-xs text-slate-400 ml-2">{lang.name}</span>
            </div>
            {isActive && (
                <Check size={16} className="text-primary-500 flex-shrink-0" />
            )}
        </motion.button>
    );

    return (
        // notranslate class prevents Google Translate from translating this component
        <div className="relative notranslate" ref={dropdownRef} translate="no">
            {/* Trigger Button */}
            <motion.button
                onClick={() => setIsOpen(!isOpen)}
                className={`
          flex items-center gap-2 px-3 py-2 
          rounded-xl border transition-all duration-200
          ${isOpen
                        ? 'bg-blue-50 dark:bg-primary-900/20 border-blue-200 dark:border-primary-700 text-blue-700 dark:text-primary-300'
                        : 'bg-white/90 dark:bg-neutral-900/90 border-slate-200 dark:border-neutral-700 text-slate-700 dark:text-neutral-200 hover:bg-slate-50 dark:hover:bg-neutral-800 hover:border-slate-300 dark:hover:border-neutral-600'}
        `}
                whileTap={{ scale: 0.98 }}
            >
                <Globe size={16} className={isOpen ? 'text-primary-500' : 'text-slate-500'} />
                <span className="text-sm font-medium hidden sm:block">
                    {currentLang.native}
                </span>
                <span className="text-sm font-medium sm:hidden">
                    {currentLang.code.toUpperCase()}
                </span>
                <ChevronDown
                    size={14}
                    className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}
                />
            </motion.button>

            {/* Dropdown Menu */}
            <AnimatePresence>
                {isOpen && (
                    <motion.div
                        initial={{ opacity: 0, y: -10, scale: 0.95 }}
                        animate={{ opacity: 1, y: 0, scale: 1 }}
                        exit={{ opacity: 0, y: -10, scale: 0.95 }}
                        transition={{ duration: 0.15, ease: 'easeOut' }}
                        className="absolute right-0 mt-2 w-72 bg-white dark:bg-neutral-900 rounded-2xl shadow-xl dark:shadow-2xl border border-slate-200 dark:border-neutral-700 overflow-hidden z-[100]"
                    >
                        {/* Search Input */}
                        <div className="p-3 border-b border-slate-100 dark:border-neutral-800">
                            <div className="flex items-center gap-2 px-3 py-2.5 bg-slate-50 dark:bg-neutral-800 rounded-xl">
                                <Search size={16} className="text-slate-400 dark:text-neutral-500" />
                                <input
                                    ref={searchInputRef}
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="Search languages..."
                                    className="flex-1 bg-transparent text-sm text-slate-700 dark:text-neutral-200 placeholder-slate-400 dark:placeholder-neutral-500 focus:outline-none"
                                />
                            </div>
                        </div>

                        {/* Language List */}
                        <div className="max-h-80 overflow-y-auto overscroll-contain">
                            {/* Popular Section */}
                            {filteredPopular.length > 0 && (
                                <div className="py-2">
                                    <div className="flex items-center gap-2 px-4 py-2">
                                        <Star size={12} className="text-amber-500" />
                                        <span className="text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                            Popular
                                        </span>
                                    </div>
                                    <div className="px-2">
                                        {filteredPopular.map((lang) => (
                                            <LanguageItem
                                                key={lang.code}
                                                lang={lang}
                                                isActive={lang.code === language}
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Divider */}
                            {filteredPopular.length > 0 && filteredAll.length > 0 && (
                                <div className="mx-4 my-2 border-t border-slate-100 dark:border-neutral-800" />
                            )}

                            {/* All Languages Section */}
                            {filteredAll.length > 0 && (
                                <div className="py-2">
                                    <div className="flex items-center gap-2 px-4 py-2">
                                        <Globe size={12} className="text-slate-400" />
                                        <span className="text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                            All Languages
                                        </span>
                                    </div>
                                    <div className="px-2">
                                        {filteredAll.map((lang) => (
                                            <LanguageItem
                                                key={lang.code}
                                                lang={lang}
                                                isActive={lang.code === language}
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* No results */}
                            {filteredPopular.length === 0 && filteredAll.length === 0 && (
                                <div className="px-4 py-8 text-center">
                                    <Globe size={32} className="mx-auto text-slate-300 mb-2" />
                                    <p className="text-sm text-slate-500">No languages found</p>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="px-4 py-2.5 border-t border-slate-100 dark:border-neutral-800 bg-slate-50/50 dark:bg-neutral-800/50">
                            <p className="text-xs text-slate-400 dark:text-neutral-500 text-center">
                                Powered by Google Translate
                            </p>
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    );
};

export default LanguageDropdown;



================================================
FILE: frontend/src/components/ui/Loading.jsx
================================================
import { motion } from 'framer-motion';
import { Loader2 } from 'lucide-react';

/**
 * Loading Component
 * 
 * Reusable loading spinner with multiple sizes and variants.
 * Provides consistent loading states across the application.
 */
const Loading = ({
    size = 'default',
    text = null,
    fullScreen = false,
    overlay = false,
}) => {
    const sizes = {
        small: 'w-4 h-4',
        default: 'w-8 h-8',
        large: 'w-12 h-12',
    };

    const textSizes = {
        small: 'text-xs',
        default: 'text-sm',
        large: 'text-base',
    };

    const spinnerSize = sizes[size] || sizes.default;
    const textSize = textSizes[size] || textSizes.default;

    const content = (
        <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="flex flex-col items-center justify-center gap-3"
        >
            <Loader2 className={`${spinnerSize} text-blue-600 dark:text-indigo-400 animate-spin`} />
            {text && (
                <p className={`${textSize} text-slate-600 dark:text-neutral-300 font-medium`}>{text}</p>
            )}
        </motion.div>
    );

    if (fullScreen) {
        return (
            <div className="fixed inset-0 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-neutral-950 dark:to-neutral-900 flex items-center justify-center z-50">
                {content}
            </div>
        );
    }

    if (overlay) {
        return (
            <div className="absolute inset-0 bg-white/90 dark:bg-neutral-900/90 backdrop-blur-sm flex items-center justify-center z-10 rounded-xl">
                {content}
            </div>
        );
    }

    return (
        <div className="flex items-center justify-center py-12">
            {content}
        </div>
    );
};

/**
 * PageLoading Component
 * For use as page-level loading state
 */
export const PageLoading = ({ text = 'Loading...' }) => {
    return (
        <div className="flex-1 flex items-center justify-center py-24">
            <Loading size="large" text={text} />
        </div>
    );
};

/**
 * ButtonLoading Component
 * For use inside buttons
 */
export const ButtonLoading = ({ text = null }) => {
    return (
        <span className="flex items-center gap-2">
            <Loader2 className="w-4 h-4 animate-spin" />
            {text && <span>{text}</span>}
        </span>
    );
};

/**
 * CardLoading Component
 * Skeleton loading for cards
 */
export const CardLoading = ({ count = 3 }) => {
    return (
        <>
            {Array.from({ length: count }).map((_, i) => (
                <motion.div
                    key={i}
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ delay: i * 0.1 }}
                    className="bg-white dark:bg-neutral-900 rounded-2xl shadow-sm dark:shadow-lg p-6 animate-pulse"
                >
                    <div className="h-4 bg-slate-200 dark:bg-neutral-700 rounded w-3/4 mb-3"></div>
                    <div className="h-3 bg-slate-100 dark:bg-neutral-800 rounded w-1/2 mb-4"></div>
                    <div className="h-8 bg-slate-100 dark:bg-neutral-800 rounded w-full"></div>
                </motion.div>
            ))}
        </>
    );
};

/**
 * TableLoading Component
 * Skeleton loading for tables
 */
export const TableLoading = ({ rows = 5, cols = 4 }) => {
    return (
        <>
            {Array.from({ length: rows }).map((_, rowIndex) => (
                <tr key={rowIndex} className="animate-pulse">
                    {Array.from({ length: cols }).map((_, colIndex) => (
                        <td key={colIndex} className="px-4 py-3">
                            <div className="h-4 bg-slate-200 dark:bg-neutral-700 rounded w-full"></div>
                        </td>
                    ))}
                </tr>
            ))}
        </>
    );
};

export default Loading;



================================================
FILE: frontend/src/components/ui/MetricsDetailModal.jsx
================================================
import { useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, FileText, Download, ExternalLink } from 'lucide-react';
import { createPortal } from 'react-dom';

const MetricsDetailModal = ({ isOpen, onClose, title, description, items, documents }) => {
    if (!isOpen) return null;

    // Handle Escape key
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                onClose();
            }
        };

        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [onClose]);

    // Render using portal to escape parent stacking contexts
    return createPortal(
        <AnimatePresence>
            <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4">
                {/* Backdrop */}
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="absolute inset-0 bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm"
                />

                {/* Modal Content */}
                <motion.div
                    initial={{ opacity: 0, scale: 0.9, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.9, y: 20 }}
                    className="relative w-full max-w-2xl bg-white/90 dark:bg-neutral-900/90 glass-panel rounded-xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh] sm:max-h-[85vh]"
                >
                    {/* Header */}
                    <div className="flex justify-between items-center p-4 sm:p-6 border-b border-slate-200/50 dark:border-neutral-700/50 bg-white/50 dark:bg-neutral-800/50">
                        <h3 className="text-lg sm:text-xl font-bold text-slate-800 dark:text-white bg-gradient-to-r from-primary-600 to-indigo-600 bg-clip-text text-transparent dark:from-indigo-400 dark:to-purple-400">
                            {title}
                        </h3>
                        <button
                            onClick={onClose}
                            className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-700 rounded-full transition-colors text-slate-500 dark:text-neutral-400 hover:text-red-500 dark:hover:text-red-400 min-w-[44px] min-h-[44px] flex items-center justify-center"
                        >
                            <X size={20} />
                        </button>
                    </div>

                    {/* Body */}
                    <div className="p-4 sm:p-6 overflow-y-auto custom-scrollbar space-y-6 sm:space-y-8">
                        <div>
                            <h4 className="text-xs sm:text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">Overview</h4>
                            <p className="text-slate-600 leading-relaxed text-base sm:text-lg">
                                {description}
                            </p>
                        </div>

                        {/* Documents Section */}
                        {documents && documents.length > 0 && (
                            <div>
                                <h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <FileText size={16} /> Related Documents
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {documents.map((doc, idx) => (
                                        <div key={idx} className="flex items-center justify-between p-3 bg-slate-50 border border-slate-200 rounded-lg hover:border-indigo-300 hover:bg-indigo-50 transition-all cursor-pointer group">
                                            <div className="flex items-center gap-3">
                                                <div className="p-2 bg-white rounded border border-slate-200 text-red-500">
                                                    <FileText size={18} />
                                                </div>
                                                <div>
                                                    <p className="font-medium text-slate-700 text-sm group-hover:text-indigo-700">{doc.name}</p>
                                                    <p className="text-xs text-slate-400">{doc.date || 'Today'}</p>
                                                </div>
                                            </div>
                                            <Download size={16} className="text-slate-400 group-hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {items && items.length > 0 && (
                            <div>
                                <h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Detailed Breakdown</h4>
                                <div className="space-y-2">
                                    {items.map((item, index) => (
                                        <div
                                            key={index}
                                            onClick={item.onClick}
                                            className={`flex justify-between items-center p-3 bg-white/60 rounded-xl border border-slate-100 hover:border-indigo-100 transition-colors ${item.onClick ? 'cursor-pointer hover:bg-indigo-50 hover:shadow-sm' : ''}`}
                                        >
                                            <span className={`font-medium ${item.onClick ? 'text-indigo-700' : 'text-slate-700'}`}>{item.label}</span>
                                            <span className="text-slate-900 font-semibold">{item.value}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div className="p-4 bg-slate-50/50 border-t border-slate-200/50 flex justify-end">
                        <button
                            onClick={onClose}
                            className="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium text-sm transition-all shadow-sm"
                        >
                            Close
                        </button>
                    </div>
                </motion.div>
            </div>
        </AnimatePresence>,
        document.body
    );
};

export default MetricsDetailModal;



================================================
FILE: frontend/src/components/ui/MotionCard.jsx
================================================
import { forwardRef } from 'react';
import { motion } from 'framer-motion';
import { cn } from '@/lib/utils';

const MotionCard = forwardRef(
  ({ className, hover = true, tap = true, children, ...props }, ref) => {
    return (
      <motion.div
        ref={ref}
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        whileHover={hover ? { scale: 1.01, y: -2 } : undefined}
        whileTap={tap ? { scale: 0.99 } : undefined}
        transition={{
          duration: 0.2,
          ease: 'easeOut',
        }}
        className={cn(
          'rounded-2xl border border-slate-200 dark:border-neutral-700 bg-white/80 dark:bg-neutral-900/80 backdrop-blur-md shadow-sm dark:shadow-lg',
          'hover:shadow-blue-glow transition-shadow duration-300',
          className
        )}
        {...props}
      >
        {children}
      </motion.div>
    );
  }
);

MotionCard.displayName = 'MotionCard';

const MotionCardHeader = forwardRef(
  ({ className, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn('flex flex-col space-y-1.5 p-6', className)}
        {...props}
      />
    );
  }
);

MotionCardHeader.displayName = 'MotionCardHeader';

const MotionCardTitle = forwardRef(
  ({ className, ...props }, ref) => {
    return (
      <h3
        ref={ref}
        className={cn(
          'text-lg font-heading font-bold leading-none tracking-tight',
          'bg-gradient-to-r from-primary-600 to-primary-700 bg-clip-text text-transparent',
          className
        )}
        {...props}
      />
    );
  }
);

MotionCardTitle.displayName = 'MotionCardTitle';

const MotionCardContent = forwardRef(
  ({ className, ...props }, ref) => {
    return <div ref={ref} className={cn('p-6 pt-0', className)} {...props} />;
  }
);

MotionCardContent.displayName = 'MotionCardContent';

export { MotionCard, MotionCardHeader, MotionCardTitle, MotionCardContent };










================================================
FILE: frontend/src/components/ui/NotificationCenter.jsx
================================================
import { useState, useEffect, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    Bell, X, Check, CheckCheck, Trash2,
    FileText, FolderOpen, Users, IndianRupee,
    AlertTriangle, Clock, ChevronRight
} from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { useNavigate } from 'react-router-dom';

/**
 * NotificationCenter Component
 * 
 * Dropdown notification center with categorized notifications,
 * mark as read, and navigation to related items.
 */
const NotificationCenter = ({ isOpen, onClose, notifications = [] }) => {
    const navigate = useNavigate();
    const [localNotifications, setLocalNotifications] = useState(notifications);

    useEffect(() => {
        setLocalNotifications(notifications);
    }, [notifications]);

    const unreadCount = localNotifications.filter(n => !n.read).length;

    const markAsRead = useCallback((id) => {
        setLocalNotifications(prev =>
            prev.map(n => n.id === id ? { ...n, read: true } : n)
        );
    }, []);

    const markAllAsRead = useCallback(() => {
        setLocalNotifications(prev => prev.map(n => ({ ...n, read: true })));
    }, []);

    const clearAll = useCallback(() => {
        setLocalNotifications([]);
    }, []);

    const handleClick = (notification) => {
        markAsRead(notification.id);
        if (notification.link) {
            navigate(notification.link);
            onClose();
        }
    };

    const getIcon = (type) => {
        const icons = {
            document: FileText,
            project: FolderOpen,
            user: Users,
            finance: IndianRupee,
            alert: AlertTriangle,
            approval: Check,
        };
        return icons[type] || Bell;
    };

    const getIconColor = (type, priority) => {
        if (priority === 'high') return 'bg-red-100 text-red-600';
        if (priority === 'medium') return 'bg-amber-100 text-amber-600';

        const colors = {
            document: 'bg-blue-100 text-blue-600',
            project: 'bg-purple-100 text-purple-600',
            user: 'bg-green-100 text-green-600',
            finance: 'bg-emerald-100 text-emerald-600',
            alert: 'bg-red-100 text-red-600',
            approval: 'bg-amber-100 text-amber-600',
        };
        return colors[type] || 'bg-slate-100 text-slate-600';
    };

    if (!isOpen) return null;

    return (
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0, y: -10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                className="absolute right-0 top-12 w-96 max-h-[32rem] bg-white dark:bg-neutral-900 rounded-2xl shadow-xl dark:shadow-2xl border border-slate-200 dark:border-neutral-700 overflow-hidden z-50"
            >
                {/* Header */}
                <div className="px-4 py-3 border-b border-slate-100 dark:border-neutral-800 bg-slate-50 dark:bg-neutral-800">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <Bell className="w-5 h-5 text-blue-600 dark:text-indigo-400" />
                            <h3 className="font-semibold text-slate-800 dark:text-white">Notifications</h3>
                            {unreadCount > 0 && (
                                <span className="px-2 py-0.5 bg-primary-600 text-white text-xs rounded-full">
                                    {unreadCount}
                                </span>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            {localNotifications.length > 0 && (
                                <>
                                    <button
                                        onClick={markAllAsRead}
                                        className="text-xs text-slate-500 dark:text-neutral-400 hover:text-primary-600 dark:hover:text-primary-400 flex items-center gap-1"
                                        title="Mark all as read"
                                    >
                                        <CheckCheck size={14} />
                                    </button>
                                    <button
                                        onClick={clearAll}
                                        className="text-xs text-slate-500 dark:text-neutral-400 hover:text-red-600 dark:hover:text-red-400 flex items-center gap-1"
                                        title="Clear all"
                                    >
                                        <Trash2 size={14} />
                                    </button>
                                </>
                            )}
                            <button
                                onClick={onClose}
                                className="text-slate-400 dark:text-neutral-500 hover:text-slate-600 dark:hover:text-neutral-300"
                            >
                                <X size={16} />
                            </button>
                        </div>
                    </div>
                </div>

                {/* Notifications List */}
                <div className="max-h-96 overflow-y-auto">
                    {localNotifications.length === 0 ? (
                        <div className="py-12 text-center">
                            <Bell className="w-10 h-10 text-slate-300 dark:text-neutral-600 mx-auto mb-3" />
                            <p className="text-slate-500 dark:text-neutral-400 text-sm">No notifications</p>
                            <p className="text-slate-400 dark:text-neutral-500 text-xs">You're all caught up!</p>
                        </div>
                    ) : (
                        <div className="divide-y divide-slate-100 dark:divide-neutral-800">
                            {localNotifications.map((notification, index) => {
                                const Icon = getIcon(notification.type);
                                const iconColor = getIconColor(notification.type, notification.priority);

                                return (
                                    <motion.div
                                        key={notification.id || index}
                                        initial={{ opacity: 0 }}
                                        animate={{ opacity: 1 }}
                                        transition={{ delay: index * 0.05 }}
                                        onClick={() => handleClick(notification)}
                                        className={`p-4 hover:bg-slate-50 dark:hover:bg-neutral-800 cursor-pointer transition-colors ${!notification.read ? 'bg-blue-50/30 dark:bg-indigo-900/10' : ''
                                            }`}
                                    >
                                        <div className="flex items-start gap-3">
                                            <div className={`p-2 rounded-lg ${iconColor}`}>
                                                <Icon size={16} />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-start justify-between gap-2">
                                                    <p className={`text-sm ${!notification.read ? 'font-semibold text-slate-900 dark:text-white' : 'text-slate-700 dark:text-neutral-300'}`}>
                                                        {notification.title}
                                                    </p>
                                                    {!notification.read && (
                                                        <div className="w-2 h-2 bg-primary-600 rounded-full flex-shrink-0 mt-1.5" />
                                                    )}
                                                </div>
                                                {notification.message && (
                                                    <p className="text-xs text-slate-500 dark:text-neutral-400 mt-0.5 line-clamp-2">
                                                        {notification.message}
                                                    </p>
                                                )}
                                                <p className="text-xs text-slate-400 dark:text-neutral-500 mt-1 flex items-center gap-1">
                                                    <Clock size={10} />
                                                    {formatDistanceToNow(new Date(notification.timestamp), { addSuffix: true })}
                                                </p>
                                            </div>
                                            {notification.link && (
                                                <ChevronRight className="w-4 h-4 text-slate-400 dark:text-neutral-500 flex-shrink-0" />
                                            )}
                                        </div>
                                    </motion.div>
                                );
                            })}
                        </div>
                    )}
                </div>

                {/* Footer */}
                {localNotifications.length > 0 && (
                    <div className="px-4 py-3 border-t border-slate-100 dark:border-neutral-800 bg-slate-50 dark:bg-neutral-800">
                        <button
                            onClick={() => {
                                navigate('/approvals');
                                onClose();
                            }}
                            className="w-full text-center text-sm text-primary-600 hover:text-primary-700 font-medium"
                        >
                            View all notifications
                        </button>
                    </div>
                )}
            </motion.div>
        </AnimatePresence>
    );
};

/**
 * NotificationBell Component
 * 
 * Bell icon with unread count badge.
 */
export const NotificationBell = ({ count = 0, onClick }) => {
    return (
        <button
            onClick={onClick}
            className="relative p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-neutral-800 transition-colors"
        >
            <Bell className="w-5 h-5 text-slate-600 dark:text-neutral-300" />
            {count > 0 && (
                <motion.span
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    className="absolute -top-0.5 -right-0.5 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center"
                >
                    {count > 9 ? '9+' : count}
                </motion.span>
            )}
        </button>
    );
};

export default NotificationCenter;



================================================
FILE: frontend/src/components/ui/NotificationPreferencesModal.jsx
================================================
/**
 * NotificationPreferencesModal - Allows users to configure notification preferences
 * 
 * Features:
 * - List of notification types with toggle switches
 * - Save/Cancel buttons
 * - Cancel restores original settings
 * - Dark mode compliant
 * - Mobile responsive
 */
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Bell, BellOff, Settings } from 'lucide-react';
import Button from '@/components/ui/Button';

// Notification types with default enabled status
const NOTIFICATION_TYPES = [
    { id: 'new_message', label: 'New Messages', description: 'When you receive a new message', defaultEnabled: true },
    { id: 'thread_mention', label: 'Thread Mentions', description: 'When someone mentions you in a thread', defaultEnabled: true },
    { id: 'project_update', label: 'Project Updates', description: 'When a project you are assigned to is updated', defaultEnabled: true },
    { id: 'task_assigned', label: 'Task Assignments', description: 'When a task is assigned to you', defaultEnabled: true },
    { id: 'document_upload', label: 'Document Uploads', description: 'When new documents are uploaded', defaultEnabled: false },
    { id: 'approval_request', label: 'Approval Requests', description: 'When you have pending approvals', defaultEnabled: true },
    { id: 'deadline_reminder', label: 'Deadline Reminders', description: 'Reminders for upcoming deadlines', defaultEnabled: true },
    { id: 'risk_alert', label: 'Risk Alerts', description: 'High-priority risk notifications', defaultEnabled: true },
    { id: 'system_update', label: 'System Updates', description: 'System maintenance and updates', defaultEnabled: false },
];

const STORAGE_KEY = 'pmis_notification_preferences';

const NotificationPreferencesModal = ({ isOpen, onClose }) => {
    const [preferences, setPreferences] = useState({});
    const [originalPreferences, setOriginalPreferences] = useState({});
    const [isSaving, setIsSaving] = useState(false);

    // Load preferences from localStorage on mount
    useEffect(() => {
        if (isOpen) {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                const loadedPrefs = stored ? JSON.parse(stored) : {};

                // Merge with defaults (for any new notification types)
                const mergedPrefs = {};
                NOTIFICATION_TYPES.forEach((type) => {
                    mergedPrefs[type.id] = loadedPrefs[type.id] !== undefined
                        ? loadedPrefs[type.id]
                        : type.defaultEnabled;
                });

                setPreferences(mergedPrefs);
                setOriginalPreferences({ ...mergedPrefs });
            } catch (error) {
                console.error('Error loading notification preferences:', error);
                // Fall back to defaults
                const defaultPrefs = {};
                NOTIFICATION_TYPES.forEach((type) => {
                    defaultPrefs[type.id] = type.defaultEnabled;
                });
                setPreferences(defaultPrefs);
                setOriginalPreferences({ ...defaultPrefs });
            }
        }
    }, [isOpen]);

    const handleToggle = (id) => {
        setPreferences(prev => ({
            ...prev,
            [id]: !prev[id]
        }));
    };

    const handleSave = async () => {
        setIsSaving(true);
        try {
            // Save to localStorage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(preferences));

            // TODO: Optionally send to backend API
            // await apiClient.post('/api/users/notification-preferences/', preferences);

            onClose();
        } catch (error) {
            console.error('Error saving preferences:', error);
        } finally {
            setIsSaving(false);
        }
    };

    const handleCancel = () => {
        // Restore original preferences - don't save anything
        setPreferences({ ...originalPreferences });
        onClose();
    };

    const hasChanges = JSON.stringify(preferences) !== JSON.stringify(originalPreferences);

    if (!isOpen) return null;

    return (
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[70] p-4"
                onClick={handleCancel}
            >
                <motion.div
                    initial={{ scale: 0.95, opacity: 0, y: 20 }}
                    animate={{ scale: 1, opacity: 1, y: 0 }}
                    exit={{ scale: 0.95, opacity: 0, y: 20 }}
                    transition={{ type: 'spring', duration: 0.3 }}
                    onClick={(e) => e.stopPropagation()}
                    className="bg-white dark:bg-neutral-900 rounded-xl shadow-2xl w-full max-w-md max-h-[85vh] flex flex-col overflow-hidden border border-slate-200 dark:border-neutral-700"
                >
                    {/* Header */}
                    <div className="flex items-center justify-between p-4 border-b border-slate-200 dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
                        <div className="flex items-center gap-2">
                            <Settings size={20} className="text-primary-600 dark:text-blue-400" />
                            <h2 className="text-lg font-bold text-slate-800 dark:text-white">
                                Notification Preferences
                            </h2>
                        </div>
                        <button
                            onClick={handleCancel}
                            className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-700 rounded-lg transition-colors text-slate-500 dark:text-neutral-400"
                            aria-label="Close"
                        >
                            <X size={20} />
                        </button>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        <p className="text-sm text-slate-500 dark:text-neutral-400 mb-4">
                            Choose which notifications you want to receive
                        </p>

                        {NOTIFICATION_TYPES.map((type) => (
                            <div
                                key={type.id}
                                className="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-neutral-800 hover:bg-slate-100 dark:hover:bg-neutral-700 transition-colors"
                            >
                                <div className="flex-1 min-w-0 pr-3">
                                    <div className="flex items-center gap-2">
                                        {preferences[type.id] ? (
                                            <Bell size={16} className="text-primary-600 dark:text-blue-400 flex-shrink-0" />
                                        ) : (
                                            <BellOff size={16} className="text-slate-400 dark:text-neutral-500 flex-shrink-0" />
                                        )}
                                        <span className="font-medium text-slate-800 dark:text-white text-sm">
                                            {type.label}
                                        </span>
                                    </div>
                                    <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1 pl-6">
                                        {type.description}
                                    </p>
                                </div>

                                {/* Toggle Switch */}
                                <button
                                    onClick={() => handleToggle(type.id)}
                                    className={`relative w-11 h-6 rounded-full transition-colors duration-200 flex-shrink-0 ${preferences[type.id]
                                            ? 'bg-primary-600 dark:bg-blue-500'
                                            : 'bg-slate-300 dark:bg-neutral-600'
                                        }`}
                                    role="switch"
                                    aria-checked={preferences[type.id]}
                                >
                                    <motion.div
                                        className="absolute top-1 left-1 w-4 h-4 bg-white rounded-full shadow-sm"
                                        animate={{
                                            x: preferences[type.id] ? 20 : 0
                                        }}
                                        transition={{ type: 'spring', stiffness: 500, damping: 30 }}
                                    />
                                </button>
                            </div>
                        ))}
                    </div>

                    {/* Footer */}
                    <div className="flex items-center justify-end gap-3 p-4 border-t border-slate-200 dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
                        <Button
                            variant="ghost"
                            onClick={handleCancel}
                            className="px-4"
                        >
                            Cancel
                        </Button>
                        <Button
                            onClick={handleSave}
                            disabled={!hasChanges || isSaving}
                            className="px-4"
                        >
                            {isSaving ? 'Saving...' : 'Save Preferences'}
                        </Button>
                    </div>
                </motion.div>
            </motion.div>
        </AnimatePresence>
    );
};

export default NotificationPreferencesModal;



================================================
FILE: frontend/src/components/ui/SearchableSelect.jsx
================================================
/**
 * SearchableSelect Component
 * Searchable dropdown with keyboard navigation
 * Used for bank selection
 * 
 * Features:
 * - Only shows errors after user has interacted (touched) the field
 * - Full dark mode support
 */
import { useState, useRef, useEffect } from 'react';
import { ChevronDown, Search, X, AlertCircle } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

const SearchableSelect = ({
    options = [],
    value,
    onChange,
    placeholder = 'Search...',
    label,
    required = false,
    disabled = false,
    error = '',
}) => {
    const [isOpen, setIsOpen] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [filteredOptions, setFilteredOptions] = useState(options);
    const [touched, setTouched] = useState(false); // Track if user has interacted
    const containerRef = useRef(null);
    const searchInputRef = useRef(null);

    useEffect(() => {
        // Filter options based on search term
        if (searchTerm) {
            const filtered = options.filter(option =>
                option.toLowerCase().includes(searchTerm.toLowerCase())
            );
            setFilteredOptions(filtered);
        } else {
            setFilteredOptions(options);
        }
    }, [searchTerm, options]);

    useEffect(() => {
        // Close dropdown when clicking outside
        const handleClickOutside = (event) => {
            if (containerRef.current && !containerRef.current.contains(event.target)) {
                if (isOpen) {
                    setTouched(true); // Mark as touched when closing without selection
                }
                setIsOpen(false);
                setSearchTerm('');
            }
        };

        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [isOpen]);

    useEffect(() => {
        // Focus search input when dropdown opens
        if (isOpen && searchInputRef.current) {
            searchInputRef.current.focus();
        }
    }, [isOpen]);

    // Reset touched when value is set externally
    useEffect(() => {
        if (value) {
            setTouched(false);
        }
    }, [value]);

    const handleSelect = (option) => {
        onChange(option);
        setIsOpen(false);
        setSearchTerm('');
        setTouched(false); // Clear touched on selection
    };

    const handleClear = () => {
        onChange('');
        setSearchTerm('');
        setTouched(true); // Mark as touched when clearing
    };

    const handleOpen = () => {
        if (!disabled) {
            setIsOpen(!isOpen);
            if (!isOpen) {
                setTouched(true); // Mark as touched when opening
            }
        }
    };

    // Only show error if field has been touched
    const displayError = touched ? error : '';

    return (
        <div ref={containerRef} className="relative">
            {label && (
                <label className="block text-sm font-medium text-app-heading mb-1.5">
                    {label}
                    {required && <span className="text-red-500 ml-1">*</span>}
                </label>
            )}

            <div className="relative">
                <button
                    type="button"
                    onClick={handleOpen}
                    disabled={disabled}
                    className={`w-full px-4 py-2.5 pr-10 text-left rounded-xl border transition-all outline-none focus:ring-2 ${displayError
                        ? 'border-red-400 focus:border-red-500 focus:ring-red-100 dark:border-red-500/50 dark:focus:ring-red-900/30'
                        : isOpen
                            ? 'border-app-focus ring-2 ring-primary-100 dark:ring-primary-900/30'
                            : 'border-app focus:border-app-focus focus:ring-primary-100 dark:focus:ring-primary-900/30'
                        } ${disabled ? 'bg-app-hover cursor-not-allowed text-app-muted' : 'bg-app-card text-app-heading'}`}
                >
                    <span className={value ? 'text-app-heading' : 'text-app-muted'}>
                        {value || placeholder}
                    </span>
                </button>

                <div className="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1">
                    {value && !disabled && (
                        <button
                            type="button"
                            onClick={(e) => {
                                e.stopPropagation();
                                handleClear();
                            }}
                            className="p-1 hover:bg-app-hover rounded transition-colors"
                        >
                            <X size={16} className="text-app-muted" />
                        </button>
                    )}
                    <ChevronDown
                        size={18}
                        className={`text-app-muted transition-transform ${isOpen ? 'rotate-180' : ''}`}
                    />
                </div>
            </div>

            {displayError && (
                <p className="mt-1 text-sm text-red-500 flex items-center gap-1">
                    <AlertCircle size={14} /> {displayError}
                </p>
            )}

            <AnimatePresence>
                {isOpen && (
                    <motion.div
                        initial={{ opacity: 0, y: -10 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: -10 }}
                        transition={{ duration: 0.15 }}
                        className="absolute z-50 w-full mt-2 bg-app-card border border-app rounded-xl shadow-lg overflow-hidden"
                    >
                        {/* Search Input */}
                        <div className="p-3 border-b border-app-subtle">
                            <div className="relative">
                                <Search
                                    size={18}
                                    className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted"
                                />
                                <input
                                    ref={searchInputRef}
                                    type="text"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    placeholder="Type to search..."
                                    className="w-full pl-10 pr-3 py-2 border border-app bg-app-card text-app-heading rounded-lg outline-none focus:border-app-focus focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900/30 transition-all"
                                />
                            </div>
                        </div>

                        {/* Options List */}
                        <div className="max-h-64 overflow-y-auto">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map((option, index) => (
                                    <button
                                        key={index}
                                        type="button"
                                        onClick={() => handleSelect(option)}
                                        className={`w-full px-4 py-2.5 text-left hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-colors ${value === option ? 'bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-400 font-medium' : 'text-app-heading'
                                            }`}
                                    >
                                        {option}
                                    </button>
                                ))
                            ) : (
                                <div className="px-4 py-8 text-center text-app-muted">
                                    <p>No results found</p>
                                    {searchTerm && (
                                        <p className="text-sm mt-1">Try a different search term</p>
                                    )}
                                </div>
                            )}
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    );
};

export default SearchableSelect;



================================================
FILE: frontend/src/components/ui/Select.jsx
================================================
import { forwardRef } from 'react';
import { cn } from '@/lib/utils';

const Select = forwardRef(
  ({ className, children, ...props }, ref) => {
    return (
      <select
        className={cn(
          'flex h-10 w-full rounded-md border border-slate-300 dark:border-neutral-600 bg-white dark:bg-neutral-900 text-slate-900 dark:text-white px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
          className
        )}
        ref={ref}
        {...props}
      >
        {children}
      </select>
    );
  }
);

Select.displayName = 'Select';

export default Select;










================================================
FILE: frontend/src/components/ui/Skeleton.jsx
================================================
import { cn } from '@/lib/utils';

export const Skeleton = ({ className, variant = 'rectangular', width, height }) => {
  const baseClasses = 'animate-pulse bg-gray-200 rounded';
  
  const variantClasses = {
    text: 'h-4',
    circular: 'rounded-full',
    rectangular: 'rounded',
  };

  const style = {};
  if (width) style.width = typeof width === 'number' ? `${width}px` : width;
  if (height) style.height = typeof height === 'number' ? `${height}px` : height;

  return (
    <div
      className={cn(baseClasses, variantClasses[variant], className)}
      style={style}
      aria-label="Loading..."
    />
  );
};

export const SkeletonCard = () => {
  return (
    <div className="p-6 space-y-4">
      <Skeleton variant="text" width="60%" />
      <Skeleton variant="text" width="40%" />
      <Skeleton variant="rectangular" height={200} />
    </div>
  );
};

export const SkeletonTable = ({ rows = 5 }) => {
  return (
    <div className="space-y-3">
      {Array.from({ length: rows }).map((_, i) => (
        <div key={i} className="flex gap-4">
          <Skeleton variant="rectangular" width="30%" height={40} />
          <Skeleton variant="rectangular" width="20%" height={40} />
          <Skeleton variant="rectangular" width="20%" height={40} />
          <Skeleton variant="rectangular" width="15%" height={40} />
          <Skeleton variant="rectangular" width="15%" height={40} />
        </div>
      ))}
    </div>
  );
};










================================================
FILE: frontend/src/components/ui/SmartInput.jsx
================================================
import { useState } from 'react';
import { Languages, Loader2 } from 'lucide-react';
import { toast } from 'sonner';

/**
 * SmartInput - Text input with optional translation button
 * 
 * Translation is now handled by Google Translate for the entire page.
 * This component provides a simple text input/textarea with label support.
 */
export const SmartInput = ({
  value,
  onChange,
  placeholder,
  className = '',
  rows = 3,
  disabled = false,
  targetLang,
  label,
  required = false,
  error,
}) => {
  const InputComponent = rows > 1 ? 'textarea' : 'input';
  const inputProps = rows > 1 ? { rows } : { type: 'text' };

  return (
    <div className="w-full">
      {label && (
        <label className="block text-sm font-medium text-app-heading mb-1">
          {label}
          {required && <span className="text-red-500 ml-1">*</span>}
        </label>
      )}
      <div className="relative">
        <InputComponent
          {...inputProps}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={placeholder}
          disabled={disabled}
          className={`w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-primary-600 focus:border-primary-600 bg-app-card text-app-heading disabled:bg-app-hover disabled:text-app-muted ${error ? 'border-red-500' : 'border-app'
            } ${className}`}
        />
      </div>
      {error && <p className="text-sm text-red-500 mt-1">{error}</p>}
    </div>
  );
};



================================================
FILE: frontend/src/components/ui/SortableDataTable.jsx
================================================
/**
 * SortableDataTable - Reusable data table with sorting, filtering, and pagination
 * 
 * Features:
 * - Column sorting (asc/desc with visual indicators)
 * - Inline search filtering
 * - Pagination for large datasets
 * - Dark mode compliant
 * - Mobile responsive
 * - Keyboard accessible
 */
import { useState, useMemo, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    ChevronUp, ChevronDown, ChevronsUpDown, Search,
    ChevronLeft, ChevronRight, Database
} from 'lucide-react';

// Utility to deep access nested object properties like 'user.name'
const getNestedValue = (obj, path) => {
    if (!path) return undefined;
    return path.split('.').reduce((acc, part) => acc && acc[part], obj);
};

// Sort comparator
const compareValues = (a, b, sortKey, sortDirection) => {
    const valA = getNestedValue(a, sortKey);
    const valB = getNestedValue(b, sortKey);

    // Handle null/undefined
    if (valA == null && valB == null) return 0;
    if (valA == null) return sortDirection === 'asc' ? 1 : -1;
    if (valB == null) return sortDirection === 'asc' ? -1 : 1;

    // Handle dates
    if (valA instanceof Date && valB instanceof Date) {
        return sortDirection === 'asc' ? valA - valB : valB - valA;
    }

    // Handle numbers
    const numA = parseFloat(valA);
    const numB = parseFloat(valB);
    if (!isNaN(numA) && !isNaN(numB)) {
        return sortDirection === 'asc' ? numA - numB : numB - numA;
    }

    // Handle strings (case-insensitive)
    const strA = String(valA).toLowerCase();
    const strB = String(valB).toLowerCase();

    if (sortDirection === 'asc') {
        return strA.localeCompare(strB);
    }
    return strB.localeCompare(strA);
};

const SortableDataTable = ({
    data = [],
    columns = [],
    title = '',
    className = '',
    emptyMessage = 'No records found',
    emptyIcon: EmptyIcon = Database,
    searchPlaceholder = 'Search...',
    showSearch = true,
    showPagination = true,
    pageSize = 10,
    headerActions = null,
    rowActions = null,
    onRowClick = null,
    defaultSortKey = null,
    defaultSortDirection = 'asc',
    stickyHeader = false,
}) => {
    const [searchQuery, setSearchQuery] = useState('');
    const [sortKey, setSortKey] = useState(defaultSortKey);
    const [sortDirection, setSortDirection] = useState(defaultSortDirection);
    const [currentPage, setCurrentPage] = useState(1);

    // Handle column header click for sorting
    const handleSort = useCallback((columnKey) => {
        if (sortKey === columnKey) {
            // Toggle direction
            setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc');
        } else {
            setSortKey(columnKey);
            setSortDirection('asc');
        }
        setCurrentPage(1); // Reset to first page on sort
    }, [sortKey]);

    // Filter data by search query
    const filteredData = useMemo(() => {
        if (!searchQuery.trim()) return data;

        const query = searchQuery.toLowerCase().trim();
        return data.filter(item =>
            columns.some(col => {
                const value = getNestedValue(item, col.key);
                if (value == null) return false;
                return String(value).toLowerCase().includes(query);
            })
        );
    }, [data, columns, searchQuery]);

    // Sort filtered data
    const sortedData = useMemo(() => {
        if (!sortKey) return filteredData;

        return [...filteredData].sort((a, b) =>
            compareValues(a, b, sortKey, sortDirection)
        );
    }, [filteredData, sortKey, sortDirection]);

    // Paginate sorted data
    const paginatedData = useMemo(() => {
        if (!showPagination) return sortedData;

        const startIndex = (currentPage - 1) * pageSize;
        return sortedData.slice(startIndex, startIndex + pageSize);
    }, [sortedData, currentPage, pageSize, showPagination]);

    const totalPages = Math.ceil(sortedData.length / pageSize);

    // Reset to page 1 when search changes
    const handleSearch = (e) => {
        setSearchQuery(e.target.value);
        setCurrentPage(1);
    };

    // Render sort indicator
    const renderSortIcon = (columnKey, sortable) => {
        if (!sortable) return null;

        if (sortKey !== columnKey) {
            return <ChevronsUpDown size={14} className="text-slate-300 dark:text-neutral-600 ml-1" />;
        }

        return sortDirection === 'asc'
            ? <ChevronUp size={14} className="text-primary-600 dark:text-blue-400 ml-1" />
            : <ChevronDown size={14} className="text-primary-600 dark:text-blue-400 ml-1" />;
    };

    return (
        <div className={`bg-app-card rounded-xl border border-app-subtle overflow-hidden ${className}`}>
            {/* Header */}
            <div className="px-4 py-3 border-b border-app-subtle flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                <div className="flex items-center gap-2">
                    {title && (
                        <>
                            <h3 className="font-semibold text-app-heading">{title}</h3>
                            <span className="text-xs text-app-muted bg-app-surface px-2 py-0.5 rounded-full">
                                {sortedData.length}
                            </span>
                        </>
                    )}
                </div>

                <div className="flex items-center gap-3">
                    {/* Search */}
                    {showSearch && (
                        <div className="relative">
                            <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" />
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={handleSearch}
                                placeholder={searchPlaceholder}
                                className="w-48 sm:w-56 pl-9 pr-3 py-1.5 text-sm border border-app bg-app-input text-app-text rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-blue-500"
                            />
                        </div>
                    )}

                    {/* Custom header actions */}
                    {headerActions}
                </div>
            </div>

            {/* Table */}
            <div className="overflow-x-auto">
                <table className="w-full text-sm">
                    <thead className={`bg-app-surface ${stickyHeader ? 'sticky top-0 z-10' : ''}`}>
                        <tr>
                            {columns.map(col => {
                                const isSortable = col.sortable !== false;
                                return (
                                    <th
                                        key={col.key}
                                        className={`text-left px-4 py-3 font-medium text-app-muted ${isSortable ? 'cursor-pointer hover:bg-slate-100 dark:hover:bg-neutral-700 select-none' : ''
                                            } ${col.className || ''}`}
                                        style={{ width: col.width || 'auto' }}
                                        onClick={() => isSortable && handleSort(col.key)}
                                    >
                                        <div className="flex items-center">
                                            <span>{col.label}</span>
                                            {renderSortIcon(col.key, isSortable)}
                                        </div>
                                    </th>
                                );
                            })}
                            {rowActions && (
                                <th className="text-right px-4 py-3 font-medium text-app-muted w-24">
                                    Actions
                                </th>
                            )}
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                        {paginatedData.length === 0 ? (
                            <tr>
                                <td
                                    colSpan={columns.length + (rowActions ? 1 : 0)}
                                    className="text-center py-12 text-app-muted"
                                >
                                    <EmptyIcon size={32} className="mx-auto mb-2 opacity-30" />
                                    <p>{emptyMessage}</p>
                                </td>
                            </tr>
                        ) : (
                            <AnimatePresence mode="popLayout">
                                {paginatedData.map((item, idx) => (
                                    <motion.tr
                                        key={item.id || idx}
                                        initial={{ opacity: 0 }}
                                        animate={{ opacity: 1 }}
                                        exit={{ opacity: 0 }}
                                        className={`hover:bg-app-surface transition-colors ${onRowClick ? 'cursor-pointer' : ''
                                            }`}
                                        onClick={() => onRowClick && onRowClick(item)}
                                    >
                                        {columns.map(col => (
                                            <td
                                                key={col.key}
                                                className={`px-4 py-3 text-app-text ${col.cellClassName || ''}`}
                                            >
                                                {col.render
                                                    ? col.render(getNestedValue(item, col.key), item)
                                                    : getNestedValue(item, col.key) ?? '-'
                                                }
                                            </td>
                                        ))}
                                        {rowActions && (
                                            <td className="px-4 py-3 text-right">
                                                {rowActions(item)}
                                            </td>
                                        )}
                                    </motion.tr>
                                ))}
                            </AnimatePresence>
                        )}
                    </tbody>
                </table>
            </div>

            {/* Pagination */}
            {showPagination && totalPages > 1 && (
                <div className="px-4 py-3 border-t border-app-subtle flex items-center justify-between bg-app-surface">
                    <div className="text-sm text-app-muted">
                        Showing {((currentPage - 1) * pageSize) + 1} to{' '}
                        {Math.min(currentPage * pageSize, sortedData.length)} of{' '}
                        {sortedData.length} entries
                    </div>
                    <div className="flex items-center gap-1">
                        <button
                            onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                            disabled={currentPage === 1}
                            className="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed text-app-muted"
                        >
                            <ChevronLeft size={18} />
                        </button>

                        {/* Page numbers */}
                        <div className="flex items-center gap-1">
                            {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                                let pageNum;
                                if (totalPages <= 5) {
                                    pageNum = i + 1;
                                } else if (currentPage <= 3) {
                                    pageNum = i + 1;
                                } else if (currentPage >= totalPages - 2) {
                                    pageNum = totalPages - 4 + i;
                                } else {
                                    pageNum = currentPage - 2 + i;
                                }

                                return (
                                    <button
                                        key={pageNum}
                                        onClick={() => setCurrentPage(pageNum)}
                                        className={`min-w-[32px] h-8 rounded-lg text-sm font-medium transition-colors ${currentPage === pageNum
                                            ? 'bg-primary-600 text-white'
                                            : 'hover:bg-slate-100 dark:hover:bg-neutral-700 text-app-muted'
                                            }`}
                                    >
                                        {pageNum}
                                    </button>
                                );
                            })}
                        </div>

                        <button
                            onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                            disabled={currentPage === totalPages}
                            className="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed text-app-muted"
                        >
                            <ChevronRight size={18} />
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};

export default SortableDataTable;



================================================
FILE: frontend/src/components/ui/StatusBadge.jsx
================================================
import { useState } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { AlertCircle, Loader2, X } from 'lucide-react';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';

/**
 * StatusBadge - Interactive status indicator with confirmation modal
 * 
 * @param {string} status - Current status value (e.g., 'ACTIVE', 'DISABLED')
 * @param {function} onToggle - Async function(newStatus) to update status
 * @param {string} entityName - Name of the entity being modified (for modal text)
 * @param {string} activeValue - Value representing active state (default: 'ACTIVE')
 * @param {string} inactiveValue - Value representing inactive state (default: 'DISABLED')
 * @param {object} customLabels - Map of status values to display labels
 * @param {object} customStyles - Map of status values to tailwind classes
 * @param {boolean} readOnly - If true, disables interaction
 */
const StatusBadge = ({
    status,
    onToggle,
    entityName = 'this item',
    activeValue = 'ACTIVE',
    inactiveValue = 'DISABLED',
    customLabels = {},
    customStyles = {},
    readOnly = false
}) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [isUpdating, setIsUpdating] = useState(false);

    // Normalize status to uppercase for consistent key lookups if needed, 
    // but keep original for values
    const normalizedStatus = String(status).toUpperCase();
    const isActive = String(status) === activeValue;

    // Determine next status
    const nextStatus = isActive ? inactiveValue : activeValue;

    // Default labels
    const labels = {
        [activeValue]: 'Active',
        [inactiveValue]: 'Inactive',
        ...customLabels
    };

    // Default styles - Removed specific hover:bg colors to use generic brightness filter
    const styles = {
        [activeValue]: 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:border-emerald-800',
        [inactiveValue]: 'bg-slate-100 text-slate-600 border-slate-200 dark:bg-neutral-800 dark:text-neutral-400 dark:border-neutral-700',
        'PENDING': 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800',
        ...customStyles
    };

    // Get current display values
    const displayLabel = labels[status] || status;
    const badgeStyle = styles[status] || styles[isActive ? activeValue : inactiveValue] || 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-neutral-800 dark:text-neutral-300 dark:border-neutral-700';

    const handleConfirm = async () => {
        setIsUpdating(true);
        try {
            await onToggle(nextStatus);
            setIsModalOpen(false);
        } catch (error) {
            console.error('Status toggle failed:', error);
            // Error handling usually done in parent, but we ensure modal doesn't stick
        } finally {
            setIsUpdating(false);
            setIsModalOpen(false);
        }
    };

    if (readOnly) {
        return (
            <span className={`px-2.5 py-1 rounded-full text-xs font-semibold border ${badgeStyle} cursor-default`}>
                {displayLabel}
            </span>
        );
    }

    return (
        <>
            <button
                onClick={(e) => {
                    e.stopPropagation();
                    setIsModalOpen(true);
                }}
                className={`px-2.5 py-1 rounded-full text-xs font-semibold border transition-all duration-200 ${badgeStyle} cursor-pointer hover:shadow-md hover:brightness-95 active:scale-95`}
                title={`Click to mark as ${labels[nextStatus] || nextStatus}`}
            >
                <div className="flex items-center gap-1.5">
                    <span className={`w-1.5 h-1.5 rounded-full ${isActive ? 'bg-emerald-500' : 'bg-slate-400'}`}></span>
                    {displayLabel}
                </div>
            </button>

            {/* Confirmation Modal Portal */}
            {isModalOpen && createPortal(
                <AnimatePresence>
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4"
                        onClick={() => !isUpdating && setIsModalOpen(false)}
                    >
                        <motion.div
                            initial={{ opacity: 0, scale: 0.95, y: 10 }}
                            animate={{ opacity: 1, scale: 1, y: 0 }}
                            exit={{ opacity: 0, scale: 0.95, y: 10 }}
                            onClick={(e) => e.stopPropagation()}
                            className="bg-white dark:bg-neutral-900 rounded-2xl shadow-xl dark:shadow-2xl w-full max-w-sm overflow-hidden"
                        >
                            <div className="p-6">
                                <div className="flex items-start gap-4">
                                    <div className={`p-3 rounded-full flex-shrink-0 ${isActive ? 'bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400' : 'bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20 dark:text-emerald-400'}`}>
                                        <AlertCircle size={24} />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-bold text-slate-900 dark:text-white">
                                            {isActive ? 'Deactivate' : 'Activate'} {entityName}?
                                        </h3>
                                        <p className="text-slate-500 dark:text-neutral-400 text-sm mt-1">
                                            Are you sure you want to declare <strong>{entityName}</strong> as <strong>{labels[nextStatus] || nextStatus}</strong>?
                                        </p>
                                    </div>
                                </div>

                                <div className="mt-6 flex gap-3 justify-end">
                                    <Button
                                        variant="ghost"
                                        onClick={() => setIsModalOpen(false)}
                                        disabled={isUpdating}
                                    >
                                        Cancel
                                    </Button>
                                    <Button
                                        onClick={handleConfirm}
                                        disabled={isUpdating}
                                        className={isActive ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-emerald-600 hover:bg-emerald-700 text-white'}
                                    >
                                        {isUpdating ? (
                                            <>
                                                <Loader2 size={16} className="animate-spin mr-2" />
                                                Updating...
                                            </>
                                        ) : (
                                            isActive ? 'Deactivate' : 'Activate'
                                        )}
                                    </Button>
                                </div>
                            </div>
                        </motion.div>
                    </motion.div>
                </AnimatePresence>,
                document.body
            )}
        </>
    );
};

export default StatusBadge;



================================================
FILE: frontend/src/components/ui/Switch.jsx
================================================
import { motion } from 'framer-motion';

const Switch = ({ checked, onChange, disabled = false, className = '' }) => {
    return (
        <button
            type="button"
            role="switch"
            aria-checked={checked}
            onClick={() => !disabled && onChange(!checked)}
            disabled={disabled}
            className={`
                relative inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2
                ${checked ? 'bg-blue-600 dark:bg-indigo-500' : 'bg-slate-200 dark:bg-neutral-700'}
                ${disabled ? 'opacity-50 cursor-not-allowed' : ''}
                ${className}
            `}
        >
            <motion.span
                layout
                transition={{ type: "spring", stiffness: 500, damping: 30 }}
                className={`
                    pointer-events-none block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out
                `}
                style={{
                    x: checked ? 20 : 0
                }}
            />
        </button>
    );
};

export default Switch;



================================================
FILE: frontend/src/components/ui/ThemeToggle.jsx
================================================
/**
 * ThemeToggle Component
 * 
 * A beautiful, accessible toggle button for switching between light, dark, and system themes.
 * Features smooth animations and clear visual feedback.
 * 
 * Usage:
 * ```jsx
 * import ThemeToggle from '@/components/ui/ThemeToggle';
 * 
 * // In Header or Settings
 * <ThemeToggle />
 * ```
 */

import { Sun, Moon, Monitor } from 'lucide-react';
import { useTheme } from '@/contexts/ThemeContext';
import { motion, AnimatePresence } from 'framer-motion';

const THEME_CONFIG = {
    light: {
        icon: Sun,
        label: 'Light Mode',
        next: 'dark',
    },
    dark: {
        icon: Moon,
        label: 'Dark Mode',
        next: 'system',
    },
    system: {
        icon: Monitor,
        label: 'System Theme',
        next: 'light',
    },
};

export default function ThemeToggle() {
    const { theme, setTheme, effectiveTheme } = useTheme();
    const config = THEME_CONFIG[theme];
    const Icon = config.icon;

    const handleToggle = () => {
        setTheme(config.next);
    };

    return (
        <motion.button
            onClick={handleToggle}
            className="relative flex items-center justify-center w-10 h-10 rounded-xl bg-slate-100 dark:bg-neutral-800 hover:bg-slate-200 dark:hover:bg-neutral-700 transition-all duration-200 group"
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            aria-label={`Switch to ${config.next} mode`}
            title={config.label}
        >
            {/* Icon with animation */}
            <AnimatePresence mode="wait">
                <motion.div
                    key={theme}
                    initial={{ y: -20, opacity: 0, rotate: -90 }}
                    animate={{ y: 0, opacity: 1, rotate: 0 }}
                    exit={{ y: 20, opacity: 0, rotate: 90 }}
                    transition={{ duration: 0.2 }}
                    className="flex items-center justify-center"
                >
                    <Icon
                        size={18}
                        className={`transition-colors duration-200 ${effectiveTheme === 'dark'
                            ? 'text-white'
                            : 'text-slate-600 group-hover:text-slate-800'
                            }`}
                    />
                </motion.div>
            </AnimatePresence>

            {/* Subtle glow effect on hover */}
            <div className="absolute inset-0 rounded-xl bg-gradient-to-tr from-blue-600/0 to-blue-600/0 group-hover:from-blue-600/10 group-hover:to-blue-600/5 transition-all duration-300 pointer-events-none" />
        </motion.button>
    );
}

/**
 * ThemeToggle with Label (for settings pages)
 */
export function ThemeToggleWithLabel() {
    const { theme, setTheme } = useTheme();

    return (
        <div className="flex items-center justify-between p-4 rounded-xl bg-slate-100 dark:bg-neutral-800">
            <div>
                <h3 className="text-sm font-semibold text-slate-900 dark:text-white mb-1">
                    Theme
                </h3>
                <p className="text-xs text-slate-500 dark:text-neutral-400">
                    Choose your preferred color scheme
                </p>
            </div>

            <div className="flex items-center gap-2">
                {Object.entries(THEME_CONFIG).map(([mode, config]) => {
                    const Icon = config.icon;
                    const isActive = theme === mode;

                    return (
                        <motion.button
                            key={mode}
                            onClick={() => setTheme(mode)}
                            className={`
                relative flex items-center justify-center w-10 h-10 rounded-lg
                transition-all duration-200
                ${isActive
                                    ? 'bg-blue-600 text-white shadow-lg'
                                    : 'bg-white dark:bg-neutral-900 border border-slate-200 dark:border-neutral-700 text-slate-500 dark:text-neutral-400 hover:bg-slate-50 dark:hover:bg-neutral-800 hover:text-slate-800 dark:hover:text-white'
                                }
              `}
                            whileHover={{ scale: 1.05 }}
                            whileTap={{ scale: 0.95 }}
                            aria-label={config.label}
                            aria-pressed={isActive}
                            title={config.label}
                        >
                            <Icon size={18} />
                        </motion.button>
                    );
                })}
            </div>
        </div>
    );
}



================================================
FILE: frontend/src/components/ui/Toast.jsx
================================================
// Toast provider wrapper for Sonner with enhanced styling
import { Toaster, toast } from 'sonner';
import { CheckCircle2, AlertTriangle, XCircle, Info, Loader2 } from 'lucide-react';

/**
 * ToastProvider Component
 * 
 * Enhanced Sonner toast provider with premium styling.
 */
export const ToastProvider = () => {
  return (
    <Toaster
      position="top-right"
      expand={true}
      richColors
      closeButton
      duration={4000}
      theme="system"
      toastOptions={{
        classNames: {
          toast: 'dark:bg-neutral-900 dark:border-neutral-700 dark:text-white',
          title: 'dark:text-white',
          description: 'dark:text-neutral-400',
          success: 'border-l-4 border-l-green-500',
          error: 'border-l-4 border-l-red-500',
          warning: 'border-l-4 border-l-amber-500',
          info: 'border-l-4 border-l-blue-500',
          closeButton: 'dark:bg-neutral-800 dark:hover:bg-neutral-700 dark:text-neutral-400',
        },
      }}
    />
  );
};

/**
 * Toast helper functions
 * 
 * Convenience functions for showing different types of toasts.
 */
export const showToast = {
  success: (message, description) => {
    toast.success(message, {
      description,
      icon: <CheckCircle2 className="w-5 h-5 text-green-600" />,
    });
  },

  error: (message, description) => {
    toast.error(message, {
      description,
      icon: <XCircle className="w-5 h-5 text-red-600" />,
      duration: 6000,
    });
  },

  warning: (message, description) => {
    toast.warning(message, {
      description,
      icon: <AlertTriangle className="w-5 h-5 text-amber-600" />,
    });
  },

  info: (message, description) => {
    toast.info(message, {
      description,
      icon: <Info className="w-5 h-5 text-blue-600" />,
    });
  },

  loading: (message) => {
    return toast.loading(message, {
      icon: <Loader2 className="w-5 h-5 text-primary-600 animate-spin" />,
    });
  },

  promise: (promise, messages) => {
    return toast.promise(promise, {
      loading: messages.loading || 'Loading...',
      success: messages.success || 'Success!',
      error: messages.error || 'Something went wrong',
    });
  },

  dismiss: (id) => {
    toast.dismiss(id);
  },

  dismissAll: () => {
    toast.dismiss();
  },
};






================================================
FILE: frontend/src/components/ui/Toggle.jsx
================================================
import { motion } from 'framer-motion';

/**
 * Toggle Switch Component
 * Smooth animated toggle with primary blue active color
 * Supports both 'checked' and 'enabled' props for compatibility
 */
const Toggle = ({
    checked,
    enabled,
    onChange,
    label,
    description,
    disabled = false,
    size = 'md'
}) => {
    // Support both 'checked' and 'enabled' props
    const isOn = checked ?? enabled ?? false;

    const sizes = {
        sm: { track: 'w-8 h-4', thumb: 'w-3 h-3', translate: 'translate-x-4' },
        md: { track: 'w-11 h-6', thumb: 'w-5 h-5', translate: 'translate-x-5' },
        lg: { track: 'w-14 h-7', thumb: 'w-6 h-6', translate: 'translate-x-7' }
    };

    const sizeConfig = sizes[size] || sizes.md;

    const handleToggle = () => {
        if (!disabled && onChange) {
            onChange(!isOn);
        }
    };

    return (
        <div className={`flex items-center justify-between ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}>
            {(label || description) && (
                <div className="flex-1 mr-4">
                    {label && (
                        <span className="text-sm font-medium text-slate-700 dark:text-neutral-300">
                            {label}
                        </span>
                    )}
                    {description && (
                        <p className="text-xs text-slate-400 dark:text-neutral-500 mt-0.5">
                            {description}
                        </p>
                    )}
                </div>
            )}

            <button
                type="button"
                role="switch"
                aria-checked={isOn}
                disabled={disabled}
                onClick={handleToggle}
                className={`
                    relative inline-flex flex-shrink-0 
                    ${sizeConfig.track}
                    rounded-full cursor-pointer
                    transition-colors duration-200 ease-in-out
                    focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2
                    ${isOn ? 'bg-primary-600' : 'bg-slate-300 dark:bg-neutral-600'}
                    ${disabled ? 'cursor-not-allowed' : 'hover:opacity-90'}
                `}
            >
                <motion.span
                    aria-hidden="true"
                    layout
                    transition={{
                        type: "spring",
                        stiffness: 700,
                        damping: 30
                    }}
                    className={`
                        pointer-events-none inline-block
                        ${sizeConfig.thumb}
                        rounded-full bg-white shadow-md
                        ${isOn ? sizeConfig.translate : 'translate-x-0.5'}
                        transform transition-transform duration-200
                        mt-0.5 ml-0.5
                    `}
                />
            </button>
        </div>
    );
};

export default Toggle;



================================================
FILE: frontend/src/components/ui/UserSearchDropdown.jsx
================================================
import { useState, useEffect, useRef } from 'react';
import { Search, User, X, Loader2, UserPlus } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import client from '@/api/client';

/**
 * UserSearchDropdown - Reusable searchable dropdown for user selection
 * 
 * Government-grade component matching uploaded design with FULL dark mode:
 * - Fuzzy search with API integration
 * - Keyboard navigation (Arrow keys, Enter, Escape)
 * - Complete dark mode support throughout
 * - Loading states
 * - "Invite New User" action
 * - Accessibility features
 * 
 * @param {Object} props
 * @param {Function} props.onSelect - Callback when user is selected (user) => void
 * @param {Function} props.onInvite - Callback when "Invite New User" is clicked
 * @param {string} props.value - Selected user ID
 * @param {string} props.label - Label text
 * @param {boolean} props.required - Whether field is required
 * @param {string} props.roleFilter - Filter by specific role (optional)
 * @param {string} props.placeholder - Placeholder text
 * @param {string} props.error - Error message to display
 */
export const UserSearchDropdown = ({
    onSelect,
    onInvite,
    value,
    label = "Select User",
    required = false,
    roleFilter = null,
    placeholder = "Search staff by name...",
    error = null
}) => {
    const [isOpen, setIsOpen] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(false);
    const [highlightedIndex, setHighlightedIndex] = useState(0);
    const [selectedUser, setSelectedUser] = useState(null);

    const dropdownRef = useRef(null);
    const searchInputRef = useRef(null);

    // Fetch users when search query changes (debounced)
    useEffect(() => {
        if (searchQuery.length < 2) {
            setUsers([]);
            return;
        }

        const timer = setTimeout(async () => {
            setLoading(true);
            try {
                const params = new URLSearchParams({ q: searchQuery, limit: 20 });
                if (roleFilter) params.append('role', roleFilter);

                const response = await client.get(`/users/search/?${params.toString()}`);
                setUsers(response.data.users || []);
            } catch (err) {
                console.error('User search failed:', err);
                setUsers([]);
            } finally {
                setLoading(false);
            }
        }, 300); // 300ms debounce

        return () => clearTimeout(timer);
    }, [searchQuery, roleFilter]);

    // Load selected user details if value is provided
    useEffect(() => {
        if (value && !selectedUser) {
            // Fetch user details by ID
            client.get(`/users/${value}/`).then(response => {
                setSelectedUser(response.data);
            }).catch(err => {
                console.error('Failed to load user:', err);
            });
        }
    }, [value, selectedUser]);

    // Close dropdown when clicking outside
    useEffect(() => {
        const handleClickOutside = (e) => {
            if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
                setIsOpen(false);
            }
        };

        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    // Handle keyboard navigation
    const handleKeyDown = (e) => {
        if (!isOpen) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                setIsOpen(true);
                setTimeout(() => searchInputRef.current?.focus(), 100);
            }
            return;
        }

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                setHighlightedIndex(prev =>
                    prev < users.length ? prev + 1 : prev
                );
                break;
            case 'ArrowUp':
                e.preventDefault();
                setHighlightedIndex(prev => prev > 0 ? prev - 1 : 0);
                break;
            case 'Enter':
                e.preventDefault();
                if (highlightedIndex === users.length && onInvite) {
                    // "Invite New User" selected
                    onInvite();
                    setIsOpen(false);
                } else if (users[highlightedIndex]) {
                    handleSelect(users[highlightedIndex]);
                }
                break;
            case 'Escape':
                e.preventDefault();
                setIsOpen(false);
                break;
            default:
                break;
        }
    };

    const handleSelect = (user) => {
        setSelectedUser(user);
        onSelect(user);
        setIsOpen(false);
        setSearchQuery('');
    };

    const handleClear = (e) => {
        e.stopPropagation();
        setSelectedUser(null);
        onSelect(null);
        setSearchQuery('');
    };

    return (
        <div className="relative" ref={dropdownRef} onKeyDown={handleKeyDown}>
            {/* Label */}
            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                {label} {required && <span className="text-red-500 dark:text-red-400">*</span>}
            </label>

            {/* Dropdown Trigger */}
            <button
                type="button"
                onClick={() => setIsOpen(!isOpen)}
                className={`
                    relative w-full p-2 pl-10 pr-10 border rounded-lg cursor-pointer
                    transition-all duration-200
                    ${error ? 'border-red-500 dark:border-red-700' : 'border-slate-200 dark:border-neutral-700'}
                    ${isOpen ? 'ring-2 ring-primary-500 dark:ring-primary-400 border-primary-500 dark:border-primary-400' : ''}
                    bg-white dark:bg-neutral-900 hover:border-slate-300 dark:hover:border-neutral-600
                `}
                tabIndex={0}
            >
                <User className="absolute left-3 top-2.5 text-slate-400 dark:text-neutral-500" size={18} />

                <div className="text-slate-900 dark:text-white truncate">
                    {selectedUser ? (
                        <span>{selectedUser.full_name || `${selectedUser.first_name} ${selectedUser.last_name}`}</span>
                    ) : (
                        <span className="text-slate-400 dark:text-neutral-500">{placeholder}</span>
                    )}
                </div>

                {selectedUser && (
                    <button
                        type="button"
                        onClick={handleClear}
                        className="absolute right-3 top-2.5 text-slate-400 dark:text-neutral-500 hover:text-slate-600 dark:hover:text-neutral-300"
                    >
                        <X size={18} />
                    </button>
                )}
            </button>

            {/* Error Message */}
            {error && (
                <p className="text-xs text-red-500 dark:text-red-400 mt-1">{error}</p>
            )}

            {/* Dropdown Menu */}
            <AnimatePresence>
                {isOpen && (
                    <motion.div
                        initial={{ opacity: 0, y: -10 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: -10 }}
                        transition={{ duration: 0.15 }}
                        className="absolute z-50 w-full mt-1 bg-white dark:bg-neutral-800 border border-slate-200 dark:border-neutral-700 rounded-lg shadow-lg overflow-hidden"
                    >
                        {/* Search Input */}
                        <div className="p-2 border-b border-slate-100 dark:border-neutral-700">
                            <div className="relative">
                                <Search className="absolute left-3 top-2.5 text-slate-400 dark:text-neutral-500" size={16} />
                                <input
                                    ref={searchInputRef}
                                    type="text"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="Type to search..."
                                    className="w-full pl-9 pr-3 py-2 border border-slate-200 dark:border-neutral-600 rounded-md bg-white dark:bg-neutral-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 outline-none text-sm placeholder:text-slate-400 dark:placeholder:text-neutral-500"
                                    autoFocus
                                />
                            </div>
                            {searchQuery.length > 0 && searchQuery.length < 2 && (
                                <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">Type at least 2 characters</p>
                            )}
                        </div>

                        {/* Results */}
                        <div className="max-h-64 overflow-y-auto">
                            {loading ? (
                                <div className="p-4 text-center text-slate-500 dark:text-neutral-400">
                                    <Loader2 className="animate-spin inline-block text-primary-500 dark:text-primary-400" size={20} />
                                    <span className="ml-2">Searching...</span>
                                </div>
                            ) : users.length === 0 && searchQuery.length >= 2 ? (
                                <div className="p-4 text-center text-slate-500 dark:text-neutral-400">
                                    No users found
                                </div>
                            ) : (
                                <>
                                    {users.map((user, index) => (
                                        <div
                                            key={user.id}
                                            onClick={() => handleSelect(user)}
                                            className={`
                                                p-3 cursor-pointer border-b border-slate-100 dark:border-neutral-700 last:border-0
                                                transition-colors duration-150
                                                ${highlightedIndex === index ? 'bg-primary-50 dark:bg-primary-900/20' : 'hover:bg-slate-50 dark:hover:bg-neutral-700'}
                                            `}
                                            onMouseEnter={() => setHighlightedIndex(index)}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 dark:text-primary-400 font-medium">
                                                    {user.first_name?.[0] || user.username?.[0] || '?'}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-medium text-slate-900 dark:text-white truncate">
                                                        {user.full_name || `${user.first_name} ${user.last_name}`}
                                                    </p>
                                                    <p className="text-xs text-slate-500 dark:text-neutral-400 truncate">
                                                        {user.email}
                                                    </p>
                                                </div>
                                                <div>
                                                    <span className="inline-block px-2 py-1 text-xs rounded-full bg-slate-100 dark:bg-neutral-700 text-slate-600 dark:text-neutral-300">
                                                        {user.role_display || user.role}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}

                                    {/* Invite New User Option */}
                                    {onInvite && (
                                        <div
                                            onClick={() => {
                                                onInvite();
                                                setIsOpen(false);
                                            }}
                                            className={`
                                                p-3 cursor-pointer border-t-2 border-primary-200 dark:border-primary-800
                                                transition-colors duration-150
                                                ${highlightedIndex === users.length ? 'bg-primary-50 dark:bg-primary-900/20' : 'hover:bg-slate-50 dark:hover:bg-neutral-700'}
                                            `}
                                            onMouseEnter={() => setHighlightedIndex(users.length)}
                                        >
                                            <div className="flex items-center gap-3 text-primary-600 dark:text-primary-400">
                                                <UserPlus size={20} />
                                                <span className="font-medium">Invite New User</span>
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    );
};

export default UserSearchDropdown;



================================================
FILE: frontend/src/components/users/InviteUserModal.jsx
================================================
import { useState } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Loader2, Mail, User as UserIcon, Send } from 'lucide-react';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';
import client from '@/api/client';

/**
 * InviteUserModal - Universal user invitation flow
 * 
 * Sends email invitation to new user with role selection
 */
export const InviteUserModal = ({ isOpen, onClose, onSuccess }) => {
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [formData, setFormData] = useState({
        email: '',
        firstName: '',
        lastName: '',
        role: '',
    });
    const [errors, setErrors] = useState({});

    const roles = [
        { value: 'SPV_Official', label: 'SPV Official' },
        { value: 'NICDC_HQ', label: 'NICDC HQ' },
        { value: 'PMNC_Team', label: 'PMNC Team' },
        { value: 'NICDC_Staff', label: 'NICDC Staff' },
        { value: 'GOVT_DEPARTMENT', label: 'Government Department' },
    ];

    const resetForm = () => {
        setFormData({ email: '', firstName: '', lastName: '', role: '' });
        setErrors({});
    };

    const validate = () => {
        const newErrors = {};
        if (!formData.email.trim()) newErrors.email = 'Email is required';
        else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
            newErrors.email = 'Invalid email format';
        }
        if (!formData.firstName.trim()) newErrors.firstName = 'First name is required';
        if (!formData.lastName.trim()) newErrors.lastName = 'Last name is required';
        if (!formData.role) newErrors.role = 'Role is required';

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validate()) return;

        setIsSubmitting(true);
        try {
            await client.post('/users/invite/', {
                email: formData.email,
                first_name: formData.firstName,
                last_name: formData.lastName,
                role: formData.role,
            });

            toast.success(`Invitation sent to ${formData.email}`);
            resetForm();
            onClose();
            if (onSuccess) onSuccess();
        } catch (error) {
            console.error('Invitation failed:', error);
            toast.error(error.response?.data?.message || 'Failed to send invitation');
        } finally {
            setIsSubmitting(false);
        }
    };

    if (!isOpen) return null;

    return createPortal(
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 dark:bg-black/60 backdrop-blur-sm p-4"
                onClick={onClose}
            >
                <motion.div
                    initial={{ opacity: 0, scale: 0.95, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95, y: 20 }}
                    className="w-full max-w-md bg-white dark:bg-neutral-900 rounded-2xl shadow-xl overflow-hidden"
                    onClick={(e) => e.stopPropagation()}
                >
                    {/* Header */}
                    <div className="p-6 border-b border-slate-100 dark:border-neutral-700 flex justify-between items-center bg-gradient-to-r from-primary-50 to-white dark:from-neutral-900 dark:to-neutral-900">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Invite User</h2>
                            <p className="text-sm text-slate-500 dark:text-neutral-400">Send invitation email</p>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-neutral-800 rounded-full transition-colors">
                            <X size={24} className="text-slate-500 dark:text-neutral-400" />
                        </button>
                    </div>

                    {/* Form */}
                    <form onSubmit={handleSubmit} className="p-6 space-y-4">
                        {/* Email */}
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                Email Address <span className="text-red-500 dark:text-red-400">*</span>
                            </label>
                            <div className="relative">
                                <input
                                    type="email"
                                    value={formData.email}
                                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                    className={`w-full p-2 pl-10 border rounded-lg bg-white dark:bg-neutral-900 dark:text-white ${errors.email ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'}`}
                                    placeholder="user@example.com"
                                />
                                <Mail className="absolute left-3 top-2.5 text-slate-400 dark:text-neutral-500" size={18} />
                            </div>
                            {errors.email && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.email}</p>}
                        </div>

                        {/* First Name */}
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                First Name <span className="text-red-500 dark:text-red-400">*</span>
                            </label>
                            <div className="relative">
                                <input
                                    type="text"
                                    value={formData.firstName}
                                    onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}
                                    className={`w-full p-2 pl-10 border rounded-lg bg-white dark:bg-neutral-900 dark:text-white ${errors.firstName ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'}`}
                                    placeholder="John"
                                />
                                <UserIcon className="absolute left-3 top-2.5 text-slate-400 dark:text-neutral-500" size={18} />
                            </div>
                            {errors.firstName && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.firstName}</p>}
                        </div>

                        {/* Last Name */}
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                Last Name <span className="text-red-500 dark:text-red-400">*</span>
                            </label>
                            <input
                                type="text"
                                value={formData.lastName}
                                onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}
                                className={`w-full p-2 border rounded-lg bg-white dark:bg-neutral-900 dark:text-white ${errors.lastName ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'}`}
                                placeholder="Doe"
                            />
                            {errors.lastName && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.lastName}</p>}
                        </div>

                        {/* Role */}
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-neutral-300 mb-1">
                                Role <span className="text-red-500 dark:text-red-400">*</span>
                            </label>
                            <select
                                value={formData.role}
                                onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                                className={`w-full p-2 border rounded-lg bg-white dark:bg-neutral-900 dark:text-white ${errors.role ? 'border-red-500' : 'border-slate-200 dark:border-neutral-700'}`}
                            >
                                <option value="">-- Select Role --</option>
                                {roles.map((r) => (
                                    <option key={r.value} value={r.value}>{r.label}</option>
                                ))}
                            </select>
                            {errors.role && <p className="text-xs text-red-500 dark:text-red-400 mt-1">{errors.role}</p>}
                        </div>

                        {/* Footer */}
                        <div className="flex justify-end gap-3 pt-4">
                            <Button
                                variant="secondary"
                                onClick={onClose}
                                disabled={isSubmitting}
                            >
                                Cancel
                            </Button>
                            <Button
                                type="submit"
                                disabled={isSubmitting}
                            >
                                {isSubmitting ? (
                                    <>
                                        <Loader2 className="animate-spin mr-2" size={18} />
                                        Sending...
                                    </>
                                ) : (
                                    <>
                                        <Send className="mr-2" size={18} />
                                        Send Invitation
                                    </>
                                )}
                            </Button>
                        </div>
                    </form>
                </motion.div>
            </motion.div>
        </AnimatePresence>,
        document.body
    );
};

export default InviteUserModal;



================================================
FILE: frontend/src/components/workflow/EntityWorkflowCard.jsx
================================================
/**
 * Entity Workflow Card Component
 * 
 * A reusable component for document detail pages that:
 * - Shows current workflow status
 * - Displays available actions (Approve, Revert, Reject)
 * - Shows workflow history timeline
 * 
 * Usage:
 * <EntityWorkflowCard 
 *   entityType="RABill" 
 *   entityId={billId} 
 *   onActionComplete={() => refetch()} 
 * />
 */
import { useState, useEffect, useCallback } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    CheckCircle, XCircle, RotateCcw, Clock, User,
    AlertTriangle, Loader2, History, ChevronDown,
    ChevronUp, MessageSquare, X
} from 'lucide-react';
import { workflowService, getStatusColor } from '@/api/services/workflowService';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';

// Remarks Modal Component
const RemarksModal = ({ isOpen, onClose, onSubmit, action, loading }) => {
    const [remarks, setRemarks] = useState('');
    const [targetStep, setTargetStep] = useState(1);

    const handleSubmit = () => {
        if (action === 'REVERT' && !remarks.trim()) {
            toast.error('Remarks are required for sending back');
            return;
        }
        onSubmit(remarks, action === 'REVERT' ? targetStep : null);
    };

    if (!isOpen) return null;

    return createPortal(
        <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-[9999] flex items-center justify-center bg-app-overlay backdrop-blur-sm p-4"
            onClick={onClose}
        >
            <motion.div
                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.95, y: 20 }}
                className="w-full max-w-md bg-app-card rounded-xl shadow-xl overflow-hidden"
                onClick={(e) => e.stopPropagation()}
            >
                <div className="p-4 border-b border-app-subtle flex justify-between items-center">
                    <h3 className="text-lg font-semibold text-app-heading">
                        {action === 'FORWARD' ? 'Approve & Forward' :
                            action === 'REVERT' ? 'Send Back' : 'Reject Workflow'}
                    </h3>
                    <button
                        onClick={onClose}
                        className="p-2 hover:bg-app-surface rounded-full transition-colors"
                    >
                        <X size={20} className="text-app-muted" />
                    </button>
                </div>

                <div className="p-4 space-y-4">
                    {action === 'REVERT' && (
                        <div>
                            <label className="block text-sm font-medium text-app-text mb-1.5">
                                Send Back to Step
                            </label>
                            <select
                                value={targetStep}
                                onChange={(e) => setTargetStep(parseInt(e.target.value))}
                                className="w-full px-3 py-2.5 rounded-lg border border-app bg-app-input text-app-text text-sm focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-indigo-500/30 outline-none transition-all"
                            >
                                <option value={1}>Step 1 (Initial)</option>
                            </select>
                        </div>
                    )}

                    <div>
                        <label className="block text-sm font-medium text-app-text mb-1.5">
                            Remarks {(action === 'REVERT' || action === 'REJECT') && <span className="text-red-500">*</span>}
                        </label>
                        <textarea
                            value={remarks}
                            onChange={(e) => setRemarks(e.target.value)}
                            placeholder={
                                action === 'FORWARD' ? 'Optional comments...' :
                                    action === 'REVERT' ? 'Explain why this needs revision...' :
                                        'Explain rejection reason...'
                            }
                            rows={4}
                            className="w-full px-3 py-2.5 rounded-lg border border-app bg-app-input text-app-text text-sm focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-indigo-500/30 outline-none transition-all resize-none"
                        />
                    </div>
                </div>

                <div className="p-4 border-t border-app-subtle flex justify-end gap-3">
                    <Button variant="outline" onClick={onClose} disabled={loading}>
                        Cancel
                    </Button>
                    <Button
                        onClick={handleSubmit}
                        disabled={loading || ((action === 'REVERT' || action === 'REJECT') && !remarks.trim())}
                        className={
                            action === 'FORWARD' ? 'bg-green-600 hover:bg-green-700' :
                                action === 'REVERT' ? 'bg-amber-600 hover:bg-amber-700' :
                                    'bg-red-600 hover:bg-red-700'
                        }
                    >
                        {loading ? (
                            <>
                                <Loader2 size={16} className="animate-spin mr-2" />
                                Processing...
                            </>
                        ) : (
                            action === 'FORWARD' ? 'Approve' :
                                action === 'REVERT' ? 'Send Back' : 'Reject'
                        )}
                    </Button>
                </div>
            </motion.div>
        </motion.div>,
        document.body
    );
};

// History Timeline Component
const WorkflowHistoryTimeline = ({ history }) => {
    if (!history || history.length === 0) {
        return (
            <div className="text-center py-4 text-app-muted text-sm">
                No workflow history available
            </div>
        );
    }

    const getActionColor = (action) => {
        switch (action) {
            case 'STARTED': return 'bg-blue-500';
            case 'FORWARD': return 'bg-green-500';
            case 'REVERT': return 'bg-amber-500';
            case 'REJECT': return 'bg-red-500';
            case 'COMPLETE': return 'bg-emerald-500';
            default: return 'bg-gray-500';
        }
    };

    const getActionIcon = (action) => {
        switch (action) {
            case 'STARTED': return Clock;
            case 'FORWARD': return CheckCircle;
            case 'REVERT': return RotateCcw;
            case 'REJECT': return XCircle;
            case 'COMPLETE': return CheckCircle;
            default: return Clock;
        }
    };

    return (
        <div className="space-y-3">
            {history.map((entry, index) => {
                const Icon = getActionIcon(entry.action);
                return (
                    <div key={entry.id || index} className="flex gap-3">
                        <div className="flex flex-col items-center">
                            <div className={`w-8 h-8 rounded-full ${getActionColor(entry.action)} flex items-center justify-center`}>
                                <Icon size={14} className="text-white" />
                            </div>
                            {index < history.length - 1 && (
                                <div className="w-0.5 flex-1 bg-app-subtle mt-2" />
                            )}
                        </div>
                        <div className="flex-1 pb-3">
                            <div className="flex items-center gap-2 mb-1">
                                <span className="font-medium text-app-heading text-sm">
                                    {entry.action_display || entry.action}
                                </span>
                                {entry.step_label && (
                                    <span className="text-xs px-2 py-0.5 bg-app-surface rounded text-app-muted">
                                        {entry.step_label}
                                    </span>
                                )}
                            </div>
                            <div className="flex items-center gap-2 text-xs text-app-muted">
                                <User size={12} />
                                <span>{entry.performed_by || 'System'}</span>
                                <span>â€¢</span>
                                <span>{new Date(entry.entered_at).toLocaleDateString('en-IN', {
                                    day: 'numeric',
                                    month: 'short',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}</span>
                            </div>
                            {entry.remarks && (
                                <div className="mt-2 p-2 bg-app-surface rounded-lg text-sm text-app-text">
                                    <MessageSquare size={12} className="inline mr-1 text-app-muted" />
                                    {entry.remarks}
                                </div>
                            )}
                        </div>
                    </div>
                );
            })}
        </div>
    );
};

// Main Component
const EntityWorkflowCard = ({ entityType, entityId, onActionComplete }) => {
    const [actions, setActions] = useState(null);
    const [history, setHistory] = useState(null);
    const [loading, setLoading] = useState(true);
    const [actionLoading, setActionLoading] = useState(false);
    const [showHistory, setShowHistory] = useState(false);
    const [modalAction, setModalAction] = useState(null);

    const fetchData = useCallback(async () => {
        if (!entityType || !entityId) return;

        try {
            setLoading(true);
            const [actionsData, historyData] = await Promise.all([
                workflowService.getActionsForEntity(entityType, entityId),
                workflowService.getEntityHistory(entityType, entityId)
            ]);
            setActions(actionsData);
            setHistory(historyData);
        } catch (error) {
            console.error('Failed to fetch workflow data:', error);
        } finally {
            setLoading(false);
        }
    }, [entityType, entityId]);

    useEffect(() => {
        fetchData();
    }, [fetchData]);

    const handleAction = async (remarks, toStep) => {
        if (!modalAction) return;

        setActionLoading(true);
        try {
            const result = await workflowService.performEntityAction(
                entityType,
                entityId,
                modalAction,
                remarks,
                toStep
            );

            if (result?.success) {
                toast.success(result.message || 'Action completed successfully');
                setModalAction(null);
                fetchData();
                onActionComplete?.();
            } else {
                toast.error(result?.error || 'Action failed');
            }
        } catch (error) {
            const errorMsg = error.response?.data?.error || error.message || 'Action failed';
            toast.error(errorMsg);
        } finally {
            setActionLoading(false);
        }
    };

    if (loading) {
        return (
            <div className="bg-app-card border border-app-subtle rounded-xl p-4">
                <div className="flex items-center justify-center py-6">
                    <Loader2 className="w-6 h-6 animate-spin text-primary-600" />
                </div>
            </div>
        );
    }

    if (!actions?.has_workflow) {
        return (
            <div className="bg-app-card border border-app-subtle rounded-xl p-4">
                <div className="text-center py-4">
                    <History size={32} className="mx-auto mb-2 text-app-muted opacity-50" />
                    <p className="text-sm text-app-muted">No active workflow</p>
                </div>
            </div>
        );
    }

    const statusColors = getStatusColor(actions.workflow_status);

    return (
        <>
            <div className="bg-app-card border border-app-subtle rounded-xl overflow-hidden">
                {/* Header */}
                <div className="p-4 border-b border-app-subtle">
                    <div className="flex items-center justify-between mb-2">
                        <h3 className="font-semibold text-app-heading flex items-center gap-2">
                            <History size={18} className="text-primary-500" />
                            Workflow Status
                        </h3>
                        <span className={`px-2.5 py-1 text-xs font-medium rounded-full ${statusColors.bg} ${statusColors.text} ${statusColors.dark}`}>
                            {actions.workflow_status?.replace('_', ' ')}
                        </span>
                    </div>
                    <div className="flex items-center gap-4 text-sm text-app-muted">
                        <span className="flex items-center gap-1">
                            <Clock size={14} />
                            {actions.current_step_label || 'Pending'}
                        </span>
                        <span className="flex items-center gap-1">
                            <User size={14} />
                            {actions.required_role || 'N/A'}
                        </span>
                    </div>
                </div>

                {/* Action Buttons */}
                {(actions.can_approve || actions.can_revert || actions.can_reject) && (
                    <div className="p-4 border-b border-app-subtle bg-app-surface/50">
                        <p className="text-xs text-app-muted mb-3">Available Actions:</p>
                        <div className="flex flex-wrap gap-2">
                            {actions.can_approve && (
                                <Button
                                    onClick={() => setModalAction('FORWARD')}
                                    className="bg-green-600 hover:bg-green-700 text-white"
                                    size="sm"
                                >
                                    <CheckCircle size={16} className="mr-1.5" />
                                    Approve
                                </Button>
                            )}
                            {actions.can_revert && (
                                <Button
                                    onClick={() => setModalAction('REVERT')}
                                    className="bg-amber-600 hover:bg-amber-700 text-white"
                                    size="sm"
                                >
                                    <RotateCcw size={16} className="mr-1.5" />
                                    Send Back
                                </Button>
                            )}
                            {actions.can_reject && (
                                <Button
                                    onClick={() => setModalAction('REJECT')}
                                    className="bg-red-600 hover:bg-red-700 text-white"
                                    size="sm"
                                >
                                    <XCircle size={16} className="mr-1.5" />
                                    Reject
                                </Button>
                            )}
                        </div>
                    </div>
                )}

                {/* History Toggle */}
                <button
                    onClick={() => setShowHistory(!showHistory)}
                    className="w-full p-3 flex items-center justify-between text-sm text-app-muted hover:bg-app-surface transition-colors"
                >
                    <span className="flex items-center gap-2">
                        <History size={16} />
                        Workflow History
                    </span>
                    {showHistory ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                </button>

                {/* History Timeline */}
                <AnimatePresence>
                    {showHistory && history?.has_history && (
                        <motion.div
                            initial={{ height: 0, opacity: 0 }}
                            animate={{ height: 'auto', opacity: 1 }}
                            exit={{ height: 0, opacity: 0 }}
                            className="overflow-hidden border-t border-app-subtle"
                        >
                            <div className="p-4 max-h-80 overflow-y-auto">
                                {history.workflows?.[0]?.history && (
                                    <WorkflowHistoryTimeline history={history.workflows[0].history} />
                                )}
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence>
            </div>

            {/* Remarks Modal */}
            <AnimatePresence>
                {modalAction && (
                    <RemarksModal
                        isOpen={!!modalAction}
                        onClose={() => setModalAction(null)}
                        onSubmit={handleAction}
                        action={modalAction}
                        loading={actionLoading}
                    />
                )}
            </AnimatePresence>
        </>
    );
};

export default EntityWorkflowCard;



================================================
FILE: frontend/src/components/workflow/WorkflowActionCards.jsx
================================================
/**
 * Workflow Action Cards Component
 * 
 * Displays pending workflow approvals for the current user
 * with quick action buttons (Approve, Revert, Reject).
 */
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    CheckCircle, XCircle, RotateCcw, Clock, User,
    ChevronRight, AlertTriangle, Loader2, Workflow,
    FileText, DollarSign, Shield, Package
} from 'lucide-react';
import { workflowService, getStatusColor } from '@/api/services/workflowService';
import { toast } from 'sonner';

const EntityIcon = ({ entityType }) => {
    const icons = {
        RABill: DollarSign,
        Tender: Package,
        Contract: FileText,
        Risk: AlertTriangle,
        Design: FileText,
        Variation: Shield
    };
    const Icon = icons[entityType] || FileText;
    return <Icon size={18} />;
};

const WorkflowActionCard = ({ instance, onAction }) => {
    const [loading, setLoading] = useState(null);
    const statusColors = getStatusColor(instance.status);

    const handleAction = async (action) => {
        setLoading(action);
        try {
            let result;
            if (action === 'forward') {
                result = await workflowService.forward(instance.id);
            } else if (action === 'reject') {
                const remarks = prompt('Please provide rejection reason:');
                if (!remarks) {
                    setLoading(null);
                    return;
                }
                result = await workflowService.reject(instance.id, remarks);
            }

            if (result?.success) {
                toast.success(result.message || 'Action completed');
                onAction?.();
            } else {
                toast.error(result?.error || 'Action failed');
            }
        } catch (error) {
            toast.error(error.message || 'Action failed');
        } finally {
            setLoading(null);
        }
    };

    return (
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, x: -100 }}
            className="p-4 bg-app-surface border border-app-subtle rounded-xl hover:border-primary-300 dark:hover:border-primary-700 transition-colors"
        >
            <div className="flex items-start justify-between gap-3">
                <div className="flex items-start gap-3 flex-1 min-w-0">
                    <div className="w-10 h-10 rounded-lg bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center flex-shrink-0">
                        <EntityIcon entityType={instance.entity_type} />
                    </div>
                    <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                            <h4 className="font-semibold text-app-heading truncate">
                                {instance.entity_type} #{instance.entity_id?.slice(0, 8)}
                            </h4>
                            <span className={`px-2 py-0.5 text-xs font-medium rounded ${statusColors.bg} ${statusColors.text} ${statusColors.dark}`}>
                                {instance.status_display || instance.status}
                            </span>
                        </div>
                        <p className="text-sm text-app-muted truncate">
                            {instance.template_name}
                        </p>
                        <div className="flex items-center gap-3 mt-2 text-xs text-app-muted">
                            <span className="flex items-center gap-1">
                                <Clock size={12} />
                                Step {instance.current_step_label || 'N/A'}
                            </span>
                            <span className="flex items-center gap-1">
                                <User size={12} />
                                {instance.current_step_role || 'Pending'}
                            </span>
                            {instance.is_overdue && (
                                <span className="flex items-center gap-1 text-red-600 dark:text-red-400">
                                    <AlertTriangle size={12} />
                                    SLA Breach
                                </span>
                            )}
                        </div>
                    </div>
                </div>

                {/* Progress Ring */}
                <div className="flex-shrink-0">
                    <div className="relative w-12 h-12">
                        <svg className="w-12 h-12 -rotate-90">
                            <circle
                                cx="24"
                                cy="24"
                                r="20"
                                fill="none"
                                stroke="currentColor"
                                className="text-gray-200 dark:text-gray-700"
                                strokeWidth="4"
                            />
                            <circle
                                cx="24"
                                cy="24"
                                r="20"
                                fill="none"
                                stroke="currentColor"
                                className="text-primary-500"
                                strokeWidth="4"
                                strokeLinecap="round"
                                strokeDasharray={`${(instance.progress_percent || 0) * 1.26} 126`}
                            />
                        </svg>
                        <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-app-heading">
                            {instance.progress_percent || 0}%
                        </span>
                    </div>
                </div>
            </div>

            {/* Action Buttons */}
            <div className="flex items-center gap-2 mt-4 pt-3 border-t border-app-subtle">
                <button
                    onClick={() => handleAction('forward')}
                    disabled={loading}
                    className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50"
                >
                    {loading === 'forward' ? (
                        <Loader2 size={16} className="animate-spin" />
                    ) : (
                        <CheckCircle size={16} />
                    )}
                    Approve
                </button>
                <button
                    onClick={() => handleAction('reject')}
                    disabled={loading}
                    className="flex items-center justify-center gap-2 px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50"
                >
                    {loading === 'reject' ? (
                        <Loader2 size={16} className="animate-spin" />
                    ) : (
                        <XCircle size={16} />
                    )}
                </button>
            </div>
        </motion.div>
    );
};

const WorkflowActionCards = ({ maxItems = 5 }) => {
    const [pendingItems, setPendingItems] = useState([]);
    const [loading, setLoading] = useState(true);

    const fetchPending = async () => {
        try {
            setLoading(true);
            const data = await workflowService.getPendingForUser();
            setPendingItems(data.results || []);
        } catch (error) {
            console.error('Failed to fetch pending workflows:', error);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchPending();
    }, []);

    if (loading) {
        return (
            <div className="flex items-center justify-center py-8">
                <Loader2 className="w-6 h-6 animate-spin text-primary-600" />
            </div>
        );
    }

    if (pendingItems.length === 0) {
        return (
            <div className="text-center py-8 text-app-muted">
                <CheckCircle size={40} className="mx-auto mb-2 text-green-500 opacity-50" />
                <p className="font-medium">All caught up!</p>
                <p className="text-sm">No pending approvals</p>
            </div>
        );
    }

    return (
        <div className="space-y-3">
            <AnimatePresence mode="popLayout">
                {pendingItems.slice(0, maxItems).map((instance) => (
                    <WorkflowActionCard
                        key={instance.id}
                        instance={instance}
                        onAction={fetchPending}
                    />
                ))}
            </AnimatePresence>

            {pendingItems.length > maxItems && (
                <a
                    href="/approvals"
                    className="flex items-center justify-center gap-2 py-2 text-primary-600 hover:text-primary-700 text-sm font-medium"
                >
                    View all {pendingItems.length} pending items
                    <ChevronRight size={16} />
                </a>
            )}
        </div>
    );
};

export { WorkflowActionCard, WorkflowActionCards };
export default WorkflowActionCards;



================================================
FILE: frontend/src/components/workflow/WorkflowTracker.jsx
================================================
import { useState } from 'react';
import { motion } from 'framer-motion';
import {
    CheckCircle2, Clock, XCircle, AlertCircle,
    ChevronRight, User, FileText, ArrowRight
} from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';

/**
 * WorkflowTracker Component
 * 
 * Visualizes document approval workflow with step-by-step progress.
 * Shows current status, pending approvers, and completed steps.
 */
const WorkflowTracker = ({
    steps = [],
    currentStep = 0,
    variant = 'horizontal', // 'horizontal' | 'vertical'
    size = 'default', // 'small' | 'default' | 'large'
}) => {
    const getStepStatus = (index) => {
        if (index < currentStep) return 'completed';
        if (index === currentStep) return 'current';
        return 'pending';
    };

    const getStepIcon = (step, status) => {
        if (status === 'completed') {
            return <CheckCircle2 className="w-full h-full text-green-600" />;
        }
        if (status === 'current') {
            if (step.status === 'rejected') {
                return <XCircle className="w-full h-full text-red-600" />;
            }
            return <Clock className="w-full h-full text-amber-600 animate-pulse" />;
        }
        return <div className="w-full h-full rounded-full bg-slate-200" />;
    };

    const sizeClasses = {
        small: { icon: 'w-6 h-6', text: 'text-xs', gap: 'gap-2' },
        default: { icon: 'w-8 h-8', text: 'text-sm', gap: 'gap-4' },
        large: { icon: 'w-10 h-10', text: 'text-base', gap: 'gap-6' },
    };

    const sizes = sizeClasses[size] || sizeClasses.default;

    if (variant === 'vertical') {
        return (
            <div className="space-y-4">
                {steps.map((step, index) => {
                    const status = getStepStatus(index);
                    const isLast = index === steps.length - 1;

                    return (
                        <div key={step.id || index} className="relative">
                            {/* Connector line */}
                            {!isLast && (
                                <div
                                    className={`absolute left-4 top-10 w-0.5 h-8 ${status === 'completed' ? 'bg-green-500' : 'bg-slate-200'
                                        }`}
                                />
                            )}

                            <motion.div
                                initial={{ opacity: 0, x: -20 }}
                                animate={{ opacity: 1, x: 0 }}
                                transition={{ delay: index * 0.1 }}
                                className={`flex items-start ${sizes.gap}`}
                            >
                                {/* Icon */}
                                <div className={`${sizes.icon} flex-shrink-0`}>
                                    {getStepIcon(step, status)}
                                </div>

                                {/* Content */}
                                <div className="flex-1 min-w-0">
                                    <p className={`font-medium ${sizes.text} ${status === 'pending' ? 'text-slate-400' : 'text-slate-800'
                                        }`}>
                                        {step.title}
                                    </p>
                                    {step.assignee && (
                                        <p className={`${sizes.text} text-slate-500 flex items-center gap-1`}>
                                            <User size={12} /> {step.assignee}
                                        </p>
                                    )}
                                    {step.completedAt && status === 'completed' && (
                                        <p className="text-xs text-slate-400">
                                            {formatDistanceToNow(new Date(step.completedAt), { addSuffix: true })}
                                        </p>
                                    )}
                                    {step.comment && (
                                        <p className="text-xs text-slate-500 mt-1 italic">"{step.comment}"</p>
                                    )}
                                </div>
                            </motion.div>
                        </div>
                    );
                })}
            </div>
        );
    }

    // Horizontal variant
    return (
        <div className="flex items-center justify-between overflow-x-auto pb-2">
            {steps.map((step, index) => {
                const status = getStepStatus(index);
                const isLast = index === steps.length - 1;

                return (
                    <div key={step.id || index} className="flex items-center flex-shrink-0">
                        <motion.div
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ delay: index * 0.1 }}
                            className="flex flex-col items-center"
                        >
                            {/* Icon */}
                            <div className={`${sizes.icon} mb-2`}>
                                {getStepIcon(step, status)}
                            </div>

                            {/* Label */}
                            <p className={`${sizes.text} text-center font-medium ${status === 'pending' ? 'text-slate-400' : 'text-slate-800'
                                }`}>
                                {step.title}
                            </p>

                            {step.assignee && (
                                <p className="text-xs text-slate-500 text-center">{step.assignee}</p>
                            )}
                        </motion.div>

                        {/* Connector */}
                        {!isLast && (
                            <div className={`mx-3 flex-shrink-0 ${status === 'completed' ? 'text-green-500' : 'text-slate-300'
                                }`}>
                                <ChevronRight size={20} />
                            </div>
                        )}
                    </div>
                );
            })}
        </div>
    );
};

/**
 * DocumentApprovalChain Component
 * 
 * Shows the full approval workflow for a document with status badges.
 */
export const DocumentApprovalChain = ({ document }) => {
    if (!document) return null;

    // Generate workflow steps from document metadata
    const workflowSteps = document.approvalChain || [
        { id: 1, title: 'Submitted', assignee: document.uploadedBy, status: 'completed' },
        { id: 2, title: 'Technical Review', assignee: 'PMNC Team', status: document.status === 'approved' ? 'completed' : 'current' },
        { id: 3, title: 'Final Approval', assignee: 'SPV Official', status: 'pending' },
    ];

    const getCurrentStep = () => {
        const currentIdx = workflowSteps.findIndex(s => s.status === 'current');
        return currentIdx >= 0 ? currentIdx : workflowSteps.length;
    };

    return (
        <div className="bg-white rounded-xl border border-slate-200 p-4">
            <div className="flex items-center gap-2 mb-4">
                <FileText className="w-5 h-5 text-primary-600" />
                <h4 className="font-semibold text-slate-800">Approval Workflow</h4>
            </div>

            <WorkflowTracker
                steps={workflowSteps}
                currentStep={getCurrentStep()}
                variant="vertical"
                size="small"
            />
        </div>
    );
};

/**
 * WorkflowStatusBadge Component
 * 
 * Compact status badge for workflow items.
 */
export const WorkflowStatusBadge = ({ status }) => {
    const statusConfig = {
        draft: { label: 'Draft', color: 'bg-slate-100 text-slate-600', icon: FileText },
        pending: { label: 'Pending Review', color: 'bg-amber-100 text-amber-700', icon: Clock },
        under_review: { label: 'Under Review', color: 'bg-blue-100 text-blue-700', icon: AlertCircle },
        approved: { label: 'Approved', color: 'bg-green-100 text-green-700', icon: CheckCircle2 },
        rejected: { label: 'Rejected', color: 'bg-red-100 text-red-700', icon: XCircle },
        revision_required: { label: 'Revision Required', color: 'bg-orange-100 text-orange-700', icon: AlertCircle },
    };

    const config = statusConfig[status] || statusConfig.draft;
    const Icon = config.icon;

    return (
        <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${config.color}`}>
            <Icon size={12} />
            {config.label}
        </span>
    );
};

export default WorkflowTracker;



================================================
FILE: frontend/src/contexts/AuthContext.jsx
================================================
import { createContext, useContext, useState, useEffect } from 'react';
import client from '@/api/client';
import { toast } from 'sonner';

const AuthContext = createContext();

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [loading, setLoading] = useState(true);

  // Initial load check
  useEffect(() => {
    const initAuth = async () => {
      const token = localStorage.getItem('access_token');
      if (token) {
        try {
          // Validate token and get user profile
          const response = await client.get('/users/me/');
          const userData = response.data;

          const finalUser = {
            ...userData,
            name: `${userData.first_name} ${userData.last_name}`.trim() || userData.username,
            avatar: `https://ui-avatars.com/api/?name=${userData.username}&background=random`,
            permissions: getPermissionsForRole(userData.role)
          };
          setUser(finalUser);
          setIsAuthenticated(true);
        } catch (error) {
          console.error('Auth check failed:', error);
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
        }
      }
      setLoading(false);
    };

    initAuth();
  }, []);

  const login = async (username, password) => {
    try {
      // 1. Get Tokens
      const loginResponse = await client.post('/auth/login/', {
        username: username,
        password: password
      });

      const { access, refresh } = loginResponse.data;
      localStorage.setItem('access_token', access);
      localStorage.setItem('refresh_token', refresh);

      // Validate token and get user profile
      const response = await client.get('/users/me/');
      const userData = response.data;

      const finalUser = {
        ...userData,
        name: `${userData.first_name} ${userData.last_name}`.trim() || userData.username,
        avatar: `https://ui-avatars.com/api/?name=${userData.username}&background=random`,
        permissions: getPermissionsForRole(userData.role)
      };

      setUser(finalUser);
      setIsAuthenticated(true);
      toast.success('Login successful');
      return { success: true };

    } catch (error) {
      console.error('Login error:', error);

      // Extract error message from various possible locations
      let errorMessage = 'Invalid credentials';

      if (error.response?.data) {
        // Backend returns { detail: "message", code: "code" }
        if (error.response.data.detail) {
          errorMessage = error.response.data.detail;
        } else if (error.response.data.non_field_errors) {
          errorMessage = error.response.data.non_field_errors[0];
        } else if (typeof error.response.data === 'string') {
          errorMessage = error.response.data;
        }
      } else if (error.message) {
        errorMessage = error.message;
      }

      toast.error(errorMessage);
      return { success: false, error: errorMessage };
    }
  };

  const logout = () => {
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    setUser(null);
    setIsAuthenticated(false);
    toast.info('Logged out successfully');
  };

  // Helper to map backend roles to frontend permissions
  const getPermissionsForRole = (role) => {
    const rolePermissions = {
      'SPV_Official': [
        'dashboard:view',
        'projects:view',
        'projects:manage',
        'approvals:view',
        'approvals:manage',
        'users:view',
        'users:manage',
        'masters:view',
        'masters:manage',
        'scheduling:view',
        'scheduling:manage',
        'cost:view',
        'cost:manage',
        'billing:view',
        'billing:manage',
        'risk:view',
        'risk:manage',
        'gis:view',
        'bim:view',
        'reports:view',
        'reports:create',
        'edms:view',
        'edms:upload',
        'edms:approve',
        'communications:view',
        'communications:send',
        'audit:view'
      ],
      'NICDC_HQ': [
        'dashboard:view',
        'projects:view',
        'projects:manage',
        'approvals:view',
        'approvals:manage',
        'users:view',
        'users:manage',
        'masters:view',
        'masters:manage',
        'scheduling:view',
        'cost:view',
        'cost:manage',
        'billing:view',
        'risk:view',
        'gis:view',
        'bim:view',
        'reports:view',
        'edms:view',
        'edms:approve',
        'communications:view',
        'communications:send',
        'audit:view'
      ],
      'PMNC_Team': [
        'dashboard:view',
        'projects:view',
        'projects:edit',
        'scheduling:view',
        'scheduling:manage',
        'cost:view',
        'billing:view',
        'risk:view',
        'risk:manage',
        'reports:view',
        'reports:create',
        'edms:view',
        'edms:upload',
        'communications:view',
        'communications:send'
      ],
      'EPC_Contractor': [
        'dashboard:view',
        'projects:view',
        'tasks:update',
        'billing:view',
        'billing:submit',
        'edms:view',
        'edms:upload',
        'communications:view',
        'communications:send'
      ],
      'Consultant_Design': [
        'dashboard:view',
        'projects:view',
        'scheduling:view',
        'cost:view',
        'bim:view',
        'edms:view',
        'edms:upload',
        'communications:view',
        'communications:send'
      ],
      'Govt_Department': [
        'dashboard:view',
        'projects:view',
        'reports:view',
        'gis:view',
        'edms:view',
        'communications:view'
      ]
    };
    return rolePermissions[role] || ['dashboard:view'];
  };

  const hasPermission = (permission) => {
    return user?.permissions?.includes(permission) || false;
  };

  // Helper to check if user is admin
  const isAdmin = () => {
    return user?.role === 'SPV_Official' || user?.role === 'NICDC_HQ';
  };

  return (
    <AuthContext.Provider value={{
      user,
      isAuthenticated,
      loading,
      login,
      logout,
      hasPermission,
      isAdmin
    }}>
      {children}
    </AuthContext.Provider>
  );
};



================================================
FILE: frontend/src/contexts/LanguageContext.jsx
================================================
import { createContext, useContext, useState, useEffect } from 'react';

/**
 * LanguageContext - Language management for Google Translate
 * 
 * This context manages the selected language and triggers Google Translate.
 * Includes hardcoded English strings for all UI elements.
 * 
 * Note: Google Translate modifies the DOM directly which can conflict with React's
 * virtual DOM reconciliation. We add a workaround to suppress these errors.
 */

// Patch to prevent "removeChild" errors from Google Translate DOM manipulation
if (typeof window !== 'undefined') {
  const originalRemoveChild = Node.prototype.removeChild;
  Node.prototype.removeChild = function (child) {
    if (child.parentNode !== this) {
      if (console.warn) {
        console.warn('Google Translate DOM conflict: Cannot remove child from parent');
      }
      return child;
    }
    return originalRemoveChild.apply(this, arguments);
  };
}

const LanguageContext = createContext(undefined);

// All supported languages with their native names (alphabetically sorted)
export const SUPPORTED_LANGUAGES = [
  // A
  { code: 'af', name: 'Afrikaans', native: 'Afrikaans' },
  { code: 'sq', name: 'Albanian', native: 'Shqip' },
  { code: 'am', name: 'Amharic', native: 'áŠ áˆ›áˆ­áŠ›' },
  { code: 'ar', name: 'Arabic', native: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' },
  { code: 'hy', name: 'Armenian', native: 'Õ€Õ¡ÕµÕ¥Ö€delays' },
  { code: 'as', name: 'Assamese', native: 'à¦…à¦¸à¦®à§€à¦¯à¦¼à¦¾' },
  { code: 'az', name: 'Azerbaijani', native: 'AzÉ™rbaycan' },
  // B
  { code: 'eu', name: 'Basque', native: 'Euskara' },
  { code: 'be', name: 'Belarusian', native: 'Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞºĞ°Ñ' },
  { code: 'bs', name: 'Bosnian', native: 'Bosanski' },
  { code: 'bg', name: 'Bulgarian', native: 'Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸' },
  { code: 'my', name: 'Burmese', native: 'á€™á€¼á€”á€ºá€™á€¬' },
  // C
  { code: 'ca', name: 'Catalan', native: 'CatalÃ ' },
  { code: 'ceb', name: 'Cebuano', native: 'Cebuano' },
  { code: 'zh-CN', name: 'Chinese (Simplified)', native: 'ç®€ä½“ä¸­æ–‡' },
  { code: 'zh-TW', name: 'Chinese (Traditional)', native: 'ç¹é«”ä¸­æ–‡' },
  { code: 'hr', name: 'Croatian', native: 'Hrvatski' },
  { code: 'cs', name: 'Czech', native: 'ÄŒeÅ¡tina' },
  // D
  { code: 'da', name: 'Danish', native: 'Dansk' },
  { code: 'nl', name: 'Dutch', native: 'Nederlands' },
  // E
  { code: 'et', name: 'Estonian', native: 'Eesti' },
  // F
  { code: 'fil', name: 'Filipino', native: 'Filipino' },
  { code: 'fi', name: 'Finnish', native: 'Suomi' },
  { code: 'fr', name: 'French', native: 'FranÃ§ais' },
  // G
  { code: 'gl', name: 'Galician', native: 'Galego' },
  { code: 'ka', name: 'Georgian', native: 'áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜' },
  { code: 'de', name: 'German', native: 'Deutsch' },
  { code: 'el', name: 'Greek', native: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬' },
  // H
  { code: 'ht', name: 'Haitian Creole', native: 'KreyÃ²l Ayisyen' },
  { code: 'ha', name: 'Hausa', native: 'Hausa' },
  { code: 'haw', name: 'Hawaiian', native: 'Ê»ÅŒlelo HawaiÊ»i' },
  { code: 'iw', name: 'Hebrew', native: '×¢×‘×¨×™×ª' },
  { code: 'hu', name: 'Hungarian', native: 'Magyar' },
  // I
  { code: 'is', name: 'Icelandic', native: 'Ãslenska' },
  { code: 'ig', name: 'Igbo', native: 'Igbo' },
  { code: 'id', name: 'Indonesian', native: 'Bahasa Indonesia' },
  { code: 'ga', name: 'Irish', native: 'Gaeilge' },
  { code: 'it', name: 'Italian', native: 'Italiano' },
  // J
  { code: 'ja', name: 'Japanese', native: 'æ—¥æœ¬èª' },
  { code: 'jv', name: 'Javanese', native: 'Basa Jawa' },
  // K
  { code: 'kk', name: 'Kazakh', native: 'ÒšĞ°Ğ·Ğ°Ò›' },
  { code: 'km', name: 'Khmer', native: 'ááŸ’á˜áŸ‚áš' },
  { code: 'rw', name: 'Kinyarwanda', native: 'Kinyarwanda' },
  { code: 'ko', name: 'Korean', native: 'í•œêµ­ì–´' },
  { code: 'ku', name: 'Kurdish', native: 'KurdÃ®' },
  { code: 'ky', name: 'Kyrgyz', native: 'ĞšÑ‹Ñ€Ğ³Ñ‹Ğ·Ñ‡Ğ°' },
  // L
  { code: 'lo', name: 'Lao', native: 'àº¥àº²àº§' },
  { code: 'la', name: 'Latin', native: 'Latina' },
  { code: 'lv', name: 'Latvian', native: 'LatvieÅ¡u' },
  { code: 'lt', name: 'Lithuanian', native: 'LietuviÅ³' },
  { code: 'lb', name: 'Luxembourgish', native: 'LÃ«tzebuergesch' },
  // M
  { code: 'mk', name: 'Macedonian', native: 'ĞœĞ°ĞºĞµĞ´Ğ¾Ğ½ÑĞºĞ¸' },
  { code: 'mg', name: 'Malagasy', native: 'Malagasy' },
  { code: 'ms', name: 'Malay', native: 'Bahasa Melayu' },
  { code: 'mt', name: 'Maltese', native: 'Malti' },
  { code: 'mi', name: 'Maori', native: 'MÄori' },
  { code: 'mn', name: 'Mongolian', native: 'ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»' },
  // N
  { code: 'ne', name: 'Nepali', native: 'à¤¨à¥‡à¤ªà¤¾à¤²à¥€' },
  { code: 'no', name: 'Norwegian', native: 'Norsk' },
  { code: 'ny', name: 'Nyanja', native: 'Chichewa' },
  // O
  { code: 'or', name: 'Odia', native: 'à¬“à¬¡à¬¼à¬¿à¬†' },
  // P
  { code: 'ps', name: 'Pashto', native: 'Ù¾ÚšØªÙˆ' },
  { code: 'fa', name: 'Persian', native: 'ÙØ§Ø±Ø³ÛŒ' },
  { code: 'pl', name: 'Polish', native: 'Polski' },
  { code: 'pt', name: 'Portuguese', native: 'PortuguÃªs' },
  // R
  { code: 'ro', name: 'Romanian', native: 'RomÃ¢nÄƒ' },
  { code: 'ru', name: 'Russian', native: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' },
  // S
  { code: 'sm', name: 'Samoan', native: 'Gagana Samoa' },
  { code: 'gd', name: 'Scots Gaelic', native: 'GÃ idhlig' },
  { code: 'sr', name: 'Serbian', native: 'Ğ¡Ñ€Ğ¿ÑĞºĞ¸' },
  { code: 'st', name: 'Sesotho', native: 'Sesotho' },
  { code: 'sn', name: 'Shona', native: 'Shona' },
  { code: 'sd', name: 'Sindhi', native: 'Ø³Ù†ÚŒÙŠ' },
  { code: 'si', name: 'Sinhala', native: 'à·ƒà·’à¶‚à·„à¶½' },
  { code: 'sk', name: 'Slovak', native: 'SlovenÄina' },
  { code: 'sl', name: 'Slovenian', native: 'SlovenÅ¡Äina' },
  { code: 'so', name: 'Somali', native: 'Soomaali' },
  { code: 'es', name: 'Spanish', native: 'EspaÃ±ol' },
  { code: 'su', name: 'Sundanese', native: 'Basa Sunda' },
  { code: 'sw', name: 'Swahili', native: 'Kiswahili' },
  { code: 'sv', name: 'Swedish', native: 'Svenska' },
  // T
  { code: 'tg', name: 'Tajik', native: 'Ğ¢Ğ¾Ò·Ğ¸ĞºÓ£' },
  { code: 'th', name: 'Thai', native: 'à¹„à¸—à¸¢' },
  { code: 'tr', name: 'Turkish', native: 'TÃ¼rkÃ§e' },
  { code: 'tk', name: 'Turkmen', native: 'TÃ¼rkmen' },
  // U
  { code: 'uk', name: 'Ukrainian', native: 'Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°' },
  { code: 'uz', name: 'Uzbek', native: "O'zbek" },
  // V
  { code: 'vi', name: 'Vietnamese', native: 'Tiáº¿ng Viá»‡t' },
  // W
  { code: 'cy', name: 'Welsh', native: 'Cymraeg' },
  // X
  { code: 'xh', name: 'Xhosa', native: 'isiXhosa' },
  // Y
  { code: 'yi', name: 'Yiddish', native: '×™×™Ö´×“×™×©' },
  { code: 'yo', name: 'Yoruba', native: 'YorÃ¹bÃ¡' },
  // Z
  { code: 'zu', name: 'Zulu', native: 'isiZulu' },
];

// Hardcoded English strings - Google Translate will translate these
const STRINGS = {
  // App
  'app.title': 'PMIS - Zaheerabad Industrial Area',

  // Common
  'common.login': 'Login',
  'common.logout': 'Logout',
  'common.dashboard': 'Integrated Dashboard',
  'common.projects': 'Projects',
  'common.documents': 'Documents',
  'common.schedule': 'Schedule',
  'common.cost': 'Cost Management',
  'common.risk': 'Risk Management',
  'common.gis': 'GIS & Mapping',
  'common.bim': '3D Model Viewer',
  'common.selectRole': 'Select Role',
  'common.welcome': 'Welcome',
  'common.language': 'Language',
  'common.profile': 'Profile',
  'common.notifications': 'Notifications',
  'common.search': 'Search',
  'common.filter': 'Filter',
  'common.export': 'Export',
  'common.upload': 'Upload',
  'common.save': 'Save',
  'common.cancel': 'Cancel',
  'common.delete': 'Delete',
  'common.edit': 'Edit',
  'common.view': 'View',
  'common.status': 'Status',
  'common.progress': 'Progress',
  'common.budget': 'Budget',
  'common.spent': 'Spent',
  'common.remaining': 'Remaining',
  'common.name': 'Name',
  'common.date': 'Date',
  'common.actions': 'Actions',
  'common.target': 'Target',
  'common.found': 'found',
  'common.type': 'Type',
  'common.category': 'Category',
  'common.version': 'Version',
  'common.size': 'Size',
  'common.uploadedBy': 'Uploaded By',
  'common.manager': 'Manager',
  'common.location': 'Location',
  'common.description': 'Description',
  'common.startDate': 'Start Date',
  'common.endDate': 'End Date',
  'common.assignedTo': 'Assigned To',
  'common.priority': 'Priority',
  'common.impact': 'Impact',
  'common.probability': 'Probability',
  'common.owner': 'Owner',
  'common.identified': 'Identified',
  'common.allStatus': 'All Status',
  'common.allTypes': 'All Types',
  'common.allProjects': 'All Projects',
  'common.project': 'Project',
  'common.total': 'Total',
  'common.inProgress': 'In Progress',
  'common.completed': 'Completed',
  'common.planning': 'Planning',
  'common.onHold': 'On Hold',
  'common.cancelled': 'Cancelled',
  'common.draft': 'Draft',
  'common.underReview': 'Under Review',
  'common.approved': 'Approved',
  'common.rejected': 'Rejected',
  'common.closed': 'Closed',
  'common.mitigated': 'Mitigated',
  'common.assessed': 'Assessed',
  'common.low': 'Low',
  'common.medium': 'Medium',
  'common.high': 'High',
  'common.critical': 'Critical',
  'common.notStarted': 'Not Started',
  'common.delayed': 'Delayed',
  'common.creating': 'Creating...',
  'common.uploading': 'Uploading...',
  'common.authenticating': 'Authenticating...',
  'common.comingSoon': 'Coming soon',
  'common.accessLevel': 'Access Level',

  // Dashboard
  'dashboard.title': 'Integrated Dashboard',
  'dashboard.overview': 'Overview',
  'dashboard.kpis': 'Key Performance Indicators',
  'dashboard.recentProjects': 'Recent Projects',
  'dashboard.activeRisks': 'Active Risks',
  'dashboard.upcomingTasks': 'Upcoming Tasks',
  'dashboard.searchPlaceholder': 'Search projects, tasks, risks...',
  'dashboard.createProject': 'Create Project',
  'dashboard.progress': 'Progress',
  'dashboard.budgetVsSpent': 'Budget vs Spent (in Crores)',
  'dashboard.riskDistribution': 'Distribution',
  'dashboard.projectTimeline': 'Project Timeline',
  'dashboard.noRisksFound': 'No risks found matching your search.',
  'dashboard.noActiveRisks': 'No active risks.',
  'dashboard.noTasksFound': 'No tasks found matching your search.',
  'dashboard.noUpcomingTasks': 'No upcoming tasks.',

  // Projects
  'projects.title': 'Projects',
  'projects.subtitle': 'Manage and track all infrastructure projects',
  'projects.createProject': 'Create Project',
  'projects.searchPlaceholder': 'Search projects...',
  'projects.allStatus': 'All Status',
  'projects.noProjectsFound': 'No projects found',
  'projects.adjustFilters': 'Try adjusting your filters to see more results.',
  'projects.getStarted': 'Get started by creating your first project.',
  'projects.noProjectsAvailable': 'No projects available at the moment.',
  'projects.budget': 'Budget',
  'projects.budgetUtilization': 'Budget Utilization',
  'projects.totalProjects': 'Total Projects',
  'projects.totalBudget': 'Total Budget',

  // EDMS
  'edms.title': 'Documents',
  'edms.subtitle': 'Electronic Document Management System',
  'edms.searchPlaceholder': 'Search documents...',
  'edms.allStatus': 'All Status',
  'edms.allTypes': 'All Types',
  'edms.documentRepository': 'Document Repository',
  'edms.documents': 'documents',
  'edms.noDocumentsFound': 'No documents found',
  'edms.adjustFilters': 'Try adjusting your filters to see more results.',
  'edms.uploadFirst': 'Upload your first document to get started.',
  'edms.uploadDocument': 'Upload Document',

  // Scheduling
  'scheduling.title': 'Scheduling',
  'scheduling.subtitle': 'Project Scheduling and Timeline Tracking',
  'scheduling.ganttChart': 'Gantt Chart',
  'scheduling.listView': 'List View',
  'scheduling.filterByProject': 'Filter by Project:',
  'scheduling.ganttChartView': 'Gantt Chart View',
  'scheduling.projectProgress': 'Project Progress',

  // Cost Management
  'cost.title': 'Cost Management',
  'cost.subtitle': 'Budget Forecasting and Cost Management',
  'cost.totalBudget': 'Total Budget',
  'cost.totalSpent': 'Total Spent',
  'cost.committed': 'Committed',
  'cost.remaining': 'Remaining',

  // Risk Management
  'risk.title': 'Risk Management',
  'risk.subtitle': 'Risk Register and Mitigation Planning',
  'risk.totalRisks': 'Total Risks',
  'risk.activeRisks': 'Active Risks',
  'risk.highImpact': 'High Impact',
  'risk.mitigated': 'Mitigated',

  // BIM
  'bim.title': '3D Model Viewer',
  'bim.subtitle': '3D Building Information Modeling Viewer',
  'bim.modelViewer': '3D Model Viewer',

  // GIS
  'gis.title': 'GIS & Mapping',
  'gis.subtitle': 'Geographic Information System & Spatial Mapping',
  'gis.projectLocationsMap': 'Project Locations Map - India',

  // Communications
  'communications.title': 'Communications',
  'communications.subtitle': 'Messages and Internal Communications',

  // Procurement
  'procurement.title': 'Procurement',
  'procurement.subtitle': 'Tenders and Contract Management',

  // E-Procurement
  'eprocurement.title': 'E-Procurement',
  'eprocurement.subtitle': 'Electronic Procurement Portal',

  // Workflow
  'workflow.title': 'Workflow Configuration',
  'workflow.subtitle': 'Configure and Manage Approval Workflows',

  // Approvals
  'approvals.title': 'Approvals',
  'approvals.subtitle': 'Pending Approvals and Reviews',

  // Reimbursement
  'reimbursement.title': 'Reimbursement',
  'reimbursement.subtitle': 'Expense Claims and Reimbursements',

  // RA Billing
  'billing.title': 'RA Billing',
  'billing.subtitle': 'Running Account Bills Management',

  // Fund Management
  'funds.title': 'Fund Management',
  'funds.subtitle': 'Project Funds Allocation and Tracking',

  // Budgeting
  'budgeting.title': 'Budgeting',
  'budgeting.subtitle': 'Budget Planning and Forecasting',

  // BOQ
  'boq.title': 'BOQ Management',
  'boq.subtitle': 'Bill of Quantities Management',

  // User Management
  'users.title': 'User Management',
  'users.subtitle': 'Manage Users, Roles and Permissions',

  // Role Manager
  'roles.title': 'Role Manager',
  'roles.subtitle': 'Configure Roles and Access Control',

  // ETP Master
  'etp.title': 'ETP Master',
  'etp.subtitle': 'ETP Configuration and Management',

  // Audit Logs
  'audit.title': 'Audit Logs',
  'audit.subtitle': 'System Activity and Change History',

  // Master Data
  'masterdata.title': 'Master Data',
  'masterdata.subtitle': 'Manage Reference Data and Configurations',

  // Status values
  'status.planning': 'Planning',
  'status.inProgress': 'In Progress',
  'status.onHold': 'On Hold',
  'status.completed': 'Completed',
  'status.cancelled': 'Cancelled',
  'status.draft': 'Draft',
  'status.underReview': 'Under Review',
  'status.approved': 'Approved',
  'status.rejected': 'Rejected',
  'status.closed': 'Closed',
  'status.mitigated': 'Mitigated',
  'status.assessed': 'Assessed',
  'status.notStarted': 'Not Started',
  'status.delayed': 'Delayed',

  // Priority values
  'priority.low': 'Low',
  'priority.medium': 'Medium',
  'priority.high': 'High',
  'priority.critical': 'Critical',

  // Header
  'header.english': 'English',
  'header.hindi': 'à¤¹à¤¿à¤‚à¤¦à¥€',
  'header.telugu': 'à°¤à±†à°²à±à°—à±',

  // Sidebar
  'sidebar.pmisZia': 'PMIS ZIA',
  'sidebar.programmeManagement': 'Programme Management',

  // Login
  'login.title': 'Programme Management Information System',
  'login.subtitle': 'Zaheerabad Industrial Area',
  'login.selectRole': 'Select your role to continue',
  'login.enter': 'Enter System',
  'login.authenticating': 'Authenticating...',
  'login.welcomeBack': 'Welcome back,',

  // Create Project Modal
  'project.createNewProject': 'Create New Project',
  'project.projectName': 'Project Name',
  'project.description': 'Description',
  'project.startDate': 'Start Date',
  'project.endDate': 'End Date',
  'project.budget': 'Budget (â‚¹)',
  'project.status': 'Status',
  'project.category': 'Category',
  'project.projectManager': 'Project Manager',

  // Upload Modal
  'upload.uploadDocument': 'Upload Document',
  'upload.dragAndDrop': 'Drag and drop your file here',
  'upload.or': 'or',
  'upload.browseFiles': 'Browse Files',

  // Translation
  'translation.translate': 'Translate',
  'translation.enterTextToTranslate': 'Enter text to translate',
  'translation.translationFailed': 'Translation failed',
};

export const LanguageProvider = ({ children }) => {
  const [language, setLanguage] = useState('en');

  /**
   * Helper to clear all Google Translate cookies
   * This is critical to stop the "Active Translation" state
   */
  const clearGoogleCookies = () => {
    const domain = window.location.hostname;
    const pastDate = 'Thu, 01 Jan 1970 00:00:00 UTC';

    // Clear cookie for current domain, root path, and dot-prefixed domain
    document.cookie = `googtrans=; expires=${pastDate}; path=/;`;
    document.cookie = `googtrans=; expires=${pastDate}; path=/; domain=${domain}`;
    document.cookie = `googtrans=; expires=${pastDate}; path=/; domain=.${domain}`;
  };

  // callback to reset widget
  const resetWidgetToOriginal = () => {
    const googleSelect = document.querySelector('.goog-te-combo');
    if (googleSelect) {
      googleSelect.value = '';
      googleSelect.dispatchEvent(new Event('change', { bubbles: true }));
    }
  };

  // Load saved language from localStorage on mount
  useEffect(() => {
    const savedLang = localStorage.getItem('pmis_language');

    if (savedLang && savedLang !== 'en') {
      setLanguage(savedLang);
      // Trigger translation for non-English languages after a delay
      setTimeout(() => triggerGoogleTranslate(savedLang), 1500);
    } else {
      // If 'en' or no preference, FORCE cleanup
      // This ensures we don't start with active translation by accident
      setLanguage('en');
      clearGoogleCookies();
      // Try to reset widget just in case
      setTimeout(resetWidgetToOriginal, 1000);
    }
  }, []);

  /**
   * Trigger Google Translate programmatically via the hidden combo box
   * This provides seamless in-page translation
   */
  const triggerGoogleTranslate = (langCode) => {
    const googleSelect = document.querySelector('.goog-te-combo');

    // Method 1: Combo Box (Preferred)
    if (googleSelect) {
      // For English: set to empty string to restore original
      // For other languages: set to language code
      googleSelect.value = langCode === 'en' ? '' : langCode;
      googleSelect.dispatchEvent(new Event('change', { bubbles: true }));
    } else if (langCode !== 'en') {
      // Retry for non-English if API isn't ready
      setTimeout(() => {
        const retrySelect = document.querySelector('.goog-te-combo');
        if (retrySelect) {
          retrySelect.value = langCode;
          retrySelect.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }, 1000);
    }

    // Method 2: Cookie Management (Persistence)
    if (langCode === 'en') {
      clearGoogleCookies();
    } else {
      const cookieValue = `/en/${langCode}`;
      document.cookie = `googtrans=${cookieValue}; path=/;`;
      document.cookie = `googtrans=${cookieValue}; path=/; domain=${window.location.hostname}`;
      document.cookie = `googtrans=${cookieValue}; path=/; domain=.${window.location.hostname}`;
    }
  };

  const handleSetLanguage = (lang) => {
    // If switching TO English FROM another language, we MUST reload
    // This is the only way to completely clear Google's DOM changes
    if (lang === 'en' && language !== 'en') {
      clearGoogleCookies();
      localStorage.setItem('pmis_language', 'en');
      setLanguage('en');
      window.location.reload();
      return;
    }

    setLanguage(lang);
    localStorage.setItem('pmis_language', lang);

    // Dispatch custom event to notify GoogleTranslateWidget to load script
    window.dispatchEvent(new CustomEvent('pmis-language-change', { detail: { language: lang } }));

    // Trigger the translation (or reset)
    setTimeout(() => triggerGoogleTranslate(lang), 100);
  };

  /**
   * Translation function - returns hardcoded English strings
   * Google Translate handles the actual translation to other languages
   */
  const t = (key) => {
    return STRINGS[key] || key;
  };

  return (
    <LanguageContext.Provider value={{ language, setLanguage: handleSetLanguage, t }}>
      {children}
    </LanguageContext.Provider>
  );
};

export const useLanguage = () => {
  const context = useContext(LanguageContext);
  if (context === undefined) {
    throw new Error('useLanguage must be used within a LanguageProvider');
  }
  return context;
};



================================================
FILE: frontend/src/contexts/SidebarContext.jsx
================================================
import { createContext, useContext, useState, useEffect, useCallback } from 'react';

const SidebarContext = createContext(undefined);

export const SidebarProvider = ({ children }) => {
  // Desktop collapse state (persisted)
  const [isCollapsed, setIsCollapsed] = useState(() => {
    try {
      const saved = localStorage.getItem('sidebar_collapsed');
      return saved ? JSON.parse(saved) : false;
    } catch {
      localStorage.removeItem('sidebar_collapsed');
      return false;
    }
  });

  // Mobile menu open state (not persisted)
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  // Track if viewport is mobile
  const [isMobile, setIsMobile] = useState(false);

  const checkMobile = useCallback(() => {
    setIsMobile(window.innerWidth < 1024);
  }, []);

  useEffect(() => {
    checkMobile();
    let timeoutId;
    const handleResize = () => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(checkMobile, 100);
    };
    window.addEventListener('resize', handleResize);
    return () => {
      window.removeEventListener('resize', handleResize);
      clearTimeout(timeoutId);
    };
  }, [checkMobile]);

  // Persist collapse state
  useEffect(() => {
    localStorage.setItem('sidebar_collapsed', JSON.stringify(isCollapsed));
  }, [isCollapsed]);

  // Close mobile menu when switching to desktop
  useEffect(() => {
    if (!isMobile) {
      setIsMobileMenuOpen(false);
    }
  }, [isMobile]);

  return (
    <SidebarContext.Provider value={{
      isCollapsed,
      setIsCollapsed,
      isMobileMenuOpen,
      setIsMobileMenuOpen,
      isMobile
    }}>
      {children}
    </SidebarContext.Provider>
  );
};

export const useSidebar = () => {
  const context = useContext(SidebarContext);
  if (context === undefined) {
    throw new Error('useSidebar must be used within a SidebarProvider');
  }
  return context;
};



================================================
FILE: frontend/src/contexts/ThemeContext.jsx
================================================
/**
 * ThemeContext - Production-Grade Dark Mode Management
 * 
 * Features:
 * - Three modes: light, dark, system (follows OS preference)
 * - Persistent storage via localStorage
 * - Automatic OS preference detection and syncing
 * - No FOUC (Flash of Unstyled Content)
 * - Type-safe with JSDoc
 * 
 * Usage:
 * ```jsx
 * import { useTheme } from '@/contexts/ThemeContext';
 * 
 * const { theme, setTheme, effectiveTheme } = useTheme();
 * // theme: 'light' | 'dark' | 'system'
 * // effectiveTheme: 'light' | 'dark' (resolved from system)
 * ```
 */

import { createContext, useContext, useState, useEffect } from 'react';
import PropTypes from 'prop-types';

/**
 * @typedef {'light' | 'dark' | 'system'} ThemeMode
 * @typedef {'light' | 'dark'} EffectiveTheme
 */

/**
 * @typedef {Object} ThemeContextValue
 * @property {ThemeMode} theme - Current theme mode
 * @property {(theme: ThemeMode) => void} setTheme - Function to change theme
 * @property {EffectiveTheme} effectiveTheme - Actual theme being applied (resolved from system if needed)
 * @property {boolean} isSystemDarkMode - Whether OS prefers dark mode
 */

const ThemeContext = createContext(/** @type {ThemeContextValue | undefined} */(undefined));

const STORAGE_KEY = 'app-theme';
const VALID_THEMES = ['light', 'dark', 'system'];

/**
 * Get initial theme from localStorage or default to 'system'
 * @returns {ThemeMode}
 */
function getInitialTheme() {
    if (typeof window === 'undefined') return 'system';

    try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored && VALID_THEMES.includes(stored)) {
            return /** @type {ThemeMode} */ (stored);
        }
    } catch (error) {
        console.warn('Failed to read theme from localStorage:', error);
    }

    return 'system';
}

/**
 * Check if OS prefers dark mode
 * @returns {boolean}
 */
function getSystemDarkMode() {
    if (typeof window === 'undefined') return false;
    return window.matchMedia('(prefers-color-scheme: dark)').matches;
}

/**
 * Resolve effective theme (system -> light/dark)
 * @param {ThemeMode} theme 
 * @param {boolean} isSystemDark 
 * @returns {EffectiveTheme}
 */
function resolveEffectiveTheme(theme, isSystemDark) {
    if (theme === 'system') {
        return isSystemDark ? 'dark' : 'light';
    }
    return theme;
}

/**
 * Apply theme to DOM
 * @param {EffectiveTheme} effectiveTheme 
 */
function applyThemeToDOM(effectiveTheme) {
    const root = document.documentElement;

    if (effectiveTheme === 'dark') {
        root.classList.add('dark');
    } else {
        root.classList.remove('dark');
    }
}

/**
 * Theme Provider Component
 * Manages dark mode state and syncs with OS preferences
 */
export function ThemeProvider({ children }) {
    const [theme, setThemeState] = useState(getInitialTheme);
    const [isSystemDarkMode, setIsSystemDarkMode] = useState(getSystemDarkMode);

    // Calculate effective theme
    const effectiveTheme = resolveEffectiveTheme(theme, isSystemDarkMode);

    /**
     * Update theme and persist to storage
     * @param {ThemeMode} newTheme 
     */
    const setTheme = (newTheme) => {
        if (!VALID_THEMES.includes(newTheme)) {
            console.error(`Invalid theme: ${newTheme}. Must be one of: ${VALID_THEMES.join(', ')}`);
            return;
        }

        setThemeState(newTheme);

        try {
            localStorage.setItem(STORAGE_KEY, newTheme);
        } catch (error) {
            console.warn('Failed to save theme to localStorage:', error);
        }
    };

    // Apply theme to DOM whenever effectiveTheme changes
    useEffect(() => {
        applyThemeToDOM(effectiveTheme);
    }, [effectiveTheme]);

    // ALWAYS Listen for OS theme changes to keep internal state synced
    // Re-attach listener when 'theme' changes so closure captures current theme
    useEffect(() => {
        if (typeof window === 'undefined') return;

        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

        const handleChange = (e) => {
            const newSystemDark = e.matches;
            setIsSystemDarkMode(newSystemDark);

            // Force immediate DOM update if in system mode
            if (theme === 'system') {
                const newEffective = newSystemDark ? 'dark' : 'light';
                applyThemeToDOM(newEffective);
            }
        };

        // Initialize state
        setIsSystemDarkMode(mediaQuery.matches);

        // Modern browsers
        if (mediaQuery.addEventListener) {
            mediaQuery.addEventListener('change', handleChange);
            return () => mediaQuery.removeEventListener('change', handleChange);
        }
        // Legacy browsers
        else if (mediaQuery.addListener) {
            mediaQuery.addListener(handleChange);
            return () => mediaQuery.removeListener(handleChange);
        }
    }, [theme]); // Run when theme changes to update closure

    const value = {
        theme,
        setTheme,
        effectiveTheme,
        isSystemDarkMode,
    };

    return (
        <ThemeContext.Provider value={value}>
            {children}
        </ThemeContext.Provider>
    );
}

ThemeProvider.propTypes = {
    children: PropTypes.node.isRequired,
};

/**
 * Hook to access theme context
 * @returns {ThemeContextValue}
 * @throws {Error} If used outside ThemeProvider
 */
export function useTheme() {
    const context = useContext(ThemeContext);

    if (context === undefined) {
        throw new Error('useTheme must be used within a ThemeProvider');
    }

    return context;
}

/**
 * Export for testing or direct access
 */
export { ThemeContext };



================================================
FILE: frontend/src/hooks/useAnimatedCounter.jsx
================================================
import { useState, useEffect, useRef } from 'react';

/**
 * useAnimatedCounter Hook
 * Animates a number from start to end value
 * @param {number} end - Target value
 * @param {number} duration - Animation duration in ms
 * @param {boolean} trigger - When true, starts animation
 */
export const useAnimatedCounter = (end, duration = 1500, trigger = true) => {
    const [count, setCount] = useState(0);
    const countRef = useRef(0);
    const startTimeRef = useRef(null);
    const animationRef = useRef(null);

    useEffect(() => {
        if (!trigger || end === 0) {
            setCount(end);
            return;
        }

        const startValue = countRef.current;
        const difference = end - startValue;

        const animate = (timestamp) => {
            if (!startTimeRef.current) {
                startTimeRef.current = timestamp;
            }

            const elapsed = timestamp - startTimeRef.current;
            const progress = Math.min(elapsed / duration, 1);

            // Easing function (ease-out)
            const easeOut = 1 - Math.pow(1 - progress, 3);

            const currentValue = startValue + difference * easeOut;
            countRef.current = currentValue;
            setCount(Math.round(currentValue));

            if (progress < 1) {
                animationRef.current = requestAnimationFrame(animate);
            }
        };

        startTimeRef.current = null;
        animationRef.current = requestAnimationFrame(animate);

        return () => {
            if (animationRef.current) {
                cancelAnimationFrame(animationRef.current);
            }
        };
    }, [end, duration, trigger]);

    return count;
};

/**
 * AnimatedNumber Component
 * Displays a number with count-up animation
 */
export const AnimatedNumber = ({
    value,
    duration = 1500,
    prefix = '',
    suffix = '',
    className = '',
    decimals = 0
}) => {
    const [displayed, setDisplayed] = useState(0);
    const previousValue = useRef(0);

    useEffect(() => {
        const startValue = previousValue.current;
        const endValue = Number(value) || 0;
        const difference = endValue - startValue;
        const startTime = performance.now();

        const animate = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // Ease-out cubic
            const easeOut = 1 - Math.pow(1 - progress, 3);
            const current = startValue + difference * easeOut;

            setDisplayed(decimals > 0 ? current.toFixed(decimals) : Math.round(current));

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                previousValue.current = endValue;
            }
        };

        requestAnimationFrame(animate);
    }, [value, duration, decimals]);

    return (
        <span className={className}>
            {prefix}{displayed}{suffix}
        </span>
    );
};

export default AnimatedNumber;



================================================
FILE: frontend/src/hooks/useETPCalculation.js
================================================
import { useState, useCallback, useEffect } from 'react';
import financeService from '@/api/services/financeService';
import { debounce } from '@/lib/utils';

/**
 * React hook for automatic ETP calculation
 * 
 * Fetches deductions from the backend based on current bill values
 * and provides a complete bill summary.
 * 
 * @example
 * const { calculate, summary, loading, error } = useETPCalculation();
 * 
 * // Call when gross amount changes
 * useEffect(() => {
 *   calculate({ gross_amount: 1000000 });
 * }, [grossAmount]);
 */
export const useETPCalculation = (options = {}) => {
    const { autoCalculate = false, debounceMs = 500 } = options;

    const [summary, setSummary] = useState(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    /**
     * Perform ETP calculation
     * @param {Object} params - Calculation parameters
     */
    const calculate = useCallback(async (params) => {
        if (!params.gross_amount || params.gross_amount <= 0) {
            setSummary(null);
            return null;
        }

        setLoading(true);
        setError(null);

        try {
            const response = await financeService.calculateETP({
                gross_amount: params.gross_amount,
                gst_percentage: params.gst_percentage ?? 18,
                retention_percentage: params.retention_percentage ?? 0,
                other_deductions: params.other_deductions ?? 0,
                advances_recovery: params.advances_recovery ?? 0,
                works_component: params.works_component,
                material_cost: params.material_cost,
                labour_cost: params.labour_cost,
            });

            setSummary(response.data);
            return response.data;
        } catch (err) {
            const errorMsg = err.response?.data?.error || 'Calculation failed';
            setError(errorMsg);
            console.error('ETP calculation error:', err);
            return null;
        } finally {
            setLoading(false);
        }
    }, []);

    // Debounced version for auto-calculation
    const debouncedCalculate = useCallback(
        debounce(calculate, debounceMs),
        [calculate, debounceMs]
    );

    return {
        calculate,
        debouncedCalculate,
        summary,
        loading,
        error,
        // Helper getters from summary
        get netPayable() { return summary?.net_payable ?? 0; },
        get totalDeductions() { return summary?.total_deductions ?? 0; },
        get gstAmount() { return summary?.gst_amount ?? 0; },
        get statutoryCharges() { return summary?.statutory_charges ?? { deductions: [], recoveries: [], levies: [], additions: [] }; },
    };
};

/**
 * Format currency in Indian Rupees
 */
export const formatINR = (amount, showPaise = true) => {
    if (amount === null || amount === undefined) return 'â‚¹0';

    const num = Number(amount);
    if (isNaN(num)) return 'â‚¹0';

    const options = {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: showPaise ? 2 : 0,
        maximumFractionDigits: showPaise ? 2 : 0,
    };

    return num.toLocaleString('en-IN', options);
};

/**
 * Calculate percentage of total
 */
export const calculatePercentage = (part, total) => {
    if (!total || total === 0) return 0;
    return ((part / total) * 100).toFixed(2);
};

export default useETPCalculation;



================================================
FILE: frontend/src/hooks/useMockData.js
================================================
import { useState, useEffect, useCallback } from 'react';
import { tasks, budgets, risks, projects, users, contractors } from '@/mock';
import { useAuth } from '@/contexts/AuthContext'; // Import useAuth
import { AuditLogger } from '@/services/AuditLogger'; // Import Logger

const STORAGE_KEYS = {

  tasks: 'pmis_tasks_v2',
  budgets: 'pmis_budgets_v2',
  risks: 'pmis_risks_v2',
  projects: 'pmis_projects_v2',
  packages: 'pmis_packages_v2',
  contractors: 'pmis_contractors_v2',
  raBills: 'pmis_ra_bills_v2',
};

// Load from localStorage or use initial mock data
const loadFromStorage = (key, fallback) => {
  if (typeof window === 'undefined') return fallback;
  try {
    const stored = localStorage.getItem(key);
    if (stored) {
      return JSON.parse(stored);
    }
  } catch (error) {
    console.error(`Error loading ${key} from storage:`, error);
  }
  return fallback;
};

// Save to localStorage
const saveToStorage = (key, data) => {
  if (typeof window === 'undefined') return;
  try {
    localStorage.setItem(key, JSON.stringify(data));
  } catch (error) {
    console.error(`Error saving ${key} to storage:`, error);
  }
};

// Simulate async operation
const simulateAsync = (data, delay = 800) => {
  return new Promise((resolve) => {
    setTimeout(() => resolve(data), delay);
  });
};

export const useMockData = () => {
  const { user } = useAuth(); // Access current user for logging


  const [tasksData, setTasksData] = useState(() =>
    loadFromStorage(STORAGE_KEYS.tasks, tasks)
  );
  const [budgetsData, setBudgetsData] = useState(() =>
    loadFromStorage(STORAGE_KEYS.budgets, budgets)
  );
  const [risksData, setRisksData] = useState(() =>
    loadFromStorage(STORAGE_KEYS.risks, risks)
  );
  const [projectsData, setProjectsData] = useState(() =>
    loadFromStorage(STORAGE_KEYS.projects, projects)
  );
  const [packagesData, setPackagesData] = useState(() =>
    loadFromStorage(STORAGE_KEYS.packages, [])
  );

  const [contractorsData, setContractorsData] = useState(() =>
    loadFromStorage(STORAGE_KEYS.contractors, contractors)
  );

  const [raBillsData, setRaBillsData] = useState(() =>
    loadFromStorage(STORAGE_KEYS.raBills, [])
  );

  // Persist to localStorage whenever data changes


  useEffect(() => {
    saveToStorage(STORAGE_KEYS.tasks, tasksData);
  }, [tasksData]);

  useEffect(() => {
    saveToStorage(STORAGE_KEYS.budgets, budgetsData);
  }, [budgetsData]);

  useEffect(() => {
    saveToStorage(STORAGE_KEYS.risks, risksData);
  }, [risksData]);

  useEffect(() => {
    saveToStorage(STORAGE_KEYS.projects, projectsData);
  }, [projectsData]);

  useEffect(() => {
    saveToStorage(STORAGE_KEYS.packages, packagesData);
  }, [packagesData]);

  useEffect(() => {
    saveToStorage(STORAGE_KEYS.contractors, contractorsData);
  }, [contractorsData]);

  useEffect(() => {
    saveToStorage(STORAGE_KEYS.raBills, raBillsData);
  }, [raBillsData]);

  // Projects CRUD
  const addProject = useCallback(async (project) => {
    const newProject = { ...project, id: `proj-${Date.now()}` };
    const result = await simulateAsync(newProject, 800);
    setProjectsData((prev) => [result, ...prev]);
    AuditLogger.logAction(user, 'CREATE', 'Project', `Created project: ${result.name}`);
    return result;
  }, [user]);

  const updateProject = useCallback(async (id, updates) => {
    const updated = projectsData.find((p) => p.id === id);
    if (!updated) throw new Error('Project not found');
    const result = await simulateAsync({ ...updated, ...updates }, 600);
    setProjectsData((prev) => prev.map((p) => (p.id === id ? result : p)));
    AuditLogger.logAction(user, 'UPDATE', 'Project', `Updated project: ${updated.name}`, updates);
    return result;
  }, [projectsData, user]);

  const deleteProject = useCallback(async (id) => {
    await simulateAsync(null, 600);
    setProjectsData((prev) => prev.filter((p) => p.id !== id));
    AuditLogger.logAction(user, 'DELETE', 'Project', `Deleted project ID: ${id}`);
  }, [user]);



  // Tasks CRUD
  const updateTask = useCallback(async (id, updates) => {
    const updated = tasksData.find((t) => t.id === id);
    if (!updated) throw new Error('Task not found');
    const result = await simulateAsync({ ...updated, ...updates }, 600);
    setTasksData((prev) => prev.map((t) => (t.id === id ? result : t)));
    AuditLogger.logAction(user, 'UPDATE', 'Task', `Updated task: ${updated.title}`, updates);
    return result;
  }, [tasksData, user]);

  const toggleTaskComplete = useCallback(async (id) => {
    const task = tasksData.find((t) => t.id === id);
    if (!task) throw new Error('Task not found');
    const newStatus = task.status === 'Completed' ? 'In Progress' : 'Completed';
    const newProgress = newStatus === 'Completed' ? 100 : task.progress;

    // Use the base updateTask which logs internally
    return updateTask(id, { status: newStatus, progress: newProgress });
  }, [tasksData, updateTask]);

  // Budgets CRUD
  const updateBudget = useCallback(async (id, updates) => {
    const updated = budgetsData.find((b) => b.id === id);
    if (!updated) throw new Error('Budget not found');
    const result = await simulateAsync({ ...updated, ...updates }, 600);
    setBudgetsData((prev) => prev.map((b) => (b.id === id ? result : b)));
    AuditLogger.logAction(user, 'UPDATE', 'Budget', `Updated budget for: ${updated.category}`, updates);
    return result;
  }, [budgetsData, user]);

  // Risks CRUD
  const updateRisk = useCallback(async (id, updates) => {
    const updated = risksData.find((r) => r.id === id);
    if (!updated) throw new Error('Risk not found');
    const result = await simulateAsync({ ...updated, ...updates }, 600);
    setRisksData((prev) => prev.map((r) => (r.id === id ? result : r)));
    AuditLogger.logAction(user, 'UPDATE', 'Risk', `Updated risk: ${updated.description}`, updates);
    return result;
  }, [risksData, user]);

  // Contractors CRUD
  const addContractor = useCallback(async (contractor) => {
    console.log('useMockData: Adding contractor', contractor);
    const newContractor = { ...contractor, id: `contr-${Date.now()}` };
    const result = await simulateAsync(newContractor, 800);
    setContractorsData((prev) => [result, ...prev]);
    AuditLogger.logAction(user, 'CREATE', 'Contractor', `Registered contractor: ${result.contractorName} (${result.email})`);
    return result;
  }, [user]);

  const deleteContractor = useCallback(async (id) => {
    await simulateAsync(null, 600);
    setContractorsData((prev) => prev.filter((c) => c.id !== id));
    AuditLogger.logAction(user, 'DELETE', 'Contractor', `Deleted contractor ID: ${id}`);
  }, [user]);

  const updateContractor = useCallback(async (id, updates) => {
    const updated = contractorsData.find((c) => c.id === id);
    if (!updated) throw new Error('Contractor not found');
    const result = await simulateAsync({ ...updated, ...updates }, 600);
    setContractorsData((prev) => prev.map((c) => (c.id === id ? result : c)));
    AuditLogger.logAction(user, 'UPDATE', 'Contractor', `Updated contractor: ${updated.contractorName}`, updates);
    return result;
  }, [contractorsData, user]);

  // RA BILLS
  const addRABill = useCallback(async (bill) => {
    const newBill = { ...bill, id: `bill-${Date.now()}` };
    const result = await simulateAsync(newBill, 800);
    setRaBillsData((prev) => [result, ...prev]);
    AuditLogger.logAction(user, 'CREATE', 'Billing', `Generated RA Bill: ${result.invoiceNumber}`);
    return result;
  }, [user]);

  return {
    users, // Export users static data

    tasks: tasksData,
    budgets: budgetsData,
    risks: risksData,
    projects: projectsData,
    packages: packagesData,
    contractors: contractorsData,

    updateTask,
    toggleTaskComplete,
    updateBudget,
    updateRisk,
    addProject,
    updateProject,
    deleteProject,
    addPackage: useCallback(async (pkg) => {
      const newPkg = { ...pkg, id: `pkg-${Date.now()}` };
      const result = await simulateAsync(newPkg, 800);
      setPackagesData((prev) => [result, ...prev]);
      AuditLogger.logAction(user, 'CREATE', 'Package', `Created package: ${result.name}`);
      return result;
    }, [user]),
    addContractor,
    deleteContractor,
    updateContractor,
    raBills: raBillsData,
    addRABill,
  };
};




================================================
FILE: frontend/src/hooks/useModalClose.js
================================================
import { useEffect } from 'react';

/**
 * Hook to handle modal closing interactions.
 * - Closes on 'Escape' key press.
 * - Does NOT close on backdrop click (by design decision).
 * 
 * @param {boolean} isOpen - Whether the modal is currently open.
 * @param {function} onClose - Function to call when closing is triggered.
 * @param {boolean} [blockEscape=false] - Optional flag to block Escape key closing (e.g., if a sub-modal is open).
 */
export const useModalClose = (isOpen, onClose, blockEscape = false) => {
    useEffect(() => {
        const handleEscape = (e) => {
            // Only trigger if open, Escape is pressed, and not blocked
            if (isOpen && e.key === 'Escape' && !blockEscape) {
                e.preventDefault();
                onClose();
            }
        };

        if (isOpen) {
            window.addEventListener('keydown', handleEscape);
        }

        return () => window.removeEventListener('keydown', handleEscape);
    }, [isOpen, onClose, blockEscape]);
};



================================================
FILE: frontend/src/lib/calculations.js
================================================
/**
 * Centralized Business Rules and Calculations
 * 
 * This file contains all formulas, rules, and calculation logic.
 * In production, these rules will process real-time data from APIs/databases.
 * 
 * All calculations are pure functions that can be easily tested and replaced.
 */

// ============================================================================
// KPI CALCULATION RULES
// ============================================================================

/**
 * Calculate Schedule Performance Index (SPI)
 * Formula: SPI = Earned Value / Planned Value
 * Rule: SPI > 1 = Ahead of schedule, SPI < 1 = Behind schedule
 */
export const calculateSPI = (earnedValue, plannedValue) => {
  if (plannedValue === 0) return 1;
  return earnedValue / plannedValue;
};

/**
 * Calculate Cost Performance Index (CPI)
 * Formula: CPI = Earned Value / Actual Cost
 * Rule: CPI > 1 = Under budget, CPI < 1 = Over budget
 */
export const calculateCPI = (earnedValue, actualCost) => {
  if (actualCost === 0) return 1;
  return earnedValue / actualCost;
};

/**
 * Calculate Cost Variation
 * Formula: CV = Budget - Actual Spent
 * Rule: Positive = Under budget, Negative = Over budget
 */
export const calculateCostVariation = (budget, spent) => {
  return budget - spent;
};

/**
 * Calculate Cost Variation Percentage
 * Formula: CV% = ((Budget - Spent) / Budget) * 100
 */
export const calculateCostVariationPercentage = (budget, spent) => {
  if (budget === 0) return 0;
  return ((budget - spent) / budget) * 100;
};

/**
 * Calculate Budget Utilization Rate
 * Formula: Utilization = (Spent / Budget) * 100
 */
export const calculateBudgetUtilization = (budget, spent) => {
  if (budget === 0) return 0;
  return (spent / budget) * 100;
};

/**
 * Calculate Project Progress Percentage
 * Formula: Progress = (Completed Tasks / Total Tasks) * 100
 * Alternative: Progress = (Actual Duration / Planned Duration) * 100
 */
export const calculateProjectProgress = (completedTasks, totalTasks) => {
  if (totalTasks === 0) return 0;
  return (completedTasks / totalTasks) * 100;
};

/**
 * Calculate Risk Score
 * Formula: Risk Score = Probability Score Ã— Impact Score
 * Probability: Low = 1, Medium = 2, High = 3
 * Impact: Low = 1, Medium = 2, High = 3, Critical = 4
 */
export const calculateRiskScore = (probability, impact) => {
  const probabilityScore = probability === 'Low' ? 1 : probability === 'Medium' ? 2 : 3;
  const impactScore = impact === 'Low' ? 1 : impact === 'Medium' ? 2 : impact === 'High' ? 3 : 4;
  return probabilityScore * impactScore;
};

/**
 * Determine Risk Priority
 * Rule: Score 1-3 = Low, 4-6 = Medium, 7-9 = High, 10+ = Critical
 */
export const getRiskPriority = (riskScore) => {
  if (riskScore >= 10) return 'Critical';
  if (riskScore >= 7) return 'High';
  if (riskScore >= 4) return 'Medium';
  return 'Low';
};

// ============================================================================
// BUDGET CALCULATION RULES
// ============================================================================

/**
 * Calculate Remaining Budget
 * Formula: Remaining = Allocated - Spent - Committed
 */
export const calculateRemainingBudget = (allocated, spent, committed) => {
  return Math.max(0, allocated - spent - committed);
};

/**
 * Calculate Budget Variance
 * Formula: Variance = Allocated - (Spent + Committed)
 */
export const calculateBudgetVariance = (allocated, spent, committed) => {
  return allocated - (spent + committed);
};

/**
 * Calculate Budget Health Status
 * Rule:
 * - Utilization > 90% = Critical (Red)
 * - Utilization > 75% = Warning (Yellow)
 * - Utilization <= 75% = Healthy (Green)
 */
export const getBudgetHealthStatus = (utilization) => {
  if (utilization > 90) return 'critical';
  if (utilization > 75) return 'warning';
  return 'healthy';
};

/**
 * Calculate Land Acquisition Status Color
 * Rule:
 * - > 90% = Green (Complete)
 * - > 50% = Yellow (In Progress)
 * - <= 50% = Red (Delayed)
 */
export const getLandAcquisitionStatusColor = (percentage) => {
  if (percentage > 90) return 'green';
  if (percentage > 50) return 'yellow';
  return 'red';
};

// ============================================================================
// FORECAST CALCULATION RULES
// ============================================================================

/**
 * Calculate Cost Forecast using Trend Analysis
 * Formula: Forecast = Actual + (Trend Ã— Remaining Periods)
 * Trend = Average monthly variance over last 3 months
 */
export const calculateCostForecast = (actualCosts, remainingMonths) => {
  if (actualCosts.length < 2) return actualCosts[actualCosts.length - 1] || 0;

  // Calculate trend (average monthly change)
  const monthlyChanges = [];
  for (let i = 1; i < actualCosts.length; i++) {
    monthlyChanges.push(actualCosts[i] - actualCosts[i - 1]);
  }

  const averageTrend = monthlyChanges.reduce((sum, change) => sum + change, 0) / monthlyChanges.length;
  const lastActual = actualCosts[actualCosts.length - 1];

  return lastActual + averageTrend * remainingMonths;
};

/**
 * Calculate Variance Percentage
 * Formula: Variance% = ((Forecast - Actual) / Actual) * 100
 */
export const calculateForecastVariance = (forecast, actual) => {
  if (actual === 0) return 0;
  return ((forecast - actual) / actual) * 100;
};

// ============================================================================
// PROJECT STATUS RULES
// ============================================================================

/**
 * Determine Project Status based on Progress and Budget
 * Rules:
 * - Progress = 100% â†’ Completed
 * - Progress < 10% â†’ Planning
 * - Budget Utilization > 100% â†’ On Hold
 * - Progress > 0% and < 100% â†’ In Progress
 */
export const determineProjectStatus = (progress, budgetUtilization) => {
  if (progress === 100) return 'Completed';
  if (progress < 10) return 'Planning';
  if (budgetUtilization > 100) return 'On Hold';
  if (progress > 0 && progress < 100) return 'In Progress';
  return 'Planning';
};

/**
 * Calculate Project Health Score
 * Formula: Health = (Progress Score + Budget Score + Risk Score) / 3
 * Each score is normalized to 0-100
 */
export const calculateProjectHealthScore = (progress, budgetUtilization, riskCount, totalRisks) => {
  const progressScore = progress;
  const budgetScore = Math.max(0, 100 - budgetUtilization);
  const riskScore = totalRisks > 0 ? ((totalRisks - riskCount) / totalRisks) * 100 : 100;

  return (progressScore + budgetScore + riskScore) / 3;
};

// ============================================================================
// AGGREGATION RULES
// ============================================================================

/**
 * Aggregate Budget by Source
 * Rule: Sum all budgets grouped by source (Central/State/Loan)
 */
export const aggregateBudgetBySource = (budgets) => {
  return budgets.reduce((acc, budget) => {
    const source = budget.source || 'Unknown';
    acc[source] = (acc[source] || 0) + budget.allocated;
    return acc;
  }, {});
};

/**
 * Aggregate Budget by Utilization Category
 * Rule: Sum all budgets grouped by utilization (Infra/Tech/Land)
 */
export const aggregateBudgetByUtilization = (budgets) => {
  return budgets.reduce((acc, budget) => {
    const utilization = budget.utilization || 'Other';
    acc[utilization] = (acc[utilization] || 0) + budget.allocated;
    return acc;
  }, {});
};

/**
 * Calculate Total Project Budget
 * Rule: Sum all allocated budgets for a project
 */
export const calculateTotalProjectBudget = (budgets) => {
  return budgets.reduce((sum, budget) => sum + Number(budget.allocated || 0), 0);
};

/**
 * Calculate Total Project Spent
 * Rule: Sum all spent amounts for a project
 */
export const calculateTotalProjectSpent = (budgets) => {
  return budgets.reduce((sum, budget) => sum + Number(budget.spent || 0), 0);
};

// ============================================================================
// WORKFLOW RULES
// ============================================================================

/**
 * Determine Next Workflow Step
 * Rule: Move to next step when current step is approved
 */
export const getNextWorkflowStep = (currentStep, totalSteps) => {
  if (currentStep >= totalSteps) return null;
  return currentStep + 1;
};

/**
 * Check if Workflow Step is Required
 * Rule: Step is required if marked as required in workflow definition
 */
export const isWorkflowStepRequired = (stepRequired) => {
  return stepRequired;
};

/**
 * Determine Workflow Status
 * Rules:
 * - All steps approved â†’ Approved
 * - Any step rejected â†’ Rejected
 * - Current step pending â†’ In Progress
 * - No steps started â†’ Pending
 */
export const determineWorkflowStatus = (currentStep, totalSteps, hasRejection) => {
  if (hasRejection) return 'Rejected';
  if (currentStep === 0) return 'Pending';
  if (currentStep >= totalSteps) return 'Approved';
  return 'In Progress';
};

// ============================================================================
// PERMISSION RULES
// ============================================================================

/**
 * Check if User Can Create Project
 * Rule: Only Admin (SPV_Official) and Manager (PMNC_Team) roles can create projects
 */
export const canCreateProject = (userRole) => {
  return userRole === 'SPV_Official' || userRole === 'PMNC_Team';
};

/**
 * Check if User Can Approve Documents
 * Rule: Admin and Manager roles can approve, Contributors can only upload
 */
export const canApproveDocuments = (userRole) => {
  return userRole === 'SPV_Official' || userRole === 'PMNC_Team';
};

/**
 * Check if User Can Delete Documents
 * Rule: Only Admin role can delete documents
 */
export const canDeleteDocuments = (userRole) => {
  return userRole === 'SPV_Official';
};

// ============================================================================
// DATA FILTERING RULES
// ============================================================================

/**
 * Filter Projects by Status
 * Rule: Return projects matching the status filter
 */
export const filterProjectsByStatus = (projects, status) => {
  if (status === 'all') return projects;
  return projects.filter((p) => p.status === status);
};

/**
 * Filter Documents by Project Hierarchy
 * Rule: Documents must belong to a project (no orphaned files)
 */
export const filterDocumentsByProject = (documents, projectId) => {
  if (projectId === 'all') return documents;
  return documents.filter((doc) => doc.projectId === projectId);
};

/**
 * Filter Risks by Project and Status
 * Rule: Return risks matching both project and status filters
 */
export const filterRisks = (risks, projectId, status) => {
  let filtered = risks;
  if (projectId !== 'all') {
    filtered = filtered.filter((r) => r.projectId === projectId);
  }
  if (status !== 'all') {
    filtered = filtered.filter((r) => r.status === status);
  }
  return filtered;
};

// ============================================================================
// VALIDATION RULES
// ============================================================================

/**
 * Validate Budget Allocation
 * Rule: Allocated amount must be positive
 */
export const validateBudgetAllocation = (amount) => {
  return amount > 0;
};

/**
 * Validate Project Dates
 * Rule: End date must be after start date
 */
export const validateProjectDates = (startDate, endDate) => {
  return new Date(endDate) > new Date(startDate);
};

/**
 * Validate Reimbursement Amount
 * Rule: Amount must be positive and within reasonable limits (e.g., < 1 Cr)
 */
export const validateReimbursementAmount = (amount) => {
  const maxAmount = 10000000; // 1 Crore
  return amount > 0 && amount <= maxAmount;
};

// ============================================================================
// EXPORT ALL RULES
// ============================================================================

export const CalculationRules = {
  // KPI Rules
  calculateSPI,
  calculateCPI,
  calculateCostVariation,
  calculateCostVariationPercentage,
  calculateBudgetUtilization,
  calculateProjectProgress,
  calculateRiskScore,
  getRiskPriority,

  // Budget Rules
  calculateRemainingBudget,
  calculateBudgetVariance,
  getBudgetHealthStatus,
  getLandAcquisitionStatusColor,
  aggregateBudgetBySource,
  aggregateBudgetByUtilization,
  calculateTotalProjectBudget,
  calculateTotalProjectSpent,

  // Forecast Rules
  calculateCostForecast,
  calculateForecastVariance,

  // Project Rules
  determineProjectStatus,
  calculateProjectHealthScore,

  // Workflow Rules
  getNextWorkflowStep,
  isWorkflowStepRequired,
  determineWorkflowStatus,

  // Permission Rules
  canCreateProject,
  canApproveDocuments,
  canDeleteDocuments,

  // Filtering Rules
  filterProjectsByStatus,
  filterDocumentsByProject,
  filterRisks,

  // Validation Rules
  validateBudgetAllocation,
  validateProjectDates,
  validateReimbursementAmount,
};




================================================
FILE: frontend/src/lib/colors.js
================================================
// Centralized color scheme for consistent UI
export const colors = {
  // Status colors - using semantic naming
  status: {
    success: {
      bg: 'bg-emerald-50 dark:bg-emerald-900/30',
      text: 'text-emerald-700 dark:text-emerald-400',
      border: 'border-emerald-200 dark:border-emerald-800',
      icon: 'text-emerald-600 dark:text-emerald-500',
    },
    warning: {
      bg: 'bg-amber-50 dark:bg-amber-900/30',
      text: 'text-amber-700 dark:text-amber-400',
      border: 'border-amber-200 dark:border-amber-800',
      icon: 'text-amber-600 dark:text-amber-500',
    },
    error: {
      bg: 'bg-red-50 dark:bg-red-900/30',
      text: 'text-red-700 dark:text-red-400',
      border: 'border-red-200 dark:border-red-800',
      icon: 'text-red-600 dark:text-red-500',
    },
    info: {
      bg: 'bg-primary-50 dark:bg-primary-900/30',
      text: 'text-primary-700 dark:text-primary-400',
      border: 'border-primary-200 dark:border-primary-800',
      icon: 'text-primary-600 dark:text-primary-500',
    },
    neutral: {
      bg: 'bg-gray-50 dark:bg-gray-800',
      text: 'text-gray-700 dark:text-gray-300',
      border: 'border-gray-200 dark:border-gray-700',
      icon: 'text-gray-600 dark:text-gray-400',
    },
  },
  // Priority colors
  priority: {
    critical: {
      bg: 'bg-red-50 dark:bg-red-900/30',
      text: 'text-red-700 dark:text-red-400',
      icon: 'text-red-600 dark:text-red-500',
    },
    high: {
      bg: 'bg-accent-50 dark:bg-accent-900/30',
      text: 'text-accent-700 dark:text-accent-400',
      icon: 'text-accent-600 dark:text-accent-500',
    },
    medium: {
      bg: 'bg-amber-50 dark:bg-amber-900/30',
      text: 'text-amber-700 dark:text-amber-400',
      icon: 'text-amber-600 dark:text-amber-500',
    },
    low: {
      bg: 'bg-emerald-50 dark:bg-emerald-900/30',
      text: 'text-emerald-700 dark:text-emerald-400',
      icon: 'text-emerald-600 dark:text-emerald-500',
    },
  },
  // Impact colors
  impact: {
    critical: 'bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400',
    high: 'bg-accent-50 dark:bg-accent-900/30 text-accent-700 dark:text-accent-400',
    medium: 'bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400',
    low: 'bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400',
  },
};

// Helper functions for consistent status colors
export const getStatusColor = (status) => {
  const statusLower = status.toLowerCase();
  if (statusLower.includes('completed') || statusLower.includes('approved') || statusLower.includes('closed')) {
    return colors.status.success;
  }
  if (statusLower.includes('review') || statusLower.includes('assessed') || statusLower.includes('planning')) {
    return colors.status.warning;
  }
  if (statusLower.includes('rejected') || statusLower.includes('cancelled') || statusLower.includes('delayed')) {
    return colors.status.error;
  }
  if (statusLower.includes('progress') || statusLower.includes('mitigated')) {
    return colors.status.info;
  }
  return colors.status.neutral;
};

export const getPriorityColor = (priority) => {
  const priorityLower = priority.toLowerCase();
  if (priorityLower === 'critical') return colors.priority.critical;
  if (priorityLower === 'high') return colors.priority.high;
  if (priorityLower === 'medium') return colors.priority.medium;
  return colors.priority.low;
};

export const getImpactColor = (impact) => {
  const impactLower = impact.toLowerCase();
  if (impactLower === 'critical') return colors.impact.critical;
  if (impactLower === 'high') return colors.impact.high;
  if (impactLower === 'medium') return colors.impact.medium;
  return colors.impact.low;
};




================================================
FILE: frontend/src/lib/rules.md
================================================
# Business Rules and Formulas Documentation

This document contains all business rules, formulas, and calculation logic used in the PMIS system. These rules will be used to process real-time data in production.

## Table of Contents
1. [KPI Calculations](#kpi-calculations)
2. [Budget Calculations](#budget-calculations)
3. [Forecast Calculations](#forecast-calculations)
4. [Project Status Rules](#project-status-rules)
5. [Workflow Rules](#workflow-rules)
6. [Permission Rules](#permission-rules)
7. [Validation Rules](#validation-rules)

---

## KPI Calculations

### Schedule Performance Index (SPI)
**Formula:** `SPI = Earned Value / Planned Value`
- **Rule:** SPI > 1 = Ahead of schedule, SPI < 1 = Behind schedule
- **Implementation:** `calculateSPI(earnedValue, plannedValue)`

### Cost Performance Index (CPI)
**Formula:** `CPI = Earned Value / Actual Cost`
- **Rule:** CPI > 1 = Under budget, CPI < 1 = Over budget
- **Implementation:** `calculateCPI(earnedValue, actualCost)`

### Cost Variation
**Formula:** `CV = Budget - Actual Spent`
- **Rule:** Positive = Under budget, Negative = Over budget
- **Implementation:** `calculateCostVariation(budget, spent)`

### Cost Variation Percentage
**Formula:** `CV% = ((Budget - Spent) / Budget) * 100`
- **Implementation:** `calculateCostVariationPercentage(budget, spent)`

### Budget Utilization Rate
**Formula:** `Utilization = (Spent / Budget) * 100`
- **Implementation:** `calculateBudgetUtilization(budget, spent)`

### Project Progress
**Formula:** `Progress = (Completed Tasks / Total Tasks) * 100`
- **Alternative:** `Progress = (Actual Duration / Planned Duration) * 100`
- **Implementation:** `calculateProjectProgress(completedTasks, totalTasks)`

### Risk Score
**Formula:** `Risk Score = Probability Score Ã— Impact Score`
- **Probability Scoring:** Low = 1, Medium = 2, High = 3
- **Impact Scoring:** Low = 1, Medium = 2, High = 3, Critical = 4
- **Implementation:** `calculateRiskScore(probability, impact)`

### Risk Priority
**Rule:**
- Score 1-3 = Low Priority
- Score 4-6 = Medium Priority
- Score 7-9 = High Priority
- Score 10+ = Critical Priority
- **Implementation:** `getRiskPriority(riskScore)`

---

## Budget Calculations

### Remaining Budget
**Formula:** `Remaining = Allocated - Spent - Committed`
- **Implementation:** `calculateRemainingBudget(allocated, spent, committed)`

### Budget Variance
**Formula:** `Variance = Allocated - (Spent + Committed)`
- **Implementation:** `calculateBudgetVariance(allocated, spent, committed)`

### Budget Health Status
**Rule:**
- Utilization > 90% = Critical (Red)
- Utilization > 75% = Warning (Yellow)
- Utilization â‰¤ 75% = Healthy (Green)
- **Implementation:** `getBudgetHealthStatus(utilization)`

### Land Acquisition Status
**Rule:**
- > 90% = Green (Complete)
- > 50% = Yellow (In Progress)
- â‰¤ 50% = Red (Delayed)
- **Implementation:** `getLandAcquisitionStatusColor(percentage)`

### Budget Aggregation by Source
**Rule:** Sum all budgets grouped by source (Central/State/Loan)
- **Implementation:** `aggregateBudgetBySource(budgets)`

### Budget Aggregation by Utilization
**Rule:** Sum all budgets grouped by utilization (Infra/Tech/Land)
- **Implementation:** `aggregateBudgetByUtilization(budgets)`

---

## Forecast Calculations

### Cost Forecast (Trend Analysis)
**Formula:** `Forecast = Actual + (Trend Ã— Remaining Periods)`
- **Trend Calculation:** Average monthly variance over last 3 months
- **Implementation:** `calculateCostForecast(actualCosts, remainingMonths)`

### Forecast Variance Percentage
**Formula:** `Variance% = ((Forecast - Actual) / Actual) * 100`
- **Implementation:** `calculateForecastVariance(forecast, actual)`

---

## Project Status Rules

### Project Status Determination
**Rule:**
- Progress = 100% â†’ Completed
- Progress < 10% â†’ Planning
- Budget Utilization > 100% â†’ On Hold
- Progress > 0% and < 100% â†’ In Progress
- **Implementation:** `determineProjectStatus(progress, budgetUtilization)`

### Project Health Score
**Formula:** `Health = (Progress Score + Budget Score + Risk Score) / 3`
- Each score is normalized to 0-100
- **Implementation:** `calculateProjectHealthScore(progress, budgetUtilization, riskCount, totalRisks)`

---

## Workflow Rules

### Next Workflow Step
**Rule:** Move to next step when current step is approved
- **Implementation:** `getNextWorkflowStep(currentStep, totalSteps)`

### Workflow Step Requirement
**Rule:** Step is required if marked as required in workflow definition
- **Implementation:** `isWorkflowStepRequired(stepRequired)`

### Workflow Status Determination
**Rule:**
- All steps approved â†’ Approved
- Any step rejected â†’ Rejected
- Current step pending â†’ In Progress
- No steps started â†’ Pending
- **Implementation:** `determineWorkflowStatus(currentStep, totalSteps, hasRejection)`

---

## Permission Rules

### Project Creation Permission
**Rule:** Only Admin (SPV_Official) and Manager (PMNC_Team) roles can create projects
- **Implementation:** `canCreateProject(userRole)`

### Document Approval Permission
**Rule:** Admin and Manager roles can approve, Contributors can only upload
- **Implementation:** `canApproveDocuments(userRole)`

### Document Deletion Permission
**Rule:** Only Admin role can delete documents
- **Implementation:** `canDeleteDocuments(userRole)`

---

## Validation Rules

### Budget Allocation Validation
**Rule:** Allocated amount must be positive
- **Implementation:** `validateBudgetAllocation(amount)`

### Project Dates Validation
**Rule:** End date must be after start date
- **Implementation:** `validateProjectDates(startDate, endDate)`

### Reimbursement Amount Validation
**Rule:** Amount must be positive and within reasonable limits (< 1 Cr)
- **Implementation:** `validateReimbursementAmount(amount)`

---

## Data Filtering Rules

### Project Status Filter
**Rule:** Return projects matching the status filter
- **Implementation:** `filterProjectsByStatus(projects, status)`

### Document Project Hierarchy Filter
**Rule:** Documents must belong to a project (no orphaned files)
- **Implementation:** `filterDocumentsByProject(documents, projectId)`

### Risk Filter
**Rule:** Return risks matching both project and status filters
- **Implementation:** `filterRisks(risks, projectId, status)`

---

## Usage in Production

When transitioning to real-time data processing:

1. **Replace Mock Data Calls:** Update data fetching to use APIs instead of mock data
2. **Keep Calculation Functions:** All calculation functions remain the same
3. **Update Data Sources:** Change input parameters from mock data to API responses
4. **Add Caching:** Implement caching for frequently calculated values
5. **Add Real-time Updates:** Use WebSockets or polling for live data updates

Example:
```typescript
// Current (Mock)
const budget = mockBudgets.find(b => b.projectId === projectId);
const utilization = calculateBudgetUtilization(budget.allocated, budget.spent);

// Production (Real-time)
const budget = await fetchBudgetFromAPI(projectId);
const utilization = calculateBudgetUtilization(budget.allocated, budget.spent);
// Same calculation function, different data source!
```




================================================
FILE: frontend/src/lib/translationService.js
================================================
/**
 * Translation Service for dynamic user input translation
 * Uses MyMemory Translation API (free, no API key required for basic usage)
 * Falls back to mock dictionary for common PMIS terms
 */

// Mock dictionary for common PMIS terminology
const mockDictionary = {
  en: {
    'project': 'project',
    'infrastructure': 'infrastructure',
    'management': 'management',
    'construction': 'construction',
    'development': 'development',
    'planning': 'planning',
    'budget': 'budget',
    'schedule': 'schedule',
    'risk': 'risk',
    'document': 'document',
    'approval': 'approval',
    'contractor': 'contractor',
    'consultant': 'consultant',
    'government': 'government',
    'department': 'department',
  },
  hi: {
    'project': 'à¤ªà¤°à¤¿à¤¯à¥‹à¤œà¤¨à¤¾',
    'infrastructure': 'à¤¬à¥à¤¨à¤¿à¤¯à¤¾à¤¦à¥€ à¤¢à¤¾à¤‚à¤šà¤¾',
    'management': 'à¤ªà¥à¤°à¤¬à¤‚à¤§à¤¨',
    'construction': 'à¤¨à¤¿à¤°à¥à¤®à¤¾à¤£',
    'development': 'à¤µà¤¿à¤•à¤¾à¤¸',
    'planning': 'à¤¯à¥‹à¤œà¤¨à¤¾',
    'budget': 'à¤¬à¤œà¤Ÿ',
    'schedule': 'à¤…à¤¨à¥à¤¸à¥‚à¤šà¥€',
    'risk': 'à¤œà¥‹à¤–à¤¿à¤®',
    'document': 'à¤¦à¤¸à¥à¤¤à¤¾à¤µà¥‡à¤œà¤¼',
    'approval': 'à¤…à¤¨à¥à¤®à¥‹à¤¦à¤¨',
    'contractor': 'à¤ à¥‡à¤•à¥‡à¤¦à¤¾à¤°',
    'consultant': 'à¤¸à¤²à¤¾à¤¹à¤•à¤¾à¤°',
    'government': 'à¤¸à¤°à¤•à¤¾à¤°',
    'department': 'à¤µà¤¿à¤­à¤¾à¤—',
  },
  te: {
    'project': 'à°ªà±à°°à°¾à°œà±†à°•à±à°Ÿà±',
    'infrastructure': 'à°®à±Œà°²à°¿à°• à°¸à°¦à±à°ªà°¾à°¯à°¾à°²à±',
    'management': 'à°¨à°¿à°°à±à°µà°¹à°£',
    'construction': 'à°¨à°¿à°°à±à°®à°¾à°£à°‚',
    'development': 'à°…à°­à°¿à°µà±ƒà°¦à±à°§à°¿',
    'planning': 'à°ªà±à°°à°£à°¾à°³à°¿à°•',
    'budget': 'à°¬à°¡à±à°œà±†à°Ÿà±',
    'schedule': 'à°·à±†à°¡à±à°¯à±‚à°²à±',
    'risk': 'à°°à°¿à°¸à±à°•à±',
    'document': 'à°ªà°¤à±à°°à°‚',
    'approval': 'à°…à°¨à±à°®à±‹à°¦à°¨',
    'contractor': 'à°•à°¾à°‚à°Ÿà±à°°à°¾à°•à±à°Ÿà°°à±',
    'consultant': 'à°•à°¨à±à°¸à°²à±à°Ÿà±†à°‚à°Ÿà±',
    'government': 'à°ªà±à°°à°­à±à°¤à±à°µà°‚',
    'department': 'à°¶à°¾à°–',
  },
};

/**
 * Translate text using MyMemory API (free, no API key required)
 * Falls back to mock dictionary if API fails
 */
export async function translateText(text, targetLang, sourceLang = 'en') {
  if (!text.trim()) {
    return {
      translatedText: '',
      sourceLanguage: sourceLang,
      targetLanguage: targetLang,
    };
  }

  // If same language, return original
  if (sourceLang === targetLang) {
    return {
      translatedText: text,
      sourceLanguage: sourceLang,
      targetLanguage: targetLang,
    };
  }

  // Try MyMemory API first (free, no API key needed for basic usage)
  try {
    const langPair = `${sourceLang}|${targetLang}`;
    const response = await fetch(
      `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${langPair}`
    );

    if (response.ok) {
      const data = await response.json();
      if (data.responseStatus === 200 && data.responseData?.translatedText) {
        return {
          translatedText: data.responseData.translatedText,
          sourceLanguage: sourceLang,
          targetLanguage: targetLang,
        };
      }
    }
  } catch (error) {
    console.warn('MyMemory API failed, falling back to mock dictionary:', error);
  }

  // Fallback to mock dictionary for common terms
  const translatedText = translateWithDictionary(text, sourceLang, targetLang);
  return {
    translatedText,
    sourceLanguage: sourceLang,
    targetLanguage: targetLang,
  };
}

/**
 * Simple dictionary-based translation for common PMIS terms
 */
function translateWithDictionary(text, sourceLang, targetLang) {
  const sourceDict = mockDictionary[sourceLang] || {};
  const targetDict = mockDictionary[targetLang] || {};

  // Simple word-by-word replacement for dictionary terms
  let translated = text;
  const words = text.toLowerCase().split(/\s+/);

  words.forEach((word) => {
    // Remove punctuation for matching
    const cleanWord = word.replace(/[.,!?;:]/g, '');
    
    // Find the key in source dictionary
    const sourceKey = Object.keys(sourceDict).find(
      (key) => sourceDict[key].toLowerCase() === cleanWord
    );

    if (sourceKey && targetDict[sourceKey]) {
      // Replace the word (case-insensitive)
      const regex = new RegExp(`\\b${word}\\b`, 'gi');
      translated = translated.replace(regex, targetDict[sourceKey]);
    }
  });

  // If no translation found, return original with a note
  if (translated === text && text.length > 0) {
    return `${text} [Translation: Use professional translation service for accurate results]`;
  }

  return translated;
}




================================================
FILE: frontend/src/lib/utils.js
================================================
import { clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs) {
  return twMerge(clsx(inputs));
}




================================================
FILE: frontend/src/mock/index.js
================================================
// Mock data loader
import projectsData from './data/projects.json';
import kpisData from './data/kpis.json';

import tasksData from './data/tasks.json';
import budgetsData from './data/budgets.json';
import costForecastsData from './data/costForecasts.json';
import risksData from './data/risks.json';
import notificationsData from './data/notifications.json';
import gisFeaturesData from './data/gisFeatures.json';
import usersData from './data/users.json';
import contractorsData from './data/contractors.json';

// Export all data
export const projects = projectsData;
export const kpis = kpisData;

export const tasks = tasksData;
export const budgets = budgetsData;
export const costForecasts = costForecastsData;
export const risks = risksData;
export const notifications = notificationsData;
export const gisFeatures = gisFeaturesData;
export const users = usersData;
export const contractors = contractorsData;

// Role permissions configuration
export const rolePermissions = {
  SPV_Official: {
    role: 'SPV_Official',
    accessLevel: 'Admin',
    permissions: [
      'dashboard:view',
      'dashboard:edit',

      'scheduling:view',
      'scheduling:edit',
      'cost:view',
      'cost:edit',
      'risk:view',
      'risk:edit',
      'gis:view',
      'bim:view',
      'users:manage',
    ],
    dashboardView: 'Executive summary, financial oversight, master controls',
  },
  PMNC_Team: {
    role: 'PMNC_Team',
    accessLevel: 'Manager',
    permissions: [
      'dashboard:view',
      'dashboard:edit',

      'scheduling:view',
      'scheduling:edit',
      'cost:view',
      'cost:edit',
      'risk:view',
      'risk:edit',
      'gis:view',
      'bim:view',
    ],
    dashboardView: 'Detailed project management metrics, risk alerts, project timeline deviations',
  },
  EPC_Contractor: {
    role: 'EPC_Contractor',
    accessLevel: 'Contributor',
    permissions: [
      'dashboard:view',

      'scheduling:view',
      'scheduling:edit',
      'cost:view',
      'cost:input',
      'gis:view',
    ],
    dashboardView: 'Task lists, upload portals, specific schedule segments',
  },
  Consultant_Design: {
    role: 'Consultant_Design',
    accessLevel: 'Limited',
    permissions: ['bim:view'],
    dashboardView: 'Design repository, model viewer',
  },
  Govt_Department: {
    role: 'Govt_Department',
    accessLevel: 'Read_Only',
    permissions: ['dashboard:view', 'gis:view'],
    dashboardView: 'High-level status reports, completion percentages',
  },
  NICDC_HQ: {
    role: 'NICDC_HQ',
    accessLevel: 'Read_Only_High_Level',
    permissions: ['dashboard:view', 'gis:view'],
    dashboardView: 'National level integration view, aggregated KPIs',
  },
};

// Helper functions to filter data by user role
export const getAccessibleModules = (role) => {
  const permissions = rolePermissions[role].permissions;
  const modules = new Set();

  if (permissions.some((p) => p.startsWith('dashboard'))) modules.add('dashboard');

  if (permissions.some((p) => p.startsWith('scheduling'))) modules.add('scheduling');
  if (permissions.some((p) => p.startsWith('cost'))) modules.add('cost');
  if (permissions.some((p) => p.startsWith('risk'))) modules.add('risk');
  if (permissions.some((p) => p.startsWith('gis'))) modules.add('gis');
  if (permissions.some((p) => p.startsWith('bim'))) modules.add('bim');

  return Array.from(modules);
};

export const hasPermission = (role, permission) => {
  return rolePermissions[role].permissions.includes(permission);
};




================================================
FILE: frontend/src/mock/data/budgets.json
================================================
[]


================================================
FILE: frontend/src/mock/data/contractors.json
================================================
[]


================================================
FILE: frontend/src/mock/data/costForecasts.json
================================================
[]


================================================
FILE: frontend/src/mock/data/gisFeatures.json
================================================
[]


================================================
FILE: frontend/src/mock/data/kpis.json
================================================
[]


================================================
FILE: frontend/src/mock/data/notifications.json
================================================
[]


================================================
FILE: frontend/src/mock/data/projects.json
================================================
[]


================================================
FILE: frontend/src/mock/data/risks.json
================================================
[]


================================================
FILE: frontend/src/mock/data/tasks.json
================================================
[]


================================================
FILE: frontend/src/mock/data/users.json
================================================
[]


================================================
FILE: frontend/src/pages/AcceptInvite.jsx
================================================
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Link, useNavigate, useParams } from 'react-router-dom';
import {
    Shield, Lock, Eye, EyeOff, CheckCircle2,
    AlertCircle, Loader2, ArrowLeft
} from 'lucide-react';
import { toast } from 'sonner';
import api from '@/api/client';

const AcceptInvite = () => {
    const { token } = useParams();
    const navigate = useNavigate();
    const [isLoading, setIsLoading] = useState(true);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [isSuccess, setIsSuccess] = useState(false);
    const [inviteInfo, setInviteInfo] = useState(null);
    const [error, setError] = useState(null);

    const [showPassword, setShowPassword] = useState(false);
    const [showConfirmPassword, setShowConfirmPassword] = useState(false);
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [errors, setErrors] = useState({});

    useEffect(() => {
        validateToken();
    }, [token]);

    const validateToken = async () => {
        setIsLoading(true);
        try {
            const response = await api.get(`/users/accept-invite/?token=${token}`);
            setInviteInfo(response.data);
        } catch (err) {
            console.error('Token validation failed:', err);
            setError(err.response?.data?.error || 'Invalid or expired invite link');
        } finally {
            setIsLoading(false);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        const newErrors = {};
        if (!password) newErrors.password = 'Password is required';
        else if (password.length < 8) newErrors.password = 'Password must be at least 8 characters';
        if (password !== confirmPassword) newErrors.confirmPassword = 'Passwords do not match';

        if (Object.keys(newErrors).length > 0) {
            setErrors(newErrors);
            return;
        }

        setIsSubmitting(true);
        try {
            await api.post('/users/accept-invite/', {
                token,
                password,
                confirm_password: confirmPassword
            });
            setIsSuccess(true);
            toast.success('Account activated successfully!');
        } catch (err) {
            console.error('Accept invite failed:', err);
            if (err.response?.data) {
                // Show specific validation errors
                const errors = err.response.data;
                setErrors(errors);

                // Show specific error message
                if (errors.password) {
                    toast.error(errors.password[0] || errors.password);
                } else if (errors.token) {
                    toast.error(errors.token[0] || errors.token);
                } else if (errors.confirm_password) {
                    toast.error(errors.confirm_password[0] || errors.confirm_password);
                } else {
                    toast.error('Failed to activate account. Please check your password and try again.');
                }
            } else {
                toast.error('Failed to activate account. Please try again.');
            }
        } finally {
            setIsSubmitting(false);
        }
    };

    if (isLoading) {
        return (
            <div className="min-h-screen bg-app-base flex items-center justify-center">
                <div className="text-center text-app-text">
                    <Loader2 className="w-10 h-10 animate-spin mx-auto mb-4" />
                    <p>Validating invite link...</p>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="min-h-screen bg-app-base flex items-center justify-center p-4">
                <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center"
                >
                    <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <AlertCircle className="w-10 h-10 text-red-600" />
                    </div>
                    <h1 className="text-2xl font-bold text-slate-900 mb-3">Invalid Invite Link</h1>
                    <p className="text-slate-600 mb-6">{error}</p>
                    <Link
                        to="/login"
                        className="inline-flex items-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 transition-colors"
                    >
                        <ArrowLeft size={18} /> Back to Login
                    </Link>
                </motion.div>
            </div>
        );
    }

    if (isSuccess) {
        return (
            <div className="min-h-screen bg-app-base flex items-center justify-center p-4">
                <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center"
                >
                    <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <CheckCircle2 className="w-10 h-10 text-green-600" />
                    </div>
                    <h1 className="text-2xl font-bold text-slate-900 mb-3">Account Activated!</h1>
                    <p className="text-slate-600 mb-6">
                        Your account has been successfully activated. You can now log in with your email and password.
                    </p>
                    <Link
                        to="/login"
                        className="inline-flex items-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 transition-colors"
                    >
                        Go to Login
                    </Link>
                </motion.div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-app-base flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                className="bg-white rounded-3xl shadow-xl w-full max-w-md overflow-hidden"
                style={{ boxShadow: '0 0 60px rgba(255, 255, 255, 0.15)' }}
            >
                {/* Header */}
                <div className="bg-gradient-to-r from-primary-600 to-primary-700 p-6 text-white text-center">
                    <div className="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <Shield className="w-8 h-8 text-white" />
                    </div>
                    <h1 className="text-xl font-bold text-white">Complete Your Registration</h1>
                    <p className="text-white text-sm mt-2 opacity-90">PMIS - Zaheerabad Industrial Area</p>
                </div>

                {/* User Info */}
                <div className="p-6 bg-primary-50 border-b border-primary-100">
                    <div className="text-center">
                        <p className="text-slate-600 text-sm">You've been invited as</p>
                        <p className="text-lg font-semibold text-slate-900 mt-1">
                            {inviteInfo?.first_name} {inviteInfo?.last_name}
                        </p>
                        <p className="text-sm text-slate-500 mt-1">{inviteInfo?.email}</p>
                        <div className="mt-2 text-sm text-slate-600">
                            <span className="font-medium">Username:</span> <span className="text-slate-900 font-semibold">{inviteInfo?.username}</span>
                        </div>
                        <span className="inline-block mt-2 px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm font-medium">
                            {inviteInfo?.role}
                        </span>
                    </div>
                </div>

                {/* Password Form */}
                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                    <p className="text-slate-600 text-sm mb-4">
                        Please set a password to activate your account.
                    </p>

                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1.5">
                            Password <span className="text-red-500">*</span>
                        </label>
                        <div className="relative">
                            <Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                            <input
                                type={showPassword ? 'text' : 'password'}
                                value={password}
                                onChange={(e) => {
                                    setPassword(e.target.value);
                                    if (errors.password) setErrors(prev => ({ ...prev, password: '' }));
                                }}
                                placeholder="Enter password (min 8 characters)"
                                className={`w-full px-4 py-2.5 pl-10 pr-10 rounded-xl border transition-all outline-none focus:ring-2 ${errors.password
                                    ? 'border-red-300 focus:border-red-500 focus:ring-red-100'
                                    : 'border-slate-200 focus:border-primary-500 focus:ring-primary-100'
                                    }`}
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                            >
                                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                            </button>
                        </div>
                        {errors.password && (
                            <p className="mt-1 text-sm text-red-500 flex items-center gap-1">
                                <AlertCircle size={14} /> {errors.password}
                            </p>
                        )}
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1.5">
                            Confirm Password <span className="text-red-500">*</span>
                        </label>
                        <div className="relative">
                            <Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                            <input
                                type={showConfirmPassword ? 'text' : 'password'}
                                value={confirmPassword}
                                onChange={(e) => {
                                    setConfirmPassword(e.target.value);
                                    if (errors.confirmPassword) setErrors(prev => ({ ...prev, confirmPassword: '' }));
                                }}
                                placeholder="Confirm password"
                                className={`w-full px-4 py-2.5 pl-10 pr-10 rounded-xl border transition-all outline-none focus:ring-2 ${errors.confirmPassword
                                    ? 'border-red-300 focus:border-red-500 focus:ring-red-100'
                                    : 'border-slate-200 focus:border-primary-500 focus:ring-primary-100'
                                    }`}
                            />
                            <button
                                type="button"
                                onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                                className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                            >
                                {showConfirmPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                            </button>
                        </div>
                        {errors.confirmPassword && (
                            <p className="mt-1 text-sm text-red-500 flex items-center gap-1">
                                <AlertCircle size={14} /> {errors.confirmPassword}
                            </p>
                        )}
                    </div>

                    <button
                        type="submit"
                        disabled={isSubmitting}
                        className="w-full py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 hover:shadow-lg active:scale-[0.98] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                        {isSubmitting ? (
                            <>
                                <Loader2 size={18} className="animate-spin" /> Activating...
                            </>
                        ) : (
                            <>
                                <CheckCircle2 size={18} /> Activate Account
                            </>
                        )}
                    </button>
                </form>
            </motion.div>
        </div>
    );
};

export default AcceptInvite;



================================================
FILE: frontend/src/pages/Approvals.jsx
================================================
/**
 * Approvals Page - Pending document and BOQ approvals dashboard
 * Shows documents and BOQ freeze requests requiring action from the current user
 */
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import {
    Clock, CheckCircle, AlertTriangle, FileText, Lock, Unlock,
    Eye, ChevronRight, RefreshCw, Filter, Loader2, Check, X, FileSpreadsheet
} from 'lucide-react';
import { formatDistanceToNow, format } from 'date-fns';
import { useAuth } from '@/contexts/AuthContext';
import client from '@/api/client';
import financeService from '@/services/financeService';
import { toast } from 'sonner';
import Button from '@/components/ui/Button';
import DocumentDetailModal from '@/components/edms/DocumentDetailModal';
import ThreadDetail from '@/components/communications/ThreadDetail';

const Approvals = () => {
    const { user } = useAuth();
    const navigate = useNavigate();

    // Document Approvals
    const [documents, setDocuments] = useState([]);
    const [loadingDocs, setLoadingDocs] = useState(true);
    const [selectedDocument, setSelectedDocument] = useState(null);
    const [discussDocument, setDiscussDocument] = useState(null);

    // BOQ Approvals
    const [boqRequests, setBoqRequests] = useState([]);
    const [loadingBoq, setLoadingBoq] = useState(true);
    const [selectedBoqRequest, setSelectedBoqRequest] = useState(null);
    const [processingRequest, setProcessingRequest] = useState(null);

    // Filter
    const [filter, setFilter] = useState('all'); // 'all', 'documents', 'boq'

    useEffect(() => {
        fetchPendingApprovals();
        fetchBoqRequests();
    }, []);

    const fetchPendingApprovals = async () => {
        setLoadingDocs(true);
        try {
            const res = await client.get('/edms/approvals/pending/');
            const docs = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setDocuments(docs);
        } catch (error) {
            console.error('Failed to fetch pending approvals:', error);
        } finally {
            setLoadingDocs(false);
        }
    };

    const fetchBoqRequests = async () => {
        setLoadingBoq(true);
        try {
            const requests = await financeService.getPendingApprovals();
            setBoqRequests(requests || []);
        } catch (error) {
            console.error('Failed to fetch BOQ requests:', error);
        } finally {
            setLoadingBoq(false);
        }
    };

    const handleApproveBoq = async (requestId) => {
        setProcessingRequest(requestId);
        try {
            await financeService.approveRequest(requestId);
            toast.success('Request approved successfully!');
            fetchBoqRequests();
            setSelectedBoqRequest(null);
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to approve request');
        } finally {
            setProcessingRequest(null);
        }
    };

    const handleRejectBoq = async (requestId, notes = '') => {
        setProcessingRequest(requestId);
        try {
            await financeService.rejectRequest(requestId, notes || 'Rejected by admin');
            toast.success('Request rejected');
            fetchBoqRequests();
            setSelectedBoqRequest(null);
        } catch (error) {
            toast.error(error.response?.data?.error || 'Failed to reject request');
        } finally {
            setProcessingRequest(null);
        }
    };

    const getStatusConfig = (status) => {
        const configs = {
            UNDER_REVIEW: {
                color: 'bg-amber-100 text-amber-700 border-amber-200',
                icon: Clock,
                label: 'Under Review',
                action: 'Needs PMNC Review'
            },
            REVISION_REQUESTED: {
                color: 'bg-orange-100 text-orange-700 border-orange-200',
                icon: AlertTriangle,
                label: 'Revision Requested',
                action: 'Returned for revision'
            },
            VALIDATED: {
                color: 'bg-blue-100 text-blue-700 border-blue-200',
                icon: CheckCircle,
                label: 'Validated',
                action: 'Needs SPV Approval'
            },
        };
        return configs[status] || configs.UNDER_REVIEW;
    };

    const getBoqRequestConfig = (requestType) => {
        if (requestType === 'BOQ_FREEZE') {
            return {
                color: 'bg-blue-100 text-blue-700',
                icon: Lock,
                label: 'Freeze Request',
                action: 'Requesting to freeze BOQ items as baseline'
            };
        }
        return {
            color: 'bg-amber-100 text-amber-700',
            icon: Unlock,
            label: 'Unfreeze Request',
            action: 'Requesting to unfreeze BOQ items for modification'
        };
    };

    // Filter items
    const filteredDocuments = filter === 'boq' ? [] : documents.filter(doc => {
        if (filter === 'documents') return true;
        return true;
    });

    const filteredBoqRequests = filter === 'documents' ? [] : boqRequests;

    const totalPending = documents.length + boqRequests.length;
    const loading = loadingDocs || loadingBoq;

    // Check if user has any pending approvals based on role
    const canValidate = ['PMNC_Team', 'SPV_Official', 'NICDC_HQ'].includes(user?.role);
    const canApprove = ['SPV_Official', 'NICDC_HQ'].includes(user?.role);

    if (!canValidate && !canApprove) {
        return (
            <div className="min-h-[60vh] flex items-center justify-center">
                <div className="text-center">
                    <div className="w-16 h-16 bg-app-surface rounded-full flex items-center justify-center mx-auto mb-4">
                        <AlertTriangle size={32} className="text-app-muted" />
                    </div>
                    <h2 className="text-xl font-bold text-app-heading">No Approval Permissions</h2>
                    <p className="text-app-muted mt-2">
                        Your role does not have approval permissions.
                    </p>
                </div>
            </div>
        );
    }

    return (
        <div className="p-6 max-w-6xl mx-auto">
            {/* Header */}
            <div className="mb-6">
                <h1 className="text-2xl font-bold text-app-heading flex items-center gap-2">
                    <Clock className="text-amber-600" />
                    Pending Approvals
                </h1>
                <p className="text-sm text-app-muted mt-1">
                    Documents and BOQ requests requiring your action
                </p>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    className="bg-app-card rounded-xl p-4 border border-app-subtle shadow-sm"
                >
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm text-app-muted">Total Pending</p>
                            <p className="text-3xl font-bold text-app-heading">{totalPending}</p>
                        </div>
                        <div className="w-12 h-12 rounded-xl bg-app-surface flex items-center justify-center">
                            <FileText size={24} className="text-app-muted" />
                        </div>
                    </div>
                </motion.div>

                <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.1 }}
                    className="bg-app-card rounded-xl p-4 border border-amber-200 dark:border-amber-900 shadow-sm"
                >
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm text-amber-600">Documents</p>
                            <p className="text-3xl font-bold text-amber-700">{documents.length}</p>
                        </div>
                        <div className="w-12 h-12 rounded-xl bg-amber-100 flex items-center justify-center">
                            <FileText size={24} className="text-amber-600" />
                        </div>
                    </div>
                </motion.div>

                <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.2 }}
                    className="bg-app-card rounded-xl p-4 border border-blue-200 dark:border-blue-900 shadow-sm"
                >
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm text-blue-600">BOQ Requests</p>
                            <p className="text-3xl font-bold text-blue-700">{boqRequests.length}</p>
                        </div>
                        <div className="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center">
                            <FileSpreadsheet size={24} className="text-blue-600" />
                        </div>
                    </div>
                </motion.div>
            </div>

            {/* Filter & Actions */}
            <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                    <Filter size={16} className="text-app-muted" />
                    <select
                        value={filter}
                        onChange={(e) => setFilter(e.target.value)}
                        className="px-3 py-2 bg-app-input border border-app text-app-text rounded-lg text-sm"
                    >
                        <option value="all">All Pending ({totalPending})</option>
                        <option value="documents">Documents Only ({documents.length})</option>
                        <option value="boq">BOQ Requests Only ({boqRequests.length})</option>
                    </select>
                </div>
                <Button variant="outline" onClick={() => { fetchPendingApprovals(); fetchBoqRequests(); }} disabled={loading}>
                    <RefreshCw size={16} className={loading ? 'animate-spin' : ''} />
                </Button>
            </div>

            {/* Content */}
            {loading ? (
                <div className="flex items-center justify-center py-16">
                    <Loader2 size={32} className="animate-spin text-app-muted" />
                </div>
            ) : totalPending === 0 ? (
                <div className="bg-app-card rounded-xl p-8 text-center border border-app-subtle">
                    <div className="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                        <CheckCircle size={32} className="text-green-600" />
                    </div>
                    <h3 className="text-lg font-semibold text-app-heading">All Caught Up!</h3>
                    <p className="text-app-muted mt-1">
                        No items require your approval right now.
                    </p>
                </div>
            ) : (
                <div className="space-y-4">
                    {/* BOQ Requests Section */}
                    {filteredBoqRequests.length > 0 && (
                        <div className="bg-app-card rounded-xl border border-blue-200 dark:border-blue-900 overflow-hidden">
                            <div className="px-4 py-3 bg-blue-50 dark:bg-blue-900/30 border-b border-blue-200 dark:border-blue-800">
                                <h3 className="font-semibold text-blue-800 dark:text-blue-300 flex items-center gap-2">
                                    <FileSpreadsheet size={18} />
                                    BOQ Approval Requests
                                </h3>
                            </div>
                            <div className="divide-y divide-slate-200 dark:divide-neutral-800">
                                {filteredBoqRequests.map((req, index) => {
                                    const config = getBoqRequestConfig(req.request_type);
                                    const RequestIcon = config.icon;

                                    return (
                                        <motion.div
                                            key={req.id}
                                            initial={{ opacity: 0, x: -10 }}
                                            animate={{ opacity: 1, x: 0 }}
                                            transition={{ delay: index * 0.05 }}
                                            className="p-4 hover:bg-app-surface transition-colors"
                                        >
                                            <div className="flex items-center gap-4">
                                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${config.color.split(' ')[0]}`}>
                                                    <RequestIcon size={24} className={config.color.split(' ')[1]} />
                                                </div>

                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2">
                                                        <h3 className="font-semibold text-app-heading truncate">
                                                            {req.title}
                                                        </h3>
                                                        <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${config.color}`}>
                                                            {config.label}
                                                        </span>
                                                    </div>
                                                    <p className="text-sm text-app-muted mt-0.5">
                                                        {req.project_name} â€¢ Requested by {req.requested_by_name} {formatDistanceToNow(new Date(req.created_at), { addSuffix: true })}
                                                    </p>
                                                    <p className="text-xs text-blue-600 mt-1 font-medium">
                                                        {req.entity_ids?.length || 0} items â€¢ {config.action}
                                                    </p>
                                                </div>

                                                <div className="flex items-center gap-2">
                                                    <Button
                                                        variant="outline"
                                                        size="sm"
                                                        onClick={() => handleRejectBoq(req.id)}
                                                        disabled={processingRequest === req.id}
                                                        className="text-red-600 border-red-200 hover:bg-red-50"
                                                    >
                                                        <X size={14} className="mr-1" />
                                                        Reject
                                                    </Button>
                                                    <Button
                                                        size="sm"
                                                        onClick={() => handleApproveBoq(req.id)}
                                                        disabled={processingRequest === req.id}
                                                        className="bg-green-600 hover:bg-green-700"
                                                    >
                                                        {processingRequest === req.id ? (
                                                            <Loader2 size={14} className="animate-spin mr-1" />
                                                        ) : (
                                                            <Check size={14} className="mr-1" />
                                                        )}
                                                        Approve
                                                    </Button>
                                                </div>
                                            </div>
                                        </motion.div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Document Approvals Section */}
                    {filteredDocuments.length > 0 && (
                        <div className="bg-app-card rounded-xl border border-app-subtle overflow-hidden">
                            <div className="px-4 py-3 bg-app-surface border-b border-app-subtle">
                                <h3 className="font-semibold text-app-heading flex items-center gap-2">
                                    <FileText size={18} />
                                    Document Approvals
                                </h3>
                            </div>
                            <div className="divide-y divide-slate-200 dark:divide-neutral-800">
                                {filteredDocuments.map((doc, index) => {
                                    const statusConfig = getStatusConfig(doc.status);
                                    const StatusIcon = statusConfig.icon;

                                    return (
                                        <motion.div
                                            key={doc.id}
                                            initial={{ opacity: 0, x: -10 }}
                                            animate={{ opacity: 1, x: 0 }}
                                            transition={{ delay: index * 0.05 }}
                                            className="p-4 hover:bg-app-surface cursor-pointer transition-colors"
                                            onClick={() => setSelectedDocument(doc)}
                                        >
                                            <div className="flex items-center gap-4">
                                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${statusConfig.color.split(' ')[0]}`}>
                                                    <StatusIcon size={24} className={statusConfig.color.split(' ')[1]} />
                                                </div>

                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2">
                                                        <h3 className="font-semibold text-app-heading truncate">
                                                            {doc.title}
                                                        </h3>
                                                        <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${statusConfig.color}`}>
                                                            {statusConfig.label}
                                                        </span>
                                                    </div>
                                                    <p className="text-sm text-app-muted mt-0.5">
                                                        {doc.document_type?.replace('_', ' ')} â€¢ v{doc.current_version_number || 1} â€¢
                                                        Uploaded by {doc.uploaded_by_name} {formatDistanceToNow(new Date(doc.created_at), { addSuffix: true })}
                                                    </p>
                                                    <p className="text-xs text-amber-600 mt-1 font-medium">
                                                        {statusConfig.action}
                                                    </p>
                                                </div>

                                                <div className="flex items-center gap-2">
                                                    <Button
                                                        variant="outline"
                                                        size="sm"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setSelectedDocument(doc);
                                                        }}
                                                    >
                                                        <Eye size={14} className="mr-1" />
                                                        Review
                                                    </Button>
                                                    <ChevronRight size={20} className="text-app-muted-light" />
                                                </div>
                                            </div>
                                        </motion.div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            )}

            {/* Document Detail Modal */}
            {selectedDocument && (
                <DocumentDetailModal
                    document={selectedDocument}
                    userRole={user?.role}
                    onClose={() => setSelectedDocument(null)}
                    onUpdate={fetchPendingApprovals}
                    onViewWithNoting={(doc) => {
                        navigate(`/edms/view/${doc.id}`);
                    }}
                    onDiscuss={(doc) => {
                        setDiscussDocument(doc);
                        setSelectedDocument(null);
                    }}
                />
            )}

            {/* Thread Detail for Discussions */}
            {discussDocument && (
                <ThreadDetail
                    thread={{
                        id: `doc-${discussDocument.id}`,
                        title: `Discussion: ${discussDocument.title}`,
                        document_id: discussDocument.id
                    }}
                    onClose={() => setDiscussDocument(null)}
                />
            )}
        </div>
    );
};

export default Approvals;



================================================
FILE: frontend/src/pages/BIM.jsx
================================================
import { useEffect, useRef, useState } from 'react';
import { useLanguage } from '@/contexts/LanguageContext';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { Box, RotateCw, Info } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

const BIM = () => {
  const { t } = useLanguage();
  const containerRef = useRef(null);
  const [activeHotspot, setActiveHotspot] = useState(null);

  const hotspots = [
    { id: 'road', x: 50, y: 50, label: 'Road Infrastructure', info: 'Main road section with standard specifications' },
    { id: 'pipe', x: 65, y: 35, label: 'Utility Pipe', info: 'Water supply pipe with 300mm diameter' },
    { id: 'building', x: 30, y: 60, label: 'Building Structure', info: 'Administrative building with 3 floors' },
  ];

  useEffect(() => {
    if (!containerRef.current) return;

    // Use refs to track Three.js objects for proper cleanup
    const threeState = {
      scene: null,
      camera: null,
      renderer: null,
      animationId: null,
      isMounted: true,
      resizeTimeout: null,
      handleResize: null,
    };

    // Initialize Three.js scene
    import('three').then((THREE) => {
      if (!threeState.isMounted || !containerRef.current) return;

      try {
        threeState.scene = new THREE.Scene();
        threeState.scene.background = new THREE.Color(0xf0f0f0);

        threeState.camera = new THREE.PerspectiveCamera(
          75,
          containerRef.current.clientWidth / containerRef.current.clientHeight,
          0.1,
          1000
        );
        threeState.camera.position.set(5, 5, 5);
        threeState.camera.lookAt(0, 0, 0);

        threeState.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
        threeState.renderer.setSize(containerRef.current.clientWidth, containerRef.current.clientHeight);
        threeState.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        containerRef.current.appendChild(threeState.renderer.domElement);

        // Add grid helper
        const gridHelper = new THREE.GridHelper(10, 10);
        threeState.scene.add(gridHelper);

        // Add axes helper
        const axesHelper = new THREE.AxesHelper(5);
        threeState.scene.add(axesHelper);

        // Add some basic geometry to represent infrastructure
        const geometry1 = new THREE.BoxGeometry(2, 0.2, 2);
        const material1 = new THREE.MeshStandardMaterial({ color: 0x888888 });
        const road = new THREE.Mesh(geometry1, material1);
        road.position.set(0, 0, 0);
        threeState.scene.add(road);

        const geometry2 = new THREE.CylinderGeometry(0.3, 0.3, 2, 32);
        const material2 = new THREE.MeshStandardMaterial({ color: 0x4169e1 });
        const pipe = new THREE.Mesh(geometry2, material2);
        pipe.position.set(2, 1, 0);
        threeState.scene.add(pipe);

        const geometry3 = new THREE.BoxGeometry(1, 1, 1);
        const material3 = new THREE.MeshStandardMaterial({ color: 0x228b22 });
        const building = new THREE.Mesh(geometry3, material3);
        building.position.set(-2, 0.5, 0);
        threeState.scene.add(building);

        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        threeState.scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 5);
        threeState.scene.add(directionalLight);

        // Animation loop
        const animate = () => {
          if (!threeState.isMounted) return;
          threeState.animationId = requestAnimationFrame(animate);
          if (threeState.renderer && threeState.scene && threeState.camera) {
            threeState.renderer.render(threeState.scene, threeState.camera);
          }
        };
        animate();

        // Handle resize with debounce
        threeState.handleResize = () => {
          if (!threeState.isMounted || !containerRef.current || !threeState.camera || !threeState.renderer) return;
          if (threeState.resizeTimeout) clearTimeout(threeState.resizeTimeout);
          threeState.resizeTimeout = setTimeout(() => {
            if (!threeState.isMounted || !containerRef.current || !threeState.camera || !threeState.renderer) return;
            threeState.camera.aspect = containerRef.current.clientWidth / containerRef.current.clientHeight;
            threeState.camera.updateProjectionMatrix();
            threeState.renderer.setSize(containerRef.current.clientWidth, containerRef.current.clientHeight);
          }, 100);
        };
        window.addEventListener('resize', threeState.handleResize);
      } catch (error) {
        console.error('Failed to initialize Three.js:', error);
      }
    }).catch((error) => {
      console.error('Failed to load Three.js:', error);
    });

    return () => {
      threeState.isMounted = false;

      if (threeState.handleResize) {
        window.removeEventListener('resize', threeState.handleResize);
      }
      if (threeState.resizeTimeout) {
        clearTimeout(threeState.resizeTimeout);
      }
      if (threeState.animationId !== null) {
        cancelAnimationFrame(threeState.animationId);
      }
      if (threeState.renderer) {
        threeState.renderer.dispose();
        // Safely remove the canvas element
        if (threeState.renderer.domElement && threeState.renderer.domElement.parentNode) {
          threeState.renderer.domElement.parentNode.removeChild(threeState.renderer.domElement);
        }
      }
      // Clean up geometries and materials
      if (threeState.scene) {
        threeState.scene.traverse((object) => {
          if (object.geometry) object.geometry.dispose();
          if (object.material) {
            if (Array.isArray(object.material)) {
              object.material.forEach((mat) => mat.dispose());
            } else {
              object.material.dispose();
            }
          }
        });
      }
    };
  }, []);

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold text-app-heading">{t('common.bim')}</h1>
        <p className="text-app-muted mt-1">{t('bim.subtitle')}</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>{t('bim.modelViewer')}</CardTitle>
          <p className="text-sm text-app-muted mt-1">
            {t('bim.interactiveVisualization')}
          </p>
        </CardHeader>
        <CardContent>
          <div ref={containerRef} className="h-[600px] w-full rounded-lg bg-app-base relative overflow-hidden">
            {/* Interactive Hotspots */}
            {hotspots.map((hotspot) => (
              <motion.button
                key={hotspot.id}
                className="absolute z-10 w-8 h-8 bg-primary-600 rounded-full border-2 border-white shadow-lg hover:bg-primary-700 transition-colors"
                style={{ left: `${hotspot.x}%`, top: `${hotspot.y}%` }}
                onClick={() => setActiveHotspot(activeHotspot === hotspot.id ? null : hotspot.id)}
                whileHover={{ scale: 1.1 }}
                whileTap={{ scale: 0.95 }}
                transition={{ duration: 0.2 }}
              >
                <Info size={16} className="text-white m-auto" />
              </motion.button>
            ))}

            {/* Hotspot Info Popup */}
            <AnimatePresence>
              {activeHotspot && (
                <motion.div
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: 10 }}
                  className="absolute bottom-4 left-4 right-4 z-20 bg-app-card/95 backdrop-blur-xl rounded-xl shadow-glass border border-app-border p-4"
                >
                  {(() => {
                    const hotspot = hotspots.find((h) => h.id === activeHotspot);
                    return hotspot ? (
                      <>
                        <h4 className="font-semibold text-sm mb-1">{hotspot.label}</h4>
                        <p className="text-xs text-app-muted">{hotspot.info}</p>
                      </>
                    ) : null;
                  })()}
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </CardContent>
      </Card>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center gap-3">
              <Box className="text-primary-600" size={32} />
              <div>
                <p className="font-medium text-app-text">{t('bim.infrastructureModels')}</p>
                <p className="text-sm text-app-muted">{t('bim.modelsDescription')}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center gap-3">
              <RotateCw className="text-primary-600" size={32} />
              <div>
                <p className="font-medium text-app-text">{t('bim.interactiveView')}</p>
                <p className="text-sm text-app-muted">{t('bim.rotateZoomExplore')}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center gap-3">
              <Box className="text-primary-600" size={32} />
              <div>
                <p className="font-medium text-app-text">{t('bim.bimIntegration')}</p>
                <p className="text-sm text-app-muted">{t('bim.bimData')}</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

export default BIM;









================================================
FILE: frontend/src/pages/Budgeting.jsx
================================================
import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { Plus, PieChart, ArrowRight, Coins, X } from 'lucide-react';
import Button from '@/components/ui/Button';
import financeService from '@/services/financeService';
import schedulingService from '@/services/schedulingService';
import projectService from '@/services/projectService';
import { toast } from 'sonner';

const Budgeting = () => {
    const [projects, setProjects] = useState([]);
    const [selectedProject, setSelectedProject] = useState(null);
    const [budgets, setBudgets] = useState([]);
    const [funds, setFunds] = useState([]);
    const [milestones, setMilestones] = useState([]);

    const [loading, setLoading] = useState(true);
    const [isModalOpen, setIsModalOpen] = useState(false);

    // Initial Load
    useEffect(() => {
        loadInitData();
    }, []);

    // ESC key handler for modal
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && isModalOpen) {
                setIsModalOpen(false);
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [isModalOpen]);

    const loadInitData = async () => {
        try {
            const [pData, fData] = await Promise.all([
                projectService.getAllProjects(),
                financeService.getFunds()
            ]);
            setProjects(pData);
            setFunds(fData);

            if (pData.length > 0) {
                setSelectedProject(pData[0].id);
                loadProjectData(pData[0].id);
            }
        } catch (error) {
            toast.error("Failed to load initial data");
        }
    };

    const loadProjectData = async (projectId) => {
        setLoading(true);
        try {
            const [bData, tData] = await Promise.all([
                financeService.getBudgets(projectId),
                schedulingService.getTasks(projectId)
            ]);
            setBudgets(bData);
            // Filter only Milestones
            setMilestones(tData.filter(t => t.isMilestone));
        } catch (error) {
            toast.error("Failed to load project budget/schedule");
        } finally {
            setLoading(false);
        }
    };

    const handleProjectChange = (e) => {
        const pid = e.target.value;
        setSelectedProject(pid);
        loadProjectData(pid);
    };

    const handleSave = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            project: selectedProject,
            fund_head: formData.get('fund_head'),
            milestone: formData.get('milestone'),
            cost_category: formData.get('cost_category'),
            amount: formData.get('amount'),
            description: formData.get('description'),
            financial_year: '2025-2026' // dynamic later
        };

        try {
            await financeService.createBudget(data);
            toast.success("Budget Allocated to Milestone");
            setIsModalOpen(false);
            loadProjectData(selectedProject);
        } catch (error) {
            toast.error("Failed to allocate budget");
        }
    };

    return (
        <div className="p-6 space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-app-heading">Budget Allocation</h1>
                    <p className="text-app-muted text-sm">Link Funds to Schedule Milestones (No Money Without Time)</p>
                </div>
                <div className="flex items-center gap-3">
                    <select
                        value={selectedProject || ''}
                        onChange={handleProjectChange}
                        className="px-3 py-2 border border-app bg-app-input text-app-text rounded-lg text-sm"
                    >
                        {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                    </select>
                    <Button onClick={() => setIsModalOpen(true)} className="bg-primary-600 text-white">
                        <Plus size={18} className="mr-2" /> Allocate Budget
                    </Button>
                </div>
            </div>

            {/* Content */}
            <div className="grid grid-cols-1 gap-6">
                <div className="bg-app-card rounded-xl shadow-sm border border-app-subtle overflow-hidden">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-app-surface text-app-muted font-medium border-b border-app-subtle">
                            <tr>
                                <th className="px-6 py-4">Linked Milestone</th>
                                <th className="px-6 py-4">Cost Category</th>
                                <th className="px-6 py-4">Fund Source</th>
                                <th className="px-6 py-4 text-right">Amount Allocated</th>
                                <th className="px-6 py-4">Status</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                            {budgets.map(item => (
                                <tr key={item.id} className="hover:bg-app-surface">
                                    <td className="px-6 py-4 font-medium text-app-heading flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-amber-500"></div>
                                        {item.milestone_name}
                                    </td>
                                    <td className="px-6 py-4 text-app-muted font-mono text-xs uppercase bg-app-surface rounded px-2 w-fit">
                                        {item.cost_category}
                                    </td>
                                    <td className="px-6 py-4 text-app-muted italic">
                                        {item.fund_name || funds.find(f => f.id === item.fund_head)?.name || 'Unknown Fund'}
                                    </td>
                                    <td className="px-6 py-4 text-right font-bold text-app-heading">
                                        {new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(item.amount)}
                                    </td>
                                    <td className="px-6 py-4">
                                        <span className="px-2 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">Active</span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {budgets.length === 0 && !loading && (
                        <div className="p-12 text-center flex flex-col items-center">
                            <div className="bg-app-surface p-4 rounded-full mb-3">
                                <Coins size={32} className="text-app-muted-light" />
                            </div>
                            <h3 className="text-app-heading font-bold mb-1">No Budget Allocated</h3>
                            <p className="text-app-muted text-sm max-w-sm">
                                Create a Milestone in Scheduling first, then allocate funds to it here.
                            </p>
                        </div>
                    )}
                </div>
            </div>

            {/* Modal */}
            {createPortal(
                <AnimatePresence>
                    {isModalOpen && (
                        <>
                            {/* Backdrop */}
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                exit={{ opacity: 0 }}
                                onClick={() => setIsModalOpen(false)}
                                className="fixed inset-0 z-[9999] bg-black/50 dark:bg-black/70 backdrop-blur-sm"
                            />
                            {/* Modal Content */}
                            <motion.div
                                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                                animate={{ opacity: 1, scale: 1, y: 0 }}
                                exit={{ opacity: 0, scale: 0.95, y: 20 }}
                                transition={{ duration: 0.2 }}
                                className="fixed inset-0 z-[9999] flex items-center justify-center p-4 pointer-events-none"
                            >
                                <div className="bg-app-card rounded-xl shadow-2xl border border-app-subtle p-6 w-96 pointer-events-auto">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-lg font-bold text-app-heading">Allocate Budget</h2>
                                        <button
                                            onClick={() => setIsModalOpen(false)}
                                            className="p-1 hover:bg-app-surface rounded-full transition-colors"
                                        >
                                            <X size={18} className="text-app-muted" />
                                        </button>
                                    </div>
                                    <form onSubmit={handleSave} className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-app-text-medium">Cost Category</label>
                                            <select name="cost_category" className="w-full bg-app-input text-app-text border border-app rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
                                                <option value="civil_works">Civil Works</option>
                                                <option value="electrical">Electrical</option>
                                                <option value="plumbing">Plumbing</option>
                                                <option value="consultancy">Consultancy</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-app-text-medium">Select Milestone (Required)</label>
                                            <select name="milestone" required className="w-full border border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20 dark:text-white rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
                                                <option value="">Select a Scheduled Milestone...</option>
                                                {milestones.map(m => (
                                                    <option key={m.id} value={m.id}>{m.name} ({m.progress}%)</option>
                                                ))}
                                            </select>
                                            {milestones.length === 0 && (
                                                <p className="text-[10px] text-red-500 mt-1">No Milestones found. Go to Schedule to create one.</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-app-text-medium">Fund Source</label>
                                            <select name="fund_head" required className="w-full bg-app-input text-app-text border border-app rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none">
                                                <option value="">Select Fund...</option>
                                                {funds.map(f => (
                                                    <option key={f.id} value={f.id}>{f.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-app-text-medium">Amount to Allocate (INR)</label>
                                            <input name="amount" type="number" required className="w-full bg-app-input text-app-text border border-app rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-app-text-medium">Description</label>
                                            <textarea name="description" className="w-full bg-app-input text-app-text border border-app rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none resize-none" rows="2"></textarea>
                                        </div>

                                        <div className="grid grid-cols-2 gap-2 pt-4">
                                            <Button type="button" variant="outline" onClick={() => setIsModalOpen(false)}>Cancel</Button>
                                            <Button type="submit" disabled={milestones.length === 0} className="bg-primary-600 text-white">Allocate</Button>
                                        </div>
                                    </form>
                                </div>
                            </motion.div>
                        </>
                    )}
                </AnimatePresence>,
                document.body
            )}
        </div>
    );
};

export default Budgeting;



================================================
FILE: frontend/src/pages/Communications.jsx
================================================
/**
 * Communications Page - Main container for the Messaging Center
 * Government-grade, formal UI - no informal styling or chat app metaphors
 * 
 * Mobile Responsive Design:
 * - Desktop: Two-column layout (thread list + detail)
 * - Mobile: Single view toggle (list OR detail with back button)
 */
import { useState, useEffect, useCallback } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import client from '@/api/client';
import { toast } from 'sonner';
import { MessageSquare, Filter, Search, AlertTriangle, ArrowLeft, FileText } from 'lucide-react';
import Button from '@/components/ui/Button';
import ThreadList from '@/components/communications/ThreadList';
import ThreadDetail from '@/components/communications/ThreadDetail';
import NewThreadModal from '@/components/communications/NewThreadModal';
import StartChatModal from '@/components/communications/StartChatModal';
import { useParams, useNavigate } from 'react-router-dom';

const Communications = () => {
    const { threadId } = useParams();
    const navigate = useNavigate();
    const { user } = useAuth();
    const [threads, setThreads] = useState([]);
    const [selectedThread, setSelectedThread] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [showNewThread, setShowNewThread] = useState(false);
    const [showStartChat, setShowStartChat] = useState(false);
    const [filters, setFilters] = useState({
        status: '',
        type: '',
        search: ''
    });
    const [stats, setStats] = useState({
        open: 0,
        pending: 0,
        escalated: 0
    });

    // Mobile responsive state
    const [isMobile, setIsMobile] = useState(false);
    const [showMobileFilters, setShowMobileFilters] = useState(false);

    // Track viewport size for responsive behavior
    const checkMobile = useCallback(() => {
        setIsMobile(window.innerWidth < 768);
    }, []);

    useEffect(() => {
        checkMobile();

        let timeoutId;
        const handleResize = () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(checkMobile, 100);
        };

        window.addEventListener('resize', handleResize);
        return () => {
            window.removeEventListener('resize', handleResize);
            clearTimeout(timeoutId);
        };
    }, [checkMobile]);

    // Initial load and URL param handling
    useEffect(() => {
        const loadInitialData = async () => {
            setIsLoading(true);
            try {
                // Fetch all threads first
                const params = new URLSearchParams();
                if (filters.status) params.append('status', filters.status);
                if (filters.type) params.append('type', filters.type);

                const res = await client.get(`/communications/threads/?${params.toString()}`);
                const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
                setThreads(data);

                // Calculate stats
                setStats({
                    open: data.filter(t => t.status === 'OPEN').length,
                    pending: data.filter(t => t.status === 'PENDING_RESPONSE').length,
                    escalated: data.filter(t => t.status === 'ESCALATED').length
                });

                // If threadId is provided in URL, fetch and select it
                if (threadId) {
                    try {
                        const threadRes = await client.get(`/communications/threads/${threadId}/`);
                        setSelectedThread(threadRes.data);
                    } catch (error) {
                        console.error('Failed to load deep-linked thread:', error);
                        toast.error('Thread not found or access denied');
                        navigate('/communications'); // Fallback
                    }
                }
            } catch (error) {
                console.error('Failed to fetch threads:', error);
                toast.error('Failed to load communications');
            } finally {
                setIsLoading(false);
            }
        };

        loadInitialData();
    }, [filters.status, filters.type, threadId]); // Re-run if filters or ID change

    const fetchThreads = async (silent = false) => {
        if (!silent) setIsLoading(true);
        try {
            const params = new URLSearchParams();
            if (filters.status) params.append('status', filters.status);
            if (filters.type) params.append('type', filters.type);

            const res = await client.get(`/communications/threads/?${params.toString()}`);
            const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setThreads(data);

            // Calculate stats
            setStats({
                open: data.filter(t => t.status === 'OPEN').length,
                pending: data.filter(t => t.status === 'PENDING_RESPONSE').length,
                escalated: data.filter(t => t.status === 'ESCALATED').length
            });
        } catch (error) {
            console.error('Failed to fetch threads:', error);
            // Don't toast on silent poll failure to avoid spamming user
            if (!silent) toast.error('Failed to load communications');
        } finally {
            if (!silent) setIsLoading(false);
        }
    };

    // Poll for sidebar updates (new threads, unread counts, sorting)
    useEffect(() => {
        const interval = setInterval(() => {
            fetchThreads(true); // Silent poll
        }, 2000);
        return () => clearInterval(interval);
    }, [filters]); // Re-create interval if filters change

    const handleThreadSelect = async (thread) => {
        try {
            const res = await client.get(`/communications/threads/${thread.id}/`);
            setSelectedThread(res.data);

            // Optimistically mark as read in the local list list momentarily
            // The real sync happens when ThreadDetail triggers onThreadRead
            setThreads(prev => prev.map(t =>
                t.id === thread.id ? { ...t, unread_count: 0 } : t
            ));
        } catch (error) {
            console.error('Failed to load thread:', error);
            toast.error('Failed to load conversation');
        }
    };

    // Mobile back button handler
    const handleMobileBack = () => {
        setSelectedThread(null);
    };

    const handleThreadCreated = (newThread) => {
        setShowNewThread(false);
        fetchThreads();
        setSelectedThread(newThread);
    };

    const handleMessageSent = () => {
        // Refresh the selected thread
        if (selectedThread) {
            handleThreadSelect(selectedThread);
        }
    };

    // Real-time updates: Poll for new messages every 3 seconds
    useEffect(() => {
        if (!selectedThread) return;

        const pollInterval = setInterval(async () => {
            try {
                // Silent fetch to update messages without showing loading state
                const res = await client.get(`/communications/threads/${selectedThread.id}/`);

                // Only update if there are changes (optimization)
                // For now, simpler to just update the state to ensure new messages appear
                setSelectedThread(prev => {
                    // Prevent update if user closed thread in the meantime
                    if (!prev || prev.id !== res.data.id) return prev;

                    // Simple check to avoid unnecessary re-renders if nothing changed
                    // (Deep comparison would be better but this is a basic safe check)
                    if (JSON.stringify(prev.messages) === JSON.stringify(res.data.messages)) {
                        return prev;
                    }
                    return res.data;
                });
            } catch (error) {
                // Silent failure is intended here - don't disrupt user
                // Just log to console for debugging
                console.debug('Background poll failed:', error);
            }
        }, 3000);

        return () => clearInterval(pollInterval);
    }, [selectedThread?.id]); // Re-run only when thread ID changes


    // Permission checks - Allow all authenticated users to initiate threads
    const canInitiateThread = !!user;

    // Determine what to show on mobile
    const showThreadListOnMobile = isMobile && !selectedThread;
    const showThreadDetailOnMobile = isMobile && selectedThread;

    return (
        <div className="h-[calc(100vh-4rem)] flex flex-col">
            {/* Header - Compact */}
            <div className="bg-app-card border-b border-app-subtle px-3 py-2 sm:px-4 sm:py-3">
                {/* Title + Actions Row */}
                <div className="flex items-center justify-between gap-3 mb-2">
                    <div className="flex items-center gap-2 min-w-0 flex-1">
                        {/* Mobile back button when viewing thread detail */}
                        {showThreadDetailOnMobile && (
                            <button
                                onClick={handleMobileBack}
                                className="p-1.5 -ml-1 hover:bg-app-surface rounded-lg transition-colors flex-shrink-0"
                                aria-label="Back to thread list"
                            >
                                <ArrowLeft size={20} className="text-app-muted" />
                            </button>
                        )}
                        <h1 className="text-base sm:text-xl font-bold text-app-heading flex items-center gap-2 truncate">
                            <MessageSquare className="text-primary-600 dark:text-primary-400 hidden sm:block flex-shrink-0" size={22} />
                            <span className="truncate">
                                {showThreadDetailOnMobile && selectedThread
                                    ? selectedThread.subject || 'Conversation'
                                    : 'Communications'
                                }
                            </span>
                        </h1>
                    </div>

                    {/* Action Buttons - On same line as title */}
                    {!showThreadDetailOnMobile && (
                        <div className="flex items-center gap-2 flex-shrink-0">
                            {/* Stats Pills */}
                            <span className="hidden sm:inline-flex px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-xs font-medium">
                                {stats.open} Open
                            </span>
                            {stats.escalated > 0 && (
                                <span className="hidden sm:inline-flex px-2 py-0.5 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full text-xs font-medium items-center gap-1">
                                    <AlertTriangle size={12} /> {stats.escalated}
                                </span>
                            )}
                            {canInitiateThread && (
                                <Button
                                    onClick={() => setShowNewThread(true)}
                                    className="text-xs px-2 py-1.5"
                                    size="sm"
                                >
                                    <FileText size={14} className="sm:mr-1" />
                                    <span className="hidden sm:inline">New</span>
                                </Button>
                            )}
                            <Button
                                onClick={() => setShowStartChat(true)}
                                className="text-xs px-2 py-1.5"
                                size="sm"
                            >
                                <MessageSquare size={14} className="sm:mr-1" />
                                <span className="hidden sm:inline">Chat</span>
                            </Button>
                        </div>
                    )}
                </div>

                {/* Filters Row - Compact */}
                {!showThreadDetailOnMobile && (
                    <div className="flex flex-col sm:flex-row gap-2">
                        {/* Mobile filter toggle */}
                        <button
                            onClick={() => setShowMobileFilters(!showMobileFilters)}
                            className="sm:hidden flex items-center gap-2 text-xs text-app-muted py-1"
                        >
                            <Filter size={14} />
                            {showMobileFilters ? 'Hide Filters' : 'Filters'}
                        </button>

                        {/* Filter controls */}
                        <div className={`flex-col sm:flex-row gap-2 ${showMobileFilters ? 'flex' : 'hidden sm:flex'} flex-1`}>
                            <div className="relative flex-1">
                                <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 text-app-muted" size={16} />
                                <input
                                    type="text"
                                    placeholder="Search..."
                                    className="w-full pl-8 pr-3 py-1.5 border border-app bg-app-input text-app-text rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    value={filters.search}
                                    onChange={(e) => setFilters({ ...filters, search: e.target.value })}
                                />
                            </div>
                            <div className="flex gap-2">
                                <select
                                    className="flex-1 sm:flex-none px-2 py-1.5 border border-app bg-app-input text-app-text rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    value={filters.status}
                                    onChange={(e) => setFilters({ ...filters, status: e.target.value })}
                                >
                                    <option value="">All Status</option>
                                    <option value="OPEN">Open</option>
                                    <option value="PENDING_RESPONSE">Pending</option>
                                    <option value="ESCALATED">Escalated</option>
                                    <option value="CLOSED">Closed</option>
                                </select>
                                <select
                                    className="flex-1 sm:flex-none px-2 py-1.5 border border-app bg-app-input text-app-text rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    value={filters.type}
                                    onChange={(e) => setFilters({ ...filters, type: e.target.value })}
                                >
                                    <option value="">All Types</option>
                                    <option value="DISCUSSION">Discussion</option>
                                    <option value="CLARIFICATION">Clarification</option>
                                    <option value="INTERNAL_NOTE">Internal</option>
                                    <option value="RULING">Ruling</option>
                                </select>
                            </div>
                        </div>
                    </div>
                )}
            </div>

            {/* Main Content - Responsive Layout */}
            <div className="flex-1 flex overflow-hidden min-h-0">
                {/* Desktop: Always show both panels */}
                {/* Mobile: Show one panel at a time */}

                {/* Thread List Panel - 35% width with border */}
                <div
                    className={`
                        ${isMobile
                            ? (showThreadListOnMobile ? 'w-full' : 'hidden')
                            : 'w-[35%] min-w-[280px] max-w-[400px]'
                        }
                        border-r-2 border-slate-200 dark:border-neutral-700 bg-app-surface overflow-y-auto
                    `}
                >
                    <ThreadList
                        threads={threads}
                        selectedThread={selectedThread}
                        onSelect={handleThreadSelect}
                        isLoading={isLoading}
                    />
                </div>

                {/* Thread Detail Panel - 65% width with subtle left shadow */}
                <div
                    className={`
                        ${isMobile
                            ? (showThreadDetailOnMobile ? 'w-full' : 'hidden')
                            : 'flex-1'
                        }
                        bg-app-card overflow-hidden shadow-[-4px_0_6px_-1px_rgba(0,0,0,0.05)] dark:shadow-[-4px_0_6px_-1px_rgba(0,0,0,0.3)]
                    `}
                >
                    {selectedThread ? (
                        <ThreadDetail
                            thread={selectedThread}
                            onMessageSent={handleMessageSent}
                            onClose={handleMobileBack}
                        />
                    ) : (
                        <div className="h-full flex flex-col items-center justify-center text-app-muted p-4">
                            <MessageSquare size={64} className="opacity-30 mb-4" />
                            <p className="text-lg text-center">Select a thread to view</p>
                            <p className="text-sm mt-1 text-center">or create a new communication thread</p>
                        </div>
                    )}
                </div>
            </div>

            {/* New Thread Modal */}
            {showNewThread && (
                <NewThreadModal
                    onClose={() => setShowNewThread(false)}
                    onCreated={handleThreadCreated}
                />
            )}

            {/* Start Chat Modal */}
            {showStartChat && (
                <StartChatModal
                    onClose={() => setShowStartChat(false)}
                    onCreated={handleThreadCreated}
                />
            )}
        </div>
    );
};

export default Communications;



================================================
FILE: frontend/src/pages/ContractorRegistration.jsx
================================================
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Link, useNavigate } from 'react-router-dom';
import {
    Building2, User, Mail, Phone, FileText, MapPin, Landmark,
    ArrowRight, ArrowLeft, CheckCircle2, AlertCircle, Loader2,
    Eye, EyeOff
} from 'lucide-react';
import { toast } from 'sonner';
import api from '@/api/client';
import Button from '@/components/ui/Button';
import SearchableSelect from '@/components/ui/SearchableSelect';
import IFSCInput from '@/components/contractor/IFSCInput';
import LocationSelector from '@/components/masters/LocationSelector';
import { fetchBankList } from '@/services/ifscService';

// InputField with touched state tracking - only shows errors after blur
const InputField = ({ label, name, value, onChange, error, type = 'text', required = false, icon: Icon, placeholder, ...props }) => {
    const [touched, setTouched] = useState(false);

    // Only show error if field has been touched (blurred) or if there's already a value with an error
    const showError = touched && error;

    return (
        <div>
            <label className="block text-sm font-medium text-app-heading mb-1.5">
                {label} {required && <span className="text-red-500">*</span>}
            </label>
            <div className="relative">
                {Icon && <Icon className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" size={18} />}
                <input
                    type={type}
                    name={name}
                    value={value}
                    onChange={(e) => {
                        onChange(e);
                        // Don't clear touched on change - user still needs to fix it
                    }}
                    onBlur={() => setTouched(true)}
                    placeholder={placeholder}
                    className={`w-full px-4 py-2.5 ${Icon ? 'pl-10' : ''} rounded-xl border transition-all outline-none focus:ring-2 bg-app-card text-app-heading disabled:bg-app-hover disabled:text-app-muted ${showError
                        ? 'border-red-400 focus:border-red-500 focus:ring-red-100 dark:border-red-500/50 dark:focus:ring-red-900/30'
                        : 'border-app focus:border-app-focus focus:ring-primary-100 dark:focus:ring-primary-900/30'
                        }`}
                    {...props}
                />
            </div>
            {showError && (
                <p className="mt-1 text-sm text-red-500 flex items-center gap-1">
                    <AlertCircle size={14} /> {error}
                </p>
            )}
        </div>
    );
};

const ContractorRegistration = () => {
    const navigate = useNavigate();
    const [currentStep, setCurrentStep] = useState(1);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [isSuccess, setIsSuccess] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const [showConfirmPassword, setShowConfirmPassword] = useState(false);
    const [bankList, setBankList] = useState([]);
    const [formData, setFormData] = useState({
        email: '', password: '', confirm_password: '',
        first_name: '', last_name: '', phone_number: '',
        company_name: '', pan_number: '', gstin_number: '', eproc_number: '',
        building_number: '', street: '', area: '', zip_code: '', location: {},
        bank_name: '', ifsc_code: '', bank_branch: '', account_number: '', account_type: 'CURRENT'
    });
    const [errors, setErrors] = useState({});

    useEffect(() => {
        const loadBanks = async () => {
            try {
                const banks = await fetchBankList();
                // Ensure we extract just names if it returns objects, or use as is
                setBankList(Array.isArray(banks) ? banks.map(b => typeof b === 'string' ? b : b.bank) : []);
            } catch (e) { console.error(e); }
        };
        loadBanks();
    }, []);

    const steps = [
        { id: 1, title: 'Account' },
        { id: 2, title: 'Company' },
        { id: 3, title: 'Address' },
        { id: 4, title: 'Bank' }
    ];

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
        // Clear error when user starts typing
        if (errors[name]) setErrors(prev => ({ ...prev, [name]: '' }));
    };

    // Special handler for phone number - digits only, max 10
    const handlePhoneChange = (e) => {
        const value = e.target.value.replace(/\D/g, '').slice(0, 10);
        setFormData(prev => ({ ...prev, phone_number: value }));
        if (errors.phone_number) setErrors(prev => ({ ...prev, phone_number: '' }));
    };

    const handleLocationChange = (loc) => {
        setFormData(prev => ({ ...prev, location: loc }));
        if (errors.location) setErrors(prev => ({ ...prev, location: '' }));
    };

    const validateStep = (step) => {
        const newErrors = {};
        if (step === 1) {
            if (!formData.email) newErrors.email = 'Email is required';
            else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) newErrors.email = 'Invalid email format';
            if (!formData.password) newErrors.password = 'Password is required';
            else if (formData.password.length < 6) newErrors.password = 'Minimum 6 characters';
            if (formData.password !== formData.confirm_password) newErrors.confirm_password = 'Passwords do not match';
            if (!formData.first_name) newErrors.first_name = 'First name is required';
            if (!formData.last_name) newErrors.last_name = 'Last name is required';
            if (!formData.phone_number) newErrors.phone_number = 'Phone number is required';
            else if (formData.phone_number.length !== 10) newErrors.phone_number = 'Phone number must be exactly 10 digits';
        }
        if (step === 2) {
            if (!formData.company_name) newErrors.company_name = 'Required';
            if (!formData.pan_number) newErrors.pan_number = 'Required';
            if (!formData.gstin_number) newErrors.gstin_number = 'Required';
            if (!formData.eproc_number) newErrors.eproc_number = 'Required';
        }
        if (step === 3) {
            if (!formData.street) newErrors.street = 'Required';
            if (!formData.zip_code) newErrors.zip_code = 'Required';
            if (!formData.location?.country) newErrors.location = 'Please select a location';
        }
        if (step === 4) {
            if (!formData.bank_name) newErrors.bank_name = 'Required';
            if (!formData.ifsc_code) newErrors.ifsc_code = 'Required';
            if (!formData.account_number) newErrors.account_number = 'Account number is required';
            else if (formData.account_number.length < 9 || formData.account_number.length > 18) {
                newErrors.account_number = 'Account number must be 9-18 digits';
            }
        }
        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleNext = () => {
        if (validateStep(currentStep)) {
            setErrors({}); // Clear errors when moving to new step
            setCurrentStep(prev => prev + 1);
        }
    };

    const handleBack = () => {
        setErrors({}); // Clear errors when going back
        setCurrentStep(prev => prev - 1);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validateStep(4)) return;
        setIsSubmitting(true);
        try {
            // Transform formData to match backend API expectations
            const { location, ...restData } = formData;

            // Backend expects city, state, country as string names, not IDs
            const payload = {
                ...restData,
                city: location?.cityName || location?.districtName || '',
                state: location?.stateName || '',
                country: location?.countryName || 'India',
            };

            await api.post('/users/register-contractor/', payload);
            setIsSuccess(true);
        } catch (err) {
            // Show specific validation errors from backend
            const errorData = err.response?.data;
            if (errorData && typeof errorData === 'object') {
                // Show first error message
                const firstError = Object.values(errorData).flat()[0];
                toast.error(firstError || 'Registration failed');
            } else {
                toast.error('Registration failed. Please check your details.');
            }
        } finally {
            setIsSubmitting(false);
        }
    };

    if (isSuccess) {
        return (
            <div className="min-h-screen bg-app-secondary flex items-center justify-center p-4">
                <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="bg-app-card rounded-3xl shadow-xl p-8 max-w-md w-full text-center border border-app-subtle"
                >
                    <div className="w-20 h-20 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <CheckCircle2 className="w-10 h-10 text-green-600 dark:text-green-400" />
                    </div>
                    <h1 className="text-2xl font-bold text-app-heading mb-3">Registration Submitted!</h1>
                    <p className="text-app mb-6">
                        Your registration is pending approval. You will receive an email once your account has been activated.
                    </p>
                    <Link
                        to="/login"
                        className="inline-flex items-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 transition-colors"
                    >
                        <ArrowLeft size={18} /> Back to Login
                    </Link>
                </motion.div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-app-secondary flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                className="bg-app-card rounded-3xl shadow-xl w-full max-w-2xl overflow-hidden border border-app-subtle"
                style={{ boxShadow: '0 0 60px rgba(0, 0, 0, 0.05)' }}
            >
                {/* Header */}
                <div className="bg-primary-600 p-6 text-white rounded-t-3xl">
                    <div className="flex items-center gap-3 mb-4">
                        <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <Building2 className="w-6 h-6 text-white" />
                        </div>
                        <div>
                            <h1 className="text-xl font-bold text-white">Contractor Registration</h1>
                            <p className="text-white/80 text-sm">PMIS - Zaheerabad Industrial Area</p>
                        </div>
                    </div>

                    {/* Progress Steps */}
                    <div className="flex items-center justify-between mt-6">
                        {steps.map((step, index) => (
                            <div key={step.id} className="flex items-center">
                                <div className="flex items-center gap-2">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${currentStep > step.id ? 'bg-green-500 text-white' :
                                        currentStep === step.id ? 'bg-white text-primary-600' : 'bg-white/30 text-white'
                                        }`}>
                                        {currentStep > step.id ? <CheckCircle2 size={16} /> : step.id}
                                    </div>
                                    <span className={`text-sm font-medium hidden sm:block ${currentStep >= step.id ? 'text-white' : 'text-white/60'
                                        }`}>{step.title}</span>
                                </div>
                                {index < steps.length - 1 && (
                                    <div className={`w-8 sm:w-16 h-0.5 mx-2 ${currentStep > step.id ? 'bg-green-500' : 'bg-white/30'}`} />
                                )}
                            </div>
                        ))}
                    </div>
                </div>

                {/* Form Content */}
                <form onSubmit={handleSubmit} className="p-6">
                    {/* Step 1: Account & Contact */}
                    {currentStep === 1 && (
                        <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} className="space-y-4">
                            <h2 className="text-lg font-semibold text-app-heading mb-4">Account & Contact Information</h2>

                            <InputField label="Email" name="email" type="email" required icon={Mail} placeholder="company@example.com" value={formData.email} onChange={handleChange} error={errors.email} />

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-app-heading mb-1.5">
                                        Password <span className="text-red-500">*</span>
                                    </label>
                                    <div className="relative">
                                        <input
                                            type={showPassword ? 'text' : 'password'}
                                            name="password"
                                            value={formData.password}
                                            onChange={handleChange}
                                            className={`w-full px-4 py-2.5 pr-10 rounded-xl border transition-all outline-none focus:ring-2 bg-app-card text-app-heading ${errors.password ? 'border-red-300 dark:border-red-500/50' : 'border-app focus:border-app-focus focus:ring-primary-100 dark:focus:ring-primary-900/30'
                                                }`}
                                        />
                                        <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-app-muted">
                                            {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                        </button>
                                    </div>
                                    {errors.password && <p className="mt-1 text-sm text-red-500">{errors.password}</p>}
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-app-heading mb-1.5">
                                        Confirm Password <span className="text-red-500">*</span>
                                    </label>
                                    <div className="relative">
                                        <input
                                            type={showConfirmPassword ? 'text' : 'password'}
                                            name="confirm_password"
                                            value={formData.confirm_password}
                                            onChange={handleChange}
                                            className={`w-full px-4 py-2.5 pr-10 rounded-xl border transition-all outline-none focus:ring-2 bg-app-card text-app-heading ${errors.confirm_password ? 'border-red-300 dark:border-red-500/50' : 'border-app focus:border-app-focus focus:ring-primary-100 dark:focus:ring-primary-900/30'
                                                }`}
                                        />
                                        <button type="button" onClick={() => setShowConfirmPassword(!showConfirmPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-app-muted">
                                            {showConfirmPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                        </button>
                                    </div>
                                    {errors.confirm_password && <p className="mt-1 text-sm text-red-500">{errors.confirm_password}</p>}
                                </div>
                            </div>
                            {/* ... Rest of components use InputField which is updated ... */}
                            <div className="grid grid-cols-2 gap-4">
                                <InputField label="First Name" name="first_name" required icon={User} placeholder="John" value={formData.first_name} onChange={handleChange} error={errors.first_name} />
                                <InputField label="Last Name" name="last_name" required placeholder="Doe" value={formData.last_name} onChange={handleChange} error={errors.last_name} />
                            </div>

                            <div className="space-y-1">
                                <InputField label="Phone Number" name="phone_number" required icon={Phone} placeholder="9876543210" value={formData.phone_number} onChange={handlePhoneChange} error={errors.phone_number} maxLength={10} />
                                {formData.first_name && (
                                    <p className="text-sm text-green-600 font-medium px-1">
                                        Username: epc_contractor_{formData.first_name.toLowerCase().replace(/[^a-z0-9]/g, '')}_{formData.last_name ? formData.last_name.toLowerCase().replace(/[^a-z0-9]/g, '').charAt(0) : 'x'}
                                    </p>
                                )}
                            </div>
                        </motion.div>
                    )}

                    {/* Step 2: Company Details */}
                    {currentStep === 2 && (
                        <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} className="space-y-4">
                            <h2 className="text-lg font-semibold text-app-heading mb-4">Company & Legal Details</h2>

                            <InputField label="Company Name" name="company_name" required icon={Building2} placeholder="ABC Infrastructure Pvt. Ltd." value={formData.company_name} onChange={handleChange} error={errors.company_name} />

                            <div className="grid grid-cols-2 gap-4">
                                <InputField label="PAN Number" name="pan_number" required icon={FileText} placeholder="ABCDE1234F" value={formData.pan_number} onChange={handleChange} error={errors.pan_number} />
                                <InputField label="GSTIN Number" name="gstin_number" required placeholder="22AAAAA0000A1Z5" value={formData.gstin_number} onChange={handleChange} error={errors.gstin_number} />
                            </div>

                            <InputField label="e-Procurement Number" name="eproc_number" required placeholder="EPROC-2024-XXXX" value={formData.eproc_number} onChange={handleChange} error={errors.eproc_number} />
                        </motion.div>
                    )}

                    {/* Step 3: Address */}
                    {currentStep === 3 && (
                        <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} className="space-y-4">
                            <h2 className="text-lg font-semibold text-app-heading mb-4">Registered Address</h2>

                            <div className="grid grid-cols-2 gap-4">
                                <InputField label="Building/Office No." name="building_number" placeholder="123-A" value={formData.building_number} onChange={handleChange} error={errors.building_number} />
                                <InputField label="Street" name="street" required placeholder="Main Road" value={formData.street} onChange={handleChange} error={errors.street} />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <InputField label="Area/Locality" name="area" placeholder="Industrial Estate" value={formData.area} onChange={handleChange} error={errors.area} />
                                <InputField label="PIN Code" name="zip_code" required placeholder="500001" value={formData.zip_code} onChange={handleChange} error={errors.zip_code} />
                            </div>

                            <LocationSelector
                                value={formData.location}
                                onChange={handleLocationChange}
                                required
                                className="mt-2"
                            />
                            {errors.location && (
                                <p className="mt-1 text-sm text-red-500 flex items-center gap-1">
                                    <AlertCircle size={14} /> {errors.location}
                                </p>
                            )}
                        </motion.div>
                    )}

                    {/* Step 4: Bank Details */}
                    {currentStep === 4 && (
                        <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} className="space-y-4">
                            <h2 className="text-lg font-semibold text-app-heading mb-4">Bank Account Details</h2>
                            <p className="text-sm text-app-muted mb-4">Required for bill payments and financial transactions.</p>

                            <SearchableSelect
                                options={bankList}
                                value={formData.bank_name}
                                onChange={(value) => {
                                    setFormData(prev => ({ ...prev, bank_name: value }));
                                    if (errors.bank_name) setErrors(prev => ({ ...prev, bank_name: '' }));
                                }}
                                label="Bank Name"
                                placeholder="Search bank..."
                                required
                                error={errors.bank_name}
                            />

                            <IFSCInput
                                value={formData.ifsc_code}
                                onChange={(value) => {
                                    setFormData(prev => ({ ...prev, ifsc_code: value }));
                                    if (errors.ifsc_code) setErrors(prev => ({ ...prev, ifsc_code: '' }));
                                }}
                                onBranchDataFetched={(branchData) => {
                                    setFormData(prev => ({
                                        ...prev,
                                        bank_name: branchData.bank_name,
                                        bank_branch: branchData.branch_name
                                    }));
                                }}
                                error={errors.ifsc_code}
                            />

                            <div className="grid grid-cols-2 gap-4">
                                <InputField
                                    label="Branch"
                                    name="bank_branch"
                                    placeholder="Auto-filled from IFSC"
                                    value={formData.bank_branch}
                                    onChange={handleChange}
                                    error={errors.bank_branch}
                                    disabled={formData.bank_branch && formData.ifsc_code}
                                />
                                <InputField
                                    label="Account Number"
                                    name="account_number"
                                    required
                                    placeholder="Enter 9-18 digit account number"
                                    value={formData.account_number}
                                    onChange={handleChange}
                                    error={errors.account_number}
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-app-heading mb-1.5">
                                    Account Type <span className="text-red-500">*</span>
                                </label>
                                <select
                                    name="account_type"
                                    value={formData.account_type}
                                    onChange={handleChange}
                                    className="w-full px-4 py-2.5 rounded-xl border border-app bg-app-card text-app-heading focus:border-app-focus focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900/30 outline-none"
                                >
                                    <option value="CURRENT">Current Account</option>
                                    <option value="SAVINGS">Savings Account</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                        </motion.div>
                    )}

                    {/* Navigation Buttons */}
                    <div className="flex items-center justify-between mt-8 pt-6 border-t border-app-subtle">
                        <div>
                            {currentStep > 1 ? (
                                <Button
                                    type="button"
                                    variant="outline"
                                    onClick={handleBack}
                                >
                                    <ArrowLeft size={18} /> Back
                                </Button>
                            ) : (
                                <Link to="/login">
                                    <Button variant="outline" type="button">
                                        <ArrowLeft size={18} /> Back to Login
                                    </Button>
                                </Link>
                            )}
                        </div>

                        <div>
                            {currentStep < 4 ? (
                                <Button
                                    type="button"
                                    onClick={handleNext}
                                >
                                    Next <ArrowRight size={18} />
                                </Button>
                            ) : (
                                <Button
                                    type="submit"
                                    disabled={isSubmitting}
                                    className="bg-green-600 hover:bg-green-700"
                                >
                                    {isSubmitting ? (
                                        <>
                                            <Loader2 size={18} className="animate-spin" /> Submitting...
                                        </>
                                    ) : (
                                        <>
                                            <CheckCircle2 size={18} /> Submit Registration
                                        </>
                                    )}
                                </Button>
                            )}
                        </div>
                    </div>
                </form>
            </motion.div>
        </div>
    );
};

export default ContractorRegistration;



================================================
FILE: frontend/src/pages/CostManagement.jsx
================================================
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { IndianRupee, PieChart, FileText, ArrowRight } from 'lucide-react';
import { Card, CardContent } from '@/components/ui/Card';
import Button from '@/components/ui/Button';

const CostManagement = () => {
  const navigate = useNavigate();

  const modules = [
    {
      title: '1. Fund Management',
      description: 'Step 1: Record Inflows (Grants, Loans, Allocations). You must have funds before you can budget.',
      icon: IndianRupee,
      path: '/cost/funds',
      color: 'bg-emerald-100 text-emerald-600',
      borderColor: 'border-emerald-200'
    },
    {
      title: '2. Budget Allocation',
      description: 'Step 2: Link Funds to Schedule Milestones. Enforces "No Money Without Time".',
      icon: PieChart,
      path: '/cost/budgeting',
      color: 'bg-blue-100 text-blue-600',
      borderColor: 'border-blue-200'
    },
    {
      title: '3. RA Billing',
      description: 'Step 3: Contractors submit bills against verified progress. System checks limits automatically.',
      icon: FileText,
      path: '/cost/billing',
      color: 'bg-amber-100 text-amber-600',
      borderColor: 'border-amber-200'
    }
  ];

  return (
    <div className="p-8 max-w-7xl mx-auto space-y-8">
      <div>
        <h1 className="text-3xl font-bold text-app-heading">Cost Management Workspace</h1>
        <p className="text-app-muted mt-2 text-lg">
          Follow the 3-step Government workflow to ensure financial discipline.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        {modules.map((mod) => (
          <Card
            key={mod.title}
            className={`cursor-pointer hover:shadow-xl transition-all duration-300 border-t-4 ${mod.borderColor}`}
            onClick={() => navigate(mod.path)}
          >
            <CardContent className="p-8 flex flex-col h-full">
              <div className={`w-14 h-14 rounded-2xl flex items-center justify-center mb-6 ${mod.color}`}>
                <mod.icon size={28} />
              </div>
              <h3 className="text-xl font-bold text-app-heading mb-3">{mod.title}</h3>
              <p className="text-app-text leading-relaxed flex-1">
                {mod.description}
              </p>
              <div className="mt-6 flex items-center text-primary-600 font-semibold group">
                Enter Module <ArrowRight size={18} className="ml-2 group-hover:translate-x-1 transition-transform" />
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      <div className="p-6 bg-app-surface rounded-xl border border-app-subtle flex items-center justify-between">
        <div>
          <h4 className="font-bold text-app-heading">Need to update the Schedule?</h4>
          <p className="text-sm text-app-muted">Milestones must be created before budgeting.</p>
        </div>
        <Button variant="outline" onClick={() => navigate('/scheduling')}>
          Go to Scheduling
        </Button>
      </div>
    </div>
  );
};

export default CostManagement;



================================================
FILE: frontend/src/pages/Dashboard.jsx
================================================
import { useState, useEffect } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import projectService from '@/api/services/projectService';
import dashboardService from '@/api/services/dashboardService';
import UnifiedDashboard from '@/components/dashboard/UnifiedDashboard';
import SPVDashboard from '@/components/dashboard/SPVDashboard';
import PMNCDashboard from '@/components/dashboard/PMNCDashboard';
import EPCDashboard from '@/components/dashboard/EPCDashboard';
import ConsultantDashboard from '@/components/dashboard/ConsultantDashboard';
import GovtDashboard from '@/components/dashboard/GovtDashboard';
import NICDCDashboard from '@/components/dashboard/NICDCDashboard';
import { PageLoading } from '@/components/ui/Loading';

const Dashboard = () => {
  const { user } = useAuth();

  // Use the new unified dashboard by default
  // Set to false to enable role-specific dashboards
  const useUnifiedDashboard = true;

  // If no user is logged in (should be handled by ProtectedRoute, but safe check)
  if (!user) return null;

  // New Unified Dashboard for all roles
  if (useUnifiedDashboard) {
    return <UnifiedDashboard />;
  }

  // Legacy role-based dashboards (kept for reference)
  const [projects, setProjects] = useState([]);
  const [dashboardStats, setDashboardStats] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchDashboardData = async () => {
      try {
        const [projectsData, statsData] = await Promise.all([
          projectService.getAllProjects(),
          dashboardService.getStats()
        ]);
        setProjects(projectsData);
        setDashboardStats(statsData);
      } catch (error) {
        console.error('Failed to fetch dashboard data:', error);
        try {
          const projectsData = await projectService.getAllProjects();
          setProjects(projectsData);
        } catch (e) {
          console.error('Failed to fetch projects:', e);
        }
      } finally {
        setLoading(false);
      }
    };
    fetchDashboardData();
  }, []);

  if (loading) {
    return <PageLoading text="Loading Dashboard..." />;
  }

  const kpis = dashboardStats?.kpis || [];
  const risks = [];
  const tasks = [];

  // Role-Based Render Logic
  const renderDashboard = () => {
    switch (user.role) {
      case 'SPV_Official':
        return <SPVDashboard projects={projects} kpis={kpis} risks={risks} stats={dashboardStats} />;
      case 'PMNC_Team':
        return <PMNCDashboard projects={projects} tasks={tasks} risks={risks} stats={dashboardStats} />;
      case 'EPC_Contractor':
        return <EPCDashboard projects={projects} tasks={tasks} stats={dashboardStats} />;
      case 'Consultant_Design':
        return <ConsultantDashboard stats={dashboardStats} />;
      case 'Govt_Department':
        return <GovtDashboard projects={projects} kpis={kpis} stats={dashboardStats} />;
      case 'NICDC_HQ':
        return <NICDCDashboard projects={projects} stats={dashboardStats} />;
      default:
        return (
          <div className="flex flex-col items-center justify-center p-8 text-center">
            <h2 className="text-xl font-bold text-app-heading">Access Denied / Role Unknown</h2>
            <p className="text-app-muted">Please contact the administrator to assign a valid role.</p>
          </div>
        );
    }
  };

  return (
    <div className="min-h-screen">
      {renderDashboard()}
    </div>
  );
};

export default Dashboard;






================================================
FILE: frontend/src/pages/DocumentViewerPage.jsx
================================================
/**
 * DocumentViewerPage - Split-screen document viewer with Noting Sheet
 * 
 * Left Pane: PDF/Image viewer
 * Right Pane: Noting Sheet panel
 */
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    ArrowLeft, Download, Printer, ZoomIn, ZoomOut, RotateCw,
    ChevronLeft, ChevronRight, Maximize2, Minimize2,
    BookOpen, Plus, FileText, AlertCircle, Loader2, X
} from 'lucide-react';
import client from '@/api/client';
import { toast } from 'sonner';
import Button from '@/components/ui/Button';
import NotingPanel from '@/components/edms/NotingPanel';
import AddNoteModal from '@/components/edms/AddNoteModal';
import * as XLSX from 'xlsx';

const DocumentViewerPage = () => {
    const { id } = useParams();
    const navigate = useNavigate();

    const [document, setDocument] = useState(null);
    const [notings, setNotings] = useState([]);
    const [loading, setLoading] = useState(true);
    const [fileUrl, setFileUrl] = useState(null);
    const [fileType, setFileType] = useState('unknown'); // 'pdf', 'image', 'video', 'excel', 'unknown'
    const [excelData, setExcelData] = useState(null); // For excel parsing
    const [showAddNote, setShowAddNote] = useState(false);
    const [panelWidth, setPanelWidth] = useState(35); // Percentage
    const [currentPage, setCurrentPage] = useState(1);
    const [totalPages, setTotalPages] = useState(1);
    const [zoom, setZoom] = useState(100);

    // Get user info for role-based permissions
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const role = user?.role || 'Admin'; // Fallback to Admin for dev if missing

    // Add Admin/SuperUser to allowed roles
    const allowedRoles = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team', 'Admin', 'SuperUser'];
    const rulingRoles = ['SPV_Official', 'NICDC_HQ', 'Admin', 'SuperUser'];

    const canAddNoting = allowedRoles.includes(role);
    const canAddRuling = rulingRoles.includes(role);

    useEffect(() => {
        fetchDocument();
        fetchNotings();
    }, [id]);

    const fetchDocument = async () => {
        try {
            const res = await client.get(`/edms/documents/${id}/`);
            setDocument(res.data);

            if (res.data.current_version) {
                const docVersion = res.data.current_version;
                const mimeType = docVersion.mime_type || '';

                // Determine File Type
                let type = 'unknown';
                if (mimeType.includes('pdf')) type = 'pdf';
                else if (mimeType.match(/image\/(jpeg|png|gif|webp)/)) type = 'image';
                else if (mimeType.match(/video\/(mp4|webm|ogg)/)) type = 'video';
                else if (mimeType.includes('spreadsheet') || mimeType.includes('excel') || mimeType.includes('csv') || docVersion.file_name.endsWith('.xlsx') || docVersion.file_name.endsWith('.xls') || docVersion.file_name.endsWith('.csv')) type = 'excel';

                setFileType(type);

                // Fetch File content
                const downloadRes = await client.get(`/edms/documents/${id}/download/`, {
                    responseType: 'blob'
                });

                if (type === 'excel') {
                    // Parse Excel
                    const arrayBuffer = await downloadRes.data.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer);
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    setExcelData(jsonData);
                    setFileUrl(null); // No URL needed specifically unless we want to download
                } else {
                    // Create URL for media/pdf
                    const url = URL.createObjectURL(downloadRes.data);
                    setFileUrl(url);
                }
            }
        } catch (error) {
            console.error('Failed to fetch document:', error);
            toast.error('Failed to load document');
        } finally {
            setLoading(false);
        }
    };

    const fetchNotings = async () => {
        try {
            const res = await client.get(`/edms/noting-sheets/?document=${id}`);
            setNotings(res.data);
        } catch (error) {
            console.error('Failed to fetch notings:', error);
        }
    };

    const handleDownload = async () => {
        try {
            const res = await client.get(`/edms/documents/${id}/download/`, {
                responseType: 'blob'
            });
            const url = window.URL.createObjectURL(res.data);
            const a = window.document.createElement('a');
            a.href = url;
            a.download = document.current_version?.file_name || 'document';
            a.click();
            window.URL.revokeObjectURL(url);
            toast.success('Download started');
        } catch (error) {
            toast.error('Failed to download');
        }
    };

    const handleExportNotingSheet = async () => {
        try {
            window.open(`/api/edms/noting-sheets/export_pdf/?document=${id}`, '_blank');
            toast.success('Noting sheet export started');
        } catch (error) {
            toast.error('Failed to export noting sheet');
        }
    };

    const handleNoteAdded = () => {
        fetchNotings();
        setShowAddNote(false);
    };

    if (loading) {
        return (
            <div className="min-h-screen bg-app-base flex items-center justify-center">
                <Loader2 size={48} className="animate-spin text-app-text" />
            </div>
        );
    }

    if (!document) {
        return (
            <div className="min-h-screen bg-app-base flex flex-col items-center justify-center text-app-text">
                <AlertCircle size={48} className="mb-4" />
                <h2 className="text-xl font-semibold">Document not found</h2>
                <Button onClick={() => navigate(-1)} className="mt-4">
                    Go Back
                </Button>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-app-base flex flex-col overflow-hidden">
            {/* Header */}
            <header className="px-6 py-4 flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <button
                        onClick={() => navigate(-1)}
                        className="p-2 hover:bg-app-layer-2 rounded-full text-app-muted hover:text-app-text transition-colors"
                    >
                        <ArrowLeft size={24} />
                    </button>
                    <div>
                        <h1 className="text-app-text font-bold text-xl truncate max-w-md">
                            {document.title}
                        </h1>
                        <p className="text-app-muted text-sm">
                            {document.document_number || 'No document number'} â€¢ v{document.current_version?.version_number || 1}
                        </p>
                    </div>
                </div>

                <div className="flex items-center gap-3">
                    <button
                        onClick={handleDownload}
                        className="flex items-center gap-2 px-4 py-2 rounded-full border border-app-border text-app-muted hover:text-app-text hover:bg-app-layer-2 transition-all font-medium text-sm"
                    >
                        <Download size={16} />
                        Download PDF
                    </button>
                    <button
                        onClick={handleExportNotingSheet}
                        className="flex items-center gap-2 px-4 py-2 rounded-full bg-app-layer-2 border border-app-border text-app-muted hover:text-app-text hover:bg-app-layer-3 transition-all font-medium text-sm"
                    >
                        <Printer size={16} />
                        Export Notes
                    </button>
                </div>
            </header>

            {/* Main Content - Floating Splite View */}
            <div className="flex-1 flex overflow-hidden px-4 pb-4 gap-4">
                {/* Left Pane - Document Viewer */}
                <div
                    className="flex flex-col bg-app-card rounded-2xl overflow-hidden border border-app-border shadow-2xl"
                    style={{ width: `${100 - panelWidth}%`, transition: 'width 0.3s ease' }}
                >
                    {/* Viewer Toolbar */}
                    <div className="flex items-center justify-between px-6 py-3 bg-app-layer-2/50 backdrop-blur border-b border-app-border">
                        <div className="flex items-center gap-2 bg-app-base/50 rounded-lg p-1 border border-app-border">
                            <button
                                onClick={() => setZoom(Math.max(25, zoom - 25))}
                                className="p-1.5 hover:bg-app-layer-2 rounded-md text-app-muted hover:text-app-text transition-colors"
                            >
                                <ZoomOut size={16} />
                            </button>
                            <span className="text-app-text text-xs font-mono w-12 text-center">{zoom}%</span>
                            <button
                                onClick={() => setZoom(Math.min(300, zoom + 25))}
                                className="p-1.5 hover:bg-app-layer-2 rounded-md text-app-muted hover:text-app-text transition-colors"
                            >
                                <ZoomIn size={16} />
                            </button>
                        </div>

                        {fileType === 'pdf' && (
                            <div className="flex items-center gap-4 text-app-muted text-sm">
                                <div className="flex items-center gap-2 bg-app-base/50 rounded-lg p-1 border border-app-border">
                                    <button
                                        onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                                        className="p-1 hover:bg-app-layer-2 rounded-md disabled:opacity-30 transition-colors"
                                        disabled={currentPage <= 1}
                                    >
                                        <ChevronLeft size={16} />
                                    </button>
                                    <span className="text-xs font-medium px-2">
                                        Page {currentPage} / {totalPages}
                                    </span>
                                    <button
                                        onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                                        className="p-1 hover:bg-app-layer-2 rounded-md disabled:opacity-30 transition-colors"
                                        disabled={currentPage >= totalPages}
                                    >
                                        <ChevronRight size={16} />
                                    </button>
                                </div>
                            </div>
                        )}

                        <button
                            onClick={() => setPanelWidth(panelWidth > 20 ? 0 : 35)}
                            className="p-2 hover:bg-app-layer-2 rounded-lg text-app-muted hover:text-app-text transition-colors"
                            title={panelWidth > 0 ? 'Maximize Viewer' : 'Show Notes'}
                        >
                            {panelWidth > 0 ? <Maximize2 size={18} /> : <Minimize2 size={18} />}
                        </button>
                    </div>

                    {/* Document Display Content */}
                    <div className="flex-1 overflow-auto p-8 flex items-start justify-center bg-app-base/50">
                        {fileType === 'pdf' && fileUrl ? (
                            <iframe
                                src={fileUrl}
                                className="bg-white shadow-2xl transition-all duration-300"
                                style={{
                                    width: `${zoom}%`,
                                    height: '100%',
                                    aspectRatio: '1/1.414'
                                }}
                                title="Document Viewer"
                            />
                        ) : fileType === 'image' && fileUrl ? (
                            <img
                                src={fileUrl}
                                alt="Document"
                                className="shadow-2xl object-contain transition-all duration-300"
                                style={{
                                    width: `${zoom}%`,
                                    maxWidth: 'none' // Allow zoom to exceed container
                                }}
                            />
                        ) : fileType === 'video' && fileUrl ? (
                            <div
                                style={{ width: `${zoom}%`, maxWidth: '100%' }}
                                className="shadow-2xl bg-black rounded-lg overflow-hidden"
                            >
                                <video controls className="w-full h-auto">
                                    <source src={fileUrl} />
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        ) : fileType === 'excel' && excelData ? (
                            <div
                                className="bg-white shadow-2xl overflow-auto w-full transition-all duration-300"
                                style={{
                                    width: `${zoom}%`,
                                    maxWidth: 'none'
                                }}
                            >
                                <table className="w-full border-collapse text-sm text-app-text">
                                    <tbody>
                                        {excelData.map((row, rowIndex) => (
                                            <tr key={rowIndex} className={rowIndex === 0 ? "bg-app-layer-2 font-bold border-b border-app-border" : "border-b border-app-border hover:bg-app-layer-2"}>
                                                {row.map((cell, cellIndex) => (
                                                    <td key={cellIndex} className="p-2 border-r border-app-border min-w-[100px] whitespace-nowrap">
                                                        {cell}
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full text-app-muted gap-4">
                                <div className="p-6 bg-app-layer-2/50 rounded-2xl flex flex-col items-center">
                                    <FileText size={48} className="mb-4 opacity-50" />
                                    <h3 className="text-lg font-medium text-app-text">
                                        Preview not available
                                    </h3>
                                    <p className="text-sm text-app-muted mb-6 text-center max-w-xs">
                                        This file type ({document?.current_version?.mime_type || 'unknown'}) cannot be previewed directly.
                                    </p>
                                    <button
                                        onClick={handleDownload}
                                        className="flex items-center gap-2 px-6 py-3 rounded-full bg-primary-600 hover:bg-primary-700 text-white font-medium transition-all"
                                    >
                                        <Download size={18} />
                                        Download File
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* Right Pane - Noting Sheet */}
                {panelWidth > 0 && (
                    <motion.div
                        initial={{ x: 50, opacity: 0 }}
                        animate={{ x: 0, opacity: 1 }}
                        exit={{ x: 50, opacity: 0 }}
                        className="bg-app-card rounded-2xl overflow-hidden shadow-2xl flex flex-col border border-app-border"
                        style={{ width: `${panelWidth}%` }}
                    >
                        {/* Panel Header */}
                        <div className="flex items-center justify-between px-6 py-4 border-b border-app-border bg-app-base/50">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-primary-50 rounded-lg text-primary-600">
                                    <BookOpen size={20} />
                                </div>
                                <div>
                                    <h2 className="font-bold text-app-text">Noting Sheet</h2>
                                    <p className="text-xs text-app-muted">
                                        {notings.filter(n => !n.is_draft).length} official notes
                                    </p>
                                </div>
                            </div>
                            {canAddNoting && (
                                <Button size="sm" onClick={() => setShowAddNote(true)} className="rounded-full px-4 shadow-sm">
                                    <Plus size={16} className="mr-1.5" />
                                    Add Note
                                </Button>
                            )}
                        </div>

                        {/* Noting Panel Content */}
                        <div className="flex-1 overflow-y-auto bg-app-base/30">
                            <NotingPanel
                                notings={notings}
                                documentId={id}
                                onRefresh={fetchNotings}
                                canAddNoting={canAddNoting}
                                canAddRuling={canAddRuling}
                            />
                        </div>
                    </motion.div>
                )}
            </div>

            {/* Add Note Modal */}
            <AnimatePresence>
                {showAddNote && (
                    <AddNoteModal
                        documentId={id}
                        document={document}
                        onClose={() => setShowAddNote(false)}
                        onSuccess={handleNoteAdded}
                        canAddRuling={canAddRuling}
                    />
                )}
            </AnimatePresence>
        </div>
    );
};

export default DocumentViewerPage;



================================================
FILE: frontend/src/pages/EDMS.jsx
================================================
/**
 * EDMS Page - Electronic Document Management System
 * Windows-like file explorer with clickable project/folder navigation
 */
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import {
    FileText, Upload, Search, Filter, Grid, List,
    RefreshCw, FolderOpen, Folder, ChevronRight, Loader2,
    Home, ArrowLeft, Plus
} from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import client from '@/api/client';
import { toast } from 'sonner';
import Button from '@/components/ui/Button';
import DocumentList from '@/components/edms/DocumentList';
import DocumentUploadModal from '@/components/edms/DocumentUploadModal';
import AddVersionModal from '@/components/edms/AddVersionModal';
import DocumentDetailModal from '@/components/edms/DocumentDetailModal';
import NewThreadModal from '@/components/communications/NewThreadModal';

const EDMS = () => {
    const { user } = useAuth();
    const navigate = useNavigate();

    // Navigation state
    const [currentView, setCurrentView] = useState('projects'); // 'projects' | 'folders' | 'documents'
    const [projects, setProjects] = useState([]);
    const [currentProject, setCurrentProject] = useState(null);
    const [currentFolder, setCurrentFolder] = useState(null);
    const [folders, setFolders] = useState([]);
    const [documents, setDocuments] = useState([]);
    const [breadcrumbs, setBreadcrumbs] = useState([]);

    // UI state
    const [loading, setLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [projectSearchQuery, setProjectSearchQuery] = useState('');
    const [statusFilter, setStatusFilter] = useState('');
    const [typeFilter, setTypeFilter] = useState('');
    const [viewMode, setViewMode] = useState('grid');

    // Modals
    const [showUploadModal, setShowUploadModal] = useState(false);
    const [showAddVersionModal, setShowAddVersionModal] = useState(false);
    const [selectedDocument, setSelectedDocument] = useState(null);
    const [showDiscussModal, setShowDiscussModal] = useState(false);
    const [discussDocument, setDiscussDocument] = useState(null);
    const [showCreateFolderModal, setShowCreateFolderModal] = useState(false);
    const [newFolderName, setNewFolderName] = useState('');

    // Permissions
    const canUpload = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team', 'EPC_Contractor', 'Consultant_Design'].includes(user?.role);
    const canCreateFolder = ['SPV_Official', 'NICDC_HQ', 'PMNC_Team', 'EPC_Contractor', 'Consultant_Design'].includes(user?.role);

    const documentStatuses = [
        { value: '', label: 'All Status' },
        { value: 'DRAFT', label: 'Draft' },
        { value: 'UNDER_REVIEW', label: 'Under Review' },
        { value: 'REVISION_REQUESTED', label: 'Revision Requested' },
        { value: 'VALIDATED', label: 'Validated' },
        { value: 'APPROVED', label: 'Approved' },
        { value: 'REJECTED', label: 'Rejected' },
    ];

    const documentTypes = [
        { value: '', label: 'All Types' },
        { value: 'DRAWING', label: 'Drawing' },
        { value: 'REPORT', label: 'Report' },
        { value: 'CONTRACT', label: 'Contract' },
        { value: 'CORRESPONDENCE', label: 'Correspondence' },
        { value: 'SPECIFICATION', label: 'Specification' },
        { value: 'INVOICE', label: 'Invoice' },
        { value: 'MEDIA', label: 'Media' },
        { value: 'OTHER', label: 'Other' },
    ];

    useEffect(() => {
        fetchProjects();
    }, []);

    useEffect(() => {
        if (currentProject) {
            fetchFoldersAndDocuments();
        }
    }, [currentProject, currentFolder, statusFilter, typeFilter, searchQuery]);

    const fetchProjects = async () => {
        setLoading(true);
        try {
            const res = await client.get('/projects/');
            const projectList = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setProjects(projectList);
        } catch (error) {
            console.error('Failed to fetch projects:', error);
        } finally {
            setLoading(false);
        }
    };

    const fetchFoldersAndDocuments = async () => {
        if (!currentProject) return;

        setLoading(true);
        try {
            // Fetch folders in current location
            const folderParams = new URLSearchParams();
            folderParams.append('project', currentProject.id);
            if (currentFolder) {
                folderParams.append('parent', currentFolder.id);
            } else {
                folderParams.append('parent', 'null');
            }

            const foldersRes = await client.get(`/edms/folders/?${folderParams.toString()}`);
            const folderList = Array.isArray(foldersRes.data) ? foldersRes.data : (foldersRes.data.results || []);
            setFolders(folderList);

            // Fetch documents in current location
            const docParams = new URLSearchParams();
            docParams.append('project', currentProject.id);
            if (currentFolder) {
                docParams.append('folder', currentFolder.id);
            } else {
                docParams.append('folder', 'null');
            }
            if (statusFilter) docParams.append('status', statusFilter);
            if (typeFilter) docParams.append('type', typeFilter);
            if (searchQuery) docParams.append('search', searchQuery);

            const docsRes = await client.get(`/edms/documents/?${docParams.toString()}`);
            const docsList = Array.isArray(docsRes.data) ? docsRes.data : (docsRes.data.results || []);
            setDocuments(docsList);
        } catch (error) {
            console.error('Failed to fetch folders/documents:', error);
            toast.error('Failed to load content');
        } finally {
            setLoading(false);
        }
    };

    const navigateToProject = (project) => {
        setCurrentProject(project);
        setCurrentFolder(null);
        setCurrentView('folders');
        setBreadcrumbs([{ type: 'project', item: project }]);
    };

    const navigateToFolder = (folder) => {
        setCurrentFolder(folder);
        setBreadcrumbs(prev => [...prev, { type: 'folder', item: folder }]);
    };

    const navigateBack = () => {
        if (breadcrumbs.length === 0) return;

        if (breadcrumbs.length === 1) {
            // Back to projects view
            setCurrentProject(null);
            setCurrentFolder(null);
            setCurrentView('projects');
            setBreadcrumbs([]);
        } else {
            // Go up one folder level
            const newBreadcrumbs = [...breadcrumbs];
            newBreadcrumbs.pop();
            setBreadcrumbs(newBreadcrumbs);

            const lastItem = newBreadcrumbs[newBreadcrumbs.length - 1];
            if (lastItem.type === 'project') {
                setCurrentFolder(null);
            } else {
                setCurrentFolder(lastItem.item);
            }
        }
    };

    const navigateToBreadcrumb = (index) => {
        if (index === -1) {
            // Home clicked
            setCurrentProject(null);
            setCurrentFolder(null);
            setCurrentView('projects');
            setBreadcrumbs([]);
            return;
        }

        const newBreadcrumbs = breadcrumbs.slice(0, index + 1);
        setBreadcrumbs(newBreadcrumbs);

        const targetItem = newBreadcrumbs[index];
        if (targetItem.type === 'project') {
            setCurrentFolder(null);
        } else {
            setCurrentFolder(targetItem.item);
        }
    };

    const handleCreateFolder = async () => {
        if (!newFolderName.trim() || !currentProject) return;

        try {
            await client.post('/edms/folders/', {
                name: newFolderName.trim(),
                project: currentProject.id,
                parent: currentFolder?.id || null
            });
            toast.success('Folder created');
            setShowCreateFolderModal(false);
            setNewFolderName('');
            fetchFoldersAndDocuments();
        } catch (error) {
            toast.error('Failed to create folder');
        }
    };

    const handleDownload = async (doc) => {
        try {
            const res = await client.get(`/edms/documents/${doc.id}/download/`, {
                responseType: 'blob'
            });
            const url = window.URL.createObjectURL(res.data);
            const a = window.document.createElement('a');
            a.href = url;
            a.download = doc.title || 'document';
            a.click();
            window.URL.revokeObjectURL(url);
            toast.success('Download started');
        } catch (error) {
            toast.error('Failed to download');
        }
    };

    const handleDiscuss = (doc) => {
        setDiscussDocument(doc);
        setShowDiscussModal(true);
    };

    const handleThreadCreated = () => {
        setShowDiscussModal(false);
        setDiscussDocument(null);
        toast.success('Discussion thread created');
    };

    // Filter projects by search
    const filteredProjects = projects.filter(p => {
        if (!projectSearchQuery.trim()) return true;
        const query = projectSearchQuery.toLowerCase();
        return (
            (p.name || '').toLowerCase().includes(query) ||
            (p.node_name || '').toLowerCase().includes(query) ||
            (p.category || '').toLowerCase().includes(query)
        );
    });

    // Render project cards (Rich Card Design)
    const renderProjectsView = () => (
        <div className="p-6">
            {/* Project Search Bar */}
            <div className="mb-6 flex items-center gap-4">
                <div className="relative flex-1 max-w-md">
                    <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" />
                    <input
                        type="text"
                        value={projectSearchQuery}
                        onChange={(e) => setProjectSearchQuery(e.target.value)}
                        placeholder="Search projects by name or category..."
                        className="w-full pl-10 pr-4 py-2.5 bg-app-input text-app-text border border-app rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                <span className="text-sm text-app-muted">
                    {filteredProjects.length} project{filteredProjects.length !== 1 ? 's' : ''}
                </span>
            </div>

            {/* Projects Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {filteredProjects.map((project, index) => (
                    <motion.div
                        key={project.id}
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: index * 0.05 }}
                        className="bg-app-card rounded-xl overflow-hidden border border-app-subtle shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group cursor-pointer"
                        onDoubleClick={() => navigateToProject(project)}
                        onClick={() => navigateToProject(project)}
                    >
                        {/* Card Header / Icon Area */}
                        <div className="bg-gradient-to-r from-primary-50 to-blue-50 dark:from-neutral-800 dark:to-neutral-800 p-6 flex justify-center items-center border-b border-app-subtle relative">
                            <div className="absolute top-2 right-2 opacity-50">
                                {/* Optional: Status badge or similar could go here */}
                            </div>
                            <div className="w-20 h-20 rounded-2xl bg-app-surface shadow-sm flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                <FolderOpen size={40} className="text-blue-600 dark:text-blue-400" />
                            </div>
                        </div>

                        <div className="p-5">
                            <h3 className="font-bold text-app-heading text-lg mb-1 line-clamp-2 group-hover:text-blue-700 dark:group-hover:text-blue-400 transition-colors">
                                {project.name}
                            </h3>
                            <p className="text-sm text-app-muted mb-4 line-clamp-1">
                                {project.node_name || 'Project Root'}
                            </p>

                            {/* Footer / Meta */}
                            <div className="flex items-center justify-between text-xs text-app-muted mt-2 pt-3 border-t border-app-subtle">
                                <span className="flex items-center gap-1">
                                    <Folder size={12} />
                                    Project Folder
                                </span>
                                <span className="flex items-center gap-1 bg-app-surface px-2 py-0.5 rounded-full text-app-muted">
                                    Open <ChevronRight size={10} />
                                </span>
                            </div>
                        </div>
                    </motion.div>
                ))}
                {filteredProjects.length === 0 && (
                    <div className="col-span-full text-center py-12 text-app-muted">
                        <FolderOpen size={48} className="mx-auto mb-4 opacity-30" />
                        <p className="text-lg font-medium">No projects found</p>
                        <p className="text-sm">Try adjusting your search</p>
                    </div>
                )}
            </div>
        </div>
    );

    // Render folders and documents in current location
    const renderFoldersAndDocuments = () => (
        <div className="p-6 space-y-8">
            {/* Folders Section - Grid of Cards */}
            {folders.length > 0 && (
                <div className="space-y-3">
                    <h3 className="text-sm font-bold text-app-heading tracking-wide flex items-center gap-2">
                        <Folder size={16} className="text-amber-500" />
                        Folders
                    </h3>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        {folders.map((folder, index) => (
                            <motion.div
                                key={folder.id}
                                initial={{ opacity: 0, scale: 0.95 }}
                                animate={{ opacity: 1, scale: 1 }}
                                transition={{ delay: index * 0.03 }}
                                className="bg-app-card p-4 rounded-xl border border-app-subtle shadow-sm hover:shadow-md hover:border-amber-300 cursor-pointer transition-all group flex flex-col justify-between h-32"
                                onClick={() => navigateToFolder(folder)}
                            >
                                <div className="flex justify-between items-start">
                                    <div className="w-10 h-10 rounded-lg bg-amber-50 dark:bg-amber-900/20 flex items-center justify-center text-amber-500 group-hover:bg-amber-100 dark:group-hover:bg-amber-900/30 transition-colors">
                                        <Folder size={20} fill="currentColor" className="text-amber-500" />
                                    </div>
                                    <div className="opacity-0 group-hover:opacity-100 transition-opacity">
                                        <ChevronRight size={16} className="text-app-muted" />
                                    </div>
                                </div>
                                <div>
                                    <p className="font-semibold text-app-text text-sm line-clamp-1 group-hover:text-amber-700 dark:group-hover:text-amber-400 transition-colors">
                                        {folder.name}
                                    </p>
                                    <p className="text-xs text-app-muted mt-1">
                                        {folder.document_count > 0 ? `${folder.document_count} items` : 'Empty'}
                                    </p>
                                </div>
                            </motion.div>
                        ))}
                    </div>
                </div>
            )}

            {/* Documents Section - Only show if documents exist OR no folders exist */}
            {(documents.length > 0 || folders.length === 0) && (
                <div className="space-y-3">
                    {folders.length > 0 && documents.length > 0 && (
                        <div className="flex items-center gap-2 pt-4 border-t border-app-subtle">
                            <FileText size={16} className="text-primary-500" />
                            <h3 className="text-sm font-bold text-app-heading tracking-wide">
                                Documents
                            </h3>
                        </div>
                    )}
                    <div className="bg-app-card rounded-xl border border-app-subtle shadow-sm overflow-hidden">
                        <DocumentList
                            documents={documents}
                            loading={loading && folders.length === 0}
                            viewMode={viewMode}
                            selectedDocId={selectedDocument?.id}
                            onView={(doc) => setSelectedDocument(doc)}
                            onViewWithNoting={(doc) => navigate(`/edms/view/${doc.id}`)}
                            onDownload={handleDownload}
                            onDiscuss={handleDiscuss}
                        />
                    </div>
                </div>
            )}
        </div>
    );

    return (
        <div className="h-full flex flex-col bg-slate-50/50 dark:bg-neutral-950">
            {/* Header Area with Subtle Gradient */}
            <div className="bg-app-card border-b border-app-subtle shadow-sm z-10">
                <div className="px-6 py-4 bg-gradient-to-r from-blue-50/50 to-indigo-50/30 dark:from-neutral-800/50 dark:to-neutral-800/30">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-4">
                            {/* Back Button */}
                            {currentView !== 'projects' && (
                                <button
                                    onClick={navigateBack}
                                    className="w-8 h-8 flex items-center justify-center bg-app-surface border border-app-subtle rounded-full hover:bg-app-subtle hover:border-app transition-all shadow-sm"
                                >
                                    <ArrowLeft size={16} className="text-app-muted" />
                                </button>
                            )}

                            {/* Title & Icon */}
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-primary-100 rounded-lg text-primary-600">
                                    <FileText size={20} />
                                </div>
                                <div>
                                    <h1 className="text-3xl font-bold text-app-heading leading-tight">
                                        Electronic Document Management System
                                    </h1>
                                    <p className="text-sm text-app-muted mt-1">
                                        {currentProject ? 'Project Documents' : 'Select a Project to browse'}
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Actions Toolbar */}
                        <div className="flex items-center gap-2">
                            <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => currentProject ? fetchFoldersAndDocuments() : fetchProjects()}
                                disabled={loading}
                                className="text-app-muted hover:text-primary-600 hover:bg-app-surface"
                            >
                                <RefreshCw size={16} className={loading ? 'animate-spin' : ''} />
                            </Button>

                            {currentProject && canCreateFolder && (
                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => setShowCreateFolderModal(true)}
                                    className="bg-app-card border-app hover:border-blue-200 dark:hover:border-blue-600 hover:bg-app-surface text-app-text"
                                >
                                    <Plus size={16} className="mr-1" />
                                    New Folder
                                </Button>
                            )}

                            {currentProject && canUpload && (
                                <>
                                    <Button
                                        size="sm"
                                        onClick={() => setShowAddVersionModal(true)}
                                        className="shadow-md shadow-primary-500/20"
                                    >
                                        <RefreshCw size={16} className="mr-1" />
                                        Add Version
                                    </Button>
                                    <Button
                                        size="sm"
                                        onClick={() => setShowUploadModal(true)}
                                        className="shadow-md shadow-primary-500/20"
                                    >
                                        <Upload size={16} className="mr-1" />
                                        Upload
                                    </Button>
                                </>
                            )}
                        </div>
                    </div>

                    {/* Breadcrumbs & Search Row */}
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        {/* Interactive Breadcrumbs */}
                        <div className="flex items-center gap-2 text-sm overflow-x-auto pb-1 no-scrollbar">
                            <button
                                onClick={() => navigateToBreadcrumb(-1)}
                                className={`flex items-center gap-2 px-3 py-1.5 rounded-full transition-all border ${breadcrumbs.length === 0
                                    ? 'bg-slate-800 dark:bg-blue-600 text-white border-slate-800 dark:border-blue-600 shadow-sm'
                                    : 'bg-app-card text-app-muted border-app hover:border-app-subtle hover:bg-app-surface'
                                    }`}
                            >
                                <Home size={14} />
                                <span className={breadcrumbs.length > 0 ? 'hidden md:inline' : 'inline'}>Projects</span>
                            </button>

                            {breadcrumbs.map((crumb, index) => {
                                const isLast = index === breadcrumbs.length - 1;
                                return (
                                    <div key={index} className="flex items-center gap-2 animate-fadeIn">
                                        <ChevronRight size={14} className="text-app-muted" />
                                        <button
                                            onClick={() => navigateToBreadcrumb(index)}
                                            className={`px-3 py-1.5 rounded-full transition-all border whitespace-nowrap max-w-[150px] truncate ${isLast
                                                ? 'bg-slate-800 dark:bg-blue-600 text-white border-slate-800 dark:border-blue-600 shadow-sm'
                                                : 'bg-app-card text-app-muted border-app hover:border-app-subtle hover:bg-app-surface'
                                                }`}
                                        >
                                            {crumb.item.name}
                                        </button>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Search & Filters */}
                        {currentProject && (
                            <div className="flex items-center gap-2 flex-wrap">
                                <div className="relative group">
                                    <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted group-hover:text-blue-500 dark:group-hover:text-blue-400 transition-colors" />
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="Search documents..."
                                        className="pl-9 pr-3 py-1.5 bg-app-input text-app-text border border-app rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-500 w-44 focus:w-60 transition-all shadow-sm"
                                    />
                                </div>
                                <select
                                    value={statusFilter}
                                    onChange={(e) => setStatusFilter(e.target.value)}
                                    className="px-3 py-1.5 bg-app-input text-app-text border border-app rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-500 shadow-sm"
                                >
                                    {documentStatuses.map(s => (
                                        <option key={s.value} value={s.value}>{s.label}</option>
                                    ))}
                                </select>
                                <select
                                    value={typeFilter}
                                    onChange={(e) => setTypeFilter(e.target.value)}
                                    className="px-3 py-1.5 bg-app-input text-app-text border border-app rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-500 shadow-sm"
                                >
                                    {documentTypes.map(t => (
                                        <option key={t.value} value={t.value}>{t.label}</option>
                                    ))}
                                </select>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Main Scrollable Content - Wrapped in white rounded container */}
            <div className="flex-1 overflow-y-auto custom-scrollbar p-6">
                <div className="bg-app-card rounded-2xl shadow-sm border border-app-subtle min-h-full">
                    {loading && (currentView === 'projects' || folders.length === 0) ? (
                        <div className="flex flex-col items-center justify-center py-20 opacity-60">
                            <Loader2 size={40} className="animate-spin text-blue-500 dark:text-blue-400 mb-4" />
                            <p className="text-app-muted font-medium">Loading contents...</p>
                        </div>
                    ) : currentView === 'projects' ? (
                        renderProjectsView()
                    ) : (
                        renderFoldersAndDocuments()
                    )}
                </div>
            </div>

            {/* Create Folder Modal */}
            <AnimatePresence>
                {showCreateFolderModal && (
                    <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
                        <motion.div
                            initial={{ opacity: 0, scale: 0.95, y: 10 }}
                            animate={{ opacity: 1, scale: 1, y: 0 }}
                            exit={{ opacity: 0, scale: 0.95, y: 10 }}
                            className="bg-app-card rounded-2xl p-6 w-full max-w-sm shadow-2xl border border-app-subtle"
                        >
                            <div className="flex items-center gap-3 mb-4">
                                <div className="p-2 bg-amber-100 dark:bg-amber-900/20 rounded-lg text-amber-600">
                                    <Folder size={20} />
                                </div>
                                <h3 className="text-lg font-bold text-app-heading">
                                    New Folder
                                </h3>
                            </div>

                            <input
                                type="text"
                                value={newFolderName}
                                onChange={(e) => setNewFolderName(e.target.value)}
                                placeholder="Enter folder name..."
                                className="w-full px-4 py-2.5 bg-app-input text-app-text border border-app rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-500 transition-all"
                                autoFocus
                                onKeyDown={(e) => e.key === 'Enter' && handleCreateFolder()}
                            />
                            <p className="text-xs text-app-muted mt-2 ml-1">
                                Create in: <span className="font-medium text-app-text">{currentFolder?.name || currentProject?.name || 'Root'}</span>
                            </p>
                            <div className="flex justify-end gap-2 mt-6">
                                <Button
                                    variant="ghost"
                                    size="sm"
                                    onClick={() => {
                                        setShowCreateFolderModal(false);
                                        setNewFolderName('');
                                    }}
                                >
                                    Cancel
                                </Button>
                                <Button size="sm" onClick={handleCreateFolder}>
                                    Create Folder
                                </Button>
                            </div>
                        </motion.div>
                    </div>
                )}
            </AnimatePresence>

            {/* Upload Modal */}
            {showUploadModal && currentProject && (
                <DocumentUploadModal
                    projectId={currentProject.id}
                    currentFolderId={currentFolder?.id}
                    onClose={() => setShowUploadModal(false)}
                    onUploaded={() => {
                        setShowUploadModal(false);
                        fetchFoldersAndDocuments();
                    }}
                />
            )}

            {/* Add Version Modal */}
            {showAddVersionModal && currentProject && (
                <AddVersionModal
                    projectId={currentProject.id}
                    currentFolderId={currentFolder?.id}
                    onClose={() => setShowAddVersionModal(false)}
                    onVersionAdded={() => {
                        setShowAddVersionModal(false);
                        fetchFoldersAndDocuments();
                    }}
                />
            )}

            {/* Document Detail Modal */}
            {selectedDocument && (
                <DocumentDetailModal
                    document={selectedDocument}
                    userRole={user?.role}
                    onClose={() => setSelectedDocument(null)}
                    onUpdate={fetchFoldersAndDocuments}
                    onDiscuss={handleDiscuss}
                    onViewWithNoting={(doc) => navigate(`/edms/view/${doc.id}`)}
                />
            )}

            {/* Discuss Modal */}
            {showDiscussModal && discussDocument && (
                <NewThreadModal
                    onClose={() => {
                        setShowDiscussModal(false);
                        setDiscussDocument(null);
                    }}
                    onCreated={handleThreadCreated}
                    preselectedContext={{
                        type: 'edms.document',
                        id: discussDocument.id,
                        name: discussDocument.title
                    }}
                />
            )}
        </div>
    );
};

export default EDMS;



================================================
FILE: frontend/src/pages/EProcurement.jsx
================================================
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    FileText, Plus, Search, Filter, Calendar, DollarSign,
    Building2, CheckCircle2, Clock, AlertCircle, ChevronRight,
    Gavel, FileSignature, TrendingUp, Loader2
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import Button from '@/components/ui/Button';
import { useLanguage } from '@/contexts/LanguageContext';
import { useAuth } from '@/contexts/AuthContext';
import procurementService from '@/api/services/procurementService';
import projectService from '@/api/services/projectService';
import { EmptyState } from '@/components/ui/EmptyState';
import { toast } from 'sonner';

const EProcurement = () => {
    const { t } = useLanguage();
    const { user } = useAuth();

    const [activeTab, setActiveTab] = useState('tenders');
    const [loading, setLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');

    // Data State
    const [tenders, setTenders] = useState([]);
    const [contracts, setContracts] = useState([]);
    const [summary, setSummary] = useState({ total_contracts: 0, active_contracts: 0, total_value: 0, total_variations: 0 });
    const [projects, setProjects] = useState([]);

    // Fetch data on mount
    useEffect(() => {
        fetchData();
    }, []);

    const fetchData = async () => {
        try {
            setLoading(true);
            const [tendersRes, contractsRes, summaryRes, projectsData] = await Promise.all([
                procurementService.getTenders(),
                procurementService.getContracts(),
                procurementService.getContractsSummary(),
                projectService.getAllProjects()
            ]);
            setTenders(tendersRes.results || tendersRes || []);
            setContracts(contractsRes.results || contractsRes || []);
            setSummary(summaryRes || { total_contracts: 0, active_contracts: 0, total_value: 0, total_variations: 0 });
            setProjects(projectsData || []);
        } catch (error) {
            console.error('Failed to fetch procurement data:', error);
            toast.error('Failed to load procurement data');
        } finally {
            setLoading(false);
        }
    };

    const getStatusBadge = (status) => {
        const statusColors = {
            DRAFT: 'bg-app-surface text-app-muted',
            PUBLISHED: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
            BID_OPEN: 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
            EVALUATION: 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300',
            AWARDED: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
            CANCELLED: 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
            CLOSED: 'bg-app-surface text-app-muted',
            ACTIVE: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
            SIGNED: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
            COMPLETED: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300',
            TERMINATED: 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
        };
        return statusColors[status] || 'bg-app-surface text-app-text';
    };

    const formatCurrency = (amount) => {
        const num = Number(amount) || 0;
        if (num >= 10000000) return `â‚¹${(num / 10000000).toFixed(2)} Cr`;
        if (num >= 100000) return `â‚¹${(num / 100000).toFixed(2)} L`;
        return `â‚¹${num.toLocaleString('en-IN')}`;
    };

    const tabs = [
        { id: 'tenders', label: 'Tenders', icon: Gavel, count: tenders.length },
        { id: 'contracts', label: 'Contracts', icon: FileSignature, count: contracts.length },
    ];

    const filteredTenders = tenders.filter(t =>
        t.title?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        t.tender_no?.toLowerCase().includes(searchQuery.toLowerCase())
    );

    const filteredContracts = contracts.filter(c =>
        c.contract_no?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        c.contractor_name?.toLowerCase().includes(searchQuery.toLowerCase())
    );

    if (loading) {
        return (
            <div className="flex items-center justify-center h-[60vh]">
                <Loader2 className="w-8 h-8 text-primary-600 animate-spin" />
            </div>
        );
    }

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-heading font-bold text-app-heading">e-Procurement</h1>
                    <p className="text-app-muted mt-1">Tendering, Bid Evaluation, Contract Lifecycle & Variation Management</p>
                </div>
                <Button className="flex items-center gap-2 bg-primary-950 text-white hover:bg-primary-900">
                    <Plus size={18} />
                    <span>New Tender</span>
                </Button>
            </div>

            {/* Summary Cards */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {[
                    { label: 'Active Tenders', value: tenders.filter(t => t.status !== 'CLOSED' && t.status !== 'CANCELLED').length, icon: Gavel, color: 'text-blue-600', bg: 'bg-blue-50' },
                    { label: 'Active Contracts', value: summary.active_contracts, icon: FileSignature, color: 'text-green-600', bg: 'bg-green-50' },
                    { label: 'Total Value', value: formatCurrency(summary.total_value), icon: DollarSign, color: 'text-primary-600', bg: 'bg-primary-50' },
                    { label: 'Variations', value: formatCurrency(summary.total_variations), icon: TrendingUp, color: 'text-amber-600', bg: 'bg-amber-50' },
                ].map((stat, idx) => (
                    <motion.div key={idx} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: idx * 0.1 }}>
                        <Card className="p-4 hover:shadow-lg transition-shadow">
                            <div className="flex items-center gap-3">
                                <div className={`p-3 rounded-xl ${stat.bg}`}>
                                    <stat.icon className={stat.color} size={20} />
                                </div>
                                <div>
                                    <p className="text-sm text-app-muted">{stat.label}</p>
                                    <p className="text-xl font-bold text-app-heading">{stat.value}</p>
                                </div>
                            </div>
                        </Card>
                    </motion.div>
                ))}
            </div>

            {/* Tabs */}
            <div className="border-b border-app-subtle">
                <div className="flex gap-6">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex items-center gap-2 py-3 px-1 border-b-2 transition-colors ${activeTab === tab.id
                                ? 'border-primary-600 text-primary-600'
                                : 'border-transparent text-app-muted hover:text-app-text'
                                }`}
                        >
                            <tab.icon size={18} />
                            <span className="font-medium text-app-text">{tab.label}</span>
                            <span className={`ml-1 px-2 py-0.5 rounded-full text-xs ${activeTab === tab.id ? 'bg-primary-100 text-primary-700' : 'bg-app-surface text-app-muted'
                                }`}>
                                {tab.count}
                            </span>
                        </button>
                    ))}
                </div>
            </div>

            {/* Search */}
            <Card className="p-4">
                <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" size={20} />
                    <input
                        type="text"
                        placeholder={`Search ${activeTab}...`}
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-app bg-app-input text-app-text rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                    />
                </div>
            </Card>

            {/* Content */}
            <AnimatePresence mode="wait">
                {activeTab === 'tenders' && (
                    <motion.div
                        key="tenders"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="space-y-4"
                    >
                        {filteredTenders.length > 0 ? (
                            filteredTenders.map((tender, idx) => (
                                <motion.div
                                    key={tender.id}
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    transition={{ delay: idx * 0.05 }}
                                >
                                    <Card className="p-4 hover:shadow-lg transition-all cursor-pointer group">
                                        <div className="flex items-start justify-between">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-3 mb-2">
                                                    <span className="text-sm font-mono text-app-muted">{tender.tender_no}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${getStatusBadge(tender.status)}`}>
                                                        {tender.status_display}
                                                    </span>
                                                </div>
                                                <h3 className="text-lg font-semibold text-app-heading group-hover:text-primary-600 transition-colors">
                                                    {tender.title}
                                                </h3>
                                                <p className="text-sm text-app-muted mt-1">{tender.project_name}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-lg font-bold text-app-heading">{formatCurrency(tender.estimated_value)}</p>
                                                <p className="text-sm text-app-muted mt-1">
                                                    {tender.bids_count || 0} bids
                                                </p>
                                                {tender.submission_deadline && (
                                                    <p className="text-xs text-app-muted mt-2 flex items-center justify-end gap-1">
                                                        <Clock size={12} />
                                                        {new Date(tender.submission_deadline).toLocaleDateString()}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </Card>
                                </motion.div>
                            ))
                        ) : (
                            <EmptyState
                                icon={Gavel}
                                title="No Tenders Found"
                                description="Create your first tender to start the procurement process."
                                actionLabel="Create Tender"
                                onAction={() => toast.info('Tender creation modal coming soon')}
                            />
                        )}
                    </motion.div>
                )}

                {activeTab === 'contracts' && (
                    <motion.div
                        key="contracts"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="space-y-4"
                    >
                        {filteredContracts.length > 0 ? (
                            filteredContracts.map((contract, idx) => (
                                <motion.div
                                    key={contract.id}
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    transition={{ delay: idx * 0.05 }}
                                >
                                    <Card className="p-4 hover:shadow-lg transition-all cursor-pointer group">
                                        <div className="flex items-start justify-between">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-3 mb-2">
                                                    <span className="text-sm font-mono text-app-muted">{contract.contract_no}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${getStatusBadge(contract.status)}`}>
                                                        {contract.status_display}
                                                    </span>
                                                </div>
                                                <h3 className="text-lg font-semibold text-app-heading group-hover:text-primary-600 transition-colors flex items-center gap-2">
                                                    <Building2 size={18} className="text-app-muted" />
                                                    {contract.contractor_name}
                                                </h3>
                                                <p className="text-sm text-app-muted mt-1">{contract.project_name}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-lg font-bold text-app-heading">{formatCurrency(contract.contract_value)}</p>
                                                {contract.variations_count > 0 && (
                                                    <p className="text-sm text-amber-600 mt-1">
                                                        {contract.variations_count} variations
                                                    </p>
                                                )}
                                                <p className="text-xs text-app-muted mt-2">
                                                    {contract.start_date} â†’ {contract.end_date}
                                                </p>
                                            </div>
                                        </div>
                                    </Card>
                                </motion.div>
                            ))
                        ) : (
                            <EmptyState
                                icon={FileSignature}
                                title="No Contracts Found"
                                description="Contracts are created when a tender is awarded."
                            />
                        )}
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    );
};

export default EProcurement;



================================================
FILE: frontend/src/pages/ETPMaster.jsx
================================================
/**
 * ETP Master Reference Page
 * 
 * Read-only view for contractors to reference current ETP charges.
 * Shows only ACTIVE charges that are currently effective.
 * 
 * Accessible by all roles for transparency.
 */
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import {
    Calculator, Search, Info, Calendar, FileText,
    TrendingDown, TrendingUp, RefreshCw, HelpCircle
} from 'lucide-react';
import mastersService from '@/api/services/mastersService';
import { useAuth } from '@/contexts/AuthContext';

const ETPMaster = () => {
    const { user } = useAuth();
    const [loading, setLoading] = useState(true);
    const [charges, setCharges] = useState([]);
    const [searchQuery, setSearchQuery] = useState('');
    const [filterType, setFilterType] = useState('all');

    // Fetch active ETP charges
    useEffect(() => {
        fetchCharges();
    }, []);

    const fetchCharges = async () => {
        setLoading(true);
        try {
            const response = await mastersService.getActiveETPCharges();
            setCharges(response.data?.results || response.data || []);
        } catch (error) {
            console.error('Failed to fetch ETP charges:', error);
            // Try fallback to all charges
            try {
                const fallback = await mastersService.getETPCharges();
                // Filter only active and effective ones
                const today = new Date();
                const allCharges = fallback.data?.results || fallback.data || [];
                const activeCharges = allCharges.filter(c => {
                    if (!c.is_active) return false;
                    if (!c.effective_date) return true;
                    return new Date(c.effective_date) <= today;
                });
                setCharges(activeCharges);
            } catch (e) {
                setCharges([]);
            }
        } finally {
            setLoading(false);
        }
    };

    // Filter charges
    const filteredCharges = charges.filter(charge => {
        const matchesSearch =
            charge.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            charge.code.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesType = filterType === 'all' || charge.charge_type === filterType;
        return matchesSearch && matchesType;
    });

    // Group by type for summary
    const chargesByType = {
        Deduction: filteredCharges.filter(c => c.charge_type === 'Deduction'),
        Recovery: filteredCharges.filter(c => c.charge_type === 'Recovery'),
        Levy: filteredCharges.filter(c => c.charge_type === 'Levy'),
        Addition: filteredCharges.filter(c => c.charge_type === 'Addition'),
    };

    // Format date
    const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    };

    // Get type icon and color
    const getTypeStyle = (type) => {
        switch (type) {
            case 'Deduction':
                return {
                    icon: TrendingDown,
                    bg: 'bg-red-50 dark:bg-red-900/10',
                    border: 'border-red-200 dark:border-red-800',
                    text: 'text-red-700 dark:text-red-400',
                    iconColor: 'text-red-500 dark:text-red-400'
                };
            case 'Recovery':
                return {
                    icon: TrendingDown,
                    bg: 'bg-amber-50 dark:bg-amber-900/10',
                    border: 'border-amber-200 dark:border-amber-800',
                    text: 'text-amber-700 dark:text-amber-400',
                    iconColor: 'text-amber-500 dark:text-amber-400'
                };
            case 'Levy':
                return {
                    icon: FileText,
                    bg: 'bg-blue-50 dark:bg-blue-900/10',
                    border: 'border-blue-200 dark:border-blue-800',
                    text: 'text-blue-700 dark:text-blue-400',
                    iconColor: 'text-blue-500 dark:text-blue-400'
                };
            case 'Addition':
                return {
                    icon: TrendingUp,
                    bg: 'bg-emerald-50 dark:bg-emerald-900/10',
                    border: 'border-emerald-200 dark:border-emerald-800',
                    text: 'text-emerald-700 dark:text-emerald-400',
                    iconColor: 'text-emerald-500 dark:text-emerald-400'
                };
            default:
                return {
                    icon: Calculator,
                    bg: 'bg-app-surface',
                    border: 'border-app-subtle',
                    text: 'text-app-text',
                    iconColor: 'text-app-muted'
                };
        }
    };

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                <div>
                    <h1 className="text-2xl font-bold text-app-heading flex items-center gap-2">
                        <Calculator className="text-primary-600" size={28} />
                        ETP Charges Reference
                    </h1>
                    <p className="text-app-muted mt-1">
                        Current statutory deductions, levies, and recoveries applicable to bills
                    </p>
                </div>
                <button
                    onClick={fetchCharges}
                    disabled={loading}
                    className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-app-text bg-app-card border border-app rounded-lg hover:bg-app-surface transition-colors disabled:opacity-50"
                >
                    <RefreshCw size={16} className={loading ? 'animate-spin' : ''} />
                    Refresh
                </button>
            </div>

            {/* Info Banner */}
            <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 flex items-start gap-3">
                <div className="p-2 bg-blue-100 dark:bg-blue-900/40 rounded-lg flex-shrink-0">
                    <Info size={18} className="text-blue-600 dark:text-blue-400" />
                </div>
                <div>
                    <p className="font-medium text-blue-800 dark:text-blue-300">Reference Information</p>
                    <p className="text-sm text-blue-600 dark:text-blue-400 mt-0.5">
                        This page displays all currently active ETP charges that will be applied to your bills.
                        Rates are set by the SPV administration as per government circulars.
                    </p>
                </div>
            </div>

            {/* Summary Cards */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {Object.entries(chargesByType).map(([type, items]) => {
                    const style = getTypeStyle(type);
                    const Icon = style.icon;
                    return (
                        <motion.div
                            key={type}
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className={`${style.bg} ${style.border} border rounded-xl p-4`}
                        >
                            <div className="flex items-center justify-between">
                                <span className={`text-xs font-semibold ${style.text} uppercase tracking-wider`}>
                                    {type}s
                                </span>
                                <Icon size={16} className={style.iconColor} />
                            </div>
                            <p className={`text-2xl font-bold ${style.text} mt-2`}>
                                {items.length}
                            </p>
                            <p className="text-xs text-app-muted mt-1">
                                {items.length === 1 ? 'charge' : 'charges'}
                            </p>
                        </motion.div>
                    );
                })}
            </div>

            {/* Filters */}
            <div className="flex flex-col sm:flex-row gap-4">
                {/* Search */}
                <div className="relative flex-1 max-w-md">
                    <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                    <input
                        type="text"
                        placeholder="Search charges..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-app bg-app-input text-app-text focus:border-primary-500 focus:ring-2 focus:ring-primary-100 outline-none transition-all"
                    />
                </div>

                {/* Type Filter */}
                <div className="flex gap-2 flex-wrap">
                    {['all', 'Deduction', 'Recovery', 'Levy', 'Addition'].map(type => (
                        <button
                            key={type}
                            onClick={() => setFilterType(type)}
                            className={`px-4 py-2 text-sm font-medium rounded-lg transition-all ${filterType === type
                                ? 'bg-primary-600 text-white shadow-sm'
                                : 'bg-app-card text-app-text border border-app hover:bg-app-surface'
                                }`}
                        >
                            {type === 'all' ? 'All Types' : type}
                        </button>
                    ))}
                </div>
            </div>

            {/* Charges Table */}
            <div className="bg-app-card rounded-xl border border-app-subtle overflow-hidden shadow-sm">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead className="bg-app-surface border-b border-app-subtle">
                            <tr>
                                <th className="text-left px-4 py-3 font-semibold text-app-text">Code</th>
                                <th className="text-left px-4 py-3 font-semibold text-app-text">Charge Name</th>
                                <th className="text-left px-4 py-3 font-semibold text-app-text">Type</th>
                                <th className="text-center px-4 py-3 font-semibold text-app-text">Rate</th>
                                <th className="text-left px-4 py-3 font-semibold text-app-text">Applied On</th>
                                <th className="text-left px-4 py-3 font-semibold text-app-text">Effective From</th>
                                <th className="text-left px-4 py-3 font-semibold text-app-text">Reference</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                            {loading ? (
                                <tr>
                                    <td colSpan={7} className="text-center py-12">
                                        <RefreshCw className="animate-spin mx-auto text-primary-500 mb-2" size={28} />
                                        <p className="text-app-muted">Loading charges...</p>
                                    </td>
                                </tr>
                            ) : filteredCharges.length === 0 ? (
                                <tr>
                                    <td colSpan={7} className="text-center py-12">
                                        <Calculator size={32} className="mx-auto text-app-muted-light mb-2" />
                                        <p className="text-app-muted">No charges found</p>
                                    </td>
                                </tr>
                            ) : (
                                filteredCharges.map((charge, idx) => {
                                    const style = getTypeStyle(charge.charge_type);
                                    return (
                                        <motion.tr
                                            key={charge.id}
                                            initial={{ opacity: 0 }}
                                            animate={{ opacity: 1 }}
                                            transition={{ delay: idx * 0.03 }}
                                            className="hover:bg-app-surface transition-colors"
                                        >
                                            <td className="px-4 py-3">
                                                <span className="font-mono text-app-heading font-medium">
                                                    {charge.code}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3">
                                                <span className="font-medium text-app-heading">
                                                    {charge.name}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3">
                                                <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded text-xs font-medium ${style.bg} ${style.text} ${style.border} border`}>
                                                    {charge.charge_type}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 text-center">
                                                <span className="inline-flex items-center justify-center min-w-[60px] px-3 py-1 bg-app-surface rounded font-mono font-bold text-app-heading">
                                                    {charge.rate_percentage}%
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 text-app-muted">
                                                {charge.basis_of_calculation}
                                            </td>
                                            <td className="px-4 py-3">
                                                <span className="inline-flex items-center gap-1 text-app-muted">
                                                    <Calendar size={14} className="text-app-muted" />
                                                    {formatDate(charge.effective_date)}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 text-app-muted text-xs">
                                                {charge.govt_reference || '-'}
                                            </td>
                                        </motion.tr>
                                    );
                                })
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* Help Section */}
            <div className="bg-app-surface rounded-xl p-6 border border-app-subtle">
                <h3 className="font-semibold text-app-heading flex items-center gap-2 mb-4">
                    <HelpCircle size={18} className="text-primary-600" />
                    Understanding ETP Charges
                </h3>
                <div className="grid md:grid-cols-2 gap-4 text-sm text-app-muted">
                    <div>
                        <h4 className="font-medium text-app-text mb-2">Charge Types</h4>
                        <ul className="space-y-1.5">
                            <li className="flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-red-500"></span>
                                <strong>Deduction:</strong> Subtracted from bill (e.g., TDS)
                            </li>
                            <li className="flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-amber-500"></span>
                                <strong>Recovery:</strong> Recovered amounts (e.g., Advances)
                            </li>
                            <li className="flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-blue-500"></span>
                                <strong>Levy:</strong> Government levies (e.g., Labour Cess)
                            </li>
                            <li className="flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-emerald-500"></span>
                                <strong>Addition:</strong> Added to bill (e.g., Price Escalation)
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h4 className="font-medium text-app-text mb-2">Calculation Basis</h4>
                        <ul className="space-y-1.5">
                            <li><strong>Gross Bill Value:</strong> Percentage on total bill amount</li>
                            <li><strong>Works Component:</strong> Percentage on works portion only</li>
                            <li><strong>Material/Labour Cost:</strong> Percentage on specific cost heads</li>
                            <li><strong>Net Payable:</strong> Percentage on final payable amount</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default ETPMaster;



================================================
FILE: frontend/src/pages/ForgotPassword.jsx
================================================
import { useState } from 'react';
import { motion } from 'framer-motion';
import { Link } from 'react-router-dom';
import {
    Mail, ArrowLeft, CheckCircle2, AlertCircle, Loader2, KeyRound
} from 'lucide-react';
import { toast } from 'sonner';
import api from '@/api/client';

const ForgotPassword = () => {
    const [email, setEmail] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [isSuccess, setIsSuccess] = useState(false);
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();

        if (!email) {
            setError('Email is required');
            return;
        }

        // Basic email validation
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            setError('Please enter a valid email address');
            return;
        }

        setIsSubmitting(true);
        setError('');

        try {
            await api.post('/users/password-reset/', { email });
            setIsSuccess(true);
            toast.success('Password reset email sent!');
        } catch (err) {
            console.error('Password reset request failed:', err);
            // Still show success to prevent email enumeration
            setIsSuccess(true);
        } finally {
            setIsSubmitting(false);
        }
    };

    if (isSuccess) {
        return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 via-amber-950 to-slate-900 flex items-center justify-center p-4">
                <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="bg-app-card rounded-3xl shadow-xl p-8 max-w-md w-full text-center"
                >
                    <div className="w-20 h-20 bg-amber-100 dark:bg-amber-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <Mail className="w-10 h-10 text-amber-600 dark:text-amber-400" />
                    </div>
                    <h1 className="text-2xl font-bold text-app-heading mb-3">Check Your Email</h1>
                    <p className="text-app-muted mb-6">
                        If an account exists with <strong>{email}</strong>, you will receive a password reset link shortly.
                    </p>
                    <p className="text-sm text-app-muted mb-6">
                        The link will expire in 1 hour. Check your spam folder if you don't see the email.
                    </p>
                    <Link
                        to="/login"
                        className="inline-flex items-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 transition-colors"
                    >
                        <ArrowLeft size={18} /> Back to Login
                    </Link>
                </motion.div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-amber-950 to-slate-900 flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                className="bg-app-card rounded-3xl shadow-xl w-full max-w-md overflow-hidden"
                style={{ boxShadow: '0 0 60px rgba(251, 191, 36, 0.15)' }}
            >
                {/* Header */}
                <div className="bg-gradient-to-r from-amber-500 to-amber-600 p-6 text-white text-center">
                    <div className="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <KeyRound className="w-8 h-8 text-white" />
                    </div>
                    <h1 className="text-xl font-bold text-white">Forgot Password?</h1>
                    <p className="text-white text-sm mt-2 opacity-90">PMIS - Zaheerabad Industrial Area</p>
                </div>

                {/* Form */}
                <form onSubmit={handleSubmit} className="p-6 space-y-5">
                    <p className="text-app-muted text-sm">
                        Enter your email address and we'll send you a link to reset your password.
                    </p>

                    <div>
                        <label className="block text-sm font-medium text-app-text mb-1.5">
                            Email Address <span className="text-red-500">*</span>
                        </label>
                        <div className="relative">
                            <Mail className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" size={18} />
                            <input
                                type="email"
                                value={email}
                                onChange={(e) => {
                                    setEmail(e.target.value);
                                    if (error) setError('');
                                }}
                                placeholder="Enter your registered email"
                                className={`w-full px-4 py-2.5 pl-10 rounded-xl border transition-all outline-none focus:ring-2 bg-app-input text-app-text ${error
                                    ? 'border-red-300 dark:border-red-500/50 focus:border-red-500 focus:ring-red-100'
                                    : 'border-app focus:border-amber-500 focus:ring-amber-100 dark:focus:ring-amber-900/30'
                                    }`}
                            />
                        </div>
                        {error && (
                            <p className="mt-1 text-sm text-red-500 flex items-center gap-1">
                                <AlertCircle size={14} /> {error}
                            </p>
                        )}
                    </div>

                    <button
                        type="submit"
                        disabled={isSubmitting}
                        className="w-full py-3 bg-amber-500 text-white rounded-xl font-semibold hover:bg-amber-600 hover:shadow-lg active:scale-[0.98] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                        {isSubmitting ? (
                            <>
                                <Loader2 size={18} className="animate-spin" /> Sending...
                            </>
                        ) : (
                            <>
                                <Mail size={18} /> Send Reset Link
                            </>
                        )}
                    </button>

                    <div className="text-center">
                        <Link
                            to="/login"
                            className="text-sm text-slate-600 hover:text-primary-600 inline-flex items-center gap-1"
                        >
                            <ArrowLeft size={14} /> Back to Login
                        </Link>
                    </div>
                </form>
            </motion.div>
        </div>
    );
};

export default ForgotPassword;



================================================
FILE: frontend/src/pages/FundManagement.jsx
================================================
import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { Plus, Wallet, TrendingUp, Calendar, X } from 'lucide-react';
import Button from '@/components/ui/Button';
import { Card } from '@/components/ui/Card';
import financeService from '@/services/financeService';
import { toast } from 'sonner';

const FundManagement = () => {
    const [funds, setFunds] = useState([]);
    const [loading, setLoading] = useState(true);
    const [isModalOpen, setIsModalOpen] = useState(false);

    useEffect(() => {
        loadFunds();
    }, []);

    // ESC key handler for modal
    useEffect(() => {
        const handleEscape = (e) => {
            if (e.key === 'Escape' && isModalOpen) {
                setIsModalOpen(false);
            }
        };
        window.addEventListener('keydown', handleEscape);
        return () => window.removeEventListener('keydown', handleEscape);
    }, [isModalOpen]);

    const loadFunds = async () => {
        try {
            setLoading(true);
            const data = await financeService.getFunds();
            setFunds(data);
        } catch (error) {
            toast.error("Failed to load funds");
        } finally {
            setLoading(false);
        }
    };

    const handleSave = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            name: formData.get('name'),
            allocating_authority: formData.get('allocating_authority'),
            total_amount: formData.get('total_amount'),
            start_date: formData.get('start_date'),
            end_date: formData.get('end_date')
        };

        try {
            await financeService.createFund(data);
            toast.success("Fund Added Successfully");
            setIsModalOpen(false);
            loadFunds();
        } catch (error) {
            toast.error("Failed to add fund");
        }
    };

    const totalInflow = funds.reduce((acc, curr) => acc + parseFloat(curr.total_amount), 0);

    return (
        <div className="p-6 space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-app-heading">Fund Management</h1>
                    <p className="text-app-muted text-sm">Track Grants, Loans, and Budgetary Allocations</p>
                </div>
                <Button onClick={() => setIsModalOpen(true)} className="bg-primary-600 text-white">
                    <Plus size={18} className="mr-2" /> Add Fund Source
                </Button>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <Card className="p-6 flex items-center gap-4 bg-emerald-50 border-emerald-100 dark:bg-emerald-900/10 dark:border-emerald-800">
                    <div className="p-3 bg-emerald-100 rounded-lg text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400">
                        <Wallet size={24} />
                    </div>
                    <div>
                        <p className="text-sm font-medium text-emerald-800 dark:text-emerald-200">Total Inflow</p>
                        <p className="text-2xl font-bold text-emerald-900 dark:text-emerald-100">
                            {new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(totalInflow)}
                        </p>
                    </div>
                </Card>
            </div>

            {/* List */}
            <div className="bg-app-card rounded-xl shadow-sm border border-app-subtle overflow-hidden">
                <table className="w-full text-sm text-left">
                    <thead className="bg-app-surface text-app-muted font-medium border-b border-app-subtle">
                        <tr>
                            <th className="px-6 py-4">Fund Name</th>
                            <th className="px-6 py-4">Authority</th>
                            <th className="px-6 py-4 text-right">Total Amount</th>
                            <th className="px-6 py-4 text-right">Allocation Period</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                        {funds.map(fund => (
                            <tr key={fund.id} className="hover:bg-app-surface">
                                <td className="px-6 py-4 font-medium text-app-heading">{fund.name}</td>
                                <td className="px-6 py-4 text-app-muted">{fund.allocating_authority}</td>
                                <td className="px-6 py-4 text-right font-mono font-medium text-app-text">
                                    {new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(fund.total_amount)}
                                </td>
                                <td className="px-6 py-4 text-right text-app-muted">
                                    {new Date(fund.start_date).getFullYear()} - {new Date(fund.end_date).getFullYear()}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                {funds.length === 0 && !loading && (
                    <div className="p-8 text-center text-app-muted">No funds allocated yet.</div>
                )}
            </div>

            {/* Modal */}
            {createPortal(
                <AnimatePresence>
                    {isModalOpen && (
                        <>
                            {/* Backdrop */}
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                exit={{ opacity: 0 }}
                                onClick={() => setIsModalOpen(false)}
                                className="fixed inset-0 z-[9999] bg-black/50 backdrop-blur-sm"
                            />
                            {/* Modal Content */}
                            <motion.div
                                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                                animate={{ opacity: 1, scale: 1, y: 0 }}
                                exit={{ opacity: 0, scale: 0.95, y: 20 }}
                                transition={{ duration: 0.2 }}
                                className="fixed inset-0 z-[9999] flex items-center justify-center p-4 pointer-events-none"
                            >
                                <div className="bg-app-card rounded-xl shadow-2xl p-6 w-96 pointer-events-auto border border-app-subtle">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-lg font-bold text-app-heading">Add Fund Source</h2>
                                        <button
                                            onClick={() => setIsModalOpen(false)}
                                            className="p-1 hover:bg-app-surface rounded-full transition-colors"
                                        >
                                            <X size={18} className="text-app-muted" />
                                        </button>
                                    </div>
                                    <form onSubmit={handleSave} className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-app-muted">Fund Name</label>
                                            <input name="name" required className="w-full border border-app bg-app-input text-app-text rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none" placeholder="e.g. World Bank Tranche 1" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-app-muted">Allocating Authority</label>
                                            <input name="allocating_authority" required className="w-full border border-app bg-app-input text-app-text rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none" placeholder="e.g. Dept of Finance" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-app-muted">Total Amount (INR)</label>
                                            <input name="total_amount" type="number" required className="w-full border border-app bg-app-input text-app-text rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none" />
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <label className="block text-xs font-bold text-app-muted">Start Date</label>
                                                <input name="start_date" type="date" required className="w-full border border-app bg-app-input text-app-text rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-app-muted">Valid Till</label>
                                                <input name="end_date" type="date" required className="w-full border border-app bg-app-input text-app-text rounded-lg p-2 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none" />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 pt-4">
                                            <Button type="button" variant="outline" onClick={() => setIsModalOpen(false)}>Cancel</Button>
                                            <Button type="submit" className="bg-primary-600 text-white">Save Fund</Button>
                                        </div>
                                    </form>
                                </div>
                            </motion.div>
                        </>
                    )}
                </AnimatePresence>,
                document.body
            )}
        </div>
    );
};

export default FundManagement;



================================================
FILE: frontend/src/pages/GIS.jsx
================================================
import { useLanguage } from '@/contexts/LanguageContext';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { gisFeatures, projects } from '@/mock';
import { MapPin } from 'lucide-react';
import { LeafletMap } from '@/components/gis/LeafletMap';

const GIS = () => {
  const { t } = useLanguage();

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold text-app-heading">{t('common.gis')}</h1>
        <p className="text-app-muted mt-1">{t('gis.subtitle')}</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>{t('gis.projectLocationsMap')}</CardTitle>
          <p className="text-sm text-app-muted mt-1">
            {t('gis.mapDescription')}
          </p>
        </CardHeader>
        <CardContent>
          <LeafletMap projects={projects} gisFeatures={gisFeatures} />
        </CardContent>
      </Card>

      {/* GIS Features List */}
      <Card>
        <CardHeader>
          <CardTitle>{t('gis.gisFeatures')}</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {gisFeatures.map((feature) => (
              <div
                key={feature.id}
                className="p-4 bg-app-card rounded-lg border border-app-border"
              >
                <div className="flex items-center gap-2 mb-2">
                  <MapPin className="text-primary-600" size={20} />
                  <h3 className="font-medium text-app-text">{feature.properties.name}</h3>
                </div>
                <p className="text-sm text-app-muted mb-2">{feature.properties.description}</p>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-primary-100 text-primary-800 rounded text-xs">
                    {feature.type}
                  </span>
                  {feature.properties.projectId && (
                    <span className="px-2 py-1 bg-app-base text-app-muted rounded text-xs">
                      {t('common.project')}: {feature.properties.projectId}
                    </span>
                  )}
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default GIS;









================================================
FILE: frontend/src/pages/Login.jsx
================================================
import OtpLogin from '@/components/auth/OtpLogin';

const Login = () => {
  return <OtpLogin />;
};

export default Login;





================================================
FILE: frontend/src/pages/Procurement.jsx
================================================
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    Building2,
    Search,
    Plus,
    Filter,
    Mail,
    Phone,
    MapPin,
    FileBadge,
    Loader2,

} from 'lucide-react';
import { Card } from '@/components/ui/Card';
import Button from '@/components/ui/Button';
import { useLanguage } from '@/contexts/LanguageContext';
import mastersService from '@/api/services/mastersService';
import projectService from '@/api/services/projectService';
import { AddContractorModal } from '@/components/procurement/AddContractorModal';
import { ContractorDetailModal } from '@/components/procurement/ContractorDetailModal';
import { EmptyState } from '@/components/ui/EmptyState';
import { toast } from 'sonner';

const Procurement = () => {
    const { t } = useLanguage();

    // Real data state
    const [contractors, setContractors] = useState([]);
    const [projects, setProjects] = useState([]);
    const [packages, setPackages] = useState([]);
    const [loading, setLoading] = useState(true);

    const [viewMode, setViewMode] = useState('grid');
    const [searchQuery, setSearchQuery] = useState('');
    const [isAddModalOpen, setIsAddModalOpen] = useState(false);
    const [editingContractor, setEditingContractor] = useState(null);

    // Detail Modal State
    const [selectedContractor, setSelectedContractor] = useState(null);
    const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);

    // Fetch real data on mount
    useEffect(() => {
        const fetchData = async () => {
            try {
                const [contractorsRes, projectsData] = await Promise.all([
                    mastersService.getContractors(),
                    projectService.getAllProjects()
                ]);
                setContractors(contractorsRes.data?.results || contractorsRes.data || []);
                // projectService.getAllProjects() already handles pagination
                setProjects(projectsData || []);
            } catch (error) {
                console.error('Failed to fetch procurement data:', error);
                toast.error('Failed to load contractors');
            } finally {
                setLoading(false);
            }
        };
        fetchData();
    }, []);

    const handleContractorClick = (contractor) => {
        setSelectedContractor(contractor);
        setIsDetailModalOpen(true);
    };

    const handleSaveContractor = async (data) => {
        try {
            const response = await mastersService.createContractor(data);
            setContractors(prev => [response.data, ...prev]);
            setIsAddModalOpen(false);
            toast.success('Contractor added successfully');
        } catch (error) {
            console.error('Failed to add contractor:', error);
            toast.error('Failed to add contractor');
        }
    };

    const handleUpdateContractor = async (id, data) => {
        try {
            const response = await mastersService.updateContractor(id, data);
            setContractors(prev => prev.map(c => c.id === id ? response.data : c));
            toast.success('Contractor updated successfully');
        } catch (error) {
            console.error('Failed to update contractor:', error);
            toast.error('Failed to update contractor');
        }
    };

    const handleDeleteContractor = async (id) => {
        try {
            await mastersService.deleteContractor(id);
            setContractors(prev => prev.filter(c => c.id !== id));
            toast.success('Contractor deleted');
        } catch (error) {
            console.error('Failed to delete contractor:', error);
            toast.error('Failed to delete contractor');
        }
    };

    const handleModalClose = () => {
        setIsAddModalOpen(false);
    };

    // Filter contractors based on search
    const filteredContractors = contractors.filter(c =>
        c.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        c.contractor_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        c.pan_no?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        c.gstin?.toLowerCase().includes(searchQuery.toLowerCase())
    );

    const activeContractors = filteredContractors.filter(c => !c.blacklisted).length;

    return (
        <div className="p-6 space-y-6">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-heading font-bold text-app-heading">Procurement</h1>
                    <p className="text-app-muted mt-1">Manage contractors, vendors, and suppliers</p>
                </div>
                <Button
                    onClick={() => setIsAddModalOpen(true)}
                    className="flex items-center gap-2 bg-primary-950 text-white hover:bg-primary-900 shadow-lg shadow-primary-950/20"
                >
                    <Plus size={18} />
                    <span>Add Contractor</span>
                </Button>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {[
                    { label: 'Total Contractors', value: contractors.length, icon: Building2, color: 'text-blue-600 dark:text-blue-400', bg: 'bg-blue-50 dark:bg-blue-900/20' },
                    { label: 'Active Contracts', value: activeContractors, icon: FileBadge, color: 'text-emerald-600 dark:text-emerald-400', bg: 'bg-emerald-50 dark:bg-emerald-900/20' },
                    { label: 'Pending Approvals', value: '0', icon: Filter, color: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-50 dark:bg-amber-900/20' },
                ].map((stat, index) => (
                    <motion.div
                        key={index}
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: index * 0.1 }}
                    >
                        <Card className="p-6 flex items-center gap-4 hover:shadow-lg transition-shadow duration-300">
                            <div className={`p-4 rounded-xl ${stat.bg}`}>
                                <stat.icon className={stat.color} size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-medium text-app-muted">{stat.label}</p>
                                <h3 className="text-2xl font-bold text-app-heading">{stat.value}</h3>
                            </div>
                        </Card>
                    </motion.div>
                ))}
            </div>

            {/* Search and Filter Bar */}
            <Card className="p-4">
                <div className="flex flex-col md:flex-row gap-4">
                    <div className="relative flex-1">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" size={20} />
                        <input
                            type="text"
                            placeholder="Search contractors by name, PAN, or GSTIN..."
                            className="w-full pl-10 pr-4 py-2 rounded-lg border border-app bg-app-input text-app-text focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>
                    <div className="flex gap-2">
                        <Button variant="outline" className="flex items-center gap-2">
                            <Filter size={18} />
                            <span>Filter</span>
                        </Button>
                    </div>
                </div>
            </Card>

            {/* Contractors Grid */}
            {loading ? (
                <div className="flex items-center justify-center py-16">
                    <Loader2 className="w-8 h-8 text-primary-600 animate-spin" />
                </div>
            ) : filteredContractors.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {filteredContractors.map((contractor, index) => (
                        <motion.div
                            key={contractor.id}
                            initial={{ opacity: 0, scale: 0.95 }}
                            animate={{ opacity: 1, scale: 1 }}
                            transition={{ delay: index * 0.05 }}
                        >
                            <div onClick={() => handleContractorClick(contractor)}>
                                <Card className="h-full hover:shadow-xl transition-all duration-300 group cursor-pointer border-app-subtle relative bg-app-card">
                                    <div className="p-6 space-y-4">
                                        <div className="flex justify-between items-start relative">
                                            <div className="p-3 rounded-lg bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300 group-hover:bg-primary-600 group-hover:text-white transition-colors duration-300">
                                                <Building2 size={24} />
                                            </div>
                                            {contractor.blacklisted && (
                                                <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300">
                                                    Blacklisted
                                                </span>
                                            )}
                                        </div>

                                        <div>
                                            <h3 className="text-lg font-bold text-app-heading group-hover:text-primary-700 dark:group-hover:text-primary-400 transition-colors">
                                                {contractor.name || contractor.contractor_name || 'Unnamed Contractor'}
                                            </h3>
                                            <div className="flex items-center gap-2 mt-1">
                                                <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${contractor.blacklisted
                                                    ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'
                                                    : contractor.is_valid
                                                        ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300'
                                                        : 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300'
                                                    }`}>
                                                    {contractor.blacklisted ? 'Blacklisted' : contractor.is_valid ? 'Active' : 'Expired'}
                                                </span>
                                            </div>
                                        </div>

                                        <div className="space-y-3 pt-4 border-t border-app-subtle">
                                            {contractor.gstin && (
                                                <div className="flex items-center gap-3 text-sm text-app-muted">
                                                    <FileBadge size={16} className="text-app-muted" />
                                                    <span className="font-mono">{contractor.gstin}</span>
                                                </div>
                                            )}
                                            {(contractor.city || contractor.state) && (
                                                <div className="flex items-center gap-3 text-sm text-app-muted">
                                                    <MapPin size={16} className="text-app-muted" />
                                                    <span className="truncate">{[contractor.city, contractor.state].filter(Boolean).join(', ')}</span>
                                                </div>
                                            )}
                                            {contractor.email && (
                                                <div className="flex items-center gap-3 text-sm text-app-muted">
                                                    <Mail size={16} className="text-app-muted" />
                                                    <span className="truncate">{contractor.email}</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </Card>
                            </div>
                        </motion.div>
                    ))}
                </div>
            ) : (
                <EmptyState
                    icon={Building2}
                    title="No Contractors Found"
                    description={searchQuery ? "No contractors match your search." : "Get started by adding your first contractor."}
                    actionLabel="Add Contractor"
                    onAction={() => setIsAddModalOpen(true)}
                />
            )}

            <AddContractorModal
                isOpen={isAddModalOpen}
                onClose={handleModalClose}
                onSave={handleSaveContractor}
                projects={projects}
                packages={packages}
                contractor={null}
            />

            <ContractorDetailModal
                isOpen={isDetailModalOpen}
                onClose={() => setIsDetailModalOpen(false)}
                contractor={selectedContractor}
                onUpdate={handleUpdateContractor}
            />
        </div>
    );
};

export default Procurement;




================================================
FILE: frontend/src/pages/ProjectDetailsPage.jsx
================================================
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import projectService from '@/api/services/projectService';
import mastersService from '@/api/services/mastersService';

import { ProjectDetailView } from '@/components/projects/ProjectDetailView';
import Button from '@/components/ui/Button';
import { ChevronLeft, Loader2 } from 'lucide-react';
import { toast } from 'sonner';

const ProjectDetailsPage = () => {
    const { id } = useParams();
    const navigate = useNavigate();

    const [project, setProject] = useState(null);
    const [packages, setPackages] = useState([]);
    const [contractors, setContractors] = useState([]);
    const [loading, setLoading] = useState(true);

    const loadProjectData = async () => {
        try {
            setLoading(true);
            const [projectData, contractorsRes] = await Promise.all([
                projectService.getProjectById(id),
                mastersService.getActiveContractors()
            ]);

            setProject(projectData);
            setContractors(contractorsRes.data?.results || contractorsRes.data || []);

            // If the project serializer returns work_packages, use them.
            // Otherwise fetch separately.
            if (projectData.work_packages) {
                setPackages(projectData.work_packages);
            } else {
                const packagesData = await projectService.getPackages(id);
                setPackages(packagesData);
            }
        } catch (error) {
            console.error('Failed to load project:', error);
            toast.error('Failed to load project details');
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        if (id) {
            loadProjectData();
        }
    }, [id]);

    const handlePackageCreated = () => {
        loadProjectData(); // Refresh data
    };

    if (loading) {
        return (
            <div className="flex h-screen items-center justify-center">
                <Loader2 className="animate-spin text-primary-600" size={32} />
            </div>
        );
    }

    if (!project) {
        return (
            <div className="flex flex-col items-center justify-center p-12">
                <h2 className="text-2xl font-bold text-app-heading">Project Not Found</h2>
                <Button onClick={() => navigate('/projects')} className="mt-4">
                    Back to Projects
                </Button>
            </div>
        );
    }

    return (
        <div className="space-y-4 h-full">
            <Button variant="outline" onClick={() => navigate(-1)} className="mb-2">
                <ChevronLeft size={16} className="mr-1" /> Back
            </Button>
            <div className="bg-app-card rounded-lg shadow-sm border border-app-subtle overflow-hidden min-h-[85vh]">
                <ProjectDetailView
                    project={project}
                    packages={packages}
                    contractors={contractors}
                    onPackageUpdate={handlePackageCreated}
                />
            </div>
        </div>
    );
};

export default ProjectDetailsPage;




================================================
FILE: frontend/src/pages/Projects.jsx
================================================
import { useState, useMemo, useEffect } from 'react';
import { useLanguage } from '@/contexts/LanguageContext';
import { useAuth } from '@/contexts/AuthContext';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import projectService from '@/api/services/projectService';
import mastersService from '@/api/services/mastersService';
import { CreateProjectModal } from '@/components/projects/CreateProjectModal';
import { ProjectDetailModal } from '@/components/projects/ProjectDetailModal';
import { CreatePackageModal } from '@/components/packages/CreatePackageModal';
import { LandStats } from '@/components/projects/LandStats';
import { EmptyState } from '@/components/ui/EmptyState';
import { FolderOpen, Plus, Search, DollarSign, TrendingUp, Package, Filter, X } from 'lucide-react';
import Button from '@/components/ui/Button';
import { motion } from 'framer-motion';
import { getStatusColor } from '@/lib/colors';
import { calculateBudgetUtilization } from '@/lib/calculations';
import { toast } from 'sonner';

const Projects = () => {
  const { t } = useLanguage();
  const { user } = useAuth();

  const [projects, setProjects] = useState([]);
  const [contractors, setContractors] = useState([]);
  const [packages, setPackages] = useState([]);
  const [loading, setLoading] = useState(true);

  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [divisionFilter, setDivisionFilter] = useState('all');
  const [showFilters, setShowFilters] = useState(false);
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
  const [isCreatePackageModalOpen, setIsCreatePackageModalOpen] = useState(false);
  const [selectedProject, setSelectedProject] = useState(null);
  const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);

  // Fetch all data from Backend
  const fetchData = async () => {
    try {
      const [projectsData, contractorsRes, packagesRes] = await Promise.all([
        projectService.getAllProjects(),
        mastersService.getActiveContractors(),
        projectService.getWorkPackages ? projectService.getWorkPackages() : Promise.resolve({ data: [] })
      ]);

      // Handle paginated responses
      setProjects(Array.isArray(projectsData) ? projectsData : []);
      setContractors(Array.isArray(contractorsRes.data) ? contractorsRes.data : (contractorsRes.data?.results || []));

      // Fix packages pagination handling
      const packagesData = packagesRes.data;
      setPackages(Array.isArray(packagesData) ? packagesData : (packagesData?.results || []));
    } catch (error) {
      console.error('Failed to load data:', error);
      toast.error('Failed to load projects');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  // Check if user can create projects
  const canCreateProject = user?.role === 'SPV_Official' || user?.role === 'PMNC_Team';

  // Get unique categories and divisions for filters
  const categories = useMemo(() => {
    const cats = [...new Set(projects.map(p => p.category).filter(Boolean))];
    return cats.sort();
  }, [projects]);

  const divisions = useMemo(() => {
    const divs = [...new Set(projects.map(p => p.division_name || p.division).filter(Boolean))];
    return divs.sort();
  }, [projects]);

  // Filter projects with all criteria
  const filteredProjects = useMemo(() => {
    return projects.filter((project) => {
      const name = project.name || '';
      const desc = project.description || '';
      const cat = project.category || '';
      const mgr = typeof project.manager === 'string' ? project.manager : (project.manager?.name || project.manager_name || '');

      const matchesSearch =
        name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        desc.toLowerCase().includes(searchQuery.toLowerCase()) ||
        cat.toLowerCase().includes(searchQuery.toLowerCase()) ||
        mgr.toLowerCase().includes(searchQuery.toLowerCase());
      const matchesStatus = statusFilter === 'all' || project.status === statusFilter;
      const matchesCategory = categoryFilter === 'all' || project.category === categoryFilter;
      const matchesDivision = divisionFilter === 'all' ||
        (project.division_name || project.division) === divisionFilter;

      return matchesSearch && matchesStatus && matchesCategory && matchesDivision;
    });
  }, [projects, searchQuery, statusFilter, categoryFilter, divisionFilter]);

  // Check if any filters are active
  const hasActiveFilters = statusFilter !== 'all' || categoryFilter !== 'all' || divisionFilter !== 'all' || searchQuery !== '';

  // Clear all filters
  const clearAllFilters = () => {
    setSearchQuery('');
    setStatusFilter('all');
    setCategoryFilter('all');
    setDivisionFilter('all');
  };

  const handleCreateProject = async (projectData) => {
    // Create project and return result for modal's two-step upload
    const result = await projectService.createProject(projectData);
    setIsCreateModalOpen(false);
    fetchData(); // Reload list
    return result; // CRITICAL: Return the created project for document uploads
  };

  const getStatusBadgeColor = (status) => {
    const statusColors = getStatusColor(status);
    return `${statusColors.bg} ${statusColors.text}`;
  };

  const formatCurrency = (amount) => {
    if (amount >= 10000000) {
      return `â‚¹${(amount / 10000000).toFixed(2)} Cr`;
    }
    return `â‚¹${(amount / 100000).toFixed(2)} L`;
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl sm:text-3xl font-bold text-app-heading">{t('projects.title')}</h1>
          <p className="text-app-muted mt-1 text-sm sm:text-base">{t('projects.subtitle')}</p>
        </div>
        {canCreateProject && (
          <div className="flex gap-2 sm:gap-3">
            <Button
              onClick={() => setIsCreatePackageModalOpen(true)}
              variant="outline"
              className="flex-1 sm:flex-none min-h-[44px]"
            >
              <Package size={18} />
              <span className="hidden sm:inline ml-2">Create Package</span>
              <span className="sm:hidden ml-1">Package</span>
            </Button>
            <Button
              onClick={() => setIsCreateModalOpen(true)}
              className="flex-1 sm:flex-none bg-primary-950 hover:bg-primary-900 min-h-[44px]"
            >
              <Plus size={18} />
              <span className="hidden sm:inline ml-2">{t('projects.createProject')}</span>
              <span className="sm:hidden ml-1">Project</span>
            </Button>
          </div>
        )}
      </div>

      {/* Summary Stats */}
      {projects.length > 0 && (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
          <motion.div
            whileHover={{ y: -4 }}
            whileTap={{ scale: 0.98 }}
          >
            <Card
              className="cursor-pointer hover:shadow-lg transition-all duration-200 hover:border-primary-600"
              onClick={() => {
                setStatusFilter('all');
                setSearchQuery('');
              }}
            >
              <CardContent className="p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-app-muted">{t('projects.totalProjects')}</p>
                    <p className="text-2xl font-bold mt-1 text-app-heading">{projects.length}</p>
                  </div>
                  <FolderOpen className="text-primary-600" size={32} />
                </div>
              </CardContent>
            </Card>
          </motion.div>
          <motion.div
            whileHover={{ y: -4 }}
            whileTap={{ scale: 0.98 }}
          >
            <Card
              className="cursor-pointer hover:shadow-lg transition-all duration-200 hover:border-primary-600"
              onClick={() => {
                setStatusFilter('In Progress');
              }}
            >
              <CardContent className="p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-app-muted">{t('common.inProgress')}</p>
                    <p className="text-2xl font-bold mt-1 text-app-heading">
                      {projects.filter((p) => p.status === 'In Progress').length}
                    </p>
                  </div>
                  <TrendingUp className="text-blue-600" size={32} />
                </div>
              </CardContent>
            </Card>
          </motion.div>
          <motion.div
            whileHover={{ y: -4 }}
            whileTap={{ scale: 0.98 }}
          >
            <Card
              className="cursor-pointer hover:shadow-lg transition-all duration-200 hover:border-primary-600"
              onClick={() => {
                setStatusFilter('Completed');
              }}
            >
              <CardContent className="p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-app-muted">{t('common.completed')}</p>
                    <p className="text-2xl font-bold mt-1 text-app-heading">
                      {projects.filter((p) => p.status === 'Completed').length}
                    </p>
                  </div>
                  <TrendingUp className="text-green-600" size={32} />
                </div>
              </CardContent>
            </Card>
          </motion.div>
          <motion.div
            whileHover={{ y: -4 }}
            whileTap={{ scale: 0.98 }}
          >
            <Card
              className="cursor-pointer hover:shadow-lg transition-all duration-200 hover:border-primary-600"
              onClick={() => {
                setStatusFilter('all');
                setSearchQuery('');
              }}
            >
              <CardContent className="p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-app-muted">{t('projects.totalBudget')}</p>
                    <p className="text-lg font-bold mt-1 text-app-heading">
                      {formatCurrency(projects.filter(p => p.status === 'In Progress' || p.status === 'Completed').reduce((sum, p) => sum + Number(p.budget || 0), 0))}
                    </p>
                  </div>
                  <DollarSign className="text-primary-600" size={32} />
                </div>
              </CardContent>
            </Card>
          </motion.div>
        </div>
      )}

      {/* Filters */}
      <Card>
        <CardContent className="p-4">
          <div className="flex flex-col gap-4">
            {/* Search and Filter Toggle Row */}
            <div className="flex flex-col sm:flex-row gap-3">
              <div className="flex-1 relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-app-muted" size={18} />
                <input
                  type="text"
                  placeholder={t('projects.searchPlaceholder')}
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="w-full pl-10 pr-4 py-2.5 border border-app bg-app-card text-app-heading rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  aria-label="Search projects"
                />
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => setShowFilters(!showFilters)}
                  className={`flex items-center gap-2 px-4 py-2.5 rounded-lg border transition-colors ${showFilters || hasActiveFilters
                    ? 'bg-primary-50 border-primary-300 text-primary-700 dark:bg-blue-900/30 dark:border-blue-600 dark:text-blue-300'
                    : 'border-app bg-app-card text-app-muted hover:bg-app-surface'
                    }`}
                >
                  <Filter size={18} />
                  <span className="hidden sm:inline">Filters</span>
                  {hasActiveFilters && (
                    <span className="bg-primary-600 text-white text-xs px-1.5 py-0.5 rounded-full">
                      {[statusFilter !== 'all', categoryFilter !== 'all', divisionFilter !== 'all'].filter(Boolean).length}
                    </span>
                  )}
                </button>
                {hasActiveFilters && (
                  <button
                    onClick={clearAllFilters}
                    className="flex items-center gap-1 px-3 py-2.5 rounded-lg border border-app bg-app-card text-app-muted hover:bg-red-50 hover:text-red-600 hover:border-red-200 dark:hover:bg-red-900/20 dark:hover:text-red-400 transition-colors"
                    title="Clear all filters"
                  >
                    <X size={16} />
                    <span className="hidden sm:inline">Clear</span>
                  </button>
                )}
              </div>
            </div>

            {/* Expanded Filters */}
            {showFilters && (
              <motion.div
                initial={{ height: 0, opacity: 0 }}
                animate={{ height: 'auto', opacity: 1 }}
                exit={{ height: 0, opacity: 0 }}
                className="grid grid-cols-1 sm:grid-cols-3 gap-3 pt-3 border-t border-app-subtle"
              >
                <div>
                  <label className="block text-xs font-medium text-app-muted mb-1.5">Status</label>
                  <select
                    value={statusFilter}
                    onChange={(e) => setStatusFilter(e.target.value)}
                    className="w-full px-3 py-2 border border-app bg-app-card text-app-heading rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                  >
                    <option value="all">{t('projects.allStatus')}</option>
                    <option value="Planning">{t('status.planning')}</option>
                    <option value="In Progress">{t('status.inProgress')}</option>
                    <option value="On Hold">{t('status.onHold')}</option>
                    <option value="Completed">{t('status.completed')}</option>
                    <option value="Cancelled">{t('status.cancelled')}</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-medium text-app-muted mb-1.5">Category</label>
                  <select
                    value={categoryFilter}
                    onChange={(e) => setCategoryFilter(e.target.value)}
                    className="w-full px-3 py-2 border border-app bg-app-card text-app-heading rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                  >
                    <option value="all">All Categories</option>
                    {categories.map(cat => (
                      <option key={cat} value={cat}>{cat}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-medium text-app-muted mb-1.5">Division</label>
                  <select
                    value={divisionFilter}
                    onChange={(e) => setDivisionFilter(e.target.value)}
                    className="w-full px-3 py-2 border border-app bg-app-card text-app-heading rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                  >
                    <option value="all">All Divisions</option>
                    {divisions.map(div => (
                      <option key={div} value={div}>{div}</option>
                    ))}
                  </select>
                </div>
              </motion.div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Projects Grid */}
      {filteredProjects.length === 0 ? (
        <Card>
          <CardContent>
            <EmptyState
              icon={FolderOpen}
              title={t('projects.noProjectsFound')}
              description={
                searchQuery || statusFilter !== 'all'
                  ? t('projects.adjustFilters')
                  : canCreateProject
                    ? t('projects.getStarted')
                    : t('projects.noProjectsAvailable')
              }
              actionLabel={canCreateProject && !searchQuery && statusFilter === 'all' ? t('projects.createProject') : undefined}
              onAction={canCreateProject && !searchQuery && statusFilter === 'all' ? () => setIsCreateModalOpen(true) : undefined}
            />
          </CardContent>
        </Card>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredProjects.map((project) => (
            <motion.div
              key={project.id}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.3 }}
            >
              <Card
                className="h-full hover:shadow-lg transition-shadow cursor-pointer"
                onClick={() => {
                  setSelectedProject(project);
                  setIsDetailModalOpen(true);
                }}
              >
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div className="flex-1 min-w-0 pr-2">
                      <CardTitle className="text-xl font-bold mb-2 text-app-heading leading-tight">{project.name}</CardTitle>
                      <p className="text-sm text-app-muted line-clamp-2">{project.description}</p>
                    </div>
                    <span
                      className={`px-2 py-1 rounded text-xs font-medium flex-shrink-0 ${getStatusBadgeColor(project.status)}`}
                    >
                      {project.status}
                    </span>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {/* Project Progress */}
                    <div>
                      <div className="flex items-center justify-between text-sm mb-2">
                        <span className="text-app-muted">{t('common.progress')}</span>
                        <span className="font-semibold text-primary-600 dark:text-primary-400">{project.progress}%</span>
                      </div>
                      <div className="w-full h-2 bg-app-secondary rounded-full overflow-hidden">
                        <motion.div
                          initial={{ width: 0 }}
                          animate={{ width: `${project.progress}%` }}
                          transition={{ duration: 0.5 }}
                          className={`h-2 rounded-full transition-all ${project.progress === 100
                            ? 'bg-success-600'
                            : project.progress >= 50
                              ? 'bg-primary-600'
                              : 'bg-warning-500'
                            }`}
                        />
                      </div>
                    </div>

                    {/* Budget Utilization */}
                    <div>
                      <div className="flex items-center justify-between text-sm mb-2">
                        <span className="text-app-muted">{t('projects.budgetUtilization')}</span>
                        <span className="font-semibold text-primary-600 dark:text-primary-400">
                          {calculateBudgetUtilization(project.budget, project.spent).toFixed(1)}%
                        </span>
                      </div>
                      <div className="w-full h-2 bg-app-secondary rounded-full overflow-hidden">
                        <motion.div
                          initial={{ width: 0 }}
                          animate={{ width: `${Math.min((project.spent / project.budget) * 100, 100)}%` }}
                          transition={{ duration: 0.5 }}
                          className={`h-2 rounded-full transition-all ${(project.spent / project.budget) * 100 > 90
                            ? 'bg-error-600'
                            : (project.spent / project.budget) * 100 > 75
                              ? 'bg-warning-500'
                              : 'bg-success-600'
                            }`}
                        />
                      </div>
                    </div>

                    {/* Land Acquisition Status */}
                    {project.land_data ? (
                      <LandStats project={project} />
                    ) : project.landAcquisitionStatus !== undefined ? (
                      <div>
                        <div className="flex items-center justify-between text-sm mb-2">
                          <span className="text-app-muted">Land Acquisition Status</span>
                          <span className="font-semibold text-primary-600 dark:text-primary-400">
                            {project.landAcquisitionStatus}%
                          </span>
                        </div>
                        <div className="w-full h-2 bg-app-secondary rounded-full overflow-hidden">
                          <motion.div
                            initial={{ width: 0 }}
                            animate={{ width: `${project.landAcquisitionStatus}%` }}
                            transition={{ duration: 0.5, delay: 0.2 }}
                            className={`h-2 rounded-full transition-all ${project.landAcquisitionStatus > 90
                              ? 'bg-green-600'
                              : project.landAcquisitionStatus > 50
                                ? 'bg-yellow-500'
                                : 'bg-red-500'
                              }`}
                          />
                        </div>
                      </div>
                    ) : null}
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          ))}
        </div>
      )}

      <CreateProjectModal
        isOpen={isCreateModalOpen}
        onClose={() => setIsCreateModalOpen(false)}
        onSave={handleCreateProject}
      />

      <ProjectDetailModal
        isOpen={!!selectedProject}
        onClose={() => setSelectedProject(null)}
        project={selectedProject}
        packages={packages.filter(p => p.project === selectedProject?.id)}
        contractors={contractors}
      />

      <CreatePackageModal
        isOpen={isCreatePackageModalOpen}
        onClose={() => setIsCreatePackageModalOpen(false)}
        projects={projects}
        onSave={async (packageData) => {
          try {
            await projectService.createWorkPackage(packageData);
            toast.success('Work package created');
            setIsCreatePackageModalOpen(false);
            fetchData();
          } catch (error) {
            console.error('Failed to create package:', error);
            toast.error('Failed to create work package');
          }
        }}
      />
    </div>
  );
};

export default Projects;




================================================
FILE: frontend/src/pages/RABilling.jsx
================================================
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    IndianRupee,
    Plus,
    Filter,
    Search,
    Download,
    FileText,
    Calculator,
    MoreVertical,
    Eye,
    Printer,
    CheckCircle2
} from 'lucide-react';
import { Card } from '@/components/ui/Card';
import Button from '@/components/ui/Button';
import { EmptyState } from '@/components/ui/EmptyState';
import financeService from '@/services/financeService'; // Real Service
import projectService from '@/services/projectService';
import userService from '@/services/userService';
import { GenerateBillModal } from '@/components/billing/GenerateBillModal';
import BillDetailModal from '@/components/billing/BillDetailModal';
import { RABillTemplate } from '@/components/billing/RABillTemplate';
import { useRef } from 'react';
import { toast } from 'sonner';
import { useAuth } from '@/contexts/AuthContext';

const RABilling = () => {
    // State for Real Data
    const [raBills, setRaBills] = useState([]);
    const [projects, setProjects] = useState([]);
    const [contractors, setContractors] = useState([]);
    const [loading, setLoading] = useState(true);

    const [searchQuery, setSearchQuery] = useState('');
    const [isGenerateModalOpen, setIsGenerateModalOpen] = useState(false);
    const [selectedBillForDetail, setSelectedBillForDetail] = useState(null);

    // For printing from the list
    const [selectedBillForPrint, setSelectedBillForPrint] = useState(null);

    const { user } = useAuth();
    const canCreateBill = user?.role === 'EPC_Contractor';

    // 1. Fetch Data on Mount
    useEffect(() => {
        const fetchData = async () => {
            try {
                setLoading(true);
                const [billsData, projectsData, usersData] = await Promise.all([
                    financeService.getBills(),
                    projectService.getAllProjects(),
                    userService.getUsers()
                ]);

                setRaBills(billsData);
                setProjects(projectsData);

                // Filter only EPC Contractors and format for dropdown
                const validContractors = usersData
                    .filter(u => u.role === 'EPC_Contractor')
                    .map(u => ({
                        ...u,
                        contractorName: u.company_name || u.username // Fallback if company name missing
                    }));
                setContractors(validContractors);
            } catch (error) {
                console.error("Failed to fetch billing data", error);
                toast.error("Failed to load data");
            } finally {
                setLoading(false);
            }
        };
        fetchData();
    }, []);

    // Trigger print when a bill is selected
    const triggerPrint = (bill) => {
        setSelectedBillForPrint(bill);
        // Wait for state to render the template then print
        setTimeout(() => {
            window.print();
            // Clear selection after a delay to allow print dialogue to capture content
            setTimeout(() => setSelectedBillForPrint(null), 2000);
        }, 500);
    };

    const handleGenerateBill = async (data) => {
        try {
            // Call API
            const newBill = await financeService.createBill(data);
            setRaBills(prev => [newBill, ...prev]); // Add to list (optimistic/immediate)
            toast.success("RA Bill Generated Successfully");
            // Modal closes itself or changes state via its own onSave verification
        } catch (error) {
            console.error(error);
            toast.error("Failed to generate bill");
        }
    };

    const handleExportSummary = () => {
        if (!raBills.length) {
            toast.error("No bills to export");
            return;
        }

        const headers = [
            "Bill No", "Date", "Project", "Contractor", "Gross Amount", "GST Amount",
            "Total Amount", "TDS", "Labour Cess", "Retention", "Net Payable", "Status"
        ];

        const rows = raBills.map(bill => [
            bill.billNo,
            bill.submissionDate,
            bill.projectName,
            bill.contractorName,
            bill.grossAmount,
            bill.gstAmount,
            bill.totalAmount,
            bill.tdsAmount,
            bill.labourCessAmount,
            bill.retentionAmount,
            bill.netPayable,
            bill.status
        ]);

        const csvContent = [
            headers.join(','),
            ...rows.map(r => r.join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `RA_Bills_Summary_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const filteredBills = raBills.filter(bill =>
        bill.billNo?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        bill.projectName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        bill.contractorName?.toLowerCase().includes(searchQuery.toLowerCase())
    );

    const totalBilled = raBills.reduce((acc, curr) => acc + (parseFloat(curr.netPayable) || 0), 0);

    return (
        <div className="p-6 space-y-6 print:hidden">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-heading font-bold text-app-heading">RA Billing Register</h1>
                    <p className="text-app-muted mt-1">Manage Contractor Running Account Bills and Certifications</p>
                </div>
                <div className="flex gap-2">
                    <Button variant="outline" onClick={handleExportSummary} className="gap-2">
                        <Download size={18} /> Export Summary
                    </Button>
                    {canCreateBill && (
                        <Button
                            onClick={() => setIsGenerateModalOpen(true)}
                            className="flex items-center gap-2 bg-primary-950 text-white hover:bg-primary-900 shadow-lg"
                        >
                            <Plus size={18} /> Generate New Bill
                        </Button>
                    )}
                </div>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {[
                    { label: 'Total Bills Generated', value: raBills.length, icon: FileText, color: 'text-blue-600', bg: 'bg-blue-50' },
                    { label: 'Total Net Payable', value: new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(totalBilled), icon: IndianRupee, color: 'text-emerald-600', bg: 'bg-emerald-50' },
                    { label: 'Pending Approvals', value: '0', icon: CheckCircle2, color: 'text-amber-600', bg: 'bg-amber-50' },
                ].map((stat, index) => (
                    <motion.div
                        key={index}
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: index * 0.1 }}
                    >
                        <Card className="p-6 flex items-center gap-4 hover:shadow-lg transition-shadow duration-300">
                            <div className={`p-4 rounded-xl ${stat.bg}`}>
                                <stat.icon className={stat.color} size={24} />
                            </div>
                            <div>
                                <p className="text-sm font-medium text-app-muted">{stat.label}</p>
                                <h3 className="text-2xl font-bold text-app-heading">{stat.value}</h3>
                            </div>
                        </Card>
                    </motion.div>
                ))}
            </div>

            {/* Toolbar */}
            <Card className="p-4">
                <div className="flex flex-col md:flex-row gap-4">
                    <div className="relative flex-1">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" size={20} />
                        <input
                            type="text"
                            placeholder="Search by Bill No, Project, or Contractor..."
                            className="w-full pl-10 pr-4 py-2 rounded-lg border border-app bg-app-input text-app-text focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>
                </div>
            </Card>

            {/* List */}
            {filteredBills.length > 0 ? (
                <div className="bg-app-card rounded-xl shadow-sm border border-app-subtle overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-app-surface border-b border-app-subtle">
                                <tr>
                                    <th className="px-6 py-4 font-semibold text-app-muted">Bill No</th>
                                    <th className="px-6 py-4 font-semibold text-app-muted">Date</th>
                                    <th className="px-6 py-4 font-semibold text-app-muted">Project</th>
                                    <th className="px-6 py-4 font-semibold text-app-muted">Contractor</th>
                                    <th className="px-6 py-4 font-semibold text-app-muted text-right">Gross Amount</th>
                                    <th className="px-6 py-4 font-semibold text-app-muted text-right">Net Payable</th>
                                    <th className="px-6 py-4 font-semibold text-app-muted">Status</th>
                                    <th className="px-6 py-4 font-semibold text-app-muted text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                                {filteredBills.map((bill, index) => (
                                    <motion.tr
                                        key={bill.id}
                                        initial={{ opacity: 0 }}
                                        animate={{ opacity: 1 }}
                                        transition={{ delay: index * 0.05 }}
                                        className="hover:bg-app-surface/50 transition-colors"
                                    >
                                        <td className="px-6 py-4 font-mono font-medium text-app-muted">{bill.billNo}</td>
                                        <td className="px-6 py-4 text-app-muted">{bill.submissionDate}</td>
                                        <td className="px-6 py-4 font-medium text-app-heading">{bill.projectName}</td>
                                        <td className="px-6 py-4 text-app-muted">{bill.contractorName}</td>
                                        <td className="px-6 py-4 text-right text-app-muted">
                                            {new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(bill.grossAmount)}
                                        </td>
                                        <td className="px-6 py-4 text-right font-bold text-emerald-600">
                                            {new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(bill.netPayable)}
                                        </td>
                                        <td className="px-6 py-4">
                                            <span className="px-2 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">
                                                {bill.status}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-right">
                                            <div className="flex items-center justify-end gap-1">
                                                <Button
                                                    variant="ghost"
                                                    size="sm"
                                                    onClick={() => setSelectedBillForDetail(bill)}
                                                    className="text-app-muted hover:text-primary-600"
                                                    title="View Details"
                                                >
                                                    <Eye size={18} />
                                                </Button>
                                                <Button
                                                    variant="ghost"
                                                    size="sm"
                                                    onClick={() => triggerPrint(bill)}
                                                    className="text-app-muted hover:text-primary-600"
                                                    title="Print Bill"
                                                >
                                                    <Printer size={18} />
                                                </Button>
                                            </div>
                                        </td>
                                    </motion.tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            ) : (
                <EmptyState
                    icon={Calculator}
                    title="No RA Bills Generated"
                    description={
                        searchQuery
                            ? "No bills match your search."
                            : (canCreateBill ? "Generate your first RA Bill to get started." : "No bills have been submitted yet.")
                    }
                    actionLabel={canCreateBill ? "Generate New Bill" : undefined}
                    onAction={canCreateBill ? () => setIsGenerateModalOpen(true) : undefined}
                />
            )}

            <GenerateBillModal
                isOpen={isGenerateModalOpen}
                onClose={() => setIsGenerateModalOpen(false)}
                onSave={handleGenerateBill}
                projects={projects}
                contractors={contractors}
            />

            {/* Hidden Template for Printing List Items */}
            {selectedBillForPrint && (
                <div className="hidden">
                    <RABillTemplate
                        bill={selectedBillForPrint}
                        project={projects.find(p => p.id === selectedBillForPrint?.projectId)}
                        contractor={contractors.find(c => c.id === selectedBillForPrint?.contractorId)}
                    />
                </div>
            )}

            {/* Bill Detail Modal with Workflow Card */}
            <BillDetailModal
                isOpen={!!selectedBillForDetail}
                onClose={() => setSelectedBillForDetail(null)}
                bill={selectedBillForDetail}
                onBillUpdate={async () => {
                    // Refetch bills after workflow action
                    try {
                        const billsData = await financeService.getBills();
                        setRaBills(billsData);
                        // Update the selected bill if still viewing it
                        if (selectedBillForDetail) {
                            const updated = billsData.find(b => b.id === selectedBillForDetail.id);
                            if (updated) setSelectedBillForDetail(updated);
                        }
                    } catch (error) {
                        console.error('Failed to refresh bills:', error);
                    }
                }}
            />
        </div>
    );
};

export default RABilling;




================================================
FILE: frontend/src/pages/Reimbursement.jsx
================================================
import { useState, useEffect } from 'react';
import { useLanguage } from '@/contexts/LanguageContext';
import { useAuth } from '@/contexts/AuthContext';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import Button from '@/components/ui/Button';
import { Upload, Send, FileText, Loader2 } from 'lucide-react';
import { toast } from 'sonner';
import projectService from '@/api/services/projectService';

const Reimbursement = () => {
  const { t } = useLanguage();
  const { user } = useAuth();

  // Real data state
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(true);

  const [formData, setFormData] = useState({
    expenseType: '',
    amount: '',
    projectReference: '',
    description: '',
  });
  const [proofFile, setProofFile] = useState(null);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Fetch real projects
  useEffect(() => {
    const fetchProjects = async () => {
      try {
        const data = await projectService.getAllProjects();
        setProjects(data || []);
      } catch (error) {
        console.error('Failed to fetch projects:', error);
      } finally {
        setLoading(false);
      }
    };
    fetchProjects();
  }, []);

  const expenseTypes = ['Travel', 'Meals', 'Accommodation', 'Materials', 'Other'];

  const handleFileChange = (e) => {
    if (e.target.files && e.target.files[0]) {
      setProofFile(e.target.files[0]);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsSubmitting(true);

    // Simulate form submission
    await new Promise((resolve) => setTimeout(resolve, 1500));

    const billNumber = `BILL-${Date.now()}`;
    toast.success('Reimbursement submitted successfully!', {
      description: `Email sent to Finance Dept regarding ${billNumber}`,
    });

    // Reset form
    setFormData({
      expenseType: '',
      amount: '',
      projectReference: '',
      description: '',
    });
    setProofFile(null);
    setIsSubmitting(false);
  };

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-heading font-bold text-app-heading">Staff Reimbursement</h1>
        <p className="text-app-muted mt-1">Submit reimbursement requests for project-related expenses</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Reimbursement Form</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label className="text-sm font-medium text-app-text mb-2 block">
                Expense Type <span className="text-red-500">*</span>
              </label>
              <select
                value={formData.expenseType}
                onChange={(e) => setFormData({ ...formData, expenseType: e.target.value })}
                required
                className="w-full px-4 py-2 border border-app rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-primary-600 bg-app-input text-app-text"
              >
                <option value="">Select expense type</option>
                {expenseTypes.map((type) => (
                  <option key={type} value={type}>
                    {type}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="text-sm font-medium text-app-text mb-2 block">
                Amount (â‚¹) <span className="text-red-500">*</span>
              </label>
              <input
                type="number"
                value={formData.amount}
                onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                required
                min="0"
                step="0.01"
                placeholder="0.00"
                className="w-full px-4 py-2 border border-app rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-primary-600 bg-app-input text-app-text"
              />
            </div>

            <div>
              <label className="text-sm font-medium text-app-text mb-2 block">
                Project Reference <span className="text-red-500">*</span>
              </label>
              <select
                value={formData.projectReference}
                onChange={(e) => setFormData({ ...formData, projectReference: e.target.value })}
                required
                className="w-full px-4 py-2 border border-app rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-primary-600 bg-app-input text-app-text"
              >
                <option value="">Select project</option>
                {projects.map((project) => (
                  <option key={project.id} value={project.id}>
                    {project.name}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="text-sm font-medium text-app-text mb-2 block">Description</label>
              <textarea
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                rows={4}
                placeholder="Describe the expense..."
                className="w-full px-4 py-2 border border-app rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-primary-600 resize-none bg-app-input text-app-text"
              />
            </div>

            <div>
              <label className="text-sm font-medium text-app-text mb-2 block">
                Proof of Payment <span className="text-red-500">*</span>
              </label>
              <div className="border-2 border-dashed border-app-subtle rounded-lg p-6 text-center hover:border-primary-600 transition-colors">
                <input
                  type="file"
                  id="proof-upload"
                  onChange={handleFileChange}
                  accept=".pdf,.jpg,.jpeg,.png"
                  className="hidden"
                  required
                />
                <label htmlFor="proof-upload" className="cursor-pointer">
                  {proofFile ? (
                    <div className="flex items-center justify-center gap-2 text-primary-600">
                      <FileText size={24} />
                      <span className="font-medium">{proofFile.name}</span>
                    </div>
                  ) : (
                    <div className="flex flex-col items-center gap-2">
                      <Upload size={32} className="text-app-muted-light" />
                      <span className="text-sm text-app-muted">Click to upload or drag and drop</span>
                      <span className="text-xs text-app-muted">PDF, JPG, PNG (max 10MB)</span>
                    </div>
                  )}
                </label>
              </div>
            </div>

            <div className="flex justify-end gap-3">
              <Button type="button" variant="outline" onClick={() => {
                setFormData({ expenseType: '', amount: '', projectReference: '', description: '' });
                setProofFile(null);
              }}>
                Clear
              </Button>
              <Button type="submit" disabled={isSubmitting}>
                <Send size={18} />
                {isSubmitting ? 'Submitting...' : 'Submit Reimbursement'}
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
};

export default Reimbursement;









================================================
FILE: frontend/src/pages/ResetPassword.jsx
================================================
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Link, useParams, useNavigate } from 'react-router-dom';
import {
    Lock, Eye, EyeOff, CheckCircle2,
    AlertCircle, Loader2, ArrowLeft, KeyRound
} from 'lucide-react';
import { toast } from 'sonner';
import api from '@/api/client';

const ResetPassword = () => {
    const { token } = useParams();
    const navigate = useNavigate();
    const [isLoading, setIsLoading] = useState(true);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [isSuccess, setIsSuccess] = useState(false);
    const [tokenInfo, setTokenInfo] = useState(null);
    const [error, setError] = useState(null);

    const [showPassword, setShowPassword] = useState(false);
    const [showConfirmPassword, setShowConfirmPassword] = useState(false);
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [errors, setErrors] = useState({});

    useEffect(() => {
        validateToken();
    }, [token]);

    const validateToken = async () => {
        setIsLoading(true);
        try {
            const response = await api.get(`/users/password-reset/confirm/?token=${token}`);
            setTokenInfo(response.data);
        } catch (err) {
            console.error('Token validation failed:', err);
            setError(err.response?.data?.error || 'Invalid or expired reset link');
        } finally {
            setIsLoading(false);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        const newErrors = {};
        if (!password) newErrors.password = 'Password is required';
        else if (password.length < 8) newErrors.password = 'Password must be at least 8 characters';
        if (password !== confirmPassword) newErrors.confirmPassword = 'Passwords do not match';

        if (Object.keys(newErrors).length > 0) {
            setErrors(newErrors);
            return;
        }

        setIsSubmitting(true);
        try {
            await api.post('/users/password-reset/confirm/', {
                token,
                password,
                confirm_password: confirmPassword
            });
            setIsSuccess(true);
            toast.success('Password reset successfully!');
        } catch (err) {
            console.error('Password reset failed:', err);
            if (err.response?.data) {
                const errors = err.response.data;
                setErrors(errors);

                if (errors.password) {
                    toast.error(Array.isArray(errors.password) ? errors.password[0] : errors.password);
                } else if (errors.token) {
                    toast.error(Array.isArray(errors.token) ? errors.token[0] : errors.token);
                } else if (errors.confirm_password) {
                    toast.error(Array.isArray(errors.confirm_password) ? errors.confirm_password[0] : errors.confirm_password);
                } else {
                    toast.error('Failed to reset password. Please try again.');
                }
            } else {
                toast.error('Failed to reset password. Please try again.');
            }
        } finally {
            setIsSubmitting(false);
        }
    };

    if (isLoading) {
        return (
            <div className="min-h-screen bg-app-base flex items-center justify-center">
                <div className="text-center text-app-text">
                    <Loader2 className="w-10 h-10 animate-spin mx-auto mb-4" />
                    <p>Validating reset link...</p>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="min-h-screen bg-app-base flex items-center justify-center p-4">
                <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="bg-app-card rounded-3xl shadow-xl p-8 max-w-md w-full text-center"
                >
                    <div className="w-20 h-20 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <AlertCircle className="w-10 h-10 text-red-600 dark:text-red-400" />
                    </div>
                    <h1 className="text-2xl font-bold text-app-heading mb-3">Invalid Reset Link</h1>
                    <p className="text-app-muted mb-6">{error}</p>
                    <div className="space-y-3">
                        <Link
                            to="/forgot-password"
                            className="inline-flex items-center gap-2 px-6 py-3 bg-amber-500 text-white rounded-xl font-semibold hover:bg-amber-600 transition-colors"
                        >
                            Request New Link
                        </Link>
                        <br />
                        <Link
                            to="/login"
                            className="text-sm text-slate-600 hover:text-primary-600 inline-flex items-center gap-1"
                        >
                            <ArrowLeft size={14} /> Back to Login
                        </Link>
                    </div>
                </motion.div>
            </div>
        );
    }

    if (isSuccess) {
        return (
            <div className="min-h-screen bg-app-base flex items-center justify-center p-4">
                <motion.div
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="bg-app-card rounded-3xl shadow-xl p-8 max-w-md w-full text-center"
                >
                    <div className="w-20 h-20 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <CheckCircle2 className="w-10 h-10 text-green-600 dark:text-green-400" />
                    </div>
                    <h1 className="text-2xl font-bold text-app-heading mb-3">Password Reset!</h1>
                    <p className="text-app-muted mb-6">
                        Your password has been successfully reset. You can now log in with your new password.
                    </p>
                    <Link
                        to="/login"
                        className="inline-flex items-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700 transition-colors"
                    >
                        Go to Login
                    </Link>
                </motion.div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-app-base flex items-center justify-center p-4">
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                className="bg-app-card dark:bg-neutral-900 rounded-3xl shadow-xl w-full max-w-md overflow-hidden"
                style={{ boxShadow: '0 0 60px rgba(251, 191, 36, 0.15)' }}
            >
                {/* Header */}
                <div className="bg-gradient-to-r from-amber-500 to-amber-600 p-6 text-white text-center">
                    <div className="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <KeyRound className="w-8 h-8 text-white" />
                    </div>
                    <h1 className="text-xl font-bold text-white">Reset Your Password</h1>
                    <p className="text-white text-sm mt-2 opacity-90">PMIS - Zaheerabad Industrial Area</p>
                </div>

                {/* User Info */}
                {tokenInfo && (
                    <div className="p-4 bg-amber-50 dark:bg-amber-900/10 border-b border-amber-100 dark:border-amber-900/30 text-center">
                        <p className="text-sm text-app-muted">Resetting password for</p>
                        <p className="text-app-heading font-semibold">{tokenInfo.email}</p>
                    </div>
                )}

                {/* Password Form */}
                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                    <p className="text-app-muted text-sm mb-4">
                        Please enter your new password below.
                    </p>

                    <div>
                        <label className="block text-sm font-medium text-app-text mb-1.5">
                            New Password <span className="text-red-500">*</span>
                        </label>
                        <div className="relative">
                            <Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" size={18} />
                            <input
                                type={showPassword ? 'text' : 'password'}
                                value={password}
                                onChange={(e) => {
                                    setPassword(e.target.value);
                                    if (errors.password) setErrors(prev => ({ ...prev, password: '' }));
                                }}
                                placeholder="Enter new password (min 8 characters)"
                                className={`w-full px-4 py-2.5 pl-10 pr-10 rounded-xl border transition-all outline-none focus:ring-2 bg-app-input text-app-text ${errors.password
                                    ? 'border-red-300 dark:border-red-500/50 focus:border-red-500 focus:ring-red-100'
                                    : 'border-app focus:border-amber-500 focus:ring-amber-100 dark:focus:ring-amber-900/30'
                                    }`}
                            />
                            <button
                                type="button"
                                onClick={() => setShowPassword(!showPassword)}
                                className="absolute right-3 top-1/2 -translate-y-1/2 text-app-muted hover:text-app-text"
                            >
                                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                            </button>
                        </div>
                        {errors.password && (
                            <p className="mt-1 text-sm text-red-500 flex items-center gap-1">
                                <AlertCircle size={14} /> {errors.password}
                            </p>
                        )}
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-app-text mb-1.5">
                            Confirm Password <span className="text-red-500">*</span>
                        </label>
                        <div className="relative">
                            <Lock className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" size={18} />
                            <input
                                type={showConfirmPassword ? 'text' : 'password'}
                                value={confirmPassword}
                                onChange={(e) => {
                                    setConfirmPassword(e.target.value);
                                    if (errors.confirmPassword) setErrors(prev => ({ ...prev, confirmPassword: '' }));
                                }}
                                placeholder="Confirm new password"
                                className={`w-full px-4 py-2.5 pl-10 pr-10 rounded-xl border transition-all outline-none focus:ring-2 bg-app-input text-app-text ${errors.confirmPassword
                                    ? 'border-red-300 dark:border-red-500/50 focus:border-red-500 focus:ring-red-100'
                                    : 'border-app focus:border-amber-500 focus:ring-amber-100 dark:focus:ring-amber-900/30'
                                    }`}
                            />
                            <button
                                type="button"
                                onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                                className="absolute right-3 top-1/2 -translate-y-1/2 text-app-muted hover:text-app-text"
                            >
                                {showConfirmPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                            </button>
                        </div>
                        {errors.confirmPassword && (
                            <p className="mt-1 text-sm text-red-500 flex items-center gap-1">
                                <AlertCircle size={14} /> {errors.confirmPassword}
                            </p>
                        )}
                    </div>

                    <button
                        type="submit"
                        disabled={isSubmitting}
                        className="w-full py-3 bg-amber-500 text-white rounded-xl font-semibold hover:bg-amber-600 hover:shadow-lg active:scale-[0.98] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                        {isSubmitting ? (
                            <>
                                <Loader2 size={18} className="animate-spin" /> Resetting...
                            </>
                        ) : (
                            <>
                                <CheckCircle2 size={18} /> Reset Password
                            </>
                        )}
                    </button>
                </form>
            </motion.div>
        </div>
    );
};

export default ResetPassword;



================================================
FILE: frontend/src/pages/RiskManagement.jsx
================================================
import { useState, useEffect, useMemo } from 'react';
import { useLanguage } from '@/contexts/LanguageContext';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { DynamicChart } from '@/components/ui/DynamicChart';
import riskService from '@/api/services/riskService';
import projectService from '@/api/services/projectService';
import {
  AlertTriangle, CheckCircle, Clock, XCircle, Plus, Search,
  Filter, ChevronDown, ChevronRight, FileText, Shield,
  TrendingUp, TrendingDown, Calendar, User, Building,
  AlertCircle, Target, BarChart3, Loader2, RefreshCw
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import CreateRiskModal from '@/components/risks/CreateRiskModal';
import RiskDetailPanel from '@/components/risks/RiskDetailPanel';
import Button from '@/components/ui/Button';

const RiskManagement = () => {
  const { t } = useLanguage();

  // State
  const [risks, setRisks] = useState([]);
  const [projects, setProjects] = useState([]);
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Filters
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedProject, setSelectedProject] = useState('');
  const [selectedSeverity, setSelectedSeverity] = useState('');
  const [selectedStatus, setSelectedStatus] = useState('');

  // UI State
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [selectedRisk, setSelectedRisk] = useState(null);
  const [showDetailPanel, setShowDetailPanel] = useState(false);
  const [expandedProjects, setExpandedProjects] = useState({});

  // Fetch data
  useEffect(() => {
    fetchData();
  }, [selectedProject, selectedSeverity, selectedStatus]);

  const fetchData = async () => {
    setLoading(true);
    setError(null);
    try {
      const filters = {};
      if (selectedProject) filters.project = selectedProject;
      if (selectedSeverity) filters.severity = selectedSeverity;
      if (selectedStatus) filters.status = selectedStatus;

      const [risksRes, projectsRes, statsRes] = await Promise.all([
        riskService.getRisks(filters),
        projectService.getProjects(),
        riskService.getRiskStats()
      ]);

      // Handle paginated responses
      setRisks(risksRes.data?.results || risksRes.data || []);
      setProjects(projectsRes.data?.results || projectsRes.data || []);
      setStats(statsRes.data || null);
    } catch (err) {
      console.error('Failed to fetch risk data:', err);
      setError('Failed to load risk data. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  // Filter risks by search query
  const filteredRisks = useMemo(() => {
    if (!searchQuery) return risks;
    const query = searchQuery.toLowerCase();
    return risks.filter(risk =>
      risk.title?.toLowerCase().includes(query) ||
      risk.risk_code?.toLowerCase().includes(query) ||
      risk.description?.toLowerCase().includes(query) ||
      risk.project_name?.toLowerCase().includes(query)
    );
  }, [risks, searchQuery]);

  // Group risks by project
  const risksByProject = useMemo(() => {
    const grouped = {};
    filteredRisks.forEach(risk => {
      const projectId = risk.project;
      if (!grouped[projectId]) {
        grouped[projectId] = {
          projectName: risk.project_name || 'Unknown Project',
          risks: []
        };
      }
      grouped[projectId].risks.push(risk);
    });
    return grouped;
  }, [filteredRisks]);

  // Chart data
  const categoryData = useMemo(() => {
    const counts = {};
    risks.forEach(risk => {
      const cat = risk.category || 'OTHER';
      counts[cat] = (counts[cat] || 0) + 1;
    });
    return Object.entries(counts).map(([name, value]) => ({
      name: riskService.CATEGORIES.find(c => c.value === name)?.label || name,
      value
    }));
  }, [risks]);

  const severityData = useMemo(() => {
    if (!stats) return [];
    return [
      { name: 'Critical', value: stats.by_severity?.critical || 0, color: '#ef4444' },
      { name: 'High', value: stats.by_severity?.high || 0, color: '#f97316' },
      { name: 'Medium', value: stats.by_severity?.medium || 0, color: '#eab308' },
      { name: 'Low', value: stats.by_severity?.low || 0, color: '#22c55e' }
    ];
  }, [stats]);

  // Handlers
  const handleRiskClick = (risk) => {
    setSelectedRisk(risk);
    setShowDetailPanel(true);
  };

  const handleCreateSuccess = (newRisk) => {
    setRisks(prev => [newRisk, ...prev]);
    setShowCreateModal(false);
    fetchData(); // Refresh stats
  };

  const handleUpdateSuccess = (updatedRisk) => {
    setRisks(prev => prev.map(r => r.id === updatedRisk.id ? updatedRisk : r));
    setSelectedRisk(updatedRisk);
    fetchData(); // Refresh stats
  };

  const toggleProjectExpand = (projectId) => {
    setExpandedProjects(prev => ({
      ...prev,
      [projectId]: !prev[projectId]
    }));
  };

  // Severity badge component
  const SeverityBadge = ({ severity }) => {
    const colors = riskService.getSeverityColor(severity);
    return (
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${colors.bg} ${colors.text}`}>
        {severity}
      </span>
    );
  };

  // Status badge component
  const StatusBadge = ({ status }) => {
    const colors = riskService.getStatusColor(status);
    const statusLabel = riskService.STATUSES.find(s => s.value === status)?.label || status;
    return (
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${colors.bg} ${colors.text}`}>
        {statusLabel}
      </span>
    );
  };

  // Loading state
  if (loading && risks.length === 0) {
    return (
      <div className="flex items-center justify-center h-64">
        <Loader2 className="w-8 h-8 animate-spin text-primary-600" />
        <span className="ml-2 text-app-muted">Loading risk data...</span>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-app-heading flex items-center gap-2">
            <Shield className="text-orange-600" />
            {t('common.risk') || 'Risk Management'}
          </h1>
          <p className="text-app-muted mt-1">
            {t('risk.subtitle') || 'Identify, assess, and mitigate project risks'}
          </p>
        </div>
        <Button
          onClick={() => setShowCreateModal(true)}
          className="min-h-[44px]"
        >
          <Plus size={20} />
          Add New Risk
        </Button>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        {/* Total Risks */}
        <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200 dark:from-blue-900/30 dark:to-blue-800/30 dark:border-blue-800">
          <CardContent className="p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-blue-700 dark:text-blue-300 font-medium">Total Risks</p>
                <p className="text-3xl font-bold text-blue-900 dark:text-blue-100 mt-1">{stats?.total || 0}</p>
              </div>
              <div className="p-3 bg-blue-500/20 rounded-xl">
                <BarChart3 className="text-blue-600" size={28} />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Critical Risks */}
        <Card className="bg-gradient-to-br from-red-50 to-red-100 border-red-200 dark:from-red-900/30 dark:to-red-800/30 dark:border-red-800">
          <CardContent className="p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-red-700 dark:text-red-300 font-medium">Critical</p>
                <p className="text-3xl font-bold text-red-900 dark:text-red-100 mt-1">{stats?.by_severity?.critical || 0}</p>
              </div>
              <div className="p-3 bg-red-500/20 rounded-xl">
                <AlertCircle className="text-red-600" size={28} />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* High Risks */}
        <Card className="bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200 dark:from-orange-900/30 dark:to-orange-800/30 dark:border-orange-800">
          <CardContent className="p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-orange-700 dark:text-orange-300 font-medium">High</p>
                <p className="text-3xl font-bold text-orange-900 dark:text-orange-100 mt-1">{stats?.by_severity?.high || 0}</p>
              </div>
              <div className="p-3 bg-orange-500/20 rounded-xl">
                <AlertTriangle className="text-orange-600" size={28} />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Overdue */}
        <Card className="bg-gradient-to-br from-amber-50 to-amber-100 border-amber-200 dark:from-amber-900/30 dark:to-amber-800/30 dark:border-amber-800">
          <CardContent className="p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-amber-700 dark:text-amber-300 font-medium">Overdue</p>
                <p className="text-3xl font-bold text-amber-900 dark:text-amber-100 mt-1">{stats?.overdue_count || 0}</p>
              </div>
              <div className="p-3 bg-amber-500/20 rounded-xl">
                <Clock className="text-amber-600" size={28} />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Mitigated */}
        <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200 dark:from-green-900/30 dark:to-green-800/30 dark:border-green-800">
          <CardContent className="p-5">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-green-700 dark:text-green-300 font-medium">Mitigated</p>
                <p className="text-3xl font-bold text-green-900 dark:text-green-100 mt-1">
                  {(stats?.by_status?.MITIGATED || 0) + (stats?.by_status?.CLOSED || 0)}
                </p>
              </div>
              <div className="p-3 bg-green-500/20 rounded-xl">
                <CheckCircle className="text-green-600" size={28} />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Charts Section */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-lg">Risks by Category</CardTitle>
          </CardHeader>
          <CardContent>
            {categoryData.length > 0 ? (
              <DynamicChart
                data={categoryData}
                dataKey="value"
                height={280}
                defaultType="bar"
                name="Risks"
              />
            ) : (
              <div className="h-64 flex items-center justify-center text-app-muted">
                No data available
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-lg">Risk Severity Distribution</CardTitle>
          </CardHeader>
          <CardContent>
            {severityData.length > 0 && severityData.some(d => d.value > 0) ? (
              <DynamicChart
                data={severityData}
                dataKey="value"
                height={280}
                defaultType="pie"
                colors={['#ef4444', '#f97316', '#eab308', '#22c55e']}
              />
            ) : (
              <div className="h-64 flex items-center justify-center text-app-muted">
                No data available
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Filters */}
      <Card>
        <CardContent className="p-4">
          <div className="flex flex-wrap gap-4">
            {/* Search */}
            <div className="relative flex-1 min-w-[200px]">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted-light" size={18} />
              <input
                type="text"
                placeholder="Search risks..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-app bg-app-input text-app-text rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              />
            </div>

            {/* Project Filter */}
            <select
              value={selectedProject}
              onChange={(e) => setSelectedProject(e.target.value)}
              className="px-4 py-2 border border-app bg-app-input text-app-text rounded-lg focus:ring-2 focus:ring-primary-500"
            >
              <option value="">All Projects</option>
              {projects.map(p => (
                <option key={p.id} value={p.id}>{p.name}</option>
              ))}
            </select>

            {/* Severity Filter */}
            <select
              value={selectedSeverity}
              onChange={(e) => setSelectedSeverity(e.target.value)}
              className="px-4 py-2 border border-app bg-app-input text-app-text rounded-lg focus:ring-2 focus:ring-primary-500"
            >
              <option value="">All Severities</option>
              <option value="CRITICAL">Critical</option>
              <option value="HIGH">High</option>
              <option value="MEDIUM">Medium</option>
              <option value="LOW">Low</option>
            </select>

            {/* Status Filter */}
            <select
              value={selectedStatus}
              onChange={(e) => setSelectedStatus(e.target.value)}
              className="px-4 py-2 border border-app bg-app-input text-app-text rounded-lg focus:ring-2 focus:ring-primary-500"
            >
              <option value="">All Statuses</option>
              {riskService.STATUSES.map(s => (
                <option key={s.value} value={s.value}>{s.label}</option>
              ))}
            </select>

            {/* Refresh */}
            <button
              onClick={fetchData}
              disabled={loading}
              className="px-4 py-2 border border-app rounded-lg hover:bg-app-subtle flex items-center gap-2 text-app-text"
            >
              <RefreshCw size={18} className={loading ? 'animate-spin' : ''} />
              Refresh
            </button>
          </div>
        </CardContent>
      </Card>

      {/* Risk List by Project */}
      <div className="space-y-4">
        {Object.entries(risksByProject).length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <Shield className="mx-auto text-app-muted-light mb-4" size={48} />
              <h3 className="text-lg font-medium text-app-heading mb-2">No Risks Found</h3>
              <p className="text-app-muted mb-4">
                {searchQuery || selectedProject || selectedSeverity || selectedStatus
                  ? 'No risks match your current filters. Try adjusting your search.'
                  : 'No risks have been registered yet. Click "Add New Risk" to get started.'}
              </p>
              <button
                onClick={() => setShowCreateModal(true)}
                className="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700"
              >
                <Plus size={18} />
                Add New Risk
              </button>
            </CardContent>
          </Card>
        ) : (
          Object.entries(risksByProject).map(([projectId, { projectName, risks: projectRisks }]) => (
            <Card key={projectId}>
              <CardHeader
                className="cursor-pointer hover:bg-app-surface transition-colors"
                onClick={() => toggleProjectExpand(projectId)}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    {expandedProjects[projectId] ? (
                      <ChevronDown className="text-app-muted" size={20} />
                    ) : (
                      <ChevronRight className="text-app-muted" size={20} />
                    )}
                    <Building className="text-primary-600" size={20} />
                    <CardTitle className="text-lg">{projectName}</CardTitle>
                    <span className="px-2 py-1 bg-app-surface rounded-full text-sm text-app-muted">
                      {projectRisks.length} {projectRisks.length === 1 ? 'risk' : 'risks'}
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    {projectRisks.filter(r => r.severity === 'CRITICAL').length > 0 && (
                      <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">
                        {projectRisks.filter(r => r.severity === 'CRITICAL').length} Critical
                      </span>
                    )}
                    {projectRisks.filter(r => r.severity === 'HIGH').length > 0 && (
                      <span className="px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs">
                        {projectRisks.filter(r => r.severity === 'HIGH').length} High
                      </span>
                    )}
                  </div>
                </div>
              </CardHeader>

              <AnimatePresence>
                {(expandedProjects[projectId] !== false) && (
                  <motion.div
                    initial={{ height: 0, opacity: 0 }}
                    animate={{ height: 'auto', opacity: 1 }}
                    exit={{ height: 0, opacity: 0 }}
                    transition={{ duration: 0.2 }}
                  >
                    <CardContent className="pt-0">
                      <div className="space-y-3">
                        {projectRisks.map((risk) => (
                          <div
                            key={risk.id}
                            onClick={() => handleRiskClick(risk)}
                            className="p-4 bg-app-surface rounded-lg border border-app-subtle hover:border-primary-300 hover:shadow-sm cursor-pointer transition-all"
                          >
                            <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2">
                                  <span className="text-xs text-app-muted font-mono">{risk.risk_code}</span>
                                  <SeverityBadge severity={risk.severity} />
                                  <StatusBadge status={risk.status} />
                                  {risk.is_overdue && (
                                    <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs animate-pulse">
                                      Overdue
                                    </span>
                                  )}
                                </div>
                                <h3 className="font-medium text-app-heading mb-1">{risk.title}</h3>
                                <div className="flex flex-wrap items-center gap-4 text-sm text-app-muted">
                                  {risk.category && (
                                    <span className="flex items-center gap-1">
                                      <Target size={14} />
                                      {riskService.CATEGORIES.find(c => c.value === risk.category)?.label}
                                    </span>
                                  )}
                                  {risk.owner_name && (
                                    <span className="flex items-center gap-1">
                                      <User size={14} />
                                      {risk.owner_name}
                                    </span>
                                  )}
                                  {risk.target_resolution && (
                                    <span className="flex items-center gap-1">
                                      <Calendar size={14} />
                                      Due: {new Date(risk.target_resolution).toLocaleDateString()}
                                    </span>
                                  )}
                                </div>
                              </div>
                              <div className="flex items-center gap-4 text-sm">
                                <div className="text-center">
                                  <div className="text-2xl font-bold text-app-heading">{risk.risk_score}</div>
                                  <div className="text-xs text-app-muted">Score</div>
                                </div>
                                <div className="text-center">
                                  <div className="text-lg font-semibold text-app-text-medium">{risk.mitigation_count || 0}</div>
                                  <div className="text-xs text-app-muted">Mitigations</div>
                                </div>
                                {risk.document_count > 0 && (
                                  <div className="text-center">
                                    <div className="text-lg font-semibold text-app-text-medium">{risk.document_count}</div>
                                    <div className="text-xs text-app-muted">Docs</div>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </CardContent>
                  </motion.div>
                )}
              </AnimatePresence>
            </Card>
          ))
        )}
      </div>

      {/* Create Risk Modal */}
      {showCreateModal && (
        <CreateRiskModal
          isOpen={showCreateModal}
          onClose={() => setShowCreateModal(false)}
          onSuccess={handleCreateSuccess}
          projects={projects}
        />
      )}

      {/* Risk Detail Panel */}
      {showDetailPanel && selectedRisk && (
        <RiskDetailPanel
          isOpen={showDetailPanel}
          onClose={() => {
            setShowDetailPanel(false);
            setSelectedRisk(null);
          }}
          risk={selectedRisk}
          onUpdate={handleUpdateSuccess}
        />
      )}
    </div>
  );
};

export default RiskManagement;



================================================
FILE: frontend/src/pages/RoleManager.jsx
================================================
import { useState } from 'react';
import { useLanguage } from '@/contexts/LanguageContext';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import Button from '@/components/ui/Button';
import { Plus, Save, Trash2, Shield } from 'lucide-react';

import { toast } from 'sonner';
import Toggle from '@/components/ui/Toggle';

const allPermissions = [
  'dashboard:view',
  'dashboard:edit',

  'scheduling:view',
  'scheduling:edit',
  'cost:view',
  'cost:edit',
  'risk:view',
  'risk:edit',
  'gis:view',
  'bim:view',
  'users:manage',
  'projects:create',
  'projects:edit',
];

const RoleManager = () => {
  const { t } = useLanguage();
  const [roles, setRoles] = useState({
    Site_Inspector: {
      role: 'Site_Inspector',
      accessLevel: 'Contributor',
      permissions: ['dashboard:view', 'scheduling:view'],
      dashboardView: 'Site inspection reports, upload photos, view schedules',
    },
  });
  const [newRoleName, setNewRoleName] = useState('');
  const [selectedRole, setSelectedRole] = useState(null);
  const [selectedPermissions, setSelectedPermissions] = useState([]);

  const handleCreateRole = () => {
    if (!newRoleName.trim()) {
      toast.error('Please enter a role name');
      return;
    }

    const roleKey = newRoleName.replace(/\s+/g, '_');
    if (roles[roleKey]) {
      toast.error('Role already exists');
      return;
    }

    setRoles({
      ...roles,
      [roleKey]: {
        role: roleKey,
        accessLevel: 'Limited',
        permissions: [],
        dashboardView: 'Custom dashboard view',
      },
    });

    setSelectedRole(roleKey);
    setSelectedPermissions([]);
    setNewRoleName('');
    toast.success('Role created successfully');
  };

  const handleSelectRole = (roleKey) => {
    setSelectedRole(roleKey);
    setSelectedPermissions(roles[roleKey]?.permissions || []);
  };

  const handleTogglePermission = (permission) => {
    setSelectedPermissions((prev) =>
      prev.includes(permission) ? prev.filter((p) => p !== permission) : [...prev, permission]
    );
  };

  const handleSaveRole = () => {
    if (!selectedRole) return;

    setRoles({
      ...roles,
      [selectedRole]: {
        ...roles[selectedRole],
        permissions: selectedPermissions,
      },
    });

    toast.success('Role permissions updated');
  };

  const handleDeleteRole = (roleKey) => {
    if (window.confirm(`Are you sure you want to delete role "${roleKey}"?`)) {
      const newRoles = { ...roles };
      delete newRoles[roleKey];
      setRoles(newRoles);
      if (selectedRole === roleKey) {
        setSelectedRole(null);
        setSelectedPermissions([]);
      }
      toast.success('Role deleted');
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-heading font-bold text-primary-950 dark:text-white">Role Manager</h1>
          <p className="text-slate-500 dark:text-neutral-400 mt-1">Create and manage user roles with custom permissions</p>
        </div>
        <div className="flex items-center gap-3">
          <input
            type="text"
            value={newRoleName}
            onChange={(e) => setNewRoleName(e.target.value)}
            placeholder="New role name (e.g., Site Inspector)"
            className="px-4 py-2 border border-slate-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 dark:text-white rounded-lg"
            onKeyPress={(e) => e.key === 'Enter' && handleCreateRole()}
          />
          <Button onClick={handleCreateRole}>
            <Plus size={18} />
            Create Role
          </Button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Role List */}
        <Card>
          <CardHeader>
            <CardTitle>Roles</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-2">
              {Object.entries(roles).map(([roleKey, roleData]) => (
                <div
                  key={roleKey}
                  className={`p-3 rounded-lg border cursor-pointer transition-colors ${selectedRole === roleKey
                    ? 'border-primary-600 bg-primary-50 dark:bg-primary-900/30'
                    : 'border-slate-200 dark:border-neutral-700 hover:border-slate-300 dark:hover:border-neutral-600'
                    }`}
                  onClick={() => handleSelectRole(roleKey)}
                >
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="font-semibold text-sm dark:text-white">{roleKey.replace(/_/g, ' ')}</p>
                      <p className="text-xs text-slate-500 dark:text-neutral-400 mt-1">{roleData.accessLevel}</p>
                    </div>
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        handleDeleteRole(roleKey);
                      }}
                      className="p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* Permission Editor */}
        <div className="lg:col-span-2">
          {selectedRole ? (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Shield size={20} />
                  Permissions for {selectedRole.replace(/_/g, ' ')}
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                    {allPermissions.map((permission) => (
                      <div
                        key={permission}
                        className="flex items-center gap-2 p-3 border border-slate-200 dark:border-neutral-700 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-neutral-800"
                        onClick={() => handleTogglePermission(permission)}
                      >
                        <Toggle
                          checked={selectedPermissions.includes(permission)}
                          onChange={() => handleTogglePermission(permission)}
                          size="sm"
                        />
                        <span className="text-sm dark:text-neutral-300">{permission}</span>
                      </div>
                    ))}
                  </div>
                  <div className="flex justify-end pt-4 border-t dark:border-neutral-700">
                    <Button onClick={handleSaveRole}>
                      <Save size={18} />
                      Save Permissions
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ) : (
            <Card>
              <CardContent className="py-12 text-center text-slate-500">
                <p>Select a role from the list to manage its permissions.</p>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
};

export default RoleManager;









================================================
FILE: frontend/src/pages/Scheduling.jsx
================================================
import React, { useState, useEffect } from 'react';
import { Plus, Filter, Calendar, FileUp } from 'lucide-react';
import Button from '@/components/ui/Button';
import { GanttChart } from '@/components/scheduling/GanttChart';
import ImportScheduleModal from '@/components/scheduling/ImportScheduleModal';
import schedulingService from '@/services/schedulingService';
import projectService from '@/api/services/projectService';
import { toast } from 'sonner';
import AddScheduleTaskModal from '@/components/scheduling/AddScheduleTaskModal';

const Scheduling = () => {
  const [tasks, setTasks] = useState([]);
  const [projects, setProjects] = useState([]);
  const [selectedProject, setSelectedProject] = useState(null);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isImportModalOpen, setIsImportModalOpen] = useState(false);

  // Initial Load
  useEffect(() => {
    loadProjects();
  }, []);

  const loadProjects = async () => {
    try {
      const data = await projectService.getAllProjects();
      // getAllProjects already extracts results, so data is always an array
      const projectsArray = Array.isArray(data) ? data : [];
      setProjects(projectsArray);
      if (projectsArray.length > 0) {
        setSelectedProject(projectsArray[0].id);
        loadTasks(projectsArray[0].id);
      }
    } catch (error) {
      console.error(error);
      toast.error("Failed to load projects");
    }
  };

  const loadTasks = async (projectId) => {
    setLoading(true);
    try {
      const data = await schedulingService.getTasks(projectId);
      setTasks(data);
    } catch (error) {
      toast.error("Failed to load schedule");
    } finally {
      setLoading(false);
    }
  };

  const handleProjectChange = (e) => {
    const pid = e.target.value;
    setSelectedProject(pid);
    loadTasks(pid);
  };



  return (
    <div className="p-6 h-full flex flex-col space-y-4">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-app-heading">Project Schedule</h1>
          <p className="text-app-muted text-sm">Manage timelines, WBS, and Critical Milestones</p>
        </div>
        <div className="flex items-center gap-3">
          <select
            value={selectedProject || ''}
            onChange={handleProjectChange}
            className="px-3 py-2 border border-app rounded-lg text-sm bg-app-input text-app-text"
          >
            {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
          </select>
          <Button
            variant="outline"
            onClick={() => setIsImportModalOpen(true)}
            className="flex-1 sm:flex-none min-h-[44px]"
          >
            <FileUp size={18} className="mr-2" />
            <span className="hidden sm:inline">Import Schedule</span>
            <span className="sm:hidden">Import</span>
          </Button>
          <Button onClick={() => setIsModalOpen(true)} className="bg-primary-600 text-white">
            <Plus size={18} className="mr-2" /> Add Task
          </Button>
        </div>
      </div>

      {/* Content */}
      <div className="flex-1 min-h-0">
        {loading ? (
          <div className="h-full flex items-center justify-center text-app-muted">Loading Schedule...</div>
        ) : (
          <GanttChart
            tasks={tasks}
            onTaskClick={(task) => toast.info(`Viewing ${task.name} (${task.progress}%)`)}
          />
        )}
      </div>

      {/* Add Schedule Task Modal */}
      <AddScheduleTaskModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        projectId={selectedProject}
        onTaskCreated={() => loadTasks(selectedProject)}
      />

      {/* Import Schedule Modal */}
      {isImportModalOpen && selectedProject && (
        <ImportScheduleModal
          projectId={selectedProject}
          onClose={() => setIsImportModalOpen(false)}
          onImported={() => loadTasks(selectedProject)}
        />
      )}
    </div>
  );
};

export default Scheduling;



================================================
FILE: frontend/src/pages/UserManagement.jsx
================================================
import { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { useAuth } from '@/contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import {
    Users, UserPlus, Search, Filter, RefreshCw, Mail, Phone, Building2,
    CheckCircle2, XCircle, Clock, Shield, AlertCircle, Eye, Loader2,
    ChevronDown, MoreVertical, UserCheck, UserX
} from 'lucide-react';
import { Card } from '@/components/ui/Card';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';
import api from '@/api/client';
import StatusBadge from '@/components/ui/StatusBadge';

// Invite User Modal
const InviteUserModal = ({ isOpen, onClose, onSuccess }) => {
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [formData, setFormData] = useState({
        email: '',
        first_name: '',
        last_name: '',
        role: 'PMNC_Team',
        department: '',
        phone_number: '',
    });
    const [errors, setErrors] = useState({});

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.email || !formData.first_name || !formData.last_name) {
            setErrors({
                email: !formData.email ? 'Email is required' : '',
                first_name: !formData.first_name ? 'First name is required' : '',
                last_name: !formData.last_name ? 'Last name is required' : '',
            });
            return;
        }

        setIsSubmitting(true);
        try {
            await api.post('/users/invite/', formData);
            toast.success(`Invite sent to ${formData.email}`);
            onSuccess();
            onClose();
        } catch (error) {
            console.error('Invite failed:', error);
            if (error.response?.data) {
                setErrors(error.response.data);
            }
            toast.error('Failed to send invite');
        } finally {
            setIsSubmitting(false);
        }
    };

    if (!isOpen) return null;

    return createPortal(
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-app-overlay backdrop-blur-sm">
            <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                className="bg-app-card rounded-2xl shadow-xl w-full max-w-lg mx-4"
            >
                <div className="p-6 border-b border-app-subtle">
                    <h2 className="text-xl font-bold text-app-heading flex items-center gap-2">
                        <UserPlus className="text-primary-600" size={24} />
                        Invite Internal User
                    </h2>
                    <p className="text-sm text-app-muted mt-1">Send an invite to a new team member</p>
                </div>

                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-app-text mb-1">Email <span className="text-red-500">*</span></label>
                        <input
                            type="email"
                            value={formData.email}
                            onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                            className={`w-full px-4 py-2 bg-app-input text-app-text rounded-lg border ${errors.email ? 'border-red-300' : 'border-app'} focus:outline-none focus:ring-2 focus:ring-primary-500`}
                            placeholder="user@example.com"
                        />
                        {errors.email && <p className="text-sm text-red-500 mt-1">{errors.email}</p>}
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-app-text mb-1">First Name <span className="text-red-500">*</span></label>
                            <input
                                type="text"
                                value={formData.first_name}
                                onChange={(e) => setFormData(prev => ({ ...prev, first_name: e.target.value }))}
                                className={`w-full px-4 py-2 bg-app-input text-app-text rounded-lg border ${errors.first_name ? 'border-red-300' : 'border-app'} focus:outline-none focus:ring-2 focus:ring-primary-500`}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-app-text mb-1">Last Name <span className="text-red-500">*</span></label>
                            <input
                                type="text"
                                value={formData.last_name}
                                onChange={(e) => setFormData(prev => ({ ...prev, last_name: e.target.value }))}
                                className={`w-full px-4 py-2 bg-app-input text-app-text rounded-lg border ${errors.last_name ? 'border-red-300' : 'border-app'} focus:outline-none focus:ring-2 focus:ring-primary-500`}
                            />
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-app-text mb-1">Role <span className="text-red-500">*</span></label>
                        <select
                            value={formData.role}
                            onChange={(e) => setFormData(prev => ({ ...prev, role: e.target.value }))}
                            className="w-full px-4 py-2 rounded-lg border border-app bg-app-input text-app-text focus:outline-none focus:ring-2 focus:ring-primary-500"
                        >
                            <option value="SPV_Official">SPV Official</option>
                            <option value="PMNC_Team">PMNC Team</option>
                            <option value="Consultant_Design">Design Consultant</option>
                            <option value="Govt_Department">Government Department</option>
                            <option value="NICDC_HQ">NICDC HQ</option>
                        </select>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-app-text mb-1">Department</label>
                            <input
                                type="text"
                                value={formData.department}
                                onChange={(e) => setFormData(prev => ({ ...prev, department: e.target.value }))}
                                className="w-full px-4 py-2 rounded-lg border border-app bg-app-input text-app-text focus:outline-none focus:ring-2 focus:ring-primary-500"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-app-text mb-1">Phone</label>
                            <input
                                type="text"
                                value={formData.phone_number}
                                onChange={(e) => setFormData(prev => ({ ...prev, phone_number: e.target.value }))}
                                className="w-full px-4 py-2 rounded-lg border border-app bg-app-input text-app-text focus:outline-none focus:ring-2 focus:ring-primary-500"
                            />
                        </div>
                    </div>

                    <div className="flex justify-end gap-3 pt-4">
                        <Button variant="outline" type="button" onClick={onClose}>Cancel</Button>
                        <Button type="submit" disabled={isSubmitting}>
                            {isSubmitting ? <Loader2 className="animate-spin mr-2" size={18} /> : <Mail className="mr-2" size={18} />}
                            Send Invite
                        </Button>
                    </div>
                </form>
            </motion.div>
        </div>,
        document.body
    );
};

// User Detail Modal
const UserDetailModal = ({ isOpen, onClose, user, onApprove, onReject }) => {
    const [rejectionReason, setRejectionReason] = useState('');
    const [showRejectForm, setShowRejectForm] = useState(false);

    if (!isOpen || !user) return null;

    return createPortal(
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-app-overlay backdrop-blur-sm">
            <motion.div
                initial={{ opacity: 0, scale: 0.95 }}
                animate={{ opacity: 1, scale: 1 }}
                className="bg-app-card rounded-2xl shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col overflow-hidden"
            >
                {/* Fixed Header */}
                <div className="p-6 border-b border-app-subtle flex justify-between items-start flex-shrink-0">
                    <div>
                        <h2 className="text-xl font-bold text-app-heading">{user.first_name} {user.last_name}</h2>
                        <p className="text-sm text-app-muted">{user.email}</p>
                    </div>
                    <button onClick={onClose} className="text-app-muted hover:text-app-text">
                        <XCircle size={24} />
                    </button>
                </div>

                {/* Scrollable Content */}
                <div className="p-6 space-y-6 overflow-y-auto flex-1">
                    {/* Status Banner */}
                    {user.account_status === 'PENDING_APPROVAL' && (
                        <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 flex items-center gap-3">
                            <Clock className="text-amber-600 dark:text-amber-400" size={24} />
                            <div>
                                <p className="font-semibold text-amber-900 dark:text-amber-300">Pending Approval</p>
                                <p className="text-sm text-amber-700 dark:text-amber-400">This user is awaiting admin approval to access the system.</p>
                            </div>
                        </div>
                    )}

                    {/* User Info */}
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <p className="text-xs text-app-muted uppercase font-medium">Role</p>
                            <p className="text-app-heading font-medium">{user.role?.replace('_', ' ')}</p>
                        </div>
                        <div>
                            <p className="text-xs text-app-muted uppercase font-medium">Status</p>
                            <p className="text-app-heading font-medium">{user.account_status}</p>
                        </div>
                        {user.company_name && (
                            <div className="col-span-2">
                                <p className="text-xs text-app-muted uppercase font-medium">Company</p>
                                <p className="text-app-heading font-medium">{user.company_name}</p>
                            </div>
                        )}
                        {user.pan_number && (
                            <>
                                <div>
                                    <p className="text-xs text-app-muted uppercase font-medium">PAN</p>
                                    <p className="text-app-heading font-mono">{user.pan_number}</p>
                                </div>
                                <div>
                                    <p className="text-xs text-app-muted uppercase font-medium">GSTIN</p>
                                    <p className="text-app-heading font-mono">{user.gstin_number}</p>
                                </div>
                            </>
                        )}
                        {user.bank_name && (
                            <>
                                <div>
                                    <p className="text-xs text-app-muted uppercase font-medium">Bank</p>
                                    <p className="text-app-heading">{user.bank_name}</p>
                                </div>
                                <div>
                                    <p className="text-xs text-app-muted uppercase font-medium">IFSC</p>
                                    <p className="text-app-heading font-mono">{user.ifsc_code}</p>
                                </div>
                            </>
                        )}
                        {user.full_address && (
                            <div className="col-span-2">
                                <p className="text-xs text-app-muted uppercase font-medium">Address</p>
                                <p className="text-app-heading">{user.full_address}</p>
                            </div>
                        )}
                    </div>

                    {/* Approval Actions */}
                    {user.account_status === 'PENDING_APPROVAL' && (
                        <div className="border-t border-app-subtle pt-4">
                            {!showRejectForm ? (
                                <div className="flex gap-3">
                                    <Button onClick={() => onApprove(user.id)} className="flex-1 bg-green-600 hover:bg-green-700">
                                        <UserCheck className="mr-2" size={18} /> Approve
                                    </Button>
                                    <Button variant="outline" onClick={() => setShowRejectForm(true)} className="flex-1 text-red-600 border-red-200 hover:bg-red-50">
                                        <UserX className="mr-2" size={18} /> Reject
                                    </Button>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    <textarea
                                        value={rejectionReason}
                                        onChange={(e) => setRejectionReason(e.target.value)}
                                        placeholder="Enter reason for rejection..."
                                        className="w-full px-4 py-2 rounded-lg border border-app bg-app-input text-app-text focus:outline-none focus:ring-2 focus:ring-red-500"
                                        rows={3}
                                    />
                                    <div className="flex gap-3">
                                        <Button variant="outline" onClick={() => setShowRejectForm(false)}>Cancel</Button>
                                        <Button
                                            onClick={() => onReject(user.id, rejectionReason)}
                                            disabled={!rejectionReason.trim()}
                                            className="bg-red-600 hover:bg-red-700"
                                        >
                                            Confirm Rejection
                                        </Button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </motion.div>
        </div>,
        document.body
    );
};

const UserManagement = () => {
    const { user } = useAuth();
    const navigate = useNavigate();
    const [users, setUsers] = useState([]);
    const [pendingUsers, setPendingUsers] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [roleFilter, setRoleFilter] = useState('all');
    const [activeTab, setActiveTab] = useState('all'); // 'all' or 'pending'
    const [isInviteModalOpen, setIsInviteModalOpen] = useState(false);
    const [selectedUser, setSelectedUser] = useState(null);
    const [isRefreshing, setIsRefreshing] = useState(false);

    // Ref to prevent duplicate fetches in React StrictMode
    const hasFetched = useRef(false);

    useEffect(() => {
        // Access control
        if (user && !['SPV_Official', 'NICDC_HQ'].includes(user.role)) {
            navigate('/dashboard');
            return;
        }
        // Prevent double-fetch in StrictMode
        if (hasFetched.current) return;
        hasFetched.current = true;

        fetchUsers();
        fetchPendingUsers();
    }, [user, navigate]);

    const fetchUsers = async () => {
        try {
            console.log("Fetching users...");
            const response = await api.get(`/users/?t=${new Date().getTime()}`);
            console.log("Users fetched response:", response.data);
            const data = Array.isArray(response.data) ? response.data : (response.data.results || []);
            console.log("Users processed:", data.length);
            setUsers(data);
        } catch (error) {
            console.error('Failed to fetch users:', error);
            toast.error("Failed to load users list");
        } finally {
            setIsLoading(false);
        }
    };

    const fetchPendingUsers = async () => {
        try {
            const response = await api.get('/users/pending/');
            setPendingUsers(response.data.results || response.data);
        } catch (error) {
            console.error('Failed to fetch pending users:', error);
        }
    };

    const handleRefresh = async () => {
        setIsRefreshing(true);
        await Promise.all([fetchUsers(), fetchPendingUsers()]);
        setIsRefreshing(false);
        toast.success("List refreshed");
    };

    const handleApprove = async (userId) => {
        try {
            await api.post(`/users/${userId}/approve/`);
            toast.success('User approved successfully');
            await fetchUsers();
            await fetchPendingUsers();
            setSelectedUser(null);
        } catch (error) {
            toast.error('Failed to approve user');
        }
    };

    const handleReject = async (userId, reason) => {
        try {
            await api.post(`/users/${userId}/reject/`, { reason });
            toast.success('User rejected');
            await fetchUsers();
            await fetchPendingUsers();
            setSelectedUser(null);
        } catch (error) {
            toast.error('Failed to reject user');
        }
    };


    const handleStatusUpdate = async (userId, newStatus) => {
        try {
            // newStatus is "ACTIVE" or "DISABLED" (from StatusBadge)
            const isActive = newStatus === 'ACTIVE';
            await api.post(`/users/${userId}/toggle-status/`, { is_active: isActive });
            toast.success(`User status updated to ${newStatus}`);
            // Optimistic update
            setUsers(users.map(u =>
                u.id === userId
                    ? { ...u, account_status: newStatus, is_active: isActive }
                    : u
            ));
        } catch (error) {
            console.error('Status update failed:', error);
            toast.error('Failed to update status');
            throw error; // Propagate to StatusBadge to stop loading state
        }
    };

    const getStatusBadge = (status) => {
        const styles = {
            'ACTIVE': 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border-green-200 dark:border-green-800',
            'PENDING_INVITE': 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-800',
            'PENDING_APPROVAL': 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 border-amber-200 dark:border-amber-800',
            'DISABLED': 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 border-red-200 dark:border-red-800',
        };
        return styles[status] || 'bg-app-secondary text-app-text';
    };

    const getRoleBadge = (role) => {
        const styles = {
            'SPV_Official': 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300',
            'PMNC_Team': 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300',
            'EPC_Contractor': 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300',
            'Consultant_Design': 'bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300',
            'Govt_Department': 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300',
            'NICDC_HQ': 'bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-300',
        };
        return styles[role] || 'bg-app-secondary text-app-text';
    };

    const displayUsers = activeTab === 'pending' ? pendingUsers : users;
    const filteredUsers = displayUsers.filter(u => {
        const matchesSearch =
            (u.username || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
            (u.email || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
            (u.first_name || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
            (u.last_name || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
            (u.company_name || '').toLowerCase().includes(searchQuery.toLowerCase());

        const matchesStatus = statusFilter === 'all' || u.account_status === statusFilter;
        const matchesRole = roleFilter === 'all' || u.role === roleFilter;

        return matchesSearch && matchesStatus && matchesRole;
    });

    return (
        <div className="p-6 space-y-6">
            {/* Header */}
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-heading font-bold text-app-heading flex items-center gap-2">
                        <Users className="text-primary-600" /> User Management
                    </h1>
                    <p className="text-app-muted mt-1">Manage system users, roles, and approvals</p>
                </div>
                <div className="flex gap-3">
                    <Button variant="outline" onClick={handleRefresh} disabled={isRefreshing}>
                        <RefreshCw size={18} className={`mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                        {isRefreshing ? 'Refreshing...' : 'Refresh'}
                    </Button>
                    <Button onClick={() => setIsInviteModalOpen(true)}>
                        <UserPlus size={18} className="mr-2" /> Invite User
                    </Button>
                </div>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <Card className="p-4">
                    <div className="flex items-center gap-3">
                        <div className="p-3 rounded-xl bg-primary-100 dark:bg-primary-900/20">
                            <Users className="w-6 h-6 text-primary-600 dark:text-primary-400" />
                        </div>
                        <div>
                            <p className="text-2xl font-bold text-app-heading">{users.length}</p>
                            <p className="text-sm text-app-muted">Total Users</p>
                        </div>
                    </div>
                </Card>
                <Card className="p-4">
                    <div className="flex items-center gap-3">
                        <div className="p-3 rounded-xl bg-green-100 dark:bg-green-900/20">
                            <CheckCircle2 className="w-6 h-6 text-green-600 dark:text-green-400" />
                        </div>
                        <div>
                            <p className="text-2xl font-bold text-app-heading">{users.filter(u => u.account_status === 'ACTIVE').length}</p>
                            <p className="text-sm text-app-muted">Active</p>
                        </div>
                    </div>
                </Card>
                <Card className="p-4 cursor-pointer hover:bg-amber-50 dark:hover:bg-amber-900/10 transition-colors" onClick={() => setActiveTab('pending')}>
                    <div className="flex items-center gap-3">
                        <div className="p-3 rounded-xl bg-amber-100 dark:bg-amber-900/20">
                            <Clock className="w-6 h-6 text-amber-600 dark:text-amber-400" />
                        </div>
                        <div>
                            <p className="text-2xl font-bold text-app-heading">{pendingUsers.length}</p>
                            <p className="text-sm text-app-muted">Pending Approval</p>
                        </div>
                    </div>
                </Card>
                <Card className="p-4">
                    <div className="flex items-center gap-3">
                        <div className="p-3 rounded-xl bg-orange-100 dark:bg-orange-900/20">
                            <Building2 className="w-6 h-6 text-orange-600 dark:text-orange-400" />
                        </div>
                        <div>
                            <p className="text-2xl font-bold text-app-heading">{users.filter(u => u.role === 'EPC_Contractor').length}</p>
                            <p className="text-sm text-app-muted">Contractors</p>
                        </div>
                    </div>
                </Card >
            </div >

            {/* Tabs */}
            <div className="flex gap-2">
                <button
                    onClick={() => setActiveTab('all')}
                    className={`px-4 py-2 rounded-lg font-medium transition-all ${activeTab === 'all'
                        ? 'bg-primary-600 text-white shadow-lg shadow-primary-600/30'
                        : 'bg-app-secondary text-app-muted hover:bg-app-surface'
                        }`}
                >
                    All Users
                </button>
                <button
                    onClick={() => setActiveTab('pending')}
                    className={`px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2 ${activeTab === 'pending'
                        ? 'bg-amber-500 text-white shadow-lg shadow-amber-500/30'
                        : 'bg-app-secondary text-app-muted hover:bg-app-surface'
                        }`}
                >
                    Pending Approval
                    {pendingUsers.length > 0 && (
                        <span className={`px-2 py-0.5 rounded-full text-xs ${activeTab === 'pending' ? 'bg-white/20' : 'bg-amber-500 text-white'}`}>
                            {pendingUsers.length}
                        </span>
                    )}
                </button>
            </div >

            {/* Filters */}
            < Card className="p-4" >
                <div className="flex flex-col md:flex-row gap-4">
                    <div className="relative flex-1">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                        <input
                            type="text"
                            placeholder="Search by name, email, or company..."
                            className="w-full pl-10 pr-4 py-2 rounded-lg border border-app bg-app-input text-app-text focus:outline-none focus:ring-2 focus:ring-primary-500"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>
                    <select
                        className="px-4 py-2 border border-app bg-app-input text-app-text rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        value={roleFilter}
                        onChange={(e) => setRoleFilter(e.target.value)}
                    >
                        <option value="all">All Roles</option>
                        <option value="SPV_Official">SPV Official</option>
                        <option value="PMNC_Team">PMNC Team</option>
                        <option value="EPC_Contractor">EPC Contractor</option>
                        <option value="Consultant_Design">Design Consultant</option>
                        <option value="Govt_Department">Government</option>
                        <option value="NICDC_HQ">NICDC HQ</option>
                    </select>
                    <select
                        className="px-4 py-2 border border-app bg-app-input text-app-text rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                    >
                        <option value="all">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="PENDING_INVITE">Pending Invite</option>
                        <option value="PENDING_APPROVAL">Pending Approval</option>
                        <option value="DISABLED">Disabled</option>
                    </select>
                </div>
            </Card >

            {/* Users Table */}
            < div className="bg-app-card rounded-xl shadow-sm border border-app-subtle overflow-hidden" >
                {
                    isLoading ? (
                        <div className="p-12 text-center" >
                            <Loader2 className="w-8 h-8 animate-spin mx-auto mb-4 text-primary-600" />
                            <p className="text-app-muted">Loading users...</p>
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="bg-app-surface border-b border-app-subtle text-xs uppercase text-app-muted font-semibold">
                                        <th className="p-4">User</th>
                                        <th className="p-4">Role</th>
                                        <th className="p-4">Status</th>
                                        <th className="p-4">Contact</th>
                                        <th className="p-4">Joined</th>
                                        <th className="p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                                    {filteredUsers.length > 0 ? (
                                        filteredUsers.map(u => (
                                            <tr key={u.id} className="hover:bg-app-surface transition-colors">
                                                <td className="p-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/40 flex items-center justify-center text-primary-600 dark:text-primary-400 font-bold">
                                                            {(u.first_name?.[0] || u.username?.[0] || '?').toUpperCase()}
                                                        </div>
                                                        <div>
                                                            <p className="font-medium text-app-heading">
                                                                {u.first_name} {u.last_name}
                                                            </p>
                                                            <p className="text-sm text-app-muted">{u.username}</p>
                                                            {u.company_name && (
                                                                <p className="text-xs text-app-muted flex items-center gap-1">
                                                                    <Building2 size={12} /> {u.company_name}
                                                                </p>
                                                            )}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="p-4">
                                                    <span className={`px-2.5 py-1 rounded-full text-xs font-semibold ${getRoleBadge(u.role)}`}>
                                                        {u.role?.replace('_', ' ')}
                                                    </span>
                                                </td>
                                                <td className="p-4">
                                                    <StatusBadge
                                                        status={u.account_status}
                                                        onToggle={(newStatus) => handleStatusUpdate(u.id, newStatus)}
                                                        entityName={`${u.first_name} ${u.last_name} `}
                                                        activeValue="ACTIVE"
                                                        inactiveValue="DISABLED"
                                                        customLabels={{
                                                            'PENDING_APPROVAL': 'Pending Approval',
                                                            'PENDING_INVITE': 'Pending Invite'
                                                        }}
                                                        readOnly={['PENDING_APPROVAL', 'PENDING_INVITE'].includes(u.account_status)}
                                                    />
                                                </td>
                                                <td className="p-4">
                                                    <div className="text-sm">
                                                        <p className="text-app-muted flex items-center gap-1">
                                                            <Mail size={14} className="text-app-muted" /> {u.email}
                                                        </p>
                                                        {u.phone_number && (
                                                            <p className="text-app-muted flex items-center gap-1 mt-1">
                                                                <Phone size={14} className="text-app-muted" /> {u.phone_number}
                                                            </p>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="p-4 text-sm text-app-muted">
                                                    {u.date_joined ? new Date(u.date_joined).toLocaleDateString() : '-'}
                                                </td>
                                                <td className="p-4">
                                                    <div className="flex items-center gap-2">
                                                        <button
                                                            onClick={() => setSelectedUser(u)}
                                                            className="p-2 text-slate-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors"
                                                        >
                                                            <Eye size={18} />
                                                        </button>
                                                        {u.account_status === 'PENDING_APPROVAL' && (
                                                            <>
                                                                <button
                                                                    onClick={() => handleApprove(u.id)}
                                                                    className="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                                                                    title="Approve"
                                                                >
                                                                    <CheckCircle2 size={18} />
                                                                </button>
                                                            </>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr>
                                            <td colSpan="6" className="p-12 text-center text-slate-500">
                                                No users found matching your criteria.
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div >
                    )}
            </div >

            {/* Modals */}
            < InviteUserModal
                isOpen={isInviteModalOpen}
                onClose={() => setIsInviteModalOpen(false)}
                onSuccess={fetchUsers}
            />

            <UserDetailModal
                isOpen={!!selectedUser}
                onClose={() => setSelectedUser(null)}
                user={selectedUser}
                onApprove={handleApprove}
                onReject={handleReject}
            />
        </div >
    );
};

export default UserManagement;



================================================
FILE: frontend/src/pages/WorkflowConfig.jsx
================================================
import { useState, useEffect, useCallback } from 'react';
import { useLanguage } from '@/contexts/LanguageContext';
import { useAuth } from '@/contexts/AuthContext';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors } from '@dnd-kit/core';
import { arrayMove, SortableContext, sortableKeyboardCoordinates, verticalListSortingStrategy, useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { GripVertical, Plus, Trash2, Save, Settings, Filter, ChevronRight, Clock, ToggleLeft, ToggleRight, Loader2, AlertCircle, Workflow, CheckCircle } from 'lucide-react';
import Button from '@/components/ui/Button';
import { toast } from 'sonner';
import { motion, AnimatePresence } from 'framer-motion';
import { workflowService, WORKFLOW_MODULES, ACTION_TYPES, WORKFLOW_ROLES } from '@/api/services/workflowService';

// Sortable Step Component
const SortableStep = ({ step, index, onDelete, onUpdate }) => {
  const { attributes, listeners, setNodeRef, transform, transition } = useSortable({ id: step.id || `step-${index}` });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  return (
    <motion.div
      ref={setNodeRef}
      style={style}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, x: -100 }}
      className="flex items-center gap-3 p-4 bg-app-surface border border-app-subtle rounded-xl hover:border-primary-300 dark:hover:border-primary-700 transition-colors"
    >
      <div {...attributes} {...listeners} className="cursor-grab active:cursor-grabbing text-app-muted hover:text-app-text">
        <GripVertical size={20} />
      </div>
      <div className="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center font-bold text-primary-700 dark:text-primary-300">
        {step.sequence || index + 1}
      </div>
      <div className="flex-1 grid grid-cols-1 md:grid-cols-4 gap-3">
        <div>
          <label className="text-xs font-medium text-app-muted mb-1 block">Role</label>
          <select
            value={step.role || ''}
            onChange={(e) => onUpdate(index, 'role', e.target.value)}
            className="w-full px-3 py-2 bg-app-input text-app-text border border-app rounded-lg text-sm"
          >
            <option value="">Select Role</option>
            {WORKFLOW_ROLES.map((role) => (
              <option key={role.value} value={role.value}>
                {role.label}
              </option>
            ))}
          </select>
        </div>
        <div>
          <label className="text-xs font-medium text-app-muted mb-1 block">Action Type</label>
          <select
            value={step.action_type || ''}
            onChange={(e) => onUpdate(index, 'action_type', e.target.value)}
            className="w-full px-3 py-2 bg-app-input text-app-text border border-app rounded-lg text-sm"
          >
            {ACTION_TYPES.map((action) => (
              <option key={action.value} value={action.value}>
                {action.label}
              </option>
            ))}
          </select>
        </div>
        <div>
          <label className="text-xs font-medium text-app-muted mb-1 block">Custom Label</label>
          <input
            type="text"
            value={step.action_label || ''}
            onChange={(e) => onUpdate(index, 'action_label', e.target.value)}
            placeholder="e.g., Technical Sanction"
            className="w-full px-3 py-2 bg-app-input text-app-text border border-app rounded-lg text-sm"
          />
        </div>
        <div>
          <label className="text-xs font-medium text-app-muted mb-1 block">SLA (Days)</label>
          <input
            type="number"
            value={step.deadline_days || 3}
            onChange={(e) => onUpdate(index, 'deadline_days', parseInt(e.target.value))}
            className="w-full px-3 py-2 bg-app-input text-app-text border border-app rounded-lg text-sm"
            min={1}
            max={30}
          />
        </div>
      </div>
      <button
        onClick={() => onDelete(index)}
        className="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
        aria-label="Delete step"
      >
        <Trash2 size={18} />
      </button>
    </motion.div>
  );
};

// Trigger Rule Component
const TriggerRuleCard = ({ rule, onEdit, onDelete }) => {
  const operatorLabels = {
    GT: '>',
    GTE: 'â‰¥',
    LT: '<',
    LTE: 'â‰¤',
    EQ: '=',
    NEQ: 'â‰ ',
    IN: 'in',
    NOT_IN: 'not in',
    CONTAINS: 'contains'
  };

  return (
    <div className="p-4 bg-app-surface border border-app-subtle rounded-xl">
      <div className="flex items-center justify-between mb-2">
        <h4 className="font-semibold text-app-heading">{rule.name}</h4>
        <div className="flex gap-2">
          <button onClick={() => onEdit(rule)} className="text-primary-600 hover:text-primary-700 text-sm">
            Edit
          </button>
          <button onClick={() => onDelete(rule.id)} className="text-red-500 hover:text-red-600 text-sm">
            Delete
          </button>
        </div>
      </div>
      <div className="flex items-center gap-2 text-sm text-app-muted">
        <code className="px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded">{rule.condition_field}</code>
        <span>{operatorLabels[rule.condition_operator] || rule.condition_operator}</span>
        <code className="px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded">{rule.condition_value}</code>
        <ChevronRight size={16} />
        <span className="text-primary-600">{rule.template_name}</span>
      </div>
      <div className="flex items-center gap-3 mt-2 text-xs text-app-muted">
        <span>Priority: {rule.priority}</span>
        <span className={`px-2 py-0.5 rounded ${rule.is_active ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' : 'bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400'}`}>
          {rule.is_active ? 'Active' : 'Inactive'}
        </span>
      </div>
    </div>
  );
};

const WorkflowConfig = () => {
  const { t } = useLanguage();
  const { user } = useAuth();
  const [activeTab, setActiveTab] = useState('templates');
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  // Templates state
  const [templates, setTemplates] = useState([]);
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [templateForm, setTemplateForm] = useState({
    name: '',
    module: 'RA_BILL',
    description: '',
    is_active: true,
    is_default: false
  });
  const [localSteps, setLocalSteps] = useState([]);

  // Trigger rules state
  const [rules, setRules] = useState([]);
  const [editingRule, setEditingRule] = useState(null);
  const [ruleForm, setRuleForm] = useState({
    name: '',
    module: 'RA_BILL',
    condition_field: '',
    condition_operator: 'GT',
    condition_value: '',
    template: '',
    priority: 100,
    is_active: true
  });

  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  // Fetch data
  const fetchTemplates = useCallback(async () => {
    try {
      setLoading(true);
      const data = await workflowService.getTemplates();
      setTemplates(data.results || data);
    } catch (error) {
      console.error('Failed to fetch templates:', error);
      toast.error('Failed to load workflow templates');
    } finally {
      setLoading(false);
    }
  }, []);

  const fetchRules = useCallback(async () => {
    try {
      const data = await workflowService.getRules();
      setRules(data.results || data);
    } catch (error) {
      console.error('Failed to fetch rules:', error);
    }
  }, []);

  useEffect(() => {
    fetchTemplates();
    fetchRules();
  }, [fetchTemplates, fetchRules]);

  // Template handlers
  const handleSelectTemplate = async (template) => {
    try {
      const detail = await workflowService.getTemplate(template.id);
      setSelectedTemplate(detail);
      setTemplateForm({
        name: detail.name,
        module: detail.module,
        description: detail.description || '',
        is_active: detail.is_active,
        is_default: detail.is_default
      });
      setLocalSteps(detail.steps || []);
    } catch (error) {
      console.error('Failed to fetch template details:', error);
      toast.error('Failed to load template details');
    }
  };

  const handleCreateTemplate = () => {
    setSelectedTemplate({ id: 'new' });
    setTemplateForm({
      name: '',
      module: 'RA_BILL',
      description: '',
      is_active: true,
      is_default: false
    });
    setLocalSteps([]);
  };

  const handleSaveTemplate = async () => {
    if (!templateForm.name.trim()) {
      toast.error('Please enter a template name');
      return;
    }

    try {
      setSaving(true);
      let savedTemplate;

      if (selectedTemplate?.id === 'new') {
        // Create new template
        savedTemplate = await workflowService.createTemplate(templateForm);
        toast.success('Template created successfully');
      } else {
        // Update existing template
        savedTemplate = await workflowService.updateTemplate(selectedTemplate.id, templateForm);
        toast.success('Template updated successfully');
      }

      // Save steps if template is not new
      if (savedTemplate && savedTemplate.id !== 'new') {
        // For new steps, we need to add them
        for (const step of localSteps) {
          if (!step.id && step.role && step.action_type) {
            await workflowService.addStep(savedTemplate.id, {
              sequence: step.sequence,
              role: step.role,
              action_type: step.action_type,
              action_label: step.action_label || '',
              deadline_days: step.deadline_days || 3,
              can_revert: step.can_revert !== false,
              remarks_required: step.remarks_required || false
            });
          } else if (step.id) {
            await workflowService.updateStep(step.id, {
              role: step.role,
              action_type: step.action_type,
              action_label: step.action_label,
              deadline_days: step.deadline_days
            });
          }
        }

        // Reorder steps
        const stepIds = localSteps.filter(s => s.id).map(s => s.id);
        if (stepIds.length > 0) {
          await workflowService.reorderSteps(savedTemplate.id, stepIds);
        }
      }

      fetchTemplates();

      // Reload the template to get updated data
      if (savedTemplate?.id) {
        handleSelectTemplate(savedTemplate);
      }
    } catch (error) {
      console.error('Failed to save template:', error);
      toast.error('Failed to save template');
    } finally {
      setSaving(false);
    }
  };

  const handleDeleteTemplate = async (templateId) => {
    if (!window.confirm('Are you sure you want to delete this template?')) return;

    try {
      await workflowService.deleteTemplate(templateId);
      toast.success('Template deleted');
      setSelectedTemplate(null);
      setLocalSteps([]);
      fetchTemplates();
    } catch (error) {
      console.error('Failed to delete template:', error);
      toast.error('Failed to delete template');
    }
  };

  // Step handlers
  const handleDragEnd = (event) => {
    const { active, over } = event;
    if (!over || active.id === over.id) return;

    const oldIndex = localSteps.findIndex((s) => (s.id || `step-${localSteps.indexOf(s)}`) === active.id);
    const newIndex = localSteps.findIndex((s) => (s.id || `step-${localSteps.indexOf(s)}`) === over.id);

    const newSteps = arrayMove(localSteps, oldIndex, newIndex);
    const updatedSteps = newSteps.map((step, index) => ({ ...step, sequence: index + 1 }));
    setLocalSteps(updatedSteps);
  };

  const handleAddStep = () => {
    const newStep = {
      sequence: localSteps.length + 1,
      role: 'PMNC_Team',
      action_type: 'REVIEW',
      action_label: '',
      deadline_days: 3,
      can_revert: true,
      remarks_required: false
    };
    setLocalSteps([...localSteps, newStep]);
  };

  const handleDeleteStep = async (index) => {
    const step = localSteps[index];

    if (step.id) {
      try {
        await workflowService.deleteStep(step.id);
        toast.success('Step deleted');
      } catch (error) {
        console.error('Failed to delete step:', error);
        toast.error('Failed to delete step');
        return;
      }
    }

    const newSteps = localSteps.filter((_, i) => i !== index);
    const updatedSteps = newSteps.map((s, i) => ({ ...s, sequence: i + 1 }));
    setLocalSteps(updatedSteps);
  };

  const handleUpdateStep = (index, field, value) => {
    const newSteps = [...localSteps];
    newSteps[index] = { ...newSteps[index], [field]: value };
    setLocalSteps(newSteps);
  };

  // Trigger rule handlers
  const handleSaveRule = async () => {
    if (!ruleForm.name || !ruleForm.condition_field || !ruleForm.condition_value || !ruleForm.template) {
      toast.error('Please fill in all required fields');
      return;
    }

    try {
      setSaving(true);
      if (editingRule) {
        await workflowService.updateRule(editingRule.id, ruleForm);
        toast.success('Rule updated');
      } else {
        await workflowService.createRule(ruleForm);
        toast.success('Rule created');
      }

      setEditingRule(null);
      setRuleForm({
        name: '',
        module: 'RA_BILL',
        condition_field: '',
        condition_operator: 'GT',
        condition_value: '',
        template: '',
        priority: 100,
        is_active: true
      });
      fetchRules();
    } catch (error) {
      console.error('Failed to save rule:', error);
      toast.error('Failed to save rule');
    } finally {
      setSaving(false);
    }
  };

  const handleDeleteRule = async (ruleId) => {
    if (!window.confirm('Delete this trigger rule?')) return;

    try {
      await workflowService.deleteRule(ruleId);
      toast.success('Rule deleted');
      fetchRules();
    } catch (error) {
      console.error('Failed to delete rule:', error);
      toast.error('Failed to delete rule');
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <Loader2 className="w-8 h-8 animate-spin text-primary-600" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-heading font-bold text-app-heading flex items-center gap-3">
            <Workflow className="text-primary-600" />
            Workflow Configuration
          </h1>
          <p className="text-app-muted mt-1">Design and manage approval workflows for your organization</p>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b border-app-subtle">
        <button
          onClick={() => setActiveTab('templates')}
          className={`px-4 py-3 font-medium transition-colors border-b-2 ${activeTab === 'templates'
              ? 'border-primary-600 text-primary-600'
              : 'border-transparent text-app-muted hover:text-app-text'
            }`}
        >
          <Settings size={18} className="inline mr-2" />
          Templates
        </button>
        <button
          onClick={() => setActiveTab('rules')}
          className={`px-4 py-3 font-medium transition-colors border-b-2 ${activeTab === 'rules'
              ? 'border-primary-600 text-primary-600'
              : 'border-transparent text-app-muted hover:text-app-text'
            }`}
        >
          <Filter size={18} className="inline mr-2" />
          Trigger Rules
        </button>
      </div>

      {/* Templates Tab */}
      {activeTab === 'templates' && (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Template List */}
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <CardTitle>Templates</CardTitle>
              <Button size="sm" onClick={handleCreateTemplate}>
                <Plus size={16} />
              </Button>
            </CardHeader>
            <CardContent>
              <div className="space-y-2 max-h-[600px] overflow-y-auto">
                {templates.length === 0 ? (
                  <p className="text-center py-8 text-app-muted">No templates yet. Create one!</p>
                ) : (
                  templates.map((template) => (
                    <button
                      key={template.id}
                      onClick={() => handleSelectTemplate(template)}
                      className={`w-full text-left p-3 rounded-lg border transition-colors ${selectedTemplate?.id === template.id
                          ? 'border-primary-600 bg-primary-50 dark:bg-primary-900/20'
                          : 'border-app-subtle hover:border-primary-300 dark:hover:border-primary-700'
                        }`}
                    >
                      <div className="flex items-center justify-between">
                        <p className="font-semibold text-sm text-app-heading">{template.name || 'Unnamed'}</p>
                        {template.is_active ? (
                          <CheckCircle size={16} className="text-green-500" />
                        ) : (
                          <AlertCircle size={16} className="text-slate-400" />
                        )}
                      </div>
                      <p className="text-xs text-app-muted mt-1">
                        {template.module_display || template.module} â€¢ {template.step_count || 0} steps
                        {template.is_default && <span className="ml-2 text-primary-600">Default</span>}
                      </p>
                    </button>
                  ))
                )}
              </div>
            </CardContent>
          </Card>

          {/* Template Editor */}
          <div className="lg:col-span-2 space-y-6">
            {selectedTemplate ? (
              <>
                <Card>
                  <CardHeader className="flex flex-row items-center justify-between">
                    <CardTitle>Template Details</CardTitle>
                    {selectedTemplate.id !== 'new' && (
                      <button
                        onClick={() => handleDeleteTemplate(selectedTemplate.id)}
                        className="text-red-500 hover:text-red-600 text-sm"
                      >
                        Delete Template
                      </button>
                    )}
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="text-sm font-medium text-app-text mb-2 block">Template Name *</label>
                        <input
                          type="text"
                          value={templateForm.name}
                          onChange={(e) => setTemplateForm({ ...templateForm, name: e.target.value })}
                          placeholder="e.g., High Value Bill Approval"
                          className="w-full px-4 py-2 bg-app-input text-app-text border border-app rounded-lg"
                        />
                      </div>
                      <div>
                        <label className="text-sm font-medium text-app-text mb-2 block">Module *</label>
                        <select
                          value={templateForm.module}
                          onChange={(e) => setTemplateForm({ ...templateForm, module: e.target.value })}
                          className="w-full px-4 py-2 bg-app-input text-app-text border border-app rounded-lg"
                        >
                          {WORKFLOW_MODULES.map((mod) => (
                            <option key={mod.value} value={mod.value}>{mod.label}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                    <div>
                      <label className="text-sm font-medium text-app-text mb-2 block">Description</label>
                      <textarea
                        value={templateForm.description}
                        onChange={(e) => setTemplateForm({ ...templateForm, description: e.target.value })}
                        placeholder="Describe when this workflow should be used..."
                        rows={2}
                        className="w-full px-4 py-2 bg-app-input text-app-text border border-app rounded-lg"
                      />
                    </div>
                    <div className="flex gap-6">
                      <label className="flex items-center gap-2 cursor-pointer">
                        <button
                          type="button"
                          onClick={() => setTemplateForm({ ...templateForm, is_active: !templateForm.is_active })}
                          className="text-primary-600"
                        >
                          {templateForm.is_active ? <ToggleRight size={28} /> : <ToggleLeft size={28} className="text-slate-400" />}
                        </button>
                        <span className="text-sm text-app-text">Active</span>
                      </label>
                      <label className="flex items-center gap-2 cursor-pointer">
                        <button
                          type="button"
                          onClick={() => setTemplateForm({ ...templateForm, is_default: !templateForm.is_default })}
                          className="text-primary-600"
                        >
                          {templateForm.is_default ? <ToggleRight size={28} /> : <ToggleLeft size={28} className="text-slate-400" />}
                        </button>
                        <span className="text-sm text-app-text">Default for Module</span>
                      </label>
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader className="flex flex-row items-center justify-between">
                    <CardTitle className="flex items-center gap-2">
                      <Clock size={20} className="text-primary-600" />
                      Approval Steps
                    </CardTitle>
                    <Button onClick={handleAddStep} size="sm">
                      <Plus size={16} />
                      Add Step
                    </Button>
                  </CardHeader>
                  <CardContent>
                    {localSteps.length === 0 ? (
                      <div className="text-center py-12 text-app-muted border-2 border-dashed border-app-subtle rounded-xl">
                        <Workflow size={48} className="mx-auto mb-3 opacity-50" />
                        <p>No steps defined yet.</p>
                        <p className="text-sm">Click "Add Step" to create your approval chain.</p>
                      </div>
                    ) : (
                      <DndContext sensors={sensors} collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
                        <SortableContext items={localSteps.map((s, i) => s.id || `step-${i}`)} strategy={verticalListSortingStrategy}>
                          <AnimatePresence mode="popLayout">
                            <div className="space-y-3">
                              {localSteps.map((step, index) => (
                                <SortableStep
                                  key={step.id || `step-${index}`}
                                  step={step}
                                  index={index}
                                  onDelete={handleDeleteStep}
                                  onUpdate={handleUpdateStep}
                                />
                              ))}
                            </div>
                          </AnimatePresence>
                        </SortableContext>
                      </DndContext>
                    )}
                  </CardContent>
                </Card>

                <div className="flex justify-end gap-3">
                  <Button variant="outline" onClick={() => setSelectedTemplate(null)}>
                    Cancel
                  </Button>
                  <Button onClick={handleSaveTemplate} disabled={saving}>
                    {saving ? <Loader2 size={18} className="animate-spin" /> : <Save size={18} />}
                    Save Template
                  </Button>
                </div>
              </>
            ) : (
              <Card>
                <CardContent className="py-16 text-center text-app-muted">
                  <Workflow size={64} className="mx-auto mb-4 opacity-30" />
                  <p className="text-lg">Select a template to edit</p>
                  <p className="text-sm mt-1">Or create a new one to get started</p>
                </CardContent>
              </Card>
            )}
          </div>
        </div>
      )}

      {/* Trigger Rules Tab */}
      {activeTab === 'rules' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Rule Form */}
          <Card>
            <CardHeader>
              <CardTitle>{editingRule ? 'Edit Trigger Rule' : 'Create Trigger Rule'}</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <label className="text-sm font-medium text-app-text mb-2 block">Rule Name *</label>
                <input
                  type="text"
                  value={ruleForm.name}
                  onChange={(e) => setRuleForm({ ...ruleForm, name: e.target.value })}
                  placeholder="e.g., High Value Bill Rule"
                  className="w-full px-4 py-2 bg-app-input text-app-text border border-app rounded-lg"
                />
              </div>
              <div>
                <label className="text-sm font-medium text-app-text mb-2 block">Module</label>
                <select
                  value={ruleForm.module}
                  onChange={(e) => setRuleForm({ ...ruleForm, module: e.target.value })}
                  className="w-full px-4 py-2 bg-app-input text-app-text border border-app rounded-lg"
                >
                  {WORKFLOW_MODULES.map((mod) => (
                    <option key={mod.value} value={mod.value}>{mod.label}</option>
                  ))}
                </select>
              </div>
              <div className="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg space-y-3">
                <p className="text-sm font-medium text-app-text">Condition</p>
                <div className="grid grid-cols-3 gap-3">
                  <div>
                    <label className="text-xs text-app-muted block mb-1">Field</label>
                    <input
                      type="text"
                      value={ruleForm.condition_field}
                      onChange={(e) => setRuleForm({ ...ruleForm, condition_field: e.target.value })}
                      placeholder="amount"
                      className="w-full px-3 py-2 bg-app-input text-app-text border border-app rounded-lg text-sm"
                    />
                  </div>
                  <div>
                    <label className="text-xs text-app-muted block mb-1">Operator</label>
                    <select
                      value={ruleForm.condition_operator}
                      onChange={(e) => setRuleForm({ ...ruleForm, condition_operator: e.target.value })}
                      className="w-full px-3 py-2 bg-app-input text-app-text border border-app rounded-lg text-sm"
                    >
                      <option value="GT">Greater Than</option>
                      <option value="GTE">Greater or Equal</option>
                      <option value="LT">Less Than</option>
                      <option value="LTE">Less or Equal</option>
                      <option value="EQ">Equals</option>
                      <option value="NEQ">Not Equals</option>
                      <option value="IN">In List</option>
                      <option value="CONTAINS">Contains</option>
                    </select>
                  </div>
                  <div>
                    <label className="text-xs text-app-muted block mb-1">Value</label>
                    <input
                      type="text"
                      value={ruleForm.condition_value}
                      onChange={(e) => setRuleForm({ ...ruleForm, condition_value: e.target.value })}
                      placeholder="5000000"
                      className="w-full px-3 py-2 bg-app-input text-app-text border border-app rounded-lg text-sm"
                    />
                  </div>
                </div>
              </div>
              <div>
                <label className="text-sm font-medium text-app-text mb-2 block">Use Template *</label>
                <select
                  value={ruleForm.template}
                  onChange={(e) => setRuleForm({ ...ruleForm, template: e.target.value })}
                  className="w-full px-4 py-2 bg-app-input text-app-text border border-app rounded-lg"
                >
                  <option value="">Select Template</option>
                  {templates
                    .filter(t => t.module === ruleForm.module)
                    .map((template) => (
                      <option key={template.id} value={template.id}>{template.name}</option>
                    ))}
                </select>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-sm font-medium text-app-text mb-2 block">Priority (Lower = First)</label>
                  <input
                    type="number"
                    value={ruleForm.priority}
                    onChange={(e) => setRuleForm({ ...ruleForm, priority: parseInt(e.target.value) })}
                    className="w-full px-4 py-2 bg-app-input text-app-text border border-app rounded-lg"
                    min={1}
                  />
                </div>
                <div className="flex items-end">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <button
                      type="button"
                      onClick={() => setRuleForm({ ...ruleForm, is_active: !ruleForm.is_active })}
                      className="text-primary-600"
                    >
                      {ruleForm.is_active ? <ToggleRight size={28} /> : <ToggleLeft size={28} className="text-slate-400" />}
                    </button>
                    <span className="text-sm text-app-text">Active</span>
                  </label>
                </div>
              </div>
              <div className="flex justify-end gap-3">
                {editingRule && (
                  <Button variant="outline" onClick={() => {
                    setEditingRule(null);
                    setRuleForm({
                      name: '',
                      module: 'RA_BILL',
                      condition_field: '',
                      condition_operator: 'GT',
                      condition_value: '',
                      template: '',
                      priority: 100,
                      is_active: true
                    });
                  }}>
                    Cancel
                  </Button>
                )}
                <Button onClick={handleSaveRule} disabled={saving}>
                  {saving ? <Loader2 size={18} className="animate-spin" /> : <Save size={18} />}
                  {editingRule ? 'Update Rule' : 'Create Rule'}
                </Button>
              </div>
            </CardContent>
          </Card>

          {/* Existing Rules List */}
          <Card>
            <CardHeader>
              <CardTitle>Existing Rules</CardTitle>
            </CardHeader>
            <CardContent>
              {rules.length === 0 ? (
                <div className="text-center py-12 text-app-muted">
                  <Filter size={48} className="mx-auto mb-3 opacity-30" />
                  <p>No trigger rules defined yet.</p>
                  <p className="text-sm mt-1">Rules determine which template is used based on conditions.</p>
                </div>
              ) : (
                <div className="space-y-3 max-h-[500px] overflow-y-auto">
                  {rules.map((rule) => (
                    <TriggerRuleCard
                      key={rule.id}
                      rule={rule}
                      onEdit={(r) => {
                        setEditingRule(r);
                        setRuleForm({
                          name: r.name,
                          module: r.module,
                          condition_field: r.condition_field,
                          condition_operator: r.condition_operator,
                          condition_value: r.condition_value,
                          template: r.template,
                          priority: r.priority,
                          is_active: r.is_active
                        });
                      }}
                      onDelete={handleDeleteRule}
                    />
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  );
};

export default WorkflowConfig;



================================================
FILE: frontend/src/pages/admin/AuditLogs.jsx
================================================
import { useState, useEffect } from 'react';
import { Shield, Download, Search, Filter, Clock, User, Activity, FileText, Database, HardDrive, RefreshCw } from 'lucide-react';
import { Card } from '@/components/ui/Card';
import Button from '@/components/ui/Button';
import { AuditLogger } from '@/services/AuditLogger';
import { useAuth } from '@/contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import api from '@/api/client';

const AuditLogs = () => {
    const [localLogs, setLocalLogs] = useState([]);
    const [backendLogs, setBackendLogs] = useState([]);
    const [isLoadingBackend, setIsLoadingBackend] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [roleFilter, setRoleFilter] = useState('All');
    const [activeTab, setActiveTab] = useState('backend'); // 'backend' or 'frontend'
    const { user } = useAuth();
    const navigate = useNavigate();

    useEffect(() => {
        // Security check
        if (user && user.role !== 'SPV_Official' && user.role !== 'NICDC_HQ') {
            navigate('/dashboard');
            return;
        }

        // Load local logs
        setLocalLogs(AuditLogger.getLogs());

        // Load backend logs
        fetchBackendLogs();
    }, [user, navigate]);

    const fetchBackendLogs = async () => {
        setIsLoadingBackend(true);
        try {
            const response = await api.get('/audit/logs/');
            const formattedLogs = response.data.results ? response.data.results : response.data;
            setBackendLogs(formattedLogs.map(log => ({
                id: log.id,
                timestamp: log.timestamp,
                userName: log.actor_name || log.actor?.username || 'System',
                userRole: log.actor_role || 'Unknown',
                action: log.action,
                resource: log.resource_type,
                module: log.module || 'Unknown',
                details: formatDetails(log),
                ipAddress: log.ip_address
            })));
        } catch (error) {
            console.error('Failed to fetch backend audit logs:', error);
        } finally {
            setIsLoadingBackend(false);
        }
    };

    const formatDetails = (log) => {
        if (log.details && typeof log.details === 'object') {
            const parts = [];
            if (log.details.title) parts.push(`Title: ${log.details.title}`);
            if (log.details.file_name) parts.push(`File: ${log.details.file_name}`);
            if (log.details.version) parts.push(`Version: ${log.details.version}`);
            if (log.details.comments) parts.push(`Comments: ${log.details.comments}`);
            return parts.join(' | ') || JSON.stringify(log.details);
        }
        return String(log.details || '');
    };

    // Get current logs based on active tab
    const currentLogs = activeTab === 'backend' ? backendLogs : localLogs;

    const filteredLogs = currentLogs.filter(log => {
        const matchesSearch =
            (log.userName || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
            (log.details || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
            (log.resource || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
            (log.action || '').toLowerCase().includes(searchQuery.toLowerCase());

        const matchesRole = roleFilter === 'All' || log.userRole === roleFilter;

        return matchesSearch && matchesRole;
    });

    const roles = ['All', ...new Set(currentLogs.map(l => l.userRole).filter(Boolean))];

    const getActionColor = (action) => {
        const actionUpper = (action || '').toUpperCase();
        if (actionUpper.includes('CREATE') || actionUpper.includes('UPLOAD')) return 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300';
        if (actionUpper.includes('DELETE') || actionUpper.includes('REJECT') || actionUpper.includes('ARCHIVE')) return 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
        if (actionUpper.includes('UPDATE') || actionUpper.includes('VERSION') || actionUpper.includes('MOVE')) return 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300';
        if (actionUpper.includes('APPROVE') || actionUpper.includes('VALIDATE')) return 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300';
        if (actionUpper.includes('VIEW') || actionUpper.includes('DOWNLOAD')) return 'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300';
        if (actionUpper.includes('SUBMIT') || actionUpper.includes('REVISION')) return 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300';
        return 'bg-app-surface text-app-muted';
    };

    // Export current visible logs as CSV
    const handleExportCSV = () => {
        const logsToExport = filteredLogs;
        if (!logsToExport.length) {
            alert('No logs to export.');
            return;
        }

        const headers = ['Timestamp', 'User Name', 'Role', 'Action', 'Resource', 'Details', 'IP Address'];
        const csvContent = [
            headers.join(','),
            ...logsToExport.map(log => [
                `"${log.timestamp || ''}"`,
                `"${(log.userName || '').replace(/"/g, '""')}"`,
                `"${(log.userRole || '').replace(/"/g, '""')}"`,
                `"${(log.action || '').replace(/"/g, '""')}"`,
                `"${(log.resource || '').replace(/"/g, '""')}"`,
                `"${(log.details || '').replace(/"/g, '""')}"`,
                `"${log.ipAddress || ''}"`
            ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `audit_logs_${activeTab}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    };

    return (
        <div className="p-6 space-y-6">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-heading font-bold text-app-heading flex items-center gap-2">
                        <Shield className="text-primary-600" /> System Audit Logs
                    </h1>
                    <p className="text-app-muted mt-1">Immutable record of all system activities and security events</p>
                </div>
                <div className="flex items-center gap-3">
                    {activeTab === 'backend' && (
                        <Button
                            variant="outline"
                            onClick={fetchBackendLogs}
                            className="flex items-center gap-2"
                            disabled={isLoadingBackend}
                        >
                            <RefreshCw size={18} className={isLoadingBackend ? 'animate-spin' : ''} />
                            Refresh
                        </Button>
                    )}
                    <Button
                        onClick={handleExportCSV}
                        className="flex items-center gap-2 bg-app-text text-app-card hover:opacity-90"
                    >
                        <Download size={18} /> Export CSV
                    </Button>
                </div>
            </div>

            {/* Tab Buttons */}
            <div className="flex gap-2">
                <button
                    onClick={() => setActiveTab('backend')}
                    className={`flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all ${activeTab === 'backend'
                        ? 'bg-primary-600 text-white shadow-lg shadow-primary-500/30'
                        : 'bg-app-card text-app-muted border border-app hover:bg-app-surface'
                        }`}
                >
                    <Database size={20} />
                    Backend Logs (All Modules)
                    <span className={`ml-2 px-2 py-0.5 rounded-full text-xs font-bold ${activeTab === 'backend' ? 'bg-white/20 text-white' : 'bg-primary-100 text-primary-700'
                        }`}>
                        {backendLogs.length}
                    </span>
                </button>
                <button
                    onClick={() => setActiveTab('frontend')}
                    className={`flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all ${activeTab === 'frontend'
                        ? 'bg-amber-500 text-white shadow-lg shadow-amber-500/30'
                        : 'bg-app-card text-app-muted border border-app hover:bg-app-surface'
                        }`}
                >
                    <HardDrive size={20} />
                    Frontend Logs (Local)
                    <span className={`ml-2 px-2 py-0.5 rounded-full text-xs font-bold ${activeTab === 'frontend' ? 'bg-white/20 text-white' : 'bg-amber-100 text-amber-700'
                        }`}>
                        {localLogs.length}
                    </span>
                </button>
            </div>

            {/* Info Banner */}
            <div className={`p-4 rounded-xl flex items-center gap-3 ${activeTab === 'backend'
                ? 'bg-primary-50 dark:bg-primary-900/10 border border-primary-200 dark:border-primary-800'
                : 'bg-amber-50 dark:bg-amber-900/10 border border-amber-200 dark:border-amber-800'
                }`}>
                {activeTab === 'backend' ? (
                    <>
                        <Database className="text-primary-600 dark:text-primary-400" size={24} />
                        <div>
                            <p className="font-medium text-primary-900 dark:text-primary-100">Backend Audit Logs (All System Modules)</p>
                            <p className="text-sm text-primary-700 dark:text-primary-300">Permanent, immutable records of all system activities (EDMS, Users, Projects, Communications) stored in the database.</p>
                        </div>
                    </>
                ) : (
                    <>
                        <HardDrive className="text-amber-600 dark:text-amber-400" size={24} />
                        <div>
                            <p className="font-medium text-amber-900 dark:text-amber-100">Frontend Audit Logs (Browser Storage)</p>
                            <p className="text-sm text-amber-700 dark:text-amber-300">Local logs stored in browser's localStorage. These are cleared when browser data is cleared.</p>
                        </div>
                    </>
                )}
            </div>

            {/* Filters */}
            <Card className="p-4">
                <div className="flex flex-col md:flex-row gap-4">
                    <div className="relative flex-1">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" size={20} />
                        <input
                            type="text"
                            placeholder="Search by user, action, or details..."
                            className="w-full pl-10 pr-4 py-2 rounded-lg border border-app bg-app-input text-app-text focus:outline-none focus:ring-2 focus:ring-primary-500 transition-all"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>
                    <div className="flex items-center gap-2">
                        <Filter size={18} className="text-app-muted" />
                        <select
                            className="p-2 border border-app bg-app-input text-app-text rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                            value={roleFilter}
                            onChange={(e) => setRoleFilter(e.target.value)}
                        >
                            {roles.map(role => (
                                <option key={role} value={role}>{role}</option>
                            ))}
                        </select>
                    </div>
                </div>
            </Card>

            {/* Logs Table */}
            <div className="bg-app-card rounded-xl shadow-sm border border-app-subtle overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="bg-app-surface border-b border-app-subtle text-xs uppercase text-app-muted font-semibold">
                                <th className="p-4 w-48">Timestamp</th>
                                <th className="p-4 w-48">User Identity</th>
                                <th className="p-4 w-40">Action</th>
                                <th className="p-4 w-32">Resource</th>
                                <th className="p-4 w-24">Module</th>
                                <th className="p-4">Details</th>
                                {activeTab === 'backend' && <th className="p-4 w-32">IP Address</th>}
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                            {(activeTab === 'backend' && isLoadingBackend) ? (
                                <tr>
                                    <td colSpan={7} className="p-8 text-center text-app-muted">
                                        <RefreshCw className="w-6 h-6 animate-spin mx-auto mb-2" />
                                        Loading backend logs...
                                    </td>
                                </tr>
                            ) : filteredLogs.length > 0 ? (
                                filteredLogs.map((log) => (
                                    <tr key={log.id} className="hover:bg-app-surface transition-colors">
                                        <td className="p-4 text-sm text-app-muted font-mono">
                                            <div className="flex items-center gap-2">
                                                <Clock size={14} />
                                                {new Date(log.timestamp).toLocaleString()}
                                            </div>
                                        </td>
                                        <td className="p-4">
                                            <div className="flex flex-col">
                                                <span className="text-sm font-medium text-app-heading flex items-center gap-1">
                                                    <User size={14} className="text-app-muted" /> {log.userName}
                                                </span>
                                                <span className="text-xs text-app-muted">{log.userRole}</span>
                                            </div>
                                        </td>
                                        <td className="p-4">
                                            <span className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold ${getActionColor(log.action)}`}>
                                                <Activity size={12} /> {log.action}
                                            </span>
                                        </td>
                                        <td className="p-4 text-sm text-app-text font-medium">
                                            {log.resource}
                                        </td>
                                        <td className="p-4">
                                            {log.module && (
                                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700">
                                                    {log.module}
                                                </span>
                                            )}
                                        </td>
                                        <td className="p-4 text-sm text-app-text-medium">
                                            <div className="flex items-center gap-2 max-w-md truncate" title={log.details}>
                                                <FileText size={14} className="text-app-muted flex-shrink-0" />
                                                <span className="truncate">{log.details}</span>
                                            </div>
                                        </td>
                                        {activeTab === 'backend' && (
                                            <td className="p-4 text-sm text-app-muted font-mono">
                                                {log.ipAddress || '-'}
                                            </td>
                                        )}
                                    </tr>
                                ))
                            ) : (
                                <tr>
                                    <td colSpan={7} className="p-8 text-center text-app-muted">
                                        No audit logs found matching your criteria.
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

export default AuditLogs;



================================================
FILE: frontend/src/pages/admin/MasterData.jsx
================================================
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import {
    Building2, MapPin, FileText, Users, Calculator,
    Plus, Search, Edit2, Trash2, RefreshCw, Database,
    Ban, AlertCircle
} from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import mastersService from '@/api/services/mastersService';
import financeService from '@/api/services/financeService';
import api from '@/api/client';
import Button from '@/components/ui/Button';
import MasterFormModal from '@/components/masters/MasterFormModal';
import DeleteConfirmModal from '@/components/masters/DeleteConfirmModal';
import SortableDataTable from '@/components/ui/SortableDataTable';
import * as fieldConfigs from '@/components/masters/fieldConfigs';
import { toast } from 'sonner';
import StatusBadge from '@/components/ui/StatusBadge';

// Tab Configuration
const TABS = [
    { id: 'hierarchy', label: 'Hierarchy', icon: Building2, color: 'emerald' },
    { id: 'geography', label: 'Geography', icon: MapPin, color: 'blue' },
    { id: 'classification', label: 'Classification', icon: FileText, color: 'purple' },
    { id: 'entities', label: 'Contractors', icon: Users, color: 'amber' },
    { id: 'etp', label: 'ETP Charges', icon: Calculator, color: 'rose' },
];

// Master type definitions for each tab
const MASTER_TYPES = {
    hierarchy: ['zones', 'circles', 'divisions', 'subdivisions'],
    geography: ['districts', 'towns'],
    classification: ['schemeTypes', 'schemes', 'workTypes', 'projectCategories'],
    entities: ['contractors'],
    etp: ['etpCharges'],
};

const MasterData = () => {
    const { user } = useAuth();
    const [activeTab, setActiveTab] = useState('hierarchy');
    const [loading, setLoading] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');

    // Modal state
    const [formModalOpen, setFormModalOpen] = useState(false);
    const [deleteModalOpen, setDeleteModalOpen] = useState(false);
    const [currentMasterType, setCurrentMasterType] = useState(null);
    const [currentItem, setCurrentItem] = useState(null);
    const [submitting, setSubmitting] = useState(false);

    // Data states
    const [data, setData] = useState({
        zones: [],
        circles: [],
        divisions: [],
        subdivisions: [],
        districts: [],
        towns: [],
        schemeTypes: [],
        schemes: [],
        workTypes: [],
        projectCategories: [],
        contractors: [],
        etpCharges: [],
    });

    // Common data needed for dropdowns
    const [users, setUsers] = useState([]);
    const [fundingSources, setFundingSources] = useState([]);

    // Blacklist modal state
    const [blacklistModal, setBlacklistModal] = useState({ open: false, contractor: null });
    const [blacklistReason, setBlacklistReason] = useState('');
    const [blacklisting, setBlacklisting] = useState(false);

    // Check if user can edit
    const canEdit = user?.is_superuser || user?.role === 'SPV_Official';

    // Fetch common data on mount (users and funding sources)
    useEffect(() => {
        fetchCommonData();
    }, []);

    const fetchCommonData = async () => {
        try {
            // Fetch all active users for dropdowns
            const usersRes = await api.get('/users/');
            const usersData = Array.isArray(usersRes.data) ? usersRes.data : (usersRes.data.results || []);
            setUsers(usersData.filter(u => u.account_status === 'ACTIVE' && u.role !== 'EPC_Contractor'));

            // Fetch funding sources from fund management
            try {
                const fundsRes = await financeService.getFunds();
                const funds = fundsRes.data || [];
                // Extract unique source names
                const sources = [...new Map(funds.map(f => [f.source_name, f])).values()];
                setFundingSources(sources);
            } catch (err) {
                console.log('Fund sources not available yet');
            }
        } catch (err) {
            console.error('Failed to fetch common data:', err);
        }
    };

    // Fetch tab data
    useEffect(() => {
        fetchTabData(activeTab);
    }, [activeTab]);

    const fetchTabData = async (tab) => {
        setLoading(true);
        try {
            const fetchMap = {
                hierarchy: async () => {
                    const [z, c, d, s] = await Promise.all([
                        mastersService.getZones(),
                        mastersService.getCircles(),
                        mastersService.getDivisions(),
                        mastersService.getSubDivisions(),
                    ]);
                    return {
                        zones: z.data?.results || z.data || [],
                        circles: c.data?.results || c.data || [],
                        divisions: d.data?.results || d.data || [],
                        subdivisions: s.data?.results || s.data || []
                    };
                },
                geography: async () => {
                    const [d, t] = await Promise.all([
                        mastersService.getDistricts(),
                        mastersService.getTowns(),
                    ]);
                    return {
                        districts: d.data?.results || d.data || [],
                        towns: t.data?.results || t.data || []
                    };
                },
                classification: async () => {
                    const [st, s, wt, pc] = await Promise.all([
                        mastersService.getSchemeTypes(),
                        mastersService.getSchemes(),
                        mastersService.getWorkTypes(),
                        mastersService.getProjectCategories(),
                    ]);
                    return {
                        schemeTypes: st.data?.results || st.data || [],
                        schemes: s.data?.results || s.data || [],
                        workTypes: wt.data?.results || wt.data || [],
                        projectCategories: pc.data?.results || pc.data || []
                    };
                },
                entities: async () => {
                    const c = await mastersService.getContractors();
                    return { contractors: c.data?.results || c.data || [] };
                },
                etp: async () => {
                    const e = await mastersService.getETPCharges();
                    return { etpCharges: e.data?.results || e.data || [] };
                },
            };

            const newData = await fetchMap[tab]();
            setData(prev => ({ ...prev, ...newData }));
        } catch (error) {
            console.error('Failed to fetch:', error);
            toast.error('Failed to load data');
        } finally {
            setLoading(false);
        }
    };

    // CRUD handlers
    const handleAdd = (masterType) => {
        setCurrentMasterType(masterType);
        setCurrentItem(null);
        setFormModalOpen(true);
    };

    const handleEdit = (masterType, item) => {
        setCurrentMasterType(masterType);
        setCurrentItem(item);
        setFormModalOpen(true);
    };

    const handleDelete = (masterType, item) => {
        setCurrentMasterType(masterType);
        setCurrentItem(item);
        setDeleteModalOpen(true);
    };

    const handleFormSubmit = async (formData) => {
        setSubmitting(true);
        try {
            const serviceMap = {
                zones: { create: mastersService.createZone, update: mastersService.updateZone },
                circles: { create: mastersService.createCircle, update: mastersService.updateCircle },
                divisions: { create: mastersService.createDivision, update: mastersService.updateDivision },
                subdivisions: { create: mastersService.createSubDivision, update: mastersService.updateSubDivision },
                districts: { create: mastersService.createDistrict, update: mastersService.updateDistrict },
                towns: { create: mastersService.createTown, update: mastersService.updateTown },
                schemeTypes: { create: mastersService.createSchemeType, update: mastersService.updateSchemeType },
                schemes: { create: mastersService.createScheme, update: mastersService.updateScheme },
                workTypes: { create: mastersService.createWorkType, update: mastersService.updateWorkType },
                projectCategories: { create: mastersService.createProjectCategory, update: mastersService.updateProjectCategory },
                contractors: { create: mastersService.createContractor, update: mastersService.updateContractor },
                etpCharges: { create: mastersService.createETPCharge, update: mastersService.updateETPCharge },
            };

            const service = serviceMap[currentMasterType];
            if (currentItem) {
                await service.update(currentItem.id, formData);
                toast.success('Record updated successfully');
            } else {
                await service.create(formData);
                toast.success('Record created successfully');
            }

            setFormModalOpen(false);
            fetchTabData(activeTab);
        } catch (error) {
            console.error('Save failed:', error);
            toast.error(error.response?.data?.detail || 'Failed to save record');
        } finally {
            setSubmitting(false);
        }
    };

    const handleDeleteConfirm = async () => {
        setSubmitting(true);
        try {
            const deleteMap = {
                zones: mastersService.deleteZone,
                circles: mastersService.deleteCircle,
                divisions: mastersService.deleteDivision,
                subdivisions: mastersService.deleteSubDivision,
                districts: mastersService.deleteDistrict,
                towns: mastersService.deleteTown,
                schemeTypes: mastersService.deleteSchemeType,
                schemes: mastersService.deleteScheme,
                workTypes: mastersService.deleteWorkType,
                projectCategories: mastersService.deleteProjectCategory,
                contractors: mastersService.deleteContractor,
                etpCharges: mastersService.deleteETPCharge,
            };

            await deleteMap[currentMasterType](currentItem.id);
            toast.success('Record deleted successfully');
            setDeleteModalOpen(false);
            fetchTabData(activeTab);
        } catch (error) {
            console.error('Delete failed:', error);
            const msg = error.response?.status === 403
                ? 'You do not have permission to delete this record'
                : error.response?.data?.detail || 'Cannot delete: record may be in use';
            toast.error(msg);
        } finally {
            setSubmitting(false);
        }
    };

    // Get field config for current master type
    const getFieldConfig = (masterType) => {
        const configMap = {
            zones: fieldConfigs.zoneFields,
            circles: fieldConfigs.circleFields(data.zones),
            divisions: fieldConfigs.divisionFields(data.circles, users),
            subdivisions: fieldConfigs.subDivisionFields(data.divisions, users),
            districts: fieldConfigs.districtFields,
            towns: fieldConfigs.townFields(data.districts),
            schemeTypes: fieldConfigs.schemeTypeFields,
            schemes: fieldConfigs.schemeFields(data.schemeTypes, fundingSources),
            workTypes: fieldConfigs.workTypeFields,
            projectCategories: fieldConfigs.projectCategoryFields,
            contractors: fieldConfigs.contractorFields,
            etpCharges: fieldConfigs.etpFields,
        };
        return configMap[masterType] || [];
    };

    // Get modal title
    const getModalTitle = (masterType, isEdit) => {
        const titles = {
            zones: 'Zone',
            circles: 'Circle',
            divisions: 'Division',
            subdivisions: 'Sub-Division',
            districts: 'District',
            towns: 'Town/City',
            schemeTypes: 'Scheme Type',
            schemes: 'Scheme',
            workTypes: 'Work Type',
            projectCategories: 'Project Category',
            contractors: 'Contractor',
            etpCharges: 'ETP Charge',
        };
        return `${isEdit ? 'Edit' : 'Add'} ${titles[masterType] || 'Record'}`;
    };


    const handleStatusUpdate = async (masterType, item, newStatus) => {
        try {
            const serviceMap = {
                zones: mastersService.updateZone,
                circles: mastersService.updateCircle,
                divisions: mastersService.updateDivision,
                subdivisions: mastersService.updateSubDivision,
                districts: mastersService.updateDistrict,
                towns: mastersService.updateTown,
                schemeTypes: mastersService.updateSchemeType,
                schemes: mastersService.updateScheme,
                workTypes: mastersService.updateWorkType,
                projectCategories: mastersService.updateProjectCategory,
                // contractors handles separately
                etpCharges: mastersService.updateETPCharge, // expects is_active bool
            };

            const updateFn = serviceMap[masterType];
            if (!updateFn) {
                toast.error(`Status update not supported for ${masterType}`);
                return;
            }

            let payload = { status: newStatus };
            if (masterType === 'etpCharges') {
                payload = { is_active: newStatus === 'ACTIVE' };
            }

            await updateFn(item.id, payload);
            toast.success('Status updated');
            fetchTabData(activeTab);
        } catch (error) {
            console.error('Status update failed', error);
            toast.error('Failed to update status');
            throw error;
        }
    };

    // Status badge helper for standard masters
    const statusBadge = (val, item, masterType = activeTab) => {
        // Some tables pass (val, item), renderDataTable passes (val, item) to col.render
        // We need to know masterType. renderDataTable needs to pass it or we assume activeTab's types?
        // Actually, renderDataTable calls it as col.render(item[col.key], item)
        // But renderDataTable is generic. The masterType is passed to renderDataTable.
        // We can wrap this in renderDataTable or just use a closure?
        // Let's rely on the fact that `renderDataTable` knows the `masterType`.
        // Wait, `renderDataTable` calls `col.render`.
        // I will change the column definition in `renderTabContent` to pass the masterType implicitly or explicitly.

        return (
            <StatusBadge
                status={val || 'Active'} // Default to Active if undefined
                onToggle={(newStatus) => handleStatusUpdate(masterType, item, newStatus)}
                entityName={item.name || item.code}
                activeValue="Active"
                inactiveValue="Inactive"
            />
        );
    };

    // Render table with SortableDataTable component
    const renderDataTable = (dataKey, columns, title, masterType) => {
        const items = data[dataKey] || [];

        // Row actions for edit/delete
        const rowActions = canEdit ? (item) => (
            <>
                <button
                    onClick={(e) => { e.stopPropagation(); handleEdit(masterType, item); }}
                    className="p-1.5 text-app-muted hover:text-primary-600 transition-colors"
                    title="Edit"
                >
                    <Edit2 size={16} />
                </button>
                <button
                    onClick={(e) => { e.stopPropagation(); handleDelete(masterType, item); }}
                    className="p-1.5 text-app-muted hover:text-red-600 transition-colors ml-1"
                    title="Delete"
                >
                    <Trash2 size={16} />
                </button>
            </>
        ) : null;

        // Header actions for Add button
        const headerActions = canEdit ? (
            <Button size="sm" variant="outline" onClick={() => handleAdd(masterType)}>
                <Plus size={14} className="mr-1" />
                Add
            </Button>
        ) : null;

        return (
            <SortableDataTable
                data={items}
                columns={columns}
                title={title}
                headerActions={headerActions}
                rowActions={rowActions}
                pageSize={15}
                defaultSortKey="name"
                searchPlaceholder={`Search ${title.toLowerCase()}...`}
            />
        );
    };

    // Tab content
    const renderTabContent = () => {
        if (loading) {
            return (
                <div className="flex items-center justify-center py-20">
                    <RefreshCw className="animate-spin text-primary-500" size={32} />
                </div>
            );
        }

        switch (activeTab) {
            case 'hierarchy':
                return (
                    <div className="space-y-6">
                        {renderDataTable('zones', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'Zone Name' },
                            { key: 'state_covered', label: 'State/Region' },
                            { key: 'head', label: 'Zone Head' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'zones') },
                        ], 'Zones', 'zones')}

                        {renderDataTable('circles', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'Circle Name' },
                            { key: 'zone_name', label: 'Zone' },
                            { key: 'authority_level', label: 'Authority' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'circles') },
                        ], 'Circles', 'circles')}

                        {renderDataTable('divisions', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'Division Name' },
                            { key: 'circle_name', label: 'Circle' },
                            { key: 'hod', label: 'HOD' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'divisions') },
                        ], 'Divisions', 'divisions')}

                        {renderDataTable('subdivisions', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'Sub-Division Name' },
                            { key: 'division_name', label: 'Division' },
                            { key: 'jurisdiction_area', label: 'Jurisdiction' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'subdivisions') },
                        ], 'Sub-Divisions', 'subdivisions')}
                    </div>
                );

            case 'geography':
                return (
                    <div className="space-y-6">
                        {renderDataTable('districts', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'District Name' },
                            { key: 'state_name', label: 'State' },
                            { key: 'pincode_range', label: 'Pincode Range' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'districts') },
                        ], 'Districts', 'districts')}

                        {renderDataTable('towns', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'Town/City Name' },
                            { key: 'district_name', label: 'District' },
                            { key: 'classification', label: 'Classification' },
                            { key: 'population', label: 'Population' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'towns') },
                        ], 'Towns/Cities', 'towns')}
                    </div>
                );

            case 'classification':
                return (
                    <div className="space-y-6">
                        {renderDataTable('schemeTypes', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'Scheme Type' },
                            { key: 'category', label: 'Category' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'schemeTypes') },
                        ], 'Scheme Types', 'schemeTypes')}

                        {renderDataTable('schemes', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'Scheme Name' },
                            { key: 'scheme_type_name', label: 'Type' },
                            { key: 'funding_agency', label: 'Funding Agency' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'schemes') },
                        ], 'Schemes', 'schemes')}

                        {renderDataTable('workTypes', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'Work Type' },
                            { key: 'sector', label: 'Sector' },
                            { key: 'unit_of_measurement', label: 'UoM' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'workTypes') },
                        ], 'Work Types', 'workTypes')}

                        {renderDataTable('projectCategories', [
                            { key: 'code', label: 'Code' },
                            { key: 'name', label: 'Category' },
                            { key: 'threshold_value', label: 'Threshold (â‚¹)', render: (val) => `â‚¹${Number(val).toLocaleString('en-IN')}` },
                            { key: 'approval_authority', label: 'Approval Authority' },
                            { key: 'status', label: 'Status', render: (val, item) => statusBadge(val, item, 'projectCategories') },
                        ], 'Project Categories', 'projectCategories')}
                    </div>
                );

            case 'entities':
                // Handle contractor blacklist toggle
                const handleBlacklistToggle = async (contractor) => {
                    if (contractor.blacklisted) {
                        // Unblacklist
                        try {
                            await mastersService.updateContractor(contractor.id, {
                                blacklisted: false,
                                blacklist_reason: ''
                            });
                            toast.success('Contractor restored to active status');
                            fetchTabData('entities');
                        } catch (err) {
                            toast.error('Failed to restore contractor');
                        }
                    } else {
                        // Open blacklist modal
                        setBlacklistModal({ open: true, contractor });
                        setBlacklistReason('');
                    }
                };

                // Handle sync contractors from EPC Contractor users
                const handleSyncContractors = async () => {
                    try {
                        const response = await mastersService.syncContractorsFromUsers();
                        const { created, linked, errors } = response.data;
                        if (created > 0 || linked > 0) {
                            toast.success(`Synced ${created} new contractors, linked ${linked} existing`);
                            fetchTabData('entities');
                        } else if (errors && errors.length > 0) {
                            toast.error('Some contractors failed to sync');
                        } else {
                            toast.info('All EPC Contractor users are already synced');
                        }
                    } catch (err) {
                        console.error('Sync failed:', err);
                        toast.error('Failed to sync contractors from users');
                    }
                };

                const confirmBlacklist = async () => {
                    if (!blacklistModal.contractor) return;
                    setBlacklisting(true);
                    try {
                        await mastersService.updateContractor(blacklistModal.contractor.id, {
                            blacklisted: true,
                            blacklist_reason: blacklistReason || 'Blacklisted by admin'
                        });
                        toast.success('Contractor has been blacklisted');
                        setBlacklistModal({ open: false, contractor: null });
                        fetchTabData('entities');
                    } catch (err) {
                        toast.error('Failed to blacklist contractor');
                    } finally {
                        setBlacklisting(false);
                    }
                };

                return (
                    <>
                        {/* Contractors Table - Sync button, Blacklist action */}
                        <div className="bg-app-card rounded-xl border border-app-subtle overflow-hidden">
                            <div className="px-4 py-3 border-b border-app-subtle flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <h3 className="font-semibold text-app-heading">Contractors</h3>
                                    <span className="text-xs text-app-muted bg-app-surface px-2 py-0.5 rounded-full">
                                        {data.contractors?.length || 0}
                                    </span>
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="flex items-center gap-2 text-xs text-app-muted">
                                        <AlertCircle size={14} />
                                        Contractors self-register via public registration
                                    </div>
                                    {canEdit && (
                                        <button
                                            onClick={handleSyncContractors}
                                            className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 rounded-lg border border-blue-200 transition-colors"
                                        >
                                            <RefreshCw size={14} />
                                            Sync from Users
                                        </button>
                                    )}
                                </div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-app-surface">
                                        <tr>
                                            <th className="text-left px-4 py-3 font-medium text-app-muted">Code</th>
                                            <th className="text-left px-4 py-3 font-medium text-app-muted">Contractor Name</th>
                                            <th className="text-left px-4 py-3 font-medium text-app-muted">Type</th>
                                            <th className="text-left px-4 py-3 font-medium text-app-muted">Class</th>
                                            <th className="text-left px-4 py-3 font-medium text-app-muted">Status</th>
                                            {canEdit && <th className="text-center px-4 py-3 font-medium text-app-muted w-32">Actions</th>}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-200 dark:divide-neutral-800">
                                        {(data.contractors || []).filter(item =>
                                            Object.values(item).some(val =>
                                                String(val).toLowerCase().includes(searchQuery.toLowerCase())
                                            )
                                        ).map((contractor, idx) => (
                                            <tr key={contractor.id || idx} className="hover:bg-app-surface transition-colors">
                                                <td className="px-4 py-3 font-mono text-app-text">{contractor.code}</td>
                                                <td className="px-4 py-3 text-app-heading font-medium">{contractor.name}</td>
                                                <td className="px-4 py-3 text-app-muted">{contractor.contractor_type}</td>
                                                <td className="px-4 py-3 text-app-muted">{contractor.registration_class}</td>
                                                <td className="px-4 py-3">
                                                    <StatusBadge
                                                        status={contractor.blacklisted ? 'BLACKLISTED' : 'ACTIVE'}
                                                        onToggle={() => handleBlacklistToggle(contractor)}
                                                        entityName={contractor.name}
                                                        activeValue="ACTIVE"
                                                        inactiveValue="BLACKLISTED"
                                                        customStyles={{
                                                            'BLACKLISTED': 'bg-red-50 text-red-700 border-red-200',
                                                            'ACTIVE': 'bg-emerald-50 text-emerald-700 border-emerald-200'
                                                        }}
                                                    />
                                                </td>
                                                {canEdit && (
                                                    <td className="px-4 py-3 text-center">
                                                        <button
                                                            onClick={() => handleBlacklistToggle(contractor)}
                                                            className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${contractor.blacklisted
                                                                ? 'bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200'
                                                                : 'bg-red-50 text-red-700 hover:bg-red-100 border border-red-200'
                                                                }`}
                                                        >
                                                            {contractor.blacklisted ? 'Restore' : 'Blacklist'}
                                                        </button>
                                                    </td>
                                                )}
                                            </tr>
                                        ))}
                                        {(data.contractors || []).length === 0 && (
                                            <tr>
                                                <td colSpan={canEdit ? 6 : 5} className="text-center py-8 text-app-muted">
                                                    <Database size={32} className="mx-auto mb-2 opacity-30" />
                                                    No contractors registered yet
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Blacklist Reason Modal */}
                        {blacklistModal.open && (
                            <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm">
                                <motion.div
                                    initial={{ opacity: 0, scale: 0.95 }}
                                    animate={{ opacity: 1, scale: 1 }}
                                    className="bg-app-card rounded-2xl shadow-xl w-full max-w-md mx-4"
                                >
                                    <div className="p-6 border-b border-app-subtle">
                                        <h2 className="text-xl font-bold text-app-heading flex items-center gap-2">
                                            <Ban className="text-red-600" size={24} />
                                            Blacklist Contractor
                                        </h2>
                                        <p className="text-sm text-app-muted mt-1">
                                            {blacklistModal.contractor?.name}
                                        </p>
                                    </div>
                                    <div className="p-6">
                                        <label className="block text-sm font-medium text-app-text-medium mb-2">
                                            Reason for Blacklisting <span className="text-red-500">*</span>
                                        </label>
                                        <textarea
                                            value={blacklistReason}
                                            onChange={(e) => setBlacklistReason(e.target.value)}
                                            placeholder="Enter reason for blacklisting this contractor..."
                                            rows={3}
                                            className="w-full px-4 py-2 bg-app-input text-app-text border border-app rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                                        />
                                        <div className="flex justify-end gap-3 mt-6">
                                            <Button
                                                variant="outline"
                                                onClick={() => setBlacklistModal({ open: false, contractor: null })}
                                            >
                                                Cancel
                                            </Button>
                                            <Button
                                                onClick={confirmBlacklist}
                                                disabled={!blacklistReason.trim() || blacklisting}
                                                className="bg-red-600 hover:bg-red-700"
                                            >
                                                {blacklisting ? 'Processing...' : 'Confirm Blacklist'}
                                            </Button>
                                        </div>
                                    </div>
                                </motion.div>
                            </div>
                        )}
                    </>
                );

            case 'etp':
                // Helper function for ETP status - considers is_active AND effective_date
                const getETPStatus = (item) => {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const effectiveDate = item.effective_date ? new Date(item.effective_date) : null;

                    if (!item.is_active) {
                        return { label: 'Inactive', style: 'bg-app-surface text-app-muted border border-app' };
                    }
                    if (effectiveDate && effectiveDate > today) {
                        return { label: 'Pending', style: 'bg-amber-50 text-amber-700 border border-amber-300' };
                    }
                    return { label: 'Active', style: 'bg-emerald-50 text-emerald-700 border border-emerald-300' };
                };

                return renderDataTable('etpCharges', [
                    { key: 'code', label: 'Code' },
                    { key: 'name', label: 'Charge Name' },
                    {
                        key: 'charge_type', label: 'Type', render: (val) => (
                            <span className={`px-2.5 py-1 rounded text-xs font-medium ${val === 'Deduction' ? 'bg-red-50 text-red-700 border border-red-200' :
                                val === 'Recovery' ? 'bg-amber-50 text-amber-700 border border-amber-200' :
                                    val === 'Levy' ? 'bg-blue-50 text-blue-700 border border-blue-200' :
                                        'bg-emerald-50 text-emerald-700 border border-emerald-200'
                                }`}>
                                {val}
                            </span>
                        )
                    },
                    {
                        key: 'rate_percentage', label: 'Rate', render: (val) => (
                            <span className="font-mono font-medium text-app-text">{val}%</span>
                        )
                    },
                    { key: 'basis_of_calculation', label: 'Basis' },
                    {
                        key: 'effective_date',
                        label: 'Effective From',
                        render: (val) => val ? new Date(val).toLocaleDateString('en-IN', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric'
                        }) : '-'
                    },
                    {
                        key: 'is_active',
                        label: 'Status',
                        render: (val, item) => {
                            const status = getETPStatus(item);
                            // If calculating status based on date (Pending), maybe readOnly?
                            // item.is_active is the source of truth for the switch.
                            // If is_active is false => Inactive.
                            // If true => Active or Pending.
                            return (
                                <StatusBadge
                                    status={item.is_active ? 'ACTIVE' : 'INACTIVE'}
                                    onToggle={(newStatus) => handleStatusUpdate('etpCharges', item, newStatus)}
                                    entityName={item.name}
                                    activeValue="ACTIVE"
                                    inactiveValue="INACTIVE"
                                    customLabels={{
                                        'ACTIVE': (item.effective_date && new Date(item.effective_date) > new Date().setHours(0, 0, 0, 0)) ? 'Pending' : 'Active',
                                        'INACTIVE': 'Inactive'
                                    }}
                                    customStyles={{
                                        'ACTIVE': (item.effective_date && new Date(item.effective_date) > new Date().setHours(0, 0, 0, 0))
                                            ? 'bg-amber-50 text-amber-700 border-amber-300'
                                            : 'bg-emerald-50 text-emerald-700 border-emerald-300',
                                        'INACTIVE': 'bg-app-surface text-app-muted border-app'
                                    }}
                                />
                            );
                        }
                    },
                ], 'ETP Charges', 'etpCharges');

            default:
                return null;
        }
    };

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 className="text-2xl font-bold text-app-heading">Master Data</h1>
                    <p className="text-app-muted mt-1">Manage reference data for projects, billing, and administration</p>
                </div>
                <Button variant="outline" size="sm" onClick={() => fetchTabData(activeTab)}>
                    <RefreshCw size={16} className="mr-2" />
                    Refresh
                </Button>
            </div>

            {/* Tabs */}
            <div className="flex flex-wrap gap-2 border-b border-app-subtle pb-4">
                {TABS.map(tab => {
                    const Icon = tab.icon;
                    const isActive = activeTab === tab.id;
                    return (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all ${isActive
                                ? `bg-${tab.color}-100 text-${tab.color}-700 shadow-sm`
                                : 'text-app-muted hover:bg-app-surface'
                                }`}
                        >
                            <Icon size={18} />
                            {tab.label}
                        </button>
                    );
                })}
            </div>

            {/* Search */}
            <div className="relative max-w-md">
                <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-app-muted" />
                <input
                    type="text"
                    placeholder="Search records..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-app bg-app-input text-app-text focus:border-primary-500 focus:ring-2 focus:ring-primary-100 outline-none transition-all"
                />
            </div>

            {/* View-only notice */}
            {!canEdit && (
                <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-3">
                    <div className="p-2 bg-amber-100 rounded-lg">
                        <Users size={18} className="text-amber-600" />
                    </div>
                    <div>
                        <p className="font-medium text-amber-800">View-Only Access</p>
                        <p className="text-sm text-amber-600">Only Super Admins can create, edit, or delete master records.</p>
                    </div>
                </div>
            )}

            {/* Content */}
            <motion.div
                key={activeTab}
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.2 }}
            >
                {renderTabContent()}
            </motion.div>

            {/* Form Modal */}
            <MasterFormModal
                isOpen={formModalOpen}
                onClose={() => setFormModalOpen(false)}
                onSubmit={handleFormSubmit}
                title={getModalTitle(currentMasterType, !!currentItem)}
                fields={getFieldConfig(currentMasterType)}
                initialData={currentItem}
                loading={submitting}
            />

            {/* Delete Modal */}
            <DeleteConfirmModal
                isOpen={deleteModalOpen}
                onClose={() => setDeleteModalOpen(false)}
                onConfirm={handleDeleteConfirm}
                itemName={currentItem ? `${currentItem.code} - ${currentItem.name}` : ''}
                loading={submitting}
            />
        </div>
    );
};

export default MasterData;



================================================
FILE: frontend/src/services/AuditLogger.js
================================================
const LOG_STORAGE_KEY = 'pmis_audit_logs';

export const AuditLogger = {
    /**
     * Log an action to the audit trail
     * @param {Object} user - The user performing the action
     * @param {string} action - 'CREATE', 'UPDATE', 'DELETE', 'LOGIN', etc.
     * @param {string} resource - The entity being affected (e.g., 'Project', 'Contractor')
     * @param {string} details - Human readable summary
     * @param {Object} metadata - Optional technical details (e.g., diffs)
     */
    logAction: (user, action, resource, details, metadata = {}) => {
        try {
            const logs = AuditLogger.getLogs();
            const newLog = {
                id: `log-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                timestamp: new Date().toISOString(),
                userId: user ? user.id : 'anonymous',
                userName: user ? user.name : 'System',
                userRole: user ? user.role : 'Unknown',
                action,
                resource,
                details,
                metadata
            };

            // Prepend new log (newest first)
            const updatedLogs = [newLog, ...logs];
            localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(updatedLogs));

            // Console backup for dev visibility
            console.log(`ğŸ“ [Audit] ${action} ${resource}: ${details}`, newLog);
        } catch (error) {
            console.error('Failed to save audit log', error);
        }
    },

    /**
     * Retrieve all logs
     * @returns {Array} List of log entries
     */
    getLogs: () => {
        try {
            const stored = localStorage.getItem(LOG_STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        } catch (error) {
            return [];
        }
    },

    /**
     * Export logs as CSV
     */
    exportLogs: () => {
        const logs = AuditLogger.getLogs();
        if (!logs.length) return;

        const headers = ['Timestamp', 'User Name', 'Role', 'Action', 'Resource', 'Details'];
        const csvContent = [
            headers.join(','),
            ...logs.map(log => [
                `"${log.timestamp}"`,
                `"${log.userName}"`,
                `"${log.userRole}"`,
                `"${log.action}"`,
                `"${log.resource}"`,
                `"${log.details}"`
            ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `audit_logs_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }
};



================================================
FILE: frontend/src/services/financeService.js
================================================
import api from '@/api/client';

const financeService = {
    // --- FUND MANAGEMENT ---
    getFunds: async () => {
        const response = await api.get('/finance/funds/');
        const data = response.data;
        return data?.results || data || [];
    },

    createFund: async (data) => {
        const response = await api.post('/finance/funds/', data);
        return response.data;
    },

    // --- BUDGETING ---
    getBudgets: async (projectId) => {
        const response = await api.get('/finance/budgets/', { params: { project: projectId } });
        const data = response.data;
        return data?.results || data || [];
    },

    createBudget: async (data) => {
        // Data should include { project, milestone, fund_head, cost_category, amount }
        const response = await api.post('/finance/budgets/', data);
        return response.data;
    },

    // --- RA BILLING ---
    getBills: async (projectId, status) => {
        const params = {};
        if (projectId) params.project = projectId;
        if (status) params.status = status;

        const response = await api.get('/finance/bills/', { params });
        const data = response.data;
        const items = data?.results || data || [];
        return items.map(transformBillToFrontend);
    },

    createBill: async (data) => {
        // Transform camelCase to snake_case for Backend
        const backendData = transformBillToBackend(data);
        const response = await api.post('/finance/bills/', backendData);
        return transformBillToFrontend(response.data);
    },

    verifyBill: async (billId) => {
        const response = await api.post(`/finance/bills/${billId}/verify/`);
        return response.data;
    },

    // --- SETTINGS ---
    getSettings: async (projectId) => {
        const response = await api.get('/finance/settings/by_project/', { params: { project: projectId } });
        return response.data;
    },

    // --- SCHEDULING ---
    getScheduleTasks: async (projectId) => {
        const response = await api.get('/scheduling/tasks/', { params: { project: projectId } });
        const data = response.data;
        return data?.results || data || [];
    },

    // --- BOQ ---
    getBOQItems: async (projectId) => {
        const response = await api.get('/finance/boq/', { params: { project: projectId } });
        const data = response.data;
        return data?.results || data || [];
    },

    updateBOQItem: async (itemId, data) => {
        // Convert to FormData to avoid 'Unsupported media type' if backend expects multipart
        const formData = new FormData();
        Object.keys(data).forEach(key => {
            if (data[key] !== null && data[key] !== undefined) {
                formData.append(key, data[key]);
            }
        });
        const response = await api.patch(`/finance/boq/${itemId}/`, formData);
        return response.data;
    },

    deleteBOQItem: async (itemId) => {
        await api.delete(`/finance/boq/${itemId}/`);
    },

    analyzeBOQFile: async (file) => {
        const formData = new FormData();
        formData.append('file', file);
        const response = await api.post('/finance/boq/analyze_file/', formData);
        return response.data;
    },

    importBOQFile: async (projectId, file, mapping) => {
        const formData = new FormData();
        formData.append('project_id', projectId);
        formData.append('file', file);
        formData.append('mapping', JSON.stringify(mapping));

        const response = await api.post('/finance/boq/import_file/', formData);
        return response.data;
    },

    requestBOQFreeze: async (projectId, itemIds, description = '') => {
        const response = await api.post('/finance/boq/request_freeze/', {
            project_id: projectId,
            item_ids: itemIds,
            description
        });
        return response.data;
    },

    requestBOQUnfreeze: async (projectId, itemIds, description = '') => {
        const response = await api.post('/finance/boq/request_unfreeze/', {
            project_id: projectId,
            item_ids: itemIds,
            description
        });
        return response.data;
    },

    // --- Approval Requests ---
    getPendingApprovals: async () => {
        const response = await api.get('/finance/approval-requests/pending/');
        return response.data;
    },

    approveRequest: async (requestId, notes = '') => {
        const response = await api.post(`/finance/approval-requests/${requestId}/approve/`, { notes });
        return response.data;
    },

    rejectRequest: async (requestId, notes = '') => {
        const response = await api.post(`/finance/approval-requests/${requestId}/reject/`, { notes });
        return response.data;
    },

    // --- Notifications ---
    getNotifications: async () => {
        const response = await api.get('/finance/notifications/');
        return response.data;
    },

    getUnreadNotificationCount: async () => {
        const response = await api.get('/finance/notifications/unread_count/');
        return response.data.count;
    },

    markNotificationRead: async (notificationId) => {
        const response = await api.post(`/finance/notifications/${notificationId}/mark_read/`);
        return response.data;
    },

    markAllNotificationsRead: async () => {
        const response = await api.post('/finance/notifications/mark_all_read/');
        return response.data;
    },

    // --- BOQ-MILESTONE MAPPINGS ---
    /**
     * Get all milestone mappings for a BOQ item
     */
    getBOQMappings: async (boqItemId) => {
        const response = await api.get('/finance/mappings/', {
            params: { boq_item: boqItemId }
        });
        return response.data;
    },

    /**
     * Get all mappings for a project (via BOQ items)
     */
    getAllMappingsForProject: async (projectId) => {
        const response = await api.get('/finance/mappings/', {
            params: { project: projectId }
        });
        return response.data;
    },

    /**
     * Create a new BOQ-Milestone mapping
     * @param {Object} data - { boq_item, milestone, percentage_allocated }
     */
    createBOQMapping: async (data) => {
        const response = await api.post('/finance/mappings/', data);
        return response.data;
    },

    /**
     * Update a BOQ-Milestone mapping
     */
    updateBOQMapping: async (mappingId, data) => {
        const response = await api.patch(`/finance/mappings/${mappingId}/`, data);
        return response.data;
    },

    /**
     * Delete a BOQ-Milestone mapping
     */
    deleteBOQMapping: async (mappingId) => {
        await api.delete(`/finance/mappings/${mappingId}/`);
    }
};

// --- DATA TRANSFORMERS ---

const transformBillToBackend = (data) => {
    // Map TDS String to Enum
    const tdsMap = {
        '194C - Individual / HUF (1%)': '194C_IND',
        '194C - Others (2%)': '194C_OTH',
        '194J - Professional Fees (10%)': '194J'
    };

    return {
        project: data.projectId,
        contractor: data.contractorId,
        milestone: data.milestoneId || null, // Ensure this field is handled if added to UI

        bill_no: data.billNo,
        work_order_no: data.workOrderNo,
        bill_date: data.submissionDate,
        period_from: data.periodFrom || null,
        period_to: data.periodTo || null,

        gross_amount: data.grossAmount,
        gst_percentage: data.gstRate,
        // gst_amount is auto-calc by backend

        tds_section_type: tdsMap[data.tdsCategory] || 'NONE',
        tds_percentage: data.tdsRate,
        // tds_amount is auto-calc

        labour_cess_percentage: data.labourCessRate,

        retention_percentage: data.retentionRate,
        // retention_amount is auto-calc

        mobilization_advance_recovery: data.mobilizationRecovery || 0,
        material_advance_recovery: data.materialRecovery || 0,
        plant_machinery_recovery: 0, // Not in UI yet

        penalty_amount: data.penaltyAmount || 0,
        price_adjustment: data.priceAdjustment || 0,
        insurance_recovery: data.insuranceRecovery || 0,
        other_deductions: data.otherDeductions || 0,

        // net_payable is auto-calc
        status: 'SUBMITTED'
    };
};

const transformBillToFrontend = (data) => {
    // Map Enum to TDS String (Reverse)
    const tdsMapReverse = {
        '194C_IND': '194C - Individual / HUF (1%)',
        '194C_OTH': '194C - Others (2%)',
        '194J': '194J - Professional Fees (10%)',
        'NONE': 'None'
    };

    return {
        id: data.id,
        projectId: data.project,
        projectName: data.project_name,
        contractorId: data.contractor,
        contractorName: data.contractor_name, // Serializer provides this

        billNo: data.bill_no,
        workOrderNo: data.work_order_no,
        submissionDate: data.bill_date,
        periodFrom: data.period_from,
        periodTo: data.period_to,

        grossAmount: parseFloat(data.gross_amount),
        gstRate: parseFloat(data.gst_percentage),
        gstAmount: parseFloat(data.gst_amount),
        totalAmount: parseFloat(data.total_amount),

        tdsCategory: tdsMapReverse[data.tds_section_type] || 'None',
        tdsRate: parseFloat(data.tds_percentage),
        tdsAmount: parseFloat(data.tds_amount),

        labourCessRate: parseFloat(data.labour_cess_percentage),
        labourCessAmount: parseFloat(data.labour_cess_amount),

        retentionRate: parseFloat(data.retention_percentage),
        retentionAmount: parseFloat(data.retention_amount),

        mobilizationRecovery: parseFloat(data.mobilization_advance_recovery),
        materialRecovery: parseFloat(data.material_advance_recovery),

        penaltyAmount: parseFloat(data.penalty_amount),
        insuranceRecovery: parseFloat(data.insurance_recovery || 0), // Schema check needed
        otherDeductions: parseFloat(data.other_deductions),

        netPayable: parseFloat(data.net_payable),
        status: data.status
    };
};

export default financeService;



================================================
FILE: frontend/src/services/ifscService.js
================================================
/**
 * Service for IFSC code validation and bank lookup
 * Uses our self-hosted IFSC database - NO external API dependencies
 * Government-grade security and privacy
 */
import client from '../api/client';

/**
 * Fetch list of all banks for dropdown
 * @returns {Promise<string[]>} Array of bank names
 */
export const fetchBankList = async () => {
    try {
        const response = await client.get('/banks/list/');
        return response.data.banks || [];
    } catch (error) {
        console.error('Failed to fetch bank list:', error);
        throw new Error('Unable to load bank list');
    }
};

/**
 * Validate IFSC code and fetch branch details
 * @param {string} ifscCode - 11-character IFSC code
 * @returns {Promise<Object>} Branch details
 */
export const fetchIFSCDetails = async (ifscCode) => {
    // Validate format locally first
    if (!isValidIFSCFormat(ifscCode)) {
        throw new Error('Invalid IFSC format. Expected: ABCD0123456');
    }

    try {
        const response = await client.get(`/banks/ifsc/${ifscCode.toUpperCase()}/`);
        return response.data;
    } catch (error) {
        if (error.response?.status === 404) {
            throw new Error('IFSC code not found in database');
        }
        if (error.response?.status === 400) {
            throw new Error(error.response.data.message || 'Invalid IFSC code');
        }
        console.error('IFSC lookup failed:', error);
        throw new Error('Failed to verify IFSC code');
    }
};

/**
 * Validate IFSC code format
 * Format: ABCD0123456 (4 letters, 0, then 6 alphanumeric)
 * @param {string} ifsc - IFSC code to validate
 * @returns {boolean} Whether format is valid
 */
export const isValidIFSCFormat = (ifsc) => {
    if (!ifsc) return false;
    return /^[A-Z]{4}0[A-Z0-9]{6}$/.test(ifsc.toUpperCase());
};

/**
 * Get IFSC statistics (admin only)
 * @returns {Promise<Object>} Database statistics
 */
export const getIFSCStats = async () => {
    try {
        const response = await client.get('/banks/stats/');
        return response.data;
    } catch (error) {
        console.error('Failed to fetch IFSC stats:', error);
        throw error;
    }
};



================================================
FILE: frontend/src/services/projectService.js
================================================
import api from '@/api/client';

const projectService = {
    getAllProjects: async () => {
        const response = await api.get('/projects/');
        const data = response.data;
        return data?.results || data || [];
    },

    getProject: async (id) => {
        const response = await api.get(`/projects/${id}/`);
        return response.data;
    },

    // Stubs for future use
    createProject: async (data) => {
        const response = await api.post('/projects/', data);
        return response.data;
    },

    updateProject: async (id, data) => {
        const response = await api.patch(`/projects/${id}/`, data);
        return response.data;
    }
};

export default projectService;



================================================
FILE: frontend/src/services/schedulingService.js
================================================
import api from '@/api/client';

const schedulingService = {
    getTasks: async (projectId) => {
        const response = await api.get('/scheduling/tasks/', { params: { project: projectId } });
        const data = response.data;
        const items = data?.results || data || [];
        return items.map(transformTaskToFrontend);
    },

    createTask: async (data, projectId) => {
        const payload = transformTaskToBackend(data, projectId);
        // Use FormData to support potential file uploads or backend expectations
        const formData = new FormData();
        Object.keys(payload).forEach(key => {
            formData.append(key, payload[key]);
        });
        const response = await api.post('/scheduling/tasks/', formData);
        return transformTaskToFrontend(response.data);
    },

    updateTask: async (id, data, projectId) => {
        const payload = transformTaskToBackend(data, projectId);
        const response = await api.patch(`/scheduling/tasks/${id}/`, payload);
        return transformTaskToFrontend(response.data);
    },

    deleteTask: async (id) => {
        await api.delete(`/scheduling/tasks/${id}/`);
    },

    /**
     * Analyze uploaded schedule file and return headers for column mapping.
     * Supports: .xlsx (Excel), .xml (MS Project), .xer (Primavera P6)
     * @param {File} file - The schedule file to analyze
     * @returns {Promise<{headers: string[], filename: string}>}
     */
    analyzeFile: async (file) => {
        const formData = new FormData();
        formData.append('file', file);

        const response = await api.post('/scheduling/tasks/analyze_file/', formData, {
            headers: { 'Content-Type': 'multipart/form-data' },
            timeout: 30000, // 30s timeout for large files
        });
        return response.data;
    },

    /**
     * Import schedule data from file using the provided column mapping.
     * @param {File} file - The schedule file to import
     * @param {string} projectId - Target project UUID
     * @param {Object} mapping - Column mapping { dbField: fileHeader }
     * @param {Function} onProgress - Optional progress callback
     * @returns {Promise<{status: string, created: number, updated: number}>}
     */
    importFile: async (file, projectId, mapping, onProgress = null) => {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('project_id', projectId);
        formData.append('mapping', JSON.stringify(mapping));

        const config = {
            headers: { 'Content-Type': 'multipart/form-data' },
            timeout: 120000, // 2min timeout for large imports
        };

        if (onProgress) {
            config.onUploadProgress = (progressEvent) => {
                const percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                onProgress(percent);
            };
        }

        const response = await api.post('/scheduling/tasks/import_file/', formData, config);
        return response.data;
    },

    /**
     * Get only milestone tasks (for budget/billing linkage)
     */
    getMilestones: async (projectId) => {
        const response = await api.get('/scheduling/tasks/', {
            params: { project: projectId }
        });
        const data = response.data;
        const items = data?.results || data || [];
        return items
            .filter(t => t.is_milestone)
            .map(transformTaskToFrontend);
    }
};

const transformTaskToBackend = (data, pId) => ({
    project: pId,
    name: data.name,
    start_date: data.startDate,
    end_date: data.endDate,
    progress: data.progress || 0,
    is_milestone: data.isMilestone || false,
    status: data.status || 'PLANNED'
});

const transformTaskToFrontend = (data) => ({
    id: data.id,
    name: data.name,
    startDate: data.start_date,
    endDate: data.end_date,
    progress: data.progress,
    isMilestone: data.is_milestone,
    status: data.status,
    project: data.project
});

export default schedulingService;



================================================
FILE: frontend/src/services/searchService.js
================================================
import apiClient from '@/api/client';

const RECENT_SEARCHES_KEY = 'pmis_recent_searches';
const MAX_RECENT_SEARCHES = 10;

/**
 * Search Service
 * 
 * Handles:
 * - Global search API calls with debouncing
 * - Recent searches in localStorage
 * - Result categorization and formatting
 * - Fuzzy matching for local data
 */
class SearchService {
    /**
     * Perform a global search across all entities
     * @param {string} query - Search query
     * @param {string} filter - Category filter ('all', 'projects', 'documents', etc.)
     * @returns {Promise<Array>} - Array of search results
     */
    async globalSearch(query, filter = 'all') {
        if (!query || query.length < 2) {
            return [];
        }

        try {
            const params = {
                q: query.trim(),
                ...(filter !== 'all' && { category: filter }),
                limit: 20
            };

            const response = await apiClient.get('/api/search/', { params });

            // Format results from API
            const results = this.formatApiResults(response.data.results || []);
            return results;
        } catch (error) {
            console.error('Search API error:', error);

            // If API fails, return empty array (local navigation still works)
            // Could also implement offline search here
            return [];
        }
    }

    /**
     * Search only within a specific category
     * @param {string} query - Search query
     * @param {string} category - Category to search in
     * @returns {Promise<Array>} - Array of search results
     */
    async searchByCategory(query, category) {
        return this.globalSearch(query, category);
    }

    /**
     * Format API results to standard format
     * @param {Array} apiResults - Raw results from API
     * @returns {Array} - Formatted results
     */
    formatApiResults(apiResults) {
        return apiResults.map(result => ({
            id: result.id || `${result.type}-${Date.now()}`,
            title: result.title || result.name,
            description: result.description || result.preview,
            category: this.mapCategory(result.type),
            type: result.type,
            path: result.url || result.path,
            relevanceScore: result.score || 0,
            metadata: {
                status: result.status,
                breadcrumb: result.breadcrumb,
                createdAt: result.created_at,
                updatedAt: result.updated_at,
                author: result.author,
            }
        }));
    }

    /**
     * Map API category types to frontend categories
     * @param {string} apiType - Type from API
     * @returns {string} - Frontend category
     */
    mapCategory(apiType) {
        const categoryMap = {
            'project': 'projects',
            'document': 'documents',
            'file': 'documents',
            'user': 'users',
            'message': 'communications',
            'thread': 'communications',
            'task': 'tasks',
            'schedule': 'tasks',
            'contractor': 'contractors',
            'risk': 'risks',
            'boq': 'boq',
            'billing': 'billing',
            'fund': 'funds',
            'procurement': 'procurement',
        };
        return categoryMap[apiType] || 'other';
    }

    /**
     * Get recent searches from localStorage
     * @returns {Array<string>} - Array of recent search terms
     */
    getRecentSearches() {
        try {
            const stored = localStorage.getItem(RECENT_SEARCHES_KEY);
            if (stored) {
                return JSON.parse(stored);
            }
        } catch (error) {
            console.error('Error reading recent searches:', error);
        }
        return [];
    }

    /**
     * Save a search term to recent searches
     * @param {string} query - Search term to save
     */
    saveRecentSearch(query) {
        if (!query || query.trim().length < 2) return;

        try {
            let recent = this.getRecentSearches();

            // Remove if already exists (to move to top)
            recent = recent.filter(term => term.toLowerCase() !== query.toLowerCase().trim());

            // Add to beginning
            recent.unshift(query.trim());

            // Limit to max
            recent = recent.slice(0, MAX_RECENT_SEARCHES);

            localStorage.setItem(RECENT_SEARCHES_KEY, JSON.stringify(recent));
        } catch (error) {
            console.error('Error saving recent search:', error);
        }
    }

    /**
     * Clear all recent searches
     */
    clearRecentSearches() {
        try {
            localStorage.removeItem(RECENT_SEARCHES_KEY);
        } catch (error) {
            console.error('Error clearing recent searches:', error);
        }
    }

    /**
     * Remove a specific recent search
     * @param {string} query - Search term to remove
     */
    removeRecentSearch(query) {
        try {
            let recent = this.getRecentSearches();
            recent = recent.filter(term => term.toLowerCase() !== query.toLowerCase());
            localStorage.setItem(RECENT_SEARCHES_KEY, JSON.stringify(recent));
        } catch (error) {
            console.error('Error removing recent search:', error);
        }
    }

    /**
     * Simple fuzzy match for typo tolerance
     * Uses trigram-like approach for character matching
     * @param {string} text - Text to search in
     * @param {string} query - Query to match
     * @returns {boolean} - Whether there's a match
     */
    fuzzyMatch(text, query) {
        if (!text || !query) return false;

        const normalizedText = text.toLowerCase().trim();
        const normalizedQuery = query.toLowerCase().trim();

        // Direct substring match
        if (normalizedText.includes(normalizedQuery)) return true;

        // For short queries, require higher match threshold
        if (normalizedQuery.length < 3) {
            return normalizedText.startsWith(normalizedQuery);
        }

        // Count matching characters in sequence
        let matchCount = 0;
        let textIndex = 0;

        for (const char of normalizedQuery) {
            while (textIndex < normalizedText.length) {
                if (normalizedText[textIndex] === char) {
                    matchCount++;
                    textIndex++;
                    break;
                }
                textIndex++;
            }
        }

        // Require at least 70% character match for fuzzy
        return matchCount / normalizedQuery.length >= 0.7;
    }

    /**
     * Calculate similarity score between two strings
     * Higher score = better match
     * @param {string} text - Text to compare
     * @param {string} query - Query to match
     * @returns {number} - Similarity score (0-100)
     */
    getSimilarityScore(text, query) {
        if (!text || !query) return 0;

        const normalizedText = text.toLowerCase().trim();
        const normalizedQuery = query.toLowerCase().trim();

        // Exact match
        if (normalizedText === normalizedQuery) return 100;

        // Starts with query
        if (normalizedText.startsWith(normalizedQuery)) return 90;

        // Contains query
        if (normalizedText.includes(normalizedQuery)) return 70;

        // Fuzzy match
        if (this.fuzzyMatch(text, query)) return 50;

        return 0;
    }
}

// Export singleton instance
export const searchService = new SearchService();
export default searchService;



================================================
FILE: frontend/src/services/userService.js
================================================
import api from '@/api/client';

const userService = {
    getUsers: async () => {
        const response = await api.get('/users/'); // Assuming /users/ endpoint lists users
        return response.data;
    },

    getCurrentUser: async () => {
        const response = await api.get('/users/me/');
        return response.data;
    }
};

export default userService;



================================================
FILE: frontend/src/utils/AuthUtils.js
================================================
// Simulate OTP storage in localStorage (mock database)
const OTP_STORAGE_KEY = 'pmis_mock_otps';

export const generateMockOtp = async (email) => {
    // Generate random 6-digit code
    const otp = Math.floor(100000 + Math.random() * 900000).toString();
    const expiresAt = Date.now() + 5 * 60 * 1000; // 5 minutes expiry

    // Store in mock DB
    const otps = getStoredOtps();
    otps[email] = { code: otp, expiresAt };
    saveStoredOtps(otps);

    // Simulate network delay
    await new Promise(resolve => setTimeout(resolve, 800));

    // Log to console (Simulation)
    console.group('ğŸ” Mock Email Service');
    console.log(`To: ${email}`);
    console.log(`Subject: Your Login OTP`);
    console.log(`Body: Your verification code is: %c${otp}`, 'font-weight: bold; font-size: 1.2em; color: #4ade80');
    console.groupEnd();

    return { success: true, message: 'OTP sent to console' };
};

export const verifyMockOtp = async (email, code) => {
    // Simulate network delay
    await new Promise(resolve => setTimeout(resolve, 600));

    const otps = getStoredOtps();
    const record = otps[email];

    if (!record) {
        return { success: false, message: 'No OTP requested for this email' };
    }

    if (Date.now() > record.expiresAt) {
        return { success: false, message: 'OTP has expired' };
    }

    if (record.code !== code) {
        return { success: false, message: 'Invalid OTP code' };
    }

    // Success - consume OTP
    delete otps[email];
    saveStoredOtps(otps);

    return { success: true };
};

// Helper to access localStorage
const getStoredOtps = () => {
    try {
        const stored = localStorage.getItem(OTP_STORAGE_KEY);
        return stored ? JSON.parse(stored) : {};
    } catch (e) {
        return {};
    }
};

const saveStoredOtps = (otps) => {
    localStorage.setItem(OTP_STORAGE_KEY, JSON.stringify(otps));
};



================================================
FILE: .github/workflows/sync-gitlab.yml
================================================
name: Sync to GitLab

# Automatically sync code to GitLab repositories when pushed to GitHub
# - Webapp repo: Full mirror of entire codebase
# - API repo: Only the backend folder
# Always syncs to main branch on GitLab

on:
  push:
    branches: [main]  # Only sync when pushing to main
  workflow_dispatch:  # Allow manual trigger

jobs:
  # Job 1: Sync entire repo to GitLab Webapp
  sync-webapp:
    name: Sync to GitLab Webapp
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper push
      
      - name: Push to GitLab Webapp (main branch)
        env:
          GITLAB_WEBAPP_URL: ${{ secrets.GITLAB_WEBAPP_URL }}
        run: |
          git remote add gitlab-webapp "$GITLAB_WEBAPP_URL" || git remote set-url gitlab-webapp "$GITLAB_WEBAPP_URL"
          git push gitlab-webapp HEAD:main --force
          echo "âœ… Synced to GitLab Webapp main branch"

  # Job 2: Sync only backend folder to GitLab API
  sync-api:
    name: Sync Backend to GitLab API
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history required for subtree
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
      - name: Push backend to GitLab API (main branch)
        env:
          GITLAB_API_URL: ${{ secrets.GITLAB_API_URL }}
        run: |
          # Add the GitLab API remote
          git remote add gitlab-api "$GITLAB_API_URL" || git remote set-url gitlab-api "$GITLAB_API_URL"
          
          # Use subtree split to extract only the backend folder
          # Then force push to main branch on API repo
          git subtree split --prefix=backend -b backend-only
          git push gitlab-api backend-only:main --force
          
          # Cleanup
          git branch -D backend-only
          echo "âœ… Synced backend to GitLab API main branch"




================================================
FILE: .vite/deps/_metadata.json
================================================
{
  "hash": "181cb998",
  "configHash": "03e6ff87",
  "lockfileHash": "e3b0c442",
  "browserHash": "69bb0b54",
  "optimized": {},
  "chunks": {}
}


================================================
FILE: .vite/deps/package.json
================================================
{
  "type": "module"
}



================================================
FILE: .vite/deps_temp_4f72f5b4/package.json
================================================
{
  "type": "module"
}


